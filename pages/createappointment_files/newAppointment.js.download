var apptLockObj={};(function(){angular.module('Appointment',['oc.lazyLoad','ecw.dir.keywords','ecw.service.keywordService','patientlookup','facilitylookup','departmentlookup','ecw.dir.timepicker','ecw.dir.datepicker','ecw.scheduleCommon','providerlookup','ecw.batchAjax','ecw.dir.structuredata','ecw.service.EncDetailsService','ecw.dir.savePrompt','ui.bootstrap','guarantorlookup','timelookup','visitStatusLookup','visitTypeLookup','visitSubTypeLookup','reasonLookup','resourceLookup','ecw.service.PSAC','ecw.datatruncUtilityModule','ecw.dir.cardonfilebtn','RxHelper',getDataExchangeConsentDependency(),getEhxCommonFuncsJsDependency(),'toasterNotification',healowSignDependency.injectPublishDocumentDirective(),'wCVIndicatorDirective',getResourceScheduleServiceFiles()]).controller('newApptController',function($scope,$http,$modal,$rootScope,$ocLazyLoad,$templateCache,$timeout,appointmentService,scheduleCommonService,batchAjaxService,EncDetailsService,$filter,PSACService,$sce,dataTruncUtilityService,rxService,toasterSvc,$compile,resourceSchedulingService){var dxArray=appointmentScopeGlobalVariables.dxArray;var encId=appointmentScopeGlobalVariables.encId;var encdata=appointmentScopeGlobalVariables.encdata;var startTime=appointmentScopeGlobalVariables.startTime;var endTime=appointmentScopeGlobalVariables.endTime;var id=appointmentScopeGlobalVariables.id;var name=appointmentScopeGlobalVariables.name;var date=appointmentScopeGlobalVariables.date;var parentForm=appointmentScopeGlobalVariables.parentForm;var visitType=appointmentScopeGlobalVariables.visitType;let isEndTimeReqForFirstLoad=false;if(encId==='0'&&startTime.length>0&&endTime.length===0&&visitType.length>0){isEndTimeReqForFirstLoad=true}var faciltyId=appointmentScopeGlobalVariables.faciltyId;var schFacilityId=appointmentScopeGlobalVariables.schFacilityId;var schFacilityTimeZone=appointmentScopeGlobalVariables.schFacilityTimeZone;var encFacId=appointmentScopeGlobalVariables.encFacId;var encFacTimeZone=appointmentScopeGlobalVariables.encFacTimeZone;var description=appointmentScopeGlobalVariables.description;var schFacilityName=appointmentScopeGlobalVariables.schFacilityName;var patientId=appointmentScopeGlobalVariables.patientId;var patientName=appointmentScopeGlobalVariables.patientName;var caseDetails=appointmentScopeGlobalVariables.caseDetails;var reservedSlotId=appointmentScopeGlobalVariables.reservedSlotId;var cancellationReason=appointmentScopeGlobalVariables.cancellationReason;var transportationStatus=appointmentScopeGlobalVariables.transportationStatus;var vision=appointmentScopeGlobalVariables.vision;var refreshRegDashBoardOnclose=appointmentScopeGlobalVariables.refreshRegDashBoardOnclose;var encType=appointmentScopeGlobalVariables.encType;var encType=appointmentScopeGlobalVariables.encType;var referralXml=appointmentScopeGlobalVariables.referralXml;var referralStatusXml=appointmentScopeGlobalVariables.referralStatusXml;var paymentXml=appointmentScopeGlobalVariables.paymentXml;var claimPaymentCount=appointmentScopeGlobalVariables.claimPaymentCount;var nextApptDetails=appointmentScopeGlobalVariables.nextApptDetails;var strXmlForAnnualNotes=appointmentScopeGlobalVariables.strXmlForAnnualNotes;var facilityArray=appointmentScopeGlobalVariables.facilityArray;var schedulefacilityFilter=appointmentScopeGlobalVariables.schedulefacilityFilter;var strRxHubContent=appointmentScopeGlobalVariables.strRxHubContent;var strRxEligiErrorContent=appointmentScopeGlobalVariables.strRxEligiErrorContent;var ptObj=appointmentScopeGlobalVariables.ptObj;var pid=appointmentScopeGlobalVariables.pid;var POS=appointmentScopeGlobalVariables.POS;var encClaimStrXml=appointmentScopeGlobalVariables.encClaimStrXml;var strXmlForVisitSubType=appointmentScopeGlobalVariables.strXmlForVisitSubType;var strXmlForClaimProvider=appointmentScopeGlobalVariables.strXmlForClaimProvider;var strXmlForconcentStatus=appointmentScopeGlobalVariables.strXmlForconcentStatus;var strXmlForSlidingFeeSch=appointmentScopeGlobalVariables.strXmlForSlidingFeeSch;var authorizedProviderJArray=appointmentScopeGlobalVariables.authorizedProviderJArray;var block_id=appointmentScopeGlobalVariables.block_id;var isPermissionForWebPortal=appointmentScopeGlobalVariables.isPermissionForWebPortal;var showBillableAlert=appointmentScopeGlobalVariables.showBillableAlert;var masterAbstractEncounter=appointmentScopeGlobalVariables.masterAbstractEncounter;var strPermissionForPosUpdate=appointmentScopeGlobalVariables.strPermissionForPosUpdate;var strPermissionForApptCopay=appointmentScopeGlobalVariables.strPermissionForApptCopay;var strPermissionForApptNonBillable=appointmentScopeGlobalVariables.strPermissionForApptNonBillable;var strPermissionForApptVisitStatus=appointmentScopeGlobalVariables.strPermissionForApptVisitStatus;var strPermissionForBookOutofOfficeHoursAppointments=appointmentScopeGlobalVariables.strPermissionForBookOutofOfficeHoursAppointments;var strPermissionForBookBlockConflictAppointments=appointmentScopeGlobalVariables.strPermissionForBookBlockConflictAppointments;var strPermissionForBookConflictAppointments=appointmentScopeGlobalVariables.strPermissionForBookConflictAppointments;var strPermissionForBookAnyVisitTypeAppointment=appointmentScopeGlobalVariables.strPermissionForBookAnyVisitTypeAppointment;var strPermissionForOverbookAppointments=appointmentScopeGlobalVariables.strPermissionForOverbookAppointments;var strXMLForMandatoryStructData=appointmentScopeGlobalVariables.strXMLForMandatoryStructData;var cookie=appointmentScopeGlobalVariables.cookie;var strXmlForPager=appointmentScopeGlobalVariables.strXmlForPager;var isTrackingBoardEnable=appointmentScopeGlobalVariables.isTrackingBoardEnable;var strAccLookupPermission=appointmentScopeGlobalVariables.strAccLookupPermission;var providerAndResourceCount=appointmentScopeGlobalVariables.providerAndResourceCount;var doctorName=appointmentScopeGlobalVariables.doctorName;var doctorSex=appointmentScopeGlobalVariables.doctorSex;var doctorLang=appointmentScopeGlobalVariables.doctorLang;var deleteAccess=appointmentScopeGlobalVariables.deleteAccess;var isFacilityAccess=appointmentScopeGlobalVariables.isFacilityAccess;var payDataMappingObj=appointmentScopeGlobalVariables.payDataMappingObj;var isProviderScheduleVerticalBarsEnabled=appointmentScopeGlobalVariables.isProviderScheduleVerticalBarsEnabled;var ecwVisitTypeRuleList=appointmentScopeGlobalVariables.ecwVisitypeRuleList;$scope.isSubTypeFieldMandatory=appointmentScopeGlobalVariables.isSubTypeFieldMandatory;$scope.isOrderAssociatedWithEnc=appointmentScopeGlobalVariables.isOrderAssociatedWithEnc;$scope.isReasonFieldMandatory=appointmentScopeGlobalVariables.isReasonFieldMandatory;var strHealowPlusAccess=appointmentScopeGlobalVariables.strHealowPlusAccess;var strIsUserCentralizedScheduler=appointmentScopeGlobalVariables.strIsUserCentralizedScheduler;var jsonCaseManager=appointmentScopeGlobalVariables.jsonCaseManager;$scope.nClosingId=appointmentScopeGlobalVariables.nClosingId;$scope.isFloatingToolbar=!(appointmentScopeGlobalVariables.strFloatingToolbar===""||appointmentScopeGlobalVariables.strFloatingToolbar==="false");$scope.ecwVisitTypeRuleList=[];$scope.noShowPercentage=appointmentScopeGlobalVariables.noShowPercentage;$scope.caseFiledAllowed=Object.is(appointmentScopeGlobalVariables.caseFiledAllowed,"true");var ECW_VISITSTATUSCODE_MAPPING_NOSHOW="No Show";var ECW_VISITSTATUSCODE_MAPPING_CANCELLED="Cancelled";var ECW_VISITSTATUSCODE_MAPPING_RESCHEDULED="Rescheduled";$scope.apptEligibilityMultiCopaySelection={url:''};if(ecwVisitTypeRuleList!==null&&ecwVisitTypeRuleList!==undefined&&$.trim(ecwVisitTypeRuleList)!==""){if(typeof ecwVisitTypeRuleList==="string"){$scope.ecwVisitTypeRuleList=JSON.parse(ecwVisitTypeRuleList)}else{$scope.ecwVisitTypeRuleList=ecwVisitTypeRuleList}}var newAppointmentFnNameSpace={};var encAssociationXml=appointmentScopeGlobalVariables.encAssociationXml;if(vision=='false'){isVision=false}var hasBookConflict=false;var hasOverbookAppt=false;var isFacilityExist=false;var preserveValueThatConflict={startTime:'',endTime:'',date:'',resourceId:'',visitSubTypeId:0};$scope.bCentralizedSchedulingEnabled=false;if(strIsUserCentralizedScheduler==='true'){$scope.bCentralizedSchedulingEnabled=true}$scope.dentalProviderSlotValidationEnabled=appointmentScopeGlobalVariables.jDentalProviderSlotValidation;$scope.FormularyID="";$scope.PMBID="";$scope.coPayCb=false;$scope.GetRxEligibilityErrorVar=false;$scope.appointmentVisitStatus={};$scope.appointmentVisitType={};$scope.appointmentVisitSubType={};$scope.enableVisitSubType=getItemKeyValue("EnableVisitSubType").toLowerCase()=="yes";$scope.appointmentReason={};$scope.visitTypeOverriden="";$scope.showCancellationReason=false;$scope.closePopupFromAddlBillingData=false;$scope.nonBillableVisitTypeCheck=true;$scope.appointmentSelectedVisitStatus="";$scope.stClass={'color':'black'};$scope.regFailedRules=[];$scope.telepopupurlPortal='';$scope.questpopupPortal='';$scope.documentViewPortal='';$scope.encFacId='0';if(encFacId!=null||encFacId!=undefined)$scope.encFacId=encFacId;$scope.doNotSetProvForRes=false;$scope.patientinfohuburlAppt="";$scope.caseIdForCaseDetails=0;$scope["case"]="0";$scope.client="";$scope.recurrence={};$scope.saveFromVal=1;$scope.txtBackColor='white';$scope.bodyHeight={'height':'568px'};$scope.approveHeight={'height':'568px'};$scope.apptHeight={'height':'503px'};$scope.apptNonBillableWarning=getUserProfile('ApptNonBillableWarning');$scope.globalAlert={color:"#e1e1e1"};$scope.classForMargin={'margin-right':'0px'};$scope.panelUrl="";$scope.isFirstTimeLoad=false;$scope.isAppointmentModalShown=false;$scope.enableOccHealth=false;$scope.prevCycleTime=moment().format("HH:mm:ss");apptLockObj={formName:"frmNewAppt",uniqueKey:"",g_cancel:false,strKey:"",isOpenform:false};$scope.enableUBData=false;$scope.Ub92Data={};$scope.PagerActiveTab={bPatientTabIsActive:false,bProviderTabIsActive:false};$scope.enableOccHealth=false;$scope.occMedValue=getItemKeyValue("EnableOccHealth");$scope.pmVisitIDExtTable=getItemKeyValue("PMInt_VisitID_extTable");$scope.pmExtVisitNo="";$scope.allowedToProceed=true;$scope.teleVisitCodesIds=[];$scope.ignoreAndProceed=false;$scope.isVisitStatusChanged=false;$scope.ruleStatus='';$scope.txtReason='';$scope.calledFromdeleteEnc=false;$scope.providerTimes='[]';$scope.resourceTimes='[]';$scope.isScreenEdited=false;$scope.isDentalVisitTypeSelected=false;$scope.previousVisitTypeName="";$scope.chairTimes="";$scope.hideTimeSlotValidation=1;$scope.ikEnableAppointmentBillingData=false;$scope.iHubConsentIconShow=false;$scope.childScreenBackdrop=false;$scope.importPtDemographicsView='';$scope.showAlertPopup={"delete":false,backdrop:false,title:"",errorMessage:[]};$scope.hide_labdiprocedureprompt=false;var defaultAlertTitle="eClinicalWorks";if(getItemKeyValue("EnableAppointmentBillingData").toLowerCase()=="yes"){$scope.ikEnableAppointmentBillingData=true}$scope.setVisitSubTypeId=function(visitSubTypeId){$scope.appointmentVisitSubType.id=visitSubTypeId};if(appointmentScopeGlobalVariables.visitSubTypeId){$scope.setVisitSubTypeId(appointmentScopeGlobalVariables.visitSubTypeId)}$scope.enableWVIndicator=getItemKeyValue("EnableWVIndicator").toLowerCase()==="yes";newAppointmentFnNameSpace.saveUserProfile=function(){var xmlDoc=$scope.getUserProfileXml();$.ajax({type:"POST",url:'/mobiledoc/jsp/catalog/xml/SaveUserProfile.jsp?UserId='+global.TrUserId+'&sessionDID=0&rnd2=0.2118096&timestamp='+(new Date).getTime(),data:{"FormData":xmlDoc},"async":false,success:function(msg){}})};newAppointmentFnNameSpace.checkIfEmpty=function(value){if(typeof value==='undefined'||value=="0"||value==""||value==null)return true;else return false};newAppointmentFnNameSpace.showAlertMessage=function(header,body){$('#alertHeader').html(header);$('#alertMessage').html(body);$('#alertModal').modal()};newAppointmentFnNameSpace.getPatientEncounters=function(patientId){var ptEncountersXML="";var serverUrl=makeURL('/mobiledoc/jsp/catalog/xml/getPtEncounters.jsp?PatientId='+patientId);ptEncountersXML=urlGet(serverUrl);var x2js=new X2JS;var jsonData=x2js.xml_str2json(ptEncountersXML);return jsonData.Envelope.Body['return'].resultset.data.row};newAppointmentFnNameSpace.checkWebEnable=function(element){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;var el=$(element);var email=el.val();var autoEnable=$("#_autoWebEnable").val();ecwAlert(autoEnable,defaultAlertTitle);if(autoEnable=="true"){if(re.test(email)){$("#_checkWebEnable").prop('checked',true)}else{$("#_checkWebEnable").prop('checked',false)}}};newAppointmentFnNameSpace.confirmDialog=function(message,className,callback,title){return newAppointmentFnNameSpace.confirmDialogWithHtmlMsg(message,className,callback,false,title)};newAppointmentFnNameSpace.confirmDialogWithHtmlMsg=function(message,className,callback,doesMsgContainHtml,title){if(angular.isUndefined(title)||$.trim(title).length===0){title=$scope.bHealowPlusEnabled?"Healow":"eClinicalWorks"}return bootbox.confirm({size:'small','z-index':10001,title:title,className:className,message:doesMsgContainHtml?message:escapeHtml(message),buttons:{'confirm':{label:'Yes',className:'btn btn-blue btn-xs mr5'},'cancel':{label:'No',className:'btn btn-lgrey btn-xs pull-right'}},callback:callback})};function getECWDescFromCode(code){let desc="";let selectedCode=$.trim(code).toUpperCase();for(let i=0;i<$scope.ecwVisitTypeRuleList.length;i++){let ecwVisitCode=$scope.ecwVisitTypeRuleList[i].CODE.toUpperCase();let ecwDesc=$.trim($scope.ecwVisitTypeRuleList[i].DESC).toLowerCase();if(ecwVisitCode===selectedCode&&(ecwDesc===$scope.ECW_CHECKIN.toLowerCase()||ecwDesc===$scope.ECW_CHKOUT.toLowerCase()||ecwDesc===$scope.ECW_PENDING.toLowerCase())){desc=$scope.ecwVisitTypeRuleList[i].DESC;break}}return desc.toLowerCase()}$scope.showFamilyBookingAlert=false;$scope.loadFamilyApptModal=function(){$scope.showFamilyBookingAlert=true};$scope.familyBookingConfirmYes=function(){$scope.showFamilyBookingAlert=false;$scope.createAppointment(12)};$scope.familyBookingConfirmNo=function(){$scope.showFamilyBookingAlert=false};$scope.openFamilyApptModal=function(){$scope.closeApptScreen()};$scope.openFamilyBookingModal=function(){var appointmentData={};appointmentData.modulename="familyAppointmentModule";appointmentData.dependencies=["/mobiledoc/jsp/webemr/scheduling/familyAppointment/assets/js/familyApptModalCtrl.js"];appointmentData.url=makeURL("/mobiledoc/jsp/webemr/scheduling/familyAppointment/family-appointment-modal.jsp?encounterId="+$scope.encounterId+"&slotInterval="+$scope.interval);$ocLazyLoad.load({name:appointmentData.modulename,files:appointmentData.dependencies,cache:true}).then(function(){$scope.$parent.familyBookingUrl.url=appointmentData.url},function(e){});$scope.saveFromVal=""};$scope.openPatientFamilyHub=function(){let familyHubData={};$scope.familyPatientContactInfoUrl="";let url="?ptName="+encodeURIComponent(patientName)+"&relatedptid="+$scope.patientId+"&parentScreen=appointment";familyHubData.modulename="FamilyHub";familyHubData.dependencies=['/mobiledoc/jsp/webemr/toppanel/patientInfo/js/familyHubModalCtrl.js'];familyHubData.url=makeURL("/mobiledoc/jsp/webemr/toppanel/patientInfo/familyHubModal.jsp"+url);$ocLazyLoad.load({name:familyHubData.modulename,files:familyHubData.dependencies,cache:true}).then(function(){$scope.familyPatientContactInfoUrl=familyHubData.url},function(e){})};$scope.closeFamilyHubInParent=function(){$scope.familyPatientContactInfoUrl="";$templateCache.remove($scope.familyPatientContactInfoUrl)};$scope.setMinMarginForOK=function(){$scope.classForMargin={'margin-right':'0px'}};$scope.setMaxMarginForOK=function(){$scope.classForMargin={'margin-right':'10px'}};$scope.setMaxBodyHeight=function(){if($scope.patientDtls.patient.id>0){$scope.bodyHeight.height='568px';$scope.approveHeight.height='568px';$scope.apptHeight.height='482px'}else{$scope.bodyHeight.height='568px';$scope.approveHeight.height='568px';$scope.apptHeight.height='503px'}if($scope.client=="MassMutual"){$scope.bodyHeight.height='595px';$scope.approveHeight.height='595px';$scope.apptHeight.height='508px'}};$scope.setMinBodyHeight=function(){if(typeof $scope.patientDtls.patient.id==undefined||typeof $scope.patientDtls.patient.id=="undefined"||$scope.patientDtls.patient.id<=0){$scope.bodyHeight.height='559px';$scope.approveHeight.height='559px';$scope.apptHeight.height='494px'}};$scope.getPatientName=function(){var value='';var CHAR_LIMIT=20;if(!angular.isUndefined($scope.ptName)){var value=$scope.ptName;if(value.length>CHAR_LIMIT){value=value.substring(0,CHAR_LIMIT)+'...'}}return value};$scope.showCaseDetail=function(action){var patientName=$scope.ptName;var caseid=0;if(action=='edit'){caseid=$scope.caseIdForPatient;if(typeof caseid==='undefined'||caseid===""||caseid==="0"){showMessage('Please select a case');return}}var patientid=$scope.patientId;$scope.paramCaseDetail={patientId:patientid,pagename:"",caseId:caseid};$scope.paramCaseDetailApptSch={pagename:""};var queryString="&case_id="+caseid+"&patient_id="+patientid;if(typeof patientName!=="undefined"){$scope.paramCaseDetail.patientName=patientName;queryString+="&patient_name="+patientName}queryString+="&parentScreen=Appointment";$scope.paramCaseDetailApptSch.pagename=makeURL("/mobiledoc/jsp/webemr/webpm/casemanager/casedetail.jsp")+queryString;$("#divCaseDetails").modal("show")};$scope.getReferralDropDown=function(){var patientid=$scope.patientId;var nDoctorId=appointmentScopeGlobalVariables.nDoctorId1;if($scope.encounterId==0){var queryString="&encounterId="+$scope.encounterId+"&PatientId="+$scope.patientId+"&EncounterDate="+$scope.StDate+"&ProviderId="+$scope.appointmentProvider.providerId}else{var queryString="&encounterId="+$scope.encounterId+"&PatientId="+$scope.patientId+"&EncounterDate="+$scope.StDate+"&ProviderId="+nDoctorId}$.ajax({url:makeURL("/mobiledoc/jsp/webemr/referral/getAppointmentReferralDropDown.jsp")+queryString,success:function(referralDropDown){if(typeof referralDropDown!='undefined'&&referralDropDown!=null&&referralDropDown!=''){$scope.referralDropDown=JSON.parse(referralDropDown.trim());$scope.$apply()}}})};$scope.getCaseNameDropDown=function(){let patientid=$scope.patientId;$.ajax({type:"POST",url:makeURL("/mobiledoc/jsp/webemr/webpm/casemanager/getCaseNameDropDown.jsp"),data:$.param({case_id:$scope["case"],patient_id:patientid}),success:function(caseDetails){if(typeof caseDetails!='undefined'&&caseDetails!=null&&caseDetails!=''){$scope.caseDetails=returnDataArray(xml2json(caseDetails).Envelope.Body["return"].resultset.data.row);if(!(typeof $scope.caseDetails!='undefined'&&$scope.caseDetails.length>0)){$scope.disableCase=true;$scope.EnableCaseManger=false}else{$scope.caseButton={'background-color':'#F6F088'};$scope.EnableCaseManger=true}if($scope.$$phase!='$apply'&&$scope.$$phase!='$digest'){$scope.$apply()}$scope.getPtAddressInfo(patientid)}}})};$scope.getEhxStatus=function(nPatientId){if($scope.empiEnabled){if(nPatientId>0){var promiseEhxData=getPromiseForPtEhxData(nPatientId,global.TrUserId,'all',"appt");promiseEhxData.then(function(ehxData){$scope.empiColorIconClass=ehxData.empiIconClass;$scope.empiPtHasNew=ehxData.newDataEhx;if($scope.$$phase!='$apply'&&$scope.$$phase!='$digest'){$scope.$apply()}},function(errorMsg){ecwAlert("req getPromiseForPtEhxData rejected from getEhxStatus in new appt",defaultAlertTitle)})}}};$scope.showClaimData=function(){$scope.paramClaimData={pagename:""};var queryString="&enc_id="+$scope.encounterId;$ocLazyLoad.load({name:'claimDataAngApp',files:['/mobiledoc/jsp/webemr/webpm/casemanager/js/claimdata.js']}).then(function(){$scope.paramClaimData.pagename=makeURL("/mobiledoc/jsp/webemr/webpm/casemanager/claimdata.jsp")+queryString},function(e){});$("#divClaimData").modal("show")};$scope.saveProviderTimeSlots=function(){if(jQuery().timeSlotPicker){var providerTimeSlots=JSON.stringify($("#provider-slots").timeSlotPicker('getTimeSlots')).length>2?JSON.stringify($("#provider-slots").timeSlotPicker('getTimeSlots')):$scope.providerTimes;var assistantTimeSlots=JSON.stringify($("#provider-slots").timeSlotPicker('getTimeSlots')).length>2?JSON.stringify($("#assistant-slots").timeSlotPicker('getTimeSlots')):$scope.resourceTimes;var chairTimeSlots=JSON.stringify($("#provider-slots").timeSlotPicker('getTimeSlots')).length>2?JSON.stringify($("#chair-slots").timeSlotPicker('getTimeSlots')):$scope.chairTimes}else{var providerTimeSlots=$scope.providerTimes;var assistantTimeSlots=$scope.resourceTimes;var chairTimeSlots=$scope.chairTimes}$.ajax({type:"POST","async":false,url:"/mobiledoc/dental/dentalApptResourceDetail/saveApptDetails/",data:JSON.stringify({"encId":$scope.encounterId,"providerTime":providerTimeSlots,"resourceTime":assistantTimeSlots,"chairTime":chairTimeSlots,"isDental":$scope.appointmentVisitType.DentalVisit}),error:function(){ecwAlert('An error occured while saving Provider/Assistant Time. Please try again.',defaultAlertTitle)},contentType:'application/json'})};$scope.setProviderSlots=function(){$.ajax({type:"POST","async":false,url:"/mobiledoc/dental/dentalApptResourceDetail/getProviderRessourceSlotsForEncounter/"+parseInt($scope.encounterId),success:function(data){if(data!=null){$scope.providerTimes=data.providerTime;$scope.resourceTimes=data.resourceTime;$scope.chairTimes=data.chairTime;$scope.isScreenEdited=true}},error:function(){ecwAlert('An error occured while fetching Provider/Assistant Time. Please try again.',defaultAlertTitle)},dataType:'JSON',contentType:'application/json'})};$("#modal-provider-assistance").on("hidden.bs.modal",function(){$scope.hideTimeSlotValidation=1});$scope.setProviderSlotsAfterTP=function(){if(isProviderScheduleVerticalBarsEnabled){$.ajax({type:"POST","async":false,url:"/mobiledoc/dental/dentalApptResourceDetail/getProviderRessourceSlotsForEncountertPAppt/"+parseInt($scope.patientId)+"/"+parseInt($scope.encounterId),success:function(data){if(data!=null&&data.toString().length>0&&data.providerTime!=null){if(data.providerTime.length>0){$scope.providerTimes=JSON.stringify(data.providerTime);var providerEndTime=data.providerTime[data.providerTime.length-1];if(data.resourceTime!=null&&data.resourceTime.length>0){var resourceEndTime=data.resourceTime[data.resourceTime.length-1];$scope.resourceTimes=JSON.stringify(data.resourceTime)}if(data.chairTime!=null&&data.chairTime.length>0){var chairEndTime=data.chairTime[data.chairTime.length-1];$scope.chairTimes=JSON.stringify(data.chairTime)}else{$scope.chairTimes='[]'}if(data.chairTime!=null&&data.chairTime.length>0&&data.resourceTime!=null&&data.resourceTime.length>0){$scope.appointmentDuration=Math.round(Math.max(providerEndTime.endValue,resourceEndTime.endValue,chairEndTime.endValue)*100/100)}else if(data.resourceTime!=null&&data.resourceTime.length>0){$scope.appointmentDuration=Math.round(Math.max(providerEndTime.endValue,resourceEndTime.endValue)*100/100)}else{$scope.appointmentDuration=Math.round(Math.max(providerEndTime.endValue,0)*100/100)}$scope.appointmentDurationChange()}}},error:function(){ecwAlert('An error occured while fetching Provider/Assistant Time. Please try again.',defaultAlertTitle)},dataType:'JSON',contentType:'application/json'})}};$scope.setAliasNameInReason=function(){var aliasNameOrReasonItemId=getItemKeyValue("DentalAliasNameOrReasonField",true);var aliasNameOrReasonItemValue=getItemKeyValue("DentalAliasNameOrReasonField",false);if(aliasNameOrReasonItemId==='1'&&aliasNameOrReasonItemValue==='yes'){$.ajax({type:"POST","async":true,url:"/mobiledoc/jsp/dental/serviceDentalProcedureSetup.jsp",data:{"action":"getDentalAliasNameDescription","encounterId":$scope.encounterId},success:function(returnData){if(returnData){if(!$scope.appointmentReason.name){$scope.appointmentReason.name=returnData.trim();$('#reason-lookupIpt1').val(returnData.trim())}else{$scope.appointmentReason.name=$scope.appointmentReason.name+"; "+returnData.trim();$('#reason-lookupIpt1').val($('#reason-lookupIpt1').val()+"; "+returnData.trim())}$scope.reasonChange()}},dataType:'text'})}};$scope.showAdditionalBillingData=function(){var strUrl="/mobiledoc/jsp/webemr/scheduling/newApptAddlBillingData.jsp";$ocLazyLoad.load({name:"newApptAddlBillingDataModule",files:["/mobiledoc/jsp/webemr/scheduling/js/newApptAddlBillingDataCtrl.js"],cache:false}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL(strUrl),controller:'newApptAddlBillingDataCtrl',windowClass:'app-modal-window bluetheme  medium-width',backdrop:"static",keyboard:false,resolve:{resolveData:function(){return{encounterId:$scope.encounterId,patientId:$scope.patientId,arriveTime:$scope.arriveTime,closePopupFromAddlBillingData:$scope.closePopupFromAddlBillingData,parentForm:parentForm,visitStatusCode:$scope.appointmentVisitStatus.code,parentScreen:'newApptController',encDate:$scope.getStartDateInYYYYMMDD()}}}})})};$scope.checkAddlBiilingDataModified=function(){var responsePromise=$http.get(makeURL("/mobiledoc/jsp/catalog/xml/edi/InitialTreatmentDate/getInitialTreatmentDate.jsp?EncounterId="+$scope.encounterId));responsePromise.success(function(resp,status,headers,config){var conjson=convertInJSON(resp);if(conjson!=null){var value=conjson.Envelope.Body['return'];if(value.status=="success"&&value.Rule.isBillingDataModified=="true"){$scope.showAddlBillingDataNote=true}else{$scope.showAddlBillingDataNote=false}}},function(error){})};$scope.openPatientDocument=function(){PSACService.checkCommonStaffPermission($scope.patientId,function(data){$ocLazyLoad.load({name:'PtDocsModule',files:['/mobiledoc/jsp/webemr/toppanel/patientdocs/js/patientdocs.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/patientdocs/patientdocs.jsp?patientId="+$scope.patientId+"&encounterId="+$scope.encounterId+"&patientName="+$scope.ptName+"&nd="+(new Date).getTime());$scope.patientinfohuburlAppt=url},function(e){})},function(){})};$scope.reminderListArray=[];$scope.getReminderList=function(){var xml=$scope.getPtRemListXml();$.ajax({type:"POST",url:makeURL('/mobiledoc/jsp/catalog/xml/getApptReminderList.jsp?FormData='+xml),data:{MaxCount:18,Counter:1},"async":false,success:function(msg){success_getReminderList(msg)}})};function success_getReminderList(msg){if(!newAppointmentFnNameSpace.checkIfEmpty(msg)){$scope.reminderListArray=returnDataArray(xml2json(msg).Envelope.Body["return"].items.item)}}$scope.getTelevisitsCodeIds=function(){$http.get(makeURL("/mobiledoc/jsp/webemr/scheduling/Controller.jsp"),{params:{action:"getTeleVisitCodeIds"}}).success(function(data){if(data!=null&&data!=undefined&&data.length>0){$scope.teleVisitCodesIds=data}})};$scope.getASAPCheckboxValue=function(){$http.get(makeURL("/mobiledoc/jsp/webemr/scheduling/Controller.jsp"),{params:{action:"getApptASAPCheckboxValue",encId:$scope.encounterId}}).success(function(data){if(data!=null&&data!=undefined){var status=data.status;var id=data.id;if(status!=null&&status!=undefined){if(status.toLowerCase()==="success"&&parseFloat(id)>0){$scope.chkASAPList=true;$scope.asapData.date=data.date;$scope.asapData.startTime=data.startTime;$scope.asapData.endTime=data.endTime}}}})};$scope.getPtRemListXml=function(){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('items');xw.writeStartElement('item');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'providerid',0,'xsi:type','xsd:string');addElement(xw,'datefrom','','xsi:type','xsd:string');addElement(xw,'dateto','','xsi:type','xsd:string');addElement(xw,'template','','xsi:type','xsd:string');addElement(xw,'patientid',$scope.patientId,'xsi:type','xsd:string');xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();return xml};$scope.launchCommonwell=function(patientId){$scope.commonwellUrl="";$ocLazyLoad.load({name:'commonWellApp',files:['/mobiledoc/jsp/webemr/css/common-welllink.css','/mobiledoc/jsp/webemr/interfaces/js/commonWell.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/interfaces/commonWell.jsp?pid="+patientId+"&TrUserId="+global.TrUserId);$scope.commonwellUrl=url},function(e){})};$scope.multiCopayFlag=false;$scope.addPatientPayment=function(multiCopayFlag){newAppointmentFnNameSpace.confirmDialog('This will save the appointment data. Do you want to continue?','bluetheme',function(result){if(result){$scope.multiCopayFlag=multiCopayFlag&&multiCopayFlag===1&&!$scope.coPayCb&&!$scope.isNonBillable;$scope.createAppointment(7)}})};$scope.showPatientPayment=function(paymentId){if($scope.isFloatingToolbar){return}var copay=$.trim($scope.mCoPaytext).length==0?'-1':$.trim($scope.mCoPaytext);if($scope.isUserHasPaymentAccess(paymentId)==false){return}if($scope.patientId>0&&$scope.encounterId>0){var param={paymentId:paymentId,parentScreen:'newApptController',encId:$scope.encounterId};loadReceivePayment($ocLazyLoad,$modal,param)}};$scope.isUserHasPaymentAccess=function(paymentId){var bResult=true;url=makeURL("/mobiledoc/jsp/catalog/xml/edi/isUserHasPaymentAccess.jsp?paymentId="+paymentId);$.ajax({type:"POST",url:makeURL(url),"async":false,success:function(data){try{data=data.replace("<return>","<returnData>").replace("</return>","</returnData>");data=x2js.xml_str2json(data);data=data.Envelope.Body.returnData;var result=data.status;if(result=="failed"){bResult=false;ecwAlert("You do not have permission to access this payment.",defaultAlertTitle)}}catch(err){ecwAlert("Error while permission to access this payment."+err,defaultAlertTitle)}}});return bResult};$scope.refreshPanel=function(){$scope.isFirstTimeLoad=false;$scope.showRightChartPanelHeading=false;$scope.commonwellUrl="";$scope.panelUrl="";$scope.panelUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId='+$scope.encounterId+'&PtId='+$scope.patientId+'&facilityId='+$scope.facilityId+'&RxCheck=Nothing&sessionDID=0&ecwappprocessid=281&date='+(new Date).getTime());$scope.getPtDemographicsImportData()};$scope.accountAndPatienBalance=function(){let param={patientId:$scope.patientId,contextFrom:'appointment',fromDate:""};loadAccountsInquiry($ocLazyLoad,$modal,param)};$scope.modalclose=true;$scope.dateFormat='MM/DD/YYYY';$scope.timeFormat='hh:mm a';$scope.pickerDateFormat="mm/dd/yy";$scope.parentClass="sm";$scope.ikenableFacilityAccess=false;if(getItemKeyValue("enableFacilityAccess").toLowerCase()=="yes"){$scope.ikenableFacilityAccess=true}$scope.transPortationRequired='0';$scope.ikenableHumanaChanges=false;if(getItemKeyValue("HumanaChanges").toLowerCase()=="yes"){$scope.ikenableHumanaChanges=true}$scope.providerForNewApptScroll=[];$scope.tempProvArray=[];$scope.providerForNewAppintment=[];$scope.providerCount=JSON.parse(providerAndResourceCount);$scope.maxLoad=10;$scope.maxAllowedLength=$scope.maxLoad;$scope.pageNo=0;$scope.recordsPerPage=10;$scope.maxCount=$scope.providerCount.allProviderCount;$scope.totalPage=parseInt($scope.maxCount/$scope.recordsPerPage);if($scope.totalPage<$scope.maxCount/$scope.recordsPerPage){$scope.totalPage=$scope.totalPage+1}$scope.minValue=false;$scope.getDoctorsDetailsWithPagination=function(islaodfirsttime){$scope.pageNo=$scope.pageNo+1;if($scope.pageNo<=$scope.totalPage){var url='';if(!$scope.ikenableFacilityAccess){url='/mobiledoc/jsp/webemr/scheduling/Controller.jsp?action=getDoctorsWithPagination&page='+$scope.pageNo+'&recordsPerPage='+$scope.recordsPerPage+'&minValue='+$scope.minValue}else{url='/mobiledoc/jsp/webemr/scheduling/Controller.jsp?action=getAuthorizedProviderWithPagination&UserId='+global.TrUserId+'&facId='+$scope.facilityId+'&page='+$scope.pageNo+'&recordsPerPage='+$scope.recordsPerPage+'&minValue='+$scope.minValue}$http({method:"POST",url:makeURL(url),cache:false}).success(function(response){var data;if(typeof response!='object'){data=JSON.parse(response.trim())}else if(typeof response=='object'){data=response}var result=data.result;if(!data.result){result=data}angular.forEach(result,function(rowData){$scope.providerForNewAppintment.push(rowData)});if($scope.encounterId>0){$scope.showProviderIfInactive($scope.encData.doctorid)}setTimeout(function(){$('[data-toggle="tooltip"]').tooltip({container:'body'})},500)})}};try{if(!$scope.ikenableFacilityAccess){try{$scope.getDoctorsDetailsWithPagination(true)}catch(err){ecwAlert("error while getting provider",defaultAlertTitle)}}else{if(!newAppointmentFnNameSpace.checkIfEmpty(authorizedProviderJArray)&&authorizedProviderJArray.length>0){$scope.providerForNewAppintment=[];$scope.providerForNewAppintment=returnDataArray(authorizedProviderJArray);$scope.inSearchMode=false;$scope.pageNo=1}else{$scope.providerForNewAppintment=[]}}}catch(err){ecwAlert("error while getting provider(KFacilityAccess)",defaultAlertTitle)}$('.dropDownForPr1').bind('scroll',function(){var diff=$(this)[0].scrollHeight-($(this).scrollTop()+$(this).height());if(diff<=10){if(!$scope.inSearchMode&&$scope.maxCount>$scope.providerForNewAppintment.length){$scope.getDoctorsDetailsWithPagination()}}});$scope.occFlag="";$scope.emgFlag="";if($scope.client==="MassMutual"&&!newAppointmentFnNameSpace.checkIfEmpty(strXmlForVisitSubType)){$scope.occFlag=xml2json(strXmlForVisitSubType).Envelope.Body["return"].encounter.occflag;$scope.emgFlag=xml2json(strXmlForVisitSubType).Envelope.Body["return"].encounter.emgflag}$scope.caseDetails={};$scope.referralDropDown={};$scope.disableCase=false;$scope.caseButton={'background-color':'#E5E2E2'};if(typeof caseDetails!='undefined'&&caseDetails!=null&&caseDetails!=''){$scope.caseDetails=returnDataArray(xml2json(caseDetails).Envelope.Body["return"].resultset.data.row)}$scope.getCasesForPatient=function(){$scope.EnableCaseMangerForNewCase=true;$http({method:"POST",url:makeURL('/mobiledoc/jsp/casemanager/GetCasesForPatient.jsp'),cache:true,params:{ptid:$scope.patientId}}).success(function(data,status,headers,config){if(data!=null&&data.trim()!=''){$scope.caseDetails=returnDataArray(xml2json(data).Envelope.Body["return"].resultset.data.row);$scope["case"]="0";if(typeof $scope.caseDetails!='undefined'&&$scope.caseDetails.length>0){$scope.EnableCaseManger=true;$scope.caseButton={'background-color':'#F6F088'}}else{$scope.EnableCaseManger=false;$scope.caseButton={'background-color':'#e1e1e1'}}}else{$scope.caseButton={'background-color':'#e1e1e1'}}}).error(function(data,status,headers,config){ecwAlert("Error occured while getting case manager list",defaultAlertTitle)})};$scope.referralDetails={};if(typeof referralXml!='undefined'&&referralXml!=''){$scope.referralDetails=xml2json(referralXml).Envelope.Body["return"].encounter}$scope.showCode=false;$scope.AuthNo="";$scope.referralNo="";$scope.refdate="";$scope.p2p=false;$scope.showRefWarning=false;$scope.referralData="";$scope.referralReasonData="";$scope.showReferralData=function(){$scope.showRefWarning=false;$scope.showCode=true;if(!angular.isUndefined($scope.referralDetails.authNo)&&$scope.referralDetails.authNo.length>0){$scope.AuthNo=$scope.referralDetails.authNo}else{$scope.referralNo=$scope.referralDetails.referralNo}$scope.refdate=$scope.referralDetails.date;$scope.referralIDNew=$scope.referralDetails.referral;if(typeof $scope.referralDetails.refToName!=='undefined'&&$scope.referralDetails.refToName!==""){$scope.referralData=$scope.referralDetails.refToName}if(typeof $scope.referralDetails.speciality!=='undefined'&&$scope.referralDetails.speciality!==""){$scope.referralData=$scope.referralData+" ("+$scope.referralDetails.speciality+")"}if($scope.referralDetails.nhxRefReqId>0){$scope.p2p=true}else{$scope.p2p=false}};$scope.showReferralWarning=function(){$scope.showCode=false;$scope.showRefWarning=true};if(typeof $scope.referralDetails!='undefined'&&$scope.referralDetails!=""){try{if($scope.referralDetails.nhxRefReqId>0||$scope.referralDetails.referral>0){$scope.showReferralData()}else{if(typeof referralStatusXml!='undefined'&&referralStatusXml!=""){if(referralStatusXml.toLowerCase()=="yes"){$scope.showReferralWarning()}}}}catch(err){ecwAlert("error while getting ref authno and date",defaultAlertTitle)}}$scope.ptPmtDetail={};if(typeof paymentXml!='undefined'&&paymentXml!=''){$scope.ptPmtDetail=returnDataArray(xml2json(paymentXml).Envelope.Body["return"].resultset.data.row)}$scope.showClaimPrNote=false;if(!newAppointmentFnNameSpace.checkIfEmpty(strXmlForClaimProvider)){var jsonObj=xml2json(strXmlForClaimProvider).Envelope.Body["return"].Appt;if(jsonObj.PayTo>0){$scope.showClaimPrNote=true}else{$scope.showClaimPrNote=false}}$scope.patientNextAppointMent=[];$scope.panelStatus="0";$scope.panelStatus=getUserProfile("ApptRightPanel");$scope.facilityData=[];if(!newAppointmentFnNameSpace.checkIfEmpty(facilityArray)&&facilityArray.length>0){$scope.facilityData=facilityArray}$scope.ikEnableApptRightPanel=false;if(getItemKeyValue("EnableApptRightPanel").toLowerCase()=="yes"){$scope.ikEnableApptRightPanel=true}$scope.paymentCount=0;try{if(!newAppointmentFnNameSpace.checkIfEmpty(claimPaymentCount)){$scope.paymentCount=claimPaymentCount}}catch(err){$scope.paymentCount=0;ecwAlert("error while getting payment count",defaultAlertTitle)}$scope.onClickNb=function(){newAppointmentFnNameSpace.confirmDialog("Are you sure you want to make the Visit as Non Billable?",'bluetheme',function(result){if(result){$scope.$apply(function(){$scope.isNonBillable=true})}else{$scope.$apply(function(){$scope.isNonBillable=false})}})};$scope.loadRightPanelUI=function(){$timeout(function(){var rpane=$('#ic-tog1').closest('.modal').find('#newApptDialog');var rightpaneltog=$('#ic-tog1').closest('.modal').find('.app-wrpap .right-panel');if($scope.ikEnableApptRightPanel){if($scope.panelStatus==="0"){$scope.setMinMarginForOK();rpane.animate({"width":"750"},"1000").removeClass('visible');rightpaneltog.animate({"right":"-336px"},"1000").removeClass('visible');$scope.Dialog.width="750px"}else if($scope.panelStatus==="1"){$('#rptog').addClass('active');rpane.animate({"width":"1080px"},"1000").addClass('visible');rightpaneltog.animate({"right":"-336px"},"1000").addClass('visible');$scope.setMaxMarginForOK();$scope.Dialog.width="1080px"}}else{$scope.setMinMarginForOK();rpane.animate({"width":"750"},"1000").removeClass('visible');rightpaneltog.animate({"right":"-336px"},"1000").removeClass('visible');$scope.Dialog.width="750px"}},100)};$scope.checkSlidingStatus=function(xml){var slidingFeeStatus=3;try{var jsonData=xml2json(xml).Envelope.Body["return"];if(!newAppointmentFnNameSpace.checkIfEmpty(jsonData.AssignedStatus)){slidingFeeStatus=jsonData.AssignedStatus}else{slidingFeeStatus=3}}catch(err){ecwAlert("Error occured during Check Patients Sliding Status",defaultAlertTitle)}if(!(slidingFeeStatus==1||slidingFeeStatus==3)){newAppointmentFnNameSpace.confirmDialog("Sliding Fee status is expired. Do you want to assign a new sliding fee status?",'bluetheme',function(result){if(result){$scope.$apply(function(){$scope.openPatientInfo()})}else{return}})}};if(!newAppointmentFnNameSpace.checkIfEmpty(strXmlForSlidingFeeSch)){try{$scope.checkSlidingStatus(strXmlForSlidingFeeSch)}catch(err){ecwAlert("error while getting sliding status:enc",defaultAlertTitle)}}$scope.claimEncId=0;try{if(!newAppointmentFnNameSpace.checkIfEmpty(encClaimStrXml)){$scope.claimEncId=returnDataArray(xml2json(encClaimStrXml).Envelope.Body["return"].EncClaim.encId)}}catch(err){ecwAlert("error while getting cliam enc id",defaultAlertTitle)}$scope.conStatus="";$scope.concentColor="red";$scope.showConsentStatus=false;$scope.getConsentData=function(xml){try{$scope.showConsentStatus=true;var jsonData=xml2json(xml).Envelope.Body["return"].ConsentFormList;$scope.conStatus=jsonData.ConsentForm[0].Text+" : "+jsonData.ConsentForm[0].Value+","+jsonData.ConsentForm[1].Text+" : "+jsonData.ConsentForm[1].Value+","+jsonData.ConsentForm[2].Text+" : "+jsonData.ConsentForm[2].Value;if(jsonData.ConsentForm[0].Value.toLowerCase()=="yes"&&jsonData.ConsentForm[1].Value.toLowerCase()=="yes"&&jsonData.ConsentForm[2].Value.toLowerCase()=="yes"){$scope.concentColor="green"}else{$scope.concentColor="red"}}catch(err){ecwAlert("Error while getting consent details",defaultAlertTitle)}};if(!newAppointmentFnNameSpace.checkIfEmpty(strXmlForconcentStatus)){try{if($(strXmlForconcentStatus).find('status').text()=="success"){$scope.getConsentData(strXmlForconcentStatus)}else{$scope.showConsentStatus=false}}catch(err){ecwAlert("error while getting consent data : edit encounter",defaultAlertTitle)}}$scope.isVision=isVision;$scope.viitTypeTobeAdeed=[];$scope.selResorceId=global.TrUserId;$scope.appointmentStartTime={time:''};$scope.appointmentEndTime={time:''};$scope.mProvider="";$scope.facilityId="";$scope.pos="";$scope.deptName="";$scope.deptId=0;$scope.encounterId="";$scope.isNonBillable=false;$scope.generalNotes="";$scope.billingNotes="";$scope.transitionOfCare=0;$scope.isNewPt=false;$scope.StDate=moment().format($scope.dateFormat);$scope.endDate=moment($scope.StDate).add(1,'y').format($scope.dateFormat);$scope.apptreasons="";$scope.apptDiagnosis=[];$scope.jsonDataForVtRule=[];$scope.jsonDataForVtRecRule=[];$scope.structDataForBillingNotes=false;$scope.ikEnableDepartments=false;$scope.cliamReq=1;$scope.copayChanged=0;$scope.ikenableRefProvider=false;$scope.ikvisitTypeSecurity=false;$scope.gender="";$scope.ptName="";$scope.strTotalVisit=0;$scope.mCoPaytext="";$scope.strruleStartTime="";$scope.strruleEndTime="";$scope.noOfVisitAllowed=0;$scope.ikncorrectionalFeature=false;$scope.bBooked=false;$scope.ikIsSIUOutboundConfigured=false;$scope.ikBrocktonInterface=false;$scope.encounterData=[];$scope.scheduleBumpApppt=false;$scope.showvsDropDown=false;$scope.mousedown=false;$scope.showProviderDropdown=false;$scope.providerSelected=true;$scope.appointmentResource={};$scope.appointmentDuration="60";$scope.appointmentProvider={};$scope.ikRecordPatientWaitTime=false;$scope.ikEncStatusCycleTime=false;$scope.ikEnableMeasureProfiling=false;$scope.ikEnableClinicalRuleEngine=false;$scope.ikEnableSaveAndViewAppt=false;$scope.ikIsDepartmentMandatory=false;$scope.ikEnableCaseManager=false;$scope.ikReferralEnable=false;$scope.ikPreregPatients=false;$scope.ikEnableWebPortal=false;$scope.ikEnterpriseDirectory=false;$scope.ikEnableFacilityAsMasterList=false;$scope.waitTime="00:00:00";$scope.address="";$scope.isWebEnabled="";$scope.webEnblaeValue=false;$scope.referralId=0;$scope.isDisabled=false;$scope.ikEnableASAPList=false;$scope.asapData={date:"",startTime:"",endTime:""};$scope.chkASAPList=false;$scope.isProviderSchedule=true;$scope.ikEnableAddSpecify=false;$scope.mSpecifyVisitType="";$scope.mSpecifyVisitStatus="";$scope.actions={apptAction:1};$scope.miscInfoName={value:""};$scope.nextApptLabel={};$scope.nextApptReason="";$scope.reservedSlotId=0;$scope.healthFundSalesArray=[];$scope.showCancellationReason=false;$scope.cancellationReason="";$scope.disableDelButton=false;$scope.empiEnabled=false;$scope.ikIgnoreProviderMap=false;$scope.visitSubType="";$scope.ikSlidingFeeSchedule=false;$scope.structdataItemId="0";$scope.structdataCapt="S";$scope.ikEnableUTCScheduling=false;$scope.ikWeeksParagonInterface=false;$scope.ikScanBubbleSheet=false;$scope.ikEnableTLCWorkFlow=false;$scope.ikEnableHL7IDUpdate=false;$scope.ikAutoEnablePortal=false;$scope.ikMUParticipate=false;$scope.ikPtReminders=false;$scope.ikDisableSchedulingEnforceProvResCheck=false;$scope.ikEnableOverlakeAcuity=false;$scope.ikPessimisticSecurity=false;$scope.isRegistrationRuleEngine=false;$scope.isIndiaOutPatient=false;$scope.emailClass='col-sm-9';$scope.ikEnableAssociatePatientCasesAppt=false;$scope.EnableCaseManger=false;$scope.EnableCaseMangerForNewCase=false;$scope.EditCase=false;$scope.ikUnlockApptDateTimeWithOrders=false;$scope.iHubConsentCheck=false;$scope.bHealowPlusEnabled=false;$scope.facilityTimeZone="";$scope.oldEncounterData={};$scope.newEncounterData={};if(encType==='deletedEnc'){$scope.disableDelButton=true}if(getItemKeyValue("VisitTypeSecurity").toLowerCase()=="yes"){$scope.ikvisitTypeSecurity=true}if(getItemKeyValue("StructDataForBillingNotes").toLowerCase()=="yes"){$scope.structDataForBillingNotes=true;$scope.structdataItemId=getItemKeyValue("BillingNotes",true);$scope.structdataCapt=getItemKeyValue("StDataCaptionForBillingNotes",true);if(newAppointmentFnNameSpace.checkIfEmpty($scope.structdataCapt)){$scope.structdataCapt="S"}}if(getItemKeyValue("EnableDepartments").toLowerCase()=="yes"){$scope.ikEnableDepartments=true}if(getItemKeyValue("RefPrByAppt").toLowerCase()=="yes"){$scope.ikenableRefProvider=true}if(getItemKeyValue("EnableCorrectionalFeatures").toLowerCase()=="yes"){$scope.ikncorrectionalFeature=true}if(getItemKeyValue("IsSIUOutboundConfigured").toLowerCase()=="yes"){$scope.ikIsSIUOutboundConfigured=true}if(getItemKeyValue("BrocktonInterface").toLowerCase()=="yes"){$scope.ikBrocktonInterface=true}if(getItemKeyValue("EnablePatientWaitTime").toLowerCase()=="yes"){$scope.ikRecordPatientWaitTime=true}if(getItemKeyValue("EncStatusCycleTime").toLowerCase()=="yes"){$scope.ikEncStatusCycleTime=true}if(getItemKeyValue("EnableMeasureProfiling").toLowerCase()=="yes"){$scope.ikEnableMeasureProfiling=true}if(getItemKeyValue("EnableClinicalRuleEngine").toLowerCase()=="yes"){$scope.ikEnableClinicalRuleEngine=true}if(getItemKeyValue("AddSpecify").toLowerCase()=="yes"){$scope.ikEnableAddSpecify=true}if(getItemKeyValue("EnableSaveAndViewNewAppt").toLowerCase()=="yes"){$scope.ikEnableSaveAndViewAppt=true}if(getItemKeyValue("IsDepartmentMandatory").toLowerCase()=="yes"){$scope.ikIsDepartmentMandatory=true}if(getItemKeyValue("PreregPatients").toLowerCase()=="yes"){$scope.ikPreregPatients=true}if(getItemKeyValue("EnableCaseManager").toLowerCase()=="yes"){$scope.ikEnableCaseManager=true}if(getItemKeyValue("ShowReferraldropdowninappt").toLowerCase()=="yes"){$scope.ikReferralEnable=true}if(getItemKeyValue("EnableWebPortal",true)>0){$scope.ikEnableWebPortal=true;$scope.emailClass='col-sm-6'}if(getItemKeyValue("EnableEMPI").toLowerCase()=="yes"){$scope.empiEnabled=true}if(getItemKeyValue("commToInteropHub").toLowerCase()==="yes"||getItemKeyValue("enableExternalRegistries").toLowerCase()==="yes"){$scope.iHubConsentCheck=true}if(getItemKeyValue("IgnoreProviderMap").toLowerCase()=="yes"){$scope.ikIgnoreProviderMap=true}if(getItemKeyValue("SlidingFeeSchedule").toLowerCase()=="yes"){$scope.ikSlidingFeeSchedule=true}if(getItemKeyValue("EnableUTCScheduling").toLowerCase()=="yes"){$scope.ikEnableUTCScheduling=true}if(getItemKeyValue("WeeksParagonInterface").toLowerCase()=="yes"){$scope.ikWeeksParagonInterface=true}if(getItemKeyValue("ScanBubbleSheet").toLowerCase()=="yes"){$scope.ikScanBubbleSheet=true}if(getItemKeyValue("EnableTLCWorkFlow").toLowerCase()=="yes"){$scope.ikEnableTLCWorkFlow=true}if(getItemKeyValue("EnableHL7IDUpdate").toLowerCase()=="1"){$scope.ikEnableHL7IDUpdate=true}if(getItemKeyValue("DisableSchedulingEnforceProvResCheck").toLowerCase()=="yes"){$scope.ikDisableSchedulingEnforceProvResCheck=true}if(getItemKeyValue("AutoEnablePortal").toLowerCase()=="yes"){$scope.ikAutoEnablePortal=true}if(getItemKeyValue("MUParticipate").toLowerCase()=="yes"){$scope.ikMUParticipate=true}if(getItemKeyValue("PtReminders").toLowerCase()=="yes"){$scope.ikPtReminders=true}if(getItemKeyValue("EnableOverlakeAcuity").toLowerCase()=="yes"){$scope.ikEnableOverlakeAcuity=true}if(getItemKeyValue("EnterpriseDirectory").toLowerCase()=="yes"){$scope.ikEnterpriseDirectory=true}if(getItemKeyValue("EnableFacilityAsMasterList",true)==1){$scope.ikEnableFacilityAsMasterList=true}if(getItemKeyValue("PessimisticSecurity").toLowerCase()=="yes"){$scope.ikPessimisticSecurity=true}if(getItemKeyValue("RegistrationRuleEngine").toLowerCase()=="yes"){$scope.isRegistrationRuleEngine=true}if(getItemKeyValue("IndiaOutPatient").toLowerCase()=="yes"){$scope.isIndiaOutPatient=true}if(getItemKeyValue("EnableAssociatePatientCasesAppt").toLowerCase()=="yes"){$scope.ikEnableAssociatePatientCasesAppt=true}if(getItemKeyValue("EnableASAPList").toLowerCase()==="yes"){$scope.ikEnableASAPList=true}$scope.PermissionForWebPortal=false;if(isPermissionForWebPortal=="true"){$scope.PermissionForWebPortal=true}$scope.permissionForPosUpdate=false;if(strPermissionForPosUpdate.toLowerCase()=="true"){if($.trim(getItemKeyValue("LockDownPOS")).toUpperCase()=="YES"){$scope.permissionForPosUpdate=false}else{$scope.permissionForPosUpdate=true}}$scope.permissionForApptCopay=false;if(strPermissionForApptCopay.toLowerCase()=="true"){$scope.permissionForApptCopay=true}$scope.permissionForApptNonBillable=false;if(strPermissionForApptNonBillable.toLowerCase()=="true"){$scope.permissionForApptNonBillable=true}$scope.permissionForApptVisitStatus=false;if(strPermissionForApptVisitStatus.toLowerCase()=="true"){$scope.permissionForApptVisitStatus=true}$scope.permissionForBookOutofOfficeHoursAppointments=false;if(strPermissionForBookOutofOfficeHoursAppointments.toLowerCase()=="true"){$scope.permissionForBookOutofOfficeHoursAppointments=true}$scope.permissionForBookBlockConflictAppointments=false;if(strPermissionForBookBlockConflictAppointments.toLowerCase()=="true"){$scope.permissionForBookBlockConflictAppointments=true}$scope.permissionForBookConflictAppointments=false;if(strPermissionForBookConflictAppointments.toLowerCase()=="true"){$scope.permissionForBookConflictAppointments=true}$scope.permissionForBookAnyVisitTypeAppointment=false;if(strPermissionForBookAnyVisitTypeAppointment.toLowerCase()=="true"){$scope.permissionForBookAnyVisitTypeAppointment=true}$scope.permissionForOverbookAppointments=false;if(strPermissionForOverbookAppointments.toLowerCase()=="true"){$scope.permissionForOverbookAppointments=true}$scope.showBillableWarning=false;$scope.deleteAccess=deleteAccess;if(!$scope.permissionForApptNonBillable){if(typeof showBillableAlert!='undefined'&&showBillableAlert.toLowerCase()=='true'){if($scope.apptNonBillableWarning==1){$scope.showBillableWarning=true}}}$scope.isDisableApptNonBillable=false;if(getItemKeyValue("DisablePopupForNonBillableVisits").toLowerCase()=="yes"){$scope.isDisableApptNonBillable=true}$scope.permissionForAccessOrders=getPermission("AccessOrders",global.TrUserId);$scope.hideApptWarning=function(){$scope.showBillableWarning=false};$scope.flag="";$scope.getDefaultVisitType=function(visitTypeId){let visitTypes=getResouceSpecificMappedVisitTypes(global.TrUserId,"resourceSpecificVisitType");for(var i=0;i<visitTypes.length;i++){if(visitTypes[i].CodeId==visitTypeId)return visitTypes[i]}return{}};$scope.setGeneralNotes=function(notes){$scope.generalNotes=notes};$scope.setAppointmentReason=function(reason){$scope.appointmentReason.name=reason};$scope.defaultVisitType=$scope.getDefaultVisitType(getUserProfile("DefaultVisitTypeId"));$scope.appointmentVisitType.Name=$scope.defaultVisitType.Name;$scope.viewLogsPermission=getPermission("ViewLogsEncounters",global.TrUserId);$scope.disableLog=true;$scope.disableOrders=true;$scope.interval=5;$scope.arriveTime="00:00:00";$scope.arriveTimeInUTC="";$scope.depTime="00:00:00";$scope.depTimeInUTC="";$scope.ECW_CHECKIN="Arrived";$scope.ECW_CHKOUT="Checked out";$scope.ECW_PENDING="PENDING";$scope.encData=[];$scope.caseIdForPatient=0;if(!newAppointmentFnNameSpace.checkIfEmpty(strXMLForMandatoryStructData)){try{var stDataVal=strXMLForMandatoryStructData.trim();if(stDataVal.toLowerCase()=="y"||stDataVal.toLowerCase()=="M"){$scope.structVal=stDataVal.toLowerCase();$scope.stClass.color='#c96565'}}catch(err){ecwAlert("Error while getting mandatory struct data details.",defaultAlertTitle)}}$scope.isInputValidNumber=function(no){var re=/^(\d)+$/;if(re.test(no)){$scope.pos=no}else{$scope.pos=""}};$scope.onSelectCase=function(){$scope.apptForm.$setDirty();$scope.caseIdForPatient=$scope["case"];$scope.EditCase=true;$scope.getPtAddressInfo($scope.patientId)};$scope.clearBillingNotes=function(){$scope.apptForm.$setDirty();$scope.billingNotes=""};$scope.clearGeneralNotes=function(){$scope.apptForm.$setDirty();$scope.generalNotes=""};$scope.notesoptions=[];$scope.saveStructuredData=function(){};var validateStructFields=function(){return dataTruncUtilityService.getTextFieldWidthsFromTable('web_'+$scope.notesoptions.datatabletype,'web_structuredata_dir','bluetheme')};$scope.saveStructureData=function(){$scope.apptForm.$setDirty();if(validateStructData()){if(!validateStructFields()){return}var xmlData=createStructureDataXML(fieldsArray);var aPromise=postStructureData(xmlData,$scope.encounterId,$scope.notesoptions.catId,$scope.notesoptions.itemId,$scope.notesoptions.datatabletype,$http);aPromise.then(function(object){$('#apptActionModalMainId').modal('hide');$scope.actions.apptAction=1},function(error){ecwAlert(error,defaultAlertTitle)})}};$scope.showStructDataForBillingNotes=function(){if(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)){$scope.createAppointment(6)}else{$scope.loadStructDataForBillingNotes()}};$scope.showStButton=true;$scope.openStructuredForm=function(){$scope.showStButton=false};$scope.openStructuredGrid=function(){$scope.showStButton=true};$scope.loadStructDataForBillingNotes=function(){$scope.showStButton=true;$scope.actions.apptAction=10;$('#apptActionModalMainId').modal();$scope.notesoptions['encounterId']=$scope.encounterId;$scope.notesoptions['itemId']=$scope.structdataItemId;$scope.notesoptions['datatabletype']='structApptBillingNotes';$scope.notesoptions['catId']=0;$scope.notesoptions['sessionId']=0;$scope.notesoptions['userId']=$scope.TrUserId;$scope.notesoptions['defaultId']='-1';$scope.notesoptions['stHeight']="415";$scope.notesoptions['showDefaultAllBtn']=true;$scope.notesoptions['showClearAllBtn']=true};$scope.getRxHubFormularyForEnc=function(){$scope.FormularyID=null;$scope.date=moment($scope.StDate).add(-1,'d').format('MM/DD/YYYY');if($scope.encounterId!=""&&$scope.encounterId!="0"){if(strRxHubContent!=''){var x2js=new X2JS;var jsonData=x2js.xml_str2json(strRxHubContent);if(jsonData.ECWERROR!='No Formulary ID is set for this encounter'){var value=jsonData.Envelope.Body['return'];$scope.formularyObj=returnDataArray(value.Formulary);if($scope.formularyObj.length>0){$scope.FormularyID=$scope.formularyObj[0].FormularyID;$scope.FormularySourceCode=$scope.formularyObj[0].FormularySourceCode;$scope.FormularySourceType=$scope.formularyObj[0].FormularySourceType;$scope.PMBID=$scope.formularyObj[0].PBMId}}else{return false}}}};$scope.GetRxEligibilityError=function(){var url="/mobiledoc/jsp/catalog/xml/RxHub/getRxEligibilityErrorDetails.jsp?PatientId="+$scope.patientId+"&SubmissionId=0";url=makeURL(url);var strContent=getUrlRespData(url);if(strContent!==""){var x2js=new X2JS;var jsonData=x2js.xml_str2json(strContent);var value=jsonData.Envelope.Body['return'];if(value.resultset.data!==""){if(value.resultset.data.row!==""){$scope.GetRxEligibilityErrorVar=true}else{$scope.GetRxEligibilityErrorVar=false}}else{return false}}};$scope.isNewAppt=false;$scope.ShowEBEnhanceData=false;$scope.EBDataList=[];$scope.isRecurringAppt=false;$scope.initEncounterProperty=function(){if($scope.isFloatingToolbar){disableScreenControlsForFloatingToolbar()}if(parentForm==='ResourceGrid'){$("#divModalLoader").css("display","none")}$scope.isFirstTimeLoad=true;$scope.encounterId=encId;if($('#slotDuration').val()!=null&&typeof $('#slotDuration').val()!='undefined'){$scope.interval=parseInt($('#slotDuration').val())}if($scope.encounterId!=0){$scope.encData=xml2json(encdata).Envelope.Body["return"].encounter;$scope.encData.facilityTimeZoneCode=encFacTimeZone;$scope.initEncounterData($scope.encData);$scope.EnableCaseMangerForNewCase=true;$scope.checkForRecurringAppt();$scope.getPtDemographicsImportData()}else{if($scope.encounterId<=0&&$scope.ikenableFacilityAccess&&isFacilityAccess=="false"){if((typeof schFacilityId=="undefined"||schFacilityId=="0"||schFacilityId=="")&&$scope.facilityData){if($scope.facilityData.length>0&&$scope.facilityData[0].Name){ecwAlert("You donot have permission to selected default facility: "+$scope.facilityData[0].Name+" Please check your permission and select other facility.",defaultAlertTitle)}}else{ecwAlert("You donot have permission to selected default facility: "+schFacilityName+" Please check your permission and select other facility.",defaultAlertTitle)}}$scope.initProperties()}$scope.GetRxEligibilityErrorVar=false;$scope.getRxHubFormularyForEnc();$scope.GetRxEligibilityError();if(getItemKeyValue("healowTeleVisit").toLowerCase()==='yes'){$scope.getTelevisitsCodeIds()}if($scope.ikEnableAppointmentBillingData){$scope.checkAddlBiilingDataModified()}if($scope.encounterId>0){$scope.isNewAppt=false}else{$scope.isNewAppt=true}setTimeout(function(){$('#searchPayTo i:last').css('display','none');$('#searchSupervisor i:last').css('display','none');$('#searchRendering i:last').css('display','none')},500);if($scope.patientId!=0&&$scope.patientId!=""&&typeof $scope.patientId!='undefined'){$scope.getReferralDropDown()}if($scope.encounterId>0){checkEncAssociation(encAssociationXml);getEligibilityEnhancedData()}if($scope.ikEnableASAPList&&!$scope.isNewAppt){$scope.getASAPCheckboxValue()}if(strHealowPlusAccess==="healowPlus"){$scope.bHealowPlusEnabled=true;defaultAlertTitle="Healow"}$scope.loadRightPanelUI();if($scope.panelStatus==="1"){$scope.panelUrl=makeURL("/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId="+$scope.encounterId+"&PtId="+$scope.patientId+"&facilityId="+$scope.facilityId+"&RxCheck=Nothing")}if(!$scope.isNewAppt){$timeout(function(){$scope.oldEncounterData=fetchEncounterAllFields()},1e3)}};function fetchEncounterAllFields(){var visitSubTypeId=$scope.appointmentVisitSubType.id===undefined?"0":$scope.appointmentVisitSubType.id;var encounterData={"patientId":$scope.patientId,"date":$scope.StDate,"startTime":$scope.appointmentStartTime.time,"endTime":$scope.appointmentEndTime.time,"visitType":$scope.appointmentVisitType.Name,"visitSubTypeId":visitSubTypeId,"reason":$scope.appointmentReason.name,"provider":$scope.appointmentProvider.providerId,"status":$scope.appointmentVisitStatus.code,"billing":$scope.billingNotes,"notes":$scope.generalNotes,"facility":$scope.facilityId,"POS":$scope.pos,"ptFlag":$scope.isNewPt,"Dx":$scope.apptDiagnosis,"referral":$scope.referralData,"DeptId":$scope.deptId,"resourceId":$scope.appointmentResource.id,"practiceId":$scope.practiceId,"transitionOfCare":$scope.transitionOfCare,"ptEmail":$scope.ptEmail,"cancellationReason":$scope.cancellationReason,"webEnabled":$scope.chkEmailCb,"transportationStatus":$scope.transPortationRequired,"visitCopay":$scope.getCopay(),"copayChanged":$scope.copayChanged,"claimRequired":$scope.isNonBillable,"ASAPisChecked":$scope.chkASAPList,"openCase":$scope["case"],"refProvider":$scope.refProviderId};return encounterData}$scope.isEncAssociatedWithLabImmMedPay=false;var checkEncAssociation=function(encAssociationXml){try{var isEncAssociated=false;if(!newAppointmentFnNameSpace.checkIfEmpty(encAssociationXml)){var oAssoData=xml2json(encAssociationXml).Envelope.Body['return'];if(oAssoData.status!=undefined&&oAssoData.status=="success"){if(parseInt(oAssoData.AssociatedMedication)>0){isEncAssociated=true}else if(parseInt(oAssoData.AssociatedLabs)>0){isEncAssociated=true}else if(parseInt(oAssoData.AssociatedImmunization)>0){isEncAssociated=true}else if(parseInt(oAssoData.AssociatedClaims)>0){isEncAssociated=true}$scope.ikUnlockApptDateTimeWithOrders="yes"===oAssoData.UnlockApptDateTimeWithOrders.toLowerCase();$scope.isEncAssociatedWithLabImmMedPay=angular.copy(isEncAssociated)}else{ecwAlert("error while encounter association check.",defaultAlertTitle)}}}catch(err){ecwAlert("error while encounter association check.",defaultAlertTitle)}};var getEligibilityEnhancedData=function(){var url=makeURL("/mobiledoc/jsp/edi/eligibility/getEnhancedEligibilityData.jsp?EncId="+$scope.encounterId+"&PatId="+$scope.patientDtls.patient.id);var req=$http({method:"POST",url:url,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).then(function(result){var conData=result.data;if(conData.status=="success"){$scope.ShowEBEnhanceData=true;var EBData=conData.data;var isServiceTypeMapped=conData.isServiceTypeMapped;setEBEnhancedData(EBData,isServiceTypeMapped)}else{ecwAlert("An error occured to fetch enhanced eligibility data.",defaultAlertTitle)}})};$scope.checkEligibilityCompare=function(){if(bCompareEligibilityApptRightPanel===undefined||bCompareEligibilityApptRightPanel!=="true"||isNaN($scope.encounterId)||Number($scope.encounterId)<=0){return}$.ajax({url:makeURL("/mobiledoc/emr/appointmenteligibility/compareEligDataWithDemoGraphic"),type:"GET","async":false,dataType:'json',data:$.param({patId:$scope.patientId,EncId:$scope.encounterId,InsResp:'P'}),success:function(conData){var eligibilityData=conData.data;if(eligibilityData!==undefined){var diffrentData=eligibilityData.filter(data=>data.diffstat=='Y');if(diffrentData.length>0){setTimeout(function(){$('#ApptsRightPaneLink21').addClass('CompareEligibility');$('#ApptsRightPaneLink21').find('i').addClass("icon eicon-triangle-exclamation ml3")},1e3)}else{setTimeout(function(){$('#ApptsRightPaneLink21').removeClass('CompareEligibility');$('#ApptsRightPaneLink21').find('i').removeClass("icon eicon-triangle-exclamation ml3")},1e3)}}}})};$scope.ShowNAEBData=false;$scope.MaxEB={};var setEBEnhancedData=function(EBData,isServiceTypeMapped){if(isServiceTypeMapped){$scope.ShowEBEnhanceData=true;if(EBData.length>0){$scope.ShowNAEBData=false;findMaxEBandShow(EBData)}else{$scope.ShowNAEBData=true}}else{$scope.ShowNAEBData=false;if(EBData.length>0){$scope.ShowEBEnhanceData=true;findMaxEBandShow(EBData)}else{$scope.ShowEBEnhanceData=false}}};var findMaxEBandShow=function(EBData){$scope.MaxEB={};$scope.ShowEBEnhanceData=true;if(EBData.length>1){$scope.EBDataList=angular.copy(EBData);var idx=getMaxBenefitAmount(EBData);$scope.MaxEB=EBData[idx]}else{$scope.MaxEB=EBData[0]}};function getMaxBenefitAmount(EBData){var maxAmount=0;var maxAmountIdx=0;for(var i=0;i<EBData.length;i++){var tempObj=EBData[i];if(parseInt(tempObj.BenefitAmount)>maxAmount){maxAmountIdx=i;maxAmount=parseInt(tempObj.BenefitAmount)}}return maxAmountIdx}$scope.showEBDataList=function(){$('.prev-dx').addClass('active')};$scope.closeEBList=function(){$('.prev-dx.active').removeClass('active')};var launchAlertModal=function(){$ocLazyLoad.load({name:'NewBillingAlert',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/billingalert/billingalert.js','/mobiledoc/jsp/webemr/templates/topPanel-tpl.js']}).then(function(){$scope.newpopUpUrlAppt=makeURL('/mobiledoc/jsp/webemr/billingalert/billingAlert.jsp?patientId='+$scope.patientId+'&Patientname='+encodeURIComponent($scope.ptName))},function(e){})};function performAsyncAlertsCheck(patientID){if(patientID>0){performAlertsBatchCheck(patientID)}else{$scope.isAfterAlertCheck=true}}function performAlertsBatchCheck(patientID){$http({headers:{"Content-Type":"application/x-www-form-urlencoded"},method:'POST',url:makeURL('/mobiledoc/jsp/webemr/billingalert/checkIfPatientHasAlerts.jsp?patientId='+patientID)}).then(processAlertsBatchCheckResults,handleAlertsBatchCheckError)}function processAlertsBatchCheckResults(response){var hasMUAlert=false;var hasBillingAlert=false;var hasGlobalAlert=false;response=response.data?response.data.split(/<\?xml version="\d*\.\d*" encoding=".*"\?>/).join(''):'';var responseJSON=(new X2JS).xml_str2json(response);if(responseJSON){var muAlertJSON=responseJSON['return'].MUAlert;hasMUAlert=!!muAlertJSON.trim()&&!isEmailOnlyMissingMUField(responseJSON);var billingAlertJSON=responseJSON['return'].BillingAlert;hasBillingAlert=billingAlertJSON.Envelope?!!billingAlertJSON.Envelope.Body['return'].AlertNotes:false;if(strAccLookupPermission!=null&&strAccLookupPermission!=undefined&&strAccLookupPermission=='1'){if(!hasBillingAlert){hasBillingAlert=billingAlertJSON.Envelope?!!billingAlertJSON.Envelope.Body['return'].grBalBillingAlert:false}}var globalAlertJSON=responseJSON['return'].GlobalAlert;hasGlobalAlert=globalAlertJSON.Envelope?!!globalAlertJSON.Envelope.Body['return'].resultset.data.row:false}if(hasMUAlert||hasBillingAlert||hasGlobalAlert){launchAlertModal()}else{$scope.isAfterAlertCheck=true;$scope.iHubConsentIconShow=true}}function isEmailOnlyMissingMUField(responseJSON){var isEmailOnlyMissingMUField=false;var missingMUFields=responseJSON['return'].MUMissingFields;if(missingMUFields){missingMUFields=missingMUFields.trim();isEmailOnlyMissingMUField=missingMUFields=='email'||missingMUFields=='email,email'}return isEmailOnlyMissingMUField}function handleAlertsBatchCheckError(){$scope.isAfterAlertCheck=true;$scope.iHubConsentIconShow=true}$scope.setIsAfterAlertCheck=function(isAfterAlertCheck){$scope.isAfterAlertCheck=isAfterAlertCheck};$scope.setGlobalAlertDetails=function(name,color){$scope.globalAlert={name:name,color:color}};$scope.launchPtLookup=function(block_id){$.ajax({type:"POST",url:makeURL('/mobiledoc/jsp/webemr/scheduling/getRegisteredPatients.jsp'),data:{"block_id":block_id,"block_type":1},dataType:"JSON","async":false,success:function(msg){if(msg){var status=msg.status;if('success'==status){var params={isMatchPatient:true,nhxPtDetails:angular.toJson(msg.nhxPtDetailsJSON),context:'healow'};params=$.param(params);$ocLazyLoad.load({name:'PatientSearch',files:['/mobiledoc/jsp/webemr/toppanel/patientSearch/js/patientSearch.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/patientMatchController.js']}).then(function(){var url='/mobiledoc/jsp/webemr/toppanel/patientSearch/patientSearch.jsp?'+params;$scope.ptMatchLookupUrl=makeURL(url)},function(e){})}}},error:function(){showMessage("Error In loading patient search")}})};$scope.apptMandatoryMsg="";$scope.CheckMissingMandatoryStructuredData=function(){var flag=false;$scope.apptMandatoryMsg="";$.ajax({type:"POST",url:makeURL('/mobiledoc/jsp/catalog/xml/getMissingMandatoryStructData.jsp'),data:{itemId:$scope.structdataItemId,catId:0,encId:$scope.encounterId,data:"yes",dataTable:"structApptBillingNotes"},"async":false,success:function(response){if(response){var jsondata=returnDataArray(xml2json(response).Envelope.Body["return"].item);if(jsondata&&jsondata.length>0){for(var i=0;i<jsondata.length;i++){if($scope.apptMandatoryMsg==""){$scope.apptMandatoryMsg="-"+jsondata[i].name;flag=true}else{$scope.apptMandatoryMsg+="\n-"+jsondata[i].name}}}}}});return flag};$scope.cancellationReason="";$scope.tdMandatoryVal=false;$scope.ckeckForPtdemographicMandatoryFields=function(){if($scope.appointmentVisitStatus.triggermanappfieldscheck=="1"){if($scope.encounterId==0&&!$scope.structDataForBillingNotes){if($scope.CheckMissingMandatoryStructuredData()){ecwAlert("Mandatory Appointment Structured Data fields can't be entered in this flow for a new Appointment.\nPlease select a different Visit Status Code that does not enforce these mandatory values, Save & Re Open the Appointment, enter the Mandatory Fields, select the correct Visit Status Code and try again.",defaultAlertTitle);return false}}else if($scope.structDataForBillingNotes){if($scope.CheckMissingMandatoryStructuredData()&&$scope.apptMandatoryMsg.length>0){ecwAlert("Missing mandatory values for Appointment Structured Data.\n"+$scope.apptMandatoryMsg,defaultAlertTitle);return false}}}if($scope.ikPreregPatients&&$scope.appointmentVisitStatus.TriggerManFieldsCheck=="1"){$.ajax({type:"POST",url:$scope.getTestDemographicsMandatoryFieldsList(),data:{PtId:$scope.patientId},"async":false,success:function(response){var status=$(response).find('status').text();$scope.tdMandatoryVal=false;if(status=='success'){$scope.tdMandatoryVal=true}else{$scope.tdMandatoryVal=false}if(!$scope.tdMandatoryVal){showMessage("Please fill up all the demographic mandatory fields of the patient.");$scope.openPatientInfo();return}else{$scope.validateMandatoryFields()}}})}else{$scope.validateMandatoryFields()}};function validateWebEnableSuccess(){$scope.webEnblaeValue=true;$scope.setWebEnableValue();bootbox.dialog({message:"Patient Web-Enabled Successfully",title:"Appointment Details - Patient Web-Enabled Successfully",closeButton:false,onEscape:function(){$scope.verifyAppointmentData()},buttons:{success:{label:"OK",className:"btn btn-blue btn-xs mr5",callback:function(){$scope.verifyAppointmentData()}}}})}$scope.validateMandatoryFields=function(){if($scope.actions.apptAction!=1){if($('#rptog').hasClass('active')){$scope.Dialog.width='1080px'}else{$scope.Dialog.width='750px'}$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1}$scope.getMessage($scope.ptEmail);if(newAppointmentFnNameSpace.checkIfEmpty($scope.patientDtls.patient.id)){showMessage("Patient selection is required. Select a Patient to save the appointment.",'ptLookup',"Appointment Details - Missing Mandatory Fields");return}else if(newAppointmentFnNameSpace.checkIfEmpty($scope.facilityId)){showMessage("Facility selection is required. Select a Facility to save the appointment.",undefined,"Appointment Details - Missing Mandatory Fields");return}else if(newAppointmentFnNameSpace.checkIfEmpty($scope.pos)){showMessage("Place of Service Code is required. Select a Place of Service Code to save the appointment.","idPos","Appointment Details - Missing Mandatory Fields");return}else if($scope.ikEnableDepartments&&$scope.ikIsDepartmentMandatory&&($scope.deptId==0||$scope.deptName=="")){showMessage("Department selection is required. Select a Department to save the appointment.",undefined,"Appointment Details - Missing Mandatory Fields");return}else if($scope.deptId>0&&$scope.ikEnableDepartments&&!$scope.checkDeptFac()){showMessage("The department chosen is not in the facility. Please choose the appropriate department.");return}else if(newAppointmentFnNameSpace.checkIfEmpty($('#Appt_startDate').val())){showMessage("Please select start date","Appt_startDate");return}else if(!$scope.validateStartDate($('#Appt_startDate').val())){showMessage("Please Enter date in MM/DD/YYYY format","Appt_startDate");$('#Appt_startDate').val("");return}else if(newAppointmentFnNameSpace.checkIfEmpty($scope.appointmentStartTime.time)){showMessage("Please select start time","startTime");return}else if(newAppointmentFnNameSpace.checkIfEmpty($scope.appointmentEndTime.time)){showMessage("Please select end time","endTime");return}else if(!$scope.validateTime($scope.appointmentStartTime.time)){showMessage("Please enter valid start time.e.g 12:55 am","startTime");return}else if(!$scope.validateTime($scope.appointmentEndTime.time)){showMessage("Please enter valid end time.e.g 12:55 am","endTime");return}else if(!moment($scope.appointmentStartTime.time,$scope.timeFormat,true).isBefore(moment($scope.appointmentEndTime.time,$scope.timeFormat,true))){showMessage('End time should be greater then start time');return}else if(!$scope.providerSelected||$scope.appointmentProvider.providerId==""||$scope.appointmentProvider.providerId<=0){showMessage("Appointment Provider selection is required. Select an Appointment Provider to save the appointment.","provider","Appointment Details - Missing Mandatory Fields");return}else if(!$scope.appointmentResource.id||$scope.appointmentResource.id==0){showMessage("Please select a resource","resource");return}else if(!$scope.ikDisableSchedulingEnforceProvResCheck&&$scope.isProviderSchedule&&$scope.appointmentProvider.providerId!=$scope.appointmentResource.id){showMessage("The selected Appointment Resource must be the same as the provider in the provider's schedule. Select the correct Appointment Resource to proceed.",undefined,"Appointment Details - Provider-Resource Mismatch");return}else if($scope.chkEmailCb&&($scope.ptEmail==""||typeof $scope.ptEmail=='undefined')){showMessage("Enter a valid Email to Web-Enable Patient. Example: John@gmail.com. "+$scope.emailMessage,"email","Appointment Details - Valid Email Required to Web-Enable Patient");return}else if($scope.ikEnableWebPortal&&$scope.webEnblaeValue&&($scope.ptEmail==""||typeof $scope.ptEmail=='undefined')){showMessage("Patient is web enabled. Please enter a valid E-mail address for portal notifications/password retrievals."+$scope.emailMessage,"email");return}else if(!$scope.appointmentVisitType.Name||$scope.appointmentVisitType.Name==''){showMessage("Visit Type selection is required. Select a Visit Type to save the appointment.","visitTypeCombo","Appointment Details - Missing Mandatory Fields");return}else if($scope.enableVisitSubType&&!$scope.isEncounterLocked&&$scope.hasSubType=='true'&&$scope.isSubTypeFieldMandatory&&(!$scope.appointmentVisitSubType||newAppointmentFnNameSpace.checkIfEmpty($scope.appointmentVisitSubType.id)||parseInt($scope.appointmentVisitSubType.id)<=0)){showMessage("Sub-Type selection is required. Select a Sub-Type to save the appointment.",undefined,"Appointment Details - Missing Mandatory Fields");return}else if(!$scope.isEncounterLocked&&$scope.isReasonFieldMandatory&&(typeof $scope.appointmentReason.name==='undefined'||$scope.appointmentReason.name==="")){showMessage("Please select Reason");return}else if(!($scope.ptEmail=="")&&!isEmailIdValid($scope.ptEmail)){$scope.getMessage($scope.ptEmail);showMessage("Enter a valid Email to Web-Enable Patient. Example: John@gmail.com. "+$scope.emailMessage,"email","Appointment Details - Valid Email Required to Web-Enable Patient");return}else if(!$scope.appointmentVisitStatus||!$scope.appointmentVisitStatus.code||$scope.appointmentVisitStatus.code.trim()==""){showMessage("Please select a visit status","visitStsCombo");return}else if($scope.encounterId<=0&&$scope.refReq&&newAppointmentFnNameSpace.checkIfEmpty($scope.referralId)){showMessage("This visit type required referral to be present.Please create a referral.");$scope.loadRefPopup($scope.referralId,$scope.patientId,$scope.ptName,$scope.encounterId,"0","0");return}else if($scope.coPayCb&&$scope.mCoPaytext==""){showMessage("Please Enter Copay");return}else if($scope.structDataForBillingNotes&&$scope.structVal=="y"){showMessage("Please enter Structured Data for Billing Notes");return}else if(!$scope.visitStatusCheck()){return}else if($scope.appointmentVisitStatus.NonBillable=="1"){newAppointmentFnNameSpace.confirmDialog("The Selected code: '"+$scope.appointmentVisitStatus.code+"' is non billable. Do you want to continue?",'bluetheme',function(result){if(result){$scope.verifyAppointmentData()}})}else if($scope.showCancellationReason==true&&$scope.cancellationReason.trim()==''){ecwAlert("Please enter cancellation reason.",defaultAlertTitle);return false}else if($scope.encounterId>0&&$scope.isNonBillable&&$scope.paymentCount>0){ecwAlert("The encounter has associated claim(s)/payment(s). The visit cannot be made non-Billable. Please uncheck 'Non-Billable visits' and continue.",defaultAlertTitle);return false}else if(!$scope.webEnblaeValue&&$scope.teleVisitCodesIds!==undefined&&$scope.teleVisitCodesIds!==null&&$scope.teleVisitCodesIds.length>0&&$scope.teleVisitCodesIds.indexOf(parseInt($scope.appointmentVisitType.CodeId,10))>=0){if($scope.ikAutoEnablePortal){if($scope.ptEmail!==""&&$scope.checkEmail){let returnVal=appointmentService.saveMuAlertData($scope.ptEmail,$scope.patientId);if(returnVal===1||returnVal==='1'){$scope.opemMUCaptuer();return false}else{validateWebEnableSuccess()}}else{showMessage("Please enter a valid E-mail address. Example: john@gmail.com."+$scope.emailMessage,"email");return false}}else{showMessage("Please web enable the patient before creating TeleVisit appointment.");return false}}else if($scope.encounterId<=0){PSACService.checkCommonStaffPermission($scope.patientDtls.patient.id,function(){$scope.verifyAppointmentData()},function(){return false})}else{$scope.verifyAppointmentData()}};$scope.verifyAppointmentData=function(){var isFacilityAccessForED=resourceSchedulingService.isFacilityAccessForED({action:"createAppointment",facilityId:$scope.facilityId,facilityName:$scope.facilityName,providerId:$scope.appointmentProvider.providerId,providerName:$scope.appointmentProvider.providerName,resourceId:$scope.appointmentResource.id,resourceName:$scope.appointmentResource.resourceName});if(!isFacilityAccessForED){return}$scope.verifyAppointmentDataAfterFacilityCheck()};$scope.verifyAppointmentDataAfterFacilityCheck=function(){if($scope.ikvisitTypeSecurity){var key="visitType_"+$scope.appointmentVisitType.Name;var permission=getPermission(key,global.TrUserId);if(!permission){showMessage("You do not have permission to create appointment with visit type "+$scope.appointmentVisitType.Name,"visitTypeCombo");return}else{$scope.getvalidationParameter()}}else{$scope.getvalidationParameter()}};$scope.getvalidationParameter=function(){var batchAjax=[];if($scope.ikncorrectionalFeature){batchAjax.push({url:$scope.getCourtDateUrl(),param:[{paramName:"patientId",paramValue:$scope.patientId}],success:onSuccessGetCourtDate,error:getCourtDateError})}batchAjax.push({url:$scope.getUrlForConflictAppt(),param:[{paramName:"TrUserId",paramValue:global.TrUserId},{paramName:"ProviderId",paramValue:$scope.appointmentResource.id},{paramName:"Date",paramValue:$scope.getStartDateInYYYYMMDD()},{paramName:"StartTime",paramValue:$scope.getStartTimeIn24hr()},{paramName:"EndTime",paramValue:$scope.getEndTimeIn24hr()},{paramName:"EncounterID",paramValue:$scope.encounterId},{paramName:"patientId",paramValue:$scope.patientId},{paramName:"Weekday",paramValue:$scope.getWeekDay()},{paramName:"multiResFacFilterId",paramValue:schedulefacilityFilter},{paramName:"apptFacId",paramValue:$scope.facilityId}],success:onSuccessCheckForConflictAppt,error:onErrorCheckForConflictAppt});batchAjax.push({url:getAppointmentLimitsUrl(),param:[{paramName:"action",paramValue:'checkEligibleWithinAppointmentLimits'},{paramName:"providerId",paramValue:$scope.appointmentResource.id},{paramName:"date",paramValue:$scope.getStartDateInYYYYMMDD()},{paramName:"startTime",paramValue:$scope.getStartTimeIn24hr()},{paramName:"endTime",paramValue:$scope.getEndTimeIn24hr()},{paramName:"weekday",paramValue:$scope.getWeekDay()},{paramName:"facilityId",paramValue:$scope.facilityId}],success:onSuccessGetAppointmentLimits,error:onErrorGetAppointmentLimits});batchAjax.push({url:$scope.getVTRuleUrl(),param:[{paramName:"doctorid",paramValue:$scope.appointmentResource.id},{paramName:"weekday",paramValue:$scope.getWeekDay()},{paramName:"aptdate",paramValue:$scope.getStartDateInYYYYMMDD()},{paramName:"multiResFacFilterId",paramValue:schedulefacilityFilter}],success:onSuccessCheckForVtRule,error:onErrorCheckForVtRule});if($scope.ikUnlockApptDateTimeWithOrders&&!$scope.isEncAssociatedWithLabImmMedPay&&isDateOrTimeModified()){batchAjax.push({url:$scope.getEncAssociationUrl(),param:[{paramName:"encounterId",paramValue:$scope.encounterId}],success:checkEncAssociation,error:onErrorCheckForEncAssoc})}batchAjax.push({url:$scope.getFacilityExistUrl(),param:[{paramName:"FacilityId",paramValue:$scope.facilityId}],success:onSuccessCheckForFacilityExist,error:onErrorCheckForFacilityExist});batchAjax.push({url:$scope.getRecRulePrUrl(),param:[{paramName:"ProvId",paramValue:$scope.appointmentResource.id}],success:onSuccessRecRulePr,error:onErrorCheckRecRulePr});batchAjaxService.batchAjax(batchAjax)};$scope.noShowWarningForCourtDate=true;var onSuccessGetCourtDate=function(response){var jsonData=xml2json(response).Envelope.Body["return"].patient;var courtDate=moment(jsonData.NextCourtDate).format($scope.dateFormat);if(courtDate!=""&&typeof courtDate!='undefined'&&$scope.StDate==courtDate){$scope.noShowWarningForCourtDate=false}else{$scope.noShowWarningForCourtDate=true}};var getCourtDateError=function(){showMessage("Error in getting courtdate.")};$scope.availability="";$scope.conflict="";$scope.isException="";$scope.conflictEncounters="";$scope.conflictEncountersData="";$scope.coflictWithBlocks=false;$scope.isAppointmentInWorkingHours=false;$scope.conflictedBlock="";var onSuccessCheckForConflictAppt=function(response){$scope.availability=$(response).find('availability').text();$scope.availability=$scope.availability.toLowerCase();$scope.conflict=$(response).find('conflict').text();$scope.isException=$(response).find('isException').text();$scope.conflictEncounters=$(response).find('encounter').text();$scope.conflictEncountersData=$(response).find('encounter');$scope.isAppointmentInWorkingHours=false;$scope.checkForWorkingHoursAvailability(response);if("Yes"==$scope.conflict){$scope.bBooked=true}else{$scope.bBooked=false}if("no"==$scope.availability){$scope.coflictWithBlocks=true;$scope.conflictedBlock=$(response).find('reason').text()}else{$scope.coflictWithBlocks=false;$scope.conflictedBlock=""}};var onErrorCheckForConflictAppt=function(){showMessage("Error in checking for conflict appointment.")};var onSuccessGetAppointmentLimits=function(response){if(response&&response!=="null"&&response.length>0){$scope.appointmentLimits=JSON.parse(response)}};var isExceedAppointmentLimit=function(){var visitDesc='';var isVisitTypeExceed=false;var isSubTypeExceed=false;$scope.appointmentLimitVisitTypeMsg="";$scope.appointmentLimitSubTypeMsg="";if($scope.appointmentLimits.length>0){for(let i=0;i<$scope.appointmentLimits.length;i++){if($scope.appointmentLimits[i].limitType===1){visitDesc=$scope.appointmentVisitType.Name+" ("+$scope.appointmentVisitType.Description+")";if(isEligibleAppointmentLimit(visitDesc,$scope.appointmentLimits[i],1)){$scope.appointmentLimitVisitTypeMsg=$scope.appointmentLimitVisitTypeMsg+$scope.appointmentLimits[i].limitTypeDesc+", ";isVisitTypeExceed=true}}else if($scope.appointmentLimits[i].limitType===2){visitDesc=$scope.appointmentVisitSubType.code+" ("+$scope.appointmentVisitSubType.name+")";if(isEligibleAppointmentLimit(visitDesc,$scope.appointmentLimits[i],2)){$scope.appointmentLimitSubTypeMsg=$scope.appointmentLimitSubTypeMsg+$scope.appointmentLimits[i].limitTypeDesc+", ";isSubTypeExceed=true}}}if(isVisitTypeExceed){$scope.appointmentLimitVisitTypeMsg=$scope.appointmentLimitVisitTypeMsg.substring(0,$scope.appointmentLimitVisitTypeMsg.length-2)}if(isSubTypeExceed){$scope.appointmentLimitSubTypeMsg=$scope.appointmentLimitSubTypeMsg.substring(0,$scope.appointmentLimitSubTypeMsg.length-2)}if(isVisitTypeExceed||isSubTypeExceed){return true}}return false};var isEligibleAppointmentLimit=function(visitDesc,appointmentLimit,typeOfLimit){var isEligible=false;if($.trim(appointmentLimit.limitTypeDesc).includes($.trim(visitDesc))){if(!newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)){if(appointmentLimit.usedInstance>appointmentLimit.totalInstance){isEligible=true}else if(typeOfLimit===1&&isApptVisitTypeChanged()&&!isVisitTypeExistForAppointmentLimit($.trim(appointmentLimit.limitTypeDesc))&&appointmentLimit.usedInstance>=appointmentLimit.totalInstance){isEligible=true}else if(typeOfLimit===2&&isApptSubTypeChanged()&&!isSubTypeExistForAppointmentLimit($.trim(appointmentLimit.limitTypeDesc))&&appointmentLimit.usedInstance>=appointmentLimit.totalInstance){isEligible=true}}else if(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)&&appointmentLimit.usedInstance>=appointmentLimit.totalInstance){isEligible=true}}return isEligible};var isVisitTypeExistForAppointmentLimit=function(limitTypeDesc){const limitTypeArray=limitTypeDesc.split(",");var limitTypeName='';limitTypeArray.forEach(element=>{const visitNameArray=element.split("(");limitTypeName+=$.trim(visitNameArray[0])+", "});var currentVisitDesc=$scope.appointmentVisitType.Name;var previousVisitDesc=$scope.currentEncVisitType;if(limitTypeName.includes(currentVisitDesc)&&limitTypeName.includes(previousVisitDesc)){return true}return false};var isSubTypeExistForAppointmentLimit=function(limitTypeDesc){if(Number(preserveValueThatConflict.visitSubTypeId)===0){return false}var currentSubDesc=$scope.appointmentVisitSubType.code+" ("+$scope.appointmentVisitSubType.name+")";var previousSubDesc='';var apptLimitsubTypes=getAllVisitSubTypes();if(apptLimitsubTypes&&apptLimitsubTypes.status){for(var i=0;i<apptLimitsubTypes.status.length;i++){var subTypeMapping=apptLimitsubTypes.status[i];if(Number(subTypeMapping.id)===Number(preserveValueThatConflict.visitSubTypeId)){previousSubDesc=subTypeMapping.code+" ("+subTypeMapping.name+")";break}}}if(limitTypeDesc.includes(currentSubDesc)&&limitTypeDesc.includes(previousSubDesc)){return true}return false};$scope.isVisitTypeRuleOk=true;$scope.strTotalVisit=0;$scope.isMoreVisitAllowed=true;var onSuccessCheckForVtRule=function(response){$scope.isVisitTypeRuleOk=true;$scope.jsonDataForVtRule=xml2json(response).Envelope.Body["return"].slots.slot;$scope.strTotalVisit=0;var startTime=$scope.getStartTimeIn24hr();var endTime=$scope.getEndTimeIn24hr();var ruleStartTime="";var ruleEndTime="";$($scope.jsonDataForVtRule).each(function(key,value){ruleStartTime=value.startTime;ruleEndTime=value.endTime;$scope.noOfVisitAllowed=value.NumEnc;var total_visit=value.totalVisits;if($scope.appointmentVisitType.Name==value.VisitTypeId){if(endTime>ruleStartTime&&endTime<=ruleEndTime||startTime<ruleEndTime&&startTime>=ruleStartTime||startTime<=ruleStartTime&&endTime>=ruleEndTime){$scope.visitTypeOverriden=$scope.appointmentVisitType.Name}if(startTime>=ruleStartTime&&startTime<=ruleEndTime&&endTime>=ruleStartTime&&endTime<=ruleEndTime){$scope.strTotalVisit=value.totalVisits;$scope.strruleStartTime=ruleStartTime;$scope.strruleEndTime=ruleEndTime;$scope.isVisitTypeRuleOk=true;if(Number(total_visit)<=Number($scope.noOfVisitAllowed)){$scope.isMoreVisitAllowed=false}return false}}else{var ruleDurationInMinutes=moment.duration(moment(ruleEndTime,$scope.timeFormat).diff(moment(ruleStartTime,$scope.timeFormat))).asMinutes();if(startTime>=ruleStartTime&&startTime<ruleEndTime&&endTime>=ruleStartTime&&(endTime<=ruleEndTime||Number($scope.appointmentVisitType.Minutes)>ruleDurationInMinutes)){$scope.isVisitTypeRuleOk=false}}})};$scope.strTotalRecVisit=0;$scope.noOfRecVisitAllowed=0;$scope.strrecruleStartTime="";$scope.strrecruleEndTime="";$scope.isVisitTypeRecRuleOk=true;$scope.isMoreRecVisitAllowed=true;var onSuccessCheckForVtRecRule=function(response){$scope.jsonDataForRecRulePr;$scope.jsonDataForVtRecRule=returnDataArray(xml2json(response).Envelope.Body["return"].slots.slot);$scope.strTotalRecVisit=0;var startTime=$scope.getStartTimeIn24hr();var endTime=$scope.getEndTimeIn24hr();var ruleStartTime="";var ruleEndTime="";$($scope.jsonDataForVtRecRule).each(function(key,value){ruleStartTime=value.startTime;ruleEndTime=value.endTime;$scope.noOfRecVisitAllowed=value.NumEnc;var total_visit=value.totalVisitsForThisAppt;if($scope.appointmentVisitType.Name==value.VisitTypeId){if(startTime>=ruleStartTime&&startTime<=ruleEndTime&&endTime>=ruleStartTime&&endTime<=ruleEndTime){$scope.strTotalRecVisit=value.totalVisits;$scope.strrecruleStartTime=ruleStartTime;$scope.strrecruleEndTime=ruleEndTime;$scope.isVisitTypeRecRuleOk=true;$scope.visitTypeOverriden=$scope.appointmentVisitType.Name;if(Number(total_visit)<=Number($scope.noOfRecVisitAllowed)){$scope.isMoreRecVisitAllowed=false}return false}}else{if(startTime>=ruleStartTime&&startTime<=ruleEndTime&&endTime>=ruleStartTime&&endTime<=ruleEndTime){$scope.isVisitTypeRecRuleOk=false}}});$scope.validateDataForAppointment()};$scope.ruleSetId=0;var onSuccessRecRulePr=function(response){$scope.recIdArray=[];$scope.setId=[];$scope.startDateArray=[];$scope.endDateArray=[];$scope.recInterval=[];$scope.jsonDataForRecRulePr=returnDataArray(xml2json(response).Envelope.Body["return"].recRules.slot);if($scope.jsonDataForRecRulePr){$($scope.jsonDataForRecRulePr).each(function(key,value){$scope.setId.push(value.SetId);$scope.endDateArray.push(value.EndDate);$scope.startDateArray.push(value.StartDate);$scope.recInterval.push(value.RecInterval);$scope.recIdArray.push(value.RecId)});for(var i=0;i<$scope.jsonDataForRecRulePr.length;i++){var endDate=$scope.endDateArray[i];var noEndDateSpecified=true;var startDate=$scope.startDateArray[i];if(endDate!=""&&endDate!=null){endDate=moment(endDate,"YYYY-MM-DD").format("MM/DD/YYYY");noEndDateSpecified=false}if(noEndDateSpecified||moment(endDate,"MM/DD/YYYY").isAfter(moment($scope.StDate,"MM/DD/YYYY"))){startDate=moment(startDate,"YYYY-MM-DD").format("MM/DD/YYYY");if(moment($scope.StDate,"MM/DD/YYYY").isAfter(moment(startDate,"MM/DD/YYYY"))||moment($scope.StDate,"MM/DD/YYYY").isSame(moment(startDate,"MM/DD/YYYY"))){var diff=moment(startDate,"MM/DD/YYYY").diff(moment($scope.StDate,"MM/DD/YYYY"),'weeks');var rem=diff%$scope.recInterval[i];if(!(rem>0)){$scope.ruleSetId=$scope.setId[i];var batchAjax=[];batchAjax.push({url:$scope.getVTRecRuleUrl(),param:[{paramName:"doctorid",paramValue:$scope.appointmentResource.id},{paramName:"weekday",paramValue:$scope.getWeekDay()},{paramName:"SetId",paramValue:$scope.ruleSetId},{paramName:"aptdate",paramValue:$scope.getStartDateInYYYYMMDD()},{paramName:"multiResFacFilterId",paramValue:schedulefacilityFilter}],success:onSuccessCheckForVtRecRule,error:onErrorCheckForVtRecRule});batchAjaxService.batchAjax(batchAjax);break}}}}}if(!isFacilityExist){ecwAlert("Facility does not exist. Please select another facility.",defaultAlertTitle);return false}if($scope.ruleSetId==0){$scope.validateDataForAppointment()}};var onSuccessCheckForFacilityExist=function(response){try{if(!newAppointmentFnNameSpace.checkIfEmpty(response)){var oFacilityData=xml2json(response).Envelope.Body['return'];if(oFacilityData.status!==undefined&&oFacilityData.status==="success"){isFacilityExist="true"===oFacilityData.FacilityExist.toLowerCase()}else{ecwAlert("error while encounter association check.",defaultAlertTitle)}}}catch(err){ecwAlert("error while encounter association check.",defaultAlertTitle)}};var onErrorCheckForFacilityExist=function(){ecwAlert("Error in checking Facility exists or not.",defaultAlertTitle)};var onErrorCheckRecRulePr=function(response){ecwAlert("Error in getting rule for provider.",defaultAlertTitle)};var onErrorCheckForVtRule=function(){ecwAlert("Error in checking visit rule for appointment.",defaultAlertTitle)};var onErrorCheckForVtRecRule=function(){ecwAlert("Error in checking visit rec rule for appointment.",defaultAlertTitle)};var onErrorCheckForEncAssoc=function(){ecwAlert("Error in checking Encounter associated with order or claim.",defaultAlertTitle)};var onErrorGetAppointmentLimits=function(){ecwAlert("Error in checking Encounter Eligible with in Appointment Limits.",defaultAlertTitle)};$scope.checkForWorkingHoursAvailability=function(response){var startTime1="";var endTime1="";var count=0;$.each($(response).find('WHours').find('slot'),function(k,v){startTime1=$(v).find('startTime').text();endTime1=$(v).find('endTime').text();if(count==0&&$scope.isTimeGreaterThanOREqualStTime($scope.getStartTimeIn24hr(),moment(startTime1,"HH:mm:ss"))&&$scope.isTimeGreaterThanOREqualEndTime($scope.getEndTimeIn24hr(),moment(endTime1,"HH:mm:ss"))){$scope.isAppointmentInWorkingHours=true;count=1}})};$scope.isTimeGreaterThanOREqualStTime=function(timeToCompare1,timeToCompare2){return moment(timeToCompare1,"HH:mm:ss").isAfter(moment(timeToCompare2,"HH:mm:ss"))||moment(timeToCompare1,"HH:mm:ss").isSame(moment(timeToCompare2,"HH:mm:ss"))};$scope.isTimeGreaterThanOREqualEndTime=function(timeToCompare1,timeToCompare2){return moment(timeToCompare2,"HH:mm:ss").isAfter(moment(timeToCompare1,"HH:mm:ss"))||moment(timeToCompare1,"HH:mm:ss").isSame(moment(timeToCompare2,"HH:mm:ss"))};$scope.validateDataForAppointment=function(){if(typeof $scope.encounterId!='undefined'&&$scope.encounterId!=""&&$scope.encounterId!="0"&&$scope.isGroup){newAppointmentFnNameSpace.confirmDialog("This appointment is part of set. If you have made changes it will only change this appointment, Do you want to update this appointment?",'bluetheme',function(result){if(result){$scope.verifyEncounterAssociation()}else{return}})}else{$scope.verifyEncounterAssociation()}};function isDateOrTimeModified(){return!newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)&&(preserveValueThatConflict.date!==$scope.StDate||preserveValueThatConflict.startTime!==$scope.appointmentStartTime.time||preserveValueThatConflict.endTime!==$scope.appointmentEndTime.time)}$scope.verifyEncounterAssociation=function(){if($scope.ikUnlockApptDateTimeWithOrders&&$scope.isEncAssociatedWithLabImmMedPay&&isDateOrTimeModified()){ecwConfirm("There is at least one Order or Claim associated with this Appointment. Updating the Date or Time "+"fields for this Appointment may change the Date or Time of the associated Orders or Claim. "+"What would you like to do?","Associated Encounter Details",function(){$scope.ckeckForPregVisit()},function(){return},"bluetheme",false,true,"Change Anyway","Cancel")}else{$scope.ckeckForPregVisit()}};$scope.ckeckForPregVisit=function(){if($scope.checkForPregnancyVisit()){newAppointmentFnNameSpace.confirmDialog("Patient "+$scope.ptName+" is a male patient. Are you sure you want to book him for "+$scope.appointmentVisitType.Name+" visit?",'bluetheme',function(result){if(result){$scope.checkForCourtdate()}else{return}})}else{$scope.checkForCourtdate()}};$scope.checkForCourtdate=function(){if(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)&&$scope.ikncorrectionalFeature&&!$scope.noShowWarningForCourtDate){newAppointmentFnNameSpace.confirmDialog("Warning! This appointment is on the same day as the patient's next court date.Do you still want to schedule this appointment?",'bluetheme',function(result){if(result){$scope.checkForPastDate()}else{return}})}else{$scope.checkForPastDate()}};$scope.checkForPastDate=function(){var date=new Date($('#Appt_startDate').val());var todayDate=new Date;todayDate.setHours(0,0,0,0);if(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)&&date<todayDate){newAppointmentFnNameSpace.confirmDialog("The selected Date/Time of this appointment is in the past. Are you sure you want to book this appointment for a past date/time?",'bluetheme',function(result){if(result){$scope.checkIfApptInWh()}else{return}},"Appointment Details - Confirm Scheduling in the Past")}else{$scope.checkIfApptInWh()}};$scope.checkIfApptInWh=function(){if(!$scope.isAppointmentInWorkingHours&&(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)||isApptTimeModified())){if(!$scope.permissionForBookOutofOfficeHoursAppointments){showMessage("The selected Appointment Date/Time is outside the working hours for "+$scope.facilityName+". Update the Date/Time to book the appointment.",undefined,"Appointment Details - Cannot Schedule Outside Working Hours");return}else if($scope.permissionForBookOutofOfficeHoursAppointments){newAppointmentFnNameSpace.confirmDialog("The selected Appointment Date/Time is outside the working hours for "+$scope.facilityName+". Are you sure you want to book the appointment outside of the facility's working hours.",'bluetheme',function(result){if(result){if(!isPatientConflictCheckExclude()){$scope.checkIfPatientAlreadyHasAppt()}else{$scope.checkIfConflict()}}else{return}},"Appointment Details - Confirm Scheduling Outside Working Hours")}else{if(!isPatientConflictCheckExclude()){$scope.checkIfPatientAlreadyHasAppt()}else{$scope.checkIfConflict()}}}else{if(!isPatientConflictCheckExclude()){$scope.checkIfPatientAlreadyHasAppt()}else{$scope.checkIfConflict()}}};$scope.checkIfPatientAlreadyHasAppt=function(){if(!newAppointmentFnNameSpace.checkIfEmpty($scope.conflictEncounters)){var time="";var provider="";var apptMsg="";$scope.conflictEncountersData.each(function(){time=moment($(this).find('startTime').text(),"HH:mm:ss").format("hh:mm a");provider=$(this).find('provider').text();return});if($scope.encounterId==="0"){apptMsg=". Are you sure you want book this appointment?"}else{apptMsg=". Do you want to save this appointment?"}newAppointmentFnNameSpace.confirmDialog("The patient "+$scope.ptName+" already has a scheduled appointment for today with "+provider+" at "+time+apptMsg,'bluetheme',function(result){if(result){$scope.checkIfConflict()}else{return}},"Appointment Details - Patient Already Has Appointment")}else{$scope.checkIfConflict()}};$scope.checkIfConflict=function(){hasBookConflict=false;if($scope.bBooked&&$scope.checkForExhustedSlot()&&(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)||isOverBookConditionSatisfy())){hasBookConflict=true;if(!$scope.permissionForBookConflictAppointments){showMessage("This appointment conflicts with another appointment.Permission denied.");return}else{newAppointmentFnNameSpace.confirmDialog("This appointment conflicts with another appointment.Do you still want to save the appointment?",'bluetheme',function(result){if(result){$scope.checkIfConflictWithBlock()}else{return}})}}else{$scope.checkIfConflictWithBlock()}};$scope.checkIfConflictWithBlock=function(){var canConflictWithBlock=false;if($scope.coflictWithBlocks){if(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)){canConflictWithBlock=true}else{canConflictWithBlock=preserveValueThatConflict.resourceId!==$scope.appointmentResource.id||preserveValueThatConflict.date!==$scope.StDate||preserveValueThatConflict.startTime!==$scope.appointmentStartTime.time||preserveValueThatConflict.endTime!==$scope.appointmentEndTime.time}}if(canConflictWithBlock&&$scope.coflictWithBlocks){if(!$scope.permissionForBookBlockConflictAppointments){showMessage("The appointment conflicts with the block : "+$scope.conflictedBlock+".Permission denied.");return}else{newAppointmentFnNameSpace.confirmDialog("The selected Appointment Date/Time of this appointment conflict with the block "+$scope.conflictedBlock+". Are you sure you want to book this appointment during blocked hours?",'bluetheme',function(result){if(result){$scope.checkForVisitRule()}else{return}},"Appointment Details - Confirm Scheduling During Blocked Time")}}else{$scope.checkForVisitRule()}};$scope.checkForVisitRule=function(){if((!$scope.isVisitTypeRuleOk||!$scope.isVisitTypeRecRuleOk)&&isApptVisitTypeChanged()){if(!$scope.permissionForBookAnyVisitTypeAppointment){showMessage("The selected visit type ("+$scope.appointmentVisitType.Name+") is not allowed in this time slot.Permission denied.");return}else if(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)){newAppointmentFnNameSpace.confirmDialog("The selected visit type ("+$scope.appointmentVisitType.Name+") is not allowed in this time slot.Do you still want to book the appointment?",'bluetheme',function(result){if(result){$scope.checkForNoOfVisitAllowed()}else{return}})}else{$scope.checkForNoOfVisitAllowed()}}else{$scope.checkForNoOfVisitAllowed()}};$scope.checkForNoOfVisitAllowed=function(){hasOverbookAppt=false;if(!$scope.isRegRuleError&&(!$scope.isMoreVisitAllowed||!$scope.isMoreRecVisitAllowed)&&(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)||isApptModified())){var totalCount=0;if(!$scope.isMoreVisitAllowed){totalCount=$scope.strTotalVisit}else if(!$scope.isMoreRecVisitAllowed){totalCount=$scope.strTotalRecVisit}if(totalCount>0){hasOverbookAppt=true;if(!$scope.permissionForOverbookAppointments){showMessage("The allowed number of visits ("+totalCount+") for "+$scope.appointmentVisitType.Name+" have already been scheduled in this time slot.Permission denied.");return}else{newAppointmentFnNameSpace.confirmDialog("The allowed number of visits ("+totalCount+") for "+$scope.appointmentVisitType.Name+" have already been scheduled in this time slot.Do you still want to book the appointment?",'bluetheme',function(result){if(result){$scope.checkForAppointmentLimits()}else{return}})}}else{$scope.checkForAppointmentLimits()}}else{$scope.checkForAppointmentLimits()}};$scope.appointmentLimits=[];$scope.appointmentLimitVisitTypeMsg="";$scope.appointmentLimitSubTypeMsg="";$scope.showAppointmentLimitAlert=false;$scope.checkForAppointmentLimits=function(){if(isExceedAppointmentLimit()){$scope.showAppointmentLimitAlert=true;if($scope.$$phase!=='$apply'&&$scope.$$phase!=='$digest'){$scope.$apply()}}else{$scope.checkForAsapList()}};$scope.appointmentLimitConfirm=function(result){$scope.showAppointmentLimitAlert=false;if(result==="no"){return}else{$scope.checkForAsapList()}};$scope.checkForAsapList=function(){if($scope.ikEnableASAPList){var flag=false;var date1=new Date;var currDate=$scope.getStartDateInYYYYMMDD();var currStartTime=$scope.getStartTimeIn24hr();var dateParts=currDate.split('-');var timeParts=currStartTime.split(':');var date2=new Date(dateParts[0],dateParts[1]-1,dateParts[2],timeParts[0],timeParts[1],timeParts[2]);var val=compareDates(date2,date1);if(val<0&&$scope.chkASAPList){ecwAlert("Please uncheck the ASAP checkbox as Date is Past Date",defaultAlertTitle);return}if($scope.asapData.date!==""){if(currDate!==$scope.asapData.date){flag=true}}if($scope.asapData.startTime!==""){var currStartTime=$scope.getStartTimeIn24hr();if(currStartTime!==$scope.asapData.startTime){flag=true}}if(flag&&$scope.chkASAPList){ecwConfirm("Do you want to remove the appointment from the ASAP List ?",defaultAlertTitle,function(){$scope.chkASAPList=false;$scope.checkForPracticeId()},function(){$scope.checkForPracticeId()},"bluetheme")}else{$scope.checkForPracticeId()}}else{$scope.checkForPracticeId()}};var isApptModified=function(){var isApptModified=false;var startDate=$scope.getStartDateInYYYYMMDD();var currentEncDate=moment($scope.currentEncDate,$scope.dateFormat).format("YYYY-MM-DD");var startTimeForAppt=moment($scope.appointmentStartTime.time,$scope.timeFormat).format("hh:mm a");var endTimeForAppt=moment($scope.appointmentEndTime.time,$scope.timeFormat).format("hh:mm a");var visitType=escapeXml($scope.appointmentVisitType.Name);if($scope.currentEncStartTime!==startTimeForAppt||$scope.currentEncEndTime!==endTimeForAppt||currentEncDate!==startDate||$scope.currentEncVisitType!==visitType||$scope.currentEncFacilityId!==$scope.facilityId||$scope.currentEncResourceId!==$scope.appointmentResource.id){isApptModified=true}return isApptModified};var isApptTimeModified=function(){var isApptTimeModified=false;var startDate=$scope.getStartDateInYYYYMMDD();var currentEncDate=moment($scope.currentEncDate,$scope.dateFormat).format("YYYY-MM-DD");var startTimeForAppt=moment($scope.appointmentStartTime.time,$scope.timeFormat).format("hh:mm a");var endTimeForAppt=moment($scope.appointmentEndTime.time,$scope.timeFormat).format("hh:mm a");if($scope.currentEncStartTime!==startTimeForAppt||$scope.currentEncEndTime!==endTimeForAppt||currentEncDate!==startDate){isApptTimeModified=true}return isApptTimeModified};var isApptVisitTypeChanged=function(){var isApptVisitTypeChanged=false;var visitType=escapeXml($scope.appointmentVisitType.Name);if($scope.currentEncVisitType!==visitType){isApptVisitTypeChanged=true}return isApptVisitTypeChanged};var isApptSubTypeChanged=function(){var isApptSubTypeChanged=false;var subType=$scope.appointmentVisitSubType.id;if(Number(preserveValueThatConflict.visitSubTypeId)!==Number(subType)){isApptSubTypeChanged=true}return isApptSubTypeChanged};var isOverBookConditionSatisfy=function(){var isOverBookConditionSatisfy=false;var startDate=$scope.getStartDateInYYYYMMDD();var currentEncDate=moment($scope.currentEncDate,$scope.dateFormat).format("YYYY-MM-DD");var startTimeForAppt=moment($scope.appointmentStartTime.time,$scope.timeFormat).format("hh:mm a");var endTimeForAppt=moment($scope.appointmentEndTime.time,$scope.timeFormat).format("hh:mm a");if($scope.encounterId!=="0"&&($scope.currentEncStartTime!==startTimeForAppt||$scope.currentEncEndTime!==endTimeForAppt||currentEncDate!==startDate||$scope.currentEncResourceId!==$scope.appointmentResource.id)){isOverBookConditionSatisfy=true}return isOverBookConditionSatisfy};$scope.checkForPracticeId=function(){if($scope.ikEnterpriseDirectory){if(!($scope.ikEnterpriseDirectory&&$scope.ikEnableFacilityAsMasterList)){var strUrl="/mobiledoc/jsp/webemr/scheduling/newApptPracticeLookup.jsp";$ocLazyLoad.load({name:"newApptPracticeLookupModule",files:["/mobiledoc/jsp/webemr/scheduling/js/newApptPracticeLookupCtrl.js"],cache:false}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL(strUrl),controller:'newApptPracticeLookupCtrl',windowClass:'app-modal-window bluetheme  medium-width',backdrop:"static",keyboard:false,resolve:{resolveData:function(){return{providerid:$scope.appointmentProvider.providerId,facilityid:$scope.facilityId}}}});modalInstance.result.then(function(responseObj){$scope.practiceId=responseObj.practiceId;$scope.creaetXmlForappt()},function(){})},function(e){})}else{$scope.creaetXmlForappt()}}else{$scope.creaetXmlForappt()}};$scope.showRegRulesResult=function(rules){$scope.allowedToProceed=true;$scope.panelUrl="";$templateCache.remove($scope.panelUrl);$scope.isNewEnc=false;$scope.disableLog=false;$scope.disableOrders=false;$scope.showRightChartPanelHeading=false;if($scope.panelStatus==="1"){$scope.panelUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId='+$scope.encounterId+'&PtId='+$scope.patientId+'&RxCheck=Nothing')}$scope.regFailedRules=rules;var totalRules=$scope.regFailedRules.length;for(var count=0;count<totalRules;count++){if($scope.regFailedRules[count].RuleAction=="ERROR"){$scope.allowedToProceed=false}}if($scope.regFailedRules.length>0&&$scope.saveFromVal==12){$scope.saveAppointment()}};$scope.getUserAttention=function(url){if($scope.regFailedRules.length>0&&url.indexOf('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp')>-1){$timeout(function(){if(!$('#rptog').hasClass('active')){$('#ic-tog1').trigger('click')}$("#buzzme").fadeOut(1e3).fadeIn(1e3).fadeOut(1e3).fadeIn(1e3).fadeOut(1e3).fadeIn(1e3)},500)}};$scope.openLinkInExternalBrowser=function(ruleUrl){if(ruleUrl!=undefined&&ruleUrl!=''){var index=ruleUrl.indexOf("http://");if(index==-1||index>0){ruleUrl="http://"+ruleUrl}window.open(ruleUrl,'_blank')}};$scope.processRule=function(action){if(action==='proceed'){$scope.ignoreAndProceed=true;$scope.txtReason='';$scope.ruleStatus='Ignore And Proceed';$("#changeRegRuleLogStatusDialog").modal({show:true,backdrop:'static'})}};$scope.triggerRegistrationRulesForPtInfo=function(){$scope.isFirstTimeLoad=false;$scope.showRightChartPanelHeading=false;$scope.panelUrl="";var url='/mobiledoc/jsp/rulesengine/processRegistrationRules.jsp?action=applyRules&encounterId='+$scope.encounterId+'&userId='+global.TrUserId;url=makeURL(url);$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,"async":false}).then(function(response){try{if(response.data==='success'){$scope.regFailedRules=[];if($scope.panelStatus==="1"){$scope.panelUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId='+$scope.encounterId+'&PtId='+$scope.patientId+'&RxCheck=Nothing&sessionDID=0&ecwappprocessid=281&date='+(new Date).getTime())}}else{$scope.showRegRulesResult(response.data)}}catch(e){showMessage(e)}},function(response){showMessage("Error executing registration rules.")})};$scope.isRegRuleError=false;$scope.triggerRegistrationRules=function(){var url='/mobiledoc/jsp/rulesengine/processRegistrationRules.jsp?action=applyRules&encounterId='+$scope.encounterId+'&userId='+global.TrUserId;url=makeURL(url);$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,"async":false}).then(function(response){try{if(response.data==='success'){$scope.isRegRuleError=false;$scope.regFailedRules=[];$scope.saveAppointment()}else{$scope.isRegRuleError=true;$scope.showRegRulesResult(response.data)}}catch(e){showMessage(e)}},function(response){showMessage("Error executing registration rules.")})};$scope.checkInitialTreatmentDate=function(actionFlag){var message="";if($scope.isNewAppt){var url='/mobiledoc/jsp/catalog/xml/edi/InitialTreatmentDate/getInitialTreatmentDate.jsp?PatientId='+$scope.patientDtls.patient.id+'&ProviderId='+$scope.appointmentProvider.providerId+"&FacilityId="+$scope.facilityId+"&EncounterId="+$scope.encounterId;url=makeURL(url);$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,"async":false}).then(function(response){try{var conjson=convertInJSON(response.data);if(conjson!=null){var value=conjson.Envelope.Body['return'];if(value.status=='success'){if(value.Rule.RuleFound==false||value.Rule.RuleFound=='false'){$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag);return}var isNewDate=value.Rule.IsNewDateFound;if((isNewDate==true||isNewDate=='true')&&value.Rule.NewInitialTreatmentDate.length>0){var initTrmtDt=moment(value.Rule.NewInitialTreatmentDate).format($scope.dateFormat);message="Initial Treatment Date for this appointment is : "+initTrmtDt+".Do you want to continue ?";newAppointmentFnNameSpace.confirmDialog(message,'bluetheme',function(result){if(result){$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}else{$scope.closePopupFromAddlBillingData=true;$scope.saveEncData($scope.encounterId,actionFlag);$scope.showAdditionalBillingData()}})}else{if(value.Rule.NewInitialTreatmentDate.length<=0){message="Initial Treatment Date has not been entered. Are you sure you want to save the appointment anyway?";newAppointmentFnNameSpace.confirmDialog(message,'bluetheme',function(result){if(result){$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}else{$scope.closePopupFromAddlBillingData=true;$scope.saveEncData($scope.encounterId,actionFlag);$scope.showAdditionalBillingData()}},"Appointment Details - Initial Treatment Date Not Entered")}else{$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}}}else{$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}}else{$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}}catch(e){$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}},function(response){$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)})}else{var url='/mobiledoc/jsp/catalog/xml/edi/InitialTreatmentDate/getInitialTreatmentDate.jsp?EncounterId='+$scope.encounterId+"&checkDate=true";url=makeURL(url);$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,"async":false}).then(function(response){try{var conjson=convertInJSON(response.data);if(conjson!=null){var value=conjson.Envelope.Body['return'];if(value.status=='success'){if(value.Rule.RuleFound==false||value.Rule.RuleFound=='false'){$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag);return}var InvId=value.Rule.InvoiceId;if(InvId<=0){var initTrmtDt=value.Rule.InitialTreatmentDate;if(initTrmtDt==""){message="Initial Treatment Date has not been entered. Are you sure you want to save the appointment anyway?";newAppointmentFnNameSpace.confirmDialog(message,'bluetheme',function(result){if(result){$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}else{$scope.closePopupFromAddlBillingData=true;$scope.saveEncData($scope.encounterId,actionFlag);$scope.showAdditionalBillingData()}},"Appointment Details - Initial Treatment Date Not Entered")}else{$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}}else{$scope.closePopupFromAddlBillingData=false;$scope.saveEncData($scope.encounterId,actionFlag)}}}}catch(e){$scope.saveEncData($scope.encounterId,actionFlag)}},function(response){$scope.saveEncData($scope.encounterId,actionFlag)})}};$scope.validateNumber=function(number){let re=/^[0-9]*$/;return re.test(number)};$scope.creaetXmlForappt=function(){if($scope.encounterId>0){var mapresult=false;mapresult=isVisitStatusCannotBeDeleted($scope.appointmentVisitStatus.code);if(scheduleCommonService.CheckVitalForEnc($scope.encounterId)>0&&scheduleCommonService.CheckIsPNProcedureCodeDoneForEnc($scope.encounterId)>0&&mapresult===true){$scope.showAlertForVitalsPnProcedureCodeDone()}else if(scheduleCommonService.CheckVitalForEnc($scope.encounterId)>0&&mapresult===true){$scope.showAlertForVitals()}else if(scheduleCommonService.CheckIsPNProcedureCodeDoneForEnc($scope.encounterId)>0&&mapresult===true){$scope.showAlertForPnProcedureCodeDone()}else if(!checkBillingNotes()){let strBillingNotesMsg="<div class='bootbox-body pad15'>";strBillingNotesMsg+="<div class='col-sm-12 nopadding'>Billing Notes has been changed from other screen.</div>";strBillingNotesMsg+="<div class='col-sm-12 nopadding' style='margin-top:5px;'>";strBillingNotesMsg+="     <div class='col-sm-3 nopadding' style='margin-right: 5px;'>Updated Billing Notes:</div>";strBillingNotesMsg+="     <div class='col-sm-8 nopadding' style='padding: 3px 10px 3px 10px !important;border:1px solid #ccc;background-color:white;'>";strBillingNotesMsg+="         <b>"+escapeHtml($scope.updatedBillingNotes)+"</b>";strBillingNotesMsg+="     </div>";strBillingNotesMsg+="</div>";strBillingNotesMsg+="<div class='col-sm-12 nopadding' style='margin-top:5px;'>Please reload updated Billing Notes by clicking <b>'Reload Billing Notes'</b> button.</div>";strBillingNotesMsg+="<div class='clearfix'></div>";ecwConfirm(strBillingNotesMsg,"Billing Note Modification Alert",function(){$scope.oldBillingNote=$scope.updatedBillingNotes;$scope.billingNotes=$scope.updatedBillingNotes;if($scope.$$phase!='$apply'&&$scope.$$phase!='$digest'){$scope.$apply()}},function(){return},"bluetheme",true,true,"Reload Billing Notes","Cancel")}else if((scheduleCommonService.CheckLabForEnc($scope.encounterId)>0||scheduleCommonService.CheckMedicationForEnc($scope.encounterId)==="true"||scheduleCommonService.CheckPLandDiagnosesForEnc($scope.encounterId)>0)&&mapresult===true){$scope.showAlertForLabDI()}else{$scope.saveContinue()}}else{$scope.saveContinue()}};function isVisitStatusCannotBeDeleted(strStatusCode){var respData=getCachedData("/mobiledoc/jsp/catalog/xml/GetEcwVisitStatusCodes.jsp");try{var jsonData=xml2json(respData.trim());var visitStatusCodeMap=jsonData.Envelope.Body['return'].resultset.data.row;for(var visitStatusIndex in visitStatusCodeMap){if(strStatusCode===visitStatusCodeMap[visitStatusIndex].code){if(visitStatusCodeMap[visitStatusIndex].description===ECW_VISITSTATUSCODE_MAPPING_NOSHOW||visitStatusCodeMap[visitStatusIndex].description===ECW_VISITSTATUSCODE_MAPPING_CANCELLED||visitStatusCodeMap[visitStatusIndex].description===ECW_VISITSTATUSCODE_MAPPING_RESCHEDULED){return true}}}return false}catch(err){ecwAlert(err.message)}}$scope.updatedBillingNotes="";function checkBillingNotes(){let result=true;let encounterId=$scope.encounterId;if(!isNaN(encounterId)&&Number(encounterId)>0){let oldBillingNotes=$scope.oldBillingNote===undefined?"":$scope.oldBillingNote;let newBillingNotes=getBillingNotes(encounterId);$scope.updatedBillingNotes=newBillingNotes;if(String(newBillingNotes).trim().toLowerCase()!==String(oldBillingNotes).trim().toLowerCase()){result=false}}return result}$scope.saveContinue=function(){var checkFieldLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_appointment","newApptController","bluetheme");if(checkFieldLength===true){if($scope.pmVisitIDExtTable&&$scope.pmVisitIDExtTable.toLowerCase()==='no'&&!$scope.validateNumber($scope.visitNo)){showMessage("Visit Number must be numeric");return}let isNew=true;if(!newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)){isNew=false}let xmlDoc=$scope.createXmlForAppointment(isNew);$scope.createAppt(xmlDoc)}};$scope.showAlertForLabDI=function(){$scope.showAlertPopup.title="Resource Scheduling - Appointment Booking";var message="You have updated the visit status as Cancelled/No Show/Rescheduled.<br>Are you sure you want to continue?";$scope.showAlertPopup.errorMessage=angular.copy(message.split("<br>"));$scope.showAlertPopup.deleteError=true;$scope.showAlertPopup.backdrop=true};$scope.showAlertForVitalsPnProcedureCodeDone=function(){$scope.showAlertPopup.title="Resource Scheduling - Appointment Booking";var message="This encounter cannot be marked as <b>Cancelled,No Show or </b> <br><b>Rescheduled</b> because it has <b>vitals</b> captured.<br>";message=message+"\nThis encounter cannot be marked as <b>Cancelled,No Show or </b> <br><b>Rescheduled</b> because it has been marked as <b>Done.</b>";$scope.showAlertPopup.errorMessage=angular.copy(message.split("<br>"));$scope.showAlertPopup.deleteError=true;$scope.showAlertPopup.backdrop=true;$scope.hide_labdiprocedureprompt=true};$scope.showAlertForVitals=function(){$scope.showAlertPopup.title="Resource Scheduling - Appointment Booking";var message="This encounter cannot be marked as <b>Cancelled,No Show or </b> <br><b>Rescheduled</b> because it has <b>vitals</b> captured.";$scope.showAlertPopup.errorMessage=angular.copy(message.split("<br>"));$scope.showAlertPopup.deleteError=true;$scope.showAlertPopup.backdrop=true;$scope.hide_labdiprocedureprompt=true};$scope.showAlertForPnProcedureCodeDone=function(){$scope.showAlertPopup.title="Resource Scheduling - Appointment Booking";var message="This encounter cannot be marked as <b>Cancelled,No Show or </b> <br><b>Rescheduled</b> because it has been marked as <b>Done.</b>";$scope.showAlertPopup.errorMessage=angular.copy(message.split("<br>"));$scope.showAlertPopup.deleteError=true;$scope.showAlertPopup.backdrop=true;$scope.hide_labdiprocedureprompt=true};$scope.closeAlertPopUp=function(){$scope.showAlertPopup.deleteError=false;$scope.showAlertPopup.backdrop=false;$scope.showAlertPopup.errorMessage=[];$scope.showAlertPopup.title=""};$scope.onSaveAppt=function(){if($scope.isRegistrationRuleEngine){if($scope.saveFromVal==1||$scope.saveFromVal==12){$scope.triggerRegistrationRules()}else{$scope.saveAppointment()}}else{$scope.saveAppointment()}};$scope.saveAppointment=function(){if(isProviderScheduleVerticalBarsEnabled){$scope.saveProviderTimeSlots()}if($scope.saveFromVal===11){$scope.modalclose=false;$scope.openDentalTPScreen();return true}else if($scope.saveFromVal!="4"&&$scope.saveFromVal!=3&&$scope.saveFromVal!=5&&$scope.saveFromVal!="6"&&$scope.saveFromVal!="7"&&$scope.saveFromVal!="8"&&$scope.saveFromVal!=12&&(parentForm==="ResSchedule"||parentForm==="encounters")){if($scope.saveFromVal!="10"){$scope.closeApptScreen()}$scope.appointmentSaved=true}else if($scope.saveFromVal=="3"){try{$scope.setValForEditAppointment();$scope.modalclose=false;return true}catch(err){return false}}else if($scope.saveFromVal=="7"){$scope.modalclose=false;var nCopyEncId=$scope.encounterId;var strUrl=makeURL("/mobiledoc/jsp/catalog/xml/edi/checkEncClaimVoided.jsp?encid="+nCopyEncId);$.ajax({url:strUrl,"async":false,success:function(result){var conjson=convertInJSON(result);var value=conjson.Envelope.Body['return'];if(value.status!="success"){ecwAlert("An error occurred retrieveing recreated enc ID",defaultAlertTitle)}else{nCopyEncId=value.encounterid}},error:function(xhr){ecwAlert("Error: "+xhr.status,defaultAlertTitle)}});var copay=0;strUrl=makeURL("/mobiledoc/jsp/catalog/xml/edi/getApptCoPay.jsp?patientId="+$scope.patientId+"&encounterId="+nCopyEncId);$.ajax({url:strUrl,"async":false,success:function(result){var conjson1=convertInJSON(result);var value1=conjson1.Envelope.Body['return'];if(value1.status=="success"){copay=value1.Encounter.Copays}else{copay=0}}});if($scope.patientId>0&&nCopyEncId>0){var param={paymentId:0,parentScreen:'newApptController',copayAmt:copay,patientId:$scope.patientId,encId:nCopyEncId}}if($scope.multiCopayFlag){openMultipleCopayScreen()}else{loadReceivePayment($ocLazyLoad,$modal,param)}return true}else if($scope.saveFromVal=="8"){$scope.modalclose=false;$scope.loadModalChargeDetails();return true}else if($scope.saveFromVal=="4"){$scope.showRecurringPopUp()}else if($scope.saveFromVal==12){$scope.openFamilyApptModal()}else if($scope.saveFromVal=="6"){$scope.isNewEnc=false;$scope.disableLog=false;$scope.disableOrders=false;$scope.showRightChartPanelHeading=false;if($scope.ikEnableApptRightPanel&&$scope.panelStatus==="1"){$scope.panelUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId='+$scope.encounterId+'&PtId='+$scope.patientId+'&RxCheck=Nothing&sessionDID=0&ecwappprocessid=281&date='+(new Date).getTime())}$scope.saveFromVal="";$scope.modalclose=false;$scope.loadStructDataForBillingNotes()}else if(parentForm=='bumpList'){$rootScope.$broadcast("scheduleBumpedAppt",$scope.encounterId);$templateCache.remove($scope.popupurl);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();if($scope.enableOccHealth&&$scope.occMedValue.toLowerCase()==='yes'){$scope.$parent.openOcc($scope.encounterId,$scope.appointmentStartTime.time,$scope.appointmentEndTime.time,$scope.appointmentResource.id,$scope.appointmentResource.resourceName,$scope.StDate,$scope.appointmentVisitType.Name,"",$scope.appointmentVisitType.color,$scope.facilityId,$scope.facilityName,$scope.patientId,$scope.ptName,"bumpList",$scope.reservedSlotId,$scope.pos,schedulefacilityFilter,block_id)}$scope.cleanUp()}else if(parentForm=='waitList'){var waitlistPatient={};waitlistPatient.patientId=$scope.patientId;waitlistPatient.patientName=$scope.ptName;$rootScope.$broadcast("scheduleWaitListedAppt",waitlistPatient);$templateCache.remove($scope.popupurl);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();$scope.cleanUp()}else if(parentForm==='FamilyBooking'){$templateCache.remove($scope.appointmentUrl.url);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();$scope.$parent.familyBookingApptSaved();$scope.cleanUp()}else if(parentForm==='ResourceGrid'){$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();$scope.$parent.getEventsFromServer();$scope.cleanUp()}else if(parentForm==='MultipleApptModern'){$templateCache.remove($scope.bookApptLookupUrl);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();let aptDetailObj={startDate:$scope.StDate,startTime:$scope.appointmentStartTime.time,endTime:$scope.appointmentEndTime.time,encId:$scope.encounterId,ptId:$scope.patientId,ptName:$scope.patientDtls.patient.name,visitType:$scope.appointmentVisitType.Name,providerId:$scope.appointmentResource.id,facilityId:$scope.facilityId,facilityName:$scope.facilityName,resourceName:$scope.appointmentResource.resourceName};$scope.$parent.onApptBookingDone(aptDetailObj)}else if(parentForm=="trackingBoard"||parentForm=="healowBoard"){var encObj={visitStatus:$scope.appointmentVisitStatus.code,encId:$scope.encounterId,arrTime:$scope.arriveTime,encDate:$scope.getStartDateInYYYYMMDD(),notesLoginId:"",logDate:"",room:"",patientId:$scope.patientId};$scope.$parent.initCountsandList(encObj);$templateCache.remove($scope.popupurl);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");if(isLockMine(apptLockObj)){releaseFormLock(apptLockObj)}$(".modal-backdrop").remove();if($scope.enableOccHealth&&$scope.occMedValue.toLowerCase()==='yes'){openOccHealthAppointment($scope.encounterId,$scope.appointmentStartTime.time,$scope.appointmentEndTime.time,$scope.appointmentResource.id,$scope.appointmentResource.resourceName,$scope.StDate,$scope.appointmentVisitType.Name,"",$scope.appointmentVisitType.color,$scope.facilityId,$scope.facilityName,$scope.patientId,$scope.ptName,"trackingBoard",$scope.reservedSlotId,$scope.pos,schedulefacilityFilter,block_id)}$scope.cleanUp()}else if(parentForm==="transitionCareManagement"){$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();$scope.$parent.newApptClose()}else if(parentForm==='HI_GIC_WORKLIST'){angular.element("[ng-controller='gapsInCareAlertController']").scope().onCloseAppt($scope.encounterId);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove()}else if(parentForm==='HI_PDX_WORKLIST'){angular.element("[ng-controller='pdxAlertController']").scope().onCloseAppointment($scope.encounterId);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove()}else if($scope.saveFromVal===1&&parentForm==="officevisit"){$scope.closeApptScreen()}else if($scope.saveFromVal===1&&parentForm==="eligibilityAdmin"){$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();$scope.cleanUp()}else{if($scope.actions.apptAction!=1){if($('#rptog').hasClass('active')){$scope.Dialog.width='1080px'}else{$scope.Dialog.width='750px'}$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1}else{if(parentForm==="patientHub"){$rootScope.$broadcast("refreshResourceSchedule")}$templateCache.remove($scope.popupurl);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();if($scope.enableOccHealth&&$scope.occMedValue.toLowerCase()==='yes'){openOccHealthAppointment($scope.encounterId,$scope.appointmentStartTime.time,$scope.appointmentEndTime.time,$scope.appointmentResource.id,$scope.appointmentResource.resourceName,$scope.StDate,$scope.appointmentVisitType.Name,"",$scope.appointmentVisitType.color,$scope.facilityId,$scope.facilityName,$scope.patientId,$scope.ptName,"patientHub",$scope.reservedSlotId,$scope.pos,schedulefacilityFilter,block_id)}$scope.cleanUp()}}if(parentForm=="Abstraction"){$scope.$parent.showSplitEncounterPopup(masterAbstractEncounter,encId)}if($scope.encounterId>0&&$scope.ikEnableSaveAndViewAppt&&$scope.saveFromVal=="2"){$scope.openProgressNoteOnSaveAppt($scope.encounterId,$scope.appointmentVisitType.Name,$scope.patientId,$scope.appointmentVisitStatus.code)}if(refreshRegDashBoardOnclose==1){$scope.$parent.paginationDetail.pageNo=1;$scope.$parent.getFilteredLogs()}if($scope.saveFromVal=="10"){$scope.saveFromVal="";$scope.loadCheckout()}if(parentForm=='PatientHousingPN'){$scope.$parent.changeEvent()}$scope.processCRE()};function openMultipleCopayScreen(){$ocLazyLoad.load({name:'apptEligibilityMultipleCopaySelectionCtrl',files:['/mobiledoc/jsp/webemr/webpm/eligibility/js/apptEligibilityMultipleCopaySelectionCtrl.js'],cache:false}).then(function(){$scope.apptEligibilityMultiCopaySelection.url=makeURL("/mobiledoc/jsp/webemr/webpm/eligibility/ApptEligibilityMultipleCopaySelectionModal.jsp?encId="+$scope.encounterId+"&patientId="+$scope.patientId)},function(e){showMessage("An error occurred in Preview Multiple Copay Modal")})}$scope.refreshCopayAmount=function(copayAmount,copayChanged){if($scope.$$phase!=='$apply'&&$scope.$$phase!=='$digest'){$scope.$apply(function(){refreshCopayVariables(copayAmount,copayChanged)})}else{refreshCopayVariables(copayAmount,copayChanged)}};function refreshCopayVariables(copayAmount,copayChanged){$scope.coPayCb=true;$scope.copayChanged=copayChanged;$scope.mCoPaytext=copayAmount;$scope.readonlytxt=false;$scope.refreshPanel()}$scope.openReceivedPaymentOnCopayMismatch=function(){if($scope.$$phase!=='$apply'&&$scope.$$phase!=='$digest'){$scope.$apply(function(){$scope.refreshPanel()})}else{$scope.refreshPanel()}let receiveCopayCallBack={paymentId:0,parentScreen:'newApptController',copayAmt:'0.00',patientId:$scope.patientId,encId:$scope.encounterId};loadReceivePayment($ocLazyLoad,$modal,receiveCopayCallBack)};$scope.opemMUCaptuer=function(){var suggestedUser=$scope.patientDtls.patient.name;suggestedUser=suggestedUser.replace(",","");suggestedUser=suggestedUser.replace("'","");const myArray=suggestedUser.split(",");suggestedUser=myArray[0];var dob=$scope.ptDob;if(typeof dob!='undefined'&&dob!=""&&dob!=null&&dob!='null'&&dob.length>8){dob=dob.substring(dob.length-4,dob.length)}suggestedUser=suggestedUser+dob;suggestedUser=suggestedUser.replace(/\s/g,'');$scope.suggestedUser=suggestedUser;$("#_emailexist_scnd").modal()};let referralVisitNoShow=function(action){if(action==="Modified"&&$scope.appointmentVisitStatus&&$scope.appointmentVisitStatus.code==="N/S"){let httpHeader={headers:{'Content-Type':'application/x-www-form-urlencoded'}};var params=$.param({encounterId:$scope.encounterId});$http.post(makeURL('/mobiledoc/referral/referral-base/referral-visit-noshow'),params,httpHeader)}};$scope.openOptOut=function(){$("#_emailexist_scnd_optout").modal()};$scope.createAppt=function(xmlDoc){var result=false;var referralAction1="";if(xmlDoc){var actionFlag=0;var encUrl="";if(!newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)){encUrl="/mobiledoc/jsp/catalog/xml/updateEncounter.jsp?EncounterId="+$scope.encounterId;encUrl=makeURL(encUrl);actionFlag=1;referralAction1="Modified"}else{encUrl="/mobiledoc/jsp/catalog/xml/newEncounter.jsp";encUrl=makeURL(encUrl);referralAction1="Created"}$.ajax({type:"POST",url:encUrl,data:{FormData:xmlDoc},dataType:"xml","async":false,success:function(msg){if(msg){var status=$(msg).find('status').text();if(actionFlag==0){$scope.encounterId=$(msg).find('encounterID').text();if($scope.encounterId>0){$scope.isNewEnc=false;$scope.isDisabled=true}}if('success'==status){$scope.oldBillingNote=angular.copy($scope.billingNotes);if($(msg).find('isPatientDeleted').text()==="true"||$(msg).find('isPatientDeleted').text()===true){var message="Selected patient is deleted.";showMessage(message)}else{result=true;if($scope.ikenableHumanaChanges){scheduleCommonService.sendTransportationDetails($scope.encounterId,global.TrUserId,"appointments")}$scope.apptForm.$setPristine();if($scope.ikEnableAppointmentBillingData){$scope.checkInitialTreatmentDate(actionFlag)}else{$scope.saveEncData($scope.encounterId,actionFlag)}if($scope.referralIDNew==0||$scope.referralIDNew==""||$scope.referralIDNew!=undefined&&$scope.encounterId!=0){if($scope.referralvisitsAllowed!=undefined&&$scope.referralvisitNo!=undefined||$scope.showCode&&$scope.referralAction=="Delete"){$scope.saveEncountertoReferralVisits($scope.referralIDNew,$scope.referralvisitsAllowed,$scope.referralvisitNo,$scope.encounterId,$scope.referralAction,referralAction1)}}}try{$scope.isRxHubEnabled=getItemKeyValue("EnableRxHub").toLowerCase()==="yes";if($scope.isRxHubEnabled&&$scope.encounterId>0&&$scope.appointmentVisitStatus.code&&$scope.appointmentVisitStatus.code==="ARR"){rxService.performAutoModeChecks($scope.encounterId,"Eligibility")}}catch(e){}referralVisitNoShow(referralAction1)}var errorMessage=$(msg).find('errormsg').text();if(errorMessage){ecwAlert(errorMessage,defaultAlertTitle)}if(getItemKeyValue("PromptPayData")=='yes'&&payDataMappingObj){$scope.isValidCaseType=false;if($scope.caseDetails){for(var i=0;i<$scope.caseDetails.length;i++){if($scope.caseDetails[i].caseid==$scope["case"]&&$scope.caseDetails[i].code==payDataMappingObj.CaseStatus){$scope.isValidCaseType=true}}}if($scope.appointmentVisitStatus.code==payDataMappingObj.VisitStatus&&$scope.isValidCaseType){$scope.setPayData()}}if(isTrackingBoardEnable&&$scope.ikEncStatusCycleTime&&parentForm!="trackingBoard"){var prevstatus=$scope.isVisitStatusChanged?$scope.appointmentSelectedVisitStatus:"";if(!$scope.isNewEnc&&$scope.isVisitStatusChanged||$scope.isNewEnc){var param={prevStatus:prevstatus,currStatus:$scope.appointmentVisitStatus.code,prevTime:$scope.prevCycleTime,currTime:moment().format("HH:mm:ss"),encounterId:$scope.encounterId,patientId:$scope.patientId,encDate:$scope.getStartDateInYYYYMMDD(),filter:"changeVisitStatus",userId:global.TrUserId};ajaxCallByPost(makeURL('/mobiledoc/jsp/webemr/scheduling/trackingBoard/getDataForAlert.jsp'),param)}}}},error:function(){var message="An error occurred while "+($scope.encounterId>0?"updating":"creating")+" an appointment.";showMessage(message)}});return result}};$scope.setPayData=function(caseid){var url=makeURL("/mobiledoc/jsp/webemr/scheduling/Controller.jsp");$http({method:"POST",url:url,cache:true,params:{action:"savePayData",encounterId:$scope.encounterId,serviceDate:$scope.getStartDateInYYYYMMDD(),patientId:$scope.patientId,caseId:$scope["case"]}}).success(function(msg,status,headers,config){ecwAlert("saved data for pay data",defaultAlertTitle)}).error(function(data,status,headers,config){var message="An error occurred while saving pay data.";showMessage(message)})};$scope.processCRE=function(){var clinicalRulePermit=getItemKeyValue("EnableClinicalRuleEngine");var isExecuteCRESecurityPermissionEnabled=getPermission("AllowAccessToExecuteClinicalRuleEngine",global.TrUserId);if(clinicalRulePermit&&clinicalRulePermit.toLowerCase()==='yes'&&isExecuteCRESecurityPermissionEnabled){var url="/mobiledoc/jsp/clinicalrule_ccmr/processClinicalRuleEngine.jsp?parentname=frmNewAppt&EncounterId="+$scope.encounterId+"&PtId="+$scope.patientId+"&TrUserId="+global.TrUserId+"&lockstyle=";$http({method:"POST",url:url,cache:true,params:{nd:(new Date).getTime()}}).success(function(msg,status,headers,config){if(msg==="SUCCESS"){$ocLazyLoad.load({name:'previewCREEvent',files:getDependencies('orderStatusDropdownProvider').concat(['/mobiledoc/jsp/webemr/clinicalrule/previewClinicalEventsListController.js']),cache:false}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/clinicalrule/previewClinicalEventsList.jsp?fromCCMR=false&EncounterId="+$scope.encounterId+"&PtId="+$scope.patientId+"&TrUserId="+global.TrUserId+"&source=&visitid=&lockstyle=");if($scope.creObj!==undefined&&$scope.creObj.crePreviewURL!==undefined){$scope.creObj.crePreviewURL=url}else{$scope.$parent.setCREPreviewURL(url)}},function(e){var message="An error occurred in Preview Clinical Event List.";showMessage(message)})}}).error(function(data,status,headers,config){var message="An error occurred while processing CRE.";showMessage(message)})}};$scope.ptCheckIn=false;$scope.ptCheckOut=false;$scope.practiceId=0;$scope.createXmlForAppointment=function(isNew){if($scope.occMedValue.toLowerCase()==='yes'&&$scope.appointmentVisitType.occHealthVisit=='1'){$scope.enableOccHealth=true}$scope.modalclose=true;var startDate=$scope.getStartDateInYYYYMMDD();var startTimeForAppt=moment($scope.appointmentStartTime.time,$scope.timeFormat).format("hh:mm:ss a");var endTimeForAppt=moment($scope.appointmentEndTime.time,$scope.timeFormat).format("hh:mm:ss a");var myDate="";var newPt=0;if($scope.isNewPt){newPt=1}if(getECWDescFromCode($scope.appointmentVisitStatus.code)===$scope.ECW_CHECKIN.toLowerCase()){if($scope.isVisitStatusChanged||$scope.arriveTime=='00:00:00'||$scope.arriveTime=='1900-01-01'){$scope.arriveTime=moment().format("HH:mm:ss");$scope.arriveTimeInUTC=moment.utc().format('YYYY-MM-DD HH:mm:ss')}$scope.depTime="00:00:00";$scope.ptCheckIn=true;$scope.ptCheckOut=false}else if(getECWDescFromCode($scope.appointmentVisitStatus.code)===$scope.ECW_CHKOUT.toLowerCase()){$scope.ptCheckIn=false;$scope.ptCheckOut=true;if($scope.isVisitStatusChanged||$scope.depTime=='00:00:00'||$scope.depTime=='1900-01-01'){$scope.depTime=moment().format("HH:mm:ss");$scope.depTimeInUTC=moment.utc().format('YYYY-MM-DD HH:mm:ss')}}else{if($scope.appointmentVisitStatus.code&&getECWDescFromCode($scope.appointmentVisitStatus.code)===$scope.ECW_PENDING.toLowerCase()){$scope.arriveTime="00:00:00";$scope.depTime="00:00:00";$scope.arriveTimeInUTC="";$scope.depTimeInUTC="";$scope.ptCheckIn=false;$scope.ptCheckOut=false}}if(typeof $scope.apptreasons=='undefined'){$scope.apptreasons=""}if(typeof $scope.billingNotes=='undefined'){$scope.billingNotes=""}if(typeof $scope.generalNotes=='undefined'){$scope.generalNotes=""}var xmlWriter=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xmlWriter);xmlWriter.writeStartElement('encounter');xmlWriter.writeAttributeString('xsi:type','xsd:string');addElement(xmlWriter,"id",$scope.patientId,'xsi:type','xsd:int');addElement(xmlWriter,"date",startDate,'xsi:type','xsd:string');addElement(xmlWriter,"time",startTimeForAppt,'xsi:type','xsd:string');addElement(xmlWriter,"endTime",endTimeForAppt,'xsi:type','xsd:string');addElement(xmlWriter,"visitType",$scope.appointmentVisitType.Name,'xsi:type','xsd:string');if($scope.enableVisitSubType){var visitSubTypeId=newAppointmentFnNameSpace.checkIfEmpty($scope.appointmentVisitSubType.id)?"0":$scope.appointmentVisitSubType.id;addElement(xmlWriter,"visitSubTypeId",visitSubTypeId,'xsi:type','xsd:int')}addElement(xmlWriter,"reason",$scope.apptreasons,'xsi:type','xsd:string');addElement(xmlWriter,"doctorid",$scope.appointmentProvider.providerId,'xsi:type','xsd:int');addElement(xmlWriter,"status",$scope.appointmentVisitStatus.code,'xsi:type','xsd:string');addElement(xmlWriter,"billing",$scope.billingNotes,'xsi:type','xsd:string');addElement(xmlWriter,"encType",'1','xsi:type','xsd:string');addElement(xmlWriter,"notes",$scope.generalNotes,'xsi:type','xsd:string');addElement(xmlWriter,"visitSubType",$scope.visitSubType,'xsi:type','xsd:string');addElement(xmlWriter,"facilityId",$scope.facilityId,'xsi:type','xsd:int');addElement(xmlWriter,"POS",$scope.pos,'xsi:type','xsd:int');addElement(xmlWriter,"arrTime",$scope.arriveTime,'xsi:type','xsd:string');addElement(xmlWriter,"depTime",$scope.depTime,'xsi:type','xsd:string');addElement(xmlWriter,"ptFlag",newPt,'xsi:type','xsd:string');addElement(xmlWriter,"Dx",$scope.apptDiagnosis,'xsi:type','xsd:string');if(isNew&&($scope.visitTypeOverriden===undefined||$.trim($scope.visitTypeOverriden)==="")){$scope.visitTypeOverriden=angular.copy($scope.appointmentVisitType.Name)}addElement(xmlWriter,"visitTypeOverriden",$scope.visitTypeOverriden,'xsi:type','xsd:string');addElement(xmlWriter,"refPrName",$scope.refProviderName,'xsi:type','xsd:string');addElement(xmlWriter,"refPrId",$scope.refProviderId,'xsi:type','xsd:string');addElement(xmlWriter,"DeptId",$scope.deptId,'xsi:type','xsd:int');addElement(xmlWriter,"UserInfo",'','xsi:type','xsd:string');addElement(xmlWriter,"resourceId",$scope.appointmentResource.id,'xsi:type','xsd:string');addElement(xmlWriter,"resFacFilterId",schedulefacilityFilter,'xsi:type','xsd:int');addElement(xmlWriter,"practiceId",$scope.practiceId,'xsi:type','xsd:int');addElement(xmlWriter,"transitionofcare",$scope.transitionOfCare,'xsi:type','xsd:int');addElement(xmlWriter,"ptEmail",$scope.ptEmail,'xsi:type','xsd:string');addElement(xmlWriter,"cancellationReason",$scope.cancellationReason,'xsi:type','xsd:string');addElement(xmlWriter,"userId",global.TrUserId,'xsi:type','xsd:string');addElement(xmlWriter,"webEnabled",$scope.chkEmailCb,'xsi:type','xsd:string');addElement(xmlWriter,"hasBookConflict",hasBookConflict,'xsi:type','xsd:string');addElement(xmlWriter,"hasOverbookAppt",hasOverbookAppt,'xsi:type','xsd:string');if(isTrackingBoardEnable){var stsAfterArr='';var stsCheckInCheckOutTime='';var stsCheckInCheckOutTimeInUTC='';if(!$scope.isVisitStatusChanged&&$scope.encData.stsAfterArr==='IN'){stsAfterArr="CheckIn";stsCheckInCheckOutTime=$scope.arriveTime;stsCheckInCheckOutTimeInUTC=$scope.arriveTimeInUTC}else if(!$scope.isVisitStatusChanged&&$scope.encData.stsAfterArr==='OUT'){stsAfterArr="CheckOut";stsCheckInCheckOutTime=$scope.depTime;stsCheckInCheckOutTimeInUTC=$scope.depTimeInUTC}else{if(getECWDescFromCode($scope.appointmentVisitStatus.code)===$scope.ECW_CHECKIN.toLowerCase()){stsAfterArr="CheckIn";stsCheckInCheckOutTime=$scope.arriveTime;stsCheckInCheckOutTimeInUTC=$scope.arriveTimeInUTC}else if(getECWDescFromCode($scope.appointmentVisitStatus.code)===$scope.ECW_CHKOUT.toLowerCase()){stsAfterArr="CheckOut";stsCheckInCheckOutTime=$scope.depTime;stsCheckInCheckOutTimeInUTC=$scope.depTimeInUTC}else{stsAfterArr="";stsCheckInCheckOutTime="";stsCheckInCheckOutTimeInUTC=""}}addElement(xmlWriter,"stsAfterArr",stsAfterArr,'xsi:type','xsd:string');addElement(xmlWriter,"stsCheckInCheckOutTime",stsCheckInCheckOutTime,'xsi:type','xsd:string');addElement(xmlWriter,"stsCheckInCheckOutTimeInUTC",stsCheckInCheckOutTimeInUTC,'xsi:type','xsd:string');if($scope.ikEncStatusCycleTime&&!isNew){addElement(xmlWriter,"currDate",moment().format("YYYY-MM-DD"),'xsi:type','xsd:string');addElement(xmlWriter,"currTime",moment().format("HH:mm:ss"),'xsi:type','xsd:string')}}if($scope.ikenableHumanaChanges){addElement(xmlWriter,"transporationStatus",$scope.transPortationRequired,'xsi:type','xsd:string')}if($scope.enableOccHealth&&$scope.occMedValue.toLowerCase()==='yes'){addElement(xmlWriter,"isOccMedAppt",'1','xsi:type','xsd:string')}addElement(xmlWriter,"webEmr","true",'xsi:type','xsd:string');addElement(xmlWriter,"isResourceScheduleAppt","true",'xsi:type','xsd:string');xmlWriter.writeEndElement();return xmlWriter.flush()};$scope.focusElement="";$scope.getFocus=function(id){$scope.focusElement=id};$scope.releaseLock=function(){releaseFormLock(apptLockObj);if($scope.isClosed){$scope.closeApptpopUp();return}};$scope.isClosed=false;$scope.createAppointment=function(val){$scope.multiApptClick=0;if($scope.ikEnableConcurLockForAppt){if(apptLockObj.strKey!==""){if(!isLockMine(apptLockObj)){var strMsg="This section has been modified by another user(s). For patient data consistency, your data will not be saved. Please re-enter the information if applicable.";var str=getItemKeyValue("concurlockalertmsg");if(str){strMsg=str}$scope.isClosed=true;ecwAlert(strMsg,defaultAlertTitle,$scope.releaseLock)}}}if(!$scope.isClosed){$scope.saveFromVal=val;$scope.ckeckForPtdemographicMandatoryFields()}};$scope.appointmentSaved=false;$scope.setValForEditAppointment=function(){$scope.isNewEnc=false;$scope.disableLog=false;$scope.disableOrders=false;$scope.showRightChartPanelHeading=false;if($scope.ikEnableApptRightPanel&&$scope.panelStatus==="1"){$scope.panelUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId='+$scope.encounterId+'&PtId='+$scope.patientId+'&RxCheck=Nothing&sessionDID=0&ecwappprocessid=281&date='+(new Date).getTime())}if($scope.saveFromVal=="10"){$scope.saveFromVal="";$scope.loadCheckout()}else{$scope.saveFromVal="";$scope.loadModalChargeDetails()}};$scope.getPatientWaitTimeUrl=function(){var url=makeURL('/jsp/catalog/xml/setPatientWaitTime.jsp');return url};$scope.getReserveSlotUrl=function(){var url=makeURL("/jsp/kiosk/updateRSSlot.jsp");return url};$scope.ajaxBatch=[];$scope.saveEncData=function(encounterId,actionFlag){$scope.ajaxBatch=[];var isEqualData=false;$scope.newEncounterData=fetchEncounterAllFields();if(actionFlag===1){isEqualData=_.isEqual($scope.oldEncounterData,$scope.newEncounterData)}if(!isEqualData){var xml=$scope.getLogXml(actionFlag);var url=$scope.getLogUrl().trim();$scope.ajaxBatch.push({url:url,param:[{paramName:"encounterId",paramValue:$scope.encounterId},{paramName:"FormData",paramValue:xml}],error:appointmentLogError})}$scope.ajaxBatch.push({url:makeURL('/jsp/webemr/InterfaceDashboard/requestHandler.jsp'),param:[{paramName:"encounterId",paramValue:$scope.encounterId},{paramName:"TrUserId",paramValue:global.TrUserId},{paramName:"requestFor",paramValue:'triggerSIU'}],error:appointmentADTTriggerLogError});$scope.ajaxBatch.push({url:$scope.getEncLogsURl(),param:[{paramName:"date",paramValue:$scope.getDateInDbFormat()}],error:appointmentEncLogError});$scope.ajaxBatch.push({url:$scope.getVisitCoPayUrl(),param:[{paramName:"EncounterId",paramValue:$scope.encounterId},{paramName:"visitCopay",paramValue:$scope.getCopay()},{paramName:"copayChanged",paramValue:$scope.copayChanged},{paramName:"claimRequired",paramValue:$scope.getClaimReq()},{paramName:"caseid",paramValue:$scope.getCaseId()},{paramName:"actionFlag",paramValue:actionFlag}],error:appointmentvisitCoPayError});if($scope.ikEnableClinicalRuleEngine){$scope.ajaxBatch.push({url:$scope.getClinicalRuleEngineUrl(),param:[{paramName:"EncounterId",paramValue:$scope.encounterId},{paramName:"PtId",paramValue:$scope.patientId},{paramName:"parentname",paramValue:"frmNewAppt"}],error:processClinicalRuleEngineError})}if($scope.ikEncStatusCycleTime){$scope.ajaxBatch.push({url:$scope.getEncStatusCycleTimeUrl(),param:[{paramName:"visitstscode",paramValue:$scope.appointmentVisitStatus.code}],success:onSaveEncStatusCycleTime,error:SaveEncStatusCycleTimeError})}if($scope.ikEnableMeasureProfiling&&(getECWDescFromCode($scope.appointmentVisitStatus.code)===$scope.ECW_CHECKIN.toLowerCase()||getECWDescFromCode($scope.appointmentVisitStatus.code)===$scope.ECW_CHKOUT.toLowerCase())){$scope.ajaxBatch.push({url:$scope.getPtProfileMeasureUrl(),param:[{paramName:"ptId",paramValue:$scope.patientId},{paramName:"encId",paramValue:$scope.encounterId},{paramName:"userId",paramValue:global.TrUserId},{paramName:"visitSts",paramValue:$scope.appointmentVisitStatus.code}],error:PtProfileMeasureUrlError})}if(block_id>0){$scope.ajaxBatch.push({url:$scope.getNhxUrl(),param:[{paramName:"blockId",paramValue:block_id},{paramName:"encId",paramValue:$scope.encounterId},{paramName:"pId",paramValue:$scope.patientId}],error:NhxUrlError})}var orderXml=$scope.getTransmitOrderXml();if($scope.ikBrocktonInterface){$scope.ajaxBatch.push({url:$scope.getTransmitIndividualOrdersUrl(),param:[{paramName:"FormData",paramValue:orderXml}],error:transmitIndividualOrdersError})}if($scope.ikRecordPatientWaitTime&&$scope.waitTime=="00:00:00"){$scope.ajaxBatch.push({url:$scope.getPatientWaitTimeUrl(),param:[{paramName:"encid",paramValue:$scope.encounterId},{paramName:"waittime",paramValue:moment().format('HH:mm:ss')}],error:savePatientWaitTimeError});if($scope.reservedSlotId>0){$scope.ajaxBatch.push({url:$scope.getReserveSlotUrl(),param:[{paramName:"encid",paramValue:$scope.encounterId},{paramName:"slotid",paramValue:$scope.reservedSlotId}],error:updateReserveSlotError})}}if($scope.ikEnableHL7IDUpdate){$scope.ajaxBatch.push({url:$scope.getHl7Url(),error:errorOnSaveHl7})}if($scope.encounterId>0&&$scope.referralId>0&&$scope.refReq){$scope.ajaxBatch.push({url:$scope.getUrlForEncReferralAssociation(),param:[{paramName:"encid",paramValue:$scope.encounterId},{paramName:"refid",paramValue:$scope.referralId}],error:errorOnLinkencReferral})}if($scope.empiEnabled){$scope.ajaxBatch.push({url:$scope.getUpdateNewEncLogUrl(),error:errorOnUpdateNewEncLog})}if($scope.ikEnableASAPList){var ASAPModified=false;if(actionFlag===1){ASAPModified=_.isEqual($scope.oldEncounterData.ASAPisChecked,$scope.newEncounterData.ASAPisChecked)}if(!ASAPModified){$scope.ajaxBatch.push({url:$scope.getASAPListUrl(),param:[{paramName:"EncounterId",paramValue:$scope.encounterId},{paramName:"PtId",paramValue:$scope.patientId},{paramName:"AppointmentDate",paramValue:$scope.getStartDateInYYYYMMDD()},{paramName:"StartTime",paramValue:$scope.getStartTimeIn24hr()},{paramName:"EndTime",paramValue:$scope.getEndTimeIn24hr()},{paramName:"UserId",paramValue:global.TrUserId},{paramName:"Notes",paramValue:""},{paramName:"isChecked",paramValue:$scope.chkASAPList},{paramName:"ActionFlag",paramValue:actionFlag}],error:errorOnASAPList})}}updateUserProfileLocalCache("ApptRightPanel",$scope.panelStatus);var userProfileXml=$scope.getUserProfileXml();$scope.ajaxBatch.push({url:$scope.getUserProfileUrl(),param:[{paramName:"FormData",paramValue:userProfileXml},{paramName:"UserId",paramValue:global.TrUserId}],error:errorOnSaveUserProfile,success:onSaveUserProfile});if($scope.enableUBData&&actionFlag===0){$scope.ajaxBatch.push({url:$scope.saveUBDataUrl(),param:[{paramName:"OpType",paramValue:'saveUBData'},{paramName:"encounterId",paramValue:$scope.encounterId},{paramName:"UBdetail",paramValue:JSON.stringify($scope.Ub92Data)}],error:errorOnSaveUBData})}batchAjaxService.batchAjax($scope.ajaxBatch);$scope.oldEncounterData=$scope.newEncounterData};var onSaveUserProfile=function(response){if($scope.encounterId>0){$scope.isFirstTimeLoad=false;if($scope.ikEnableWebPortal){if($scope.ptEmail!==""&&$scope.checkEmail&&$scope.chkEmailCb){var returnVal=appointmentService.saveMuAlertData($scope.ptEmail,$scope.patientId);if(returnVal==0){bootbox.dialog({message:"Patient Web-Enabled Successfully",title:"Appointment Details - Patient Web-Enabled Successfully",closeButton:false,onEscape:function(){$scope.onSaveAppt()},buttons:{success:{label:"OK",className:"btn btn-blue btn-xs mr5",callback:function(){$scope.onSaveAppt()}}}})}else if(returnVal==1){$scope.opemMUCaptuer()}}else if($scope.ptCheckIn&&$scope.ptCheckOut==false&&$scope.checkEmail&&!$scope.chkEmailCb&&$scope.patientDtls.patient.optout==0&&$scope.ikMUParticipate){$scope.openOptOut()}else{$scope.onSaveAppt()}}else{$scope.onSaveAppt()}}else{$scope.closeApptpopUp();ecwAlert("error throw from newencounter/updatencounter",defaultAlertTitle)}$scope.modalclose=false;$scope.commonwellUrl=""};var appointmentLogError=function(response){ecwAlert("Error occurred while saving appointment log.",defaultAlertTitle);return};var NhxUrlError=function(response){ecwAlert("Error occurred while NHX-enc linking",defaultAlertTitle);return};var appointmentEncLogError=function(response){ecwAlert("Error occurred while saving appointment encounter log.",defaultAlertTitle);return};var appointmentvisitCoPayError=function(response){ecwAlert("Error occurred while saving appointment visit copay.",defaultAlertTitle);return};var updateBumpListError=function(response){ecwAlert("Error occurred while updating a bumplist.",defaultAlertTitle);return};var processClinicalRuleEngineError=function(response){ecwAlert("Error occurred while processing clinical rule engine.",defaultAlertTitle);return};var onSaveEncStatusCycleTime=function(response){var statusCode=$(response).find("statusCode").text();if(statusCode!=null&&statusCode!=""&&typeof statusCode!='undefined'){var code=$(response).find("code").text();var name=$(response).find("name").text();var logDate=moment().format('yyyy-MM-DD HH:mm:ss');$.ajax({type:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/setEncStatus.jsp?encounterId="+$scope.encounterId+"&status="+code+"&name="+name+"&userId="+global.TrUserId+"&logDate="+logDate),success:function(data1){}})}};var PtProfileMeasureUrlError=function(response){ecwAlert("Error occurred while patient profile measure.",defaultAlertTitle);return};var transmitIndividualOrdersError=function(response){ecwAlert("Error occurred while transmitting individual order.",defaultAlertTitle);return};var savePtSIUInfoUrlError=function(response){ecwAlert("Error occurred while saving ptsiu info.",defaultAlertTitle);return};var savePatientWaitTimeError=function(response){ecwAlert("Error occurred while saving patient wait time.",defaultAlertTitle);return};var updateReserveSlotError=function(response){ecwAlert("Error occurred while updating reserved slot.",defaultAlertTitle);return};var errorOnSaveHl7=function(response){ecwAlert("Error occurred while saving visitno.",defaultAlertTitle);return};var SaveEncStatusCycleTimeError=function(response){ecwAlert("Error occurred while encounter status cycle time.",defaultAlertTitle);return};var errorOnSaveUserProfile=function(response){ecwAlert("Error occurred while saving user profiles",defaultAlertTitle);return};var errorOnUpdateNewEncLog=function(response){ecwAlert("Error occurred while updating encounter log",defaultAlertTitle);return};var errorOnLinkencReferral=function(response){ecwAlert("Error occurred while linking enc-referral",defaultAlertTitle);return};var errorOnASAPList=function(response){ecwAlert("Error occurred while saving ASAP List",defaultAlertTitle);return};let appointmentADTTriggerLogError=function(response){ecwAlert("Error occurred while triggering appointment via SIU Interface.",defaultAlertTitle);return};$scope.validateEmail=function(email){var re=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return re.test(email)};$scope.getNhxUrl=function(){return makeURL("/jsp/ereferralemr/linkApptBlockNHX.jsp")};$scope.emailMessage="";$scope.getMessage=function(email){$scope.emailMessage="";if(typeof email!='undefined'){if(email==""){$scope.emailMessage="E-mail address is blank."}else if(email==" "){$scope.emailMessage="E-mail address has spaces in it."}else if(email.indexOf("@")<0){$scope.emailMessage="E-mail address entered does not contain an @ sign."}else if(email.indexOf(".")<0){$scope.emailMessage="E-mail address entered does not contain '.' character"}else if(email.indexOf("@")==0){$scope.emailMessage=" @ sign can not be the first character in your email address."}else if(email.indexOf("@")==email.length-1){$scope.emailMessage="@sign can not be the last character in your email address."}else if(email.indexOf(".")==0){$scope.emailMessage=" '.' can not be the last character in your email address."}}};$scope.validateStartDate=function(date){var re=/^(0[1-9]|1[012])\/(0[1-9]|[12][0-9]|3[01])\/(199\d|[2-9]\d{3})$/i;return re.test(date)};$scope.validateTime=function(time){var re=/^(0?[1-9]|1[012])(:[0-5]\d) [APap][mM]$/;return re.test(time)};$scope.getHl7Url=function(){return makeURL("/jsp/catalog/xml/setHL7IDForEncounter.jsp?encounterId="+$scope.encounterId+"&HL7Id="+$scope.visitNo)};$scope.recurringAppt=function(){newAppointmentFnNameSpace.confirmDialog('This will save the appointment data. Do you want to continue?','bluetheme',function(result){if(result){recurringOnSaveAppt()}})};function recurringOnSaveAppt(){$scope.recurrence.recurrenceAction="new";if($scope.encounterId&&$scope.encounterId>0){var objRecurrence=appointmentService.isEncRecurringAndConflicting($scope.encounterId);if(objRecurrence&&objRecurrence.isRecurring){$scope.recurrence.recurrenceAction="edit"}}$scope.createAppointment(4)}$scope.showRecurringPopUp=function(){$ocLazyLoad.load({name:'AppointmentRecurrence',files:['/mobiledoc/jsp/webemr/scheduling/js/appointmentRecurrenceController.js']}).then(function(){var param="encounterId="+$scope.encounterId;param+="&startDate="+$scope.StDate;param+="&startTime="+$scope.appointmentStartTime.time;param+="&endTime="+$scope.appointmentEndTime.time;param+="&recurrenceAction="+$scope.recurrence.recurrenceAction;var url=makeURL("/mobiledoc/jsp/webemr/scheduling/appointmentRecurrence.jsp?"+param);$scope.newpopUpApptRecurrence=url},function(e){});$scope.saveFromVal=""};$scope.getWeekDay=function(){var weekDay=parseInt(moment($scope.StDate,$scope.dateFormat).day())+parseInt(1);return weekDay};$scope.getStartTimeIn24hr=function(){var startTime=moment($scope.appointmentStartTime.time,$scope.timeFormat).format("HH:mm:ss");return startTime};$scope.getEndTimeIn24hr=function(){var endTime=moment($scope.appointmentEndTime.time,$scope.timeFormat).format("HH:mm:ss");return endTime};$scope.getStartDateInYYYYMMDD=function(){var startDate=moment($scope.StDate,$scope.dateFormat).format("YYYY-MM-DD");return startDate};$scope.getStartDate=function(){return moment($scope.stDate)};$scope.getTodayDate=function(format){if(!newAppointmentFnNameSpace.checkIfEmpty(format)){return moment().format(format)}else{return moment()}};$scope.getUrlForConflictAppt=function(){var url=makeURL("/jsp/catalog/xml/block/IsTimeSlotBlockedBookedException.jsp");return url};$scope.getUrlForEncReferralAssociation=function(){var url=makeURL("/jsp/catalog/xml/saveEncIdwithRefId.jsp");return url};$scope.txtClass="txtBoxDefColor";$scope.getClassForBackColor=function(){return $scope.txtClass};$scope.$watch('patientDtls.patient.id',function(){if($scope.patientDtls.patient.id>0){$scope.bodyHeight.height='568px';$scope.approveHeight.height='568px';$scope.apptHeight.height='482px'}else{$scope.bodyHeight.height='568px';$scope.approveHeight.height='568px';$scope.apptHeight.height='503px'}if($scope.client=="MassMutual"){$scope.bodyHeight.height='595px';$scope.approveHeight.height='595px';$scope.apptHeight.height='508px'}});$scope.customerType="";$scope.status="";$scope.ptMatchLookupUrlAppt="";$scope.openPatientLookupModal=function(searchText){if(!newAppointmentFnNameSpace.checkIfEmpty($scope.referralId)&&!newAppointmentFnNameSpace.checkIfEmpty($scope.patientId)){ecwAlert("You cannot change patient once the referral is created for patient "+$scope.ptName+". If you really want to change patient create new appointment.",defaultAlertTitle);return false}if(searchText!==undefined){$scope.patientSearchData_patientLookup=searchText}var params={isReturnPtObject:true,showTopButtons:"1"};params=$.param(params);$ocLazyLoad.load({name:'PatientSearch',files:['/mobiledoc/jsp/webemr/toppanel/patientSearch/js/patientSearch.js']}).then(function(){var url='/mobiledoc/jsp/webemr/toppanel/patientSearch/patientSearch.jsp?'+params;$scope.ptMatchLookupUrlAppt=makeURL(url)},function(e){})};$scope.launchpt=function(searchText){$scope.openPatientLookupModal(searchText)};$scope.ptInfoInlineEdit={formattedAddress:'',ptTel:''};$scope.countryList=[];$scope.apptEditPtContactUrl='';$scope.openEditTelPopover=function(){var strUrl="/mobiledoc/jsp/webemr/scheduling/newApptPtContact.html";$ocLazyLoad.load({name:"newApptPtContactModule",files:["/mobiledoc/jsp/webemr/scheduling/js/newApptPtContactCtrl.js"]}).then(function(){$scope.apptEditPtContactUrl=makeURL(strUrl)},function(e){})};$scope.apptEditPtAddressUrl='';$scope.openEditAddressPopover=function(){var strUrl="/mobiledoc/jsp/webemr/scheduling/newApptPtAddress.html";$ocLazyLoad.load({name:"newApptPtAddressModule",files:["/mobiledoc/jsp/webemr/scheduling/js/newApptPtAddressCtrl.js"]}).then(function(){$scope.apptEditPtAddressUrl=makeURL(strUrl)},function(e){})};$scope.apptEditPtInsDtlsUrl='';$scope.InsHoverIn=function(e){var strUrl="/mobiledoc/jsp/webemr/scheduling/newApptPtInsurance.html";$scope.apptEditPtInsDtlsUrl=makeURL(strUrl);var position=$("#newApptController").offset();var positionLeft=position.left;var left=$(e.target).position().left-220;if(left<positionLeft){left=positionLeft+20}var top=$(e.target).position().top+20;$('.ptDemoInsInfo').css({"left":left,"top":top})};$scope.InsHoverOut=function(e){$('#apptEditPtInsDiv').removeClass('active');$scope.apptEditPtInsDtlsUrl=''};$scope.getPtAddressInfo=function(nPtId){var nClaimId=0;if($scope.encData.InvoiceId!==undefined){nClaimId=$scope.encData.InvoiceId}let strUrl=makeURL("/mobiledoc/emr/schedule/ptinfo/getPtAddrInfo");$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',data:$.param({caseId:$scope["case"],PtId:nPtId,EncId:$scope.encounterId,InvId:nClaimId,isEnableCaseManager:$scope.ikEnableCaseManager,encDate:$scope.getStartDateInYYYYMMDD()}),url:strUrl}).then(function(response){ptAddressUpdatorSuccessHandler(response,getPtCaseInsCallBk)},function(error){ecwAlert("Failed to log registration rules status",defaultAlertTitle)})};$scope.clearPatientData=function(){if($scope.enableWVIndicator){$scope.patientDtls.patient.id=0}};var getLastWCVAppointmentData=function(nPtId){$scope.lastWCVApptDetails=null;$scope.lastWCVHeader=null;let header;let content;let responsePromise=$http.get(makeURL("/mobiledoc/emr/appointmentwcv/getLastWCVAppointmentData?nPatientId="+nPtId));responsePromise.success(function(resp,status,headers,config){if(resp.status&&resp.status.toUpperCase()==="SUCCESS"){try{let dob;if($scope.ptDob&&moment($scope.ptDob,'DD MMM YYYY',true).isValid()){dob=moment($scope.ptDob,"DD MMM YYYY").format("MM/DD/YYYY")}else{dob=$scope.ptDob}let agelimit=_calculateAge(_toDate(dob))<=21;if(resp.result==='NoWVData'){if(agelimit){content='No Well-Child Visits Completed'}else{content='No AV Completed'}}else{content=angular.copy(resp.result)}$scope.lastWCVApptDetails=content;if(agelimit){header='Last WCV:'}else{header='Last AV:'}$scope.lastWCVHeader=header;$scope.wcvIndicator=angular.copy(resp.wcvIndicator)}catch(e){showMessage("An error occurred while parsing WCV data.")}}else{showMessage(resp.message)}})};var getPtAddressCallBk=function(data){if(data.AddressInfo!==undefined){var addressInfo=data.AddressInfo;$scope.ptInfoInlineEdit=angular.copy(addressInfo);$scope.ptInfoInlineEdit.formattedAddressTooltip=addressInfo.address+', '+addressInfo.address2+', '+addressInfo.city+', '+addressInfo.state+', '+addressInfo.county+', '+addressInfo.zipcode;var wLAddress=(addressInfo.address.match(/W|M/g)||[]).length;var wLAddress2=(addressInfo.address2.match(/W|M/g)||[]).length;var wLCity=(addressInfo.city.match(/W|M/g)||[]).length;var addressCharLength=20;var address2CharLength=13;var cityCharLength=10;if(wLAddress>5){addressCharLength=10}if(wLAddress2>5){address2CharLength=10}if(wLCity>5){cityCharLength=5}$scope.ptInfoInlineEdit.formattedAddress=$scope.trimStringToFixChar(addressInfo.address,addressCharLength)+', '+$scope.trimStringToFixChar(addressInfo.address2,address2CharLength)+', '+$scope.trimStringToFixChar(addressInfo.city,cityCharLength)+', '+addressInfo.state+', '+addressInfo.county+', '+addressInfo.zipcode;setPtPhoneLable()}if(data.InsInfo!==undefined){var insInfo=data.InsInfo;$scope.ptInfoInlineEdit.InsInfo=angular.copy(insInfo);$scope.ptInfoInlineEdit.InsType=data.InsType}};var getPtCaseInsCallBk=function(data){if(data.InsInfo!=undefined){var insInfo=data.InsInfo;$scope.ptInfoInlineEdit.InsInfo=angular.copy(insInfo);$scope.ptInfoInlineEdit.InsType=data.InsType;$scope.$apply()}};var setPtPhoneLable=function(){$scope.ptInfoInlineEdit.ptPhoneToShow='';$scope.ptInfoInlineEdit.ptPhoneIcon='icon ob-tel';if($scope.ptInfoInlineEdit.ptMobile!==''){$scope.ptInfoInlineEdit.ptPhoneToShow=angular.copy($scope.ptInfoInlineEdit.ptMobile);$scope.ptInfoInlineEdit.ptPhoneIcon='fa fa-mobile '}else if($scope.ptInfoInlineEdit.ptTel!==''){$scope.ptInfoInlineEdit.ptPhoneToShow=angular.copy($scope.ptInfoInlineEdit.ptTel)}else if($scope.ptInfoInlineEdit.ptMobile!==''){$scope.ptInfoInlineEdit.ptPhoneToShow=angular.copy($scope.ptInfoInlineEdit.employerPhone);$scope.ptInfoInlineEdit.ptPhoneIcon='fa fa-briefcase '}};$scope.trimInsNameToFixChar=function(strInsName){if(strInsName.length>0){var nInsNameTrimTo=10;if($scope.ptInfoInlineEdit.InsInfo[1]===undefined&&strInsName===$scope.ptInfoInlineEdit.InsInfo[0].InsName){nInsNameTrimTo=nInsNameTrimTo+10}if(!$scope.empiEnabled){nInsNameTrimTo=nInsNameTrimTo+10}if($scope.ptInfoInlineEdit.formattedAddress.length+12<=60){nInsNameTrimTo=nInsNameTrimTo+10}strInsName=$scope.trimStringToFixChar(strInsName,nInsNameTrimTo)}return strInsName};$scope.trimStringToFixChar=function(str,nStripto){if(str.length>0&&str.trim().length>nStripto){str=str.substr(0,nStripto-2);str=str+'...'}return str};var ptAddressUpdatorSuccessHandler=function(response,callBackFun){if(response.data!=undefined){try{var data=response.data;if(data.status!=undefined&&data.status==='success'){getPtAddressCallBk(data.Data)}else{ecwAlert(data.message,defaultAlertTitle)}}catch(err){}}};$scope.patientDtls={patient:{}};$scope.setPatientRecord=function(obj){$scope.ptMatchLookupUrlAppt="";$scope.selectPatient(obj)};$scope.selectPatient=function(obj){if(getItemKeyValue("EnableInactiveDeceasedAppts").toLowerCase()==="no"){if(obj.Deceased==="1"){ecwAlert("Cannot create an appointment for deceased patient.Please select other patient.",defaultAlertTitle);return false}if(obj.Status==="1"){ecwAlert("Cannot create an appointment for inactive patient.Please select other patient.",defaultAlertTitle);return false}}$scope.ptName=$scope.patientDtls.patient.name=obj.name;parentPtId=$scope.patientId=$scope.patientDtls.patient.id=obj.id;pid=$scope.patientDtls.patient.id;patientId=$scope.patientDtls.patient.id;patientName=$scope.ptName;$scope.patientDtls.patient.dob=obj.dob;if(typeof $scope.patientDtls.patient.dob!='undefined'&&$scope.patientDtls.patient.dob!=""&&$scope.patientDtls.patient.dob!=null&&$scope.patientDtls.patient.dob!='null'){$scope.ptDob=moment($scope.patientDtls.patient.dob,$scope.dateFormat).format("DD MMM YYYY")}$scope.ptTel=$scope.patientDtls.patient.upPhone=obj.upPhone;$scope.ptEmail=$scope.patientDtls.patient.Email=obj.Email;$scope.gender=$scope.patientDtls.patient.sex=obj.sex;$scope.address=$scope.patientDtls.patient.address=obj.address;$scope.isWebEnabled=$scope.patientDtls.patient.WebEnabled=obj.WebEnabled;$scope.patientDtls.patient.optout=obj.optout;$scope.getPtAddressInfo(patientId);if($scope.isWebEnabled=="1"){$scope.webEnblaeValue=true}else{$scope.webEnblaeValue=false}if($scope.ptEmail==""){$scope.txtClass="txtBoxColor"}else{$scope.txtClass="txtBoxDefColor"}if($scope.ikEnableWebPortal){if($scope.webEnblaeValue){$scope.picWeb=true;$scope.checkEmail=false}else{$scope.picWeb=true;$scope.checkEmail=true;if(!$scope.PermissionForWebPortal){$scope.checkEmail=false}else{if($scope.ikAutoEnablePortal&&$scope.ptEmail!==""&&$scope.validateEmail($scope.ptEmail)&&$scope.ptCheckOut==false&&$scope.patientDtls.patient.optout==0){$scope.chkEmailCb=true}}}}else{$scope.picWeb=false;$scope.checkEmail=false}if($scope.empiEnabled){$scope.getEhxStatus($scope.patientId)}var consentFormXml=urlGet(makeURL("/mobiledoc/jsp/catalog/xml/LoadPtConsentFormData.jsp?ptid="+$scope.patientId));if($(consentFormXml).find('status').text()=="success"){$scope.getConsentData(consentFormXml)}else{$scope.showConsentStatus=false}performAsyncAlertsCheck($scope.patientId);if($scope.ikSlidingFeeSchedule){$scope.CheckPatientsSlidingStatus()}var status=$scope.appointmentVisitType.Name+" ("+$scope.appointmentVisitType.Description+")";var consentFormXml=urlGet(makeURL("/mobiledoc/jsp/catalog/xml/isStructDataMandatory.jsp?ptId="+$scope.patientId+"&visitStatus="+status+"&encId="+$scope.encounterId));if(!newAppointmentFnNameSpace.checkIfEmpty(consentFormXml)&&(consentFormXml.trim().toLowerCase()=="y"||consentFormXml.trim().toLowerCase()=="M")){$scope.structVal=consentFormXml.trim().toLowerCase();$scope.stClass.color='#c96565'}if($scope.ikEnableCaseManager&&$scope.ikEnableAssociatePatientCasesAppt&&$scope.isNewEnc){$scope.getCasesForPatient()}$scope.getReferralDropDown();$scope.ptMatchLookupUrlAppt="";if($scope.enableWVIndicator){getLastWCVAppointmentData($scope.patientDtls.patient.id)}};$scope.patientSearchHistory=[];$scope.refreshSearchedPatients=function(){$scope.patientSearchHistory=getPatientSearchHistory()};$scope.refreshSearchedPatients();$scope.ptSearchHistoryClick=function(patientHistorySearch){var SearchBy="Name";var name="";var fname="";var lname="";if(patientHistorySearch.name){name=patientHistorySearch.name.split(",")}if(name.length>1){fname=name[1].trim();lname=name[0].trim()}else{fname=name[0].trim();lname=name[0].trim()}var param={ShowLastApptDate:1,counter:0,MAXCOUNT:1,SearchBy:SearchBy,SearchField:SearchBy,MyOrAllFacs:1,aptdropdown:1,aptRecentSearch:1,ptid:patientHistorySearch.id,firstName:fname,lastName:lname};var url=makeURL('/mobiledoc/jsp/catalog/xml/getPatients.jsp');ajaxCallByPost(url,param).success(function(data,status,headers,config){var values=[];var value=xml2json(data).Envelope.Body["return"].patient;if(value){if(value.length>0){values=value}else{values.push(value)}if(values.length>0){$scope.patientDtls=values[0];if($scope.patientDtls){$scope.patientDtls.patient={};angular.copy($scope.patientDtls,$scope.patientDtls.patient);$scope.mySelectPatient1()}}}})};$scope.mySelectPatient1=function(){if(getItemKeyValue("EnableInactiveDeceasedAppts").toLowerCase()==="no"){if($scope.patientDtls.patient.Deceased==="1"){ecwAlert("Cannot create an appointment for deceased patient.Please select other patient.",defaultAlertTitle);return false}if($scope.patientDtls.patient.Status==="1"){ecwAlert("Cannot create an appointment for inactive patient.Please select other patient.",defaultAlertTitle);return false}}$scope.ptName=$scope.patientDtls.patient.name;parentPtId=$scope.patientId=$scope.patientDtls.patient.id;pid=$scope.patientDtls.patient.id;patientId=$scope.patientDtls.patient.id;patientName=$scope.ptName;if(typeof $scope.patientDtls.patient.dob!='undefined'&&$scope.patientDtls.patient.dob!=""&&$scope.patientDtls.patient.dob!=null&&$scope.patientDtls.patient.dob!='null'){$scope.ptDob=moment($scope.patientDtls.patient.dob,$scope.dateFormat).format("DD MMM YYYY")}$scope.ptTel=$scope.patientDtls.patient.upPhone;$scope.ptEmail=$scope.patientDtls.patient.Email;$scope.gender=$scope.patientDtls.patient.sex;$scope.address=$scope.patientDtls.patient.address;$scope.isWebEnabled=$scope.patientDtls.patient.WebEnabled;$scope.getPtAddressInfo(patientId);if($scope.isWebEnabled=="1"){$scope.webEnblaeValue=true}else{$scope.webEnblaeValue=false}if($scope.ptEmail==""){$scope.txtClass="txtBoxColor"}else{$scope.txtClass="txtBoxDefColor"}if($scope.ikEnableWebPortal){if($scope.webEnblaeValue){$scope.picWeb=true;$scope.checkEmail=false}else{$scope.picWeb=true;$scope.checkEmail=true;if(!$scope.PermissionForWebPortal){$scope.checkEmail=false}else{if($scope.ikAutoEnablePortal&&$scope.ptEmail!==""&&$scope.validateEmail($scope.ptEmail)&&$scope.ptCheckOut==false){$scope.chkEmailCb=true}}}}else{$scope.picWeb=false;$scope.checkEmail=false}if($scope.empiEnabled){$scope.getEhxStatus($scope.patientId)}var consentFormXml=urlGet(makeURL("/mobiledoc/jsp/catalog/xml/LoadPtConsentFormData.jsp?ptid="+$scope.patientId));if($(consentFormXml).find('status').text()=="success"){$scope.getConsentData(consentFormXml)}else{$scope.showConsentStatus=false}performAsyncAlertsCheck($scope.patientId);if($scope.ikSlidingFeeSchedule){$scope.CheckPatientsSlidingStatus()}var status=$scope.appointmentVisitType.Name+" ("+$scope.appointmentVisitType.Description+")";var consentFormXml=urlGet(makeURL("/mobiledoc/jsp/catalog/xml/isStructDataMandatory.jsp?ptId="+$scope.patientId+"&visitStatus="+status+"&encId="+$scope.encounterId));if(!newAppointmentFnNameSpace.checkIfEmpty(consentFormXml)&&(consentFormXml.trim().toLowerCase()=="y"||consentFormXml.trim().toLowerCase()=="M")){$scope.structVal=consentFormXml.trim().toLowerCase();$scope.stClass.color='#c96565'}if($scope.ikEnableCaseManager&&$scope.ikEnableAssociatePatientCasesAppt&&$scope.isNewEnc){$scope.getCasesForPatient()}$scope.getReferralDropDown();if($scope.enableWVIndicator){getLastWCVAppointmentData($scope.patientDtls.patient.id)}};$scope.CheckPatientsSlidingStatus=function(){var slidingStatusFormXml=urlGet(makeURL("/mobiledoc/jsp/catalog/xml/edi/getSlidingFeeScheduleForPatient.jsp?PatientId="+$scope.patientId));$scope.checkSlidingStatus(slidingStatusFormXml)};$scope.facName="";$scope.timeZone="";$scope.onChangeFacility_NewAppt=function(){$scope.apptForm.$setDirty();$scope.timeZone="";$scope.facilityTimeZone="";$scope.facilityId=$scope.facility1.facility.Id;$scope.facilityName=$scope.facility1.facility.Name;$scope.facility1.facility.Name=$scope.facilityName=$scope.facility1.facility.Name;if($scope.facility1.facility.Code&&$scope.facility1.facility.Code!==""){$scope.facility1.facility.Name=$scope.facility1.facility.Code+":"+$scope.facility1.facility.Name}$scope.pos=$scope.facility1.facility.POS;if(!newAppointmentFnNameSpace.checkIfEmpty($scope.facility1.facility.TimeZone)){$scope.timeZone="("+$scope.facility1.facility.TimeZone+")"}if($scope.ikEnableUTCScheduling&&$scope.facility1.facility.TimeZoneCode!==""&&$scope.facilityName.includes($scope.facility1.facility.TimeZoneCode)){var removeTimeZoneContent=" "+$scope.facility1.facility.TimeZoneCode;$scope.facilityName=$scope.facilityName.replace(removeTimeZoneContent,"");$scope.facilityTimeZone=$scope.facility1.facility.TimeZoneCode}if($scope.ikenableFacilityAccess){$scope.providerForNewAppintment=[];$scope.inSearchMode=false;$scope.pageNo=0;$scope.getDoctorsDetailsWithPagination(false)}};$scope.mySelectFacilityClear=function(){$scope.facilityId="";$scope.facilityName=""};$scope.checkDeptFac=function(){var isValidDept=true;$.ajax({type:"POST",url:'/mobiledoc/jsp/catalog/xml/edi/checkDeptFac.jsp?DeptId='+$scope.deptId+'&FacilityId='+$scope.facilityId,"async":false,success:function(data){if(typeof data!='undefined'&&data!=""){try{var jsondata=xml2json(data).Envelope.Body["return"].FacCheck.CheckInfo;if(jsondata.validity=='invalid'){isValidDept=false}}catch(err){ecwAlert("Error while checking valid dept for facility",defaultAlertTitle)}}}});return isValidDept};$scope.getVTRuleUrl=function(){var url=makeURL('/jsp/catalog/xml/VisitTypeRulesForProvider.jsp');return url};$scope.getRecRulePrUrl=function(){var url=makeURL('/jsp/catalog/xml/getRecRulesForProvider.jsp');return url};$scope.getVTRecRuleUrl=function(){var url=makeURL('/jsp/catalog/xml/getVisitRulesForSet.jsp');return url};$scope.getTotalCountForVisitUrl=function(){var url=makeURL('/jsp/catalog/xml/getEncCountForVisitType.jsp');return url};$scope.getCourtDateUrl=function(){var url=makeURL('/jsp/catalog/xml/getPatientInfo.jsp');return url};$scope.getEncAssociationUrl=function(){var url=makeURL('/jsp/catalog/xml/getEncAssociation.jsp');return url};$scope.getFacilityExistUrl=function(){var url=makeURL('/jsp/catalog/xml/checkIfDefaultFacilityExists.jsp');return url};var getAppointmentLimitsUrl=function(){var url=makeURL('/jsp/webemr/menu/schedule/configureschedulingrules/schedulingRulesController.jsp');return url};$scope.checkForExhustedSlot=function(){var bThisSlotBooked=false;var bAllSlotsBooked=true;var bThisSlotRecBooked=false;var bAllSlotsRecBooked=true;var areAllSlotExhusted=false;var startTime=moment($scope.appointmentStartTime.time,$scope.timeFormat).format("HH:mm:ss");var endTime=moment($scope.appointmentEndTime.time,$scope.timeFormat).format("HH:mm:ss");var ruleStartTime="";var ruleEndTime="";var ruleVisitTypeDesc="";var apptVisitType=$scope.appointmentVisitType.Name+" ("+$scope.appointmentVisitType.Description+")";$($scope.jsonDataForVtRule).each(function(key,value){ruleStartTime=value.startTime;ruleEndTime=value.endTime;ruleVisitTypeDesc=value.VisitTypeDesc;if(value.totalVisits>0){if($.trim(startTime)===$.trim(ruleStartTime)&&$.trim(endTime)===$.trim(ruleEndTime)&&$.trim(apptVisitType)===$.trim(ruleVisitTypeDesc)){if(value.NumEnc>value.totalVisits){bThisSlotBooked=true}bAllSlotsBooked=bAllSlotsBooked&&bThisSlotBooked}}});if($scope.jsonDataForVtRecRule&&$scope.jsonDataForVtRecRule.length>0){$($scope.jsonDataForVtRecRule).each(function(key,value){ruleStartTime=value.startTime;ruleEndTime=value.endTime;ruleVisitTypeDesc=value.VisitTypeDesc;if(value.totalVisits>0){if($.trim(startTime)===$.trim(ruleStartTime)&&$.trim(endTime)===$.trim(ruleEndTime)&&$.trim(apptVisitType)===$.trim(ruleVisitTypeDesc)){if(value.NumEnc>value.totalVisits){bThisSlotRecBooked=true}bAllSlotsRecBooked=bAllSlotsRecBooked&&bThisSlotRecBooked}}})}else{bAllSlotsRecBooked=bAllSlotsRecBooked&&bThisSlotRecBooked}return bAllSlotsBooked||bAllSlotsRecBooked};$scope.checkForPregnancyVisit=function(){if($scope.gender=='male'&&$scope.appointmentVisitType.PregVisit=='1'){return true}else{return false}};$scope.CheckPaymentForEnc=function(encountrId){$.ajax({method:'POST',url:'/mobiledoc/jsp/catalog/xml/CheckPaymentsForEnc.jsp?encounterId='+encountrId,"async":false,success:function(data){var jsonData=xml2json(data).Envelope.Body["return"];$scope.paymentCount=jsonData.count}})};$scope.setVisitType=function(visitType){$scope.appointmentVisitType.Name=visitType};$scope.reasonChange=function(){$scope.apptForm.$setDirty();$scope.reasons=$scope.apptreasons=$scope.appointmentReason.name};$scope.timeLabelClicked=function(){if(isProviderScheduleVerticalBarsEnabled&&$scope.appointmentVisitType.DentalVisit==='1'){$ocLazyLoad.load({name:'dentalApptProviderResourceSlotsModule',files:['/mobiledoc/jsp/webemr/scheduling/css/jquery-ui-range-slider.css','/mobiledoc/jsp/webemr/scheduling/css/dental-scheduling-landing.css','/mobiledoc/jsp/webemr/scheduling/css/dental-slots.css','/mobiledoc/jsp/webemr/scheduling/js/dentalProviderResourceSlotModal.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/scheduling/dentalProviderResourceSlotModal.jsp");$scope.dentalProviderSlotsPopupUrl=url},function(e){ecwAlert("Error in opening Dental Provider/Assistant Time slot setup screen",defaultAlertTitle)})}};$scope.visitTypeChange=function(){$scope.checkForDentalVisit();$scope.enableUBData=false;$scope.appointmentStartTimeChange();if(isProviderScheduleVerticalBarsEnabled){if($scope.appointmentVisitType.DentalVisit=='1'){$('#newAppointmentTimeLbl').addClass('timeLink');$('.visibleDental').removeAttr('style');if($scope.previousVisitTypeName!=''){$scope.providerTimes='[]';$scope.resourceTimes='[]';$("#provider-slots").timeSlotPicker('clearSelection');$("#assistant-slots").timeSlotPicker('clearSelection');$("#chair-slots").timeSlotPicker('clearSelection')}}else{$scope.providerTimes='[]';$scope.resourceTimes='[]';$('#addExtraResource1').show();$('#deleteExtraResource1').show();$('#addExtraResource2').hide();$('#deleteExtraResource2').hide();$('#deleteExtraResource3').hide();$('.visibleDental').css('display','none');$('.visibleDental2').css('display','none');$('#newAppointmentTimeLbl').removeAttr('data-target','#modal-provider-assistance');$('#newAppointmentTimeLbl').removeAttr('data-toggle','modal');$('#newAppointmentTimeLbl').removeClass('timeLink')}}if($scope.appointmentVisitType.ReferralVisit=='1'&&$scope.encounterId<=0){$scope.refReq=true;$scope.loadRefPopup($scope.referralId,$scope.patientId,$scope.ptName,$scope.encounterId,"0","0")}else{$scope.refReq=false}if($scope.appointmentVisitType.enablecollectubclaimdata==='1'){$scope.enableUBData=true}$scope.checkForClaimAndCoPay();if($scope.isAppointmentModalShown){$scope.apptForm.$setDirty()}if(isProviderScheduleVerticalBarsEnabled){$scope.previousVisitTypeName=$scope.appointmentVisitType.Name}};$scope.whenAppointmentModalShown=function(){$scope.isAppointmentModalShown=true};$scope.readonlytxt=true;$scope.changeCoPay=function(){$scope.apptForm.$setDirty();if($scope.coPayCb){$scope.copayChanged=1;$scope.mCoPaytext="0.00";$scope.readonlytxt=false}else{$scope.mCoPaytext="";$scope.copayChanged=0;$scope.readonlytxt=true}};$scope.getLogXml=function(actionFlag){var currentdate=new Date;var action="Created";var currTime=currentdate.getHours()+":"+currentdate.getMinutes()+":"+currentdate.getSeconds();var currDate=currentdate.getFullYear()+"-"+(currentdate.getMonth()+1)+"-"+currentdate.getDate();if(actionFlag==1){action="Modified"}var xmlWriter=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xmlWriter);xmlWriter.writeStartElement('log');xmlWriter.writeAttributeString('xsi:type','xsd:string');addElement(xmlWriter,"date",currDate,'xsi:type','xsd:string');addElement(xmlWriter,"time",currTime,'xsi:type','xsd:string');addElement(xmlWriter,"userId",global.TrUserId,'xsi:type','xsd:string');addElement(xmlWriter,"action",action,'xsi:type','xsd:string');xmlWriter.writeEndElement();return xmlWriter.flush()};$scope.getLogUrl=function(){var url="/jsp/catalog/xml/setLogs.jsp";url=makeURL(url);return url};$scope.getDateInDbFormat=function(){var myDate="";if($scope.StDate!=""){var curDate=$scope.StDate.split("/");if(isVision){myDate=curDate[2]+"-"+curDate[1]+"-"+curDate[0]}else{myDate=curDate[2]+"-"+curDate[0]+"-"+curDate[1]}}return myDate};$scope.getEncLogsURl=function(){var url=makeURL('/jsp/catalog/xml/setEncLog.jsp');return url};$scope.getClinicalRuleEngineUrl=function(){var url="/jsp/clinicalrule_ccmr/processClinicalRuleEngine.jsp";url=makeURL(url);return url};$scope.getEncStatusCycleTimeUrl=function(){var url="/jsp/catalog/xml/getStatusCodeFromVisitStsCode.jsp";url=makeURL(url);return url};$scope.getPtProfileMeasureUrl=function(){var url="/jsp/registry/tcny/ProfileMeasuresForPatient.jsp";url=makeURL(url);return url};$scope.getCaseId=function(){var caseid="";if(typeof $scope.caseIdForPatient!='undefined'&&$scope.caseIdForPatient!=""){caseid=$scope.caseIdForPatient}return caseid};$scope.getClaimReq=function(){if($scope.isNonBillable){$scope.cliamReq=0}return $scope.cliamReq};$scope.getCopay=function(){var coPay="0.00";if(typeof $scope.mCoPaytext!='undefined'&&$scope.mCoPaytext!=""){coPay=$scope.mCoPaytext}return coPay};$scope.getVisitCoPayUrl=function(){var url="/jsp/catalog/xml/SetVisitCopay.jsp";url=makeURL(url);return url};$scope.getASAPListUrl=function(){var url="/jsp/webemr/scheduling/asapList/SetASAPDetails.jsp";url=makeURL(url);return url};$scope.getTransmitOrderXml=function(){var xmlWriter=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xmlWriter);addElement(xmlWriter,"encid",$scope.encounterId,'xsi:type','xsd:string');addElement(xmlWriter,"ptid",$scope.patientId,'xsi:type','xsd:string');return xmlWriter.flush()};$scope.getTransmitIndividualOrdersUrl=function(){var url='/jsp/catalog/xml/hl7/TransmitIndividualOrders.jsp';url=makeURL(url);return url};$scope.getBumpListUrl=function(){var url="/jsp/catalog/xml/updateBumpList.jsp";url=makeURL(url);return url};$scope.getUpdateNewEncLogUrl=function(){return makeURL("/jsp/empi/updateNewEncLog.jsp?encId="+$scope.encounterId+"&pid="+$scope.patientId)};$scope.browseCommonReasons=function(){$scope.actions.apptAction=2;$("#apptActionModalMainId").modal();$scope.searchKey={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:[],favorite:'',notes:$scope.reasons,macroAllowed:true};$scope.keywords.module='Reasons';$scope.keywords.maxcount='20';$scope.keywords.currentIndex='1';$scope.keywords.favorite='';if($scope.isFloatingToolbar){$timeout(function(){$("#keywords-tplList").css('height','360px');$('#keywordsTextArea').attr('style',function(i,s){return(s||'')+';height: 360px !important;'})},500)}};$scope.saveReason=function(){if($scope.isFloatingToolbar){disableBottomPanelButtonsForFloatingToolbar()}$scope.apptForm.$setDirty();$scope.reasons="";$scope.apptreasons="";$scope.appointmentReason.name=$scope.reasons=$scope.apptreasons=$scope.keywords.notes;$scope.searchKey={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:[],favorite:'',notes:''};$scope.actions.apptAction=1;$('#apptActionModalMainId').modal('hide')};$scope.cancelReason=function(){if($scope.isFloatingToolbar){disableBottomPanelButtonsForFloatingToolbar()}$scope.actions.apptAction=1;$('#apptActionModalMainId').modal('hide');removeAllCachedURL($scope.keywords.module);$scope.searchKey={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:[],favorite:'',notes:''}};$scope.cancelAppointment=function(){$scope.bumpAction=1};$scope.reasons="";$scope.diagnosis=[];$scope.ShowAppointment=function(){$scope.showReason=false};$scope.browseCommonDiagnosis=function(){$scope.actions.apptAction=3;$("#apptActionModalMainId").modal();$scope.temp=[];angular.forEach($scope.diagnosis,function(obj){$scope.temp.push(obj)});$scope.searchKey={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:angular.copy($scope.temp),favorite:'',notes:''};$scope.keywords.module='Appointment Dx';$scope.keywords.maxcount='20';$scope.keywords.currentIndex='1';$scope.keywords.favorite='N';var url="/mobiledoc/jsp/catalog/xml/getChildNodes2.jsp?keyName="+$scope.keywords.module+"&Options=1&SortBy=ItemName&itemName=&counter=1&MAXCOUNT="+$scope.keywords.maxcount;url=makeURL(url);var data=getCachedData(url,$scope.keywords.module);var x2js=new X2JS;var jsonData=x2js.xml_str2json(data);var value=jsonData.Envelope.Body['return'].item;if(value){if(value.length>0){$scope.keywords.items=value}else{$scope.keywords.items.push(value)}}if($scope.isFloatingToolbar){$timeout(function(){$("#keywords-tplList").css('height','360px');$("#keywords-tplGrid").css('height','360px')},500)}};$scope.saveDiagnosis=function(){if($scope.isFloatingToolbar){disableBottomPanelButtonsForFloatingToolbar()}$scope.apptForm.$setDirty();$scope.diagnosis=[];$scope.apptDiagnosis=[];angular.forEach($scope.keywords.selectedItems,function(obj){if(obj.notes==""){$scope.apptDiagnosis.push(obj.name);obj.notes=obj.name;$scope.diagnosis.push(obj)}else{$scope.diagnosis.push(obj);$scope.apptDiagnosis.push(obj.notes)}});$scope.searchKey={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:[],favorite:'',notes:''};$scope.actions.apptAction=1;$("#apptActionModalMainId").modal('hide')};$scope.initProperties=function(){if(parentForm==="ResSchedule"||parentForm==="trackingBoard"||parentForm==="MultipleAppt"||parentForm==="MultipleApptModern"){document.getElementById("dvApptLoader").style.display="none"}if(parentForm==="FamilyBooking"){$scope.isDisabled=true}if(parentForm==="patientHub"){$scope.isDisabled=true;$scope.fromHub=true}if(parentForm==='wellChildVisit'){$scope.isDisabled=true;$scope.fromWellVisit=true}if($scope.isFloatingToolbar){$scope.isDisabled=true}if(parentForm==='HI_GIC_WORKLIST'||parentForm==='HI_PDX_WORKLIST'){$scope.isDisabled=true}$scope.reasons="";$scope.isNewEnc=true;$scope.showNextApt=false;$scope.reservedSlotId=reservedSlotId;$scope.disableLog=true;$scope.disableOrders=true;$scope.showRightChartPanelHeading=true;$scope.setAppointmentResource(id);$scope.setPatient();if("MultipleApptModern"===parentForm&&$scope.bCentralizedSchedulingEnabled){$scope.isAfterAlertCheck=true;$scope.iHubConsentIconShow=true}else{performAsyncAlertsCheck($scope.patientId)}if(block_id>0){$scope.launchPtLookup(block_id)}$scope.setFacility();if(parentForm=="trackingBoard"){$scope.setVisitStatus("ARR");$scope.setGeneralNotes(description)}else{$scope.setVisitStatus("PEN")}if(typeof visitType!='undefined'&&visitType!=""){$scope.nonBillableVisitTypeCheck=false;$scope.visitTypeOverriden=visitType;$scope.setVisitType(visitType)}if($scope.empiEnabled){if($scope.patientId>0){var promiseEhxData=getPromiseForPtEhxData($scope.patientId,global.TrUserId,'all',"appt");promiseEhxData.then(function(ehxData){$scope.empiColorIconClass=ehxData.empiIconClass;$scope.empiPtHasNew=ehxData.newDataEhx;if($scope.$$phase!='$apply'&&$scope.$$phase!='$digest'){$scope.$apply()}},function(errorMsg){ecwAlert("req getPromiseForPtEhxData rejected from init() in new appt",defaultAlertTitle)})}}$timeout(function(){$scope.modalclose=false;if($scope.panelStatus==="0"){$('.eprescribeact').addClass('active')}openModal();$scope.setAppointmentTime();try{$scope.apptForm.$setPristine()}catch(error){ecwAlert("form not loaded",defaultAlertTitle)}},1e3);if($scope.ikEnableWebPortal){if($scope.webEnblaeValue){$scope.picWeb=true;$scope.checkEmail=false}else{$scope.picWeb=true;$scope.checkEmail=true;if(!$scope.PermissionForWebPortal){$scope.checkEmail=false}else{if($scope.ikAutoEnablePortal&&$scope.ptEmail!==""&&$scope.validateEmail($scope.ptEmail)&&$scope.ptCheckOut==false&&$scope.patientDtls.patient.optout==0){$scope.chkEmailCb=true}}}}else{$scope.picWeb=false;$scope.checkEmail=false}$scope.isVisitStatusChanged=false;if(appointmentScopeGlobalVariables.reasons)$scope.appointmentReason.name=$scope.reasons=$scope.apptreasons=appointmentScopeGlobalVariables.reasons;if($scope.enableWVIndicator&&$scope.patientId>0){getLastWCVAppointmentData($scope.patientId)}if($scope.fromHub===true){if($scope.ikEnableCaseManager&&$scope.ikEnableAssociatePatientCasesAppt&&$scope.isNewEnc&&!isNaN($scope.patientId)&&Number($scope.patientId)>0){$scope.getCasesForPatient()}}};$scope.setAppointmentTime=function(){$scope.StDate=date;if(startTime&&typeof startTime!="undefined"&&startTime!=""){$scope.appointmentStartTime.time=startTime}if(endTime&&typeof endTime!="undefined"&&endTime!=""){$scope.appointmentEndTime.time=endTime}if(isEndTimeReqForFirstLoad){isEndTimeReqForFirstLoad=false;$timeout(function(){$scope.appointmentStartTimeChange()})}};$scope.setAppointmentResource=function(resourceId){if(typeof resourceId!='undefined'&&resourceId!=""){$scope.appointmentResource.id=resourceId}else{$scope.appointmentResource.id=global.TrUserId}};$scope.refreshPatientDetail=function(){$scope.iHubConsentIconShow=false;$timeout(function(){$scope.iHubConsentIconShow=true},1e3);var objPatient;var url=makeURL("/mobiledoc/jsp/catalog/xml/getPatientInfo.jsp");$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',data:$.param({patientId:$scope.patientId}),url:url}).then(function(response){objPatient=xml2json(response.data).Envelope.Body["return"].patient;ptObj=JSON.stringify(objPatient);$scope.setPatient()},function(error){ecwAlert("Failed to log registration rules status",defaultAlertTitle)});$scope.checkEligibilityCompare()};$scope.setPatient=function(){if(typeof patientId=='undefined'||patientId==""||patientId=="0"){if(typeof pid=='undefined'||pid==""||pid=="0"){patientId="";patientName=""}else{patientId=pid}}var patientObj={};if(!newAppointmentFnNameSpace.checkIfEmpty(ptObj)){patientObj=JSON.parse(ptObj)}$scope.patientDtls={patient:{}};let ptNameFromObj="";if(patientId>0&&patientObj&&!jQuery.isEmptyObject(patientObj)){ptNameFromObj=patientObj.name;$scope.ptTel=$scope.patientDtls.patient.upPhone=patientObj.phone;$scope.ptEmail=$scope.patientDtls.patient.Email=patientObj.email;$scope.address=$scope.patientDtls.patient.address=patientObj.address;$scope.ptDob=$scope.patientDtls.patient.ptDob=patientObj.dob;$scope.isWebEnabled=$scope.patientDtls.patient.WebEnabled=patientObj.webenabled;if($scope.isWebEnabled=="1"){$scope.webEnblaeValue=true}else{$scope.webEnblaeValue=false}$scope.patientDtls.patient.optout=patientObj.optout;$scope.gender=patientObj.gender;$scope.setWebEnableValue();if(patientObj.namewithsuffix&&patientObj.namewithsuffix!=""){patientName=patientObj.namewithsuffix}$scope.getPtAddressInfo(patientId)}parentPtId=$scope.patientDtls.patient.id=$scope.patientId=patientId;try{if(ptNameFromObj!==undefined&&ptNameFromObj.length>0){$scope.ptName=$scope.patientDtls.patient.name=ptNameFromObj}else{$scope.ptName=$scope.patientDtls.patient.name=patientName}}catch(e){$scope.ptName=$scope.patientDtls.patient.name=patientName}};$scope.getValForPtId=function(){if($scope.patientDtls.patient.id>0){return true}else{return false}};$scope.setFacility=function(){$scope.facility1={facility:{}};if($scope.ikenableFacilityAccess&&isFacilityAccess=="false"){$scope.facilityId=$scope.facility1.facility.Id="";$scope.facilityName=$scope.facility1.facility.Name="";$scope.pos=""}else{if((typeof schFacilityId=="undefined"||schFacilityId=="0"||schFacilityId=="")&&$scope.facilityData){$scope.facilityId=$scope.facility1.facility.Id=faciltyId;if(typeof $scope.facilityData!="undefined"&&$scope.facilityData!=""&&$scope.facilityData.length>0){$scope.facilityName=$scope.facilityData[0].Name;$scope.facility1.facility.Name=$scope.facilityData[0].Name;if($scope.facilityData[0].code&&$scope.facilityData[0].code!==""){$scope.facility1.facility.Name=$scope.facilityData[0].code+":"+$scope.facilityData[0].Name}if($scope.ikEnableUTCScheduling&&$scope.facilityData[0].facilityTimeZoneCode&&$scope.facilityData[0].facilityTimeZoneCode!==""){$scope.facility1.facility.Name=$scope.facility1.facility.Name+" ("+$scope.facilityData[0].facilityTimeZoneCode+")";$scope.facilityTimeZone=$scope.facilityData[0].facilityTimeZoneCode}$scope.pos=$scope.facilityData[0].POS}}else{$scope.facilityId=$scope.facility1.facility.Id=schFacilityId;$scope.facilityName=$scope.facility1.facility.Name=schFacilityName;if($scope.ikEnableUTCScheduling&&schFacilityTimeZone&&schFacilityTimeZone!==""){$scope.facility1.facility.Name=$scope.facility1.facility.Name+" ("+schFacilityTimeZone+")";$scope.facilityTimeZone=schFacilityTimeZone}$scope.pos=POS}}};$scope.onBlurEmail=function(){if($scope.ikAutoEnablePortal&&$scope.ptEmail!==""&&$scope.validateEmail($scope.ptEmail)&&$scope.ptCheckOut==false&&$scope.patientDtls.patient.optout==0){$scope.chkEmailCb=true}};$scope.showNextApt=false;$scope.isEncounterLocked=false;$scope.isNewEnc=true;$scope.cusomerInfo={};$scope.isAA=false;$scope.isMosd=false;$scope.selectedCase="";$scope.showClaimNotePic=false;$scope.showAddlBillingDataNote=false;$scope.checkEmail=false;$scope.chkEmailCb=false;$scope.changeVisitFromEnc=false;$scope.doNotSetProvForRes=false;$scope.ikEnableConcurLockForAppt=false;if(getItemKeyValue("EnableConcurLockForAppt").toLowerCase()=="yes"){$scope.ikEnableConcurLockForAppt=true}$scope.appointment_end_time="";$scope.initEncounterData=function(eventData){if($scope.ikEnableConcurLockForAppt){apptLockObj.uniqueKey="frmNewAppt"+eventData.encounterId;acquireFormLock(apptLockObj,acquireFormLockCallBack)}$scope.isScreenEdited=true;if($scope.ikenableHumanaChanges){$scope.transPortationRequired=transportationStatus}$scope.changeVisitFromEnc=true;if(parentForm=="ResSchedule"||parentForm=="trackingBoard"){document.getElementById("dvApptLoader").style.display="none"}try{$scope.patientId=eventData.patientId;performAsyncAlertsCheck($scope.patientId);if(!newAppointmentFnNameSpace.checkIfEmpty(eventData.practiceId)){$scope.practiceId=eventData.practiceId}else{$scope.practiceId=0}$scope.practiceId=eventData.practiceId;$scope.arriveTime=eventData.arrivedTime;$scope.depTime=eventData.depTime;$scope.patientNextAppointMent=xml2json(nextApptDetails).Envelope.Body["return"].encounter;$scope.isNewEnc=false;$scope.showRightChartPanelHeading=false;var setEncounterFacility=function(){$scope.facility1={facility:{}};$scope.facilityId=$scope.facility1.facility.Id=eventData.facilityId;$scope.facility1.facility.Name=eventData.facilityName;if(eventData.facilityCode&&eventData.facilityCode!==""){$scope.facility1.facility.Name=eventData.facilityCode+":"+eventData.facilityName}if($scope.ikEnableUTCScheduling&&eventData.facilityTimeZoneCode&&eventData.facilityTimeZoneCode!==""){$scope.facility1.facility.Name=$scope.facility1.facility.Name+" ("+eventData.facilityTimeZoneCode+")";$scope.facilityTimeZone=eventData.facilityTimeZoneCode}$scope.facilityName=eventData.facilityName;$scope.pos=eventData.POS};if(parentForm&&parentForm=='bumpList'){$scope.setAppointmentTime();$scope.setAppointmentResource(id);if(!schFacilityId||schFacilityId==0){setEncounterFacility()}else{$scope.setFacility()}}else if(parentForm&&parentForm=='noShow'){$scope.setAppointmentTime();$scope.setAppointmentResource(id);if(!schFacilityId||schFacilityId==0){setEncounterFacility()}else{$scope.setFacility()}}else{$scope.StDate=moment(eventData.date).format($scope.dateFormat);$scope.appointmentStartTime.time=moment(eventData.time,'HH:mm:ss').format($scope.timeFormat);$scope.appointment_end_time=eventData.endTime;$scope.appointmentEndTime.time=moment(eventData.endTime,'HH:mm:ss').format($scope.timeFormat);$scope.setAppointmentResource(eventData.ResourceId);$scope.doNotSetProvForRes=true;$timeout(function(){backupProviderName=$scope.appointmentProvider.providerName=doctorName;$scope.appointmentProvider.sex=doctorSex;$scope.appointmentProvider.languages=doctorLang;backupProviderId=$scope.appointmentProvider.providerId=eventData.doctorid},1e3);setEncounterFacility();$scope.currentEncStartTime=$scope.appointmentStartTime.time;$scope.currentEncEndTime=$scope.appointmentEndTime.time;$scope.currentEncVisitType=eventData.visitType;$scope.currentEncResourceId=eventData.ResourceId;$scope.currentEncFacilityId=$scope.facilityId;$scope.currentEncDate=$scope.StDate;preserveValueThatConflict.startTime=$scope.currentEncStartTime;preserveValueThatConflict.endTime=$scope.currentEncEndTime;preserveValueThatConflict.resourceId=$scope.currentEncResourceId;preserveValueThatConflict.date=$scope.StDate}$scope.setVisitSubTypeId(eventData.visitSubTypeId);preserveValueThatConflict.visitSubTypeId=eventData.visitSubTypeId;$scope.setVisitType(parentForm&&parentForm=='bumpList'?visitType:eventData.visitType);$scope.refproviderName={provider:{}};$scope.refProviderName=$scope.refproviderName.provider.Name=eventData.refPrName;$scope.refProviderId=$scope.refproviderName.provider.Id=eventData.refPrId;if(eventData.groupId==""||eventData.groupId==null||typeof eventData.groupId=='undefined'){$scope.isGroup=false}else{$scope.isGroup=true}$scope.nonBillableVisitTypeCheck=false;$scope.appointmentVisitStatus.code=eventData.status;$scope.appointmentSelectedVisitStatus=eventData.status;if(getItemKeyValue('HCLChanges').toLowerCase()=='yes'&&eventData.status=='CANC'){$scope.showCancellationReason=true;if(cancellationReason!=null||cancellationReason!=""){$scope.cancellationReason=cancellationReason}else{$scope.cancellationReason=cancellationReason}}if(!newAppointmentFnNameSpace.checkIfEmpty(eventData.encounterId)){if(eventData.newPt=="0"){$scope.isNewPt=false}else{$scope.isNewPt=true}$scope.transitionOfCare=eventData.transitionofcare;$scope.patientDtls={patient:{}};parentPtId=$scope.patientDtls.patient.id=$scope.patientId=eventData.patientId;$scope.ptName=$scope.patientDtls.patient.name=eventData.name;$scope.ptDob=moment(eventData.dob,$scope.dateFormat).format("DD MMM YYYY");$scope.ptTel=$scope.patientDtls.patient.upPhone=eventData.upPhone;$scope.ptEmail=$scope.patientDtls.patient.Email=eventData.uemail;$scope.patientDtls.patient.optout=eventData.optout;if(eventData.WebEnabled=="1"){$scope.webEnblaeValue=true}else{$scope.webEnblaeValue=false}if($scope.ptEmail==""){$scope.txtClass="txtBoxColor"}else{$scope.txtClass="txtBoxDefColor"}$scope.setWebEnableValue();$scope.encounterId=eventData.encounterId;$scope.disableLog=false;$scope.disableOrders=false;if(!newAppointmentFnNameSpace.checkIfEmpty(strXmlForAnnualNotes)){var jsonData=xml2json(strXmlForAnnualNotes).Envelope.Body["return"].item;if(jsonData){$scope.billingNotes=jsonData.notes;$scope.oldBillingNote=angular.copy(jsonData.notes)}}if($scope.encData.ClaimReq=="0"){$scope.isNonBillable=true}else{$scope.isNonBillable=false}if($scope.encData.CopayChanged=="1"){$scope.coPayCb=true}else{$scope.coPayCb=false}if($scope.coPayCb){$scope.readonlytxt=false;$scope.copayChanged=1;$scope.mCoPaytext=$scope.encData.VisitCopay}else{$scope.readonlytxt=true;$scope.copayChanged=0;$scope.mCoPaytext=""}if(!newAppointmentFnNameSpace.checkIfEmpty(jsonCaseManager)){if(typeof jsonCaseManager.CaseId!=='undefined'&&typeof jsonCaseManager.CaseName!=='undefined'){$('#caseCombo').val(jsonCaseManager.CaseName);$scope.caseIdForPatient=$scope["case"]=jsonCaseManager.CaseId.toString()===""?"0":jsonCaseManager.CaseId.toString();if($scope.caseIdForPatient>0){$scope.EditCase=true}}}if(!newAppointmentFnNameSpace.checkIfEmpty(eventData.generalNotes)){$scope.generalNotes=eventData.generalNotes}else{$scope.generalNotes=""}if(!newAppointmentFnNameSpace.checkIfEmpty(eventData.reason)){$scope.apptreasons=eventData.reason;$scope.appointmentReason.name=$scope.reasons=eventData.reason}else{$scope.apptreasons="";$scope.reasons=""}if(!newAppointmentFnNameSpace.checkIfEmpty(eventData.Dx)){$scope.apptDiagnosis=eventData.Dx;var dxArr=eventData.Dx.split(",");$scope.diagnosis=dxArray}else{$scope.apptDiagnosis=""}}else{$scope.disableLog=true;$scope.disableOrders=true}if($scope.ikRecordPatientWaitTime){$scope.waitTime=eventData.waitTime}if($scope.patientNextAppointMent!=""&&$scope.patientNextAppointMent!=null&&typeof $scope.patientNextAppointMent!='undefined'){$scope.nextAppt=$scope.patientNextAppointMent.NextAppt;if(typeof $scope.nextAppt!='undefined'&&$scope.nextAppt!=""){$scope.showNextApt=true;$scope.nextApptLabel=$scope.nextAppt.split(",")}$scope.nextApptReason=$scope.patientNextAppointMent.NextApptReason}else{$scope.showNextApt=false}if(eventData.encLock=="1"){$scope.isEncounterLocked=true}else{$scope.isEncounterLocked=false}if($scope.claimEncId==$scope.encounterId){$scope.showClaimNotePic=true}else{$scope.showClaimNotePic=false}if($scope.client==="MassMutual"){if($scope.occFlag=="1"&&$scope.emgFlag=="1"){$scope.visitSubType=0}else if($scope.occFlag=="0"&&$scope.emgFlag=="1"){$scope.visitSubType=1}else if($scope.occFlag=="1"&&$scope.emgFlag=="0"){$scope.visitSubType=2}else if($scope.occFlag=="0"&&$scope.emgFlag=="0"){$scope.visitSubType=3}}if($scope.ikEnableApptRightPanel&&$scope.panelStatus==="1"){$scope.panelUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId='+$scope.encounterId+'&PtId='+$scope.patientId+'&facilityId='+$scope.facilityId+'&RxCheck=Nothing&sessionDID=0&ecwappprocessid=281&date='+(new Date).getTime())}else{$('.newApptDiv').removeAttr('id')}if($scope.ikEnableDepartments){$scope.deptId=eventData.DeptId;$scope.deptName=eventData.DeptName}$scope.visitNo=eventData.hl7Id;$scope.isDisabled=true;if(!(typeof $scope.caseDetails!='undefined'&&$scope.caseDetails.length>0)){$scope.disableCase=true;$scope.EnableCaseManger=false}else{$scope.caseButton={'background-color':'#F6F088'};$scope.EnableCaseManger=true}if($scope.empiEnabled){$scope.getEhxStatus($scope.patientId)}var strContentData=$.trim(strXmlForPager);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;try{var jsond=x2js.xml_str2json(strContentData);$scope.pagerStatus=jsond.Envelope.Body['return'].items.item.pager_status}catch(err){}}$timeout(function(){$scope.modalclose=false;if($scope.panelStatus==="0"){$('.eprescribeact').addClass('active')}openModal();try{$scope.apptForm.$setPristine()}catch(error){ecwAlert("could not set pristine. form not loaded.",defaultAlertTitle)}},1e3);$scope.isVisitStatusChanged=false;if(isTrackingBoardEnable&&$scope.ikEncStatusCycleTime&&$scope.encounterId!=0&&parentForm!="trackingBoard"){var param={encounterId:$scope.encounterId,status:$scope.appointmentVisitStatus.code,filter:"cycleTime"};var url=makeURL('/mobiledoc/jsp/webemr/scheduling/trackingBoard/getDataForAlert.jsp');ajaxCallByPost(url,param).success(function(data,status,headers,config){if(data!=null&&data.trim()!="undefined"&&data.trim()!="null"){var cycleTimeObj=JSON.parse(data.trim());$scope.prevCycleTime=cycleTimeObj.cycleTime}})}if(isProviderScheduleVerticalBarsEnabled){$scope.setProviderSlots()}if($scope.enableWVIndicator){getLastWCVAppointmentData($scope.patientDtls.patient.id)}$scope.getPtAddressInfo($scope.patientId)}catch(ex){ecwAlert("Appointment","Error in getting appointment information")}};function acquireFormLockCallBack(){if(apptLockObj.g_cancel){$scope.closeApptpopUp();$('#billingalert').modal('hide');return}}$scope.setWebEnableValue=function(){if($scope.ikEnableWebPortal){if($scope.webEnblaeValue){$scope.picWeb=true;$scope.checkEmail=false}else{$scope.picWeb=true;$scope.checkEmail=true;if(!$scope.PermissionForWebPortal){$scope.checkEmail=false}else{if($scope.ikAutoEnablePortal&&$scope.ptEmail!==""&&$scope.validateEmail($scope.ptEmail)&&$scope.ptCheckOut==false&&$scope.patientDtls.patient.optout==0){$scope.chkEmailCb=true}}}}else{$scope.picWeb=false;$scope.checkEmail=false}};function calendarClickHandler(){$(this).parent().parent().find('input[type="text"]').datepicker("show")}$(".icon-inputcalender").on('click',calendarClickHandler);$scope.getClassForEmail=function(){if($scope.ikEnableWebPortal){return'col-sm-7'}else{return'col-sm-9'}};$scope.BackToAppointment=function(){$scope.action.apptAction=1};$scope.setProviderName=function(providerId){angular.forEach($scope.providerForNewAppintment,function(rsObj,key){if(rsObj.id==providerId){backupProviderName=$scope.appointmentProvider.providerName=rsObj.fullname}})};$scope.BackToAppointment=function(){$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1};$scope.showLogs=function(){if(!$scope.viewLogsPermission){ecwAlert("You don't have permission to View Logs.",defaultAlertTitle);return}var strUrl="/mobiledoc/jsp/webemr/scheduling/newApptLogs.jsp?encId="+$scope.encounterId;$ocLazyLoad.load({name:'apptLogsModule',files:['/mobiledoc/jsp/webemr/scheduling/js/apptLogsController.js']}).then(function(){$scope.apptLogsUrl=makeURL(strUrl);$scope.actions.apptAction=4;$("#apptActionModalMainId").modal()},function(e){})};$scope.browseBillingNotes=function(){$scope.actions.apptAction=5;$("#apptActionModalMainId").modal();$scope.temp=[];$scope.searchKey={value:''};$scope.selectedNotes={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:[],favorite:'',notes:angular.copy($scope.billingNotes)};$scope.keywords.module='BillingNotes';$scope.keywords.maxcount='20';$scope.keywords.currentIndex='1';$scope.keywords.favorite='N';var url="/mobiledoc/jsp/catalog/xml/getChildNodes2.jsp?keyName="+$scope.keywords.module+"&Options=1&SortBy=ItemName&itemName=&counter=1&MAXCOUNT="+$scope.keywords.maxcount;url=makeURL(url);var data=getCachedData(url,$scope.keywords.module);var x2js=new X2JS;var jsonData=x2js.xml_str2json(data);var value=jsonData.Envelope.Body['return'].item;if(value){if(value.length>0){$scope.keywords.items=value}else{$scope.keywords.items.push(value)}}};$scope.browseGeneralNotes=function(){$scope.actions.apptAction=6;$("#apptActionModalMainId").modal();$scope.temp=[];$scope.searchKey={value:''};$scope.selectedNotes={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:[],favorite:'',notes:angular.copy($scope.generalNotes),macroAllowed:true};$scope.keywords.module='GeneralNotes';$scope.keywords.maxcount='20';$scope.keywords.currentIndex='1';$scope.keywords.favorite='N';var url="/mobiledoc/jsp/catalog/xml/getChildNodes2.jsp?keyName="+$scope.keywords.module+"&Options=1&SortBy=ItemName&itemName=&counter=1&MAXCOUNT="+$scope.keywords.maxcount;url=makeURL(url);var data=getCachedData(url,$scope.keywords.module);var x2js=new X2JS;var jsonData=x2js.xml_str2json(data);var value=jsonData.Envelope.Body['return'].item;if(value){if(value.length>0){$scope.keywords.items=value}else{$scope.keywords.items.push(value)}}};$scope.cancelGeneralNotes=function(){$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1;removeAllCachedURL($scope.keywords.module);$scope.searchKey={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:[],favorite:'',notes:''}};$scope.saveGeneralNotes=function(){$scope.apptForm.$setDirty();$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1;$scope.generalNotes=$scope.keywords.notes};$scope.cancelNotes=function(){$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1;removeAllCachedURL($scope.keywords.module);$scope.searchKey={value:''};$scope.keywords={items:[],module:'',maxcount:'',selectedItems:[],favorite:'',notes:''}};$scope.closeApptDetailLogModal=function(){$scope.AppointmentDetailLogs=""};$scope.showDetailLogs=function(){var strUrl=makeURL("/mobiledoc/jsp/webemr/scheduling/AppointmentLogs.jsp?encId="+$scope.encounterId);$ocLazyLoad.load({name:'AppointmentDetailsLogModule',files:['/mobiledoc/jsp/webemr/scheduling/js/AppointmentLogsController.js']}).then(function(){$scope.AppointmentDetailLogs=strUrl},function(e){})};$scope.saveNotes=function(){$scope.apptForm.$setDirty();$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1;$scope.billingNotes=$scope.keywords.notes};$scope.browseDepartments=function(){$scope.paramApptDepartmentPath=makeURL("/mobiledoc/jsp/webemr/webpm/getDepartments.jsp?FacilityId="+$scope.facilityId)};$scope.sendDepartmentToClaimController=function(departmentLst){if(departmentLst!=undefined){$scope.deptId=departmentLst.DeptId;$scope.deptName=departmentLst.DeptName}};var backupProviderName="";var backupProviderId="";$scope.onClickVt=function(){$('#visitTypeCombo').focus()};$scope.onClickVs=function(){$('#visitStsCombo').focus()};$scope.onClickPr=function(){$("#infoIconDiv").css("border-color","#66afe9");$scope.appointmentProvider.providerName="";$('.provider-appt-lookup-div').find('#provider').focus();$scope.loadInitialProvider()};$scope.onClickRes=function(){$('#resource').focus()};$scope.keywordFocus=function(val,val2){$scope.onClickPr()};$scope.isOpen=function(val){if(val=='4'){return $scope.showProviderDropdown}};$scope.setProviderNameAndId=function(name,id){backupProviderName=$scope.appointmentProvider.providerName=name;backupProviderId=$scope.appointmentProvider.providerId=id};$scope.setProviderDetails=function(){$scope.appointmentProvider.sex=$scope.appointmentResource.sex;$scope.appointmentProvider.languages=$scope.appointmentResource.languages};$scope.changeResource=function(){$scope.apptForm.$setDirty();if($scope.appointmentResource.resourceType=="2"||$scope.appointmentResource.resourceType=="9"){$scope.isProviderSchedule=false;if(!$scope.appointmentResource.resourceDefApptProvider=="0"){$scope.setProviderNameAndId($scope.appointmentResource.resourceDefApptProviderName,$scope.appointmentResource.resourceDefApptProvider)}else{$scope.setProviderNameAndId("",0)}}else{$scope.isProviderSchedule=true;$scope.setProviderNameAndId($scope.appointmentResource.resourceName,$scope.appointmentResource.id);$scope.setProviderDetails()}};$scope.refReq=false;$scope.onItemClick=function(val,obj){$scope.apptForm.$setDirty();if(val=='4'){if($scope.ikenableFacilityAccess){backupProviderName=$scope.appointmentProvider.providerName=obj.resourceName}else{backupProviderName=$scope.appointmentProvider.providerName=obj.fullname;$scope.appointmentProvider.sex=obj.sex;$scope.appointmentProvider.languages=obj.languages}backupProviderId=$scope.appointmentProvider.providerId=obj.id;$scope.showProviderDropdown=false;$scope.providerSelected=true}};$scope.onMouseOut=function(val){if($scope.mousedown){$scope.mousedown=false}else{if(val=='4'){if(backupProviderName==""){$scope.appointmentProvider.providerId="";$scope.appointmentProvider.providerName="";$scope.providerSelected=false}else{$scope.appointmentProvider.providerName=backupProviderName;$scope.appointmentProvider.providerId=backupProviderId;$scope.providerSelected=true}$scope.showProviderDropdown=false}}$("#infoIconDiv").css("border-color","#ccc")};$scope.visibleInfoIcon=function(i){$("#infoIconApp"+i).css("visibility","visible");$("#a-span-providerinfo"+i).addClass("a-span-providerinfo")};$scope.hideInfoIcon=function(i){$("#infoIconApp"+i).css("visibility","hidden");$("#a-span-providerinfo"+i).removeClass("a-span-providerinfo")};$scope.visibleInfoIconInput=function(){if($('#newAppointmentUl2').is(":visible")){$("#infoIcon").css("visibility","hidden")}else{$("#infoIcon").css("visibility","visible");$("#infoIconDiv").css("border-color","#ccc")}};$scope.hideInfoIconInput=function(){$("#infoIcon").css("visibility","hidden");if($('#newAppointmentUl2').is(":visible")){$("#infoIconDiv").css("border-color","#66afe9")}else{$("#infoIconDiv").css("border-color","#ccc")}};$scope.mouseDown=function(){$scope.mousedown=true};$scope.onKeyPress=function(val){if(val=='4'){$scope.providerSelected=false;$("#infoIconDiv").css("border-color","#66afe9")}};$scope.onKeyup=function(val,e){length=$scope.appointmentProvider.providerName.length;$scope.inSearchMode=false;if(val=='4'&&(e.keyCode!='38'&&e.keyCode!='40')){$("#infoIconDiv").css("border-color","#66afe9");if(length>='2'){$scope.inSearchMode=true;$scope.ProviderTemp=[];$scope.providerForNewAppintment=[];if(!$scope.ikenableFacilityAccess){$.ajax({type:"POST",url:makeURL('/mobiledoc/jsp/webemr/scheduling/Controller.jsp?action=getDoctors&providerName='+$scope.appointmentProvider.providerName+'&minValue='+$scope.minValue),"async":false,success:function(data){$scope.showProviderDropdown=true;var data=JSON.parse(data.trim());var result=data.result;angular.forEach(result,function(rowData){$scope.providerForNewAppintment.push(rowData)})}})}else{$.ajax({type:"POST",url:makeURL('/mobiledoc/jsp/webemr/scheduling/Controller.jsp?action=getAuthorizedProviderForSearch&UserId='+global.TrUserId+'&facId='+$scope.facilityId+'&providerName='+$scope.appointmentProvider.providerName+'&minValue='+$scope.minValue),"async":false,success:function(data){$scope.showProviderDropdown=true;if(!newAppointmentFnNameSpace.checkIfEmpty(data)){var data=JSON.parse(data.trim());var result=data.result;if(!data.result){result=data}angular.forEach(result,function(rowData){$scope.providerForNewAppintment.push(rowData)})}else{$scope.providerForNewAppintment=[]}}})}if($scope.encounterId>0){$scope.showProviderIfInactive($scope.encData.doctorid)}}else{$scope.loadInitialProvider()}}};$scope.showActiveResourceOnly="true";$scope.showProviderIfInactive=function(nId){var obj;for(var i=0;i<$scope.providerForNewAppintment.length;i++){obj=$scope.providerForNewAppintment[i];if(nId===obj.id&&parseInt(obj.status)===1){$scope.providerForNewAppintment[i].showme=true}}};$scope.loadInitialProvider=function(){$scope.showProviderDropdown=true;$scope.providerForNewAppintment=[];$scope.inSearchMode=false;$scope.pageNo=0;$scope.recordsPerPage=10;$scope.getDoctorsDetailsWithPagination()};$scope.checkForClaimAndCoPay=function(){if(!$scope.changeVisitFromEnc){if($scope.appointmentVisitType.ReqClaim&&$scope.appointmentVisitType.ReqClaim=='0'){if($scope.nonBillableVisitTypeCheck&&getItemKeyValue("DisablePopupForNonBillableVisits",false).toLowerCase()!="yes"){newAppointmentFnNameSpace.confirmDialog("Marking this encounter as non-billable will prevent claims from being created for this encounter. Are you sure you want to mark this encounter as non-billable?",'bluetheme',function(result){if(result){$scope.$apply(function(){$scope.isNonBillable=true})}else{return}},"Appointment Details - Mark Encounter as Non-Billable")}else{$scope.$apply(function(){$scope.isNonBillable=true})}}else{$scope.$apply(function(){$scope.isNonBillable=false})}if($scope.appointmentVisitType.ReqCopay&&$scope.appointmentVisitType.ReqCopay=='0'){$scope.$apply(function(){$scope.coPayCb=true;$scope.copayChanged=1});$scope.readonlytxt=false;$scope.mCoPaytext="0.00"}else{$scope.$apply(function(){$scope.coPayCb=false;$scope.copayChanged=0});$scope.readonlytxt=true;$scope.mCoPaytext=""}if($scope.appointmentVisitType.billtopatient==="1"){fadeAlert("Pt Portion/Copay has been changed !",'290px',"","newAppointmentIpt14");getVisitTypeCopayCharges()}else{$scope.lblChangeCopay="Change co-pay"}}if($scope.appointmentVisitType.billtopatient==="1"){$scope.lblChangeCopay="Patient portion "}else{$scope.lblChangeCopay="Change co-pay"}$scope.nonBillableVisitTypeCheck=true;$scope.changeVisitFromEnc=false;if($scope.isAppointmentModalShown){$scope.apptForm.$setDirty()}};$scope.lblChangeCopay="Change co-pay";function fadeAlert(msg,width,parentClass,inputToHighlight,callBackfunc){var msgDivRelativePos={};var inlineMsgDiv=$('#napInlineMsg');inlineMsgDiv.css('width',width);$('#napMsgHeader').text("Note : ");$('#napMsgbox').text(msg);if(parentClass!==undefined&&parentClass!==""){let parentClassPos=$("."+parentClass).offset();inlineMsgDiv.css('display','block');let msgDivPos=inlineMsgDiv.offset();msgDivRelativePos=inlineMsgDiv.position();let topDiff=msgDivPos.top-parentClassPos.top;let leftDiff=$(window).width()/2-(inlineMsgDiv.width()+32)/2;inlineMsgDiv.offset({top:msgDivPos.top-topDiff,left:leftDiff});inlineMsgDiv.css('display','none')}inlineMsgDiv.fadeIn('slow').delay(1200).fadeOut('slow');if(inputToHighlight!==undefined&&inputToHighlight!==""){$('#'+inputToHighlight).addClass('highlightTextBox');setTimeout(function(){$('#'+inputToHighlight).removeClass('highlightTextBox')},2e3)}if(parentClass!==undefined&&parentClass!==""){setTimeout(function(){inlineMsgDiv.css('top',msgDivRelativePos.top+'px');inlineMsgDiv.css('left',msgDivRelativePos.left+'px');inlineMsgDiv.css('display','none')},3e3)}if(callBackfunc!==undefined){setTimeout(function(){callBackfunc()},2e3)}}var getVisitTypeCopayCharges=function(){var url="/mobiledoc/jsp/webemr/menu/schedule/visitTypeCostConfigController.jsp";var param={Action:"GET_CHARGES",visitCode:$scope.appointmentVisitType.Name,resourceId:$scope.appointmentResource.id};ajaxCallByPost(url,param).success(function(data,status,headers,config){if(headers.status===200){var retData=$.parseJSON(data);if(retData.visitBillToPt){$scope.lblChangeCopay="Patient portion ";$scope.mCoPaytext=retData.charges;$scope.copayChanged=1;$scope.coPayCb=true;$scope.readonlytxt=false}else{$scope.lblChangeCopay="Change co-pay"}}})};$scope.checkIfEmpty=function(value){if(typeof value==='undefined'||value=="0"||value==""||value==null)return true;else return false};$scope.loadRefPopup=function(refId,patientId,ptName,refEncId,nNhxReqId,recType){var params={refId:refId,patientId:patientId,ptName:ptName,refEncId:refEncId,nNhxReqId:nNhxReqId,recType:recType,referralType:"Incoming",callingFrom:'Appointment'};params=$.param(params);$ocLazyLoad.load({name:'referralPopUpApp',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/commanP2PService.js','/mobiledoc/jsp/webemr/jellybean/referral/referralPopupController.js','/mobiledoc/jsp/webemr/templates/icd-tpl.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/EncDetailsService.js','/mobiledoc/jsp/webemr/templates/cpt-tpl.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/ICD_Treatment.js'],cache:false}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/referral/referralPopup.jsp?'+params);$scope.referralUrlAppt=url},function(e){})};$scope.getReferralIdCallback=function(referralId,patientDtlsObj){$scope.referralId=referralId;if(!newAppointmentFnNameSpace.checkIfEmpty(patientDtlsObj.id)){patientId=patientDtlsObj.id;$scope.selectPatient(patientDtlsObj)}$scope.isDisabled=true};$scope.getReferralDropDownReload=function(){$scope.getReferralDropDown()};$scope.ptReferralsURLAppt="";$scope.closePtReferral=function(){$scope.ptReferralsURLAppt="";$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1;if($('#rptog').hasClass('active')){$scope.Dialog.width='1080px'}else{$scope.Dialog.width='750px'}};$scope.openMultipleAppt=function(val){var date="";if(val==2){date=$scope.getDateForFollowUp();date=moment(date,"MM/DD/YYYY").format("MM/DD/YYYY")}var popupData={};popupData.modulename="multipleApptSearch";popupData.dependencies=["/mobiledoc/jsp/webemr/scheduling/js/multipleApptSearch.js","/mobiledoc/jsp/webemr/scheduling/js/appointmentSearch.js","/mobiledoc/jsp/webemr/templates/Provider-tpl.js"];popupData.url=makeURL("/mobiledoc/jsp/webemr/scheduling/multipleAppointment.jsp?patientName="+$scope.ptName+"&patientId="+$scope.patientId+"&patientDOB="+$scope.ptDob+"&patientPhNo="+$scope.ptTel+"&encounterId="+$scope.encounterId+"&parentScreen=Appointment&dateForNextAppt="+date+"&resourceId="+$scope.appointmentResource.id+"&resouceName="+$scope.appointmentResource.resourceName+"&visittype="+$scope.appointmentVisitType.Name);$scope.newpopUpUrlAppt="";$scope.ocLazyLoadPopup(popupData)};$scope.loadReferralData=function(){var url="/mobiledoc/jsp/catalog/xml/CheckReferral.jsp";var param={EncounterId:$scope.encounterId,nhxBlockId:block_id};ajaxCallByPost(url,param).success(function(data,status,headers,config){$scope.referralDetails=xml2json(data).Envelope.Body["return"].encounter;if($scope.referralDetails.nhxRefReqId>0||$scope.referralDetails.referral>0){$scope.showReferralData()}else{var url="/mobiledoc/jsp/webemr/scheduling/Controller.jsp";var param={EncounterId:$scope.encounterId,action:'getReferralStatus'};ajaxCallByPost(url,param).success(function(data,status,headers,config){if(typeof data!='undefined'&&data!=""){if(data.trim().toLowerCase()=="yes"){$scope.showReferralWarning()}}})}})};$scope.setTransitionOfCareFromChild=function(toc){$scope.transitionOfCare=toc};$scope.openToCPTRefRec=function(){if($scope.encounterId==="0"){ecwAlert("Please save the appointment to launch the Transition of care screen.",defaultAlertTitle);return false}$templateCache.remove($scope.tocPtReferralsRecsURLAppt);$scope.tocPtReferralsRecsURLAppt="";var params={PatientId:$scope.patientId,patientName:$scope.ptName,encounterId:$scope.encounterId,toc:$scope.transitionOfCare,context:'webemr',fromscreen:'appoinment'};params=$.param(params);$ocLazyLoad.load({name:'TocRefRecWebApp',files:['/mobiledoc/jsp/webemr/jellybean/referral/TOCPTRefRec.js'],cache:false}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/referral/TOCPTRefRec.jsp?'+params;$scope.tocPtReferralsRecsURLAppt=makeURL(url)},function(e){})};$scope.openRefferal=function(){if($scope.patientId==0||$scope.patientId==""||typeof $scope.patientId=='undefined'){showMessage('please select patient','ptLookup');return}else{$scope.loadPtReferral()}};$scope.loadPtReferral=function(){$templateCache.remove($scope.ptReferralsURLAppt);$scope.ptReferralsURLAppt="";var params={PatientId:$scope.patientId,referralId:typeof $scope.referralDetails.referral!='undefined'&&$scope.referralDetails.referral!=''?$scope.referralDetails.referral:0,nhxRefReqId:typeof $scope.referralDetails.nhxRefReqId!='undefined'&&$scope.referralDetails.nhxRefReqId!=''?$scope.referralDetails.nhxRefReqId:0,nEncounterId:$scope.encounterId,parentForm:"appointment"};params=$.param(params);$ocLazyLoad.load({name:'ptReferralApp',files:['/mobiledoc/jsp/webemr/jellybean/referral/ptReferralController.js'],cache:false}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/referral/ptReferrals.jsp?'+params;$scope.ptReferralsURLAppt=makeURL(url)},function(e){})};function createAppointmentReferralVisitsXML(referralVisitsArray,action,userId){var xw=new XMLWriter;startSoapPacket(xw);if(action=="Delete"){for(var index in referralVisitsArray){obj=referralVisitsArray[index];xw.writeStartElement('visit');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'referralId',obj.referralId,'xsi:type','xsd:int');addElement(xw,'encounterId',obj.encounterId,'xsi:type','xsd:int');addElement(xw,'userId',userId,'xsi:type','xsd:int');xw.writeEndElement()}}else{for(var index in referralVisitsArray){obj=referralVisitsArray[index];xw.writeStartElement('visit');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'referralId',obj.referralId,'xsi:type','xsd:int');addElement(xw,'encounterId',obj.encounterId,'xsi:type','xsd:int');addElement(xw,'visitsAllowed',obj.visitsAllowed,'xsi:type','xsd:string');addElement(xw,'visitNo',obj.visitNo,'xsi:type','xsd:string');addElement(xw,'userId',userId,'xsi:type','xsd:int');xw.writeEndElement()}}endSoapPacket(xw);return xw.flush()}$scope.saveEncountertoReferralVisits=function(refId,refvisitsAllowed,refvisitsUsed,id,action,referralAction){var refVistisArry=[];if($scope.encounterId!=""&&$scope.encounterId!=-1){var objVisit={referralId:refId,encounterId:id,visitsAllowed:refvisitsAllowed,visitNo:refvisitsUsed};refVistisArry.push(objVisit)}var xmlData=createAppointmentReferralVisitsXML(refVistisArry,action,global.TrUserId);var params={referralId:refId,FormData:xmlData,encounterId:id,block_id:block_id,Action:action,TrUserId:global.TrUserId,referralAction:referralAction};params=$.param(params);$http({method:"POST",url:makeURL("/mobiledoc/jsp/webemr/referral/addEncounterToVisit.jsp"),data:params,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).then(function(response){return response.data},function(){throw"Internal Error occured, Please try after some time"})};$scope.selectReferralGroup=function(referral){if(typeof referral=='undefined'){$scope.referralData="";$scope.referralAction="Delete"}else{$scope.referralData="";if(referral.ToProvider!==undefined&&referral.ToProvider!==''){$scope.referralData=$scope.referralData+referral.ToProvider}if(referral.Speciality!==undefined&&referral.Speciality!==''){$scope.referralData=$scope.referralData+" ("+referral.Speciality+")"}$scope.referralReasonData="Reason : "+referral.Reason;$scope.referralProvider=referral.ToProvider;$scope.referralReason=referral.Reason;$scope.referralSpecility=referral.Speciality;$scope.referralIDNew=referral.Id;$scope.referralvisitsAllowed=referral.visitsAllowed;$scope.referralvisitNo=referral.visitNo;$scope.referralTypeData=referral.referralType;$scope.referralAction="Save"}};$scope.multipleSearchURL="";$scope.vtRuleArray=[];$scope.apptArray=[];$scope.loadMultipleAppointmentSearch=function(val){$templateCache.remove($scope.multipleSearchURL);$scope.multipleSearchURL="";$ocLazyLoad.load({name:'appointmentSearch',files:['/mobiledoc/jsp/webemr/scheduling/js/appointmentSearch.js'],cache:false}).then(function(){var url='/mobiledoc/jsp/webemr/templates/multipleAppointmentTpl.jsp?patientId='+$scope.patientId+'&patientName='+$scope.ptName;$scope.multipleSearchURL=url},function(e){})};$scope.getDateForFollowUp=function(){if(!newAppointmentFnNameSpace.checkIfEmpty($scope.nextApptLabel)){var strNextApptString=$scope.nextApptLabel[0];var arr=strNextApptString.split(" ");var no=arr[0];var val=arr[1];var date=$scope.StDate;if(!newAppointmentFnNameSpace.checkIfEmpty(no)&&!val){var followupdate=moment(no,"MM/DD/YYYY");var isValidDate=moment(followupdate,"MM/DD/YYYY").isValid();if(isValidDate){return followupdate}}if(!newAppointmentFnNameSpace.checkIfEmpty(no)&&!newAppointmentFnNameSpace.checkIfEmpty(val)){date=$scope.getDateForNextAppt(no,val)}return date}else{return""}};$scope.getDateForNextAppt=function(no,val){var result;switch(val){case"d":case"D":case"Day":case"day":case"Days":case"days":result=moment($scope.StDate,$scope.dateFormat).add(parseInt(no),'days');break;case"w":case"W":case"Week":case"week":case"weeks":case"Weeks":result=moment($scope.StDate,$scope.dateFormat).add(parseInt(no),'weeks');break;case"m":case"M":case"month":case"Month":case"months":case"Months":result=moment($scope.StDate,$scope.dateFormat).add(parseInt(no),'months');break;case"y":case"Y":case"year":case"years":case"Year":case"Years":result=moment($scope.StDate,$scope.dateFormat).add(parseInt(no),'years');break;default:result=$scope.StDate;break}return result};$scope.openEncounterLookUp=function(){if($scope.patientId<=0||$scope.patientId==""||typeof $scope.patientId=='undefined'){showMessage('please select patient','ptLookup');return}PSACService.checkCommonStaffPermission($scope.patientId,function(){$ocLazyLoad.load({name:'NewEncounter',files:['/mobiledoc/jsp/webemr/toppanel/encounter.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/Encounter-lookup.jsp?patientId="+$scope.patientId+"&pnencid="+$scope.encounterId+"&patientName="+$scope.ptName+"&callFrom=appointment"+"&nd="+(new Date).getTime());$scope.newpopUpUrlAppt=url},function(e){})},function(){return})};$scope.deleteAppt=function(){var retData;if(!$scope.deleteAccess){showMessage("Permission Denied.");return}if($scope.encounterId!='0'&&$scope.encounterId!=''&&typeof $scope.encounterId!="undefined"){if($scope.encData.encLock==1){showMessage("Locked encounters can't be deleted.");return}else if(scheduleCommonService.CheckPaymentsForEnc($scope.encounterId)>0){showMessage("This encounter cannot be deleted.\nIt has Claims/Payments associated with it.");return}else if(scheduleCommonService.CheckLabForEnc($scope.encounterId)>0){showMessage("This encounter cannot be deleted.\nIt has Labs/DI associated with it.");return}else if(scheduleCommonService.CheckImmForEnc($scope.encounterId)>0){showMessage("This encounter cannot be deleted.\nIt has Immunizations associated with it.");return}else if(scheduleCommonService.CheckMedicationForEnc($scope.encounterId)=="true"){showMessage("This encounter cannot be deleted.\nIt has Medication associated with it.");return}else if((retData=scheduleCommonService.encClinicalDataValidator($scope.encounterId)).status==="failed"){ecwAlert($.trim(retData.message),defaultAlertTitle);return}else{var nGroupId="";var recurrenceFlag=$scope.encData.groupId&&$scope.encData.groupId!=''||$scope.encData.recurrenceId?true:false;if($scope.encData.groupId&&$scope.encData.groupId!=''){nGroupId=$scope.encData.groupId}var subMessage="";if(recurrenceFlag){subMessage="This Appointment is part of a set/package."}var message;if(typeof $scope.encData.title!='undefined'&&$scope.encData.title!=""&&$scope.encData.title.length>0){message=subMessage+" Are you sure you want to delete appointment for '"+$scope.encData.title+"'?"}else{message=subMessage+" Are you sure you want to delete the appointment?"}if(retData.status==='success'&&retData.message.indexOf("The progress note logs indicate")!==-1){message=retData.message.replace("loss of data","<b>loss of data</b>")}newAppointmentFnNameSpace.confirmDialogWithHtmlMsg(message,$scope.isVision?'ss-modal':'bluetheme',function(result){if(result){if(recurrenceFlag){var displayMsg=scheduleCommonService.getTotalEncCountForGroupAppointmentMsg($scope.encounterId);if(displayMsg&&displayMsg.length>0){ecwAlert(displayMsg,defaultAlertTitle)}}$timeout(function(){$scope.deleteEncounter(false,nGroupId)},500)}},true)}}};$scope.initNewReferral=function(refId,patientId,nFlag,referralTypeData,ptName,refEncId,nNhxReqId){if($scope.patientId==0||$scope.patientId==""||typeof $scope.patientId=='undefined'){showMessage('Please select patient','ptLookup');return}else{if($('#referralCombo1').val().length<=0&&nFlag==1){showMessage('Please select Referral');return}var setReferral="";if(typeof referralTypeData=='undefined'||referralTypeData=="I"){setReferral="Incoming"}$scope.referralPopUpAppointment="";var params={refId:refId,patientId:$scope.patientId,ptName:ptName,refEncId:refEncId,nNhxReqId:nNhxReqId,recType:'REF',referralType:setReferral,callingFrom:'NewAppointment'};params=$.param(params);$ocLazyLoad.load({name:'referralPopUpAppointment',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/commanP2PService.js','/mobiledoc/jsp/webemr/jellybean/referral/referralPopupController.js','/mobiledoc/jsp/webemr/templates/icd-tpl.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/EncDetailsService.js','/mobiledoc/jsp/webemr/templates/cpt-tpl.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/ICD_Treatment.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/referral/referralPopup.jsp?'+params);$scope.referralPopUpAppointment=url},function(e){})}};$scope.responseReferral=function(){$scope.referralPopUpAppointment=""};$scope.deleteEncounter=function(result,nGroupId){scheduleCommonService.deleteEncounter($scope.encounterId,result,nGroupId).success(function(data){scheduleCommonService.setLogs($scope.encounterId,3);$scope.apptForm.$setPristine();$scope.closeApptScreen(true)}).error(function(data){showMsg('An error occurred in deleting an appointment')})};$scope.closeApptScreen=function(isCallledFromDelete){$scope.multiApptClick=0;if($scope.actions.apptAction!=1){if($('#rptog').hasClass('active')){$scope.Dialog.width='1080px'}else{$scope.Dialog.width='750px'}$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1}else{if($scope.apptForm.$dirty){newAppointmentFnNameSpace.confirmDialog('Do you want to save the changes you made to appointment?','bluetheme',function(result){if(result){$scope.createAppointment(1)}else{$scope.closeApptpopUp(isCallledFromDelete)}})}else{$scope.closeApptpopUp(isCallledFromDelete)}}if(parentForm=='waitList'){$rootScope.$broadcast("scheduleWaitListedApptCancel",$scope.patientId);$templateCache.remove($scope.popupurl);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();$scope.cleanUp()}if(parentForm==='bumpList'){$rootScope.$broadcast("unselectBumpAppointment",$scope.encounterId);if(isLockMine(apptLockObj)){releaseFormLock(apptLockObj)}$templateCache.remove($scope.popupurl);$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$(".modal-backdrop").remove();$scope.cleanUp()}};$scope.closeApptpopUp=function(isCallledFromDelete){if($scope.isFloatingToolbar){disableBottomPanelButtonsForFloatingToolbar()}$scope.multiApptClick=0;appointmentService.destoryScope();if($scope.actions.apptAction!=1){if($('#rptog').hasClass('active')){$scope.Dialog.width='1080px'}else{$scope.Dialog.width='750px'}$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1}else{if(!angular.isUndefined($scope.ignoreAndProceed)&&$scope.ignoreAndProceed==true){$scope.checkRegRulesonCloseApptpopUp(isCallledFromDelete)}else{if($scope.regFailedRules.length>0){newAppointmentFnNameSpace.confirmDialog("There are unsatisfied Ignorable/Non-Ignorable Registration Rule(s) for this appointment. Are you sure you want to close anyway?",'bluetheme',function(result){if(result){$scope.$apply(function(){$scope.txtReason='';$scope.ruleStatus='Reg Rule Cancellation';$scope.calledFromdeleteEnc=isCallledFromDelete;$("#changeRegRuleLogStatusDialog").modal({show:true,backdrop:'static'})})}else{$scope.$apply(function(){if($scope.saveFromVal===12){$scope.saveFromVal=1;$scope.multiApptClick=1}return false})}},"Appointment Details - Unsatisfied Registration Rules")}else{$scope.checkRegRulesonCloseApptpopUp(isCallledFromDelete)}}}};$scope.saveRegRuleStatusDescription=function(){if($.trim($scope.ruleReason).length===0){$scope.txtReason="Please specify reason";$scope.calledFromdeleteEnc=false;return false}if($scope.ruleStatus==='Reg Rule Cancellation'){$scope.regFailedRules.forEach(function(failedRuleObj){failedRuleObj.description=$scope.ruleReason});$scope.logRegFailedRules($scope.regFailedRules,$scope.calledFromdeleteEnc)}else if($scope.ruleStatus==='Ignore And Proceed'){if($scope.multiApptClick===1){$scope.saveFromVal=12}$scope.saveRegRuleIgnoreAndProceedReason();$("#changeRegRuleLogStatusDialog").modal("hide")}$scope.calledFromdeleteEnc=false};$scope.saveRegRuleIgnoreAndProceedReason=function(){$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',data:$.param({action:'updateTransaction',encounterId:$scope.encounterId,reason:$scope.ruleReason}),url:makeURL("/mobiledoc/jsp/rulesengine/processRegistrationRules.jsp")}).then(function(response){if(response!==undefined&&response.status===200){if($scope.saveFromVal!==12){$scope.saveFromVal=1}$scope.saveAppointment()}},function(error){ecwAlert("Failed to save registration rule IgnoreAndProceed reason",defaultAlertTitle)})};$scope.closeDialog=function(){if($scope.ignoreAndProceed){$scope.ignoreAndProceed=false}if($.trim($scope.ruleReason).length>0){$scope.ruleReason=""}closeModal()};$scope.cleanUp=function(isFromDestroy){if($scope.telephoneencounterurl&&parentForm=="encounters"){$templateCache.remove($scope.telephoneencounterurl);$scope.$parent.onCloseAppt()}else if($scope.hublinkurl&&parentForm=="patientHub"){$templateCache.remove($scope.hublinkurl);$scope.$parent.onCloseAppt()}else if($scope.linkurl&&parentForm=="Registry"){$templateCache.remove($scope.linkurl);$scope.$parent.onCloseAppt()}else if($scope.trackingBoardVisitUrl&&parentForm=="trackingBoard"){$templateCache.remove($scope.trackingBoardVisitUrl);$scope.$parent.onCloseAppt()}else if($scope.trackingBoardVisitUrl&&parentForm=="bumpList"){$templateCache.remove($scope.sendMessageDlg);$scope.$parent.onCloseAppt()}else if($scope.appointmentPopup&&$scope.appointmentPopup.url&&parentForm==="officevisit"){$templateCache.remove($scope.appointmentPopup.url);$scope.$parent.onCloseAppt()}else if($scope.appointmentUrl&&$scope.appointmentUrl.url&&parentForm==="FamilyBooking"){$templateCache.remove($scope.appointmentUrl.url);$scope.$parent.onCloseAppt()}else if($scope.eligibilityApptUrl&&parentForm==="eligibilityAdmin"){$templateCache.remove($scope.eligibilityApptUrl);$scope.$parent.closeEligibilityApptInParent()}else if(parentForm==="bumpList"){$rootScope.$broadcast("unselectBumpAppointment",$scope.encounterId);if(isLockMine(apptLockObj)){releaseFormLock(apptLockObj)}$scope.$parent.onCloseAppt()}};$scope.checkRegRulesonCloseApptpopUp=function(isCallledFromDelete){if(isLockMine(apptLockObj)){releaseFormLock(apptLockObj)}if(!$scope.closePopupFromAddlBillingData){$('#newApptModal').data('modal',null);$('#newApptModal').modal("hide");$("#changeRegRuleLogStatusDialog").modal("hide");$(".modal-backdrop").remove();$('#patientLkpcls').removeClass('apptWidth');if(parentForm&&parentForm=="ResSchedule"){$scope.removeLock();$scope.refreshSchedule();$scope.url.popupurl="";if($scope.saveFromVal===12){$scope.openFamilyBookingModal()}}else if(parentForm=="trackingBoard"){var encObj={visitStatus:$scope.appointmentVisitStatus.code,encId:$scope.encounterId,arrTime:$scope.arriveTime,encDate:$scope.getStartDateInYYYYMMDD(),patientId:$scope.patientId};$scope.$parent.initCountsandList(encObj)}if($scope.enableOccHealth&&$scope.occMedValue.toLowerCase()==='yes'&&!isCallledFromDelete){openOccHealthAppointment($scope.encounterId,$scope.appointmentStartTime.time,$scope.appointmentEndTime.time,$scope.appointmentResource.id,$scope.appointmentResource.resourceName,$scope.StDate,$scope.appointmentVisitType.Name,"",$scope.appointmentVisitType.color,$scope.facilityId,$scope.facilityName,$scope.patientId,$scope.ptName,"Appointment",$scope.reservedSlotId,$scope.pos,schedulefacilityFilter,block_id)}$scope.cleanUp()}};$scope.logRegFailedRules=function(regFailedRules,isCallledFromDelete){var url=makeURL("/mobiledoc/jsp/rulesengine/processRegistrationRules.jsp");$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',data:$.param({action:'logFailesRegRules',encounterId:$scope.encounterId,strRules:JSON.stringify(regFailedRules)}),url:url}).then(function(response){if(response!==undefined&&response.status===200){if(refreshRegDashBoardOnclose==="1"){$scope.$parent.paginationDetail.pageNo=1;$scope.$parent.getFilteredLogs()}$scope.checkRegRulesonCloseApptpopUp(isCallledFromDelete)}},function(error){ecwAlert("Failed to log registration rules status",defaultAlertTitle)})};$scope.showTimeZone=false;$scope.getClassForFac=function(){if($scope.ikEnableUTCScheduling){$scope.showTimeZone=true;return"col-sm-7"}else{$scope.showTimeZone=true;return"col-sm-9"}};$scope.miscInfoJSON=[];$scope.openMiscInfo=function(){$scope.actions.apptAction=9;$("#apptActionModalMainId").modal();$scope.getMiscInfo()};$scope.openClaimRespParty=function(){if($scope.encounterId<=0||$scope.encounterId==""||typeof $scope.encounterId=='undefined'){return}if($scope.patientId<=0||$scope.patientId==""||typeof $scope.patientId=='undefined'){showMessage('please select patient','ptLookup');return}$scope.claimRespPartyAppt="";$ocLazyLoad.load({name:'ChangeClaimRespParty',files:['/mobiledoc/jsp/webemr/webpm/claimResponsibleParty/js/ChangeClaimRespPartyCtrl.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/webpm/claimResponsibleParty/ChangeClaimRespPartyEncWeb.jsp?PatientId="+$scope.patientId+"&EncId="+$scope.encounterId+"&parent=apt");$scope.claimRespPartyAppt=url},function(e){})};$scope.getMiscInfo=function(){if($scope.encounterId<=0||$scope.encounterId==""||typeof $scope.encounterId=='undefined'){return}var serverUrl=makeURL('/mobiledoc/jsp/catalog/xml/getApptMiscInfo.jsp?EncounterId='+$scope.encounterId);var miscInfoXML=urlGet(serverUrl);$scope.miscInfoJSON=[];$scope.miscInfoJSON=returnDataArray(xml2json(miscInfoXML).Envelope.Body["return"].MiscInfo);$.each($scope.miscInfoJSON,function(k,v){$('#td'+v.LabelId).prop('readonly',true)})};$scope.getMiscInfoUrl=function(){return makeURL('/jsp/catalog/xml/getApptMiscInfo.jsp')};$scope.getcreateSaveMiscInfoXml=function(){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('CusotomInfoList');xw.writeStartElement('CustomLabel');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'LabelName',$scope.miscInfoName.value,'xsi:type','xsd:string');addElement(xw,'UpdateFlag','false','xsi:type','xsd:string');addElement(xw,'LabelId',0,'xsi:type','xsd:string');addElement(xw,'Display',0,'xsi:type','xsd:string');xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();return xml};$scope.getSaveMiscInfoUrl=function(){return makeURL('/jsp/catalog/xml/setApptMiscLabelName.jsp')};$scope.createSaveMiscInfoXml=function(){if($scope.apptMiscCustomization===false){ecwAlert("This user does not permission to change the Miscellaneous Info",defaultAlertTitle);return}var checkFieldLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_miscinfo","apptmiscInfoLableDiv","bluetheme");if(checkFieldLength==false){return false}if(newAppointmentFnNameSpace.checkIfEmpty($scope.miscInfoName.value)){showMessage("Enter a label name",'miscLabel');return}else{$scope.ajaxBatch=[];$scope.ajaxBatch.push({url:$scope.getSaveMiscInfoUrl(),param:[{paramName:"FormData",paramValue:$scope.getcreateSaveMiscInfoXml()}],error:onErrorcreateSaveMiscInfo});$scope.ajaxBatch.push({url:$scope.getMiscInfoUrl(),param:[{paramName:"EncounterId",paramValue:$scope.encounterId}],success:onGetMiscInfo,error:onErrorcreateSaveMiscInfo});batchAjaxService.batchAjax($scope.ajaxBatch);$scope.miscInfoName.value=""}};var onGetMiscInfo=function(response){$scope.miscInfoJSON=[];if(!newAppointmentFnNameSpace.checkIfEmpty(response)){$scope.miscInfoJSON=returnDataArray(xml2json(response).Envelope.Body["return"].MiscInfo);$.each($scope.miscInfoJSON,function(k,v){$('#td'+v.LabelId).prop('readonly',true)})}};var onErrorcreateSaveMiscInfo=function(){ecwAlert("An error accured while getting misc info",defaultAlertTitle)};var onErrorcreateSaveMiscInfo=function(){ecwAlert("An error accured while savin misc info",defaultAlertTitle)};$scope.deleteMiscInfo=function(obj){if($scope.apptMiscCustomization===false){ecwAlert("This user does not have permission to change the Miscellaneous Info",defaultAlertTitle);return}newAppointmentFnNameSpace.confirmDialog('Do you want to delete: '+obj.InfoName,'bluetheme',function(result){if(result){$scope.ajaxBatch=[];$scope.ajaxBatch.push({url:$scope.getDelMiscInfoUrl(),param:[{paramName:"EncounterId",paramValue:$scope.encounterId},{paramName:"labelId",paramValue:obj.LabelId}],error:onErrorDeleteMiscInfo});$scope.ajaxBatch.push({url:$scope.getMiscInfoUrl(),param:[{paramName:"EncounterId",paramValue:$scope.encounterId}],success:onGetMiscInfo,error:onErrorcreateSaveMiscInfo});batchAjaxService.batchAjax($scope.ajaxBatch)}else{return}})};var onErrorDeleteMiscInfo=function(){ecwAlert("error while deleteing misc info",defaultAlertTitle)};$scope.getDelMiscInfoUrl=function(){return makeURL('/jsp/catalog/xml/deleteApptCustomInfo.jsp')};$scope.editMiscInfo=function(obj){if($scope.apptMiscCustomization===false){ecwAlert("This user does not have permission to change the Miscellaneous Info",defaultAlertTitle);return}$('#td'+obj.LabelId).prop('readonly',false);$('#edit'+obj.LabelId).hide();$('#save'+obj.LabelId).show()};$scope.lablId=0;$scope.createEditMiscInfoXml=function(obj){var checkFieldLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_miscinfogrid","miscInfoLableValueTbl","bluetheme");if(checkFieldLength==false){return}if(newAppointmentFnNameSpace.checkIfEmpty(obj.InfoName)){showMessage("Enter a label name");return}else{var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('CusotomInfoList');xw.writeStartElement('CustomLabel');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'LabelName',obj.InfoName,'xsi:type','xsd:string');addElement(xw,'UpdateFlag','True','xsi:type','xsd:string');addElement(xw,'LabelId',obj.LabelId,'xsi:type','xsd:string');addElement(xw,'Display',0,'xsi:type','xsd:string');xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();$scope.lablId=obj.LabelId;$scope.ajaxBatch=[];$scope.ajaxBatch.push({url:$scope.getSaveMiscInfoUrl(),param:[{paramName:"FormData",paramValue:xml}],error:onErrorcreateSaveMiscInfo});$scope.ajaxBatch.push({url:$scope.getMiscInfoUrl(),param:[{paramName:"EncounterId",paramValue:$scope.encounterId}],success:onGetMiscInfoEdit,error:onErrorcreateSaveMiscInfo});batchAjaxService.batchAjax($scope.ajaxBatch)}};var onGetMiscInfoEdit=function(response){$scope.miscInfoJSON=[];if(!newAppointmentFnNameSpace.checkIfEmpty(response)){$scope.miscInfoJSON=returnDataArray(xml2json(response).Envelope.Body["return"].MiscInfo);$.each($scope.miscInfoJSON,function(k,v){$('#td'+v.LabelId).prop('readonly',true)})}$('#edit'+$scope.lablId).show();$('#save'+$scope.lablId).hide()};$scope.saveMiscInfoValue=function(){var checkFieldLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_miscinfogrid","miscInfoLableValueTbl","bluetheme");if(checkFieldLength==false){return false}var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('CusotomInfoList');$.each($scope.miscInfoJSON,function(k,v){xw.writeStartElement('CustomInfo');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'EncounterId',$scope.encounterId,'xsi:type','xsd:string');addElement(xw,'LabelId',v.LabelId,'xsi:type','xsd:string');addElement(xw,'InfoValue',v.InfoValue,'xsi:type','xsd:string');addElement(xw,'LabelSel',0,'xsi:type','xsd:string');xw.writeEndElement()});xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();$scope.ajaxBatch=[];$scope.ajaxBatch.push({url:$scope.getMiscInfoValUrl(),param:[{paramName:"FormData",paramValue:xml}],error:onErrorcreateSaveMiscInfo});$scope.ajaxBatch.push({url:$scope.getMiscInfoUrl(),param:[{paramName:"EncounterId",paramValue:$scope.encounterId}],success:onGetMiscInfoEdit,error:onErrorcreateSaveMiscInfo});batchAjaxService.batchAjax($scope.ajaxBatch);$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1};$scope.getMiscInfoValUrl=function(){return makeURL("/jsp/catalog/xml/setApptMiscDetails.jsp")};$scope.getTestDemographicsMandatoryFieldsList=function(){var serverUrl=makeURL('/mobiledoc/jsp/catalog/xml/testDemographicsMandatoryFieldsList.jsp');return serverUrl};$scope.loadChargeDetails=function(){newAppointmentFnNameSpace.confirmDialog('This will save the appointment data. Do you want to continue?','bluetheme',function(result){if(result){if(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)){$scope.createAppointment(3)}else{$scope.createAppointment(8)}}})};$scope.loadModalChargeDetails=function(){if(getItemKeyValue("IndiaOutPatient").toLowerCase()=="yes"){$scope.getClaimId()}else{$scope.modalclose=false;$templateCache.remove($scope.newpopUpUrlAppt);var altCoPayValue=$.trim($scope.mCoPaytext)==""?"0":$scope.mCoPaytext;$ocLazyLoad.load({name:'patientChargeDetailsApp',files:['/mobiledoc/jsp/webemr/webpm/js/patientChargeDetail.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/webpm/patientChargeDetails.jsp?patientId="+$scope.patientId+"&encId="+$scope.encounterId+"&pvDate="+$scope.StDate+"&altCoPay="+$scope.coPayCb+"&altCoPayValue="+altCoPayValue+"&parentScreen=newApptController");$scope.newpopUpUrlAppt=url},function(e){})}};$scope.setFacilityIdUsingClaimId=function(dataObj){if(!angular.isUndefined(dataObj)&&dataObj!=null&&dataObj.Id>0){$scope.facilityId=dataObj.Id;$scope.facilityName=dataObj.Name;$scope.facility1.facility.Name=dataObj.Name;if($scope.ikEnableUTCScheduling&&dataObj.TimeZoneCode&&dataObj.TimeZoneCode!==""){$scope.facility1.facility.Name=$scope.facility1.facility.Name+" ("+dataObj.TimeZoneCode+")";$scope.facilityTimeZone=dataObj.TimeZoneCode}$scope.pos=dataObj.pos}};$scope.closeAlertModal=function(){$('#alertModal').hide()};$scope.launchOrders=function(){$ocLazyLoad.load({name:'ptOrdersApp',files:['/mobiledoc/jsp/webemr/scheduling/patientorders/patientOrdersController.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/scheduling/patientorders/patientOrders.jsp?PatientId="+$scope.patientId+"&EncounterId="+$scope.encounterId);$scope.newpopUpUrlAppt=url},function(e){})};$scope.getptPayment=function(){var serverUrl=makeURL("/mobiledoc/jsp/catalog/xml/getPtPmtForEnc.jsp?EncounterId="+$scope.encounterId+"&showRecreatedClaimEncPayment=true");var ptPaymentInfoXML=urlGet(serverUrl);if(typeof ptPaymentInfoXML!='undefined'&&ptPaymentInfoXML!=''){$scope.ptPmtDetail=returnDataArray(xml2json(ptPaymentInfoXML).Envelope.Body["return"].resultset.data.row);$scope.CheckPaymentForEnc($scope.encounterId)}if($scope.ikEnableApptRightPanel&&$scope.panelStatus==="1"){$scope.panelUrl="";$scope.panelUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId='+$scope.encounterId+'&PtId='+$scope.patientId+'&RxCheck=Nothing&sessionDID=0&ecwappprocessid=281&date='+(new Date).getTime())}};$scope.encounterId=0;$scope.openPatientHub=function(){if(newAppointmentFnNameSpace.checkIfEmpty($scope.patientDtls.patient.id)){showMessage('please select patient','ptLookup');$('#ptLookup').focus();return}updatePatientSearchHistory($scope.patientDtls.patient.id,$scope.ptName);var enc=newAppointmentFnNameSpace.getPatientEncounters($scope.patientDtls.patient.id);var encounterId=0;if(enc){if(enc.length>1)encounterId=enc[0].encounterID;else if(enc.encounterID)encounterId=enc.encounterID}else{encounterId=0}PSACService.checkCommonStaffPermission($scope.patientDtls.patient.id,function(data){$ocLazyLoad.load({name:'NewHub',files:['/mobiledoc/jsp/webemr/templates/topPanel-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientHub/patienthubController.js']}).then(function(){$scope.patientinfohuburlAppt="";var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientHub/patient-hub.jsp?patientId='+$scope.patientDtls.patient.id+'&encounterId='+encounterId+'&parentScreen=newAppointment&nd='+(new Date).getTime());$scope.patientinfohuburlAppt=url},function(e){})},function(){})};$scope.openPatientInfo=function(){if(newAppointmentFnNameSpace.checkIfEmpty($scope.patientDtls.patient.id)){showMessage('please select patient','ptLookup');return}var name="";var files=[];$scope.patientinfohuburlAppt="";name='NewInfo';files=['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/ptInfoController.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/miscController.js'];$ocLazyLoad.load({name:name,files:files}).then(function(){$scope.patientinfohuburlAppt=makeURL('/mobiledoc/jsp/webemr/toppanel/patientInfo/patient-demographics.jsp?patientId='+$scope.patientDtls.patient.id+'&context=appointment&nd='+(new Date).getTime())},function(e){})};$scope.ocLazyLoadPopup=function(popupData){$ocLazyLoad.load({name:popupData.modulename,files:popupData.dependencies,cache:true}).then(function(){$scope.newpopUpUrlAppt=popupData.url},function(e){})};$scope.getClassForEmail=function(){if($scope.ikIgnoreProviderMap){return"col-sm-6"}else{return"col-sm-9"}};$scope.closePopUp=function(){if($scope.actions.apptAction!=1){if($('#rptog').hasClass('active')){$scope.Dialog.width='1080px'}else{$scope.Dialog.width='750px'}$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1}else{$('#newApptModal').modal("hide");$('#newApptModal').data('modal',null);if(parentForm==""||parentForm=="ResSchedule"){$scope.removeLock();newAppointmentFnNameSpace.saveUserProfile()}else if(parentForm==="bumpList"){$rootScope.$broadcast("unselectBumpAppointment",$scope.encounterId);if(isLockMine(apptLockObj)){releaseFormLock(apptLockObj)}}$templateCache.remove($scope.url);$(".modal-backdrop .fade .in").remove();$('#patientLkpcls').removeClass('apptWidth');$scope.cleanUp()}};$scope.toggleApptRightPane=function(){$('#rptog').toggleClass('active');var rpane=$('#ic-tog1').closest('.modal').find('#newApptDialog');var rightpaneltog=$('#ic-tog1').closest('.modal').find('.app-wrpap .right-panel');if(rpane.hasClass('visible')){rpane.animate({"width":"750"},"1000").removeClass('visible');rightpaneltog.animate({"right":"-336px"},"2000").removeClass('visible');$scope.panelStatus="0";$scope.setMinMarginForOK();$scope.Dialog.width="750px"}else{rpane.animate({"width":"1080px"},"1000").addClass('visible');rightpaneltog.animate({},"2000").addClass('visible');$scope.panelStatus="1";$scope.setMaxMarginForOK();$scope.Dialog.width="1080px";if($scope.panelUrl.length<=0){$scope.panelUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptsRightPane.jsp?EncId='+$scope.encounterId+'&PtId='+$scope.patientId+'&facilityId='+$scope.facilityId+'&RxCheck=Nothing&sessionDID=0&ecwappprocessid=281&date='+(new Date).getTime())}}};$scope.refProviderName="";$scope.refProviderId=0;$scope.setRefProvider=function(){$scope.apptForm.$setDirty();$scope.refProviderName=$scope.refproviderName.provider.Name;$scope.refProviderId=$scope.refproviderName.provider.Id};$scope.clearRefProvider=function(){$scope.refProviderName="";$scope.refProviderId=0};$scope.appointmentStartTimeChange=function(){if($scope.appointmentStartTime.time!=""&&$scope.appointmentStartTime.time!=null&&typeof $scope.appointmentStartTime.time!='undefined'&&$scope.appointmentVisitType.Minutes>0&&$scope.appointment_end_time==""&&visitType===""){var endTime=moment($scope.appointmentStartTime.time,$scope.timeFormat).add($scope.appointmentVisitType.Minutes,'minutes');$scope.appointmentEndTime.time=moment(endTime).format($scope.timeFormat)}else{visitType=""}$scope.appointment_end_time="";if(isProviderScheduleVerticalBarsEnabled){var duration=moment.duration(moment($scope.appointmentEndTime.time,$scope.timeFormat).diff(moment($scope.appointmentStartTime.time,$scope.timeFormat))).asMinutes();if(duration>0){$scope.appointmentDuration=Math.round(duration);$scope.appointmentDurationHoursMinutes(duration)}else{$scope.appointmentDuration=""}if($scope.isScreenEdited!=true){$scope.providerTimes='[]';$scope.resourceTimes='[]';$scope.chairTimes='[]'}else{$scope.isScreenEdited=false}}};$scope.appointmentEndTimeChange=function(){if(isProviderScheduleVerticalBarsEnabled){var duration=moment.duration(moment($scope.appointmentEndTime.time,$scope.timeFormat).diff(moment($scope.appointmentStartTime.time,$scope.timeFormat))).asMinutes();if(duration>0){$scope.appointmentDuration=Math.round(duration);$scope.appointmentDurationHoursMinutes(duration)}else{$scope.appointmentDuration=""}if($scope.isScreenEdited!=true){$scope.providerTimes='[]';$scope.resourceTimes='[]';$scope.chairTimes='[]'}else{$scope.isScreenEdited=false}}};$scope.appointmentDurationChange=function(){var endTime=moment($scope.appointmentStartTime.time,$scope.timeFormat).add($scope.appointmentDuration,'minutes');$scope.appointmentEndTime.time=moment(endTime).format($scope.timeFormat);var duration=moment.duration(moment($scope.appointmentEndTime.time,$scope.timeFormat).diff(moment($scope.appointmentStartTime.time,$scope.timeFormat))).asMinutes();if(duration>0){$scope.appointmentDuration=Math.round(duration);$scope.appointmentDurationHoursMinutes(duration)}else{$scope.appointmentDuration=""}};$scope.appointmentDurationHoursMinutes=function(duration){$scope.appointmentDurationMinutes=Math.ceil(duration%60/5)*5;if($scope.appointmentDurationMinutes==='60'){$scope.appointmentDurationHours=Math.floor(duration/60)+1}else{$scope.appointmentDurationHours=Math.floor(duration/60)}};$scope.getUserProfileXml=function(){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('UserProfile');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'ApptRightPanel',$scope.panelStatus,'xsi:type','xsd:String');xw.writeEndElement();endSoapPacket(xw);xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();return xml};$scope.getUserProfileUrl=function(){var url=makeURL('/jsp/catalog/xml/SaveUserProfile.jsp');return url};$scope.loadRxEligibilty=function(){$scope.newpopUpUrlAppt="";$ocLazyLoad.load({name:'rxEligibilityModule',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/showRxEligibility.js'],cache:false}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/showRxEligibility.jsp?PatientId='+$scope.patientId+'&StDate='+$scope.StDate+'&encId='+$scope.encounterId+"&providerID="+$scope.appointmentProvider.providerId+"&pmbid="+encodeURIComponent($scope.PMBID)+"&calledFrom=NewAppointment");$scope.newpopUpUrlAppt=url},function(e){})};$scope.showClaimPr=function(){$scope.apptClaimProviderUrl='';var strUrl="/mobiledoc/jsp/webemr/scheduling/newApptClaimProviders.jsp?encId="+$scope.encounterId;$ocLazyLoad.load({name:'apptClaimProviderModule',files:['/mobiledoc/jsp/webemr/scheduling/js/newApptClaimProvidersCtrl.js']}).then(function(){$scope.apptClaimProviderUrl=makeURL(strUrl);$("#newAppointmentUl1").show();$scope.showHideChildScreenBackdrop(true)},function(e){})};$scope.showHideChildScreenBackdrop=function(value){$scope.childScreenBackdrop=value};$scope.visitNo="";$scope.showVisitNo=false;$scope.showVisitNumber=function(){$scope.pmExtVisitNo=$scope.visitNo;$scope.showVisitNo=true};$scope.getVisitNumber=function(){return $scope.showVisitNo};$scope.cancelVisitNo=function(){$scope.visitNo=$scope.pmExtVisitNo;$scope.showVisitNo=false};$scope.okVisitNo=function(){var pmExtVisitNoScreenName="web_apptEncVisitNo";if($scope.pmVisitIDExtTable&&$scope.pmVisitIDExtTable.toLowerCase()==='yes'){pmExtVisitNoScreenName="web_apptPmCodesVisitNo"}if(dataTruncUtilityService.getTextFieldWidthsFromTable(pmExtVisitNoScreenName,"newAppointmentUl3","bluetheme")){$scope.showVisitNo=false;$scope.pmExtVisitNo=$scope.visitNo}else{$scope.visitNo=$scope.pmExtVisitNo}};$scope.scanDocuments=function(){$scope.documentListUrlAppt="";var strRefId='';if($scope.patientId!=="0")strRefId=$scope.patientId;$scope.patientFullName=$scope.ptName;var pncatId=0,itemId=0;$scope.strCaption="Patient Documents("+$scope.patientFullName+")";$ocLazyLoad.load({name:'ptdocListModule',files:["/mobiledoc/jsp/webemr/toppanel/patientdoclist/patientdocList.js","/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/EncDetailsService.js","/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js"]}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/patientdoclist/patientdocList.jsp?ReportId="+strRefId+"&patientId="+$scope.patientId+"&DocType=chart_doc&EncounterId="+$scope.encounterId+"&pncatId="+pncatId+"&pnitemId="+itemId+"&TrUserId="+global.TrUserId+"&nd="+(new Date).getTime());$scope.documentListUrlAppt=url},function(e){})};$scope.refreshDocCount=function(docCount,pnitemId){};$scope.Dialog={width:'750px'};$scope.getWidth=function(){return $scope.Dialog};$scope.onChangeNb=function(){$scope.apptForm.$setDirty();if($scope.isNonBillable){if($scope.isDisableApptNonBillable){$scope.isNonBillable=true}else{newAppointmentFnNameSpace.confirmDialog("Marking this encounter as non-billable will prevent claims from being created for this encounter. Are you sure you want to mark this encounter as non-billable?",'bluetheme',function(result){if(result){$scope.$apply(function(){$scope.isNonBillable=true})}else{$scope.$apply(function(){$scope.isNonBillable=false})}},"Appointment Details - Mark Encounter as Non-Billable")}}};$scope.EnableOrDisableContextSensitiveButton=function(keyName,toottipmsg,butid,isMedicalDevice){var session=cookie.split("=");var data=getDeviceCompatibilityCheckValue(keyName,"",toottipmsg,isMedicalDevice);if(data!=""&&!angular.isUndefined(data)){var res=data.split(",");switch(keyName){case"winprojecte":if(res[0]=="true")$scope.disableBubbleShts=false;else $scope.disableBubbleShts=true;break;case"eclinicforms":if(res[0]=="true")$scope.disableEclinic=false;else $scope.disableEclinic=true;break}if(res[0]=="false"){$("#"+butid).attr("title",res[1])}}};$scope.loadPluginOptions=function(tabsel){try{if($scope.eCliniFormsWebOnly()){if(newAppointmentFnNameSpace.checkIfEmpty($scope.patientDtls.patient.id)){showMessage('Please select a patient','ptLookup');$('#ptLookup').focus();return}$ocLazyLoad.load({name:'eCliniFormModule',files:['/mobiledoc/jsp/webemr/toppanel/eCliniForm/eCliniFormController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/eCliniForm/eCliniFormScrn.jsp?patientId='+$scope.patientId+'&encounterId='+$scope.encounterId+'&patientName='+$scope.ptName+'&nd='+(new Date).getTime());$scope.patientinfohuburlAppt=url},function(e){})}else{launchPlugin('id=ECLINICFORMS|patientId='+$scope.patientId+'|enc_id='+$scope.encounterId)}}catch(err){}};$scope.cancelECFormView=function(){$scope.patientinfohuburlAppt=""};$scope.checkInsEligibilityAppt="";$scope.checkBillingNoteData=function(){getItemKeyValuePair("GlobalContextEligibilityUpdateBillingNotes",item);if(item.isExists&&item.itemId>0&&item.itemId==="1"){var BillingNotesModified=_.isEqual($scope.oldEncounterData.billing,$scope.billingNotes);if(!BillingNotesModified){$scope.checkBillngNoteDataConfirmation()}else{$scope.getEligibilityReport()}}else{$scope.getEligibilityReport()}};$scope.checkBillngNoteDataConfirmation=function(){newAppointmentFnNameSpace.confirmDialogWithHtmlMsg("Insurance Eligibility verification will overwrite the currently added/updated 'Billing Notes'.<br/>Click 'Yes' to save the 'Billing Notes' and open the 'Insurance Eligibility' verification screen.<br/> Click 'No' to open the 'Insurance Eligibility' verification screen without saving 'Billing Notes'.",'bluetheme',function(result){if(result){$scope.saveBillingNoteData()}else{$scope.getEligibilityReport()}},true,"Billing Note Update Confirmation")};$scope.saveBillingNoteData=function(){var url=makeURL("/mobiledoc/jsp/webemr/scheduling/setApptBillingNotes.jsp");$.ajax({url:url,type:"POST",data:{encid:$scope.encounterId,BillingNoteOld:$scope.oldEncounterData.billing,BillingNoteNew:$scope.billingNotes},"async":false,success:function(data){$scope.oldBillingNote=$scope.billingNotes;$scope.getEligibilityReport()}})};$scope.getEligibilityReport=function(){var strUrl=makeURL("/mobiledoc/jsp/webemr/webpm/eligibility/EligibilityReportSummary.jsp?insuranceId=0&patientId="+$scope.patientId+"&encounterId="+$scope.encounterId+"&callfrom=&insResponse=A&checkEligibilityAll=true");$ocLazyLoad.load({name:'eRsummaryModule',files:['/mobiledoc/jsp/webemr/webpm/eligibility/js/eRsummaryCtrl.js']}).then(function(){$scope.checkInsEligibilityAppt="";$scope.checkInsEligibilityAppt=strUrl},function(e){})};$scope.webEnablePatient=function(optout){var uname=$("#uname").val();var email=$scope.ptEmail;var doNotWebEnable=0;$scope.err_msg_optout="";if($("#_donotwebenable").is(':checked')){doNotWebEnable=1}if(uname.length<7&&(optout==0||optout==undefined||typeof optout=="undefined")){$scope.err_msg1="Username should be greater than 7 characters";$("#uname").focus();return false}else if(!email||!$scope.validateEmail(email)){if(optout===1){if(doNotWebEnable===0){$scope.err_msg_optout="Please enter a valid email address.";return false}}else{$scope.err_msg1="Please enter a valid email address.";$("#emailid1").focus();return false}}if(optout===1&&doNotWebEnable===1){var optoutreason=$("#optReason").val();if(!optoutreason){$scope.err_msg_optout="Please select reason for not web enabling.";$("#optReason").focus();return false}}var result=appointmentService.saveMuAlertData($scope.ptEmail,$scope.patientId,uname,optout);if(result==0){$scope.closeWebEnableDailog(optout);if($scope.teleVisitCodesIds!==undefined&&$scope.teleVisitCodesIds!==null&&$scope.teleVisitCodesIds.length>0&&$scope.teleVisitCodesIds.indexOf(parseInt($scope.appointmentVisitType.CodeId,10))>=0){validateWebEnableSuccess()}else{$scope.onSaveAppt()}}else{if(optout===1){$scope.closeWebEnableDailog(optout);$scope.opemMUCaptuer()}}};$scope.eCliniFormsWebOnly=function(){var data=getDeviceCompatibilityCheckValue("eclinicforms","","","");if(data!=""&&!angular.isUndefined(data)){var res=data.split(",");if(res[0]=="true")return false;else return true}};$scope.closeWebEnableDailog=function(optout){if(optout==1){$('#_emailexist_scnd_optout').modal('hide')}else{$('#_emailexist_scnd').modal('hide')}};$scope.disableBubbleShts=true;$scope.disableEclinic=true;$scope.EnableOrDisableContextSensitiveButton("eclinicforms","Please use browser plug-in for this functionality.","btneClinicFrms",false);$scope.bextFlag=false;$scope.ptApptReminderNewAppt="";$scope.openPatientReminder=function(){$scope.getReminderList();var startDate=$scope.getStartDate();var nextAppt=$scope.nextApptLabel.toString();var color=$scope.appointmentVisitType.color;if(typeof $scope.reminderListArray!='undefined'&&$scope.reminderListArray.length>0){$scope.ptApptReminderNewAppt="";$ocLazyLoad.load({name:'reminderListApp',files:['/mobiledoc/jsp/webemr/scheduling/js/reminderList.js'],cache:false}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/scheduling/reminderList.jsp?reminderData='+JSON.stringify($scope.reminderListArray)+'&encounterId='+$scope.encounterId+'&ptId='+$scope.patientDtls.patient.id+'&patientName='+$scope.ptName+'&ptDob='+$scope.ptDob+'&ptTel='+$scope.ptTel+'&ptEmail='+$scope.ptEmail+'&address='+$scope.address+'&providerId='+$scope.appointmentProvider.providerId+'&providerName='+$scope.appointmentProvider.providerName+'&nextVisit='+nextAppt+'&visittype='+$scope.appointmentVisitType.Name+'&startDate='+$scope.getStartDate()+'&facilityId='+$scope.facilityId+'&facilityName='+$scope.facility1.facility.Name+'&visitTypeColor='+color);$scope.ptApptReminderNewAppt=url},function(e){})}else{$scope.ptApptReminderNewAppt="";$ocLazyLoad.load({name:'apptReminderModule',files:['/mobiledoc/jsp/webemr/scheduling/js/apptReminderController.js'],cache:false}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/scheduling/ApptReminder.jsp?encounterId='+$scope.encounterId+'&ptId='+$scope.patientDtls.patient.id+'&patientName='+$scope.ptName+'&ptDob='+$scope.ptDob+'&ptTel='+$scope.ptTel+'&ptEmail='+$scope.ptEmail+'&address='+$scope.address+'&providerId='+$scope.appointmentProvider.providerId+'&providerName='+$scope.appointmentProvider.providerName+'&nextVisit='+nextAppt+'&visittype='+$scope.appointmentVisitType.Name+'&startDate='+$scope.getStartDate()+'&facilityId='+$scope.facilityId+'&facilityName='+$scope.facility1.facility.Name+'&visitTypeColor='+color);$scope.ptApptReminderNewAppt=url},function(e){})}};$scope.getClassForStructureData=function(){return $scope.stClass};$scope.colorForCaseButton={'color':'black'};if($scope.ikEnableCaseManager){$scope.colorForCaseButton.color='blue'}else{$scope.colorForCaseButton.color='black'}$scope.getClassForCaseManager=function(){return $scope.colorForCaseButton};$scope.consentEhxPopup=function(autoExport){var isExported=false;var isremindertime="";var showEhxPopup=false;var patientid=$scope.patientId;var data={pid:patientid};var url="/mobiledoc/jsp/empi/consent/afterConsentRemindDate.jsp";$scope.newpopUpUrlAppt="";if(patientid>0){var promiseEhxData=getPromiseForPtEhxData(patientid,global.TrUserId,'consentReceived',"patientHub");promiseEhxData.then(function(result){if(result=='false'){var ehxDown=appointmentScopeGlobalVariables.strEhxDown;if(ehxDown&&ehxDown.contains("ehx-down:")){var ehxDownErrMsg=ehxDown.split('ehx-down:')[1];ecwAlert(ehxDownErrMsg,defaultAlertTitle)}else{var promiseConsent=ehxCommonFuncsGetPromiseForAjax(url,data);promiseConsent.then(function(response){isremindertime=$.trim(response);if(isremindertime=="after"){$ocLazyLoad.load({name:'ehxConsent',files:['/mobiledoc/jsp/webemr/empi/consent/js/PatientConsentCtrl.js','/mobiledoc/jsp/catalog/xml/keywords/js/ecw-keywords.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/empi/consent/ptConsentDecision.jsp?pid="+patientid+"&userId="+global.TrUserId+"&empi_DemograhicsExportMandatory="+autoExport+"&consentType=0&nd="+(new Date).getTime());$scope.newpopUpUrlAppt=url},function(e){ecwAlert("Error "+e,defaultAlertTitle)})}},function(errorMsg){showMessage("Error connecting EHX server, Please try again later.")})}}})}};$scope.optinPatientForEhx=function(){$scope.newpopUpUrlAppt="";$ocLazyLoad.load({name:'ehxConsent',files:['/mobiledoc/jsp/webemr/empi/consent/js/PatientConsentCtrl.js','/mobiledoc/jsp/catalog/xml/keywords/js/ecw-keywords.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/empi/consent/ptConsentDecision.jsp?pid="+$scope.patientId+"&userId="+global.TrUserId+"&consentType=0&nd="+(new Date).getTime());$scope.newpopUpUrlAppt=url},function(e){ecwAlert("Error "+e,defaultAlertTitle)})};$scope.openPtLvFromEhx=function(){$scope.newpopUpUrlAppt="";if(encid==undefined||encid==""){encid=0}$scope.newpopUpUrlAppt=openPtLv($scope.patientId,global.TrUserId,encid,'newAppointment','ptDataAtEhxRightPanel')};$scope.loadAcuityForm=function(){if($scope.encounterId==="0"){ecwAlert("Please save the appointment to launch the acuity form",defaultAlertTitle);return false}$ocLazyLoad.load({name:'Acuity',files:['/mobiledoc/jsp/webemr/scheduling/js/acuityController.js']}).then(function(){$scope.patientinfohuburlAppt="";var url=makeURL('/mobiledoc/jsp/webemr/scheduling/acuityFom.jsp?encounterId='+$scope.encounterId+'&appointmentDate='+$scope.StDate+'&patientName='+encodeURIComponent($scope.ptName)+'&providerName='+encodeURIComponent($scope.appointmentProvider.providerName));$scope.patientinfohuburlAppt=url},function(e){})};$scope.initStructuredCustom=function(){$("#apptActionModalMainId").modal('hide');$scope.actions.apptAction=1;var initStructCustomData={structCustomCatId:0,structCustomItemId:$scope.structdataItemId,structDataTableType:"structApptBillingNotes"};var structCustomUrl="/mobiledoc/jsp/webemr/progressnotes/structuredata-config-container.jsp";$ocLazyLoad.load({name:"configStructuredcontainer",files:["/mobiledoc/jsp/webemr/progressnotes/structuredata-config-container.js","/mobiledoc/jsp/webemr/templates/structuredata-config-tpl.js"],cache:true}).then(function(){var customStructModalInstance=$modal.open({templateUrl:makeURL(structCustomUrl),controller:'ConfigStructContainerController',windowClass:'app-modal-window bluetheme',backdrop:"static",resolve:{initStructCustomData:function(){return initStructCustomData}}});customStructModalInstance.result.then(function(responseObj){},function(responseObj){$scope.closeConfigStructForm()})},function(e){})};$scope.closeConfigStructForm=function(){$scope.showStructDataForBillingNotes()};$scope.enableApptRightPanel=false;$scope.paymentShow=false;if(getItemKeyValue("enableApptRightPanelHealow").toLowerCase()=="yes"){$scope.enableApptRightPanel=true}else{$scope.enableApptRightPanel=false}var webportal=0;var strMessengerEnable="no";$scope.bwebportalEnabled=false;$scope.bIsKioskEnabled=false;$scope.bIsMessengerEnabled=false;var item={itemId:0,keyValue:'',isExists:false};function resetItemObj(){item={itemId:0,keyValue:'',isExists:false}}resetItemObj();getItemKeyValuePair("EnableWebPortal",item);if(item.isExists&&item.itemId>0&&item.itemId==="1"){$scope.bwebportalEnabled=true;webportal=1}resetItemObj();getItemKeyValuePair("PreRegisterKiosk",item);if(item.isExists&&item.itemId>0&&item.keyValue==="1"){$scope.bIsKioskEnabled=true;webportal=1}resetItemObj();getItemKeyValuePair("EnableVoiceInterface",item);if(item.isExists&&item.keyValue.toLowerCase()=="yes"){$scope.bIsMessengerEnabled=true;strMessengerEnable="yes"}$scope.isDentalEnabled=false;resetItemObj();getItemKeyValuePair("EnableDentalEMR",item);if(item.isExists&&item.keyValue.toLowerCase()=="yes"&&item.itemId==="2"){$scope.isDentalEnabled=true}$scope.RightPanelInfo=getPatientRightPanelInfo();function getPatientRightPanelInfo(){if($scope.enableApptRightPanel==true&&pid!=''&&pid!='undefined'&&pid>0){var serverUrl=makeURL('/mobiledoc/jsp/webemr/scheduling/rightPanelHealowDetails.jsp?uid='+pid+'&nEncId='+encId+'&dataRequestedFrom=forDisplay');var preparePatientData=urlGet(serverUrl);if(preparePatientData!=null||preparePatientData!=undefined){preparePatientData=preparePatientData.trim()}var arrPatientData=JSON.parse(preparePatientData);var lastLogins='',demo='',status='';angular.forEach(arrPatientData,function(value,key){angular.forEach(value,function(value,key){if(key=='lastLogin'){var date;$scope.lastLogin=value;if(value.lastLoginaccessTime!="NA"&&value.lastLoginaccessTime!=undefined){var t=value.lastLoginaccessTime.split(/[- :]/);date=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])}if(date!="NA"&&date!=undefined){var dateF=new Date(date);var dd=dateF.getDate();if(dd<10){dd='0'+dd}var mm=dateF.getMonth()+1;if(mm<10){mm='0'+mm}var d=mm+'/'+dd+'/'+dateF.getFullYear();var hours=dateF.getHours();var minutes=dateF.getMinutes();var ampm=hours>=12?'pm':'am';hours=hours%12;hours=hours?hours:12;minutes=minutes<10?'0'+minutes:minutes;$scope.lastLoginaccessTime=d}}else if(key=='demographicsUpdate'){$scope.demographicsUpdate=value}else if(key=='QuestData'){$scope.QuestData=value}else if(key=='scannedDocuments'){$scope.scannedDocs=value}else if(key=='hastracker'){$scope.hastracker=value}else if(key=='payments'){for(var i=0;i<value.length;i++){if(value[i].addInfo==encFacId){$scope.paymentShow=true}}$scope.payments=value}else if(key=='consentForms'){$scope.consentForms=value;for(var i=0;i<value.length;i++){var date;var val=value[i].updatedOn;if(val!="NA"&&val!=undefined){$scope.updatedOn=yyyymmddTommddyyyy(val)}}}})})}}$scope.yyyymmddTommddyyyy=function(date){var dateArray="";if(date!=undefined){if(date.indexOf("/")>-1){dateArray=date.split("/")}else if(date.indexOf("-")>-1){dateArray=date.split("-")}if(dateArray.length!=3){return""}if(dateArray[2].length==4){return dateArray[0]+"/"+dateArray[1]+"/"+dateArray[2]}return dateArray[1]+"/"+dateArray[2]+"/"+dateArray[0]}return dateArray};$scope.loadDocumentView=function(docId){$ocLazyLoad.load({name:'documentViewModule',files:['/mobiledoc/jsp/webemr/jellybean/reviewdocs/documentView.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/jellybean/reviewdocs/documentView.jsp?navigate=no&leftPanel=1&toprightPanel=0&docId="+docId+"&patientId="+pid+"&encounterId=0&nd="+(new Date).getTime());$scope.documentViewPortal=url},function(e){ecwAlert("Error occured while loading document detailed view. Error : "+e,defaultAlertTitle)})};$scope.cancelDocumentView=function(){$('#wholeClass2').css({"height":"635px"})};$scope.getDetailView=function(encounterId){$scope.documentViewPortal='';var serverURL=makeURL('/mobiledoc/jsp/webemr/scheduling/rightPanelHealowDetails.jsp?pid='+pid+'&encounterId='+encounterId+'&dataRequestedFrom=forTelEnc');var patientData=urlGet(serverURL);if(patientData!=null||patientData!=undefined){patientData=patientData.trim()}var telEncData=JSON.parse(patientData);var etype=telEncData.eType;var ptReason=telEncData.ptReason;if(typeof etype==="undefined"){etype="2"}$ocLazyLoad.load({name:'TJellyDetailView',files:getDependencies('TJellyDetailView')}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/telephoneencounter/JellyBeanT-Telephone-Encounter-DetailView.jsp?EncounterId='+encounterId+'&TrUserId='+global.TrUserId+'&PatientId='+pid+'&enctype='+etype+'&index=-1&parentfunctionname=getDetailView&context=TelEncAppt'+'&enabledMessenger='+strMessengerEnable+'&enabledWebPortal='+webportal+'&ptReason='+ptReason+'&nd='+(new Date).getTime();url=makeURL(url);$scope.telepopupurlPortal=url},function(e){})};$scope.viewQuestDoc=function(docId,docType,docName,docPagenum,docCount){$rootScope.loadOnce=false;$scope.documentView='';$ocLazyLoad.load({name:'QuestionnaireImport',files:getDependencies('concurrencyAlertsProvider').concat(['/mobiledoc/jsp/webemr/portal/questImport.js','/mobiledoc/jsp/webemr/js/jellybean.js'])}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/healowhub/healowhub.jsp?uid="+pid+"&userid="+global.TrUserId+"&encid="+encId+"&docId="+docId+"&docType="+docType+"&docName="+docName+"&docPagenum="+docPagenum+"&docCount="+docCount+"&selectedTab=questionnaire&nd="+(new Date).getTime());$scope.questpopupPortal=url},function(e){})};$scope.paymentCollectedView=function(paymentId){var param={paymentId:paymentId,parentScreen:'newApptController',patientId:pid};loadReceivePayment($ocLazyLoad,$modal,param)};$scope.closemodal=function(modalname){var modalId="#"+modalname;$(modalId).modal('hide')};$scope.openProgressNoteOnSaveAppt=function(encId,visitId,patId,visitStatus){if(checkCancelledCode(visitStatus)){var msg="Progress Notes cannot be viewed for cancelled status/non-billable visit.";ecwAlert(msg,defaultAlertTitle)}else{var encounterId=encId;document.getElementById("dvApptLoader").style.display="block";updatePatientSearchHistory(patId,$scope.ptName);doChecksForPN(encounterId,patId,$http,'dvApptLoader')}};$scope.visitStatusChange=function(){$scope.isVisitStatusChanged=true;$scope.apptForm.$setDirty();if($scope.empiEnabled&&$scope.appointmentVisitStatus.code&&$scope.appointmentVisitStatus.code==="ARR"){var strConsenttoView=getEhxItemKeyValue('CommunityConsentType').toLowerCase();var autoOptin=getItemKeyValue("EmpiAutoOptinUponArrival");if((isItemKeyEnabled("Empi3rdPartyPortal")||isItemKeyEnabled("EmpiSingleEmr"))&&getEhxItemKeyValue('PopupConsentWhenArrivePt')!==true){return}if('view'===strConsenttoView||'disclose'===strConsenttoView||'yes'===autoOptin.toLowerCase()){$scope.consentEhxPopup(true)}else{$scope.consentEhxPopup(false)}}if(getItemKeyValue('HCLChanges').toLowerCase()=='yes'&&$scope.appointmentVisitStatus.codeId==2){$scope.showCancellationReason=true;$scope.cancellationReason=cancellationReason!='null'?cancellationReason:""}else{$scope.showCancellationReason=false;$('#cancReason').val("")}};$scope.visitStatusCheck=function(){var bValid=true;if(!$scope.permissionForApptVisitStatus&&$scope.appointmentVisitStatus.NonBillable=="1"){showMessage('You do not have a permission to change the visit status to '+$scope.appointmentVisitStatus.code+' (Non-Billable).Please contact your administartor');$scope.setVisitStatus($scope.appointmentSelectedVisitStatus);bValid=false}else if($scope.appointmentVisitStatus.NonBillable=="1"&&$scope.isEncounterLocked){showMessage('The encounter is locked. Please select billable visit status code.',"visitStsCombo");bValid=false}else if($scope.encounterId>0&&$scope.appointmentVisitStatus.NonBillable=="1"&&$scope.paymentCount>0){showMessage('The encounter has associated claim(s)/payment(s). Please select billable visit status code.',"visitStsCombo");bValid=false}return bValid};$scope.setVisitStatus=function(status){if(status){$scope.appointmentVisitStatus.code=status}else{$scope.appointmentVisitStatus.code="PEN"}};$scope.loadCheckout=function(){if(newAppointmentFnNameSpace.checkIfEmpty($scope.encounterId)){$scope.createAppointment(10)}else{$ocLazyLoad.load({name:'saleApp',files:['/mobiledoc/jsp/webemr/inventory/sale.js']}).then(function(){$scope.newpopUpUrlAppt=makeURL('/mobiledoc/jsp/webemr/inventory/sale.jsp?ptId='+$scope.patientId+'&encId='+$scope.encounterId)},function(e){})}};$scope.closeSaleLink=function(){$scope.newpopUpUrlAppt=null};$scope.pagerData=[];$scope.providerPagerData=[];$scope.pageInterval=[];$scope.usediffpager=false;$scope.selectedPagerCode="";$scope.selectedPagerInterval="";$scope.pagerGivenAt="";$scope.pagingTime="0";$scope.pagermsg="";$scope.pagerStatusDesc="";$scope.ppagermsg="";$scope.initCapCode="";$scope.initInterval=[];$scope.pagerStatus="Pager Status";$scope.machinename="";$scope.PagerVendor="";$scope.cancelPagingBtn=false;$scope.allowSendingPageToPatient=appointmentScopeGlobalVariables.allowSendingPageToPatient;$scope.allowSendingPageToProviders=appointmentScopeGlobalVariables.allowSendingPageToProviders;$scope.apptMiscCustomization=appointmentScopeGlobalVariables.apptMiscCustomization;$scope.patientPagingTabActive=true;$scope.isPagerInitialised=false;$scope.setPagerTime=function(){if($scope.pagerGivenAt==""){$scope.pagerGivenAt=moment().format("hh:mm:ss")}$scope.pagingTime=moment().format("hh:mm:ss")};$scope.getMachineName=function(){var strUrl="/mobiledoc/jsp/webemr/menu/emr/configuration/deviceconfiguration/getDevicesConfiguration.jsp?";strUrl=strUrl+"id="+"getMachineName";strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){$scope.machinename=strContentData.trim()}};$scope.getPagerVendor=function(){var strUrl="/mobiledoc/jsp/webemr/menu/emr/configuration/deviceconfiguration/getDevicesConfiguration.jsp?";strUrl=strUrl+"id="+"getPagerVendor";strUrl=strUrl+"&facId="+$scope.facilityId;strUrl=strUrl+"&modality="+"Pager";strUrl=strUrl+"&macname="+$scope.machinename;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){$scope.PagerVendor=strContentData.trim()}};$scope.loadInitializedPager=function(){strUrl="/mobiledoc/jsp/catalog/xml/selectPagerNumberAndIntervalDesc.jsp?EncounterID="+$scope.encounterId;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData).Envelope.Body['return'].resultset.data.row;if(jsond===undefined){}else{$scope.pagerStatusDesc=jsond.StatusDesc;if($scope.pagerStatusDesc==='Cancelled'){}else{$scope.pagermsg=jsond.PagerTextMsg;$scope.initCapCode=jsond.SelectedPagerNumber;$scope.pagerData=[{"CapCode":$scope.initCapCode,"PagerID":jsond.PagerID,"PagerType":jsond.PagerType}];$scope.selectedPagerCode={inidata:$scope.pagerData[0]};$scope.pagerGivenAt=jsond.PagerGivenAt;$scope.pagingTime=jsond.PagingTime;var errorLog=jsond.ErrorLog;$scope.cancelPagingBtn=true;$scope.isPagerInitialised=true}}}};$scope.initializePager=function(){var checkPagerFieldsLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_schedulepager","sendPageID","bluetheme");if(checkPagerFieldsLength){if($scope.selectedPagerCode.inidata.CapCode=="NA"){ecwAlert("Invalid Pager ID",defaultAlertTitle,null,"","bluetheme")}else{$scope.setPagerTime();var xmlWriter=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xmlWriter);xmlWriter.writeStartElement('Item');xmlWriter.writeAttributeString('xsi:type','xsd:string');addElement(xmlWriter,"patientid",$scope.patientId,'xsi:type','xsd:string');addElement(xmlWriter,"encounterid",$scope.encounterId,'xsi:type','xsd:string');addElement(xmlWriter,"facilityid",$scope.facilityId,'xsi:type','xsd:string');addElement(xmlWriter,"capcode",$scope.selectedPagerCode.inidata.CapCode,'xsi:type','xsd:string');addElement(xmlWriter,"pagergivenat",$scope.pagerGivenAt,'xsi:type','xsd:string');addElement(xmlWriter,"pagingtime",$scope.pagingTime,'xsi:type','xsd:string');addElement(xmlWriter,"userid",global.TrUserId,'xsi:type','xsd:string');addElement(xmlWriter,"pagermsg",$scope.pagermsg,'xsi:type','xsd:string');addElement(xmlWriter,"StatusDesc","",'xsi:type','xsd:string');xmlWriter.writeEndElement();endSoapPacket(xmlWriter);strUrl=makeURL("/mobiledoc/jsp/catalog/xml/InitialisePager.jsp");$http({headers:{"Content-Type":"application/x-www-form-urlencoded"},method:'POST',url:strUrl,data:"FormData="+xmlWriter.flush()}).success(function(response){var jsonObject=x2js.xml_str2json(response);if(jsonObject.Envelope.Body["return"].status=="success"){$('.dropup').removeClass('open');$scope.cancelPagingBtn=true;$scope.isPagerInitialised=true;$scope.loadPagerStatus()}else{$('.dropup').removeClass('open');$scope.cancelPagingBtn=false;$scope.isPagerInitialised=false}})}}};$scope.cancelPaging=function(){strUrl="/mobiledoc/jsp/catalog/xml/CancelPaging.jsp?EncounterID="+$scope.encounterId;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);if(!angular.equals(strContentData,"")&&!angular.equals(strContentData,null)&&!angular.equals(strContentData,"null")){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);if(jsond.Envelope.Body["return"].status==="success"){$scope.cancelPagingBtn=false;$scope.isPagerInitialised=false;$('.dropup').removeClass('open')}}};$scope.loadDefaultFacility=function(){if($scope.facilityId.length==0){strUrl="/mobiledoc/jsp/catalog/xml/LoadUserProfile.jsp?UserId="+global.TrUserId;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);$scope.facilityId=jsond.Envelope.Body['return'].resultset.data.row.FacilityId}}};$scope.loadPagerStatus=function(){var batch=[];batch.push({url:makeURL('/jsp/catalog/xml/getPagerStatus.jsp?EncounterID='+$scope.encounterId),success:function(strContentData){strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);$scope.pagerStatus=jsond.Envelope.Body['return'].items.item.pager_status}}});batchAjaxService.batchAjax(batch)};$scope.loadPagerData=function(){$scope.checkActiveTab();$scope.ppagermsg=patientName+" is here for the "+$scope.appointmentStartTime.time+" appt";$scope.loadDefaultFacility();$scope.getMachineName();$scope.getPagerVendor();$scope.loadInitializedPager();if($scope.pagerData.length==0){strUrl="/mobiledoc/jsp/catalog/xml/getPagerNumberData.jsp?FacilityID="+$scope.facilityId;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);$scope.pagerData=returnDataArray(jsond.Envelope.Body['return'].resultset.data.row);if($scope.pagerData===undefined||$scope.pagerData.length==0){$scope.pagerData=[{"CapCode":"NA","PagerID":"NA","PagerType":"NA"}]}else{$scope.selectedPagerCode={inidata:$scope.pagerData[0]}}}}if($scope.providerPagerData.length==0){strUrl="/mobiledoc/jsp/catalog/xml/getPagerNumberDataForProvider.jsp?FacilityID="+$scope.facilityId;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);$scope.providerPagerData=returnDataArray(jsond.Envelope.Body['return'].resultset.data.row);if($scope.providerPagerData===undefined||$scope.providerPagerData.length==0){$scope.providerPagerData=[{"CapCode":"NA","PagerID":"NA","PagerType":"NA"}]}$scope.selectedProviderPagerCode={inidata:$scope.providerPagerData[0]}}}};$scope.checkActiveTab=function(){if(!$scope.allowSendingPageToPatient&&!$scope.allowSendingPageToProviders){$("#newAppointmentBtn16").hide();$("#initpagerbtn").hide();$scope.cancelPagingBtn=false}if($scope.allowSendingPageToPatient&&$scope.patientPagingTabActive){$("#newAppointmentBtn16").show();$("#initpagerbtn").show();if($scope.isPagerInitialised===true){$scope.cancelPagingBtn=true}$scope.PagerActiveTab.bPatientTabIsActive=true;$scope.PagerActiveTab.bProviderTabIsActive=false}else if(!$scope.allowSendingPageToPatient&&$scope.patientPagingTabActive){$("#newAppointmentBtn16").hide();$("#initpagerbtn").hide();$scope.cancelPagingBtn=false}if($scope.allowSendingPageToProviders&&!$scope.patientPagingTabActive){$("#newAppointmentBtn16").show();$("#initpagerbtn").hide();$scope.cancelPagingBtn=false;$scope.PagerActiveTab.bPatientTabIsActive=false;$scope.PagerActiveTab.bProviderTabIsActive=true}else if(!$scope.allowSendingPageToProviders&&!$scope.patientPagingTabActive){$("#newAppointmentBtn16").hide();$("#initpagerbtn").hide();$scope.cancelPagingBtn=false}};$scope.LoadActiveTab=function(){if($('.active.tab-pane').hasClass('PatientTab')){$scope.PagerActiveTab.bPatientTabIsActive=true;$scope.PagerActiveTab.bProviderTabIsActive=false}else{$scope.PagerActiveTab.bPatientTabIsActive=false;$scope.PagerActiveTab.bProviderTabIsActive=true}};$scope.PageNow=function(cookie,encId,encDate,patientId){var checkPagerFieldsLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_schedulepager","sendPageID","bluetheme");if(checkPagerFieldsLength){var token=encodeURIComponent(csrfToken);$scope.cookie=cookie;var UrlDeviceName="pager";var UrlTestType=$scope.PagerVendor;var TrUserId=global.TrUserId;var Capcode=0;var PagerId=0;var PagerType="";var encFacId=$scope.encFacId;var PagerMsg="";if($scope.PagerActiveTab.bPatientTabIsActive==true){Capcode=$scope.selectedPagerCode.inidata.CapCode;PagerId=$scope.selectedPagerCode.inidata.PagerID;PagerType=$scope.selectedPagerCode.inidata.PagerType;PagerMsg=$("#pagermsg").val()}if($scope.PagerActiveTab.bProviderTabIsActive==true){Capcode=$scope.selectedProviderPagerCode.inidata.CapCode;PagerId=$scope.selectedProviderPagerCode.inidata.PagerID;PagerType=$scope.selectedProviderPagerCode.inidata.PagerType;PagerMsg=$("#ppagermsg").val()}var deviceparam="DeviceParams="+encodeURIComponent(getDeviceParamsForPager(UrlDeviceName,UrlTestType,global.TrUserId,encFacId,patientId,encId,encDate,Capcode,PagerId,PagerType,PagerMsg));$scope.RefreshButton=true;try{launchPlugin('id=pager|DeviceType='+UrlTestType+'|facilityId='+encFacId+'|encId='+encId+'|encDate='+encDate+'|patientId='+patientId+'|CapCode='+Capcode+'|PagerID='+PagerId+'|PagerMsg='+PagerMsg+'|userId='+encodeURIComponent(TrUserId)+'|'+deviceparam)}catch(err){}}};function getDeviceParamsForPager(devicename,modality,uid,encFacId,patientId,encId,encDate,CapCode,PagerID,PagerType,PagerMsg){var newxml="<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>";newxml+="<SOAP-ENV:Envelope xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:xsd=\"http://www.w3.org/1999/XMLSchema\" xmlns:xsi=\"http://www.w3.org/1999/XMLSchema-instance\"><SOAP-ENV:Body><return><Document><UserId>"+escapeHtml(uid)+"</UserId><ItemType>"+escapeHtml(modality)+"</ItemType><DeviceName>"+escapeHtml(devicename)+"</DeviceName><facilityId>"+escapeHtml(encFacId)+"</facilityId><patientId>"+escapeHtml(patientId)+"</patientId><server>"+escapeHtml(window.location.host)+"</server><encId>"+escapeHtml(encId)+"</encId><encDate>"+escapeHtml(encDate)+"</encDate><CapCode>"+escapeHtml(CapCode)+"</CapCode><PagerID>"+escapeHtml(PagerID)+"</PagerID><PagerType>"+escapeHtml(PagerType)+"</PagerType><PagerMsg>"+escapeHtml(PagerMsg)+"</PagerMsg></Document></return></SOAP-ENV:Body></SOAP-ENV:Envelope>";return newxml}var x2js=new X2JS;$scope.getClaimId=function(){if($scope.encounterId<=0){ecwAlert("Please select valid encounter and try again.",defaultAlertTitle);return false}var url=makeURL("/mobiledoc/jsp/catalog/xml/CheckClaimForEnc.jsp?encounterId="+$scope.encounterId);sendRequest("POST",url,"",resCheckClaimForEnc)};var resCheckClaimForEnc=function(result){if(!angular.isUndefined(result.status)&&result.status=="success"){if(!angular.isUndefined(result.claimId)){var m_claimId;if($.trim(result.claimId).length>0&&!isNaN(result.claimId)){m_claimId=result.claimId}if(m_claimId>0){var param={claimId:m_claimId,parentScreen:'newAppointment',encounterId:$scope.encounterId,patientId:patientId};loadHCFAClaim($ocLazyLoad,$modal,param,$scope)}else{$scope.handleCreateClaim()}}}else{ecwAlert("An error occurred while getting claimId for encounter.",defaultAlertTitle);return false}};var sendRequest=function(type,url,formData,callbackFunc){var req=$http({method:type,url:url,data:formData,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).then(function(result){var conjson=convertInJSON(result.data);if(conjson!=null){var value=conjson.Envelope.Body['return'];if($.trim(callbackFunc).length>0){callbackFunc(value)}}else{ecwAlert("Error in getting data from server side.",defaultAlertTitle)}})};$scope.handleCreateClaim=function(){var claimtype=0;var disableLicenseVarification=getItemKeyValue("DisableLicenseVerification");if(disableLicenseVarification&&disableLicenseVarification.toUpperCase()=="NO"){var clServiceDate=angular.copy($scope.StDate);if(isDTPLoop2400ValidateDate(clServiceDate,"Encounter Date")){clServiceDate=getYYYYMMDD(clServiceDate);var bValid=false;bValid=IsLicensedFeatureValid($scope._ProviderId,clServiceDate);if(!bValid){ecwAlert("License is Expired.",defaultAlertTitle,"");return}}else{return}}$scope.createEncInv($scope.encounterId,claimtype)};function IsLicensedFeatureValid(pro,dt){return isProviderLicenseValid(pro,dt)}$scope.createEncInv=function(encounterId,type){if(ValidateEncForCOIDMgt(encounterId)==false){ecwAlert("Provider-Facility-Practice is not linked to COID. Claim cannot be created!",defaultAlertTitle);return false}var obj={};obj.EncounterId=encounterId;obj.Type=type;var url=makeURL("/mobiledoc/jsp/catalog/xml/edi/CreateEncInv.jsp");var invId=0;getAjaxResponse(obj,url).success(function(response){var objJson=x2js.xml_str2json(response);if(objJson!=undefined&&objJson.Envelope.Body['return'].status!=undefined){var status=objJson.Envelope.Body['return'].status;if(status.toUpperCase()=="SUCCESS"&&objJson.Envelope.Body['return'].InvId!=undefined){invId=objJson.Envelope.Body['return'].InvId;$scope.claimPagePopup="";var param={claimId:invId,parentScreen:'chargeDetails',encounterId:encounterId,patientId:patientId};loadHCFAClaim($ocLazyLoad,$modal,param,$scope)}}})};var ValidateEncForCOIDMgt=function(lEncId){var validateEncForCOIDMgtFlag=true;var itemKey=getItemKeyValue("EnterpriseDirectory");if(itemKey&&itemKey.toUpperCase()=="YES"){validateEncForCOIDMgtFlag=ValidateEncounterForCOIDManagement(lEncId)}return validateEncForCOIDMgtFlag};var ValidateEncounterForCOIDManagement=function(nEncId){var bValidateEncounterForCOIDManagement=false;var validFlag=isEnterpriseCOIDManagementEnabled();if(!validFlag){bValidateEncounterForCOIDManagement=true;return bValidateEncounterForCOIDManagement}bValidateEncounterForCOIDManagement=false;var strUrl=makeURL("/mobiledoc/jsp/catalog/xml/processEnterpriseDirectory.jsp");var obj={};obj.OpType="VALIDATEENCOUNTER";obj.EncId=nEncId;getAjaxResponse(obj,strUrl).success(function(response){var objJson=convertInJSON(response);if(objJson!=undefined){if(objJson.Envelope.Body['return'].status=="failed"){bValidateEncounterForCOIDManagement=false}else{bValidateEncounterForCOIDManagement=true}}});return bValidateEncounterForCOIDManagement};var isEnterpriseCOIDManagementEnabled=function(){var validFlag=false;var itemKey=GetEnterpriseItemKeyValue("COIDManagementEnabled");if(itemKey&&itemKey=="1"){validFlag=true}return validFlag};function getAjaxResponse(obj,url){var xsrf=$.param(obj);return $.ajax({method:"POST",url:url,data:xsrf,"async":false,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}$scope.compareDates=function(date1,date2){var d1=new Date(date1);var d2=new Date(date2);return d1.getTime()===d2.getTime()};$scope.OnclickCompareEligibility=function(){var url=makeURL("/mobiledoc/jsp/edi/eligibility/compare/compareEligDatawithDemog.jsp?TrUserId="+global.TrUserId+"&EncId="+$scope.encounterId+"&patId="+$scope.patientId+"&InsResp=P&rnd="+(new Date).getTime());$scope.loadApptRightPanelIframeScreen(url,"Eligibility Demographics Comparison",$scope.patientId,"407px","no")};$scope.loadApptRightPanelIframeScreen=function(url,title,patientId,height,scrolling){var strUrl="/mobiledoc/jsp/webemr/scheduling/AppointmentRightPanelFrom.html";$ocLazyLoad.load({name:"ApptRightPanelViewerModule",files:["/mobiledoc/jsp/webemr/scheduling/js/AppointmentRightPanelFromController.js"],cache:true}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL(strUrl),controller:'ApptRightPanelViewerController',windowClass:'app-modal-window bluetheme apptrightpanel-mod',backdrop:"static",keyboard:false,resolve:{resolveData:function(){return{frameUrl:url,frameTitle:title,framePatientId:patientId,frameHeight:height,frameScrolling:scrolling}}}});modalInstance.result.then(function(responseObj){if(responseObj==="Eligibility Demographics Comparison"){$scope.checkEligibilityCompare()}},function(){})},function(e){})};appointmentService.setScope($scope);$scope.$on("$destroy",function(){appointmentService.destoryScope();$scope.showPatientPayment=null;$scope.nextApptLabel=null;$scope.cancelNotes=null;$scope.copyClaimPr=null;$scope.appointmentEndTime=null;$scope.appointmentStartTime=null;$scope.appointmentReason=null;$scope.appointmentResource=null;$scope.appointmentVisitStatus=null;$scope.appointmentVisitType=null;$scope.appointmentVisitSubType=null;$scope.visitTypeChange=null;$scope.reasonChange=null;$scope.appointmentStartTimeChange=null;$scope.visitStatusChange=null;$scope.changeResource=null;$scope.recurrence.rangeStart=null;$("#Appt_startDate").datepicker("destroy");$("#datepicker1").datepicker("destroy");$(".icon-inputcalender").off('click',calendarClickHandler);$templateCache.remove(appointmentScopeGlobalVariables.appointmentTemplateEncryptedUrl);$templateCache.remove(appointmentScopeGlobalVariables.appointmentTemplateURL);$scope.daySel=null;$scope.recurrence.daySel=null;$scope.showPatientPayment=null;$scope.providerForNewAppintment=null;$scope.facilityTimeZone=null;isEnterpriseCOIDManagementEnabled=null;ValidateEncounterForCOIDManagement=null;ValidateEncForCOIDMgt=null;sendRequest=null;resCheckClaimForEnc=null;webportal=0;strMessengerEnable=null;item=null;onGetMiscInfoEdit=null;onErrorDeleteMiscInfo=null;onErrorcreateSaveMiscInfo=null;onErrorcreateSaveMiscInfo=null;onGetMiscInfo=null;backupProviderName=null;backupProviderId=null;errorOnLinkencReferral=null;errorOnUpdateNewEncLog=null;errorOnSaveUserProfile=null;SaveEncStatusCycleTimeError=null;errorOnSaveHl7=null;updateReserveSlotError=null;savePatientWaitTimeError=null;savePtSIUInfoUrlError=null;transmitIndividualOrdersError=null;PtProfileMeasureUrlError=null;onSaveEncStatusCycleTime=null;processClinicalRuleEngineError=null;updateBumpListError=null;appointmentvisitCoPayError=null;appointmentEncLogError=null;NhxUrlError=null;appointmentLogError=null;onSaveUserProfile=null;onErrorCheckForVtRule=null;onSuccessCheckForVtRule=null;onErrorCheckForConflictAppt=null;onSuccessCheckForConflictAppt=null;onErrorCheckForEncAssoc=null;errorOnASAPList=null;getCourtDateError=null;onSuccessGetCourtDate=null;launchAlertModal=null;hasAnyAlertsBatchCheck=null;hasAnyAlerts=null;rpane=null;rightpaneltog=null;parentPtId=null;$scope.panelStatus=null;invid=null;reasonArray=null;dxArray=null;encId=null;encdata=null;startTime=null;endTime=null;id=null;name=null;date=null;parentForm=null;visitType=null;faciltyId=null;schFacilityId=null;encFacId=null;schFacilityName=null;patientId=null;patientName=null;caseDetails=null;reservedSlotId=null;cancellationReason=null;vision=null;refreshRegDashBoardOnclose=null;encType=null;encType=null;referralXml=null;referralStatusXml=null;paymentXml=null;claimPaymentCount=null;nextApptDetails=null;strXmlForAnnualNotes=null;strXmlForTotalCharges=null;strXmlForLog=null;facilityArray=null;schedulefacilityFilter=null;strRxHubContent=null;strRxEligiErrorContent=null;ptObj=null;pid=null;POS=null;encClaimStrXml=null;strXmlForVisitSubType=null;strXmlForClaimProvider=null;strXmlForconcentStatus=null;strXmlForSlidingFeeSch=null;authorizedProviderJArray=null;block_id=null;isPermissionForWebPortal=null;showBillableAlert=null;masterAbstractEncounter=null;strPermissionForPosUpdate=null;strPermissionForApptCopay=null;strPermissionForApptNonBillable=null;strPermissionForApptVisitStatus=null;strPermissionForBookOutofOfficeHoursAppointments=null;strPermissionForBookBlockConflictAppointments=null;strPermissionForBookConflictAppointments=null;strPermissionForBookAnyVisitTypeAppointment=null;strPermissionForOverbookAppointments=null;strXMLForMandatoryStructData=null;strXmlForPager=null;rpane=null;rightpaneltog=null;appointmentScopeGlobalVariables=null;encAssociationXml=null;if(typeof dentalAppointmentCleapuproutinesexecution!=="undefined"&&dentalAppointmentCleapuproutinesexecution){dentalAppointmentCleapuproutinesexecution();dentalAppointmentCleapuproutinesexecution=null}});function openModal(){$('#ptLookup').focus()}$scope.clickOnLaunchChadis=function(link,isExternalWindowEnabled){if(isExternalWindowEnabled)$('#ChadisFormFromApptRightPanel')[0].submit();else{$scope.externalChadisLaunchLink=$sce.trustAsResourceUrl(link);$("#externallinkChadis").modal()}};$scope.loadUBData=function(){var url=makeURL("/mobiledoc/jsp/webemr/webpm/UBdata.jsp?encounterId="+$scope.encounterId);$ocLazyLoad.load({name:'ubdatamodule',files:['/mobiledoc/jsp/webemr/webpm/js/UBdata.js']}).then(function(){$scope.ubdataUrl=url},function(e){ecwAlert('Fail to load UB data',defaultAlertTitle)})};$scope.setUB92Data=function(data){$scope.Ub92Data=data};$scope.saveUBDataUrl=function(){var url=makeURL('/jsp/webemr/webpm/UBdataController.jsp');return url};var errorOnSaveUBData=function(response){ecwAlert("Failed to save UB Data",defaultAlertTitle);return};$scope.loadGuarantorBalNewAppt=function(){$ocLazyLoad.load({name:'guarantorAccountApp',files:['/mobiledoc/jsp/webemr/webpm/js/guarantorAccount.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/webpm/guarantorAccount.jsp?patientId="+$scope.patientId+"&userType=3&parentScreen=newApptLink");$scope.grInquirylinkurl=url},function(e){})};$scope.showDentalTP=function(){if($scope.encounterId===null||$scope.encounterId===undefined||$scope.encounterId==='0'){newAppointmentFnNameSpace.confirmDialog("To access the Treatment Plan, an appointment must be created first. Do you want to continue?",'bluetheme',function(result){if(result){$scope.createAppointment(11)}else{return}})}else{$scope.openDentalTPScreen()}};$scope.openDentalTPScreen=function(){$scope.titlename="Dental Treatment Plan";if(checkCancelledCode($scope.appointmentVisitStatus.code)){var msg="Treatment Plan cannot be viewed for cancelled status/non-billable visit.";ecwAlert(msg,defaultAlertTitle)}else{PSACService.checkCommonStaffPermission($scope.patientId,function(){$ocLazyLoad.load({files:['/mobiledoc/jsp/dental/css/treatmentPlan.css','/mobiledoc/jsp/dental/js/appointmentTreatmentPlan.js','/mobiledoc/jsp/dental/js/dental-keywords.js']}).then(function(){var url=makeURL("/mobiledoc/dental/appointmentTreatment/loadTPForAppointment?patientId="+$scope.patientId+"&encId="+$scope.encounterId+"&provId="+$scope.appointmentProvider.providerId+"&resId="+$scope.appointmentResource.id);$scope.dentalTreatmentPlanurl=url},function(e){ecwAlert("Error in opening Appointment Treatment Plan screen",defaultAlertTitle)})},function(){return})}};$scope.checkForDentalVisit=function(){$scope.isDentalVisitTypeSelected=$scope.appointmentVisitType&&$scope.appointmentVisitType.DentalVisit==='1'};$scope.checkForRecurringAppt=function(){let objRecurrence=appointmentService.isEncRecurringAndConflicting($scope.encounterId);if(objRecurrence&&objRecurrence.isRecurring){$scope.isRecurringAppt=objRecurrence.isRecurring}setApptDataAfterSaveAppt()};function setApptDataAfterSaveAppt(){$scope.currentEncDate=angular.copy($scope.StDate);$scope.currentEncStartTime=angular.copy($scope.appointmentStartTime.time);$scope.currentEncEndTime=angular.copy($scope.appointmentEndTime.time);$scope.currentEncVisitType=angular.copy($scope.appointmentVisitType.Name);$scope.currentEncResourceId=angular.copy($scope.appointmentResource.id);$scope.currentEncFacilityId=angular.copy($scope.facilityId)}$scope.importPtDemographics=function(){$scope.importPtDemographicsView='';let appointmentId=$scope.encounterId;var patientId=$scope.patientId;var demoGraphicsId=0;$ocLazyLoad.load({name:'PreviewPatientEnteredDataInfo',files:['/mobiledoc/jsp/webemr/jellybean/patiententereddata/js/previewPatientEnteredDataInfo.js','/mobiledoc/jsp/resources/jslib/perfect-scrollbar/css/perfect-scrollbar.css','/mobiledoc/jsp/resources/jslib/perfect-scrollbar/dist/perfect-scrollbar.min.js','/mobiledoc/jsp/resources/jslib/angular-perfect-scrollbar/src/angular-perfect-scrollbar.min.js']}).then(function(){var url="/mobiledoc/jsp/webemr/jellybean/patiententereddata/previewPatientEnteredDataInfo.jsp?"+"TrUserId="+global.TrUserId+"&patientId="+patientId+"&demoGraphicsId="+demoGraphicsId+"&encounterId="+appointmentId;url=makeURL(url);$scope.importPtDemographicsView=url},function(e){})};$scope.showPtDemographicsImportData=false;$scope.showEcheckinStatus="-1";$scope.checkInProcessStatusByEnc="";$scope.multipleDemoChanges="false";$scope.demographicUpdateEncId=0;$scope.demographicUpdatereason=0;$scope.getPtDemographicsImportData=function(){$scope.showPtDemographicsImportData=false;$scope.demographicUpdateEncId=0;$scope.demographicUpdatereason=0;var url="/mobiledoc/jsp/webemr/portal/demographicsHelper.jsp";$.ajax({url:url,type:"POST",dataType:"json",data:{pid:$scope.encData.patientId,encid:$scope.encounterId,action:"getApptPtDemographicsImportData"},"async":false,success:function(data){if(data!==null&&data!==undefined){$scope.demographicUpdateEncId=data.demographicUpdateEncId;$scope.demographicUpdatereason=data.demographicUpdatereason;if($scope.demographicUpdateEncId||$scope.demographicUpdatereason){$scope.showPtDemographicsImportData=true}$scope.showEcheckinStatus=data.echeckinStatus;$scope.checkInProcessStatusByEnc=data.checkInProcessStatusByEnc;$scope.multipleDemoChanges=data.multipleDemoChanges}}})};var showMessage=function(message,elementIdToFocus,title){if(angular.isUndefined(title)||$.trim(title).length===0){title=$scope.bHealowPlusEnabled?"Healow":"eClinicalWorks"}ecwAlert(message,title,null,"","",elementIdToFocus)};$scope.openPatientProfile=function(){if(newAppointmentFnNameSpace.checkIfEmpty($scope.patientDtls.patient.id)){showMessage('please select patient','ptLookup');$('#ptLookup').focus();return}let elem=$compile(" <healow-plus-profile-pic-dir patient-id=\""+$scope.patientDtls.patient.id+"\" hide-profile-icon='true'></healow-plus-profile-pic-dir>")($scope);$("#appointment-patient-profile-container").html(elem);setTimeout(function(){$("#appointment-patient-profile-container .sidePanel").hide();$("#appointment-patient-profile-container .icon.icon-patient-profile").click()},500)};$scope.addCostEstimator=function(patientId,encounterId){let param="patientid="+patientId+"&encounterId="+encounterId;$scope.commonwellUrl="";$ocLazyLoad.load({name:'PatientCostEstimator',files:['/mobiledoc/jsp/webemr/webpm/costEstimator/js/patientCostEstimatorCtrl.js']}).then(function(){let url='/mobiledoc/jsp/webemr/webpm/costEstimator/patientCostEstimator.jsp?'+param;$scope.commonwellUrl=makeURL(url)},function(e){console.log(e)})};$scope.cancelAppointmentAction=function(){switch($scope.actions.apptAction){case 2:$scope.cancelReason();break;case 3:$scope.cancelReason();break;case 4:$scope.BackToAppointment();break;case 5:$scope.cancelNotes();break;case 6:$scope.cancelGeneralNotes();break;case 9:$scope.BackToAppointment();break;case 10:$scope.saveStructureData();break}};var disableScreenControlsForFloatingToolbar=function(){$timeout(function(){$("#newAppointmentBtn43").prop('disabled',true);$("#newAppointmentBtn44").prop('disabled',true);$("#newAppointmentBtn45").prop('disabled',true);$("#newAppointmentBtn46").prop('disabled',true);$("#newAppointmentBtn47").prop('disabled',true);$("#newAppointmentBtn48").prop('disabled',true);$("#newAppointmentBtn99").prop('disabled',true);$("#newAppointmentBtn49").prop('disabled',true);$("#dentalTreatment").prop('disabled',true);$("#newAppointmentBtn25").prop('disabled',true);$("#newAppointmentBtn26").prop('disabled',true);$("#newAppointmentBtn27").prop('disabled',true);$("#newAppointmentBtn28").prop('disabled',true);$("#newAppointmentBtn29").prop('disabled',true);$("#newAppointmentBtn30").prop('disabled',true);$("#newAppointmentBtn31").prop('disabled',true);$("#newAppointmentBtn32").prop('disabled',true);$("#newAppointmentBtn34").prop('disabled',true);$("#newAppointmentBtn1").prop('disabled',true);$("#newAppointmentLink19").prop('disabled',true);$("#newAppointmentLink7").addClass('disabled');$("#newAppointmentLink7").attr("ng-click","");$("#newAppointmentLink8").addClass('disabled');$("#newAppointmentLink8").attr("ng-click","");$("#newAppointmentLink55").prop('disabled',true);$("#newAppointmentLink9").prop('disabled',true);$("#newAppointmentLink56").prop('disabled',true);$("#newAppointmentBtn2").prop('disabled',true);$("#newAppointmentIpt3").prop('disabled',true);$("#newAppointmentBtn15").prop('disabled',true);$("#newAppointmentTransitionOfCareBtn").prop('disabled',true);$("#caseCombo").prop('disabled',true);$("#newAppointmentBtn19").prop('disabled',true);$("#newAppointmentBtn20").prop('disabled',true);$("#newAppointmentBtn21").prop('disabled',true);$("#referralCombo1").prop('disabled',true);$("#referral-data-lookupBtn2").prop('disabled',true);$("#referralellipsis").prop('disabled',true);$("#newreferralopen").prop('disabled',true);$("#apptBillingNotesId").prop('disabled',true);$("#newAppointmentBtn22").prop('disabled',true);$("#newAppointmentBtn23").prop('disabled',true);$("#newAppointmentBtn24").prop('disabled',true);$("#apptGeneralNotesId").prop('disabled',true);$("#newAppointmentIpt13").prop('disabled',true);$("#newAppointmentIpt14").prop('disabled',true);$("#newAppointmentIpt15").prop('disabled',true);$("#newAppointmentBtn2222").prop('disabled',true);$("#newAppointmentBtn24").prop('disabled',true)},1e3)};var disableBottomPanelButtonsForFloatingToolbar=function(){$timeout(function(){$("#newAppointmentBtn43").prop('disabled',true);$("#newAppointmentBtn44").prop('disabled',true);$("#newAppointmentBtn45").prop('disabled',true);$("#newAppointmentBtn46").prop('disabled',true);$("#newAppointmentBtn47").prop('disabled',true);$("#newAppointmentBtn48").prop('disabled',true);$("#newAppointmentBtn99").prop('disabled',true);$("#newAppointmentBtn49").prop('disabled',true);$("#dentalTreatment").prop('disabled',true)},0)};$scope.addPatientPaymentForCollection=function(rule){if($scope.patientId>0){var param={paymentId:0,parentScreen:'newApptController',patientId:$scope.patientId,encId:$scope.encounterId,collectionCode:rule.collectionCodes.replace(/\[|\]/g,'').split(','),ruleId:rule.RuleId}}loadReceivePayment($ocLazyLoad,$modal,param)};function isPatientConflictCheckExclude(){var ConflictCheckExclude=false;if($scope.encounterId!=="0"&&Number(preserveValueThatConflict.resourceId)===Number($scope.appointmentResource.id)&&preserveValueThatConflict.date===$scope.StDate&&preserveValueThatConflict.startTime===$scope.appointmentStartTime.time){ConflictCheckExclude=true}return ConflictCheckExclude}}).service('appointmentService',function($http,toasterSvc){var appointmentScope;return{isEncRecurringAndConflicting:function(encounterId){var jsonObj={};var url=makeURL("/mobiledoc/jsp/catalog/xml/isEncRecurringAndConflicting.jsp");ajaxCallByPost(url,{EncounterId:encounterId}).success(function(data){jsonObj=xml2json(data).Envelope.Body["return"];if(jsonObj.tooltipmess&&jsonObj.tooltipmess!=''){jsonObj.isRecurring=true}else{jsonObj.isRecurring=false}}).error(function(data){showMessage("An error occured in encounter recurring.")});return jsonObj},updateReservedSlot:function(slotId,encounterId){var flag=true;var url=makeURL("/mobiledoc/jsp/kiosk/updateRSSlot.jsp");ajaxCallByPost(url,{encid:encounterId,slotid:slotId}).success(function(data){}).error(function(data){flag=false;showMessage("Error updating reserve slot.")});return flag},setPatientWaitTime:function(encounterId){var flag=true;var url=makeURL("/mobiledoc/jsp/catalog/xml/setPatientWaitTime.jsp");ajaxCallByPost(url,{encid:encounterId,waittime:moment().format("HH:mm:ss")}).success(function(data){}).error(function(data){flag=false;ecwAlert("Error while saving wait time.")});return flag},getApptRecurrenceData:function(encounterId){var url=makeURL('/mobiledoc/jsp/webemr/scheduling/Controller.jsp');url=makeURL(url);var objApptRecurrence;ajaxCallByPost(url,{encounterId:encounterId,action:'getApptRecurrenceData'}).success(function(data){objApptRecurrence=xml2json($.trim(data)).Envelope.Body["return"].Recurring}).error(function(data){showMessage("Error getting appointment recurrence information.")});return objApptRecurrence},saveApptRecurrence:function(encounterId,nDoctorId,sOpenedFor,facId,bSelectedDays,nRecFrequency,startDate,endDate,startTime,endTime,nOcurrences,nFrequency,nOriginalPatternId,nOriginalPattern,nSave){var param={action:'saveApptRecurrence',days:bSelectedDays,recurFreq:nRecFrequency,startDate:startDate,endDate:endDate,startTime:startTime,endTime:endTime,occurences:nOcurrences,frequency:nFrequency,origPatternId:nOriginalPatternId,origPattern:nOriginalPattern,save:nSave,doctorId:nDoctorId,openFor:sOpenedFor,facId:facId,encounterId:encounterId};var url=makeURL('/mobiledoc/jsp/webemr/scheduling/Controller.jsp');url=makeURL(url);ajaxCallByPost(url,param).success(function(data){toasterSvc.showSuccessToaster("Appointments saved successfully",5e3)}).error(function(data){showMessage("Error Saving appointment recurrence.")})},saveMuAlertData:function(ptEmail,patientId,uname,optout){var result;var struname=uname;if(typeof uname=='undefined'){struname=ptEmail}if(optout==0||typeof optout=='undefined'){var param={uname:struname,email:ptEmail,pid:patientId,webnenable:"Yes",location:"Appointment Screen"}}else{var optout=0;var optoutreason=$("#optReason").val();if($("#_donotwebenable").is(':checked')){optout=1}var param={email:ptEmail,uname:ptEmail,pid:patientId,webnenable:"Yes",optout:optout,optreason:optoutreason,location:"Appointment Screen"}}var url=makeURL('/mobiledoc/jsp/portal/saveMUAlertData.jsp');url=makeURL(url);ajaxCallByPost(url,param).success(function(data){if(typeof data!='undefined'){result=data.toString().trim()}}).error(function(data){showMessage("Error Saving appointment MU alert.")});return result},setScope:function(scope){appointmentScope=scope},getScope:function(){return appointmentScope},destoryScope:function(){appointmentScope=null}}})})();function getScope(){return angular.element(document.getElementById('newApptModal')).injector().get("appointmentService").getScope()}
angular.module('NewHub',['oc.lazyLoad','ui.bootstrap','rightPanelModule','afterCareHub.services','ecw.service.PSAC','ecw.pagination','ecw.service.EncDetailsService','ecw.dir.cardonfilebtn','evaFavorite','patientEnrollmentDirective','enrollmentService','patientQuickEnrollmentDirective','wCVIndicatorDirective','toasterNotification',getEhxCommonFuncsJsDependency(),getDataExchangeConsentDependency(),getPhmHubFiles()]).controller('patienthubController',function($scope,$http,$ocLazyLoad,$compile,$modal,$sce,$window,afterCareServiceHub,$rootScope,PSACService,EncDetailsService,$templateCache,$attrs,evaFavoriteService,$timeout,$injector,toasterSvc){var patientPicClickHandler=function(e){$('.img_tab').show();e.stopPropagation()};var fadeImgTabHandler=function(){$(".img_tab").fadeOut()};$('#hub-patientpic').on('click',patientPicClickHandler);$scope.isPatientPictureLoadStart=false;$(document).on('click',fadeImgTabHandler);$scope.onCloseAppt=function(){$scope.hublinkurl="";$templateCache.remove($scope.hublinkurl)};$scope.isTotalWriteOffPresent=$attrs.isTotalWriteOffPresent==="true"?true:false;$scope.mandateCardOnFile=$attrs.mandateCardOnFile;$scope.strEnableClaimCollection=getItemKeyValue("EnableClaimCollection").toLowerCase()==="yes";$scope.isModernPatientMerge=getItemKeyValue("ModernPatientMerge").toLowerCase()==='yes';$scope.isMultipleSSOEnabled=$attrs.multipleSsoEnabled.toLowerCase()==='true';$scope.isWebOMREnabled=getItemKeyValue("WebOMREnabled").toLowerCase()==='yes';$scope.isEpaServiceEnabled=getItemKeyValue("EnableePAService").toLowerCase()==="yes";$scope.crePreviewURL="";$scope.infolinkurl="";$scope.hublinkurl="";$scope.ecw_native_app_agent=!global.ecw_native_app_agent;if(!global.ecw_native_app_agent){$("#eCliniFormsBtn").attr("title","Please use windows native application for this functionality");$("#medicalRecordBtn").attr("title","Please use windows native application for this functionality")}$scope.fromJellyBeanPanel=$attrs.fromJellyBeanPanel;$scope.parentForm=$attrs.parentForm;$scope.ptId=0;$scope.encounterId=0;$scope.PatientHubInfo={};$scope.rightpanelHub="";$scope.appcount=$attrs.apptCount;$scope.externalreporturlvalue='';$scope.bDisableP2PLinks=global.bDisableP2PLinks;$scope.btPtDocsDisabled=$attrs.ptDocsDisabled.toLowerCase()==='true';$scope.btHealowPlusAccess=$attrs.bHealowPlusAccess.toLowerCase()==='true';$scope.ehxConsentRecv=false;$scope.ehx3rdPartyPortalEnabled=getItemKeyValue("Empi3rdPartyPortal").toLowerCase()=="yes";$scope.paperConsultNotes=$attrs.pConsultNotes;$scope.enablePtDocPluginMode;$scope.enableLetterPluginMode;$scope.showhiderightpanel='0';$scope.showhiderightpanel=getUserProfile("PatientHubRightPanel");$scope.permissionForAppt=true;$scope.paramCreateNewClaim={page:'',load:0};$scope.isValidPatient=$attrs.isValidPatient==="false"?false:true;$scope.hasLabDetailsAccess=false;$scope.PcfPatientId=parseInt($attrs.patientId,10);$scope.hasHubPLAccess=false;$scope.hasTreatmentTimelineAccess=getPermission("TreatmentTimeLineAccess",global.TrUserId);$scope.isPatientConfidentialForHub=false;$scope.patientConfidentialityTitleForHub="";if($attrs.strPermissionForAppointment.toLowerCase()=='true'){$scope.permissionForAppt=true}else{$scope.permissionForAppt=false}if($attrs.strPermissionForLabaccess.toLowerCase()==='true'){$scope.hasLabDetailsAccess=true}if($attrs.patientId!='')$scope.ptId=$attrs.patientId;if(!angular.isUndefined($attrs.encounterId)&&!isNaN($attrs.encounterId)&&parseInt($attrs.encounterId,10)>0){$scope.encounterId=$attrs.encounterId}$scope.isNewActionAccessible=true;if($("#actionPopUp").css('display')==='block'){$scope.isNewActionAccessible=false}else if($("#actionPopUp").css('display')==='none'){$("#actionPopUp").parent().remove()}if($scope.screens){if($scope.screens.accountslookupscreen===true){$("#AccInqButton").attr("disabled","disabled")}$scope.screens.patienthubscreen=true}else{$scope.screens={patienthubscreen:true}}var index=-1;var devicetype=-1;$scope.setindex=function(param,type){index=param;devicetype=type;$scope.loadmodalurl("Devices")};$scope.enablePatientCostEstimator=false;$scope.enablePatientCostEstimator=getItemKeyValue("EnablePatientCostEstimator").toLowerCase()=="yes";$scope.enablePaymentPlan=false;$scope.enablePaymentPlan=getItemKeyValue("EnablePaymentPlans").toLowerCase()=="yes";$scope.disableprintlabel=true;$scope.disablemedicalRecordBtn=true;$scope.disableEcliniForms=true;$scope.contextFrom=$attrs.contextFrom;$scope.isPNMethodExecute=false;$scope.isDRCMClient=getItemKeyValue("DRCMClient").toLowerCase();$scope.isRCMClient=getItemKeyValue("RCMClient").toLowerCase();$scope.isAccountInquiryFromCBO=getItemKeyValue("accountInquiryFromCBO").toLowerCase();$scope.loggedInuserFacility=global.facilityId;$scope.enableCBOAccBal=false;if($scope.isRCMClient=="yes"&&$scope.isAccountInquiryFromCBO=="yes"&&$scope.isDRCMClient!="yes")$scope.enableCBOAccBal=true;var permissionKeys=[];permissionKeys.push("HubConsultNotes");permissionKeys.push("TelephoneEncounter");permissionKeys.push("WebEncounter");permissionKeys.push("HubRx");permissionKeys.push("HubProblemList");permissionKeys.push("Medical Summary");permissionKeys.push("Accounts LookUp");permissionKeys.push("HubMedicalRecord");$scope.enableWVIndicator=getItemKeyValue("EnableWVIndicator").toLowerCase()==="yes";var permissionKeyList={};permissionKeyList=getPermissionForKeyArray(permissionKeys,global.TrUserId);if(permissionKeyList.Values.length>0){$scope.hasHubPLAccess=permissionKeyList.Values[0]["HubProblemList"]===1?true:false;if(!$scope.hasHubPLAccess){$("#ptHubProblemList").attr("title","You do not have access to Problem List in the Hub and ICW.\nPlease contact your administrator.\n\nPlease go to Assessments in Progress Notes to edit the Problem List.")}}$scope.openexternalreportsWindowObject=null;$scope.structDataCurrentPage=1;$scope.structDataPageSize=9;$scope.patientHubStructArray=[];$scope.totalDisplayed=0;$scope.EnableOrDisableContextSensitiveButton=function(keyName,toottipmsg,butid,isMedicalDevice){if(patientHubModalcookie!=null){var session=patientHubModalcookie.split("=");var data=getDeviceCompatibilityCheckValue(keyName,session[1],toottipmsg,isMedicalDevice);if(data!=""&&!angular.isUndefined(data)){if($scope.PatientHubInfo.bDevicesConfigured!=""&&!angular.isUndefined($scope.PatientHubInfo.bDevicesConfigured))$scope.PatientHubInfo.bDevicesConfigured=true;var res=data.split(",");if("winprojecte"==keyName){if(res[0]=="true"){$scope.disableEcliniForms=false;$scope.disableprintlabel=false;$scope.disablemedicalRecordBtn=false}else{$scope.disableprintlabel=true;$scope.disablemedicalRecordBtn=true;if(res[0]=="false"){$("#menuprintlabelbtn").attr("title",res[1]);$("#medicalRecordBtn").attr("title",res[1])}}}else if("macprojecte"===keyName){$scope.disablemedicalRecordBtn=res[0]!="true"}}}};$scope.openBHHubCommonWarningPopup=function(screenName,screenTitle,message){commonWarningPopup({screenName:screenName,screenTitle:screenTitle,buttons:[{label:"OK",cssClass:'btn-blue',callbackEvent:function(){}}],message:message,isCommunicationPopup:true,isKeyboardClose:true},$ocLazyLoad,$modal)};$scope.openBHHubSecurityAccessPopup=function(){let message='BH Hub access denied. Please contact your administrator to grant you access to <BR> "Allow Access to BH Hub" security setting.<BR><BR>';$scope.openBHHubCommonWarningPopup('BH Hub','Access',message)};var toSetFacility=false;function facilityFilterInit(){if($attrs.isFacillityFilter=='true'){if(isSupportsLocalStorage()){if(!containsKey('loggedInInfo')){var info=getLoggedInInfo();put("loggedInInfo",JSON.stringify(info))}var infoJson=JSON.parse(get('loggedInInfo'));var facId=infoJson.facilityId;if(facId!=='0'&&$.isNumeric(facId)&&parseInt(facId,10)>0){}else{toSetFacility=true}}}}facilityFilterInit();function setFacIdInLS(){if(toSetFacility){if(isSupportsLocalStorage()){if(containsKey('loggedInInfo')){var info=JSON.parse(get('loggedInInfo'));info.facilityId=$attrs.facilityId;put("loggedInInfo",JSON.stringify(info))}else{var info=getLoggedInInfo();put("loggedInInfo",JSON.stringify(info))}}}}setFacIdInLS();$scope.clearPtHubGlobalVars=function(){patientHubModalCount=null;patientHub_pregListXml=null;patientHubModalcookie=null;patientHubModalpHubClsObj=null;patientHubModalelemhubrp=null};$scope.closethismodal=function(elementId){try{if($scope.isPNMethodExecute===true&&$scope.$parent.closeClaimScreenFromHub!==undefined&&angular.isFunction($scope.$parent.closeClaimScreenFromHub)){$scope.$parent.$parent.closeClaimScreenFromHub()}}catch(e){}if($scope.parentForm==="renewalRequest"){if(typeof $scope.$parent.closeRenewalPatientHub=='function'){$scope.$parent.closeRenewalPatientHub()}}if($scope.parentForm=="newAppointment"){try{$scope.$parent.refreshPatientDetail();if(typeof $scope.$parent.triggerRegistrationRulesForPtInfo=='function'){$scope.$parent.triggerRegistrationRulesForPtInfo()}}catch(err){}}$("#"+elementId).modal('hide');$('#hub-patientpic').off('click',patientPicClickHandler);$(document).off('click',fadeImgTabHandler);$('#patient-hubUl2').off('click',preventMultipleClick);$('#structdata-hub').off('scroll',onScrollStructData);if($scope.screens){$scope.screens.patienthubscreen=false}$scope.clearPtHubGlobalVars();if(elementId=="patient_hub"){$scope.showPluginScreenPatientHub(false);var elem1=$('#patient_hub1').find('.right-panel');if(elem1){var controllerscope1=angular.element(elem1).scope();if(controllerscope1){controllerscope1.$destroy();elem1.remove();angular.element(elem1).remove()}}$templateCache.remove($attrs.requestUrl);$templateCache.remove($attrs.encryptedUrl);try{$('#patient_hub1').scope().$destroy()}catch(e){}$("#patient_hub1").remove();$('.modal-backdrop.fade').last().remove();if($('.modal.in:visible').length==0){$('.modal-backdrop.fade').remove()}}var isPNBaseRefreshed=EncDetailsService.isPNBaseRefreshed();if(($scope.contextFrom&&$scope.contextFrom==="progressnotes"||$scope.fromJellyBeanPanel&&$scope.fromJellyBeanPanel==="yes")&&!isPNBaseRefreshed){EncDetailsService.refreshPNBaseScreen()}if($scope.openexternalreportsWindowObject!=null&&!$scope.openexternalreportsWindowObject.closed){$scope.openexternalreportsWindowObject.close()}};$scope.showPluginScreenPatientHub=function(isClosePlugin){try{if(selectPtHub_global.screenId!=null&&selectPtHub_global.screenId!=""&&selectPtHub_global.screenId!="null"){webemrPlugin.getWebview2Instance().CallPlugin('id=ShowPluginScreen|screen='+selectPtHub_global.screenName+'|screenId='+selectPtHub_global.screenId+'|isClose='+isClosePlugin)}}catch(err){}};$scope.closePatientHubModal=function(){$scope.closethismodal('patient_hub')};$scope.openCBOAccountInquiry=function(){var url='/mobiledoc/jsp/webemr/webrcm/launcherModal.jsp?patientId='+$scope.ptId;$scope.hublinkurl=makeURL(url)};$scope.showPatientInquiry=function(){if($scope.enableCBOAccBal){$scope.openCBOAccountInquiry();return}var hubAccInquiryPermission="";if(permissionKeyList.Values.length>0){hubAccInquiryPermission=permissionKeyList.Values[0]["Accounts LookUp"]==1?true:false}if(hubAccInquiryPermission){let param={patientId:$scope.ptId,contextFrom:'patienthub'};loadAccountsInquiry($ocLazyLoad,$modal,param);evaFavoriteService.showEvaFavorite("Do you know you can quickly check account inquiry via EVA.<br>"+"Command : get account inquiry for (Patient_Name)<br>"+"Would you like to add this command to your favorites?","openaccountinquiry")}else{ecwAlert("You don't have permission to access Account Inquiry. Please contact your administrator.","eClinicalworks");return false}};$scope.openPtLvFromEhx=function(){$scope.topPanelPopUrl="";var myDocumentURL="/mobiledoc/jsp/webemr/empi/viewPtEhxData.jsp?patientId="+$scope.ptId+"&uid="+global.TrUserId+"&encId="+$scope.encounterId+"&context="+"toppanel"+"&mainDivId="+"ptDataAtEhxTopPanel"+"&action="+"viewPtExternalDocument"+"&title="+"IHEDocs";$ocLazyLoad.load({name:'',files:['/mobiledoc/jsp/webemr/empi/js/viewPtEhxDataController.js','/mobiledoc/jsp/webemr/rightpanel/js/ehxImportItemsService.js'],cache:true}).then(function(){$scope.topPanelPopUrl=makeURL(myDocumentURL)},function(e){ecwAlert(e)})};$scope.closeFlowsheet=function(){try{$templateCache.remove($scope.hublinkurl)}catch(err){}};$scope.callbackTemplateModal=function(){$scope.getUserProfileTemplateList()};$scope.callbackTemplateListModal=function(){$scope.getUserProfileTemplateList()};$scope.getUserProfileTemplateList=function(){$scope.userProfileTemplateList={};$.ajax({url:makeURL("/mobiledoc/jsp/catalog/userProfileTemplateController.jsp"),type:"POST",data:"action=getTemplateList&templateType=DocumentSearch&favourite=1&userId="+global.TrUserId,"async":false,success:function(data){if(data!=null&&data.trim()!=''){$scope.userProfileTemplateList=jQuery.parseJSON(data.trim())}}})};$scope.isTagGroupsObjectEmpty=function(){return $scope.userProfileTemplateList&&Object.keys($scope.userProfileTemplateList).length===0};$scope.editTemplate=function(templateId){$ocLazyLoad.load({name:'templateModule',files:['/mobiledoc/jsp/webemr/jellybean/reviewdocs/template.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/reviewdocs/template.jsp?action=2&templateId='+templateId);$scope.hublinkurl=url},function(e){ecwAlert("Error occurred while launching template.","eClinicalWorks",null,"","bluetheme")})};$scope.openAdvanceDocumentSearchWindow=function(obj){$scope.patientId=$scope.ptId;var name="";var url=' /mobiledoc/jsp/webemr/toppanel/patientdocs/Documents-Search.jsp?patientId='+$scope.ptId+"&patientName="+"&templateId="+obj.templateId;$ocLazyLoad.load({name:'NewInfo',files:[]}).then(function(){$scope.hublinkurl=makeURL(url)},function(e){ecwAlert("Error occurred while launching document search window.","eClinicalWorks",null,"","bluetheme")})};$scope.openAdvanceDocumentSearchWindowNew=function(obj){$scope.patientId=$scope.ptId;launchPlugin('id=PTDOC|patientId='+$scope.ptId+'|TemplateId='+obj.templateId)};$scope.launchAdvanceDocSearchWindow=function(tagGroupObj){var isPluginEnabled=false;var isPluginPtDocsEnabled=false;var obj={};try{obj=jQuery.parseJSON(sessionStorage.getItem("ECW_DEVICES"))}catch(e){}if(obj&&obj.hasOwnProperty('DATA')){var data=obj.DATA;if(data&&data.length>0){for(var i=0,len=data.length;i<len;i++){if(data[i].key==='winprojecte'&&data[i].value===true){isPluginEnabled=true}if(data[i].key==='ptdoc'&&data[i].value===true){isPluginPtDocsEnabled=true}}}}if(isPluginEnabled&&isPluginPtDocsEnabled){$scope.openAdvanceDocumentSearchWindowNew(tagGroupObj)}else{$scope.openAdvanceDocumentSearchWindow(tagGroupObj)}};var preventMultipleClick=function(){$('#patient-hubUl2').css('pointer-events','none');setTimeout(function(){$('#patient-hubUl2').css('pointer-events','')},500)};$('#patient-hubUl2').on('click',preventMultipleClick);$scope.loadmodalurl=function(tabsel,pluginMode){$scope.sel_patient=0;$scope.hublinkurl="";var name="";if($scope.PatientHubInfo.mname)name=$scope.PatientHubInfo.lname+", "+$scope.PatientHubInfo.fname+", "+$scope.PatientHubInfo.mname;else name=$scope.PatientHubInfo.lname+", "+$scope.PatientHubInfo.fname;if(tabsel&&(tabsel==='LABS'||tabsel==='DI'||tabsel==='Procedures')){if($scope.hasLabDetailsAccess===false){showMessage("You don't have permissions to Access Labs/Imaging. Please contact your administrator.","eClinicalWorks");return}}if($scope.patientRxSummaryUrl!=""){$templateCache.remove($scope.patientRxSummaryUrl)}$scope.patientRxSummaryUrl="";if(tabsel=='Info'){$ocLazyLoad.load({name:'NewInfo',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/ptInfoController.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/miscController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientInfo/patient-demographics.jsp?patientId='+$scope.ptId+'&context=Hub');$scope.hublinkurl=url},function(e){})}else if(tabsel=='Encounters'){showMessageIfMultipleModalInstance("div.patient-encounter[ng-controller=encounterController]","One instance of Encounters window is already open. You cannot open another instance");PSACService.checkCommonStaffPermission($scope.ptId,function(){$ocLazyLoad.load({name:'NewEncounter',files:['/mobiledoc/jsp/webemr/toppanel/encounter.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/Encounter-lookup.jsp?patientId="+$scope.ptId);$scope.hublinkurl=url},function(e){})},function(){return})}else if(tabsel=='New_Alerts'){$ocLazyLoad.load({name:'alertsMainApp',files:getDependencies('alertsMainApp')}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/alerts/cdss/alertsMain.jsp?launchedFrom=patientHub&patientId='+$scope.ptId);$scope.hublinkurl=url},function(e){})}else if(tabsel=='PatientDocs'){var strFaxInboxUser=getItemKeyValue("FaxInboxUser");if(strFaxInboxUser==""){strFaxInboxUser=50}if(!($scope.ptId==strFaxInboxUser)){PSACService.checkCommonStaffPermission($scope.ptId,function(data){if(undefined===pluginMode){if($scope.enablePtDocPluginMode==undefined){$scope.enablePtDocPluginMode=isPluginEnabled(2)}}else{$scope.enablePtDocPluginMode=pluginMode}if(!$scope.enablePtDocPluginMode){showMessageIfMultipleModalInstance("div#PatientDocControllerId[ng-controller=PatientDocController]","One instance of Patient Document window is already open. You cannot open another instance");showMessageIfMultipleModalInstance("div#PatientDocControllerId[ng-controller=NewPatientDocController]","One instance of Patient Documents window is already open. You cannot open another instance");$ocLazyLoad.load({name:'PtDocsModule',files:['/mobiledoc/jsp/webemr/toppanel/patientdocs/js/patientdocs.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/patientdocs/patientdocs.jsp?btPatientHubDisabled=true&patientId="+$scope.ptId+"&encounterId="+$scope.encounterId+"&patientName="+name+" "+$scope.PatientHubInfo.Inactive.trim()+"&nd="+(new Date).getTime()+"&context="+$scope.context);$scope.hublinkurl=url},function(e){})}else{launchPlugin('id=PTDOC|patientId='+$scope.ptId)}},function(){})}}else if(tabsel=='LABS'){$ocLazyLoad.load({name:'LabHistoryApp',serie:true,files:getDependencies('LabHistoryApp')}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/labs/labhistory/LabDIProHistory.jsp?context="+$scope.contextFrom+"&nType=0&patientId="+$scope.ptId+"&userId="+global.TrUserId+"&normalView=1&CorrectionalEnabled=false&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})}else if(tabsel=='DI'){$ocLazyLoad.load({name:'LabHistoryApp',serie:true,files:getDependencies('LabHistoryApp')}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/labs/labhistory/LabDIProHistory.jsp?context="+$scope.contextFrom+"&nType=1&patientId="+$scope.ptId+"&userId="+global.TrUserId+"&normalView=1&CorrectionalEnabled=false&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})}else if(tabsel=='Procedures'){$ocLazyLoad.load({name:'LabHistoryApp',serie:true,files:getDependencies('LabHistoryApp')}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/labs/labhistory/LabDIProHistory.jsp?context="+$scope.contextFrom+"&nType=3&patientId="+$scope.ptId+"&userId="+global.TrUserId+"&normalView=1&CorrectionalEnabled=false&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})}else if(tabsel=='IMM'){$ocLazyLoad.load({name:'ImmInjHxApp',files:getDependencies('ImmInjHxApp')}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/labs/immunizations/ImmunizationHx.jsp?nImmInjType=1&patientId="+$scope.ptId+"&userId="+global.TrUserId+"&webenabled="+$scope.PatientHubInfo.webenabled+"&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})}else if(tabsel=='Refferals'){}else if(tabsel=='Allergies'){$ocLazyLoad.load({name:'AllergyListModule',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/js/allergyListController.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/js/RxHelper.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/rx/showActiveAllergy.jsp'),controller:'AllergyListCtrl',size:'lg',resolve:{patientID:function(){return $scope.ptId},filterInfo:function(){return{multiSelect:"false",canDelete:"false",needBreadCrum:"false",Description:"Select Medication"}},ptAllergyArray:function(){return $scope.ptAllergyArray},hasPtAllergy:function(){return $scope.hasPtAllergy},encid:function(){return 0},patientIdentifierJson:function(){return $scope.getPatientIdentifiers()}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){})})}else if(tabsel=='RX'){var hubRxPermission="";if(permissionKeyList.Values.length>0){hubRxPermission=permissionKeyList.Values[0]["HubRx"]==1?true:false}if(hubRxPermission){PSACService.checkCommonStaffPermission($scope.ptId,function(){$scope.openPatientMedicationSummary()},function(){return})}else{ecwAlert("You don't have permission to access Rx. Please contact your administrator.","eClinicalworks");return false}}else if(tabsel=='NOTES'){$ocLazyLoad.load({name:'topPanelNotesModule',files:['/mobiledoc/jsp/webemr/toppanel/topPanelNotesCtrl.js']}).then(function(){var url="/mobiledoc/jsp/webemr/toppanel/topPanelNotes.jsp?patientId="+$scope.ptId;$scope.hublinkurl=makeURL(url)},function(e){})}else if(tabsel=='VisionHx'){$ocLazyLoad.load({name:'visionHxModule',files:['/mobiledoc/jsp/webemr/progressnotes/usvision/js/printDirective.js','/mobiledoc/jsp/webemr/progressnotes/usvision/js/VisionDataService.js','/mobiledoc/jsp/webemr/progressnotes/usvision/visionHx/ptVisionHxCtrl.js']}).then(function(){var url="/mobiledoc/jsp/webemr/progressnotes/usvision/visionHx/patientVisionHx.jsp?patientId="+$scope.ptId;$scope.hublinkurl=makeURL(url)},function(e){})}else if(tabsel=='ProgressNotes'){if(!$scope.PatientHubInfo.disableClicks){closeModalRPMMonitoringStatus();getPatientEncounterBasedOnFilter($http,$scope.ptId).success(function(data){var encounters=getPatientEncountersForTab(data);openLatestPN(encounters,$http,$scope.ptId,$ocLazyLoad,$modal);$scope.showPluginScreenPatientHub(true)}).error(function(){})}}else if(tabsel=='AfterCare'){var data={patientId:$scope.ptId,patientName:$scope.PatientHubInfo.lname+', '+$scope.PatientHubInfo.fname,fromHub:'yes'};setAfterCarePatientInHub(data);url='#/mobiledoc/jsp/webemr/AfterCare/afterCare.jsp?Rand='+Math.floor(1e3+Math.random()*9e3);window.location=url;$scope.showPluginScreenPatientHub(true);$("#patient_hub").modal('hide');$("#patient_hub1").remove();setTimeout(function(){$('.modal-backdrop.fade').remove()},250)}else if(tabsel=='NewWebEnc'){var hubNewTelEncPermission="";if(permissionKeyList.Values.length>0){hubNewTelEncPermission=permissionKeyList.Values[0]["WebEncounter"]==1?true:false}if(!hubNewTelEncPermission){ecwAlert("You don't have permission to access Web Encounter.Please contact your administrator.","eClinicalworks");return false}var itemKeyVal=getItemKeyValue('EnableInactiveDeceasedAppts');var isEnableInactiveDecease='';if(itemKeyVal){isEnableInactiveDecease=itemKeyVal.toLowerCase()=='yes'?true:false}if(!isEnableInactiveDecease){if(IsDeceased()){ecwAlert("Cannot create web encounter for deceased patient.","Appointment Error");return false}else if(IsInactive()){ecwAlert("Cannot create web encounter for inactive patient.","Appointment Error");return false}}$ocLazyLoad.load({name:'TJellyDetailView',files:getDependencies('TJellyDetailView')}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/telephoneencounter/JellyBeanT-Telephone-Encounter-DetailView.jsp?&EncounterId=0&PatientId='+$scope.ptId+'&parentfunctionname=cmdNewTelEncClick&enctype=6&index=-1&context=patienthub';url=makeURL(url);$scope.hublinkurl=url},function(e){})}else if(tabsel=='NewTelEnc'){var hubNewTelEncPermission="";if(permissionKeyList.Values.length>0){hubNewTelEncPermission=permissionKeyList.Values[0]["TelephoneEncounter"]==1?true:false}if(!hubNewTelEncPermission){ecwAlert("You don't have permission to access Telephone Encounter.Please contact your administrator.","eClinicalworks");return false}var itemKeyVal=getItemKeyValue('EnableInactiveDeceasedAppts');var isEnableInactiveDecease='';if(itemKeyVal){isEnableInactiveDecease=itemKeyVal.toLowerCase()=='yes'?true:false}if(!isEnableInactiveDecease){if(IsDeceased()){ecwAlert("Cannot create telephone encounter for deceased patient.","Appointment Error");return false}else if(IsInactive()){ecwAlert("Cannot create telephone encounter for inactive patient.","Appointment Error");return false}}$ocLazyLoad.load({name:'TJellyDetailView',files:getDependencies('TJellyDetailView')}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/telephoneencounter/JellyBeanT-Telephone-Encounter-DetailView.jsp?&EncounterId=0&PatientId='+$scope.ptId+'&parentfunctionname=cmdNewTelEncClick&enctype=2&index=-1&context=patienthub';url=makeURL(url);$scope.hublinkurl=url},function(e){})}else if(tabsel=='MED_SUM'){var hubMedicalSummaryPermission="";if(permissionKeyList.Values.length>0){hubMedicalSummaryPermission=permissionKeyList.Values[0]["Medical Summary"]==1?true:false}if(hubMedicalSummaryPermission){var age=calculateAgeFrom(parseStringToDate(yyyymmddTommddyyyy($scope.PatientHubInfo.dateOfBirth),'mm/dd/yyyy','/'));age=age.substring(0,age.indexOf('Y'));$scope.titlename="Medical Summary";$ocLazyLoad.load({name:'NewIframe',files:['/mobiledoc/jsp/webemr/templates/topPanel-tpl.js','/mobiledoc/jsp/webemr/toppanel/launchIframeController.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/launchIframemodal.jsp?ScreenName=Medical Summary&patientId="+$scope.ptId+"&Ptage="+age+"&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})}else{ecwAlert("You don't have permission to access Medical Summary. Please contact your administrator.","eClinicalworks");return false}}else if(tabsel=='DENTAL_SUM'){$scope.titlename="Dental Summary";$ocLazyLoad.load({name:'dental',files:['/mobiledoc/jsp/webemr/progressnotes/dental/dental.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/progressnotes/dental/dental.jsp?action=dentalSummary&encId=-1&patientId="+$scope.ptId+"&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})}else if(tabsel=='Letters'){if(undefined===pluginMode){if($scope.enableLetterPluginMode==undefined){$scope.enableLetterPluginMode=isPluginEnabled(1)}}else{$scope.enableLetterPluginMode=pluginMode}if(!$scope.enableLetterPluginMode){$ocLazyLoad.load({name:'NewLetters',files:['/mobiledoc/jsp/webemr/toppanel/letters/selectLetter.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/letters/selectLetter.jsp?context=patientHub&patientId="+$scope.ptId+"&encounterId="+$scope.encounterId+"&patientName="+encodeURIComponent(name)+"&webenabled="+$scope.PatientHubInfo.webenabled);$scope.hublinkurl=url},function(e){})}else{try{var param='id=LETTERS|patientId='+$scope.ptId;launchPlugin(param)}catch(err){}}}else if(tabsel=='LettersQuickMode'){if(undefined===pluginMode){if($scope.enableLetterPluginMode==undefined){$scope.enableLetterPluginMode=isPluginEnabled(1)}}else{$scope.enableLetterPluginMode=pluginMode}if(!$scope.enableLetterPluginMode){$ocLazyLoad.load({name:'QuickLetters',files:['/mobiledoc/jsp/webemr/toppanel/letters/quickLetter.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/letters/quickLetter.jsp?patientId="+$scope.ptId+"&encounterId="+$scope.encounterId+"&patientName="+encodeURIComponent(name));$scope.hublinkurl=url},function(e){})}else{launchPlugin('id=LETTERS|patientId='+$scope.ptId+'|LtrMode=1')}}else if(tabsel=="MedicalRecord"){var hubMedicalRecordPermission="";if(permissionKeyList.Values.length>0){hubMedicalRecordPermission=permissionKeyList.Values[0]["HubMedicalRecord"]==1?true:false}if(hubMedicalRecordPermission){medicalrecordViewLogs();launchPlugin('id=PMR|patientId='+$scope.ptId)}else{ecwAlert("You don't have permission to access Medical Record. Please contact your administrator.","eClinicalworks");return false}}else if(tabsel=="ECliniForms"){var pluginModeEnable=false;if(undefined===pluginMode){if($scope.enablePtDocPluginMode==undefined){pluginModeEnable=!isPluginDisabledForModule(3)}}else{pluginModeEnable=pluginMode}if(!pluginModeEnable){try{$ocLazyLoad.load({name:'eCliniFormModule',files:['/mobiledoc/jsp/webemr/toppanel/eCliniForm/eCliniFormController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/eCliniForm/eCliniFormScrn.jsp?patientId='+$scope.ptId+'&TrUserId='+global.TrUserId+'&token='+encodeURIComponent(csrfToken)+"&encounterId=0"+"&patientName="+name+"&context=hub"+"&webEnabledPat="+$scope.PatientHubInfo.webenabled);$scope.ecliniformURL=url},function(e){})}catch(err){}}else{launchPlugin('id=ECLINICFORMS|patientId='+$scope.ptId)}}else if(tabsel=="ECliniFormsQuickMode"){launchPlugin('id=ECLINICFORMS|patientId='+$scope.ptId+'|SignMode=1')}else if(tabsel=='BillingAlert'){$ocLazyLoad.load({name:'NewBillingAlert',files:['/mobiledoc/jsp/webemr/billingalert/billingalert.js','/mobiledoc/jsp/webemr/templates/topPanel-tpl.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/billingalert/billingAlert.jsp?patientId='+$scope.ptId);$scope.hublinkurl=url},function(){ecwAlert("An error occurred in loading billing/global alerts for patient.")})}else if(tabsel=='New_Appt'){if($scope.permissionForAppt){var itemKeyVal=getItemKeyValue('EnableInactiveDeceasedAppts');var isEnableInactiveDecease='';if(itemKeyVal){isEnableInactiveDecease=itemKeyVal.toLowerCase()=='yes'?true:false}if(!isEnableInactiveDecease){if(IsDeceased()){ecwAlert("Cannot create appointment for a deceased patient.","Appointment Error");return false}else if(IsInactive()){ecwAlert("Cannot create appointment for an inactive patient.","Appointment Error");return false}}var strPtObj="";var obj=new Object;obj.dob=$scope.PatientHubInfo.dateOfBirth;obj.phone=$scope.PatientHubInfo.homePhone;obj.address=$scope.PatientHubInfo.address+","+$scope.PatientHubInfo.address2;obj.email=$scope.PatientHubInfo.emailAddress;obj.webenabled=$scope.PatientHubInfo.webenabled;try{strPtObj=JSON.stringify(obj)}catch(err){}$ocLazyLoad.load({name:'Appointment',files:["/mobiledoc/jsp/webemr/scheduling/js/newAppointment.js","/mobiledoc/jsp/webemr/scheduling/css/appointment.css"]}).then(function(){var now=moment();var url=makeURL('/mobiledoc/jsp/webemr/scheduling/newAppointment.jsp?encounterId=&start='+now.format('hh:mm a')+'&end=&id='+global.TrUserId+'&name=&date='+now.format("MM/DD/YYYY")+'&pinAppointment=&visitType=&visitTypeDesc=&visitColor=&facilityId=&facilityName=&parentScreen=patientHub&patientName='+encodeURIComponent(name)+'&patientId='+$scope.ptId+"&ptObj=");$scope.hublinkurl=url},function(e){})}else{ecwAlert("Permission denied.","eClinicalworks")}}else if(tabsel=='NewAction'){var params={ActionId:"0",patientId:$scope.ptId,ms:(new Date).getTime()};params=$.param(params);$ocLazyLoad.load({name:'actionsDetailViewApp',files:['/mobiledoc/jsp/webemr/lookup/lookup.js','/mobiledoc/jsp/webemr/js/dateformat.js','/mobiledoc/jsp/webemr/templates/keywords-tpl.js','/mobiledoc/jsp/webemr/templates/structuredata-tpl.js','/mobiledoc/jsp/webemr/js/xeditable.min.js','/mobiledoc/jsp/webemr/css/xeditable.css','/mobiledoc/jsp/webemr/jellybean/telephoneencounter/actionsDetailView.js'],cache:true}).then(function(){var url="/mobiledoc/jsp/webemr/jellybean/telephoneencounter/actionsDetailView.jsp?"+params;$scope.hublinkurl=url},function(e){})}else if(tabsel=='ViewActions'){var params={patientName:name,patientId:$scope.ptId,ms:(new Date).getTime()};params=$.param(params);$ocLazyLoad.load({name:'actionsByPatientApp',files:['/mobiledoc/jsp/webemr/lookup/lookup.js','/mobiledoc/jsp/webemr/jellybean/telephoneencounter/actionsByPatient.js'],cache:true}).then(function(){var url="/mobiledoc/jsp/webemr/jellybean/telephoneencounter/actionsByPatient.jsp?"+params;$scope.hublinkurl=url},function(e){})}else if(tabsel=='LetterLogs'){$ocLazyLoad.load({name:'letterLogModule',files:['/mobiledoc/jsp/webemr/toppanel/letters/letterLogs.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/letters/letterLogs.html");var modalInstance=$modal.open({templateUrl:makeURL(url),controller:'letterLogController',backdrop:"static",windowClass:'app-modal-window bluetheme',resolve:{LogFilter:function(){return{"PatientId":$scope.ptId}}}});modalInstance.result.then(function(){setTimeout(function(){modalInstance=null},1)},function(e){setTimeout(function(){modalInstance=null},1)})},function(e){})}else if(tabsel=="Devices"){var files=['/mobiledoc/jsp/webemr/devices/DeviceWebController.js','/mobiledoc/jsp/webemr/labs/util/LabUtilities.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/js/clearbutton/clearUndoButton.js','/mobiledoc/jsp/webemr/templates/notes-tpl.js','/mobiledoc/jsp/webemr/js/ui-grid.min.js','/mobiledoc/jsp/webemr/css/ui-grid.min.css','/mobiledoc/jsp/webemr/devices/css/deviceReportModule.css'];$ocLazyLoad.load({name:'devicemodule',files:files}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/devices/DeviceScreenNewWeb.jsp?PtId="+$scope.ptId+"&DeviceName="+$scope.PatientHubInfo.devices[index].DeviceName+"&itemType="+$scope.PatientHubInfo.devices[index].DeviceModalityList[devicetype].Modality+"&callingFrom=Hub");$scope.hublinkurl=url},function(e){})}else if(tabsel=="PrintLabels"){var enablezebra=getItemKeyValue("EnableZebraLabelFeature",false);launchPlugin('id=PRINTLABELS|patientId='+$scope.ptId+'|callingFrom=patienthub|callingFor=regular|enablezebra='+enablezebra)}else if(tabsel=="templateList"){$ocLazyLoad.load({name:'templateListModule',files:['/mobiledoc/jsp/webemr/jellybean/reviewdocs/templateList.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/reviewdocs/templateList.jsp');$scope.hublinkurl=url},function(e){ecwAlert("Error occurred while launching template list window.","eClinicalWorks",null,"","bluetheme")})}else if(tabsel=="createTemplate"){$ocLazyLoad.load({name:'templateModule',files:['/mobiledoc/jsp/webemr/jellybean/reviewdocs/template.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/reviewdocs/template.jsp?action=1&templateId=0');$scope.hublinkurl=url},function(e){ecwAlert("Error occurred while launching template window.","eClinicalWorks",null,"","bluetheme")})}else if(tabsel=="dentalexamination"){$ocLazyLoad.load({name:'dental',files:['/mobiledoc/jsp/webemr/progressnotes/dental/dental.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/progressnotes/dental/dental.jsp?action=dentalExam&patientId='+$scope.ptId+'&encId=-1 &encProviderId=-1');$scope.hublinkurl=url},function(e){})}else if(tabsel=="PrintWristband"){if($attrs.bHasWristbandLabelPrintingAccess.toLowerCase()=="true"){var enablezebra=getItemKeyValue("EnableZebraLabelFeature",false);launchPlugin('id=PRINTLABELS|patientId='+$scope.ptId+'|callingFrom=patienthub|callingFor=custom|enablezebra='+enablezebra)}else{ecwAlert("You are not given access to view this page. This can be changed from security settings.","eClinicalWorks",null,"","bluetheme")}}else if(tabsel=="ProblemList"){var url="/mobiledoc/jsp/webemr/rightpanel/problemList.jsp?pid="+$scope.ptId+"&encId="+$scope.encounterId+"&callFrom=patientHub";$ocLazyLoad.load({name:'problemlist',files:['/mobiledoc/jsp/webemr/js/vendor/jscrollpane.js','/mobiledoc/jsp/webemr/rightpanel/js/plListController.js','/mobiledoc/jsp/webemr/progressnotes/billing/assessmentNotes-tpl.js','/mobiledoc/jsp/resources/jslib/angular-ui-bootstrap/dist/ui-bootstrap-tpls.js','/mobiledoc/jsp/webemr/progressnotes/assessment/assessment-import-module.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL(url),controller:'problemListController',backdrop:"static"});modalInstance.result.then(function(){},function(e){})})}else if(tabsel=="PL9to10"){$ocLazyLoad.load({name:'pl9to10',files:['/mobiledoc/jsp/webemr/toppanel/patientHub/PL9to10ConversionController.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/patientHub/ICD9toICD10Main.jsp?webemr=yes&frm=patienthub&search=&TrUserId="+global.TrUserId+"&ptId="+$scope.ptId+"&useicd10=1&vendorcode=IMO&hcc=0&itm=&encounterId=0");var modalInstance=$modal.open({templateUrl:makeURL(url),controller:'pl9to10Controller',backdrop:"static"})},function(e){})}else if(tabsel=="FaxLogs"){$ocLazyLoad.load({name:'faxLogModule',files:['/mobiledoc/jsp/webemr/jellybean/fax/faxLog.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/jellybean/fax/faxLog.jsp?patientId="+$scope.ptId);$scope.hublinkurl=url},function(e){})}else if(tabsel=="medicalRecordLogs"){$ocLazyLoad.load({name:'medRecordLogModule',files:['/mobiledoc/jsp/catalog/js/medicalRecordLog.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/catalog/medicalRecordLog.jsp?patientId="+$scope.ptId);$scope.hublinkurl=url},function(e){})}else if(tabsel=='FLOWSHEET'){PSACService.checkCommonStaffPermission($scope.ptId,function(data){$ocLazyLoad.load({name:'flowsheet',files:['/mobiledoc/jsp/webemr/toppanel/flowsheet/flowsheet.js','/mobiledoc/jsp/catalog/js/confTimeline.js']}).then(function(){var patientIdentifierObject=encodeURIComponent(typeof $scope.patientIdentifiers=="object"?JSON.stringify($scope.getPatientIdentifiers()):$scope.getPatientIdentifiers());var url=makeURL("/mobiledoc/jsp/webemr/toppanel/flowsheet/flowsheet.jsp?fromScreen=flowsheet&ScreenName=Flowsheet&patientId="+$scope.ptId+"&Ptage="+age+"&encounterId="+$scope.encounterId+"&nd="+(new Date).getTime())+"&ptIdentifier="+patientIdentifierObject;$scope.hublinkurl=url},function(e){})},function(){})}else if(tabsel=='PatientRecord'){if(global.bDisableP2PLinks){return}$scope.ptRecordPopupurl="";$ocLazyLoad.load({name:'newP2PMessage',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/newP2PMessageController.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/outgoingAttController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/patientrecord/newp2pmessage.jsp?parentFound=false&isP2P=1&patientId='+$scope.ptId);$scope.hublinkurl=url},function(e){})}else if(tabsel=='PtReferrals'){PSACService.checkCommonStaffPermission($scope.ptId,function(data){$scope.ptReferralURL="";$ocLazyLoad.load({name:'ptReferralApp',files:['/mobiledoc/jsp/webemr/jellybean/referral/ptReferralController.js'],cache:false}).then(function(){let defaultSelected=getRJellybeanDefaultScreen();var url=makeURL('/mobiledoc/jsp/webemr/jellybean/referral/ptReferrals.jsp?PatientId='+$scope.ptId+'&frompthub=true&contextfrom='+$scope.contextFrom+'&defultselecte='+defaultSelected);$scope.ptReferralURL=url},function(e){})},function(){})}else if(tabsel=='Referral'){if(global.bDisableP2PLinks){return}var params={refId:0,patientId:$scope.ptId,referralType:'Outgoing',callingFrom:'Patienthub'};params=$.param(params);$ocLazyLoad.load({name:'referralPopUpApp',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/commanP2PService.js','/mobiledoc/jsp/webemr/jellybean/referral/referralPopupController.js','/mobiledoc/jsp/webemr/templates/icd-tpl.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/EncDetailsService.js','/mobiledoc/jsp/webemr/templates/cpt-tpl.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/ICD_Treatment.js'],cache:false}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/referral/referralPopup.jsp?'+params);$scope.hublinkurl=url},function(e){})}else if(tabsel=='HealowAppt'){if(global.bDisableP2PLinks){return}var params={patientId:$scope.ptId};params=$.param(params);$ocLazyLoad.load({name:'healowApptBookingApp',files:['/mobiledoc/jsp/webemr/healowApptBooking/healowApptBookingController.js','/mobiledoc/jsp/webemr/jellybean/referral/refToLookupServicesModule.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/healowApptBooking/healowApptBooking.jsp?'+params);$scope.hublinkurl=url},function(e){})}else if(tabsel=='ConsultNotes'){var permissionStaff=false;permissionStaff=checkStaffPermissions($scope.ptId);if(permissionStaff){var HubConsultNotesPermission=false;if(permissionKeyList.Values.length>0){HubConsultNotesPermission=permissionKeyList.Values[0]["HubConsultNotes"]==1?true:false}if(HubConsultNotesPermission){$scope.strCaption="Consult Notes ("+name+")";$ocLazyLoad.load({name:'ptdocListModule',files:['/mobiledoc/jsp/webemr/toppanel/patientdoclist/patientdocList.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientdoclist/patientdocList.jsp?patientId='+$scope.ptId+'&ReportId='+$scope.ptId+'&DocType=ConsultNotes_doc&EncounterId=0&pncatId=0&pnitemId=0&TrUserId='+global.TrUserId+'&nd='+(new Date).getTime()+"&contextFrom="+$scope.contextFrom);$scope.hublinkurl=url},function(e){})}else{showMessage("You do not have the permission.","Permission denied.")}}else{showMessage("You need permission.","Permission denied.")}}else if(tabsel=='CCMRHub'){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs($scope,$ocLazyLoad).hub($scope.ptId)},function(e){})}else if(tabsel=='CreateVirtualVisit'){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs($scope,$ocLazyLoad).createVirtualVisit($scope.ptId)},function(e){})}else if(tabsel=='CCMREnroll'){$ocLazyLoad.load({name:'CcmModule',files:['/mobiledoc/jsp/webemr/ccmr/carePlanning/js/enrollmentController.js','/mobiledoc/jsp/webemr/populationhealth/js/phmInterfaceService.js','/mobiledoc/jsp/webemr/templates/keywords-tpl.js','/mobiledoc/jsp/webemr/behavioralhealth/directives/notesDirective/js/notesDirective.js','/mobiledoc/jsp/webemr/templates/spellCheck-tpl.js','/mobiledoc/jsp/webemr/ecwspeech/js/evaspeech.js','/mobiledoc/jsp/webemr/behavioralhealth/directives/notesDirective/css/notesDirective.css']}).then(function(){var params={patientId:$scope.ptId,programMode:'add',userMode:'single',ms:$.now(),enrollFlag:'quickEnroll'};params=$.param(params);var url='/mobiledoc/jsp/webemr/ccmr/carePlanning/enrollProgram.jsp?'+params;$scope.hublinkurl=url},function(e){})}else if(tabsel=='CPSP'){$ocLazyLoad.load({name:'CPSPModule',files:['/mobiledoc/jsp/webemr/webpm/CPSP/js/CPSPController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/webpm/CPSP/frmCPSP.jsp?PatId='+$scope.ptId);$scope.hublinkurl=url},function(e){})}else if(tabsel=='healow_tracker'){$ocLazyLoad.load({name:'PtCommSettings',files:getDependencies('concurrencyAlertsProvider').concat(['/mobiledoc/jsp/webemr/templates/topPanel-tpl.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/portal/questImport.js'])}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/healowhub/healowhub.jsp?userid="+global.TrUserId+"&uid="+$scope.ptId+"&encid="+$scope.encounterId+"&selectedTab=tracker&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})}else if(tabsel=="skintest/therapy"){windowClass:'bluetheme allergymodule',$ocLazyLoad.load({name:'Allergy',files:['/mobiledoc/jsp/allergy/css/multi-select.css','/mobiledoc/jsp/webemr/css/perfect-scrollbar.min.css','/mobiledoc/jsp/allergy/css/main.css','/mobiledoc/jsp/allergy/css/10ewidget.css','/mobiledoc/jsp/allergy/css/allergy-module.css','/mobiledoc/jsp/allergy/css/allergyShotAdmin.css','/mobiledoc/jsp/allergy/js/angular/angular-ui.min.js','/mobiledoc/jsp/allergy/js/allergyhub/SkinTestEncountersCtrl.js','/mobiledoc/jsp/allergy/js/allergyqueue/AllergyService.js','/mobiledoc/jsp/allergy/js/main.js','/mobiledoc/jsp/allergy/js/common/commonUtils.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/allergy/AllergyHub/SkinTestEncounters.jsp?PatientId='+$scope.ptId+'&isWeb=true');$scope.hublinkurl=url},function(e){})}else if(tabsel=='CaseMgmtHub'){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs($scope,$ocLazyLoad).caseMgmtHub($scope.ptId)},function(e){})}else if(tabsel=='ptCaseMgmtHub'){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs($scope,$ocLazyLoad).ptCaseMgmtHub($scope.ptId)},function(e){})}else if(tabsel=='carecommunity'){$scope.titlename="Care Community";$ocLazyLoad.load({name:'CareCommunityIframe',files:['/mobiledoc/jsp/webemr/toppanel/launchIframeController.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/launchIframemodal.jsp?ScreenName=CareCommunity&patientId="+$scope.ptId);$scope.hublinkurl=url},function(e){})}else if(tabsel=='WEB_ENABLE'){$ocLazyLoad.load({name:'PtCommSettings',files:['/mobiledoc/jsp/webemr/toppanel/voice/ptcommsettings.js','/mobiledoc/jsp/webemr/templates/topPanel-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientHub/patienthubController.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/voice/ptcommunicationsettings.jsp?uid='+$scope.patientId+'&nd='+(new Date).getTime());$scope.webEnablScreenUrl=url},function(e){console.log(e)})}else if($scope.behavioralHealthTabs.indexOf(tabsel)>-1){let pnScope=angular.element($("div[ng-controller='behavioralHealthProgressNotesController as bhVisitProgressNotes']")).scope();let pnPatientId=0;let currentTab='';let ptHubPatientId=parseInt($scope.ptId,10);if(pnScope){pnPatientId=parseInt(pnScope.bhVisitProgressNotes.patientId,10);currentTab=pnScope.bhVisitProgressNotes.behavioralHealthObj.currentTab}if(ptHubPatientId>0&&pnPatientId!==ptHubPatientId){if(currentTab!==tabsel){openBHTab(tabsel)}else{let message=tabsel+' cannot be accessed from the BH Hub as '+tabsel+' is already open in the background.'+'<br><br>To avoid data discrepancy for the patient, navigate away from the '+tabsel+' in the background prior to accessing the '+tabsel+' from the BH Hub.';$scope.openBHHubCommonWarningPopup('BH Hub','Access',message)}}else{toasterSvc.showErrorToaster("Unable to launch BH Hub while progress note is open. Please navigate back to the patient's progress note.",1e4)}}};function openBHTab(tabsel){let bhRequiredFiles=JSResourceObj["bhCommonJs"].split(",");bhRequiredFiles.push('/mobiledoc/jsp/webemr/behavioralhealth/progressnote/css/bhPatientHubTabs.css','/mobiledoc/jsp/webemr/behavioralhealth/progressnote/js/bhPatientHubTabs.js','/mobiledoc/jsp/webemr/behavioralhealth/js/behavioralhealth-service.js','/mobiledoc/jsp/webemr/behavioralhealth/directives/bhlogs/logsDirective.js','/mobiledoc/jsp/webemr/behavioralhealth/directives/notesDirective/js/notesDirective.js','/mobiledoc/jsp/webemr/ecwspeech/js/evaspeech.js');$ocLazyLoad.load({name:'bhPatientHubTabsApp',files:bhRequiredFiles}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL("/mobiledoc/behavioralhealth/BHPatientHubSecurity/getBHPatientHubUrl"),controller:'bhPatientHubTabsCrl as bhPtHub',windowClass:'bluetheme bh-patient-hub-modal-width',backdrop:'static',keyboard:false,resolve:{model:function(){return{"patientId":$scope.ptId,"selectedTab":tabsel}}}});modalInstance.result.then(function(){},function(response){if(response&&response.data&&422===response.data.statusCode){$scope.openBHHubSecurityAccessPopup()}})})}function getRJellybeanDefaultScreen(){$scope.jellyBeanObj=getJellyBeanSettings();let defaultSelected="Incoming";if($scope.jellyBeanObj.RJellyDefaultScreen==="0"){defaultSelected="Outgoing"}else if(getItemKeyValue("EnableDentalPreDetermination").toUpperCase()==='YES'&&$scope.jellyBeanObj.RJellyDefaultScreen==="3"){defaultSelected="PreDetermination"}return defaultSelected}$scope.patientRxSummaryUrl="";$scope.openPatientMedicationSummary=function(){var jspName='/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/patientRxSummary.jsp';var jsName='/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/patientRxSummary.js';if($scope.patientRxSummaryUrl!==""){$templateCache.remove($scope.patientRxSummaryUrl)}$ocLazyLoad.load({name:'PatientMedicationSummaryModule',files:[jsName]}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/patientRxSummary.jsp?encounterId='+$scope.encounterId+'&patientId='+$scope.ptId+'&trUserId='+global.TrUserId);$scope.patientRxSummaryUrl=url})};$scope.cancelECFormView=function(){$scope.ecliniformURL=""};var CalculatePtHubPatientAge=function(inactiveStatus,patientDOB,deceasedDate){var isPatientDeceased=false;var age="";if(inactiveStatus&&inactiveStatus.trim()=='(Deceased)'){isPatientDeceased=true}if(isPatientDeceased){if(deceasedDate!=null&&deceasedDate!=""){if(getDateDiff(patientDOB,deceasedDate)>=0){age=calculateExactAgeInMYD(_toDate(patientDOB),12,_toDate(deceasedDate),true,true)}else{ecwAlert("The Deceased Date cannot precede the Date of Birth.","eClinicalWorks","","","");age=""}}else{age=""}}else{if(!isPatientDeceased){age=calculateExactAgeInMYD(_toDate(patientDOB),12,new Date,true,true)}else{age=""}}return age};function getPatientEncounters(patientId){var serverUrl='/mobiledoc/jsp/catalog/xml/getPtEncounters.jsp?PatientId='+patientId;var ptEncountersXML=urlGet(serverUrl);var jsonData=xml2json(ptEncountersXML);return jsonData.Envelope.Body['return'].resultset.data.row}function getPatientDemograpic(){let patientData={};let data={pid:$scope.ptId,encounterId:$scope.encounterId};let response=urlPost(makeURL("/mobiledoc/jsp/webemr/toppanel/patientHub/fetchPatientHub.jsp"),data);if(response){patientData=preparePatientData(response)}return patientData}function preparePatientData(patientDemographicJson){var patientData={};if(patientDemographicJson){if(!$scope.encounterId||$scope.encounterId===0){$scope.encounterId=patientDemographicJson.patientinfo.EncounterId}if(patientDemographicJson.patientinfo.BHHubEnabled){$scope.hasBhHubAccess=getPermission("AllowAccessToBHHub",global.TrUserId)}patientData=patientDemographicJson.patientinfo;$scope.enableCorrectionalFeatures=getItemKeyValue("EnableCorrectionalFeatures").toLowerCase()=="yes";if($scope.enableCorrectionalFeatures){$scope.corrConfig={SIDLabel:getItemKeyValue("Corrections_SIDLabel"),BnCLabel:getItemKeyValue("Corrections_BCLabel")};patientData.nycid=patientDemographicJson.patientinfo.NYCID;patientData.mDesignation=patientDemographicJson.patientinfo.MDesignation;patientData.suicideWatch=patientDemographicJson.patientinfo.SuicideWatch;patientData.facility=patientDemographicJson.patientinfo.Facility;patientData.housingArea=patientDemographicJson.patientinfo.HousingArea;patientData.dischargeDate=patientDemographicJson.patientinfo.DischargeDate;patientData.admissionDate=patientDemographicJson.patientinfo.AdmissionDate;patientData.nextCourtDate=patientDemographicJson.patientinfo.NextCourtDate;patientData.AKAName=patientDemographicJson.patientinfo.AKA1I;patientData.AKANameTitle='AKA Name 1:'+patientDemographicJson.patientinfo.AKA1I+' \nAKA Name 2:'+patientDemographicJson.patientinfo.AKA2I+' \nAKA Name 3:'+patientDemographicJson.patientinfo.AKA3I}patientData.ID=$scope.ptId;patientData.fname=!patientDemographicJson.patientinfo.FNAME?"":unescapeHtml(patientDemographicJson.patientinfo.FNAME);patientData.lname=!patientDemographicJson.patientinfo.LNAME?"":unescapeHtml(patientDemographicJson.patientinfo.LNAME);patientData.mname=!patientDemographicJson.patientinfo.MNAME?"":patientDemographicJson.patientinfo.MNAME;patientData.preferredName=!patientDemographicJson.patientinfo.PREFERREDNAME?"":unescapeHtml(patientDemographicJson.patientinfo.PREFERREDNAME);patientData.formatedPrefName=!patientDemographicJson.patientinfo.FORMATEDPREFNAME?"":patientDemographicJson.patientinfo.FORMATEDPREFNAME;patientData.fullName=patientData.lname+', '+patientData.fname+' '+patientData.mname;patientData.age=CalculatePtHubPatientAge(patientDemographicJson.patientinfo.Inactive,patientDemographicJson.patientinfo.DOB,patientData.deceasedDate);patientData.isPatientUnder22years=_calculateAge(_toDate(patientDemographicJson.patientinfo.DOB))<=21;patientData.gender=patientDemographicJson.patientinfo.GENDER;patientData.transgender=patientDemographicJson.patientinfo.Transgender;patientData.address=patientDemographicJson.patientinfo.ADDRESS1;patientData.address2=patientDemographicJson.patientinfo.ADDRESS2;patientData.dateOfBirth=patientDemographicJson.patientinfo.DOB;patientData.mobilePhone=patientDemographicJson.patientinfo.CELLPHONE;patientData.homePhone=patientDemographicJson.patientinfo.HOMEPHONE;patientData.workPhone=patientDemographicJson.patientinfo.WORKPHONE;patientData.emailAddress=patientDemographicJson.patientinfo.EMAIL;patientData.city=patientDemographicJson.patientinfo.CITY;patientData.state=patientDemographicJson.patientinfo.STATE;patientData.zip=patientDemographicJson.patientinfo.ZIP;patientData.strNamewithsuffix=!patientDemographicJson.patientinfo.FULLNAMEWITHSUFFIX?"":unescapeHtml(patientDemographicJson.patientinfo.FULLNAMEWITHSUFFIX);var addrStr="";if(patientDemographicJson.patientinfo.ADDRESS1&&patientDemographicJson.patientinfo.ADDRESS2){addrStr=patientDemographicJson.patientinfo.ADDRESS1+","+patientDemographicJson.patientinfo.ADDRESS2}else if(patientDemographicJson.patientinfo.ADDRESS1&&!patientDemographicJson.patientinfo.ADDRESS2){addrStr=patientDemographicJson.patientinfo.ADDRESS1}else if(!patientDemographicJson.patientinfo.ADDRESS1&&patientDemographicJson.patientinfo.ADDRESS2){addrStr=patientDemographicJson.patientinfo.ADDRESS2}patientData.citystatezip='';if(patientData.city)patientData.citystatezip=patientData.city;if(patientData.state){patientData.citystatezip=patientData.citystatezip+','+patientData.state}if(patientData.zip){patientData.citystatezip=patientData.citystatezip+'-'+patientData.zip}if(addrStr.length>0&&patientData.citystatezip.length>0)patientData.fullAddr=addrStr+", "+patientData.citystatezip;else if(addrStr.length==0&&patientData.citystatezip.length>0)patientData.fullAddr=patientData.citystatezip;else if(addrStr.length>0&&patientData.citystatezip.length==0)patientData.fullAddr=addrStr;else patientData.fullAddr='';patientData.altAddressExist=patientDemographicJson.patientinfo.altAddressExist;$scope.isPatientPictureLoadStart=false;patientPictureService.getUsingDefaultCache(patientDemographicJson.patientinfo.picPath).then(function(path){$timeout(function(){$scope.isPatientPictureLoadStart=true;patientData.picPath=path},1500)});patientData.pcp=patientDemographicJson.patientinfo.PCP;patientData.pcpid=patientDemographicJson.patientinfo.PCPId;patientData.mrn=patientDemographicJson.patientinfo.MRN;if(getPermission("AccessPatientBalance",global.TrUserId)==false){patientData.ptBalance="No Access";patientData.acBalance="No Access";patientData.collBalance="No Access";patientData.patientCollectionBalance="No Access"}patientData.EncounterReason=patientDemographicJson.patientinfo.encounterReason;var device=patientDemographicJson.patientinfo.DevicesHubList;patientData.bDevicesConfigured=device.IsAnyDevicesConfigured;patientData.devices=device.DeviceList;patientData.externalreporturl_pthub=patientDemographicJson.patientinfo.ExternalReportsURL;patientData.externallaunchurl=patientDemographicJson.patientinfo.ExternalURLLaunch;patientData.isDentalExamEnabled=getPermission("AccessDentalExamFromPatientHub",global.TrUserId);if(patientDemographicJson.patientinfo.hasOwnProperty('EnableIHEDocumentSharing')){patientData.IHEDocumentSharing=true;patientData.IHEDocumentSharingCaption=patientDemographicJson.patientinfo.EnableIHEDocumentSharing}else{patientData.IHEDocumentSharing=false}if(patientDemographicJson.patientinfo.hasOwnProperty('ehxDocURLCaption')){patientData.ehxDocumentSharing=true;patientData.ehxDocumentSharingCaption=patientDemographicJson.patientinfo.ehxDocURLCaption;patientData.ehxUrl=patientDemographicJson.patientinfo.ehxUrl}else{patientData.ehxDocumentSharing=false}if(patientDemographicJson.patientinfo.hasOwnProperty('careFxCaption')){patientData.careFx=true;patientData.careFxCaption=patientDemographicJson.patientinfo.careFxCaption}else{patientData.careFx=false}if(patientDemographicJson.patientinfo.hasOwnProperty('tuftsURLCaption')){patientData.tuftsLink=true;patientData.tuftsLinkCaption=patientDemographicJson.patientinfo.tuftsURLCaption}else{patientData.tuftsLink=false}if(patientDemographicJson.patientinfo.hasOwnProperty('PHNLinkURLCaption')){patientData.PHNLink=true;patientData.PHNLinkCaption=patientDemographicJson.patientinfo.PHNLinkURLCaption}else{patientData.PHNLink=false}if(patientDemographicJson.patientinfo.hasOwnProperty('careProfileUrl')){patientData.careProfile=true;patientData.careProfileUrl=patientDemographicJson.patientinfo.careProfileUrl}else{patientData.careProfile=false}patientData.isHealowInsightsHospice=patientDemographicJson.patientinfo.isHealowInsightsHospice;patientData.isPartiallyMerged=patientDemographicJson.patientinfo.isPartiallyMerged}return patientData}$scope.loadrpanel=function(){if($("#hubrightpanel").html()&&$("#hubrightpanel").html().length>0){$('#patient_hub1').find('.icon-greenarrow').toggleClass('active');var rpane=$('#phub_dialog');var prog=$('.icon-greenarrow').closest('.modal-content').find('.right-panel');var prewrap=$('.presc-wrap');if(rpane.hasClass('visible')){rpane.animate({"width":"891px"},"2000").removeClass('visible')}else{rpane.animate({"width":"1290px"},"2000").addClass('visible')}if(prog.hasClass('visible')){prog.animate({"margin-right":"0"},"2000").removeClass('visible')}else{prog.animate({"margin-right":"399px"},"2000").addClass('visible')}}else if($scope.isValidPatient){$ocLazyLoad.load({name:'NewRightPanel',files:['/mobiledoc/jsp/webemr/rightpanel/js/rpTabsCtrl.js']}).then(function(){$http({method:"GET",url:"/mobiledoc/jsp/webemr/rightpanel/rightPanel.jsp",cache:false,params:{TrUserId:global.TrUserId,context:'patienthub',patientId:$scope.ptId,encounterId:$scope.encounterId}}).success(function(data,status,headers,config){var compiledData=$compile(data)($scope);$("#hubrightpanel").html(compiledData);$('#patient_hub1').find('.icon-greenarrow').toggleClass('active');var rpane=$('#phub_dialog');var prog=$('.icon-greenarrow').closest('.modal-content').find('.right-panel');var prewrap=$('.presc-wrap');if(rpane.hasClass('visible')){rpane.animate({"width":"891px"},"2000").removeClass('visible')}else{rpane.animate({"width":"1290px"},"2000").addClass('visible')}if(prog.hasClass('visible')){prog.animate({"margin-right":"0"},"2000").removeClass('visible')}else{prog.animate({"margin-right":"399px"},"2000").addClass('visible')}}).error(function(data,status,headers,config){BootstrapDialog.alert("Error occured while getting right panel")})},function(e){})}};$scope.onLoad=function(){$scope.checkBreakGlassWarning();if($scope.showhiderightpanel=="1"){$scope.loadrpanel()}launchClinicalRuleEngine($ocLazyLoad,$http,$scope,'hub',"PatientHub",$scope.ptId,$scope.encounterId)};$scope.checkBreakGlassWarning=function(){if($scope.ptId>0&&getItemKeyValue("EnterpriseDirectory").toLowerCase()==="yes"&&getItemKeyValue("EnableBreakGlass").toLowerCase()==="yes"&&getPermission("EnableBreakGlass",global.TrUserId)){var warningObj=checkEnterpriseAccess($scope.ptId,global.TrUserId);if(warningObj.Warning=="true"){$scope.openBreakGlassModal($scope.ptId,global.TrUserId,warningObj.WarnId)}else{$scope.loadPatientHub()}}else{if($scope.btHealowPlusAccess){ecwAlert("You are not authorized to access this feature. Please contact support.")}else{$scope.loadPatientHub()}}};$scope.showPtCollBalance=false;$scope.forceRefreshPatientPictureImage=function(){patientPictureService.getUsingDefaultCache($scope.PatientHubInfo.picPath,true).then(function(path){$scope.PatientHubInfo.picPath=path})};$scope.getPatientHubStructureData=function(){resetStructPagination();$http({url:makeURL("/mobiledoc/emr/patienthub/structuredata"),method:"POST","async":true,headers:{'Content-Type':'application/x-www-form-urlencoded'},params:{patientId:$scope.ptId}}).success(function(structData){if(structData){if(!jQuery.isEmptyObject(structData)){$scope.patientHubStructData=getStructuredData(structData);$scope.getStructureDataWithPagination()}}})};var resetStructPagination=function(){$scope.structDataCurrentPage=1;$scope.structDataPageSize=9;$scope.patientHubStructArray=[];$scope.totalDisplayed=0};$scope.getStructureDataWithPagination=function(){$scope.totalItems=$scope.patientHubStructData.length;let tPages=$scope.totalItems/$scope.structDataPageSize;$scope.totalPages=Math.ceil(tPages);let startIndex=0;let endIndex=0;if($scope.structDataCurrentPage<1){$scope.structDataCurrentPage=1}else if($scope.structDataCurrentPage>$scope.totalPages){$scope.structDataCurrentPage=$scope.totalPages}if($scope.totalItems<=$scope.structDataPageSize){startIndex=0;endIndex=$scope.totalItems-1}else{startIndex=($scope.structDataCurrentPage-1)*$scope.structDataPageSize;endIndex=Math.min(startIndex+$scope.structDataPageSize-1,$scope.totalItems-1)}$scope.structDataCurrentPage++;for(let i=startIndex;i<=endIndex;i++){$scope.patientHubStructArray.push($scope.patientHubStructData[i])}$scope.totalDisplayed=$scope.patientHubStructArray.length};$scope.loadPatientHub=function(){if($attrs.bHasPtHubAccess.toLowerCase()=="true"){$("#patient_hub").modal('show');$scope.strEnableExtColl=getItemKeyValue("EnableExternalCollections");if($scope.strEnableExtColl.toUpperCase()=='YES'){$scope.showPtCollBalance=true}else{$scope.isVendorActivated()}$scope.PatientHubInfo=getPatientDemograpic();$scope.EnableOrDisableContextSensitiveButton(window.navigator.userAgent.indexOf("Mac")!==-1?"macprojecte":"winprojecte","","",false);$scope.updatePatientIdentifier();if($scope.PatientHubInfo.ExternalReports!=''&&$scope.isMultipleSSOEnabled){$scope.getVendorSSOUrlData()}$scope.patientHubStructData=$scope.getPatientHubStructureData()}else{ecwAlert("You do not have permissions to access the Patient Hub. Please contact your administrator.");if($('#patient_hub1')){$('#patient_hub1').scope().$destroy();$("#patient_hub1").remove()}}};$scope.updatePatientIdentifier=function(){if($scope.PatientHubInfo){$scope.patientIdentifiers={id:$scope.ptId,firstName:$scope.PatientHubInfo.fname,lastName:$scope.PatientHubInfo.lname,middleInitial:$scope.PatientHubInfo.mname,suffix:$scope.PatientHubInfo.suffix,dateOfBirth:$scope.PatientHubInfo.dateOfBirth,sex:$scope.PatientHubInfo.gender,accountNumber:$scope.PatientHubInfo.accountno}}else{$scope.patientIdentifiers={id:$scope.ptId}}};$scope.isVendorActivated=function(){$http({method:"POST",url:"/mobiledoc/jsp/catalog/xml/getIsVendorActivated.jsp",headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){var x2js=new X2JS;var objJson=x2js.xml_str2json(response);if(!angular.isUndefined(objJson)&&!angular.isUndefined(objJson.Envelope.Body['return'].status)&&objJson.Envelope.Body['return'].status=="success"){if(!angular.isUndefined(objJson.Envelope.Body['return'].isVendorActivated)){if(objJson.Envelope.Body['return'].isVendorActivated==1){$scope.showPtCollBalance=true}}}})};$scope.getVendorSSOUrlData=function(){var strUrl="/mobiledoc/jsp/webemr/toppanel/patientHub/getVendorSSOUrl.jsp?TrUserId="+global.TrUserId+"&action=getVendorSSOURL&pid="+$scope.ptId;$.ajax({url:strUrl,cache:false,success:function(response){var data=response.trim();if(data){$scope.vendorData=JSON.parse(data)}},error:function(response){ecwAlert("Error")}})};$scope.confirmEnc=function(){if($scope.PatientHubInfo.isDeleted===1){var bootDialog=bootbox.dialog({message:"The patient is deleted, Do you still want to continue?",title:"eClinicalWorks",size:'small',className:"bluetheme",buttons:{confirm:{label:"Yes",callback:function(){$scope.loadmodalurl('New_Appt')}},cancel:{label:"No",callback:function(){}}}}).css("z-index","31000").css('padding-top','10%');bootDialog.removeClass("orangetheme")}else{$scope.loadmodalurl('New_Appt')}};$scope.openBreakGlassModal=function(patientId,nTrUserId,warningid){$ocLazyLoad.load({name:"breakGlassWarning",files:["/mobiledoc/jsp/webemr/menu/file/enterpriseDirectory/js/breakGlassWarningController.js"],cache:true}).then(function(){var url='/mobiledoc/jsp/webemr/menu/file/enterpriseDirectory/breakGlassWarning.jsp?nTrUserId='+nTrUserId+'&ptid='+patientId+'&warningid='+warningid;var customStructModalInstance=$modal.open({templateUrl:makeURL(url),controller:'breakGlassWarningController',windowClass:'app-modal-window bluetheme breakGlassModalDiv',backdrop:"false",keyboard:false});customStructModalInstance.result.then(function(){$scope.loadPatientHub()},function(result){})})};var count=$("div[id*='patient_hub1']").length;if(count==1){$scope.onLoad()}function imageExists(url123,callback){var img123=new Image;img123.onload=function(){callback(true)};img123.onerror=function(){callback(false)};img123.src=url123}var imageUrl_Base='file://C|/Temp/WinProjectE/Images/close.png';function CheckFile(){var imageUrl=imageUrl_Base;imageExists(imageUrl,function(exists){if(exists){ecwAlert('Please use the installed Native eCWapp to perform this operation. (Path: C:\\Program Files (x86)\\eClinicalWorks\\WinProjectE\\WinProjectE.exe)')}else{if(confirm("This operation cannot be performed using web-broser, Do you want to download native eCWapp?")==true){var arrow=document.getElementById('arrow-chrome');arrow.style.display='block';var i=0;var x=setInterval(function(){i+=.1;arrow.style.opacity=i},50);setTimeout(function(){clearInterval(x);arrow.style.opacity=0},2e3);window.location="http://"+window.location.host+"/mobiledoc/WinProjectE_Installer.EXE"}}})}$scope.CheckBrowser=function(){var is_ecw_native_app=navigator.userAgent.toLowerCase().indexOf('ecw_winproject_e_1.1.0')>-1;if(!is_ecw_native_app){window.open("http://"+window.location.host+"/mobiledoc/WinProjectE/Application%20Files/WinProjectE_1_0_0_9/WinProjectE.application")}else{$scope.RunSignaturePadApplication()}};$scope.loadBillingLog=function(){PSACService.checkCommonStaffPermission($scope.ptId,function(data){var queryString="?tabOnId=1";queryString+="&EntityType=2";queryString+="&EntityId="+$scope.ptId;queryString+="&txtDateFrom=";queryString+="&txtDateTo=";queryString+="&PatientId="+$scope.ptId;queryString+="&InvId="+$scope.ptId;queryString+="&sortBy=1";queryString+="&sortOrder=DESC";queryString+="&LogCategory=All";$ocLazyLoad.load({name:'claimsBillingLogModule',files:['/mobiledoc/jsp/webemr/webpm/js/claimBillingLogs.js','/mobiledoc/jsp/webemr/webpm/js/commonFunction.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/webpm/claimBillingLogs.jsp"+queryString);$scope.loadBillingLogUrl=url},function(e){})})};$scope.ptCommunication_click=function(){$ocLazyLoad.load({name:'PtCommSettings',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/voice/ptcommsettings.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/voice/ptcommunicationsettings.jsp?uid='+$scope.ptId+'&nd='+(new Date).getTime());$scope.hublinkurl=url},function(e){})};$scope.openSingleSendMessage_pthub=function(){if($scope.PatientHubInfo.webenabled&&$scope.PatientHubInfo.webenabled=='1'||$scope.PatientHubInfo.voiceenabled&&$scope.PatientHubInfo.voiceenabled=='1'){if($scope.ptId>0){$scope.hublinkurl="";$ocLazyLoad.load({name:'sendMessageModule',files:getDependencies('sendMessage')}).then(function(){var param="TrUserId="+global.TrUserId;param+="&patientIds="+$scope.ptId;param+="&msgSource="+$("#hdMsgSource_pthub").val();var url=makeURL('/mobiledoc/jsp/webemr/singlesend/sendMessage.jsp?'+param);$scope.hublinkurl=url;evaFavoriteService.showEvaFavorite("Do you know you can quickly send message via EVA.<br>"+"Command : send a text message to (Patient_Name)<br>"+"Would you like to add this command to your favorites?","sendtextMessage")},function(e){})}else{BootstrapDialog.alert({title:"eClinicalworks",message:'Please select Patient !'})}}else{ecwAlert("Patient is not web/voice/text enabled!","eClinicalworks")}};$scope.openPatientPayment=function(){var param={patientId:$scope.ptId,parentScreen:"patientHub"};loadReceivePayment($ocLazyLoad,$modal,param)};$scope.loadGuarantorBal=function(){$ocLazyLoad.load({name:'guarantorAccountApp',files:['/mobiledoc/jsp/webemr/webpm/js/guarantorAccount.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/webpm/guarantorAccount.jsp?patientId="+$scope.ptId+"&userType=3&parentScreen=patientHub&grId="+$scope.PatientHubInfo.GuarantorId);$scope.hublinkurl=url},function(e){})};$scope.loadDocumentView=function(patientId,docId){$ocLazyLoad.load({name:'documentViewModule',files:['/mobiledoc/jsp/webemr/jellybean/reviewdocs/documentView.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/jellybean/reviewdocs/documentView.jsp?navigate=yes&leftPanel=1&toprightPanel=0&docId="+docId+"&patientId="+patientId+"&encounterId="+0+"&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})};$scope.cancelDocumentView=function(){};$scope.createNewTelEnc=function(patientId,filePath,fileName){var msg="Document attached from fax inbox.";$ocLazyLoad.load({name:'TJellyDetailView',files:getDependencies('TJellyDetailView')}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/telephoneencounter/JellyBeanT-Telephone-Encounter-DetailView.jsp';url+='?enctype=2&index=-1&context=patientdocs&EncounterId=0&PatientId='+patientId+'&filePath='+filePath+'&fileName='+fileName+'&message='+msg;url=makeURL(url);$scope.hublinkurl=url},function(e){})};$scope.openPatientAllCommunicationLogs_ptHub=function(type){if($scope.ptId>0){if(window.voiceLogs_global){voiceLogsBackUpForMainScreen=voiceLogs_global}if(window.smsLogs_global){smsLogsBackUpForMainScreen=smsLogs_global}var name=$scope.PatientHubInfo.lname+","+$scope.PatientHubInfo.fname;var logUrl="/mobiledoc/jsp/webemr/messenger/communicationLogs.jsp?type=voice&frmHub=true&patientId="+$scope.ptId+"&patientName="+name;if(type=='voice'){logUrl="/mobiledoc/jsp/webemr/messenger/communicationLogs.jsp?type=voice&frmHub=true&patientId="+$scope.ptId+"&patientName="+name}else if(type=='portal'){logUrl="/mobiledoc/jsp/webemr/messenger/communicationLogs.jsp?type=portal&frmHub=true&patientId="+$scope.ptId+"&patientName="+name}$ocLazyLoad.load({name:'communicationLogs'}).then(function(){$scope.frameMsgLogs=makeURL(logUrl)},function(e){});$("#dlgMSgLogs").modal({backdrop:'static',keyboard:false});$("#dlgMSgLogs").css("border","none");return true}else{ecwAlert("please select patient then try again.","Alert");return false}};$scope.closeMsgLogsDialuge=function(){$('#dlgMSgLogs').modal('hide');if($('.communicationLogsMAINDIV').length>1){voiceLogs_global=voiceLogsBackUpForMainScreen;smsLogs_global=smsLogsBackUpForMainScreen}else{try{DeleteMainDiv_SmsLogs()}catch(e){}try{DeleteMainDiv_VoiceLogs()}catch(e){}try{var scope=angular.element(document.getElementById("communicationLogsMainDiv")).scope();scope.$destroy();scope=null}catch(e){}}};$scope.openexternalreports_multipleSSO=function(url){if($scope.ptId>0){$scope.externalreporturlvalue=$sce.trustAsResourceUrl(url);if($scope.PatientHubInfo.externallaunchurl=='yes'){window.open($scope.externalreporturlvalue)}else{$("#myextreport").modal({backdrop:'static',keyboard:false});$("#myextreport").css("border","none").css("margin-left","-720px");$("#myextreport .modal-content").css("height","650").css("width","1290px");$("#frameextreport").css("height","620").css("margin-top","-8px")}}else{ecwAlert("please select patient then try again.","Alert");return false}};$scope.openexternalreports_pthub=function(){if($scope.ptId>0){if($scope.PatientHubInfo.externallaunchurl==='yes'){$scope.externalreporturlvalue=$sce.trustAsResourceUrl($scope.PatientHubInfo.externalreporturl_pthub);window.open($scope.externalreporturlvalue)}else{if(!$scope.isWebOMREnabled){$scope.externalreporturlvalue=$sce.trustAsResourceUrl($scope.PatientHubInfo.externalreporturl_pthub);$("#myextreport").modal({backdrop:'static',keyboard:false});$("#myextreport").css("border","none").css("margin-left","-720px");$("#myextreport .modal-content").css("height","650").css("width","1290px");$("#frameextreport").css("height","620").css("margin-top","-8px");return}if($scope.openexternalreportsWindowObject!=null&&!$scope.openexternalreportsWindowObject.closed){$scope.openexternalreportsWindowObject.focus();return}$.ajax({url:$scope.PatientHubInfo.externalreporturl_pthub+"&agent=web",type:"GET",dataType:"html",success:function(data){if($scope.isHTML(data)){$scope.openModalWindow("","","650","1290");$scope.openexternalreportsWindowObject.document.body.innerHTML=data}else{$scope.openModalWindow(data,"","650","1290")}},error:function(xhr,status){ecwAlert("Cannot Proceed further. Reason : Unable to generate URL")}})}}else{ecwAlert("please select patient then try again.","Alert");return false}};$scope.isHTML=function(str){var doc=(new DOMParser).parseFromString(str,"text/html");return Array.from(doc.body.childNodes).some(node=>node.nodeType===1)};$scope.openModalWindow=function(url,windowName,height,width){let left=(screen.width-width)/2;let top=(screen.height-height)/4+50;$scope.openexternalreportsWindowObject=window.open(url,windowName,"width="+width+",height="+height+",center=yes,status=no,scrollbars=yes,resizable=yes,top="+top+", left= "+left)};$scope.getPtDemographicHub=function(){$scope.PatientHubInfo=getPatientDemograpic()};$scope.optinPatientForEhx=function(pid){$ocLazyLoad.load({name:'ehxConsent',files:['/mobiledoc/jsp/webemr/empi/consent/js/PatientConsentCtrl.js','/mobiledoc/jsp/catalog/xml/keywords/js/ecw-keywords.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/empi/consent/ptConsentDecision.jsp?pid="+pid+"&userId="+global.TrUserId+"&consentType=0&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){ecwAlert("Error "+e)})};$scope.optinPatientForSSO=function(pid){$ocLazyLoad.load({name:'ssoGHSMoad'}).then(function(){var url=makeURL("/mobiledoc/jsp/sso/SSOInGHS.jsp?reqType=webemr&pid="+pid+"&userId="+global.TrUserId);$scope.hublinkurl=url},function(e){ecwAlert("Error "+e)})};if($scope.PatientHubInfo.eHXEnabled){var strConsenttoView=getEhxItemKeyValue('CommunityConsentType').toLowerCase();if('view'==strConsenttoView||'disclose'==strConsenttoView){$scope.ehxConsentRecv=true}else{var promiseEhxData=getPromiseForPtEhxData($scope.ptId,global.TrUserId,'consentSigned',"patientHub");promiseEhxData.then(function(result){if(result=='true'){$scope.ehxConsentRecv=true}else{$scope.ehxConsentRecv=false}})}}$scope.getPregListItems=function(){$scope.pregListItems=[];$scope.PregnancyExist=false;if(patientHub_pregListXml&&patientHub_pregListXml!=''){var jsonVal=xml2json(patientHub_pregListXml);var value=jsonVal.Envelope.Body['return'].encounter;if(value){if(value.length>0){$scope.pregListItems=value}else{$scope.pregListItems.push(value)}$scope.PregnancyExist=true}}};$scope.loadOBSummary=function(obj){$scope.hublinkurl="";$ocLazyLoad.load({name:'pregnancysummary',cache:false,files:['/mobiledoc/jsp/webemr/obFlowsheet/obSummary/obSummaryController.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/obFlowsheet/obSummary/OB-Summary.jsp?encounterId="+$scope.encounterId+"&patientId="+ +$scope.ptId+"&pregId="+obj+"&userId="+global.TrUserId+"&nd="+(new Date).getTime());$scope.hublinkurl=url},function(e){})};$scope.exportToEHX=function(type){var title='eEHX Export  '+document.getElementById('ptIdentifierHTML').innerHTML;var strExportWithoutConsent=getItemKeyValue('empi_CCRExportWithoutConsent').toLowerCase();if(type=='DOC'&&($scope.ehxConsentRecv==true||strExportWithoutConsent=='yes')){ecwConfirm(" Are you sure you want to export the patient's docs to eHX?  ",title,function(){exportDocsToEhx($scope.ptId,global.TrUserId)},function(){return})}else if($scope.ehxConsentRecv==true){if(type=='CCR'){ecwConfirm("Are you sure you want to export the patient's 'eHealth Summary' to eHX? ",title,function(){ehxCommonFuncsExportCCRToEhx($scope.ptId)},function(){return})}else if(type=='LAB'){ecwConfirm(" Are you sure you want to export the patient's lab/imaging to eHX? ",title,function(){exportLabsToEhx($scope.ptId)},function(){return})}}else{var msg='';if(type=='CCR'){msg=', no eHS is exported.'}else if(type=='LAB'){msg=', no lab/imaging is exported.'}else if(type=='DOC'){msg=', document(s) cannot be exported.'}showMessage('This Patient is not opted-in to eEHX'+msg)}};$scope.showCaseManagers=function(){$ocLazyLoad.load({name:'billingCaseManagerModuel',files:["/mobiledoc/jsp/webemr/webpm/casemanager/js/billingCaseManager.js"]}).then(function(){$scope.selectCaseManagerURL=makeURL("/mobiledoc/jsp/webemr/webpm/casemanager/billingCaseManager.jsp?PatientId="+$scope.ptId+"&select=False")},function(e){})};$scope.destroyBillingCaseManModal=function(){$scope.selectCaseManagerURL=""};$scope.refreshhub=function(){$scope.PatientHubInfo=getPatientDemograpic();$scope.updatePatientIdentifier();$scope.patientHubStructData=$scope.getPatientHubStructureData();$scope.patientConfidential()};$scope.confirmCreateNewProgressNote=function(){ecwConfirm('Are you sure you want to create a new progress note for '+$scope.PatientHubInfo.fname+' '+$scope.PatientHubInfo.lname+'?','New Progress Note',createNewProgressNote)};$scope.isIndiaOutPatientEnabled=function(){var value=getItemKeyValue("IndiaOutPatient");if(value.toUpperCase()==="YES"){return true}else{return false}};$scope.createNewClaim=function(){var patientName=$scope.PatientHubInfo.lname+","+$scope.PatientHubInfo.fname;var url=makeURL('/mobiledoc/jsp/webemr/webpm/createClaim.jsp?patientId='+$scope.ptId+"&patientName="+patientName+"&parentScreen=patientHub");$ocLazyLoad.load({name:'createClaimApp',files:['/mobiledoc/jsp/webemr/webpm/js/createClaim.js']}).then(function(){$scope.paramCreateNewClaim={page:url,load:1}},function(e){showMessage('Failed to Load Claim',null)})};$scope.responseCreateClaim=function(args){$scope.paramCreateNewClaim={page:'',load:0};if(args&&args.nInvId){$scope.loadClaimScreen(args.nInvId,args.nClaimType)}};$scope.loadClaimScreen=function(invoiceId,argClaimType){if(invoiceId!=""){var param={claimId:invoiceId,parentScreen:'patientHub',encounterId:0,patientId:$scope.ptId};if($scope.isIndiaOutPatientEnabled()){loadHCFAClaim($ocLazyLoad,$modal,param,$scope)}else if(argClaimType==2){loadDentalClaim($ocLazyLoad,param,$scope,'inpatientBilling')}else if(argClaimType==1){loadUBClaim($ocLazyLoad,param,$scope,'inpatientBilling')}else{loadHCFAClaim($ocLazyLoad,$modal,param,$scope)}}else{showMessage("Fail to Load Claim Screen")}};$scope.closeBillingModal=function(){$templateCache.remove($scope.inpatientBilling);$scope.inpatientBilling=""};function createNewProgressNote(){var responseXML=createNewAppointment();var responseJSON=xml2json(responseXML);if(IsSuccessResult(responseJSON)){var encounterID=responseJSON.Envelope.Body['return'].encounterID;setAppointmentLogs(encounterID);doChecksForPN(encounterID,$scope.ptId,$http,'patient_hub');$('.modal-backdrop.in').remove()}else{$window.alert('Unable to create encounter.')}}function createNewAppointment(){var url='/mobiledoc/jsp/catalog/xml/newEncounter.jsp';var now=moment();var facilityId=getUserProfile('FacilityId')||getPrimaryFacilityId()||getFacilityList()[0].Id;var providerResourceObj=getProviderAndResourceForNewAppointment();var visitStatus=getDefaultVisitStatus();var visitType=getDefaultVisitType();var duration=getVisitTypeDuration(providerResourceObj.resourceId,visitType.CodeId);var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('encounter');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'id',$scope.ptId,'xsi:type','xsd:int');addElement(xw,'doctorid',providerResourceObj.providerId,'xsi:type','xsd:int');addElement(xw,'date',now.format('YYYY-MM-DD'),'xsi:type','xsd:string');addElement(xw,'time',now.format('hh:mm:ss a'),'xsi:type','xsd:string');addElement(xw,'endTime',now.add(duration,'m').format('hh:mm:ss a'),'xsi:type','xsd:string');addElement(xw,'visitType',visitType.Name,'xsi:type','xsd:string');addElement(xw,'status',visitStatus,'xsi:type','xsd:string');addElement(xw,'facilityId',facilityId,'xsi:type','xsd:int');addElement(xw,'POS',getFacilityAttributeFromCache(facilityId,'pos')||'11','xsi:type','xsd:int');addElement(xw,'visitTypeOverriden',visitType.Name,'xsi:type','xsd:string');addElement(xw,'resourceId',providerResourceObj.resourceId,'xsi:type','xsd:');addElement(xw,'notes','','xsi:type','xsd:string');addElement(xw,'reason','','xsi:type','xsd:string');addElement(xw,'encType','1','xsi:type','xsd:string');xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();var data={FormData:xml};return urlPost(url,data)}function getProviderAndResourceForNewAppointment(){var providerId=0;var resourceId=0;var resourceInfo=getResourceInfo(global.TrUserId);if(loginUserType==1){providerId=resourceId=global.TrUserId}else if(resourceInfo){resourceId=global.TrUserId;providerId=resourceInfo.resourceDefApptProvider}if(providerId==0){providerId=resourceId=$scope.PatientHubInfo.renproviderid||getDoctors()[0].id}return{providerId:providerId,resourceId:resourceId}}function getResourceInfo(userId){var resources=getResources();for(var i=0;i<resources.length;i++){if(resources[i].id==userId)return resources[i]}return null}function getDefaultVisitStatus(){var visitStatuses=getVisitStatuses();for(var i=0;i<visitStatuses.length;i++){if(visitStatuses[i].description=='Pending')return visitStatuses[i].code}return visitStatuses[0]}function getDefaultVisitType(){var defaultVisitTypeId=getUserProfile('DefaultVisitTypeId');var visitTypes=getVisitTypes();if(defaultVisitTypeId>0){for(var i=0;i<visitTypes.length;i++){if(visitTypes[i].CodeId==defaultVisitTypeId)return visitTypes[i]}}else{for(var i=0;i<visitTypes.length;i++){if(visitTypes[i].Name=='URG')return visitTypes[i]}}return visitTypes[0]}function getVisitTypeDuration(resourceId,visitTypeCodeId){var visitTypeDetail=getVisitCodesDetail(resourceId);for(var i=0;i<visitTypeDetail.length;i++){if(visitTypeDetail[i].CodeId==visitTypeCodeId)return visitTypeDetail[i].Minutes}return 15}$scope.loadPortalLog=function(){if($scope.ptId>0){var name="";if($scope.PatientHubInfo.mname)name=$scope.PatientHubInfo.lname+","+$scope.PatientHubInfo.fname+","+$scope.PatientHubInfo.mname;else name=$scope.PatientHubInfo.lname+","+$scope.PatientHubInfo.fname;$scope.portalLogsURI=makeURL("#/mobiledoc/jsp/webemr/messenger/communicationLogs.jsp/portal/1 /"+$scope.ptId+"/ /true/"+name+"/");$("#portalLogsModal").modal({backdrop:'static',keyboard:false});$("#portalLogsModal").css("border","none");$("#portalLogsModal .modal-content").css("height","750px").css("width","1150px").css("margin-left","-250px");$("#portalLogs").css("height","730px").css("margin-top","-8px")}else{ecwAlert("please select patient then try again.","Alert");return false}};$scope.refreshDocCount=function(count,docType){if(docType=='ConsultNotes_doc'){$scope.paperConsultNotes=count}};function setAppointmentLogs(encounterID){var url='/mobiledoc/jsp/catalog/xml/setLogs.jsp';var data={encounterId:encounterID,FormData:getLogXML()};urlPost(url,data)}function getLogXML(){var currentDate=new Date;var currTime=currentDate.getHours()+':'+currentDate.getMinutes()+':'+currentDate.getSeconds();var currDate=currentDate.getFullYear()+'-'+(currentDate.getMonth()+1)+'-'+currentDate.getDate();var xmlDoc='';xmlDoc=createXml();xmlDoc+=createXmlBody();xmlDoc+='<m:NOOP xmlns:m="NOOP">';xmlDoc+=createXmlNode('log','string','',true);xmlDoc+=createXmlNode('date','string',currDate,false);xmlDoc+=createXmlNode('time','string',currTime,false);xmlDoc+=createXmlNode('userId','string',global.TrUserId,false);xmlDoc+=createXmlNode('action','string','Created',false);xmlDoc+=createXmlClosingNode('log');xmlDoc+='</m:NOOP>';xmlDoc+=createXmlCloseBody();xmlDoc+=createCloseXml();return xmlDoc}function setAfterCarePatientInHub(data){afterCareServiceHub.setPatientFromHub(data).success(function(result){})}$scope.loadEprescriptionLogs=function(){$scope.eRxLogsURL="";$ocLazyLoad.load({name:'myApp.Ejellybean.controllers',files:['/mobiledoc/jsp/webemr/jellybean/refillrequest/js/ejelly.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/RxFillIndicator.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/eRxMessageViewer.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/commonRxRequest.js'],cache:false}).then(function(){var url=null;if($scope.enableCorrectionalFeatures){url='/mobiledoc/jsp/webemr/jellybean/ePrescription/ePrescriptionPtHub.jsp?pthub=yes&ptid='+$scope.ptId+'&calledFrom=pthub'}else{url='/mobiledoc/jsp/webemr/jellybean/ePrescription/ePrescriptionPtHub.jsp?pthub=yes&ptid='+$scope.ptId}url=makeURL(url);$scope.eRxLogsURL=url},function(e){})};$scope.loadEPALogs=function(){$scope.ePALogsURL="";$ocLazyLoad.load({name:'ePALogModule',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/js/RxHelper.js','/mobiledoc/jsp/webemr/jellybean/ePA/js/ePALogController.js'],cache:false}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/ePA/ePALog.jsp?patientId='+$scope.ptId;url=makeURL(url);$scope.ePALogsURL=url})};var Util={};Util.key={80:"p"};$scope.checkForWristBandLabel=function(){if(getItemKeyValue("EnableWristbandLabelPrinting").toLowerCase()=="yes"){$scope.EnableWristbandLabel=true}else{$scope.EnableWristbandLabel=false}};$scope.checkForWristBandLabel();var IsDeceased=function(){if($scope.PatientHubInfo.Inactive)var deceased=$scope.PatientHubInfo.Inactive.trim();if(deceased=='(Deceased)'){return true}return};var IsInactive=function(){if($scope.PatientHubInfo.Inactive)var inactive=$scope.PatientHubInfo.Inactive.trim();if(inactive=='(Inactive)'){return true}return};$scope.openPatientCostEstimator=function(){var name="";if($scope.PatientHubInfo.mname)name=$scope.PatientHubInfo.lname+","+$scope.PatientHubInfo.fname+","+$scope.PatientHubInfo.mname;else name=$scope.PatientHubInfo.lname+","+$scope.PatientHubInfo.fname;$ocLazyLoad.load({name:'ptCostEstimatorListModule',files:['/mobiledoc/jsp/webemr/webpm/costEstimator/js/ptCostEstimatorListCtrl.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/webpm/costEstimator/PCEListForPatient.jsp?ParentScreen=PtHub&patientid='+$scope.ptId+'&patientname='+name);$scope.hublinkurl=url},function(e){})};$scope.openPaymentPlan=function(){var name="";if($scope.PatientHubInfo.mname)name=$scope.PatientHubInfo.lname+","+$scope.PatientHubInfo.fname+","+$scope.PatientHubInfo.mname;else name=$scope.PatientHubInfo.lname+","+$scope.PatientHubInfo.fname;$ocLazyLoad.load({name:'ptPaymentPlanListApp',files:['/mobiledoc/jsp/webemr/webpm/paymentplan/js/ptPaymentPlanListCtrl.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/webpm/paymentplan/ptPaymentPlanList.jsp?ParentScreen=PtHub&patientId='+$scope.ptId+'&patientname='+name);$scope.hublinkurl=url},function(e){})};var BillingAlertFlag=false;$scope.loadNewTelephoneEnc=function(){$ocLazyLoad.load('/mobiledoc/jsp/webemr/js/globalAlertsService.js').then(function(){var globalAlertsService=$injector.get('globalAlertsService');if(globalAlertsService.doesPatientHaveMUOrBillingAlerts($scope.ptId)){BillingAlertFlag=true;$scope.loadmodalurl('BillingAlert')}else{$scope.loadmodalurl('NewTelEnc')}})};$scope.setIsAfterAlertCheck=function(isAfterAlertCheck){$scope.isAfterAlertCheck=isAfterAlertCheck;if(BillingAlertFlag){$scope.loadmodalurl('NewTelEnc');BillingAlertFlag=false}};$scope.trimPatientDetails=function(str,n){if(str&&str.length>0){if(str.length>n){str=str.substring(0,n-2)+'...'}return str}else return""};$scope.openRxAssistURL=function(url){window.open(url,"",'width=770, height=510,top=50,left=440,location=no,menubar=no,resizable=no,scrollbars=no,status=no,titlebar=no,toolbar=no')};$scope.openASCEncounters=function(){if(!getPermission("allowAccessASCEncounters",global.TrUserId)){ecwAlert("Permission denied.");return false}let requiredFiles=JSResourceObj["commonJs"].split(",");requiredFiles.push("/mobiledoc/jsp/ascWeb/OR/ascEncounters/js/ascEncountersCtrl.js","/mobiledoc/jsp/ascWeb/OR/ascEncounters/js/ascEncountersService.js","/mobiledoc/jsp/ascWeb/OR/ascEncounters/css/encounter-details-popup.css");$ocLazyLoad.load({name:'ascEncountersModal',files:requiredFiles}).then(function(){$modal.open({templateUrl:'/mobiledoc/jsp/ascWeb/OR/ascEncounters/modal/ascEncounters.html',controller:'ascEncountersModalCtrl',controllerAs:'aec',windowClass:'project-10i w1300',backdrop:"static",keyboard:false,resolve:{model:function(){return{"patientData":$scope.PatientHubInfo,"patientID":$scope.ptId}}}})})};function getStructuredData(structdata){var temp=[];if(structdata){var len=structdata.length;for(var i=0;i<len;i++){if(structdata[i].parentId==0){temp.push(structdata[i])}else if(structdata[i].parentId!=0&&structdata[i].value&&structdata[i].value.length>0){temp.push(structdata[i])}}}return temp}function medicalrecordViewLogs(){var jsonObj=[];var item={};item["userid"]=global.TrUserId;item["patientid"]=$scope.ptId;item["reason"]="";item["reciver"]="";item["providername"]="";item["action"]="View";jsonObj.push(item);var url=makeURL('/mobiledoc/jsp/catalog/logs/GetMedicalRecordLogList.jsp');var data={action:"add",formdata:JSON.stringify(jsonObj)};var result=urlPost(url,data)}$scope.closeextreportdialog=function(){$('#myextreport').modal('hide')};function openLatestPN(encounters,$http,patientId,$ocLazyLoad,$modal){var canCodesArray=getCancelledCodesCommon();for(var i=0;i<encounters.length;i++){if(checkCancelledStatus(encounters[i].status,canCodesArray)||!validEncType(encounters[i].encType)){encounters.splice(i,1);i=i-1}}if(encounters.length&&encounters.length>0){var isPSACEnabled=isItemKeyEnabled('EnablePSAC');if(isPSACEnabled){var passingEncList=[];var latestEncId=getDefaultEncounterId(encounters,true);passingEncList.push(latestEncId);processEncForPSAC($http,passingEncList).success(function(data){var isLatestEncAccessible=data[latestEncId];if(parseInt(latestEncId,10)>0&&isLatestEncAccessible){doChecksForPN(latestEncId,patientId,$http,"patient_hub");$scope.isPNMethodExecute=true;if($scope.$parent.$parent.scheduleCtrl&&$scope.$parent.$parent.scheduleCtrl.moduleName==="groupScheduleCtrlForParentAccess"||$scope.$parent.$parent.$parent.docCtrl&&$scope.$parent.$parent.$parent.docCtrl.moduleName==="groupDocumentation"){$scope.$parent.$parent.groupVisitCtrl.proceedCloseModal()}if($scope.contextFrom==="allergymodule"){closeAllergyModuleScreen()}closeEPAScreen()}else{var modalData={};modalData.encList=encounters;modalData.patientId=patientId;modalData.reason="We are not able to open progress note as latest note is classified, please select any encounter from below list.";var popupUrl="/mobiledoc/jsp/webemr/progressnotes/viewpn-enclist.jsp";$ocLazyLoad.load({name:"EncListViewPN",files:["/mobiledoc/jsp/webemr/progressnotes/viewpn-enclist.js"],cache:true}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL(popupUrl),controller:'EncListViewPNController',windowClass:'app-modal-window viewPNEncListModalDiv',backdrop:"static",resolve:{modalData:function(){return modalData}}});modalInstance.result.then(function(responseObj){},function(responseObj){})},function(e){})}}).error(function(){ecwAlert("Internal Error occured while checking security, please try after some time.","eClinicalWorks")})}else{var encId=getDefaultEncounterId(encounters,true);if(parseInt(encId,10)>0){doChecksForPN(encId,patientId,$http,"patient_hub");$scope.isPNMethodExecute=true;if($scope.$parent.$parent.scheduleCtrl&&$scope.$parent.$parent.scheduleCtrl.moduleName==="groupScheduleCtrlForParentAccess"||$scope.$parent.$parent.$parent.docCtrl&&$scope.$parent.$parent.$parent.docCtrl.moduleName==="groupDocumentation"){$scope.$parent.$parent.groupVisitCtrl.proceedCloseModal()}if($scope.contextFrom==="allergymodule"){closeAllergyModuleScreen()}closeEPAScreen()}else{ecwAlert("There are no valid encounters to be viewed for this patient.","eClinicalWorks")}}}else{ecwAlert("There are no valid encounters to be viewed for this patient.","eClinicalWorks")}}function getDefaultEncounterId(encounters,byPassPSAC){var encId=0;for(var i=0;i<encounters.length;i++){if(byPassPSAC||encounters[i].psacFlag){var encDate=parseStringToDate(encounters[i].date,"yyyy-mm-dd","-");if(encDate!==''){var date=new Date;date=new Date(date.getFullYear(),date.getMonth(),date.getDate());var diff=days_between_wo_abs(encDate,date);if(diff<=0){encId=encounters[i].encounterID;break}}}}if(parseInt(encId,10)===0){for(var i=0;i<encounters.length;i++){if(byPassPSAC||encounters[i].psacFlag){encId=encounters[i].encounterID;break}}}return encId}function closeModalRPMMonitoringStatus(){$(".monitoring-status").modal('hide');$(".monitoring-status").remove();$('.modal-backdrop.fade').remove()}function closeAllergyModuleScreen(){$(".allergymodule").modal('hide');$(".allergymodule").remove();$(".shotadminmain").modal('hide');$(".shotadminmain").remove();$(".extractbillingmain").modal('hide');$(".extractbillingmain").remove();$('.modal-backdrop.fade').remove()}function closeEPAScreen(){try{var unsavedDataConfirmMessage=handleOnBeforeUnloadForSavePromptDirective();if($scope.parentForm==="ePAJellyBean"&&(unsavedDataConfirmMessage===undefined||unsavedDataConfirmMessage==="")){if(typeof $scope.$parent.closePADialog=='function'){$scope.$parent.closePADialog()}if(typeof $scope.$parent.closeEPACommonSend=='function'){$scope.$parent.closeEPACommonSend(true)}}}catch(e){}}function processEncForPSAC($http,encounters){if(encounters.length&&encounters.length>0){var psacCheckEncIds=encounters;var url="/mobiledoc/jsp/webemr/progressnotes/checkencpsac.jsp";url=makeURL(url);var xsrf=$.param({"encIds":psacCheckEncIds.join()});return $http({headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},dataType:'text',method:'POST',url:url,data:xsrf})}}function getPatientEncounterBasedOnFilter($http,patientId){var url="/mobiledoc/jsp/catalog/xml/getPtEncounters.jsp?PatientId="+patientId+"&EncOptions=0";url=makeURL(url);var xsrf='';var infoJson=JSON.parse(get('loggedInInfo'));if($attrs.isFacillityFilter=='true'&&infoJson.facilityFilter=="My"){xsrf=$.param({WebPortalEnabled:$attrs.webPortalFlag,FacilityId:$attrs.facilityId})}else{xsrf=$.param({WebPortalEnabled:$attrs.webPortalFlag})}return $http({headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},dataType:'text',method:'POST',url:url,data:xsrf})}$scope.closePortalLogsDialogue=function(){$('#portalLogsModal').modal('hide')};$scope.openCollectionBalanceDetails=function(){let strEnableBadDebtColl=getItemKeyValue("EnableBadDebtCollCycle");if(strEnableBadDebtColl.toUpperCase()!=="YES"){return}let stripBillingEnable=getItemKeyValue("EnableIPBilling");if(stripBillingEnable.toUpperCase()!=="YES"){return}let strEnableClaimColl=getItemKeyValue("EnableClaimCollection");if(strEnableClaimColl.toUpperCase()!=="YES"){return}$ocLazyLoad.load({name:'CollectionCycleBalance',files:['/mobiledoc/jsp/webemr/webpm/collection/js/CollectionCycleBalanceDetailsCtrl.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/webpm/collection/CollectionCycleBalanceDetails.html'),controller:'CollectionCycleBalanceController',controllerAs:'collectionCycle',windowClass:'app-modal-window bluetheme  medium-width',backdrop:"static",resolve:{patient:function(){return $scope.ptId}}});modalInstance.result.then(function(response){},function(response){})})};$scope.getPatientIdentifiers=function(){return $scope.patientIdentifiers};$scope.setCREPreviewURL=function(url){$scope.crePreviewURL=url};$scope.checkCaseManagementEnabled=function(){if(getItemKeyValue('CCMRCaseManagement').toLowerCase()==='yes'){return true}return false};$scope.openTreatmentTimeLineScreen=function(){if($scope.hasTreatmentTimelineAccess){loadTreatmentTimeline($ocLazyLoad,$modal,$scope.ptId,$scope.encounterId)}};var itemCDS={itemId:0,keyValue:'',isExists:false};getItemKeyValuePair("EnableFHIRProviderFacingApps",itemCDS);if(itemCDS.isExists&&itemCDS.keyValue.toLowerCase()==="yes"){var fhirproviderapplaunchHtml='<li title="Apps" id="lifhirdirective"><fhirproviderapplaunch launchedfrom="patienthub" direction="dropup" encid="0" pid="'+$scope.ptId+'"></fhirproviderapplaunch></li>';$("#patient-hubUl2").append(fhirproviderapplaunchHtml);$ocLazyLoad.load({name:'smartoffhirproviderapps',serie:true,files:['/mobiledoc/jsp/webemr/templates/smartonfhirapplaunch-tpl.js']}).then(function(){angular.element($("#patient_hub1").get(0)).injector().invoke(function($compile){$compile($("#lifhirdirective"))($scope)})},function(e){})}if(getItemKeyValue('EnablePrimaryCareFirst').toLowerCase()==='yes'){$ocLazyLoad.load({files:['/mobiledoc/jsp/webemr/js/vendor/ui-router.js','/mobiledoc/jsp/webemr/ccmr/rpm/css/rpm-main.css','/mobiledoc/jsp/webemr/ccmr/rpm/css/perfect-scrollbar.css','/mobiledoc/jsp/webemr/ccmr/rpm/css/rpm-custom.css','/mobiledoc/jsp/webemr/ccmr/rpm/enrollment/css/patient-enrollment.css','/mobiledoc/jsp/webemr/js/ion.rangeSlider.js','/mobiledoc/jsp/webemr/ccmr/rpm/css/rpm-global-style.css','/mobiledoc/jsp/js/jquery.inputmask/jquery.inputmask.date.extensions.js','/mobiledoc/jsp/webemr/ccmr/rpm/enrollment/js/directive/common-directive.js','/mobiledoc/jsp/resources/jslib/angular-perfect-scrollbar/src/angular-perfect-scrollbar.min.js','/mobiledoc/jsp/webemr/ccmr/rpm/enrollment/js/service/enrollmentService.js','/mobiledoc/jsp/webemr/ccmr/rpm/js/vendorjs/angular-sanitize.js','/mobiledoc/jsp/webemr/ccmr/rpm/js/vendorjs/perfect-scrollbar.min.js','/mobiledoc/jsp/webemr/ccmr/rpm/devicemonitoring/directive/rpmThirdPartyPortal-tpl.js','/mobiledoc/jsp/resources/jslib/angular-ui-bootstrap/dist/ui-bootstrap-tpls.js','/mobiledoc/jsp/webemr/ccmr/ccm/js/directive/phmTimerLogs-tpl.js','/mobiledoc/jsp/webemr/behavioralhealth/directives/notesDirective/js/notesDirective.js','/mobiledoc/jsp/webemr/templates/spellCheck-tpl.js','/mobiledoc/jsp/webemr/ecwspeech/js/evaspeech.js','/mobiledoc/jsp/webemr/behavioralhealth/directives/notesDirective/css/notesDirective.css']}).then(function(){},function(e){ecwAlert('Error occurred while loading pcf enrollment modal dependency files.'+e,'eClinicalWorks')})}var onScrollStructData=function(){if($(this).scrollTop()+$(this).innerHeight()>=this.scrollHeight-10){if($scope.patientHubStructData.length>$scope.totalDisplayed)$scope.getStructureDataWithPagination();$scope.$digest()}};$('#structdata-hub').on('scroll',onScrollStructData);$scope.behavioralHealthTabs=["Overview","Treatment Plan","Screening","History","Confidential Notes","Safety Plan","Discharge"];$scope.patientConfidential=function(){if(isItemKeyEnabled('EnablePSAC')){PSACService.patientConfidentialCheck($scope.ptId).then(function(response){if(response.data){$scope.isPatientConfidentialForHub=true;$scope.patientConfidentialityTitleForHub="This patient is confidential."}else{$scope.isPatientConfidentialForHub=false;$scope.patientConfidentialityTitleForHub=""}},function(){ecwAlert("An error occurred while checking for patient confidentiality.")})}}});angular.module('afterCareHub.services',[]).service('afterCareServiceHub',function($http){var URL="/mobiledoc/jsp/catalog/xml/";return{setPatientFromHub:function(data){var param=$.param(data);var url='/mobiledoc/jsp/webemr/AfterCare/getAftercareEncountersList.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}}});
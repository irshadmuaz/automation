angular.module('ecw.dir.aiDocAssistant',[]).directive('aiDocAssistant',function(aiDocAssistantService,$modal,$ocLazyLoad){return{restrict:'E',scope:{id:"@",topclass:"@",selector:'@for',screenName:"@",patientId:"=?",encounterId:"=?"},replace:true,templateUrl:'/mobiledoc/jsp/webemr/ai/ecw.dir.ai-doc-assistant.html',link:function(scope){scope.docAssistantEnabled=aiDocAssistantFunctions.isAIDocAssistantEnabled();scope.docAssistantPermission=getPermission("AllowAIDocAssistant",global.TrUserId);scope.iconTitle=scope.docAssistantPermission?"Documentation Assistant":"Enable the Security Setting \"Documentation Assistant\" to get access to this feature.";scope.docAssistantScreenMappingData=aiDocAssistantFunctions.getDocAssistantScreenMappingData();scope.docAssistantEnableForField=scope.docAssistantScreenMappingData.some(configdata=>{if(configdata.uiscreenname==='patientHubNote'&&configdata.uiscreenname===scope.screenName&&!configdata.disabled){return true}return configdata.uiscreenname===scope.screenName&&configdata.uifieldname===scope.selector&&!configdata.disabled});scope.id=scope.id;scope.topclass=scope.topclass?scope.topclass:"btn-lgrey btn-xs pull-right";scope.wysiElement=false;scope.contentEditableSpan=false;scope.selectorId=scope.selector.slice(1);scope.displayLoader=false;scope.isEncounterLockOrDeleted=false;if(scope.encounterId){if(scope.encounterId!==0){aiDocAssistantService.getEncounterLockOrDeletedStatus(scope.encounterId).success(function(response){if(response.data){scope.isEncounterLockOrDeleted=response.data.isEncounterLockOrDeleted}}).error(function(error){console.log(error)})}}if($($(scope.selector).get(0)).data("wysihtml5")){scope.wysiElement=true}scope.targetElement=$(scope.selector).get(0);if(scope.targetElement&&scope.targetElement.tagName.toLowerCase()==='span'){scope.wysiElement=true;scope.contentEditableSpan=true;scope.targetElement.value=scope.targetElement.innerHTML}scope.aiDocAssistantModalOpen=function(){if(!scope.targetElement){scope.targetElement=$(scope.selector).get(0)}let aiDocAssistantRequestData=scope.wysiElement?scope.targetElement.value:escapeHtml(scope.targetElement.value);aiDocAssistantRequestData=scope.replaceHTMLCharacters(aiDocAssistantRequestData);if(scope.isInputValid(aiDocAssistantRequestData)){scope.displayLoader=true;aiDocAssistantService.getDocAssistant(aiDocAssistantRequestData).success(function(response){scope.displayLoader=false;if(response.errorMessage){displayWarningPopup('Request Timeout','The request to the server timed out. Please try again.');return}let aiResponseData=response?.data?.completion;if(aiResponseData!==null&&aiResponseData!==""){scope.openaiDocAssistantModal(aiResponseData,response.data.responseId)}}).error(function(data){scope.displayLoader=false;displayWarningPopup('Connectivity error','An error has occurred while connecting to eCW AI service. Please try again later.')})}else{displayWarningPopup('Text too short','The entered text is too short . Enter at least five words to use Documentation Assistant.')}};scope.openaiDocAssistantModal=function(aiDocAssistantResponse,responseId){$ocLazyLoad.load({name:'aiDocAssistantModule',files:['/mobiledoc/jsp/webemr/ai/aiDocAssistantModalController.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL("/mobiledoc/jsp/webemr/ai/aiDocAssistantModal.html"),controller:'aiDocAssistantModalController as atr',windowClass:'modal fade z1250 w630 type-primary bluetheme ai-doc-assistant-modal',keyboard:false,backdrop:"static",resolve:{aiDocAssistantResponse:function(){return aiDocAssistantResponse}}});modalInstance.result.then(function(responseObj){},function(responseObj){if(responseObj){scope.aiDocAssistantModalApply(aiDocAssistantResponse,responseId)}})})};scope.aiDocAssistantModalApply=function(aiDocAssistantResponse,responseId){if(scope.targetElement){scope.wysiElement=$(scope.targetElement).data("wysihtml5");if(scope.wysiElement){let textEditor=scope.wysiElement.editor;textEditor.setValue(aiDocAssistantResponse);scope.targetElement.value=aiDocAssistantResponse}else if(scope.contentEditableSpan&&scope.targetElement.id===$(scope.selector).get(0).id){$(scope.selector).get(0).innerHTML=aiDocAssistantResponse}else{scope.targetElement.value=aiDocAssistantResponse}if(!scope.contentEditableSpan){scope.targetElement.dispatchEvent(new Event("change"))}scope.targetElement=null;var logData={};logData.userId=parseInt(global.TrUserId,10);logData.patientId=scope.patientId?parseInt(scope.patientId,10):0;logData.encounterId=scope.encounterId?parseInt(scope.encounterId,10):0;logData.responseId=responseId;logData.uiscreenname=scope.screenName;logData.uifieldname=scope.selector;aiDocAssistantService.saveAppliedLog(logData)}};scope.isInputValid=function(elementVal){if(elementVal!==null&&elementVal!==""&&elementVal!=="undefined"){let words=elementVal.trim().split(/\s+/);if(words.length>=5){return true}}return false};var displayWarningPopup=function(screenTitle,message,callback,titleHeader){if(!titleHeader){titleHeader='Documentation Assistant'}commonWarningPopup({screenName:'',screenTitle:'<div class="warning-ai-screen-doc-assistant">'+'<i class="icon-ai-primary icon-ai-warning-doc-assistant"></i><span>'+titleHeader+'</span></div>'+' - '+screenTitle,buttons:[{label:"OK",cssClass:'btn-blue',callbackEvent:function(){if($.isFunction(callback)){callback()}}}],message:message,isErrorPopup:true,screenSpecificClass:'',isKeyboardClose:false},$ocLazyLoad,$modal)};scope.replaceHTMLCharacters=function(docAssistantText){return docAssistantText.replace(/&nbsp;/gi,"")}}}}).factory('aiDocAssistantService',function($http){let getDocAssistant=function(textValue){let req={method:'POST',url:"/mobiledoc/emr/aidocassistant/query-response",data:{context:textValue},headers:{'Content-Type':'application/json'}};return $http(req)};let saveAppliedLog=function(logData){$http({method:'POST',url:'/mobiledoc/emr/aidocassistant/saveDocAssistantAppliedLog',data:logData,headers:{'Content-Type':'application/json'}}).success(function(response){}).error(function(error){console.log(error)})};let getEncounterLockOrDeletedStatus=function(encounterId){let req={method:'POST',url:'/mobiledoc/emr/aidocassistant/getEncounterLockOrDeletedStatus',params:{encounterId:encounterId},headers:{'Content-Type':'application/json'}};return $http(req)};return{getDocAssistant:getDocAssistant,saveAppliedLog:saveAppliedLog,getEncounterLockOrDeletedStatus:getEncounterLockOrDeletedStatus}});
angular.module("p2pInvitationApp",[]).factory('p2pInvitationService',function($http){return{getP2PInvitationFilterData:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/webemr/jellybean/p2pinvitation/getp2pinvitations.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},deleteP2PInvitations:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/telenc/deleteMessage.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}}}});angular.module("p2pInvitation",['oc.lazyLoad','ecw.pagination','ecw.dir.datepicker','p2pInvitationApp']).controller('p2pInvitationController',function($scope,$timeout,$ocLazyLoad,$templateCache,p2pInvitationService){$scope.p2pInvitations=[];$scope.currentPage=1;$scope.noOfResult=20;$scope.invitationMsg=$('#msg_invitation').val();$scope.communityInvitationMsg=$('#msg_community_invitation').val();$scope.delP2PInvitationIds=[];$scope.loadInvitations=function(){$scope.sortBy=$('#sortBy').val();$scope.sortOrder=$('#sortOrder').val();$scope.pageNo=$('#pageNo').val();$scope.rowsPerPage=$('#rowsPerPage').val();$scope.strFilter=$('#strFilter').val();$scope.strDateFrom=$('#strDateFrom').val();$scope.strDateTo=$('#strDateTo').val();$scope.strSubject=$('#strSubject').val();$scope.strLabel=$('#strLabel').val();$scope.strSendRecvId=$('#strSendRecvId').val();$scope.messageBoxType=$('#msgBoxType').val();var data="";data=xml2json(listview_invitationXml);if(!angular.isUndefined(data.Envelope.Body["return"].messages.message)){if(angular.isUndefined(data.Envelope.Body["return"].messages.message.length)){$scope.p2pInvitations.push(data.Envelope.Body["return"].messages.message);var fromDocXml=xml2json(data.Envelope.Body["return"].messages.message.fromdoctordetails);if(!angular.isUndefined(fromDocXml.InviterDetails)){$scope.p2pInvitations[0].providerSpecialty=fromDocXml.InviterDetails.providerSpecialty}}else{$scope.p2pInvitations=data.Envelope.Body["return"].messages.message;$.each($scope.p2pInvitations,function(index,p2pinvitation){var fromDocXml=xml2json(p2pinvitation.fromdoctordetails);if(!angular.isUndefined(fromDocXml.InviterDetails)){p2pinvitation.providerSpecialty=fromDocXml.InviterDetails.providerSpecialty}})}}else{$scope.p2pInvitations=[]}$scope.totalRecData=data.Envelope.Body["return"].total;$scope.calculatePageNumber()};$scope.filterP2PInvitation=function(){var params={tabOnId:$scope.tabOnId,sortBy:5,sortOrder:"DESC",pageNo:$scope.currentPage,rowsPerPage:$scope.noOfResult,strFilter:$scope.strFilter,dateFrom:$scope.strDateFrom,dateTo:$scope.strDateTo,subject:$scope.strSubject,filterLabels:$scope.strLabel,strSendRecvId:$scope.strSendRecvId,msgBoxType:$scope.messageBoxType,loginUserId:global.TrUserId};params=$.param(params);$scope.p2pInvitations=[];p2pInvitationService.getP2PInvitationFilterData(params).success(function(data){var jsonData=xml2json($.trim(data));if(!angular.isUndefined(jsonData.Envelope.Body["return"].messages.message)){if(angular.isUndefined(jsonData.Envelope.Body["return"].messages.message.length)){$scope.p2pInvitations.push(jsonData.Envelope.Body["return"].messages.message);var fromDocXml=xml2json(jsonData.Envelope.Body["return"].messages.message.fromdoctordetails);if(!angular.isUndefined(fromDocXml.InviterDetails)){$scope.p2pInvitations[0].providerSpecialty=fromDocXml.InviterDetails.providerSpecialty}}else{$scope.p2pInvitations=jsonData.Envelope.Body["return"].messages.message;$.each($scope.p2pInvitations,function(index,p2pinvitation){var fromDocXml=xml2json(p2pinvitation.fromdoctordetails);if(!angular.isUndefined(fromDocXml.InviterDetails)){p2pinvitation.providerSpecialty=fromDocXml.InviterDetails.providerSpecialty}})}}else{$scope.p2pInvitations=[]}$scope.totalRecData=jsonData.Envelope.Body["return"].total;$scope.calculatePageNumber()})};$scope.setCurrent=function(){$timeout(function(){$scope.filterP2PInvitation()},100)};$scope.calculatePageNumber=function(){$scope.pages=[];$scope.noPages=Math.ceil($scope.totalRecData/$scope.noOfResult);for(var i=1;i<=$scope.noPages;i++){$scope.pages.push(i)}};var setConfirmFlagToTrue=function(){$("#p2pInvitationTable tr").each(function(index){var row=$(this);if(index>0){if(row.find("td:eq(1)").find("input:checkbox").is(":checked")){value=row.find("td:eq(1)").children(0).prop('value');var params={MessageId:value,p2pInvitation:true};$scope.delP2PInvitationIds.push(params)}}});var delParams={p2pInvitationIdJson:JSON.stringify($scope.delP2PInvitationIds),fromWebEmr:true,p2pInvitation:true};delParams=$.param(delParams);p2pInvitationService.deleteP2PInvitations(delParams).success(function(data){if(data.trim()){showMessage(data)}else{$scope.filterP2PInvitation()}})};$scope.deleteP2PInvitation=function(){var chkboxlen=$('[name="p2pinvitationchkbox"]:checked').length;if(chkboxlen<1){showMessage("Plese select one or more messages and try again.");return}ecwConfirm("Are you sure you want to delete the checked Invitation(s)?","",setConfirmFlagToTrue)};$scope.setPerPageNoOfRecData=function(){$scope.currentPage=1;$scope.filterP2PInvitation()};$scope.invitationRecv=function(msgId,status){$templateCache.remove($scope.invitationRecvPopUpURL);$scope.invitationRecvPopUpURL="";var params={invitationId:msgId,status:status};params=$.param(params);$ocLazyLoad.load({name:'p2pInvitationReceived',files:['/mobiledoc/jsp/webemr/jellybean/p2pinvitation/p2pInvitationRecvController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/p2pinvitation/p2pinvitationreceived.jsp?'+params);$scope.invitationRecvPopUpURL=url},function(e){console.log(e)})}}).controller("blueHeaderController",function($scope){$scope.tabOnId=$('#tabOnId').val();$scope.setTabId=function(tabOnId){var listViewScope=angular.element($("#listView")).scope();listViewScope.tabOnId=tabOnId;listViewScope.currentPage=1;listViewScope.filterP2PInvitation()}});angular.module("referralAppServices",[]).factory('referralService',function($http){return{saveReferral:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/setReferral.jsp?"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},saveReferralVisits:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/p2pmodule/referral/visits/referralvisits"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},getAuth:function(param){try{return $http({method:"GET",url:makeURL("/mobiledoc/jsp/catalog/xml/edi/getBillingCodes.jsp?"+param)})}catch(err){}},getReferralRecord:function(param){try{return $http({method:"GET",url:makeURL("/mobiledoc/jsp/catalog/xml/getReferral.jsp?"+param)})}catch(err){}},getNhxReferralRecord:function(param){try{return $http({method:"GET",url:makeURL("/mobiledoc/jsp/catalog/xml/getNhxReferral.jsp?"+param)})}catch(err){}},updateNHxReferral:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/getUpdatedReqId.jsp?"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},getPatientEncounter:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/getPtEncounters.jsp?"+param)})}catch(err){}},getReferralVisits:function(param){try{return $http({method:"GET",url:makeURL("/mobiledoc/jsp/catalog/xml/getReferralVisits.jsp?"+param),headers:{'Content-Type':'applicatifon/x-www-form-urlencoded'}})}catch(err){}},getPtnInsurances:function(param){try{return $http({method:"GET",url:makeURL("/mobiledoc/jsp/catalog/xml/getPtInsurances.jsp?"+param)})}catch(err){}},getRefManatoryField:function(){try{return $http({method:"GET",url:makeURL("/mobiledoc/jsp/catalog/xml/getRefMandatoryFieldList.jsp?")})}catch(err){}},getRefPrintData:function(param){try{var url='/mobiledoc/jsp/catalog/xml/printPatientReferral.jsp?';url=makeURL(url+param);return $http({method:"GET",url:url})}catch(err){}},getReferralReason:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/getChildNodes2.jsp?"+param)})}catch(err){}},setReferralReplay:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/ereferralemr/newP2PMessage.jsp?"+param)})}catch(err){}},createRefFromP2p:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/getUpdatedReqId.jsp?"+param)})}catch(err){}},getReferralLog:function(param){try{return $http({method:"GET",url:makeURL("/mobiledoc/jsp/catalog/xml/getRefApptLogs.jsp?"+param)})}catch(err){}}}});(function() {var refToLookupDependencyModule =angular.module("ecw.p2p.referral.refToLookupDependencyModule",[]);refToLookupDependencyModule.factory('refToLookupModuleDependencyService',function() {var classicLookup ={files :['/mobiledoc/jsp/webemr/jellybean/referral/refToLookupController.js','/mobiledoc/jsp/webemr/jellybean/referral/refToLookupServicesModule.js','/mobiledoc/jsp/webemr/js/AngularUI_uniqueFilter.js',],modalURL :'/mobiledoc/jsp/webemr/jellybean/referral/refToProvLookup.jsp',moduleName :'refToLookupModule'};var modernLookup ={files :['/mobiledoc/jsp/webemr/referral/lookup/js/refToModernLookupController.js','/mobiledoc/jsp/webemr/referral/lookup/js/refToModernLookupMapController.js','/mobiledoc/jsp/webemr/jellybean/referral/refToLookupServicesModule.js','/mobiledoc/jsp/webemr/js/AngularUI_uniqueFilter.js','/mobiledoc/jsp/webemr/referral/lookup/css/refToModernLookup.css'],modalURL :'/mobiledoc/jsp/webemr/referral/lookup/tpl/refToModernLookup.jsp',moduleName :'refToModernLookupModule'};let toggleLookup ={files :['/mobiledoc/jsp/webemr/referral/lookup/js/refToToggleLookupController.js'],modalURL :'/mobiledoc/emr/referral/ref-to-lookup/toggle-lookup',moduleName :'refToLookupToggleModule'};var lookup =function (type) {if (!type) {return toggleLookup;}
 if (type ==='classic') {return classicLookup;}
 return modernLookup;};return {getModule :function (type) {var module =lookup(type);return {name:module.moduleName,files:module.files
 };},getFiles :function (type) {return lookup(type).files;},getModalURL:function (type) {return lookup(type).modalURL;}
 };});})();var timer_hdl;angular.module("recAppServices",[]).factory('recService',function($http){return{getRecordFilter:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/webemr/jellybean/patientrecord/getRecordData.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},getP2PRecordMessageIds:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/webemr/jellybean/patientrecord/getP2PRecordMessageIds.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},getAttachmentsCount:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/ereferralemr/getReferralAttachCounts.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},getUpdatedPRStatus:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/ereferralemr/requestHandler.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},getPTRecordStatus:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/ereferralemr/getPatientRecordStatus.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},deleteP2PEncounter:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/ereferralemr/deleteP2pEncounter.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},deleteOutboxPatientRecord:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/deleteReferral.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}}}});angular.module("ptRecordModule",['oc.lazyLoad','recAppServices','stafflookup','ecw.pagination','ecw.dir.datepicker','ptRecordModule','ecw.dir.p2pstatus','ecw.dir.datepicker','multipleStaffLookup','toasterNotification','ecw.common.alert','ui.bootstrap','calendarApp']).controller('recordController',function($scope,$window,$location,recService,$http,$timeout,$ocLazyLoad,$templateCache,toasterSvc,modernAlertFactory){$scope.ptRecords={};let reInitDefaults=function(){$scope.ptRecords.PTRECORD_I=[];$scope.ptRecords.PTRECORD_O=[];$scope.totalRecData=0;$scope.pages=[]};$scope.type=0;$scope.bInbox=true;$scope.ptRecordType='PTRECORD_I';$scope.currentPage=1;$scope.noOfResult=20;$scope.delRecordDetails={};$scope.multipleStaffLookupName={};$scope.multipleStaffLookupText="";$scope.multipleStaffLookupName.staffList=[];$scope.isAllowMultipleStaffSelection=false;reInitDefaults();var isChromeUIScreen=$('#isEdgeRequest').val();$scope.isChromeUIScreen=isChromeUIScreen==="true";let allowMultipleStaffSelection=getItemKeyValue("AllowMultipleStaffSelection");if(allowMultipleStaffSelection!=null&&allowMultipleStaffSelection.toUpperCase()==='YES'){$scope.isAllowMultipleStaffSelection=true}$scope.hasAcceessToDeletePatientRecord=getPermission('AllowUserToDeletePatientRecord',global.TrUserId);$scope.selectedPatientRecordIdForDelete=[];let isUpdateByController=false;let startDate=new Date;startDate.setFullYear(startDate.getFullYear()-1);$scope.dateRangePickerObj={openDatepickerRange:false,startDatepicker:startDate,endDatepicker:new Date,startDate:startDate,endDate:new Date,minDate:new Date(1900,0,1),maxDate:new Date};let transmissionLinkDocumentClick=function(event){var container=$('.referral-transmission');var containerPrev=$('.referral-transmission-link');if(!container.is(event.target)&&container.has(event.target).length===0&&!containerPrev.is(event.target)){container.removeClass('open')}};let patientRecordDataTableScroll=function(){$('.referral-transmission').removeClass('open')};$(document).on('click',transmissionLinkDocumentClick);$(".patient-record-app .dash-height > .ecw-scrollbar").bind('scroll',patientRecordDataTableScroll);$scope.loadPtRecords=function(){$scope.multipleStaffLookupCounter=0;$scope.type=document.getElementById("type").value;$scope.showIncompleteRecords="0";$scope.subTab=document.getElementById("subTab").value;if($scope.subTab&&$scope.subTab==="all-failed"){$scope.showIncompleteRecords="1"}$scope.TrUserId=document.getElementById("TrUserId").value;$scope.tabOnId=document.getElementById("tabOnId").value;if($scope.subTab&&$scope.subTab==="all-failed"){if($scope.type==1){$scope.tabOnId=7}else{$scope.tabOnId=5;$scope.showIncompleteRecords="0"}}$scope.strFilter=document.getElementById("strFilter").value;$scope.nWebPortalEnabled=document.getElementById("nWebPortalEnabled").value;$scope.authorizedUserIds=document.getElementById("authorizedUserIds").value;$scope.searchPatient={patient:''};$scope.searchAssignTo={staff:{}};$scope.searchAssignTo.staff.name=global.TrUserName;$scope.searchAssignTo.staff.id=global.TrUserId;$scope.searchToProvider={staff:{}};$scope.searchToProvider.staff.name="";$scope.searchToProvider.staff.id="";if(patientRecordCounts){$scope.ptRecordCounts=JSON.parse(patientRecordCounts)}if(!isItemKeyEnabled("nhxMonitorP2PConnectivity")){$scope.isP2Pconnected=true;$scope.showP2PconnectivityErrorPopup=false}else{var p2pConnectivityStatus=isChromeUIScreen==="true"?$('#p2PConnectivityStatus').val():get("p2pConnectivityStatus");$scope.isP2Pconnected=p2pConnectivityStatus!=null&&"1"===p2pConnectivityStatus;if(!$scope.isP2Pconnected&&get('p2pConnectivityPopupShown')==null){put('p2pConnectivityPopupShown',true);$scope.showP2PconnectivityErrorPopup=true}}if($scope.type==0){$scope.bInbox=true;$scope.ptRecordType='PTRECORD_I'}else{$scope.bInbox=false;$scope.ptRecordType='PTRECORD_O'}$scope.recordFilter()};$scope.setSearchAssignToId=function(){};$scope.setSearchToProvider=function(){};$scope.clearSearchAssignToId=function(){$scope.searchAssignTo.staff.id="";$scope.recordFilter()};$scope.clearSearchToProvider=function(){$scope.searchToProvider.staff.id="";$scope.recordFilter()};$scope.sortByIcon={'ASC':'jellybean-icon-ascending','DESC':'jellybean-icon-descending'};$scope.sortBy=1;$scope.sortOrder="DESC";$scope.isFirstAttemptToSortByPriority=true;$scope.recordSortBy=function(sortBy){if($scope.sortOrder==="ASC"&&$scope.sortBy===sortBy){sortBy=1}if($scope.sortBy!==sortBy){$scope.sortOrder="ASC"}$scope.sortBy=sortBy;if($scope.sortBy===1&&$scope.isFirstAttemptToSortByPriority){$scope.sortOrder="ASC";$scope.isFirstAttemptToSortByPriority=false}if($scope.sortOrder=="DESC"){$scope.sortOrder="ASC"}else{$scope.sortOrder="DESC"}$scope.recordFilter()};$scope.recordFilter=function(){reInitDefaults();var assingToProviderId="";if(!angular.isUndefined($scope.searchAssignTo.staff.id)&&$scope.assingToProvider!="")assingToProviderId=$scope.searchAssignTo.staff.id;var assignedToProviderName="";if(!angular.isUndefined($scope.searchAssignTo.staff.name)&&$scope.assingToProviderName!="")assignedToProviderName=$scope.searchAssignTo.staff.name;var searchToProviderId="";if(!angular.isUndefined($scope.searchToProvider.staff.id))searchToProviderId=$scope.searchToProvider.staff.id;validateAndSetPtRecordDate();var params={tabOnId:$scope.tabOnId,assignedToId:assingToProviderId,assignedToName:assignedToProviderName,sortBy:$scope.sortBy,sortOrder:$scope.sortOrder,pageNo:$scope.currentPage,rowsPerPage:$scope.noOfResult,type:$scope.type,TrUserId:global.TrUserId,strFilter:$scope.strFilter,nWebPortalEnabled:$scope.nWebPortalEnabled,authorizedUserIds:$scope.authorizedUserIds,ptRecordDateFrom:$scope.dateRangePickerObj.startDatepicker.format("yyyy-mm-dd"),ptRecordDateTo:$scope.dateRangePickerObj.endDatepicker.format("yyyy-mm-dd"),patientId:$scope.searchPatient.patient.id,searchToProviderId:searchToProviderId,showIncompleteRecords:$scope.showIncompleteRecords};params=$.param(params);recService.getRecordFilter(params).success(function(data){var jsonData=xml2json($.trim(data));$scope.ptRecords[$scope.ptRecordType]=returnDataArray(jsonData.Envelope.Body["return"].encounters.encounter);$scope.totalRecData=jsonData.Envelope.Body["return"].Total;$scope.calculatePageNumber()})};$scope.setTabId=function(tabOnId){$scope.tabOnId=tabOnId;$scope.currentPage=1;if($scope.tabOnId===6||$scope.tabOnId===1){$scope.showIncompleteRecords="0"}if($scope.type==1){if($scope.tabOnId===7){$scope.showIncompleteRecords="1"}else{$scope.showIncompleteRecords="0"}}$scope.loadInboxOutboxData($scope.type)};$scope.setRecordType=function(type){$scope.type=type;$scope.setTabId(3)};$scope.loadInboxOutboxData=function(type){$scope.sortBy=1;$scope.sortOrder="DESC";$scope.isFirstAttemptToSortByPriority=true;$scope.type=type;if($scope.type==0){$scope.bInbox=true;$scope.ptRecordType='PTRECORD_I'}else{$scope.bInbox=false;$scope.ptRecordType='PTRECORD_O'}var assingToProviderId="";if(!angular.isUndefined($scope.searchAssignTo.staff.id)&&$scope.assingToProvider!="")assingToProviderId=$scope.searchAssignTo.staff.id;var assignedToProviderName="";if(!angular.isUndefined($scope.searchAssignTo.staff.name)&&$scope.assingToProviderName!="")assignedToProviderName=$scope.searchAssignTo.staff.name;$scope.recordFilter()};$scope.loadPopup=function(encId,patientId,reqId,refReqId,requestStatus){if(requestStatus==="2"){ecwAlert("Attachments or Patient Record details have not been transmitted correctly. Please request the sender to send the Patient Record again.","Attachment Failed","","Close");return false}$scope.recordPopUpURL="";var params={encId:encId,patientId:patientId,reqId:reqId,refReqId:refReqId};params=$.param(params);$ocLazyLoad.load({name:'recordPopUpApp',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/commanP2PService.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/recordPopupController.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/patientMatchController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/patientrecord/ptrecorddetailsviewinbox.jsp?'+params);$scope.recordPopUpURL=url},function(e){console.log(e)})};$scope.loadInboxAttachments=function(nhxReqId,patientId,requestStatus){if(requestStatus==="2"){ecwAlert("Attachments or Patient Record details have not been transmitted correctly. Please request the sender to send the Patient Record again.","Attachment Failed","","Close");return false}if(patientId&&patientId!=="0"){$scope.patientIdentifiers=patientId}else{$scope.patientIdentifiers=""}$("#ptRecordInboxAtt_refattform").attr("action","/mobiledoc/jsp/webemr/jellybean/patientrecord/referralattachmentshtml.jsp");$("#ptRecordInboxAtt_refattform #nhxReqId").val(nhxReqId);$("#ptRecordInboxAtt_refattform").submit();$("#ptRecordInboxAtt").modal('show')};$scope.loadOutboxRecordPopup=function(referralId){$templateCache.remove($scope.outboxRecordPopUpURL);$scope.outboxRecordPopUpURL="";var params={referralId:referralId};params=$.param(params);$ocLazyLoad.load({name:'outboxRecordPopUpApp',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/outboxRecordPopupController.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/patientrecord/ptrecorddetailsviewoutbox.jsp?'+params);$scope.outboxRecordPopUpURL=url},function(e){console.log(e)})};$scope.loadAttachmentsCount=function(nhxRefId){$scope.attachmentCounts={};var params={nhxReqId:nhxRefId};params=$.param(params);recService.getAttachmentsCount(params).success(function(data){var jsonData=xml2json($.trim(data));$scope.attachmentCounts=returnDataArray(jsonData.Envelope.Body["return"].attachcounts)})};let hideDeleteMenu=function(){$("#ptRecordDelete").parent().removeClass('open')};$scope.deleteP2PEncounter=function(){if(!$scope.hasAcceessToDeletePatientRecord){modernAlertFactory.error({header:'<b>Patient Records – Security permission not granted</b>',message:"You do not have the permission to <b>delete a Patient Record</b>. <br/>The ability to delete a Patient Record is restricted by security setting, <b>Delete Patient Record</b>."});return}var chkboxlen=$('[name="ptRecChkbox"]:checked').length;if(chkboxlen<1){modernAlertFactory.communication({header:'<b>Patient Records - No record seleced</b>',message:"Please <b>choose</b> only one record to delete."});return}if(chkboxlen>1){modernAlertFactory.communication({header:'<b>Patient Records - Select a single patient record</b>',message:"To delete a record, please select only <b>one at a time.</b>"});return}if($scope.tabOnId==="1"){ecwAlert("Addressed records cannot be deleted.")}else{hideDeleteMenu();ecwConfirm("Are you sure you want to delete the selected Patient Records?","",deleteP2PRec)}};var deleteP2PRec=function(){var params={encId:$scope.delRecordDetails.encId,reqId:$scope.delRecordDetails.reqId,refReqId:$scope.delRecordDetails.refReqId,referralType:"PTRECORD_I",timeZone:getTZ(),timeZoneName:getTZName(),browserTime:getBrowserTime(),uid:global.TrUserId,uName:global.TrUserName,context:"webemr"};params=$.param(params);recService.deleteP2PEncounter(params).success(function(data){if(data&&data.trim()==="success"){if(isChromeUIScreen&&isChromeUIScreen==='true'){notification.show("success","","Patient Records - The P2P Patient record has been deleted.",6e3)}else{toasterSvc.showSuccessToaster('Patient Records - The P2P Patient record has been deleted.',6e3,true)}}else{if(isChromeUIScreen&&isChromeUIScreen==='true'){notification.show("error","",'Something went wrong, Please try again',6e3)}else{toasterSvc.showErrorToaster('Something went wrong, Please try again',6e3,true)}}$scope.recordFilter()})};$scope.deleteP2POutboxPatientRecord=function(){if(!$scope.hasAcceessToDeletePatientRecord){modernAlertFactory.error({header:'<b>Patient Records – Security permission not granted</b>',message:"You do not have the permission to <b>delete a Patient Record</b>. <br/>The ability to delete a Patient Record is restricted by security setting, <b>Delete Patient Record</b>."});return}if($scope.selectedPatientRecordIdForDelete.length===0){modernAlertFactory.communication({header:'<b>Patient Records - No record seleced</b>',message:"Please <b>choose</b> only one record to delete."});return}if($scope.selectedPatientRecordIdForDelete.length>1){modernAlertFactory.communication({header:'<b>Patient Records - Select a single patient record</b>',message:"To delete a record, please select only <b>one at a time.</b>"});return}hideDeleteMenu();ecwConfirm("Are you sure you want to delete the selected Patient Records?","",deleteP2POutboxRec)};let showPermissionDeniedWarning=function(){modernAlertFactory.warning({header:'<b>Delete P2P Patient Record - Permission Error</b>',message:"You do not have permission to <b>delete a Patient Record</b>. <br>"+"Permission to delete a Patient Record is contolled by security setting <b>Delete Patient Records.</b><br><br>"+"Please contact your practice administator to request access."})};let deleteP2POutboxRec=function(){var params={referralId:$scope.selectedPatientRecordIdForDelete[0],referralType:"PTRECORD_O",context:"patientRecord"};params=$.param(params);recService.deleteOutboxPatientRecord(params).success(function(data){let response=data?data.trim():"";if(response==="success"){if(isChromeUIScreen&&isChromeUIScreen==='true'){notification.show("success","",'Patient Records - The P2P Patient record has been deleted.',6e3)}else{toasterSvc.showSuccessToaster('Patient Records - The P2P Patient record has been deleted.',6e3,true)}}else if(response==="PERMISSION_DENIED"){showPermissionDeniedWarning()}else{if(isChromeUIScreen&&isChromeUIScreen==='true'){notification.show("error","",'Something went wrong, Please try again',6e3)}else{toasterSvc.showErrorToaster('Something went wrong, Please try again',6e3,true)}}$scope.selectedPatientRecordIdForDelete=[];$scope.recordFilter()},function(){if(isChromeUIScreen&&isChromeUIScreen==='true'){notification.show("error","",'Something went wrong, Please try again',6e3)}else{toasterSvc.showErrorToaster('Something went wrong, Please try again',6e3,true)}$scope.selectedPatientRecordIdForDelete=[];$scope.recordFilter()})};$scope.getDeletedPtRecordLogs=function(){hideDeleteMenu();$scope.deletePtRecordLogsUrl="";if("yes"==getItemKeyValue("inoutreferrallogs","").toLowerCase()){$ocLazyLoad.load({name:'deletePtRecordLogAppService',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/deletePtRecordLogsController.js','/mobiledoc/jsp/webemr/templates/pagination-tpl.js']}).then(function(){$scope.deletePtRecordLogsUrl=makeURL("/mobiledoc/jsp/webemr/jellybean/patientrecord/deletePtRecordLogs.jsp?ptRecordLogType=PTRECORD_I")},function(e){console.log(e)})}};$scope.getDeletedOutboxReferralLogs=function(){hideDeleteMenu();$scope.deleteRefLogsUrl="";$ocLazyLoad.load({name:'deleteRefLogsAppService',files:['/mobiledoc/jsp/webemr/jellybean/referral/deleteReferralLogsController.js','/mobiledoc/jsp/webemr/templates/pagination-tpl.js']}).then(function(){let logType='PTRECORD_O';$scope.deleteRefLogsUrl=makeURL("/mobiledoc/p2pmodule/referral/log/deletelog?referralLogType="+logType)},function(e){console.log(e)})};$scope.setP2PEncounter=function(encId,reqId,refReqId,index){var element=document.getElementById("ptrecchk_"+index);if(element.checked){var params={encId:encId,reqId:reqId,refReqId:refReqId};$scope.delRecordDetails=params}};$scope.setP2POutboxRefForDelete=function(event){let target=event.target;if(target.checked){if($scope.selectedPatientRecordIdForDelete.indexOf(target.value)===-1){$scope.selectedPatientRecordIdForDelete.push(target.value)}}else{$scope.selectedPatientRecordIdForDelete.forEach(function(patientRecord){if(patientRecord===target.value){let ptRecordIndex=$scope.selectedPatientRecordIdForDelete.indexOf(patientRecord);if(ptRecordIndex!==-1){$scope.selectedPatientRecordIdForDelete.splice(ptRecordIndex,1)}}})}};$scope.newP2PMessage=function(provider){$scope.newP2PMessageUrl="";$templateCache.remove($scope.newP2PMessageURL);var params="isP2P=1&type="+$scope.type;if(provider&&global.authorizedP2PStaff=="true"&&$.trim(provider.refTo).length>0&&parseInt($.trim(provider.refTo))>0&&!isAuthorizedStaffForProviderId($.trim(provider.refTo))){ecwAlert("You are not authorized to reply on behalf of "+provider.refToName+". Please ask the provider to authorize you.");return}if(!angular.isUndefined(provider)){params={patientId:provider.patientId,patientName:provider.name,toProviderNPI:provider.refToP2PNPI,toProviderName:provider.refToName,fromP2PNPI:provider.fromP2PNPI,fromProviderId:provider.refFrom,fromProvider:provider.sender,pnencid:provider.encounterId,p2preply:true,messageType:2,loginId:global.TrUserId,userType:global.loginUserType,TrUserId:global.TrUserId,subject:provider.reason,refReqId:provider.refReqId,toProvId:provider.refTo,isP2P:1};params=$.param(params)}$ocLazyLoad.load({name:'newP2PMessage',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/newP2PMessageController.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/outgoingAttController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/patientrecord/newp2pmessage.jsp?parentFound=true&'+params);$scope.newP2PMessageURL=url},function(e){console.log(e)})};$scope.loadOutboxAttachments=function(referralId){$scope.outboxAttachmentsURL="";$templateCache.remove($scope.outboxAttachmentsURL);$ocLazyLoad.load({name:'outboxAttachments',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/outboxAttachmentsController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/jellybean/patientrecord/outboxattachments.jsp?fromPage=ptRecord&referralId='+referralId);$scope.outboxAttachmentsURL=url},function(e){console.log(e)})};$scope.calculatePageNumber=function(){$scope.pages=[];$scope.noPages=Math.ceil($scope.totalRecData/$scope.noOfResult);for(var i=1;i<=$scope.noPages;i++){$scope.pages.push(i)}};$scope.setPerPageNoOfRecData=function(){$scope.currentPage=1;$scope.recordFilter()};$scope.setCurrent=function(){$timeout(function(){$scope.recordFilter()},100)};$scope.refreshP2PStatus=function(recType){if($scope.type==1){refreshP2PStatus($scope.ptRecords[$scope.ptRecordType],recType,recService)}};$scope.$on('$routeChangeSuccess',function(){if($scope.type==1){updateP2PStatus($scope.ptRecords[$scope.ptRecordType],recService,ptrecprdinbox_jsp_strMsgIds,'1')}});$scope.displayDetails=function(obj,provP2PNPIs,encodedNPIEncryptionKey,refToCCNPIListCount,CC){if(provP2PNPIs===""){return}displayDetails(obj,provP2PNPIs,encodedNPIEncryptionKey,refToCCNPIListCount,CC)};$scope.hideDetails=function(){hideDetails()};$scope.$on('$destroy',function(){$(document).off('click',transmissionLinkDocumentClick);$(".patient-record-app .dash-height > .ecw-scrollbar").unbind('scroll',patientRecordDataTableScroll)});$scope.toggleP2pConnectivityErrorPopup=function(showPopup){if(showPopup===false){$scope.showP2PconnectivityErrorPopup=showPopup}else{var isPopupShownAlready=get('p2pConnectivityPopupShown');if(isPopupShownAlready==null||isPopupShownAlready===false){put('p2pConnectivityPopupShown',true);$scope.showP2PconnectivityErrorPopup=true}else{$scope.showP2PconnectivityErrorPopup=false}}};$scope.refreshP2PconnectivityStatus=function(status){try{if(isItemKeyEnabled("nhxMonitorP2PConnectivity")){var p2pConnectivityStatus=status;if(angular.isUndefined(p2pConnectivityStatus)){p2pConnectivityStatus=get("p2pConnectivityStatus")}if(p2pConnectivityStatus!=null){$scope.isP2Pconnected=1===p2pConnectivityStatus;$scope.toggleP2pConnectivityErrorPopup(!$scope.isP2Pconnected);if($scope.$$phase!=='$apply'&&$scope.$$phase!=='$digest'){$scope.$apply()}}}}catch(e){}};$scope.getStaffData=function(){$scope.multipleStaffLookupCounter=$scope.multipleStaffLookupCounter+1;if($scope.isAllowMultipleStaffSelection){let ids='';let staffNames='';if($scope.multipleStaffLookupName.staffList!=null){let staffListLength=$scope.multipleStaffLookupName.staffList.length;for(let i=0;i<staffListLength;i++){if(i===0){ids=$scope.multipleStaffLookupName.staffList[i].id}else{ids=ids+','+$scope.multipleStaffLookupName.staffList[i].id}}staffNames=$scope.multipleStaffLookupText}if(ids===''){if($scope.multipleStaffLookupCounter===1){ids=global.TrUserId;$scope.multipleStaffLookupName.staffList=[{id:global.TrUserId,name:global.TrUserName}]}else{ids='0';$scope.multipleStaffLookupName.staffList=[{id:0,name:'All'}]}}$scope.searchAssignTo.staff.id=ids;$scope.searchAssignTo.staff.name=staffNames;$scope.pageNo=1;$scope.currentPage=1;$scope.recordFilter()}};$scope.$watch('dateRangePickerObj.startDatepicker',function(){changeStartOrEndDate('Date To')});$scope.$watch('dateRangePickerObj.endDatepicker',function(){changeStartOrEndDate('Date From')});let changeStartOrEndDate=function(changingDate){if($scope.dateRangePickerObj.startDatepicker&&$scope.dateRangePickerObj.endDatepicker){if(isStartOrEndDateChangeRequired()){if(changingDate==='Date To'){setPtRecordEndDate($scope.dateRangePickerObj.startDatepicker);showDateNotification("Date To")}else if(changingDate==='Date From'){setPtRecordStartDate($scope.dateRangePickerObj.endDatepicker);showDateNotification("Date From")}}else{isUpdateByController=false}}};let isStartOrEndDateChangeRequired=function(){if(!isUpdateByController&&(isGreaterThanMaxYears()||isDateDiffLessThanZero($scope.dateRangePickerObj.startDatepicker,$scope.dateRangePickerObj.endDatepicker))){return true}else{return false}};let isDateDiffLessThanZero=function(startDate,endDate){let diff=endDate.getTime()-startDate.getTime();return diff<0};let showDateNotification=function(autoChangedDate){notification.show('info-msg','','The "'+autoChangedDate+'" field has been automatically adjusted to comply with the 1-year maximum range.',6e3)};let isGreaterThanMaxYears=function(){let momentStartDate=moment($scope.dateRangePickerObj.startDatepicker,'YYYY-MM-DD');let momentEndDate=moment($scope.dateRangePickerObj.endDatepicker,'YYYY-MM-DD');return momentEndDate.diff(momentStartDate,'days')>365};let setPtRecordEndDate=function(date){let newEndDate=moment(date,'yyyy-mm-dd').add(1,'years');if(newEndDate.isAfter()){newEndDate=moment()}let endSelectedDate=newEndDate.toDate();$scope.dateRangePickerObj.endDate=endSelectedDate;$scope.dateRangePickerObj.endDatepicker=endSelectedDate;isUpdateByController=true};let setPtRecordStartDate=function(date){let newStartDate=moment(date,'yyyy-mm-dd').add(-1,'years').toDate();$scope.dateRangePickerObj.startDate=newStartDate;$scope.dateRangePickerObj.startDatepicker=newStartDate;isUpdateByController=true};let validateAndSetPtRecordDate=function(){if(!$scope.dateRangePickerObj.startDatepicker&&!$scope.dateRangePickerObj.endDatepicker){let newEndDate=moment().toDate();$scope.dateRangePickerObj.endDate=newEndDate;$scope.dateRangePickerObj.endDatepicker=newEndDate;setPtRecordStartDate($scope.dateRangePickerObj.endDatepicker);isUpdateByController=true}else if($scope.dateRangePickerObj.startDatepicker&&!$scope.dateRangePickerObj.endDatepicker){setPtRecordEndDate($scope.dateRangePickerObj.startDatepicker)}else if(!$scope.dateRangePickerObj.startDatepicker&&$scope.dateRangePickerObj.endDatepicker){setPtRecordStartDate($scope.dateRangePickerObj.endDatepicker)}}});function findPos(obj){var windowHeight=$(window).height();curleft=obj.pageX-100;curtop=obj.pageY;var totalHeight=windowHeight-curtop;if(totalHeight<=200){curtop=curtop-150}return[curleft,curtop]}function displayDetails(obj,npi,encodedNPIEncryptionKey,refToCCNPIListCount,CC){if(npi==="")return;timer_hdl=setTimeout(function(){var posObj=findPos(obj);if(CC){if(parseInt(refToCCNPIListCount)>2){document.getElementById("providerdetaildiv").style.height="260px"}else{document.getElementById("providerdetaildiv").style.height="130px"}document.getElementById("providerdetaildiv").style.left=posObj[0]-10+"px"}else{document.getElementById("providerdetaildiv").style.height="130px";document.getElementById("providerdetaildiv").style.left=posObj[0]+100+"px"}document.getElementById("providerdetaildiv").style.width="300px";document.getElementById("providerdetaildiv").style.top=posObj[1]+"px";document.getElementById("providerdetaildiv").style.display="block";document.getElementById("npi").value=npi;document.getElementById("encodedNPIEncryptionKey").value=encodedNPIEncryptionKey;document.getElementById("frmPvdrDetails").action="/mobiledoc/jsp/ereferralemr/getProviderDetails.jsp";document.getElementById("frmPvdrDetails").submit()},1)}function hideDetails(){clearTimeout(timer_hdl);document.getElementById("providerdetaildiv").style.display="none"}function resizeListviewBody(){var listViewTableHt=$('#ptRecInboxTable').css('height');$('#ptRecordListViewBody').css('height',listViewTableHt+10)}
var prismaAppModalModule=angular.module("prismaAppModalModule",[]);prismaAppModalModule.controller("PrismaModalController",function($scope,$ocLazyLoad,$timeout,$modal,PrismaAppService,$observableService,PRISMA_CONSTANT,$sce){var prismaCtrl=this;var pagination={};var initData={};const DEFAULT_MINS_FOR_RELEASE_STUCK_PATIENT=4;prismaCtrl.PRISMA_CONSTANT=PRISMA_CONSTANT;prismaCtrl.hideFailedIndexingMessage=true;prismaCtrl.hidePartialIndexingMessage=true;prismaCtrl.partialIndexedMessageResponse={};prismaCtrl.showIndexingStatusButton=false;prismaCtrl.notAvailableDocumentDetails=[];prismaCtrl.patientId=$scope.patientId;prismaCtrl.encounterId=$scope.encounterId;prismaCtrl.userId=$scope.userId;prismaCtrl.isFromExe=PrismaAppService.isFromExe;if(prismaCtrl.isFromExe&&angular.isUndefined(prismaCtrl.patientId)){prismaCtrl.patientId=angular.element("#prisma-exe-parent-id").scope().vm.patientId;prismaCtrl.encounterId=angular.element("#prisma-exe-parent-id").scope().vm.encounterId;prismaCtrl.userId=angular.element("#prisma-exe-parent-id").scope().vm.userId}prismaCtrl.isCallingFrom=PrismaAppService.getCallingFrom();if(prismaCtrl.isCallingFrom&&angular.isUndefined(prismaCtrl.patientId)){prismaCtrl.patientId=angular.element("#prisma-pn-tab").scope().vm.patientId;prismaCtrl.encounterId=angular.element("#prisma-pn-tab").scope().vm.encounterId;prismaCtrl.userId=angular.element("#prisma-pn-tab").scope().vm.userId}prismaCtrl.showPrismaTabFilter=false;prismaCtrl.showRecordTabFilter=false;prismaCtrl.healowHubEnabled=false;prismaCtrl.topicName="index~"+prismaCtrl.patientId;prismaCtrl.isIndexingFinished=false;prismaCtrl.indexStatus=PRISMA_CONSTANT.INDEX.INPROGRESS;prismaCtrl.isPrismaSearchItemKeyDisabled=false;prismaCtrl.isPaidModelEnabled=PrismaAppService.isPaidModelEnabled;prismaCtrl.actionHubUrl="";prismaCtrl.closePrismaModal=closePrismaModal;prismaCtrl.ccdaDocFetchCallBack=ccdaDocFetchCallBack;prismaCtrl.isNewMIFetched=false;let pdfViewer=undefined;prismaCtrl.init=function(){if(!prismaCtrl.isCallingFrom){$observableService.publish("prismaModalOpened")}PrismaAppService.notifyPrismaPopupInstance(true);angular.element('.prismaview .maintabs').addClass('disabled');_checkAndOpenPrismaDisclaimerStatusModal();$observableService.subscribe('switchPrismaTab',function(){prismaCtrl.currentTab=prismaCtrl.menuItems[0].route;prismaCtrl.indextab=1});$observableService.subscribe('switchRecordsTab',function(data){prismaCtrl.updateCurrentTab(prismaCtrl.menuItems[2].route,3,prismaCtrl.menuItems[2].heading);prismaCtrl.moveToRecordTimeOut=$timeout(function(){$observableService.publish('moveToRecordsTab',data.data)},1e3)});$observableService.subscribe('onUnloadPrismaStandalone',function(){prismaCtrl.closePrismaModal()});if(PrismaAppService.getCallingFrom()!=="hinsights"){angular.element('#prisma-screen-loading'+prismaCtrl.patientId).hide()}else{angular.element('#prisma-screen-loading').hide()}prismaCtrl.updateNewMIFetched()};prismaCtrl.updateNewMIFetched=function(){var promiseIndexPt=PrismaAppService.isNewMIFetched(prismaCtrl.patientId);promiseIndexPt.then(function(response){if(response){if(response.status&&response.status==='success'){prismaCtrl.isNewMIFetched=response.isNewMIAvailable}}},function(errorMsg){})};prismaCtrl.adtData={};prismaCtrl.fhirData={};prismaCtrl.externalRecord={};prismaCtrl.dpcData={};function assignLastRetrievalAndIndexedDates(lastRetrievalDates){prismaCtrl.lastDocFetchDate={};if(lastRetrievalDates.CCDA){prismaCtrl.lastDocFetchDate['CCDA_lastDocFetchDate']=lastRetrievalDates.CCDA.lastRetrievalDate?lastRetrievalDates.CCDA.lastRetrievalDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.lastDocFetchDate['CCDA_lastIndexedDate']=lastRetrievalDates.CCDA.lastIndexedDate?lastRetrievalDates.CCDA.lastIndexedDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}else{prismaCtrl.lastDocFetchDate['CCDA_lastDocFetchDate']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.lastDocFetchDate['CCDA_lastIndexedDate']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}if(lastRetrievalDates.ADT){prismaCtrl.lastDocFetchDate['ADT_lastDocFetchDate']=lastRetrievalDates.ADT.lastRetrievalDate?lastRetrievalDates.ADT.lastRetrievalDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.lastDocFetchDate['ADT_lastIndexedDate']=lastRetrievalDates.ADT.lastIndexedDate?lastRetrievalDates.ADT.lastIndexedDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}else{prismaCtrl.lastDocFetchDate['ADT_lastDocFetchDate']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.lastDocFetchDate['ADT_lastIndexedDate']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}if(lastRetrievalDates.ProgressNote){prismaCtrl.lastDocFetchDate['ProgressNote_lastDocFetchDate']=lastRetrievalDates.ProgressNote.lastRetrievalDate?lastRetrievalDates.ProgressNote.lastRetrievalDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.lastDocFetchDate['ProgressNote_lastIndexedDate']=lastRetrievalDates.ProgressNote.lastIndexedDate?lastRetrievalDates.ProgressNote.lastIndexedDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}else{prismaCtrl.lastDocFetchDate['ProgressNote_lastDocFetchDate']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.lastDocFetchDate['ProgressNote_lastIndexedDate']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}if(lastRetrievalDates.FHIR){prismaCtrl.fhirData['lastIndexedDate']=lastRetrievalDates.FHIR.lastIndexedDate?lastRetrievalDates.FHIR.lastIndexedDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}else{prismaCtrl.fhirData['lastIndexedDate']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}assignLastIndexedDate(lastRetrievalDates)}function assignLastDocStatusAndComponent(sourceData){assignLastRetrievalFHIRData(sourceData.FHIR);assignLastRetrievalADTData(sourceData.ADT);assignLastRetrievalExternalData(sourceData.ExternalRecord);assignLastRetrievalDPCData(sourceData.DPC)}prismaCtrl.isDocInprogress=false;prismaCtrl.isDocFailed=false;function assignLastRetrievalFHIRData(fhirDoc){if(fhirDoc){prismaCtrl.fhirData['not-applicable']=undefined;prismaCtrl.fhirData['isFhirEnabled']=fhirDoc.isFhirEnabled;prismaCtrl.fhirData['lastReceivedDate']=fhirDoc.lastReceivedDate?fhirDoc.lastReceivedDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.fhirData['status']=fhirDoc["status"]?fhirDoc["status"]:undefined;prismaCtrl.fhirData['error-resource']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.fhirData['lastStartDate']=fhirDoc['lastStartDate']?fhirDoc['lastStartDate']:'';prismaCtrl.fhirData['lastEndDate']=fhirDoc['lastEndDate']?fhirDoc['lastEndDate']:'';prismaCtrl.fhirData['lastInitiatedDate']=fhirDoc['lastInitiatedDate']?fhirDoc['lastInitiatedDate']:'';if(prismaCtrl.fhirData['lastStartDate']===''&&prismaCtrl.fhirData['lastEndDate']===''&&prismaCtrl.fhirData['lastInitiatedDate']===''){prismaCtrl.fhirData['not-applicable']='N/A'}if(prismaCtrl.fhirData['status']===prismaCtrl.PRISMA_CONSTANT.FHIR.In_Progress){prismaCtrl.isDocInprogress=true;prismaCtrl.isDocFailed=false}else if((prismaCtrl.fhirData['status']===prismaCtrl.PRISMA_CONSTANT.FHIR.Failed_Preprocessing||prismaCtrl.fhirData['status']===prismaCtrl.PRISMA_CONSTANT.FHIR.Failed_Retrieval||prismaCtrl.fhirData['status']===prismaCtrl.PRISMA_CONSTANT.FHIR.Failed_Parsing||prismaCtrl.fhirData['status']===prismaCtrl.PRISMA_CONSTANT.FHIR.Partial_Success)&&prismaCtrl.isDocInprogress===false){prismaCtrl.isDocInprogress=false;prismaCtrl.isDocFailed=true}prismaCtrl.fhirData['error-resource']=fhirDoc['error-resource']?fhirDoc['error-resource']:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.fhirData['isRefreshEnabled']=fhirDoc['isRefreshEnabled']?fhirDoc['isRefreshEnabled']:false}}function allignLeftPositionIfFailedComponentPresent(){if(prismaCtrl.fhirData['error-resource']&&prismaCtrl.fhirData['error-resource']!==prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA||prismaCtrl.adtData["error-resource"]!==prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA||prismaCtrl.dpcData["error-resource"]&&prismaCtrl.dpcData["error-resource"]!==prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA||prismaCtrl.externalRecord["error-resource"]!==prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA){angular.element(".popover-sm.recent-doc").css({'left':'36%'});angular.element(".popover-sm.recent-doc").css({'width':'max-content'})}}function assignLastRetrievalADTData(adtDoc){if(adtDoc){prismaCtrl.adtData["status"]=adtDoc["status"]?adtDoc["status"]:undefined;prismaCtrl.adtData["error-resource"]=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;if(prismaCtrl.adtData['status']===prismaCtrl.PRISMA_CONSTANT.ADT.In_Progress){prismaCtrl.isDocInprogress=true;prismaCtrl.isDocFailed=false}else if(prismaCtrl.adtData['status']===prismaCtrl.PRISMA_CONSTANT.ADT.Failed_Preprocessing&&prismaCtrl.isDocInprogress===false){prismaCtrl.isDocInprogress=false;prismaCtrl.isDocFailed=true}prismaCtrl.adtData["error-resource"]=adtDoc["error-resource"]?adtDoc["error-resource"]:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}}function assignLastRetrievalExternalData(ihubDoc){if(ihubDoc){prismaCtrl.externalRecord["status"]=ihubDoc["status"]?ihubDoc["status"]:undefined;prismaCtrl.externalRecord["error-resource"]=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;if(prismaCtrl.externalRecord['status']===prismaCtrl.PRISMA_CONSTANT.IHUB.In_Progress){prismaCtrl.isDocInprogress=true;prismaCtrl.isDocFailed=false}else if((prismaCtrl.externalRecord['status']===prismaCtrl.PRISMA_CONSTANT.IHUB.Failed_Preprocessing||prismaCtrl.externalRecord['status']===prismaCtrl.PRISMA_CONSTANT.IHUB.Failed_Retrieval)&&prismaCtrl.isDocInprogress===false){prismaCtrl.isDocInprogress=false;prismaCtrl.isDocFailed=true}else if(prismaCtrl.externalRecord['status']==="Failed"){prismaCtrl.message=ihubDoc["message"];prismaCtrl.isDocFailed=true}prismaCtrl.externalRecord["error-resource"]=ihubDoc["error-resource"]?ihubDoc["error-resource"]:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}}function assignLastRetrievalDPCData(dpcDoc){if(dpcDoc){prismaCtrl.dpcData['status']=dpcDoc["status"]?dpcDoc["status"]:undefined;prismaCtrl.dpcData['isDpcEnabled']=dpcDoc["isDpcEnabled"];prismaCtrl.dpcData['error-resource']=prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;prismaCtrl.dpcData['lastReceivedDate']=dpcDoc.lastReceivedDate?dpcDoc.lastReceivedDate:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA;if(prismaCtrl.dpcData['status']===prismaCtrl.PRISMA_CONSTANT.DPC.In_Progress){prismaCtrl.isDocInprogress=true;prismaCtrl.isDocFailed=false}else if(prismaCtrl.dpcData['status']===prismaCtrl.PRISMA_CONSTANT.DPC.Failed_Preprocessing&&prismaCtrl.isDocInprogress===false){prismaCtrl.isDocInprogress=false;prismaCtrl.isDocFailed=true}prismaCtrl.dpcData["error-resource"]=dpcDoc["error-resource"]?dpcDoc["error-resource"]:prismaCtrl.PRISMA_CONSTANT.EMPTY_DATA}}function assignLastIndexedDate(lastRetrievalDates){let indexedDates=[];let dFormat='MM/DD/YYYY hh:mm A';for(let key in lastRetrievalDates){let lastIndexedDate=lastRetrievalDates[key]['lastIndexedDate'];if(lastIndexedDate&&moment(lastIndexedDate,dFormat,true).isValid()){indexedDates.push(new Date(lastIndexedDate))}}prismaCtrl.lastIndexedTime="";if(indexedDates&&indexedDates.length>0){prismaCtrl.lastIndexedTime=moment(new Date(Math.max.apply(null,indexedDates))).format(dFormat)}}function _checkAndOpenPrismaDisclaimerStatusModal(){let data=PrismaAppService.getProfileData();if(data){initData=data;PrismaAppService.setProfileData(data);PrismaAppService.setCollapsed(data["isCollapse"]);userProfileConfiguration(data);if(initData&&initData.disclaimerNotes){prismaCtrl.notes=$sce.trustAsHtml(decodeHTMLContent(initData.disclaimerNotes));prismaCtrl.showCISINotes=false;if(initData.cisiDisclaimerNotes){prismaCtrl.cisiNotes=$sce.trustAsHtml(decodeHTMLContent(initData.cisiDisclaimerNotes));prismaCtrl.showCISINotes=true}}setTimerForPatientStatusActive(data.minsForReleaseStuckPatient);prismaCtrl.dataExchangeConsent=data.dataExchangeConsent;prismaCtrl.isRelatedKeywordsEnabled=data.isRelatedKeywordsEnabled;prismaCtrl.isHealowPlusEnabled=data.isHealowPlusEnabled}}function userProfileConfiguration(data){if(data.records_tab_filter===0){prismaCtrl.showRecordTabFilter=false}else{prismaCtrl.showRecordTabFilter=true}PrismaAppService.setRecordFilterStatus(prismaCtrl.showRecordTabFilter);if(data.prisma_tab_filter===0){prismaCtrl.showPrismaTabFilter=false}else{prismaCtrl.showPrismaTabFilter=true}if(data.timelineViewMode===0){PrismaAppService.isClassicTimeline=true}else{PrismaAppService.isClassicTimeline=false}PrismaAppService.setPrismaFilterStatus(prismaCtrl.showPrismaTabFilter);_fetchPrismaPanelPostDisclaimerInitData()}prismaCtrl.showPSACMessage=function(e){angular.element('.prismaview .popover').hide();const elPopover=angular.element('.prismaview .psac-message.popover');prismaCtrl.psacMessageTimeout=$timeout(function(){elPopover.show().animate({},100,function(){angular.element(this).position({of:angular.element(e.target),my:'left top+12 !important',at:'left bottom',collision:"flipfit",within:".prismaview"}).animate({"opacity":1},100)})},100)};prismaCtrl.closePSACModal=function(){angular.element('.prismaview .psac-message').hide()};prismaCtrl.showPrismaDisclaimerModal=function(onInfoBtnClick,e){prismaCtrl.hideDisclaimerDoNotShowMsg=onInfoBtnClick;angular.element('.prismaview .popover').hide();const elPopover=angular.element('.prismaview .disclaimer-content.popover');prismaCtrl.disclaimerTimeout=$timeout(function(){elPopover.show().animate({},100,function(){angular.element(this).position({of:angular.element(e.target),my:'left top+12 !important',at:'left bottom',collision:"flipfit",within:".prismaview"}).animate({"opacity":1},100)})},100)};prismaCtrl.showLastFetchDateModal=function(e){angular.element('.prismaview .popover').hide();let elPopover=angular.element('.prismaview .recent-doc.popover');prismaCtrl.lastDocFetchDateTimeout=$timeout(function(){elPopover.show().animate({},100,function(){angular.element(this).position({of:angular.element(e.target),my:'left+40 top+18',at:'left bottom',collision:"flipfit",within:".prismaview"}).animate({"opacity":1},100)});allignLeftPositionIfFailedComponentPresent()},100)};prismaCtrl.highlightSuggestedKeyword=function(haystack,needle){if(!needle){return $sce.trustAsHtml(haystack)}return $sce.trustAsHtml(haystack.replace(new RegExp(needle,"gi"),function(match){return'<span class="highlightedText">'+match+'</span>'}))};prismaCtrl.closePrismaDisclaimerModal=function(){angular.element('.prismaview .disclaimer-content').hide()};prismaCtrl.closeLastFetchDateModal=function(){angular.element('.prismaview .recent-doc').hide()};function _fetchPrismaPanelPostDisclaimerInitData(){prismaCtrl.isOpenPrismaModal=true;prismaCtrl._checkPatientWebEnabled();prismaCtrl._checkMemberInsightsEnabled();prismaCtrl.isElasticSearchServerAlive()}function _insertPrismaAuditLog(ptId,userId,tabData){PrismaAppService.insertPrismaAuditLog(ptId,userId,tabData).then(function(response){},function(errorMsg){ecwAlert(errorMsg)})}prismaCtrl._checkPatientWebEnabled=function(){if("yes"===getItemKeyValue('HealowDataSupported').toLowerCase()){if(initData.isPatientWebEnabled){prismaCtrl.healowHubEnabled=true}else if(!prismaCtrl.healowHubEnabled){PrismaAppService.getMenuItems().forEach((element,index)=>{if(element.route==='healowhubtab'){prismaCtrl.menuItems.splice(index,1)}})}}else{PrismaAppService.getMenuItems().forEach((element,index)=>{if(element.route==='healowhubtab'){prismaCtrl.menuItems.splice(index,1)}})}};prismaCtrl.loadMemberInsightsResources=function(){$ocLazyLoad.load({name:"MIPrisma",files:['/mobiledoc/jsp/healowInsights/components/js/cipc-info-icon-service.js','/mobiledoc/jsp/healowInsights/components/js/pd-info-icon-service.js','/mobiledoc/jsp/healowInsights/components/js/hcc-info-icon-service.js','/mobiledoc/jsp/healowInsights/components/js/hcc-dpc-info-icon-service.js','/mobiledoc/jsp/healowInsights/components/js/hcc-filter-service.js','/mobiledoc/jsp/healowInsights/components/js/hcc-disagree-action-service.js','/mobiledoc/jsp/healowInsights/memberinsights/js/prisma-member-insights.js','/mobiledoc/jsp/healowInsights/memberinsights/js/prisma-mi-dropdown-selection.js','/mobiledoc/jsp/healowInsights/templates/pagination-tpl.js','/mobiledoc/jsp/healowInsights/memberinsights/css/prisma-member-insights.css'],serie:true,cache:true})};prismaCtrl._checkMemberInsightsEnabled=function(){if(initData.isUserAuthorizedToViewMemberInsights){prismaCtrl.loadMemberInsightsResources()}else{prismaCtrl.menuItems.forEach((element,index)=>{if(element.route==='memberinsightstab'){prismaCtrl.menuItems.splice(index,1)}})}};prismaCtrl.isElasticSearchServerAlive=function(){if(undefined!==initData.isPrismaSearchEnabled&&typeof initData.isPrismaSearchEnabled==="boolean"&&!initData.isPrismaSearchEnabled){prismaCtrl.isPrismaSearchItemKeyDisabled=true;$observableService.publish('searchDisable',{"isSearchDisabled":true,"patientId":prismaCtrl.patientId});prismaCtrl.getDocumentMetadataPostIndexing();prismaCtrl.offlineTimeout=$timeout(function(){onInitDisabledPrismaTab()},400);return}var data=JSON.parse(initData.isElasticSearchServerAlive);if(data&&data.hasOwnProperty('status')){if("success"!==$.trim(data.status)&&data.hasOwnProperty('message')){$observableService.publish('searchDisable',{"isSearchDisabled":true,"patientId":prismaCtrl.patientId});PrismaAppService.setPopupModelMessage($.trim(data.message));prismaCtrl.getDocumentMetadataPostIndexing();prismaCtrl.offlineTimeout=$timeout(function(){prismaCtrl.openPrismaOfflineModal();onInitDisabledPrismaTab()},400)}else{prismaCtrl.isESAlive=true;prismaCtrl._onTheFlyIndexPtDocument(false)}}};function applyChanges(){try{if($scope.$$phase!=='$apply'&&$scope.$$phase!=='$digest'){$scope.$apply()}}catch(e){}}function onInitDisabledPrismaTab(){angular.element('.prismaview .maintabs').removeClass('disabled');if(!PrismaAppService.getSearchWord()){angular.element('.prismaview .prisma-modal .tabbrdrbtm .nav-tabs>li:first-child').addClass('disabled')}}prismaCtrl._onTheFlyIndexPtDocument=function(isRequestForReIndex,prismaRecordTypeIds){prismaCtrl.isIndexingFinished=false;prismaCtrl.showIndexingStatusButton=true;prismaCtrl.indexStatus=PRISMA_CONSTANT.INDEX.INPROGRESS;PrismaAppService.setIndexStatus(prismaCtrl.indexStatus);var promiseIndexPt=PrismaAppService.indexPatientPrismaDocuments(prismaCtrl.patientId,isRequestForReIndex,prismaRecordTypeIds,PrismaAppService.getBreakGlassReasonNo());promiseIndexPt.then(function(respObj){var resp;if(undefined!==respObj){resp=respObj.responseJson;if(resp.isTransactionCreated&&PrismaAppService.isPrismaPopupInstanceOpen()){showAlertMessage("<div class='text-left mt-24'><b>External Records - Preparing"+"</b><br/></br><b>Revisit</b> the screen in <b>some time</b> to <b>view the records</b>"+" </div>",'','SecurityMsg','','','400px;','ok','','showAlert','','','',true,false)}if(undefined!==respObj.status&&'failed'===respObj.status&&PrismaAppService.isPrismaPopupInstanceOpen()){ecwAlert("Error occurred while preparing documents to be searchable.")}}if(undefined!==resp&&undefined!==resp.isIndexingFinished&&typeof resp.isIndexingFinished==="boolean"&&undefined!==resp.isPatientDataSearchable&&typeof resp.isPatientDataSearchable==="boolean"){prismaCtrl.isIndexingFinished=resp.isIndexingFinished;if(prismaCtrl.isIndexingFinished){$observableService.publish('searchInit',{"patientId":prismaCtrl.patientId});onInitDisabledPrismaTab();$observableService.publish('searchDisable',{"isSearchDisabled":!resp.isPatientDataSearchable});prismaCtrl.setDocumentMetadataPostIndexing(resp)}else{prismaCtrl.closePrismaModal();ecwAlert("healow Insights will shortly be available once the patient's records are refreshed on the search server. Please try again in a few seconds.")}}},function(errorMsg){ecwAlert(errorMsg)})};prismaCtrl.getDocumentMetadataPostIndexing=function(){PrismaAppService.getDocumentMetadataPostIndexing(prismaCtrl.patientId).then(function(resp){prismaCtrl.setDocumentMetadataPostIndexing(resp)},function(errorMsg){ecwAlert(errorMsg)})};prismaCtrl.setDocumentMetadataPostIndexing=function(resp){var currentdate=new Date;prismaCtrl.lastCheck=currentdate.getDate()+"/"+(currentdate.getMonth()+1)+"/"+currentdate.getFullYear()+" "+currentdate.getHours()+":"+currentdate.getMinutes()+":"+currentdate.getSeconds();prismaCtrl.notAvailableAdtCount=0;prismaCtrl.notAvailableCcdaCount=0;prismaCtrl.notAvailableFhirCount=0;prismaCtrl.notAvailablePnCount=0;prismaCtrl.notAvailablePtCount=0;prismaCtrl.isCcdaFailedDocPresent=false;prismaCtrl.isFhirFailedDocPresent=false;prismaCtrl.isAdtFailedDocPresent=false;prismaCtrl.isPNFailedDocPresent=false;prismaCtrl.isPtFailedDocPresent=false;prismaCtrl.isAllDocFailedToIndex=false;prismaCtrl.partialIndexedMessageResponse={};prismaCtrl.notAvailableDocumentDetails=[];prismaCtrl.isNonConcludedTransactionExist=false;if(resp!=="undefined"&&resp.documentIndexStatus!=="undefined"){if(undefined!==resp.filterObj&&undefined!==resp.filterObj.prismaTabFilters){PrismaAppService.setPrismaTabFilters(resp.filterObj.prismaTabFilters)}if(undefined!==resp.filterObj&&undefined!==resp.filterObj.recordsTabFilters){PrismaAppService.setRecordsTabFilters(resp.filterObj.recordsTabFilters)}if(undefined!==resp.filterObj&&undefined!==resp.filterObj.recordsTabFilterTemplates){PrismaAppService.setRecordsTabFilterTemplates(resp.filterObj.recordsTabFilterTemplates);if(PrismaAppService.isADTModule()||PrismaAppService.getCallingFrom()==="floatingToolbar"||PrismaAppService.getCallingFrom()==="enc"){PrismaAppService.setApplyRecordTabFilterDefaultTemplate(false)}else{PrismaAppService.setApplyRecordTabFilterDefaultTemplate(true)}}if(undefined!==resp.lastDocRetrievalAndIndexedDates){assignLastRetrievalAndIndexedDates(resp.lastDocRetrievalAndIndexedDates)}if(undefined!==resp.lastDocStatusAndComponent){assignLastDocStatusAndComponent(resp.lastDocStatusAndComponent)}if('success'===resp.documentIndexStatus.trim()){prismaCtrl.showIndexingStatusButton=false;prismaCtrl.indexStatus=PRISMA_CONSTANT.INDEX.SUCCESS;PrismaAppService.setIndexStatus(prismaCtrl.indexStatus);prismaCtrl.hidePartialIndexingMessage=true;prismaCtrl.hideFailedIndexingMessage=true}else if('partial'===resp.documentIndexStatus.trim()){_documentsIndexedPartially(resp)}else if('fail'===resp.documentIndexStatus.trim()){_documentsIndexingFailed()}if(undefined!==resp.notAvailableDocumentDetails&&resp.notAvailableDocumentDetails instanceof Array){prismaCtrl.notAvailableDocumentDetails=resp.notAvailableDocumentDetails}if(undefined!==resp.notAvailableAdtCount&&typeof resp.notAvailableAdtCount==="number"){prismaCtrl.notAvailableAdtCount=resp.notAvailableAdtCount}if(undefined!==resp.notAvailableCcdaCount&&typeof resp.notAvailableCcdaCount==="number"){prismaCtrl.notAvailableCcdaCount=resp.notAvailableCcdaCount}if(undefined!==resp.notAvailableFhirCount&&typeof resp.notAvailableFhirCount==="number"){prismaCtrl.notAvailableFhirCount=resp.notAvailableFhirCount}if(undefined!==resp.notAvailablePnCount&&typeof resp.notAvailablePnCount==="number"){prismaCtrl.notAvailablePnCount=resp.notAvailablePnCount}if(undefined!==resp.notAvailablePtCount&&typeof resp.notAvailablePtCount==="number"){prismaCtrl.notAvailablePtCount=resp.notAvailablePtCount}prismaCtrl.psacEncCount=resp.psacEncCount;prismaCtrl.totalSecuredEncCount=resp.totalSecuredEncCount;prismaCtrl.ssEncDetail=resp.ssEncDetail;prismaCtrl.isPsacHideOptionSelected=resp.isPsacHideOptionSelected;prismaCtrl.isNonConcludedTransactionExist=resp.isNonConcludedTransactionExist}};var setTimerForPatientStatusActive=function(minsForReleaseStuckPatient){if(!minsForReleaseStuckPatient||minsForReleaseStuckPatient<=0){minsForReleaseStuckPatient=DEFAULT_MINS_FOR_RELEASE_STUCK_PATIENT}prismaCtrl.makeActiveSession=setInterval(function(){var promiseIndexPt=PrismaAppService.setPatientStatusActive(prismaCtrl.patientId);promiseIndexPt.then(function(resp){},function(errorMsg){ecwAlert(errorMsg)})},minsForReleaseStuckPatient*1e3*60)};var _documentsIndexingFailed=function(){prismaCtrl.indexStatus=PRISMA_CONSTANT.INDEX.FAILED;$observableService.publish('searchDisable',{"isSearchDisabled":true});PrismaAppService.setIndexStatus(prismaCtrl.indexStatus);prismaCtrl.hideFailedIndexingMessage=false;prismaCtrl.failedStatusMessage="PRISMA All Records Failed to Index";prismaCtrl.isSearchDisabled=true;prismaCtrl.isAllDocFailedToIndex=true};var _documentsIndexedPartially=function(response){prismaCtrl.indexStatus=PRISMA_CONSTANT.INDEX.PARTIAL;PrismaAppService.setIndexStatus(prismaCtrl.indexStatus);_getPatientsFailedIndexDocumentDetails(response)};prismaCtrl.indexFailedDoc=function(e){prismaCtrl.isFailIndexInProgress=true;PrismaAppService.getConnectedUsers(prismaCtrl.patientId).then(function(response){prismaCtrl.closePopover(e);prismaCtrl.isFailIndexInProgress=false;if(response&&undefined!==response.isElasticSearchServerAlive&&"success"!==response.isElasticSearchServerAlive.status){ecwAlert(response.isElasticSearchServerAlive.message)}else if(response&&undefined!==response.connectedUsersCount&&response.connectedUsersCount===1){makeTabSelected(PRISMA_CONSTANT.TAB.RECORDS);PrismaAppService.setSearchedWord('');var prismaRecordTypeIds=[];if(prismaCtrl.isAdtFailedDocPresent||prismaCtrl.notAvailableAdtCount>0||prismaCtrl.isAllDocFailedToIndex){prismaRecordTypeIds.push(PRISMA_CONSTANT.RECORD_TYPE.ADT)}if(prismaCtrl.isCcdaFailedDocPresent||prismaCtrl.notAvailableCcdaCount>0||prismaCtrl.isAllDocFailedToIndex){prismaRecordTypeIds.push(PRISMA_CONSTANT.RECORD_TYPE.CCDA)}if(prismaCtrl.isFhirFailedDocPresent||prismaCtrl.notAvailableFhirCount>0||prismaCtrl.isAllDocFailedToIndex){prismaRecordTypeIds.push(PRISMA_CONSTANT.RECORD_TYPE.FHIR)}if(prismaCtrl.isPNFailedDocPresent||prismaCtrl.notAvailablePnCount>0||prismaCtrl.isAllDocFailedToIndex){prismaRecordTypeIds.push(PRISMA_CONSTANT.RECORD_TYPE.PROGRESS_NOTE)}if(prismaCtrl.isPtFailedDocPresent||prismaCtrl.notAvailablePtCount>0||prismaCtrl.isAllDocFailedToIndex){prismaRecordTypeIds.push(PRISMA_CONSTANT.RECORD_TYPE.PATIENT_DOCUMENT)}if(prismaRecordTypeIds.length===0){ecwAlert("No documents available to reindex.");return}prismaCtrl._onTheFlyIndexPtDocument(true,JSON.stringify(prismaRecordTypeIds))}else{ecwAlert("The Records cannot be refreshed due to other users currently accessing healow Insights for this patient.")}},function(errorMsg){prismaCtrl.isFailIndexInProgress=false;ecwAlert(errorMsg)})};prismaCtrl.showRecentDocument=e=>{angular.element('.prismaview .popover').hide();const elPopover=angular.element('.prismaview .documents.popover');elPopover.show().animate({},100,function(){angular.element(this).position({of:angular.element(e.target),my:'left-15 top+15',at:'left bottom',collision:"flipfit",within:".prismaview"}).animate({"opacity":1},100)})};prismaCtrl.closePopover=function(e){angular.element(e.target).parents('.prismaview .popover').hide()};var _getPatientsFailedIndexDocumentDetails=function(response){if(!response)return;prismaCtrl.partialIndexedMessageResponse=JSON.parse(response.failedIndexDetails);prismaCtrl.hidePartialIndexingMessage=false;prismaCtrl.failedStatusMessage="PRISMA Records Failed to Index";if(undefined!==prismaCtrl.partialIndexedMessageResponse.failedIndexableRecord&&prismaCtrl.partialIndexedMessageResponse.failedIndexableRecord instanceof Array){prismaCtrl.partialIndexedMessageResponse.failedIndexableRecord.forEach(element=>{if(element.recordType===PRISMA_CONSTANT.RECORD_TYPE.CCDA){prismaCtrl.isCcdaFailedDocPresent=true}if(element.recordType===PRISMA_CONSTANT.RECORD_TYPE.FHIR){prismaCtrl.isFhirFailedDocPresent=true}if(element.recordType===PRISMA_CONSTANT.RECORD_TYPE.ADT){prismaCtrl.isAdtFailedDocPresent=true}if(element.recordType===PRISMA_CONSTANT.RECORD_TYPE.PROGRESS_NOTE){prismaCtrl.isPNFailedDocPresent=true}if(element.recordType===PRISMA_CONSTANT.RECORD_TYPE.PATIENT_DOCUMENT){prismaCtrl.isPtFailedDocPresent=true}})}};prismaCtrl.getMemberInsightsUrl=function(source){return'/mobiledoc/jsp/healowInsights/memberinsights/view/prisma-member-insights.jsp?patientId='+prismaCtrl.patientId+'&encounterId='+prismaCtrl.encounterId+'&source='+source+'&isFromExe='+prismaCtrl.isFromExe};prismaCtrl.updateCurrentTab=(currentTabName,id,tabHeading)=>{PrismaAppService.setTabData(tabHeading);prismaCtrl.currentTab=currentTabName;prismaCtrl.indextab=id;PrismaAppService.setCurrentTabName(currentTabName);makeTabActive(currentTabName);if(currentTabName==="prismatab"){$observableService.publish('clearPrismaSearchedResult');$observableService.publish('setPrismaSearchedText')}else if(currentTabName==="healowhubtab"){$observableService.publish('callHealowHub',{patientId:prismaCtrl.patientId,encounterId:prismaCtrl.encounterId,userId:prismaCtrl.userId})}else if(currentTabName==="memberinsightstab"){prismaCtrl.updateNewMIFetched()}};function makeTabActive(currentTabName){angular.element('.prismaview .prisma-modal .tabbrdrbtm .nav-tabs>li').removeClass('active');angular.element('.prismaview .prisma-modal .tabbrdrbtm .nav-tabs>li.'+currentTabName).addClass('active')}let defaultLoadCI=prismaCtrl.isCallingFrom==='LabsModal'||PrismaAppService.isContext()==='LabsModal';prismaCtrl.initClinicalInsightTab=PrismaAppService.isContext()==='LabsModal';prismaCtrl.menuItems=PrismaAppService.getMenuItems(defaultLoadCI);var initialMenu=prismaCtrl.menuItems.filter(menu=>menu.active)[0];PrismaAppService.setTabData(initialMenu.heading);PrismaAppService.setCurrentTabName(initialMenu.route);prismaCtrl.currentTab=initialMenu.route;prismaCtrl.indextab=initialMenu.id;initialMenu.active=true;pagination[prismaCtrl.menuItems[0].route]={currentPage:1,totalRecord:0};pagination[prismaCtrl.menuItems[1].route]={currentPage:1,totalRecord:0};prismaCtrl.modalOpen=false;function getMenuItem(tabName){var selectedMenu;prismaCtrl.menuItems.forEach((val,index)=>{if(val.route===tabName){selectedMenu=val}});return selectedMenu}function closeResources(){$timeout.cancel(prismaCtrl.offlineTimeout);$timeout.cancel(prismaCtrl.lastDocFetchDateTimeout);$timeout.cancel(prismaCtrl.filterTimeout);$timeout.cancel(prismaCtrl.disclaimerTimeout);$timeout.cancel(prismaCtrl.psacMessageTimeout);$timeout.cancel(prismaCtrl.clearFilterTimeout);$timeout.cancel(prismaCtrl.moveToRecordTimeOut);if(prismaCtrl.makeActiveSession){clearInterval(prismaCtrl.makeActiveSession)}$observableService.unsubscribe('switchPrismaTab');$observableService.unsubscribe('callHealowHub');$observableService.unsubscribe('onUnloadPrismaStandalone');$observableService.unsubscribe('openPrismaBundleSettings');$observableService.unsubscribe('switchRecordsTab')}function makeTabSelected(menuName){var menuObj=getMenuItem(menuName);prismaCtrl.currentTab=menuObj.route;prismaCtrl.indextab=menuObj.id;makeTabActive(prismaCtrl.currentTab)}$scope.$on("$destroy",function(event){if(prismaCtrl.isFromExe||prismaCtrl.isCallingFrom){closePrismaModal()}closeResources()});function closePrismaModal(){var rWidth=PrismaAppService.getRecordsWidth();var pWidth=PrismaAppService.getPrismaWidth();if(!prismaCtrl.isCallingFrom){$scope.modalInstance.close(false)}$observableService.publish("prismaModalClosed");PrismaAppService.notifyPrismaPopupInstance(false);_insertPrismaAuditLog(prismaCtrl.patientId,prismaCtrl.encounterId,PrismaAppService.getTabData());var width=rWidth?rWidth:pWidth;let userProfiledata={isCollapse:PrismaAppService.isAllRecordExpanded()?1:0,showprismadisclaimer:PrismaAppService.getProfileData()['showprismadisclaimer']?PrismaAppService.getProfileData()['showprismadisclaimer']:0,prisma_screen_splitter_width:angular.isUndefined(width)||isNaN(width)?0:width,prisma_tab_filter:prismaCtrl.showPrismaTabFilter===true?1:0,records_tab_filter:prismaCtrl.showRecordTabFilter===true?1:0,patientId:prismaCtrl.patientId};PrismaAppService.setProfileData(userProfiledata);PrismaAppService.setPrismaUserProfileSetting(userProfiledata,true);if(prismaCtrl.makeActiveSession){clearInterval(prismaCtrl.makeActiveSession)}PrismaAppService.reset()}prismaCtrl.openAccessLogs=function(){let params={patientId:prismaCtrl.patientId};var accessModal=$modal.open({templateUrl:'/mobiledoc/jsp/webemr/toppanel/prisma/template/prisma-access-logs-modal.html',windowClass:'prismaaccesslog pt50 bluetheme log-modal',controller:'accessLogModalInstanceCtrl',controllerAs:'logs',backdrop:'static',keyboard:false,size:'lg',resolve:{requestParam:function(){return params}}})};prismaCtrl.openSettings=function(itemId,moduleName){let params={patientId:prismaCtrl.patientId,itemId:itemId,moduleName:moduleName};$ocLazyLoad.load({name:'',files:['/mobiledoc/jsp/webemr/toppanel/prisma/js/prisma-settings-modal-controller.js','/mobiledoc/jsp/webemr/toppanel/prisma/css/prisma-settings-style.css','/mobiledoc/jsp/webemr/toppanel/prisma/js/prisma-settings-service.js','/mobiledoc/jsp/webemr/toppanel/prisma/js/prisma-bundles-tab-controller.js','/mobiledoc/jsp/webemr/toppanel/prisma/js/prisma-create-bundle-controller.js','/mobiledoc/jsp/webemr/toppanel/prisma/js/prisma-settings-tab-controller.js','/mobiledoc/jsp/ascWeb/js/angularjs/angular-ui-sortable.js','/mobiledoc/jsp/webemr/toppanel/prisma/js/prisma-reorders-tab-controller.js','/mobiledoc/jsp/webemr/toppanel/prisma/js/prisma-settings-highlights-tab-controller.js'],cache:true}).then(function(){$modal.open({templateUrl:'/mobiledoc/jsp/webemr/toppanel/prisma/template/prisma-settings-modal.html',windowClass:'bluetheme w1000 prisma-setting-modal',controller:'settingsModalInstanceCtrl',controllerAs:'settingsmodalvar',backdrop:'static',keyboard:false,size:'lg',resolve:{requestParam:function(){return params}}})})};$observableService.subscribe('openPrismaBundleSettings',function(){prismaCtrl.openSettings(2,"createBundle")});prismaCtrl.showHideFilters=function(tabName){prismaCtrl.filterTimeout=$timeout(function(){angular.element('.prismaview .summary-details .scroller .ps-scrollbar-x-rail').remove();angular.element('.prismaview  .summary-details .scroller .ps-scrollbar-y-rail').remove();var marginHeight=angular.element('.doc-list').offset().top+angular.element('.top-filter-section').height()+45;marginHeight="calc(100vh - "+marginHeight+"px) !important";angular.element('.scrollPrismaSearchDoc').css({"height":marginHeight})},500);if(tabName===PRISMA_CONSTANT.TAB.PRISMA){prismaCtrl.showPrismaTabFilter=!prismaCtrl.showPrismaTabFilter;setFilterHeight(angular.element(".pt-record-view"),prismaCtrl.showPrismaTabFilter)}else if(tabName===PRISMA_CONSTANT.TAB.RECORDS){prismaCtrl.showRecordTabFilter=!prismaCtrl.showRecordTabFilter;setFilterHeight(angular.element(".rt-record-view"),prismaCtrl.showRecordTabFilter);PrismaAppService.setRecordFilterStatus(prismaCtrl.showRecordTabFilter)}};var filterHeight=0;function setFilterHeight(element,isFilterShown){if(angular.element(".prisma-filter-div").outerHeight()>0){filterHeight=angular.element(".prisma-filter-div").outerHeight()}if(isFilterShown){PrismaAppService.changeRecordHgt(-filterHeight,element)}else{PrismaAppService.changeRecordHgt(filterHeight,element)}}prismaCtrl.openPrismaTerms=function(prismaTermsType){if(undefined!==prismaTermsType&&typeof prismaTermsType==="string"&&('TERMS_AND_CONDITIONS'===prismaTermsType||'PRIVACY_POLICY'===prismaTermsType)){let termsUrl;let title;let termsInfo;if('TERMS_AND_CONDITIONS'===prismaTermsType){termsUrl=getItemKeyValue('PrismaTermsAndConditionsUrl');title="Terms and Conditions";termsInfo="prismaTermsConditions"}else if('PRIVACY_POLICY'===prismaTermsType){termsUrl=getItemKeyValue('PrismaPrivacyPolicyUrl');title="Privacy Policy";termsInfo="prismaPrivacyPolicy"}if(undefined!==termsUrl&&typeof termsUrl==="string"&&termsUrl.length>0){if(termsUrl.startsWith("http")){let window_datetime=(new Date).getTime();window.open(termsUrl,"Prisma_terms"+window_datetime)}else{let params={termsUrl:termsUrl,title:title,termsInfo:termsInfo};$modal.open({templateUrl:'/mobiledoc/jsp/webemr/toppanel/prisma/template/prisma-terms-container.html',windowClass:'prismaTerms',controller:'termsAndPolicyCtrl',controllerAs:'termsAndPolicyCtrl',backdrop:false,size:'lg',backdropClass:'fadeBackdrop',resolve:{requestParam:function(){return params}}})}}else{ecwAlert("Invalid configuration found.")}}else{ecwAlert("Invalid request received.")}};function ccdaDocFetchCallBack(){prismaCtrl.isDocInprogress=true;prismaCtrl.isDocFailed=false;applyChanges()}prismaCtrl.retrieveFHIRDoc=function(){prismaCtrl.isDocInprogress=true;prismaCtrl.isDocFailed=false;angular.element(".prismaview .fhir-refresh").addClass('disabled');PrismaAppService.retrieveFHIRDoc(prismaCtrl.patientId).then(function(){},function(errorMsg){ecwAlert(errorMsg)})};prismaCtrl.openPrismaOfflineModal=function(){var modalContainerInstance=$modal.open({templateUrl:'prisma-offline-modal.html',windowClass:'fade modalProp prismaPopupModel ',controller:'PrismaOfflineModalController',controllerAs:'prismaOfflineCtrl',backdrop:'static',keyboard:false,size:'lg'})};prismaCtrl.loadFhirMessage=function(){angular.element('.prismaview .fhir-tolltipinfo').removeClass('hidden')};prismaCtrl.unLoadFhirMessage=function(){angular.element('.prismaview .fhir-tolltipinfo').addClass('hidden')};prismaCtrl.checkEventName=function(data,event){prismaCtrl.eventName=event;prismaCtrl.actionHubData=data};prismaCtrl.actionHubMenuList={healowInsightsPrismaModule:{cssItems:{zIndex:1051,top:0,left:0},healowInsightsPrismaScreen:getActionhubConfiguration()}};function getActionhubConfiguration(){return{headerItems:[{id:1,lookup:'hubconnect.tpl'}],firstRowItems:[{id:1,lookup:'addnotes.tpl'},{id:2,lookup:'quickaction.tpl'},{id:3,lookup:'newappointment.tpl'},{id:4,lookup:'searchappointment.tpl'}],footerItems:[{id:1,lookup:'phmhub.tpl'},{id:2,lookup:'patientprofile.tpl'}]}}});prismaAppModalModule.controller("PrismaOfflineModalController",function($scope,$modal,PrismaAppService,$modalInstance){var prismaOfflineCtrl=this;prismaOfflineCtrl.prismaPopupModelTitle="Search Server Offline";prismaOfflineCtrl.prismaPopupModelMessage=PrismaAppService.getPopupModelMessage();prismaOfflineCtrl.resetPrismaPopupModel=function(){$modalInstance.dismiss('modal')}});
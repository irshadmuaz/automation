var evaSpeechService={final_transcript:'',speechEndpoint:"",showWelcomeText:true,one_line:/\n/g,two_line:/\n\n/g,first_char:/\S/,SAMPLE_RATE:16e3,SAMPLE_SIZE:16,speechContext:null,socket:null,sourceNode:null,scriptNode:null,micStream:null,socketInitTimeout:null,currentEvaScope:null,setScope:function(getEvaScope){evaSpeechService.currentEvaScope=getEvaScope},getScope:function(){return evaSpeechService.currentEvaScope},linebreak:function(s){return s.replace(evaSpeechService.two_line,'\r\n\n').replace(evaSpeechService.one_line,'\r\n')},capitalize:function(s){return s.replace(evaSpeechService.first_char,function(m){return m.toUpperCase()})},webSpeechAndSynthesisEngineInit:function(){var languageOptions="en-US";$.ajax({url:'/mobiledoc/jsp/oda/assistant/evaConfigHandler.jsp?requestFor=getEvaKeys',type:'POST',"async":false,success:function(result){result=JSON.parse(result);languageOptions=result.language}});evaSpeechService.speechEndpoint=getDecItemkeyValueByName("SpeechEndPoint")},audioInit:function(){if(!window.AudioContext){ecwAlert("Web Audio isn't available in your browser.");return}},initWebsocket:function(audioPromise){if(evaSpeechService.speechContext==null){evaSpeechService.speechContext=new AudioContext}evaSpeechService.scriptNode=evaSpeechService.speechContext.createScriptProcessor(4096,2,2);const MAX_INT=Math.pow(2,16-1)-1;evaSpeechService.scriptNode.addEventListener('audioprocess',function(e){clearTimeout(evaSpeechService.socketInitTimeout);var evaScope=evaSpeechService.getScope();evaScope.changeInputMode('voice');var floatSamples=e.inputBuffer.getChannelData(0);evaSpeechService.socket.binaryType='blob';if(evaSpeechService.socket.readyState!==evaSpeechService.socket.CLOSED){evaSpeechService.socket.send(Int16Array.from(floatSamples.map(function(n){return n*MAX_INT})))}});function newWebsocket(){if(evaSpeechService.socket!=null&&evaSpeechService.socket.readyState===evaSpeechService.socket.OPEN){return}var websocketPromise=new Promise(function(resolve,reject){var url=evaSpeechService.speechEndpoint;evaSpeechService.socket=new WebSocket(url+"/transcribe");evaSpeechService.socket.addEventListener('open',resolve);evaSpeechService.socket.addEventListener('error',reject);evaSpeechService.socket.onerror=function(){clearTimeout(evaSpeechService.socketInitTimeout);ecwAlert("Unable to establish connection to the cloud server. Please Try Again!");audioPromise.then(function(result){evaSpeechService.micStream=result;evaSpeechService.closeWebsocket();evaSpeechService.getScope().changeInputMode('text')})}});Promise.all([audioPromise,websocketPromise]).then(function(values){let c=evaSpeechService.speechContext.createMediaStreamSource(audioPromise);let processor=evaSpeechService.speechContext.createScriptProcessor(4096,1,1);c.connect(processor);var analyser=evaSpeechService.speechContext.createAnalyser();analyser.minDecibels=-90;analyser.maxDecibels=-10;analyser.smoothingTimeConstant=.85;analyser.fftSize=256;c.connect(analyser);evaSpeechDictationService.detectSilence(evaSpeechService.speechContext,c,evaSpeechService.stopRecognizing,{},9e3,-90,analyser);evaSpeechService.micStream=values[0];evaSpeechService.socket=values[1].target;if(evaSpeechService.getScope().inputMode==='text'){evaSpeechService.closeWebsocket()}evaSpeechService.socket.addEventListener('close',function(e){if(e.reason==="SpeechUsageExceeded"){evaService.pushAssistantResponse("You have exceeded permitted speech usage provided to you. Kindly contact you administrator.")}else if(e.reason==="UnauthorizedUser"){evaService.pushAssistantResponse("You are not authorized to use eva cloud services. Please contact your administrator.")}evaSpeechService.closeWebsocket();var scope=evaSpeechService.getScope();scope.changeInputMode('text')});evaSpeechService.socket.addEventListener('error',function(e){console.error('Error from websocket',e);evaSpeechService.closeWebsocket();var scope=evaSpeechService.getScope();scope.changeInputMode('text')});function startByteStream(e){evaSpeechService.sourceNode=evaSpeechService.speechContext.createMediaStreamSource(evaSpeechService.micStream);evaSpeechService.sourceNode.connect(evaSpeechService.scriptNode);evaSpeechService.scriptNode.connect(evaSpeechService.speechContext.destination)}evaSpeechService.socket.addEventListener('message',function(e){evaSpeechService.socket.addEventListener('message',onTranscription);startByteStream(e)},{once:true});var apuId=getItemKeyValue('AutoUpgradeKey');var loggedInUserId=global.TrUserId;var loggedInUserFullName=evaglobal.userFullName;evaSpeechService.socket.send(JSON.stringify({sampleRate:evaSpeechService.speechContext.sampleRate,apuId:apuId,loggedInUserId:loggedInUserId,loggedInUserFullName:loggedInUserFullName,singleUtterance:true,authToken:eAuthToken,language:"en-US",format:"LINEAR16",module:"eva"}))})["catch"](console.log.bind(console))}function toggleWebsocket(e){var _speechContext=e.target;if(_speechContext.state==='running'){newWebsocket()}else if(_speechContext.state==='suspended'){evaSpeechService.closeWebsocket()}}function onTranscription(e){var result=JSON.parse(e.data);var textFromServer;if(result.alternatives_){textFromServer=result.alternatives_[0].transcript_;evaService.processInterimResult(textFromServer)}if(result.isFinal_){textFromServer=$.trim(textFromServer);evaService.processResult(textFromServer)}}toggleWebsocket({target:evaSpeechService.speechContext})},setUpRecording:function(){recognizing=true;if(evaSpeechService.speechContext!=null){evaSpeechService.speechContext.resume.bind(evaSpeechService.speechContext)}navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,channelCount:2,sampleRate:{ideal:evaSpeechService.SAMPLE_RATE},sampleSize:evaSpeechService.SAMPLE_SIZE}}).then(function(stream){evaSpeechService.initWebsocket(stream)})["catch"](function(err){var errMsg=evaSpeechService.getMicErrorMsg(err.code);evaService.pushAssistantResponse(errMsg)})},closeWebsocket:function(){if(evaSpeechService.speechContext!=null){evaSpeechService.speechContext.suspend.bind(evaSpeechService.speechContext)}if(evaSpeechService.scriptNode!=null){evaSpeechService.scriptNode.disconnect()}if(evaSpeechService.micStream!=null){var track=evaSpeechService.micStream.getAudioTracks();for(var i=0;i<track.length;i++){track[i].stop()}}if(evaSpeechService.sourceNode!=null){evaSpeechService.sourceNode.disconnect()}if(evaSpeechService.socket!=null&&evaSpeechService.socket.readyState===evaSpeechService.socket.OPEN){evaSpeechService.socket.close()}},startButton:function(event){evaSpeechService.final_transcript='';evaSpeechService.setUpRecording();evaSpeechService.socketInitTimeout=setTimeout(function(){var scope=evaSpeechService.getScope();if(scope.inputMode!=='text'){scope.changeInputMode('text')}},5e3)},stopRecognizing:function(reason){if(reason&&reason==='noresponse'){evaService.pushAssistantResponse("I did not get any response. Try using the text box below.")}recognizing=false;if("evaSpeechDictationService"in window&&evaSpeechDictationService.runningAnimationFrameId){cancelAnimationFrame(evaSpeechDictationService.runningAnimationFrameId)}evaSpeechService.closeWebsocket()},getMicErrorMsg:function(errCode){var errMsg="";switch(errCode){case 0:errMsg="Your browser is not authorized to access microphone. Please verify and try again.";break;case 8:errMsg="It does not seem to have a microphone connected. Please verify and try again.";break;case 9:case 18:errMsg="Speech will not work on unsecure HTTP connection. Please contact your administrator.";break;default:errMsg="You do not have a microphone connected or your browser is not authorized to access your microphone. Verify that your browser has access to your microphone and try again."}return errMsg}};evaSpeechService.webSpeechAndSynthesisEngineInit();evaSpeechService.audioInit();
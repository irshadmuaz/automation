angular.module("recordPopUpApp",['stafflookup','patientlookup','oc.lazyLoad','ecw.dir.savePrompt','ptMatchModule','p2pCommanObjsModule']).controller('recordPopupController',function($scope,$filter,$ocLazyLoad,$q,recordPopupService,p2pCommonService){$scope.recordPopupService=recordPopupService;$scope.assignedToProv={};$scope.isContentXML=false;var ptRecordInboxFnNameSpace={};ptRecordInboxFnNameSpace.enableOkButton=function(){$('#ptrecorddetailsviewinboxBtn4').removeClass('pointereventsnone')};ptRecordInboxFnNameSpace.disableOkButton=function(){$('#ptrecorddetailsviewinboxBtn4').addClass('pointereventsnone')};$scope.loadP2PEncData=function(){$scope.linkedReferralReferenceURL="";$scope.p2pEncData={};var data="";$scope.ptRecAddrStatus={val:0};data=xml2json(ptrecorddetailsviewinbox_p2pEncData);if(!angular.isUndefined(data.Envelope.Body["return"].encounter)){$scope.p2pEncData=data.Envelope.Body["return"].encounter;if($scope.p2pEncData.strContentXML){$scope.isContentXML=$scope.p2pEncData.strContentXML==="true"}}else{$scope.p2pEncData={}}if($scope.p2pEncData.message&&$scope.p2pEncData.message.trim().length==0){$('#messageArea').html("<p style='margin-left:32%;margin-top:41%;color: #666;font-weight: 700;'>This Record contains empty message.</p>")}$scope.assignedToProvider={staff:{}};$scope.assignedToProvider.staff.name=$scope.p2pEncData.assignedTo;$scope.assignedToProvider.staff.id=$scope.p2pEncData.assignedToId;$scope.assignedToProv.name=$scope.p2pEncData.assignedTo;$scope.assignedToProv.id=$scope.p2pEncData.assignedToId;var ptObj={patientId:$scope.p2pEncData.patientId,patientName:$scope.p2pEncData.name};$scope.setRecordPatientData(ptObj)};$scope.setRecordPatientData=function(ptObj){if(ptObj&&!$.isEmptyObject(ptObj)){$scope.recordPopupService.recDetailsObj.selectedPtObj=ptObj}};$scope.bReviewed=false;$scope.bUpload=false;$scope.saveData=function(){ptRecordInboxFnNameSpace.disableOkButton();if(!$scope.recordPopupService.recDetailsObj.selectedPtObj.patientId||$scope.recordPopupService.recDetailsObj.selectedPtObj.patientId==="0"){ecwAlert("Please match Patient before saving record");ptRecordInboxFnNameSpace.enableOkButton();return false}if($scope.p2pEncData.attachCount>0){if($scope.ptRecAddrStatus.val==1&&$scope.p2pEncData.encounterId==0&&$scope.recordPopupService.recDetailsObj.selectedPtObj.patientId==0){if(!$scope.p2pEncData.referral360Id){var retValue=confirm("Addressed messages/attachments cannot be moved to Patient Documents. Do you want to continue?");if(!retValue){return}ptRecordInboxFnNameSpace.enableOkButton()}}if($scope.p2pEncData.encounterId==0&&$scope.recordPopupService.recDetailsObj.selectedPtObj.patientId>0||$scope.p2pEncData.encounterId>0&&$scope.p2pEncData.ptDocs!=1){if($scope.p2pEncData.referral360Id){$scope.bUpload=true}else{var retVal=confirm("Do you want to move the associated attachment(s) to Patient Documents now ?");if(retVal==true){$scope.bUpload=true}ptRecordInboxFnNameSpace.enableOkButton()}}}if($scope.bUpload||$scope.p2pEncData.encounterId>0&&$scope.p2pEncData.ptDocs==1){if($scope.ptRecAddrStatus.val==1&&$scope.recordPopupService.recDetailsObj.selectedPtObj.patientId>0){if(!$scope.p2pEncData.referral360Id){var retVal=confirm("Do you want the associated Patient Documents to be marked reviewed as well?");if(retVal==true){$scope.bReviewed=true}ptRecordInboxFnNameSpace.enableOkButton()}}}$scope.uploadAttachments()};$scope.uploadAttachments=function(){var promise=$scope.setP2PEncounter();promise.then(function(){if($scope.bUpload){if($scope.p2pEncData.osName=="linux"){var encDateObj=new Date($scope.p2pEncData.date);var p2pEncTimestamp=encDateObj.getTime();var p2pEncDateTime=$filter('date')(p2pEncTimestamp,"yyyy-MM-dd hh:mm:ss");var scanDate=p2pEncDateTime.split(" ")[0];var params={refReqId:$scope.p2pEncData.refReqId,patientId:$scope.recordPopupService.recDetailsObj.selectedPtObj.patientId,assignedToId:$scope.p2pEncData.assignedToId,assignedTo:$scope.p2pEncData.assignedTo,date:scanDate,prioritiy:$scope.p2pEncData.priority,trType:'Patient Record',trId:$scope.p2pEncData.encounterId,scannedBy:global.TrUserName};ptRecordInboxFnNameSpace.enableOkButton();p2pCommonService.prepareP2pParams(params);p2pCommonService.uploadP2PAttachmentToFTP().success(function(result){if(result==="failed"){ecwAlert("Attachment(s) could not be uploaded to Patient Documents.");ptRecordInboxFnNameSpace.enableOkButton();return}$scope.$parent.recordFilter()}).error(function(result){ecwAlert("Attachment(s) could not be uploaded to Patient Documents.");ptRecordInboxFnNameSpace.enableOkButton()})}}})};$scope.setP2PEncounter=function(){var deferred=$q.defer();var encDate=new Date($scope.p2pEncData.date);var encTimestamp=encDate.getTime();var currentDate=$filter('date')(encTimestamp,"dd-MM-yyyy");var ptRecordStatus=$scope.ptRecAddrStatus.val;if($scope.p2pEncData.referral360Id){ptRecordStatus="1"}var params={encId:$scope.p2pEncData.encounterId,reqId:$scope.p2pEncData.reqId,patientId:$scope.recordPopupService.recDetailsObj.selectedPtObj.patientId,assignedToId:$scope.assignedToProv.id,assignedTo:$scope.assignedToProv.name,status:ptRecordStatus,reviewptdocs:$scope.bReviewed,uploadptdocs:$scope.bUpload,refReqId:$scope.p2pEncData.refReqId,scannedBy:global.TrUserName,date:currentDate,priority:$scope.p2pEncData.priority};params=$.param(params);$scope.recordPopupService.setP2PEncounter(params).success(function(data){data=xml2json(data);if(data&&!angular.isUndefined(data.Envelope.Body["return"].status)&&data.Envelope.Body["return"].status==="failed"&&data.Envelope.Body["return"].isAssignToUnautharized){ecwAlert(data.Envelope.Body["return"].errormsg);ptRecordInboxFnNameSpace.enableOkButton();deferred.reject(response);return}else if(data&&!angular.isUndefined(data.Envelope.Body["return"].errormsg)&&data.Envelope.Body["return"].errormsg==="failed"){ecwAlert("Attachment(s) could not be uploaded to Patient Documents.");ptRecordInboxFnNameSpace.enableOkButton();deferred.reject(response);return}$scope.closePtrecordDetailsViewmodal("ptrecorddetailsviewinbox");$scope.$parent.recordFilter();deferred.resolve()}).error(function(data){deferred.reject(response);$scope.showErrorMessage()});return deferred.promise};$scope.showErrorMessage=function(){ecwAlert('Patient record could not be saved due to network issue. Please try again later.');ptRecordInboxFnNameSpace.enableOkButton()};$scope.closePtrecordDetailsViewmodal=function(elementId){closeP2PModal('ptrecorddetailsviewinbox','recordPopupControllerDiv')};$scope.setAssignedToProvider=function(){$scope.assignedToProv.id=$scope.assignedToProvider.staff.id;$scope.assignedToProv.name=$scope.assignedToProvider.staff.name};$scope.loadInboxAttachments=function(nhxReqId){$("#ptRecordInboxDetailsViewAtt_refattform").attr("action","/mobiledoc/jsp/webemr/jellybean/patientrecord/referralattachmentshtml.jsp");$("#ptRecordInboxDetailsViewAtt_refattform #nhxReqId").val(nhxReqId);$("#ptRecordInboxDetailsViewAtt_refattform").submit();$("#ptRecordInboxDetailsViewAtt").modal('show')};$scope.launchPtLookup=function(){var params={isMatchPatient:true,context:'p2p',refReqId:$scope.p2pEncData.refReqId};params=$.param(params);$ocLazyLoad.load({name:'PatientSearch',files:['/mobiledoc/jsp/webemr/toppanel/patientSearch/js/patientSearch.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/patientMatchController.js','/mobiledoc/jsp/webemr/css/file-menu-p2p-patientlookup-leftpanel.css']}).then(function(){var url='/mobiledoc/jsp/webemr/toppanel/patientSearch/patientSearch.jsp?'+params;$scope.ptMatchLookupUrl=makeURL(url)},function(e){})};$scope.openPtRecordlog=function(){var strValue="";$scope.viewPtRecordlogmodal="";strValue=getItemKeyValue("inoutreferrallogs",strValue);if("yes"==strValue.toLowerCase()){$ocLazyLoad.load({name:'viewPtRecordlog',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/ptRecordLogsController.js','/mobiledoc/jsp/webemr/templates/pagination-tpl.js']}).then(function(){$scope.viewPtRecordlogmodal=makeURL("/mobiledoc/jsp/webemr/jellybean/patientrecord/getPtRecordLogs_10e.jsp?ptRecordLogType="+"PTRECORD_I"+"&referralId="+$scope.p2pEncData.refReqId+"&patientId="+$scope.recordPopupService.recDetailsObj.selectedPtObj.patientId+"&timeZone="+getTZ()+"&timeZoneName="+getTZName()+"&callFrom=web")},function(e){})}};$scope.openLinkedReferralDetailScreen=function(){$('#dvLoadingRef').show();$scope.recordPopupService.getReferralDetailFrom360Id($scope.p2pEncData.referral360Id).then(function(response){if(response.data.statusCode===1){var params={refId:response.data.result.referralPopupRequestDetail.referralId,patientId:response.data.result.referralPopupRequestDetail.patientId,ptName:$scope.recordPopupService.recDetailsObj.selectedPtObj.patientName,refEncId:response.data.result.referralPopupRequestDetail.refEncId,nNhxReqId:response.data.result.referralPopupRequestDetail.nhxReqId,recType:'REF',referralType:'Outgoing',callingFrom:'Patient_Record',referral360id:$scope.p2pEncData.referral360Id,extNHXRefTxId:response.data.result.referralPopupRequestDetail.extNhxRefTxId,nhxMsgTxId:'0'};params=$.param(params);$ocLazyLoad.load({name:'referralPopUpApp',files:['/mobiledoc/jsp/webemr/jellybean/patientrecord/commanP2PService.js','/mobiledoc/jsp/webemr/jellybean/referral/referralPopupController.js','/mobiledoc/jsp/webemr/templates/icd-tpl.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/EncDetailsService.js','/mobiledoc/jsp/webemr/templates/cpt-tpl.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/ICD_Treatment.js'],cache:true}).then(function(){$scope.linkedReferralReferenceURL=makeURL('/mobiledoc/jsp/webemr/jellybean/referral/referralPopup.jsp?'+params);$('#dvLoadingRef').hide()},function(e){console.log(e);$('#dvLoadingRef').hide()})}else{ecwAlert('Unable to load referral, please try again');$('#dvLoadingRef').hide()}},function(){ecwAlert('Unable to load referral, please try again');$('#dvLoadingRef').hide()})}}).factory('recordPopupService',function($http){return{setP2PEncounter:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/ereferralemr/setP2pEncounter.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},getReferralDetailFrom360Id:function(referral360id){return $http({method:"POST",url:makeURL("/mobiledoc/referral/referral-base/get-referral-detail-from-360-id"),data:$.param({referral360id:referral360id,referralType:'O'}),headers:{'Content-Type':'application/x-www-form-urlencoded'}})},recDetailsObj:{selectedPtObj:{patientId:'0',patientName:''}}}});function getPTDocXml(DocID,patientId,strFileName,catID,customName,ScanDate,ScannedBy,strDescription,strReview,strReviewerId,strReviewerName,strFacilityId,strPriority,lEncId,lRefId,strAttachTo,strReviewDocAndLab,strPublishToeHX,refReqId,p2pTrId,trType){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('return');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'Document',"",'xsi:type','xsd:string');addElement(xw,'PatientId',patientId,'xsi:type','xsd:int');addElement(xw,'FileName',strFileName,'xsi:type','xsd:string');addElement(xw,'catid',catID,'xsi:type','xsd:string');addElement(xw,'CustomName',customName,'xsi:type','xsd:int');addElement(xw,'PatientId',patientId,'xsi:type','xsd:int');addElement(xw,'FileName',strFileName,'xsi:type','xsd:string');addElement(xw,'catid',catID,'xsi:type','xsd:string');addElement(xw,'CustomName',customName,'xsi:type','xsd:int');addElement(xw,'ScannedDate',ScanDate,'xsi:type','xsd:int');addElement(xw,'Description',strDescription,'xsi:type','xsd:string');addElement(xw,'Review',strReview,'xsi:type','xsd:string');addElement(xw,'ReviewerId',strReviewerId,'xsi:type','xsd:int');addElement(xw,'ReviewerName',strReviewerName,'xsi:type','xsd:int');addElement(xw,'FacilityId',strFacilityId,'xsi:type','xsd:string');addElement(xw,'Priority',strPriority,'xsi:type','xsd:string');addElement(xw,'encId',lEncId,'xsi:type','xsd:int');addElement(xw,'refID',lRefId,'xsi:type','xsd:int');addElement(xw,'AttachTo',strAttachTo,'xsi:type','xsd:int');addElement(xw,'ReviewDocAndLab',strReviewDocAndLab,'xsi:type','xsd:string');addElement(xw,'PublishToeHX',strPublishToeHX,'xsi:type','xsd:string');addElement(xw,'refReqId',refReqId,'xsi:type','xsd:int');addElement(xw,'p2pTrId',p2pTrId,'xsi:type','xsd:string');addElement(xw,'trType',trType,'xsi:type','xsd:int');xw.writeEndElement();endSoapPacket(xw);return xw.flush()}
var quickSearchApp=angular.module('QuickSearchDirective',appendToDoJsDependency(['StandingOrdersDirective','providerlookup','stafflookup','oc.lazyLoad','RxHelper','ecw.service.EncDetailsService','InjectionDrugInteraction','ecw.dir.alertmessage','rtbcModule','ecw.service.refReasonValidation','ecw.patientCentricDosing','ecw.p2p.referral.refToLookupDependencyModule','ePAOrderModule','ecw.service.cptDropService']));quickSearchApp.directive('quicksearchLookup',function($rootScope,$http,$filter,$ocLazyLoad,$modal,$timeout,rxService,EncDetailsService,injectionDrugInteractionService,rtbcService,refReasonValidationService,refToLookupModuleDependencyService,$injector,ePAOrderService,cptDropService){return{restrict:'AE',scope:{topClass:"@",qsrequestObj:'=qsrequestObj',qsresponseObj:'=qsresponseObj',setqsDetails:'&'},templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/common/quickSearchDirective.jsp'),link:function(scope,element,attributes){var timer="";var isLoading=false;var filterType="";var lockObj;scope.global={wrapText:true,isCurrentDxActive:true,isPlActive:true,isPrevDxActive:true};const PRE_VISIT_PLANNING_CONTEXT="preVisitPlanningOrder";const MEASURE_MAPPING="MEASURE_MAPPING";const IMMUNIZATION_SCREEN=["Immunization",'Injection'];const QUICK_ORDER_SOURCE_FOR_PRE_VISIT_PLANNING='Quick Search';const operative_encType=1003;const intra_anesthesia=1008;var quickSearchNS={};scope.todoService;quickSearchNS.loadToDoService=function(){$ocLazyLoad.load({name:'',files:['/mobiledoc/jsp/webemr/healowPlus/todolist/shared/shared.service.js','/mobiledoc/jsp/webemr/healowPlus/todolist/components/todo-container/js/todolist.service.js'],serie:true,cache:true}).then(function(){scope.todoService=$injector.get("todoListService")})};quickSearchNS.resizeOnBaseResolution=function(){if(document.documentElement.clientWidth<1600&&scope.qsrequestObj?.sContext==='PNscreen'){scope.qsdTextBoxDivWidth=130}$('#content-separator-by-pipe').css({'display':'block'})};quickSearchNS.showDragAndFilterIcons=function(){$("#drag-icon-div-"+scope.randNum).show();$("#quick-filter-icon-div-"+scope.randNum).show()};quickSearchNS.scrollDxToTop=()=>{let dxDiv=document.getElementById("qsd-first-level-dxDiv-"+scope.randNum);if(dxDiv){dxDiv.scrollTop=0}};let watchStatusAndRoomNumber=scope.$on('resizeQuickSearch_'+scope.qsrequestObj?.sContext,()=>{quickSearchNS.resizeOnBaseResolution()});$(document).ready(()=>{let roomAndStatusInfo=$('#stickyOfficeVisitDetailsOnPN>.pnBlueBarStatusLabel').html();if(roomAndStatusInfo&&roomAndStatusInfo!==''){quickSearchNS.resizeOnBaseResolution()}function dragElement(element,direction){if(!element)return;let md;const dxDiv=document.getElementById("qsd-first-level-dxDiv-"+scope.randNum);const searchResultDiv=document.getElementById("qsd-search-result-div-"+scope.randNum);element.onmousedown=onMouseDown;function onMouseDown(e){md={e:e,offsetLeft:element.offsetLeft,offsetTop:element.offsetTop,dxDivWidth:dxDiv.offsetWidth,searchResultDivWidth:searchResultDiv.offsetWidth};document.onmousemove=onMouseMove;document.onmouseup=()=>{document.onmousemove=document.onmouseup=null}}function onMouseMove(e){let delta={x:e.clientX-md.e.clientX,y:e.clientY-md.e.clientY};delta.x=Math.min(Math.max(delta.x,-md.dxDivWidth),md.searchResultDivWidth);dxDiv.style.width=md.dxDivWidth+delta.x+"px";searchResultDiv.style.width=md.searchResultDivWidth-delta.x+"px"}}dragElement(document.getElementById("drag-icon-div-"+scope.randNum))});var qsLeftRightArrowBtnHandler=function(e){e.stopPropagation()};const qsInputCalendarClickHandler=function(e){$(this).parent().parent().find('.only-date').datepicker("show")};quickSearchNS.getQsMainMenuRight=function(){return scope.qsrequestObj?.sContext==='PNscreen'?'-35px':'-87px'};quickSearchNS.setDateAndTimeObjForQS=function(){if(!$('.only-date').hasClass('hasDatepicker')){$('.only-date').datepicker()}$(document).off('click.'+scope.topClassUniqueDivId,'.icon-inputcalender:not(".disabled")');$(document).on('click.'+scope.topClassUniqueDivId,'.icon-inputcalender:not(".disabled")',qsInputCalendarClickHandler);$(".icon-calender-sm").off('click').click(function(){$(this).parent().parent().find('input[type="text"]').datepicker("show")});$('.qs-directive').on('click','.leftRightArrowBtnDiv',qsLeftRightArrowBtnHandler)};var tooltipIteration=0;var tooltipTimeout=setInterval(function(){if(tooltipIteration>=20){clearInterval(tooltipTimeout)}var tooltipElement=$('[data-toggle="PLTooltip"]');if($(tooltipElement).length>0){$(tooltipElement).tooltip({container:'body'});clearInterval(tooltipTimeout)}tooltipIteration++},500);scope.$on('$destroy',function(){$(document).off('click.'+scope.topClassUniqueDivId,'.icon-inputcalender:not(".disabled")');$('.qs-directive').off('click','.leftRightArrowBtnDiv',qsLeftRightArrowBtnHandler);tooltipTimeout=clearTimeout(tooltipTimeout);clearTimeout(timer);if(scope.context=="PNscreen"){$('ul.rtbcEligDivQuickPN li.dropdown').off("mouseenter");$('ul.rtbcEligDivQuickPN li.dropdown').off("mouseleave")}else{$('ul.rtbcEligDivQuickOrder li.dropdown').off("mouseenter");$('ul.rtbcEligDivQuickOrder li.dropdown').off("mouseleave")}watchStatusAndRoomNumber();removeScopePropertyAndMethod(scope)});quickSearchNS.showQSDiv=function(qsTextboxId){$('.ref-div').hide();$('#first-level-qsd-actions-'+scope.randNum).hide();scope.calculateHeightForPrompt(335,318);quickSearchNS.showDragAndFilterIcons();$('.lab-data-div').show();$('.treatment-save').addClass('hide');$('.quickOrder-divMenu-filterDetail,.quickOrder-divMenu-OrderDetail').removeClass('hide');$('.future-order-box-div').removeClass('hide');if(scope.context==="ImmTherapeuticInjections"){$('.quick-menu').css({'position':'fixed','right':'auto','top':'auto','margin-top':'25px'});$('.injectionCompadiumQuickSearch').find('.input-group-addon').css({'padding':'0 4px','line-height':'0px'})}else if(scope.context===MEASURE_MAPPING){$('.quick-menu').css({'position':'fixed','right':'auto','top':'auto','margin-top':'25px'});$('.alertMappingQS').find('.input-group-addon').css({'padding':'0 4px','line-height':'0px'})}else{$('.quick-menu').css({'right':'0','top':'100%'})}$('#icon-blackreferal').removeClass('active');var sVal=jQuery('#quick-search-textBox-'+qsTextboxId).val();if(!angular.isUndefined(sVal)){if(sVal.length<2){$('.quick-menu .first-level-qsd').addClass('hide')}else quickSearchNS.setFocusOnSearchBox(qsTextboxId,0)}};quickSearchNS.hideDivBasedOnType=function(sRequestType){if(sRequestType=="filter-div"){$('.quickOrder-divMenu-filterDetail').removeClass('open')}else if(sRequestType=="order-detail-div"){$('.quickOrder-divMenu-OrderDetail').removeClass('open')}if(scope.topClass==='editLabDIProcSunohPopup'||scope.topClass==='sunohRxOrderClass'){$('#quickOrder-divMenu-sunoh-filterDetail-'+scope.randNum).removeClass('open')}};quickSearchNS.setFocusOnSearchBox=function(randNum,nSelectTxt){if(prgNoteCurrTab&&(prgNoteCurrTab=='progressNote'||prgNoteCurrTab=='scribe')){return false}var id='quick-search-textBox-'+randNum;scope.copyIdForInline=id;var element=document.getElementById(id);var idEleExists=typeof element!='undefined'&&element!=null?true:false;setTimeout(function(){if(idEleExists){element.focus()}},1);if(idEleExists){jQuery('#'+id).focus();document.getElementById(id).focus();if(nSelectTxt==1){var sValue=jQuery('#'+id).val();if(sValue.length>0){$('#'+id).select()}}}};quickSearchNS.showHideQSDirectiveDivs=function(sQSText,nRandonNum,nViewType){if(nViewType==1){$('#qsd-quick-menu-'+nRandonNum).css({'right':quickSearchNS.getQsMainMenuRight()})}if(scope.isBaseResolutionAndPNSource()){scope.calculateHeightForPrompt(335,318);$timeout(()=>{$('#qsd-first-level-div-'+nRandonNum).removeClass('hide')})}else{$('#qsd-first-level-div-'+nRandonNum).removeClass('hide')}$('#qsd-second-level-rxDiv-'+nRandonNum).addClass('hide');if(sQSText==''){$('#qsd-quick-search-main-div-'+nRandonNum).removeClass('open')}else{$('#qsd-quick-search-main-div-'+nRandonNum).addClass('open')}if(scope.context==="ImmTherapeuticInjections"&&typeof resizeVBChromiumModal==="function"){resizeVBChromiumModal(immInjCompendium_size_772,immInjCompendium_size_650)}quickSearchNS.showDragAndFilterIcons();quickSearchNS.scrollDxToTop()};quickSearchNS.getDefaultParamsForQSD=function(sRequestType){if(sRequestType=="createReferral"){var jsonObj={nSpecialityId:0,nPriority:0,nDxId:0,refToProviderDt:[],assignToProviderDt:[],referralReasonDt:quickSearchNS.splitReferralReasonsForQSD('')};jsonObj.refToProviderDt=[];jsonObj.refToProviderDt.provider=[];jsonObj.refToProviderDt.provider.Name="";jsonObj.refToProviderDt.provider.Id="0";jsonObj.assignToProviderDt=[];jsonObj.assignToProviderDt.staff=[];jsonObj.assignToProviderDt.staff.name="";jsonObj.assignToProviderDt.staff.id="0";return jsonObj}};quickSearchNS.getDefaultProviderObjForQSD=function(){var obj=[];obj.provider=[];obj.provider.Name="";obj.provider.Id="0";return obj};quickSearchNS.getDefaultStaffObjForQSD=function(){var obj=[];obj.staff=[];obj.staff.name="";obj.staff.id="0";return obj};quickSearchNS.splitReferralReasonsForQSD=function(sString){var oReasonObj=[];var k=0;if(sString!='undefined'){var sStr=sString.split("|");for(k=0;k<sStr.length;k++){var sObj={sReason:sStr[k],id:k+1};oReasonObj.push(sObj)}}while(k<4){var sObj={sReason:"",id:k+1};oReasonObj.push(sObj);k++}return oReasonObj};quickSearchNS.showToastrs=function(type,title,message){let totalNotificationCnt=document.querySelectorAll('.qs-toast-wrapper .notification-theme-success').length;totalNotificationCnt+=document.querySelectorAll('.qs-toast-wrapper .notification-theme-error').length;totalNotificationCnt+=document.querySelectorAll('.qs-toast-wrapper .notification-theme-warning').length;if(totalNotificationCnt>1){$timeout(()=>{quickSearchNS.showToastrs(type,title,message)},1e3)}else{let toastrWrapper=document.getElementsByClassName('notification-toast-wrapper');if(toastrWrapper){toastrWrapper=toastrWrapper[0]}if(!toastrWrapper){toastrWrapper=document.createElement('div');toastrWrapper.classList.add("notification-toast-wrapper","qs-toast-wrapper");document.getElementById('qsd-inplace-msg-'+scope.randNum).appendChild(toastrWrapper);if(scope.topClass=='sunohQuickOrder'){$(".qs-toast-wrapper").css('top','0')}}notification.show(type,title,message,5e3)}};quickSearchNS.showOrdStatus=function(sOrderName,sRequestType,nRandomNumber,nDisplayInPlace,lengthInPixel){if(nDisplayInPlace==1){let title=scope.context===PRE_VISIT_PLANNING_CONTEXT?'Added to ToDo List':'Ordered : ';let status="success";if(sRequestType==='prompt'){status='warning';title=''}else if(sRequestType==='failed'){status='error';title='Status :'}if(document.getElementById('qsd-inplace-msg-'+scope.randNum)){quickSearchNS.showToastrs(status,title,escapeHtml(sOrderName))}}else{if(sRequestType=='prompt'){$('#alert-msg-'+nRandomNumber).css('width','380px');$('#alert-msg-'+nRandomNumber).addClass('bg-red-color-status')}else if(sRequestType=='failed'){$('#alert-msg-'+nRandomNumber).css('width','260px');$('#alert-msg-'+nRandomNumber).addClass('bg-red-color-status');$('#order-status-type-'+nRandomNumber).text("Status : ")}else{$('#alert-msg-'+nRandomNumber).removeClass('bg-red-color-status');$('#alert-msg-'+nRandomNumber).css('width','260px');$('#order-status-type-'+nRandomNumber).text("Ordered : ")}if(_.trim(lengthInPixel)>0){$('#alert-msg-'+nRandomNumber).css('width',lengthInPixel+'px')}$('#sOrderNameInStatus-'+nRandomNumber).text(sOrderName);$('#alert-msg-'+nRandomNumber).fadeIn('slow').delay(1e3).fadeOut('slow')}var prgNoteCurrTab=""};quickSearchNS.checkForConcurrencyinQs=function(){var isClosed=false;if(lockObj.strKey!==""){if(!isLockMine2(lockObj)){isClosed=true}}return isClosed};scope.toggleDxList=type=>{if(type==='problems'&&scope.qsDxList.probListDx&&scope.qsDxList.probListDx.length>0){scope.global.isPlActive=!scope.global.isPlActive}if(type==='prev'&&scope.qsDxList.prevDx&&scope.qsDxList.prevDx.length>0){scope.global.isPrevDxActive=!scope.global.isPrevDxActive}if(type==='current'&&scope.qsDxList.prevDx&&scope.qsDxList.prevDx.length>0){scope.global.isCurrentDxActive=!scope.global.isCurrentDxActive}};scope.isBaseResolutionAndPNSource=()=>{if((scope.qsrequestObj?.sContext==='PNscreen'||scope.qsrequestObj?.sContext==='SunohQuickOrders'&&scope.topClass==='sunohQuickOrder')&&scope.isBaseResolution()){return true}return false};scope.isBaseResolution=()=>{return document.documentElement.clientHeight<=768};scope.clearSearch=()=>{scope.qsFilterObj.sQuickSearchText='';scope.qsFilterObj.nContainsSearch=scope.topClass!=="editLabDIProcSunohPopup"?0:1};scope.getNumberOfOrdersToDisplay=()=>{if(scope.isBaseResolutionAndPNSource()){return 10}return 13};quickSearchNS.closeTreatmentScreenforConcurrencyinQS=function(){if(scope.$parent.closeTreatmentScreenforConcurrency instanceof Function){scope.$parent.closeTreatmentScreenforConcurrency()}};scope.randNum=Math.floor(Math.random()*Math.pow(10,3))+"";scope.futureOrderFilter=getItemKeyValue("ShowUnreviewedFutureOrderFilter",false)=="0";scope.enableTransferVisit=getItemKeyValue("EnableTransferFromLabOrder",false).toUpperCase()!="NO";scope.hideForOSAdmin=false;if(scope.context==='frmOSAdmin'){scope.hideForOSAdmin=true}scope.topClassUniqueDivId="topClassDiv-"+scope.randNum;topClassDivIdForStOrders=scope.topClassUniqueDivId;nRandomNumForQSD=scope.randNum+"";scope.sRequestFrom="qsDirective";scope.QSDetailsReqObj=[];scope.QSDetailsReqObj={reqObj:[]};scope.showNDCWarningforNonNDCDrugDoses=false;if(getItemKeyValue("showNDCWarningforNonNDCDrugDoses").toLowerCase()=="yes"){scope.showNDCWarningforNonNDCDrugDoses=true}scope.bDispenseInventoryLinkEnabled=false;if(getItemKeyValue("EnableDispenseAndInventoryLink").toLowerCase()=="yes"){scope.bDispenseInventoryLinkEnabled=true}scope.qsrequestObj.refreshQsData=function(datObj){scope.nEncounterId=datObj.encounterId;scope.qsrequestObj.nEncounterId=datObj.encounterId;scope.loadQuickSearchData();if(scope.context=="ascOrdersScreen"){scope.qsrequestObj.orderFor=datObj.orderFor;scope.qsrequestObj.noteType=datObj.noteType;scope.qsrequestObj.nEncounterType=datObj.encType;scope.qsrequestObj.nDoctorId=scope.qsrequestObj.nTrUserId;scope.qsrequestObj.protocolType=scope.qsrequestObj.protocolType==undefined?0:scope.qsrequestObj.protocolType;scope.qsrequestObj.protocolType=datObj.orderProtocolStatus==undefined?scope.qsrequestObj.protocolType:datObj.orderProtocolStatus}else if(scope.context===PRE_VISIT_PLANNING_CONTEXT){scope.qsrequestObj.hmFlag=datObj.hmFlag;scope.qsrequestObj.ptDob=datObj.ptDob}};scope.disableQSItem=function(item){return scope.context===PRE_VISIT_PLANNING_CONTEXT&&scope.qsrequestObj.hmFlag===1&&(item.sKeyname=='labreports'||item.sKeyname=='xrays'||item.sKeyname=='procedures'||item.sKeyname==='assessments'||item.sKeyname==='orderset'||item.sKeyname==='template')};scope.isFavouriteEnable=function(item){if(scope.context!==PRE_VISIT_PLANNING_CONTEXT)return true;const categoriesHavingFavNotEnabled=['orderset','template','assessments'];if(item&&item.sKeyname&&categoriesHavingFavNotEnabled.indexOf(item.sKeyname.toLowerCase())!==-1){return false}return true};scope.getTitleForIcon=function(item){if(scope.context!==PRE_VISIT_PLANNING_CONTEXT||!item)return'';if(item.itemType==='injections')return"Injection";if(item.itemType==='immunizations')return"Immunization";let title='';switch(item.sKeyname){case'orderset':title='Order Set';break;case'template':title='Template';break;case'labreports':title='Lab';break;case'xrays':title='Diagnostic Imaging';break;case'procedures':title='Procedure';break;case'assessments':title='Assessment';break}return title};scope.getToolTip=function(item){return scope.disableQSItem(item)?"Can not Add Historical Lab/Imaging/Procedure/Assessment/Orderset/Generic Templates":item.sItemName};scope.toggleCategoryFilter=type=>{if(type==='Rx'){scope.qsFilterObj.RxOrders=scope.qsFilterObj.RxOrders==='1'?'0':'1'}if(type==='Lab'){scope.qsFilterObj.LabOrders=scope.qsFilterObj.LabOrders==='1'?'0':'1'}if(type==='DI'){scope.qsFilterObj.DIOrders=scope.qsFilterObj.DIOrders==='1'?'0':'1'}if(type==='Proc'){scope.qsFilterObj.ProcedureOrders=scope.qsFilterObj.ProcedureOrders==='1'?'0':'1'}if(type==='Imm'){scope.qsFilterObj.ImmInjOrders=scope.qsFilterObj.ImmInjOrders==='1'?'0':'1'}scope.saveQuickSearchFilters('filter-div')};scope.checkIsCompoundDrug=function(value){if(value==='true'||value===true||value==='1'||value===1){return true}return false};scope.b_DrugDbEnabled=getItemKeyValue("EnableMSClinical").toLowerCase();scope.b_enabledFormulary=false;scope.b_enabledFormulary=getItemKeyValue("isFormularyEnabled").toLowerCase()=="yes";scope.b_viewFormulary=false;scope.selectedDrugIndex=-1;if(scope.qsrequestObj===undefined||(scope.qsrequestObj.nTrUserId===undefined||scope.qsrequestObj.nTrUserId<=0)||(scope.qsrequestObj.nPatientId===undefined||scope.qsrequestObj.nPatientId<=0)||(scope.qsrequestObj.nEncounterId===undefined||scope.qsrequestObj.nEncounterId<=0)&&scope.qsrequestObj.sContext!==PRE_VISIT_PLANNING_CONTEXT){console.log("------------------------------------------------------------------------------");console.log("Error loading QS Directive in PN : TrUserId/PatientId/EncounterId are undefined or 0 ");console.log("------------------------------------------------------------------------------")}else{scope.nTrUserId=scope.qsrequestObj.nTrUserId;scope.nPatientId=scope.qsrequestObj.nPatientId;scope.nEncounterId=scope.qsrequestObj.nEncounterId;scope.nSelectedAssessmentId="0";scope.nSelectedAssessmentCode="N/A";scope.bDxExistForVisit=true;scope.qsdLeftAlign=0;scope.nShowInPlaceAlertStatus=1;scope.context="";if(scope.qsrequestObj.sContext!=undefined)scope.context=scope.qsrequestObj.sContext;if(scope.context===PRE_VISIT_PLANNING_CONTEXT){quickSearchNS.loadToDoService()}scope.QSDCustomParams={nShowDx:1,nShowFilterOpt:1,nShowCCResultsOpt:1,nShowReferralOpt:1,nShowFutuerOrdOpt:1,nCreateOrders:1,nNoOfOrdersPerView:scope.getNumberOfOrdersToDisplay(),nShowFutureOrdOpt:0};if(scope.qsrequestObj.sContext!=undefined)scope.context=scope.qsrequestObj.sContext;if(scope.context&&scope.context.toLowerCase()==="treatmentscreen"||scope.context.toLowerCase()==="pnscreen"||scope.context==="dermExecScreen"){scope.b_viewFormulary=true}scope.isRxEligibilitySuccessful=false;scope.isEpaServiceEnabled=getItemKeyValue("EnableePAService").toLowerCase()==="yes";scope.qsDxHeight=405;scope.global.createRefBtnHeight=24;if(scope.context=="PNscreen"){try{var screensize=document.documentElement.clientWidth;if(screensize<1366){scope.qsdTextBoxDivWidth=240}else if(screensize>1366&&screensize<1500){scope.qsdTextBoxDivWidth=240+(Number.parseInt(screensize)-1386)}else{scope.qsdTextBoxDivWidth=265}}catch(err){scope.qsdTextBoxDivWidth=190}scope.qsdMainMenuHeight=420;scope.qsdFirstLevelDivWidth=650;scope.qsdSearchResultDiv=370;scope.qsdReferralDiv=370;scope.qsdFutureOrdBoxDiv=375;scope.qsdFirstLevelDxDivWidth=308;scope.qsdFirstLevelDxContainerWidth=scope.isBaseResolution()?281:270;scope.qsdLeftAlignAndSmall=1;scope.global.createRefBtnHeight=25}else if(scope.context==="ImmTherapeuticInjections"){scope.qsdTextBoxDivWidth=277;scope.qsdMainMenuHeight=372;scope.qsdFirstLevelDivWidth=270;scope.qsdFirstLevelDxDivWidth=0;scope.qsdFirstLevelDxContainerWidth=0;scope.qsdSearchResultDiv=270;scope.nShowInPlaceAlertStatus=0;scope.QSDCustomParams.nShowReferralOpt=0;scope.QSDCustomParams.nShowCCResultsOpt=0;scope.QSDCustomParams.nShowFutuerOrdOpt=0;scope.QSDCustomParams.nShowDx=0}else if(scope.context===MEASURE_MAPPING){scope.qsdTextBoxDivWidth=380;scope.qsdMainMenuHeight=372;scope.qsdFirstLevelDivWidth=260;scope.qsdFirstLevelDxDivWidth=0;scope.qsdFirstLevelDxContainerWidth=0;scope.qsdSearchResultDiv=260;scope.nShowInPlaceAlertStatus=0;scope.QSDCustomParams.nShowReferralOpt=0;scope.QSDCustomParams.nShowCCResultsOpt=0;scope.QSDCustomParams.nShowFutuerOrdOpt=0;scope.QSDCustomParams.nShowDx=0;scope.QSDCustomParams.nShowFilterOpt=0}else if(scope.context=="treatmentscreen"){scope.qsdTextBoxDivWidth=260;scope.qsdMainMenuHeight=420;scope.qsdFirstLevelDivWidth=660;scope.qsdSearchResultDiv=370;scope.qsdReferralDiv=360;scope.qsdFutureOrdBoxDiv=360;scope.qsdFirstLevelDxDivWidth=308;scope.qsdFirstLevelDxContainerWidth=285;scope.nShowInPlaceAlertStatus=1;lockObj=scope.qsrequestObj.lockObj}else if(scope.context=="ascOrdersScreen"){scope.qsdTextBoxDivWidth=265;scope.qsdMainMenuHeight=420;scope.qsdFirstLevelDivWidth=652;scope.qsdFirstLevelDxDivWidth=308;scope.qsdFirstLevelDxContainerWidth=285;scope.qsdSearchResultDiv=370;scope.qsdReferralDiv=360;scope.qsdFutureOrdBoxDiv=360;scope.nShowInPlaceAlertStatus=1;scope.QSDCustomParams.nShowFutureOrdOpt=1}else if(scope.context=="dermConfiScreen"){scope.QSDCustomParams.nShowReferralOpt=0;scope.QSDCustomParams.nShowCCResultsOpt=0;scope.qsdTextBoxDivWidth=220;scope.qsdMainMenuHeight=400;scope.qsdFirstLevelDivWidth=650;scope.qsdFirstLevelDxDivWidth=308;scope.qsdFirstLevelDxContainerWidth=285;scope.qsdSearchResultDiv=356;scope.qsdReferralDiv=260;scope.qsdFutureOrdBoxDiv=260;scope.nShowInPlaceAlertStatus=0}else if(scope.context=="dermExecScreen"){scope.QSDCustomParams.nShowReferralOpt=0;scope.QSDCustomParams.nShowCCResultsOpt=0;scope.qsdTextBoxDivWidth=340;scope.qsdMainMenuHeight=420;scope.qsdFirstLevelDivWidth=592;scope.qsdFirstLevelDxDivWidth=308;scope.qsdFirstLevelDxContainerWidth=295;scope.qsdSearchResultDiv=356;scope.qsdReferralDiv=260;scope.qsdFutureOrdBoxDiv=260;scope.nShowInPlaceAlertStatus=0;scope.obsIdVsTreatmentIds=scope.qsrequestObj.obsIdVsTreatmentIds;if(scope.qsrequestObj&&scope.qsrequestObj.typeOfClient=='vb'){$timeout(function(){try{$("#qsd-quick-search-main-div-"+scope.randNum).width(scope.qsdTextBoxDivWidth);$("#qsd-first-level-div-"+scope.randNum).width(scope.qsdFirstLevelDivWidth);$("#qsd-first-level-div-"+scope.randNum).height(scope.qsdMainMenuHeight);$("#qsd-first-level-dxDiv-"+scope.randNum).width(scope.qsdFirstLevelDxDivWidth);$("#quickSearchDirective_"+scope.topClass+"_Ul1").css({"position":"absolute","left":"285px"})}catch(err){}})}}else if(scope.context==PRE_VISIT_PLANNING_CONTEXT){scope.qsdTextBoxDivWidth=255;scope.qsdMainMenuHeight=scope.qsrequestObj.context=="treatment"?375:420;scope.qsdFirstLevelDivWidth=381;scope.qsdFirstLevelDxDivWidth=276;scope.qsdFirstLevelDxContainerWidth=285;scope.qsdSearchResultDiv=341;scope.qsdReferralDiv=381;scope.qsdFutureOrdBoxDiv=301;scope.nShowInPlaceAlertStatus=1;scope.QSDCustomParams.nShowDx=0;if(IMMUNIZATION_SCREEN.indexOf(scope.qsrequestObj.callingImmOrInjItemSource)!==-1){scope.QSDCustomParams.nShowReferralOpt=0;scope.QSDCustomParams.nShowCCResultsOpt=0;scope.QSDCustomParams.nShowDx=0;scope.QSDCustomParams.nShowFilterOpt=0;scope.qsdFirstLevelDivWidth=344}scope.global.createRefBtnHeight=25}else if(scope.context=='FHIRTreatment'){scope.qsdTextBoxDivWidth=260;scope.qsdMainMenuHeight=420;scope.qsdFirstLevelDivWidth=660;scope.qsdFirstLevelDxDivWidth=308;scope.qsdFirstLevelDxContainerWidth=285;scope.qsdSearchResultDiv=370;scope.qsdReferralDiv=360;scope.qsdFutureOrdBoxDiv=360;scope.nShowInPlaceAlertStatus=1;scope.QSDCustomParams.nShowDx=1;scope.QSDCustomParams.nShowReferralOpt=0;scope.QSDCustomParams.nShowCCResultsOpt=0;scope.QSDCustomParams.nShowFilterOpt=1;scope.global.createRefBtnHeight=25}if(scope.topClass=='editLabDIProcSunohPopup'){scope.QSDCustomParams.nShowReferralOpt=0;scope.QSDCustomParams.nShowCCResultsOpt=0;scope.QSDCustomParams.nShowDx=0;scope.qsdMainMenuHeight=200;scope.qsdSearchResultDiv=400;scope.qsdFutureOrdBoxDiv=400;$timeout(function(){$(".editLabDIProcSunohPopup").find("input[id^='quick-search-textBox-']").attr("placeholder","Enter an order")})}else if(scope.topClass=='sunohRxOrderClass'){scope.QSDCustomParams.nShowReferralOpt=0;scope.QSDCustomParams.nShowCCResultsOpt=0;scope.QSDCustomParams.nShowDx=0;scope.qsdMainMenuHeight=200;scope.qsdSearchResultDiv=434;scope.qsdFirstLevelDivWidth=434;scope.qsdFutureOrdBoxDiv=400;scope.qsdTextBoxDivWidth=250}scope.$watch('qsrequestObj.nDxItemId',function(newValue,oldValue){if(newValue>=0){scope.nSelectedAssessmentId=newValue;scope.setDefaultAssessment()}});scope.$watch('qsrequestObj.sActionType',function(newValue,oldValue){if(newValue&&newValue.length>=0){if(newValue=="loadDxList"){scope.loadDxListInQSD()}}});scope.$on('loadQSDxList',function(){scope.loadDxListInQSD()});scope.dosageResultSet=[];scope.genericEquivalent=[];scope.genericPrice={};scope.drugPrice={};scope.hasFormularyCheckDone=false;scope.formularyInfo={};scope.loadFormularyInfo={};scope.m_bShowRxHubFormulary=false;scope.formulary={};scope.bOrderingRxMultipleTimes=false;scope.isContainformularyRx=false;scope.enableCorrectionalFeatures=getItemKeyValue('EnableCorrectionalFeatures').toLowerCase()=="yes";scope.enableDOCFormulary=getItemKeyValue('EnableDOCFormulary').toLowerCase()=="yes";scope.DOCFormularyDefaultClassification=getItemKeyValue('DOCFormularyDefaultClassification',true);scope.isShowFormularyFilter=function(){if(scope.b_enabledFormulary&&scope.b_viewFormulary){return true}return false};if(getItemKeyValue("OrderingRxMultipleTimes")=="yes")scope.bOrderingRxMultipleTimes=true;scope.MedispanId=getItemKeyValue("MedispanRx",true);scope.CustomRxId=getItemKeyValue("CustomRx",true);scope.MultumId=getItemKeyValue("MultumRx",true);scope.compoundRxId=getItemKeyValue("CompoundRx",true);scope.b_ShowMultumDosesFormCustom=false;var multumCustomDrug=getUserProfile("ShowMultumDosesForCustomDrugs");if(multumCustomDrug.length>0&&multumCustomDrug=="1"){scope.b_ShowMultumDosesFormCustom=true}scope.b_MedispanEnabled=getItemKeyValue("EnableMedispan").toLowerCase();scope.selectedIndex=0;scope.rxedit=false;scope.ShowMessageForPastVisitItemKey=getItemKeyValue("ShowMessageForPastVisit").toLowerCase();scope.m_bFirstRx=true;scope.m_bAllergyInteraction=true;scope.checkAllergyVerifiedFlag=true;scope.encdateAddRx="";scope.enctimeAddRx="";try{if(scope.context=="PNscreen"||scope.context=="treatmentscreen"||scope.context=="dermExecScreen"||scope.context=="ascOrdersScreen"||scope.context=="FHIRTreatment"||scope.context==='SunohQuickOrders'||scope.topClass==="editLabDIProcSunohPopup"||scope.topClass==="sunohRxOrderClass"){if(scope.nEncounterId>0){if(!EncDetailsService.getEncDetails()){EncDetailsService.fetchEncDetails(scope.nEncounterId)}}}if((scope.context=="PNscreen"||scope.context=="treatmentscreen"||scope.context=="dermExecScreen"||scope.context=="ascOrdersScreen"||scope.context=="FHIRTreatment"||scope.context==='SunohQuickOrders'||scope.topClass==="editLabDIProcSunohPopup"||scope.topClass==="sunohRxOrderClass")&&scope.nEncounterId>0){if(EncDetailsService.getEncDetails().encounterId!==scope.nEncounterId+''){EncDetailsService.fetchEncDetails(scope.nEncounterId)}if(EncDetailsService.getEncDetails&&EncDetailsService.getEncDetails().encDate){scope.encdateAddRx=EncDetailsService.getEncDetails().encDate;scope.enctimeAddRx=EncDetailsService.getEncDetails().encTime;scope.encfacilityId=EncDetailsService.getEncDetails().facilityId}}}catch(e){}if(scope.context==="ImmTherapeuticInjections"||scope.context===MEASURE_MAPPING){if(!scope.encfacilityId){scope.encfacilityId=""}}scope.RxSearchType=[];scope.RxDefaultSearchTypeId=0;scope.RxDefaultDosesTypeId=2;scope.selectedRxName="";scope.selectedRxItemId="";scope.selectedRxDrugNameId="";scope.selectedRxObject={};try{scope.showObsoleteMessage=false;scope.showDiscontinuedDrugs=0;scope.showDiscontinuedDrugs=getUserProfile("ShowDiscontinuedDrugs",global.TrUserId);if(scope.showDiscontinuedDrugs===1||scope.showDiscontinuedDrugs==="1")scope.showDiscontinuedDrugs=-1;else scope.showDiscontinuedDrugs=0}catch(e){}scope.getRxFormulary=function(drugNameID,itemID){if(scope.nEncounterId>0){var url='/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/getRxFormulary.jsp?encid='+scope.nEncounterId;var promise=$http.post(makeURL(url));promise.success(function(data){scope.hasFormularyCheckDone=true;scope.formularyInfo=data.formulary;if(typeof scope.formularyInfo=="object"){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.loadFormularyInfo);if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].status=="success"){scope.loadFormularyInfo=jsonobj.Envelope.Body['return']}else{scope.loadFormularyInfo.message="No Formulary Found for patient"}}}})}};scope.patientVitalData={};scope.loadPatientVitals=function(encounterId,patientId,loadQuickSearchResult){var reqObj={"encounterId":encounterId,"patientId":patientId};let promise=$http.post(makeURL("/mobiledoc/emr/patientvital/getpatientheightandweight"),reqObj,{headers:{"Content-Type":"application/json"}});promise.success(function(data){scope.patientVitalData=data;if(loadQuickSearchResult){scope.getQuickOrderSearchResults()}})};scope.qsCommonJSONObj=[];scope.qsFilterObj=[];scope.qsDxList=[];scope.qsOrdersList=[];scope.displayTodaysOrderDate=$filter('date')(new Date,'MM/dd/yyyy');scope.referralMandatoryFields={};scope.oCreateRefObj=quickSearchNS.getDefaultParamsForQSD('createReferral');scope.RefToProviderNameData=quickSearchNS.getDefaultProviderObjForQSD();scope.RefAssingToNameData=quickSearchNS.getDefaultStaffObjForQSD();scope.providerForCCResultsTo={provider:{},providerList:[]};if(scope.context==="PNscreen"||scope.context==="treatmentscreen"){scope.isRtbcServiceEnabled=getItemKeyValue("EnableRtbcService").toLowerCase()==="yes";if(getUserProfile("RtbcSettings")==='1'){scope.showRtbcPopup=true}else{scope.showRtbcPopup=false}scope.rtbcEligibilityFlag=false;if(scope.isRtbcServiceEnabled){$http({method:"POST",url:"/mobiledoc/emr/rtbc/getRtbcResponse",cache:false,params:{PatientId:scope.nPatientId,EncounterId:scope.nEncounterId,Task:'getRtbcEligibility'}}).success(function(response){if(response){if(response.status){if(response.status==='success'){scope.rtbcEligibilityFlag=true;if(response.RtbcVendorName){scope.rtbcVendorName=response.RtbcVendorName}}if(response.RtbcResponse){scope.rtbcEligibilityErrMsg=response.RtbcResponse}}}});$(function(){if(scope.context=="PNscreen"){$('ul.rtbcEligDivQuickPN li.dropdown').on("mouseenter",function(){$(this).parent('.dropdown').toggleClass('open');$(this).find('.dropdown-menu').stop(true,true).delay(200).fadeIn(500)}).on("mouseleave",function(){$(this).find('.dropdown-menu').stop(true,true).delay(200).fadeOut(500)})}else{$('ul.rtbcEligDivQuickOrder li.dropdown').on("mouseenter",function(){$(this).parent('.dropdown').toggleClass('open');$(this).find('.dropdown-menu').stop(true,true).delay(200).fadeIn(500)}).on("mouseleave",function(){$(this).find('.dropdown-menu').stop(true,true).delay(200).fadeOut(500)})}})}}scope.nCheckHideOfTopAndBottomArrows=0;scope.searchOrdersList=[];scope.stOrderDtObj=[];scope.sOrderDtForStandingOrd=[];scope.RxListType=[];scope.diCPTItems=[];scope.isPAMAActionRequired=false;scope.selectedOrderItemKeyName="";scope.rxDrugSearchTypeList=[{name:'Drug & Route',value:'1',title:'Drug & Route'},{name:'Drug Product Description',value:'2',title:'Drug Name, Strength, Route and Formulation'}];var rxDrugSearchTypeIdWiseMap=[];var rxDrugSearchType;for(var index=0;index<scope.rxDrugSearchTypeList.length;index++){rxDrugSearchType=scope.rxDrugSearchTypeList[index];rxDrugSearchTypeIdWiseMap[rxDrugSearchType.value]=rxDrugSearchType}scope.disableDrugSearch=function(){var medispanRxId=getItemKeyValue("MedispanRx",true);if(scope.qsFilterObj.RxDefaultListTypeId==="0"||scope.qsFilterObj.RxDefaultListTypeId===0||scope.qsFilterObj.RxDefaultListTypeId===medispanRxId){return false}return true};scope.rxDrugSearchTypeChange=function(){if(scope.disableDrugSearch()){scope.qsFilterObj.RxDrugSearchTypeTitle="Select MedispanRx or All Rx from Rx Type";return true}var rxDrugSearchType=rxDrugSearchTypeIdWiseMap[scope.qsFilterObj.RxDrugSearchType];if(rxDrugSearchType){scope.qsFilterObj.RxDrugSearchTypeTitle=rxDrugSearchType.title;return true}return false};scope.setDefaultDrugSearchType=function(newDrugDbLookup){var drugDBLookUp=getUserProfile("DefaultDrugDBLookUp");var medispanRxId=getItemKeyValue("MedispanRx",true);if(drugDBLookUp!=="0"&&drugDBLookUp!==0&&drugDBLookUp!==medispanRxId&&(newDrugDbLookup==="0"||newDrugDbLookup===0||newDrugDbLookup===medispanRxId)){scope.qsFilterObj.RxDrugSearchType='1'}};scope.loadQuickSearchData=function(){if(scope.bDispenseInventoryLinkEnabled){scope.qsrequestObj.facilityId=scope.encfacilityId}if(scope.topClass==="editLabDIProcSunohPopup"){scope.qsrequestObj.nContainsSearch=1}var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp";var loadQuickSearchFormData={'QuickSearchFilterObj':JSON.stringify(scope.qsrequestObj),'sRequestFrom':'qsDirective','sRequestType':'loadQuickSearchData'};var quickSearchHttpConfig={headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}};var responsePromise=$http.post(makeURL(strUrl),$.param(loadQuickSearchFormData),quickSearchHttpConfig);responsePromise.success(function(data,status,headers,config){scope.qsCommonJSONObj=data;if(scope.qsCommonJSONObj.referralMandFields){scope.referralMandatoryFields=scope.qsCommonJSONObj.referralMandFields}scope.qsFilterObj=scope.qsCommonJSONObj.QSFilterData;scope.global.wrapText=scope.context==='dermExecScreen'?true:scope.qsFilterObj.wrapText;if(typeof getUserProfile("DefaultDrugDBLookUp")==='undefined'){scope.qsFilterObj.RxDefaultListTypeId=0}else{scope.qsFilterObj.RxDefaultListTypeId=getUserProfile("DefaultDrugDBLookUp")}if(scope.showDiscontinuedDrugs===-1){scope.qsFilterObj.ShowDiscontinuedDrugs="1"}else{scope.qsFilterObj.ShowDiscontinuedDrugs="0"}scope.qsDxList=scope.qsCommonJSONObj.DxList;if(scope.qsDxList.probListDx){scope.qsDxList.probListDx=scope.qsDxList.probListDx.filter(function(problemListItem){return!(problemListItem.wustatus&&("erroneous dx"===problemListItem.wustatus.toLowerCase()||"w/u negative"===problemListItem.wustatus.toLowerCase()))})}scope.setDefaultsForQSDirective();scope.qsFilterObj.SelectedLabCompanyId=scope.qsCommonJSONObj.SelectedLabCompanyId?scope.qsCommonJSONObj.SelectedLabCompanyId+"":"0";scope.qsFilterObj.SelectedDICompanyId=scope.qsCommonJSONObj.SelectedDICompanyId?scope.qsCommonJSONObj.SelectedDICompanyId+"":"0";scope.qsFilterObj.nContainsSearch=scope.topClass!=="editLabDIProcSunohPopup"?0:1;scope.qsFilterObj.SelectedLabCompanyId=scope.qsFilterObj.SelectedLabCompanyId.toString();scope.qsFilterObj.SelectedDICompanyId=scope.qsFilterObj.SelectedDICompanyId.toString();scope.qsFilterObj.RxDefaultListTypeId=scope.qsFilterObj.RxDefaultListTypeId.toString();if(scope.qsCommonJSONObj.isPAMAActionRequired){scope.isPAMAActionRequired=true;scope.diCPTItems=JSON.parse(scope.qsCommonJSONObj.diCPTItems).response}scope.rxDrugSearchTypeChange();if(scope.topClass==="sunohRxOrderClass"){scope.setTextBoxFromSunohAddRx()}})};scope.switchTab=function(){prgNoteCurrTab=scope.$parent.tabAction;if(prgNoteCurrTab&&(prgNoteCurrTab=='progressNote'||prgNoteCurrTab=='scribe')){scope.$parent.changeTab('Orders')}};scope.setDefaultsForQSDirective=function(){prgNoteCurrTab=scope.$parent.tabAction;scope.setAssignToDefaultForReferral();scope.setDefaultAssessment();quickSearchNS.showQSDiv(scope.randNum);quickSearchNS.setFocusOnSearchBox(scope.randNum,0);quickSearchNS.setDateAndTimeObjForQS();if(scope.qsdLeftAlignAndSmall==1){$('#qsd-quick-menu-'+scope.randNum).css({'right':quickSearchNS.getQsMainMenuRight()})}};if(scope.topClass!=="sunohRxOrderClass"){scope.loadQuickSearchData()}scope.setDataInParentScreen=function(sRequestType,oRequestObj){try{if(typeof scope.qsresponseObj!='undefined'&&typeof scope.qsresponseObj.obj!='undefined'){scope.qsresponseObj.obj.sRequestType=sRequestType;scope.qsresponseObj.obj=oRequestObj;if(scope.selectedOrderItemKeyName){scope.qsresponseObj.obj.selectedOrderItemKeyName=scope.selectedOrderItemKeyName;if(scope.selectedOrderItemKeyName.toLowerCase()==='cptcodes'){scope.qsresponseObj.obj.selectedOrderItemType=oRequestObj.itemType}}}if(scope.context!=='FHIRTreatment'){scope.setqsDetails()}}catch(e){console.log(e)}};scope.$on('saveAssessmentFromEPA',function(e,Obj){scope.setDataInParentScreen('neworder',Obj);return});scope.loadSupplementPopUp=function(){var url="/mobiledoc/emr/assessment.ecw/icdSupplementPopUpView?itemid="+scope.nSelectedAssessmentId+"&patientid="+scope.nPatientId+"&name="+encodeURIComponent(scope.nSelectedAssessmentCode+" "+scope.nSelectedAssessmentName);$ocLazyLoad.load({name:"icdsupplementdata",files:['/mobiledoc/jsp/webemr/progressnotes/assessment/icdsupplementdetails.js']}).then(function(){url=makeURL(url);if($('#assessment-instancepopup').length>0){$('#assessment-instancepopup').remove()}scope.supplementDataPopUp=url},function(e){})};scope.processAfterICDSupplementData=function(modalInstanceResponse){scope.oItemData.specify=modalInstanceResponse.specify;scope.oItemData.notes=modalInstanceResponse.notes;scope.oItemData.OnsetDate=modalInstanceResponse.OnsetDate;scope.oItemData.risk=modalInstanceResponse.risk;scope.oItemData.hasSupplementDetails=true;if(scope.oItemData.sKeyname.toLowerCase()==='rx'||scope.oItemData.sKeyname.toLowerCase()==='rxmedispan'){scope.saveRxFromQuickSearch()}else{scope.saveLabsDIProcImmInjOrders(scope.oItemData)}$timeout(function(){if(scope.isFromFvrtDiv){$('.favDrop-'+scope.randNum).addClass('open');scope.isFromFvrtDiv=false}else{$('#qsd-quick-menu-'+scope.randNum).css({'right':quickSearchNS.getQsMainMenuRight()});$('#qsd-quick-search-main-div-'+scope.randNum).addClass('open');$('#qsd-first-level-div-'+scope.randNum).removeClass('hide');$('#quick-search-textBox-'+scope.randNum).val(scope.qsFilterObj.sQuickSearchText)}},350)};quickSearchNS.checkForAsmtInPrevDxList=function(selectedAsmtId){var index=-1;if(typeof scope.qsDxList.prevDx!=='undefined'&&scope.qsDxList.prevDx.length>0){for(var i=0;i<scope.qsDxList.prevDx.length;i++){if(selectedAsmtId!=='undefined'&&scope.qsDxList.prevDx[i].itemId!=='undefined'&&String(scope.qsDxList.prevDx[i].itemId)===String(selectedAsmtId)){index=i;break}}return index}};scope.isMSClinicalDoseWindow=false;scope.qsDirectiveRowClickHanlder=function(oItem,event){if(checkIsValidForAllergyVerification(oItem.sKeyname,event)&&scope.checkAllergyVerifiedFlag){scope.checkAllergyVerified(scope.nEncounterId,oItem,event);return}if(scope.topClass==="editLabDIProcSunohPopup"){if(scope.qsFilterObj.sIsFuture==='1'){oItem.sFutureDate=scope.qsFilterObj.sFutureDate}oItem.spokenText=scope.qsrequestObj.spokenText;$rootScope.$broadcast('appendSunohItemSuggession',oItem);scope.hideAllQucikSearchDDiv();return}scope.isMSClinicalDoseWindow=false;if(scope.context==="ImmTherapeuticInjections"&&typeof resizeVBChromiumModal==="function"){resizeVBChromiumModal(immInjCompendium_size_1180,immInjCompendium_size_650)}if(scope.context==="ascOrdersScreen"&&scope.qsrequestObj.noteType===3&&(oItem.sKeyname==='rx'||oItem.sKeyname==='rxmedispan'||oItem.sKeyname==='activity'||oItem.sKeyname==='diet'||oItem.sKeyname==='nursing')){ecwAlert("Order Status: User will not be able to place Activity, Diet, Nursing and Medication Orders for Discharge Order Type!");return false}if(scope.futureOrd.nShowFutureOrdItemsOpt==0){return}if(scope.context=="ascOrdersScreen"){if(event){oItem.elementId=event.currentTarget.id}}if(scope.context=="treatmentscreen"){if(quickSearchNS.checkForConcurrencyinQs()){quickSearchNS.closeTreatmentScreenforConcurrencyinQS();return}}if(scope.disableQSItem(oItem)){return}if(scope.context.toLowerCase()==="pnscreen"||scope.context.toLowerCase()==="treatmentscreen"||scope.context==="dermExecScreen"){scope.selectedOrderItemKeyName=oItem.sKeyname}if(scope.context=="dermExecScreen"){try{if(Object.keys(scope.obsIdVsTreatmentIds).length==0){quickSearchNS.showOrdStatus("Please select at least one observation for quick order.",'failed',scope.randNum,scope.nShowInPlaceAlertStatus);return}}catch(err){}if(!scope.$parent.isLockMine()){return}oItem.selectedAssessmentId=scope.nSelectedAssessmentId;oItem.selectedAssessmentCode=scope.nSelectedAssessmentCode;scope.$parent.setQSResult(oItem)}if((scope.context.toLocaleLowerCase()==="pnscreen"||scope.context.toLocaleLowerCase()==="treatmentscreen")&&_.trim(oItem.itemType).toLocaleLowerCase()==='immunizations'&&_.trim(oItem.cvxActive).toUpperCase()!="ACTIVE"&&_.trim(oItem.ppdStatus)!=='1'){quickSearchNS.showOrdStatus("Immunization with inactive CVX cannot be ordered.",'failed',scope.randNum,scope.nShowInPlaceAlertStatus,360);return}var sId;var currentTargetId;quick_search_callFrom="";if(event){sId=event.target.id;if(event.currentTarget&&event.currentTarget.id){currentTargetId=event.currentTarget.id}else{currentTargetId=""}}else{sId="";currentTargetId=""}if(typeof currentTargetId!='undefined'&&currentTargetId!=""){if(currentTargetId.indexOf('qsd-fav')!=-1){quick_search_callFrom="Fav-dropDown"}}if(scope.context=="dermConfiScreen"){if(sId.indexOf('favIcon')!=-1){scope.updateFavoriteStatusForItem(oItem)}else{scope.$parent.setQSResult(oItem)}return}if(typeof sId!='undefined'){if(sId.indexOf('favIcon')!=-1)scope.updateFavoriteStatusForItem(oItem);else if(sId.indexOf('qsd-futureOrder')!=-1)scope.setStOrdersFromQSDirective(oItem);else{scope.orderTest(oItem);if(typeof isFromFvrtDiv!=='undefined'){scope.isFromFvrtDiv=isFromFvrtDiv}}}};scope.doseListRequest={'itemId':0};scope.doseListRequest.encounterId=scope.nEncounterId;scope.doseListRequest.patientId=scope.nPatientId;scope.drugDbDoseList=false;function generateRefreshId(existingRefreshId){var refreshId=existingRefreshId;while(refreshId===existingRefreshId){refreshId=Math.random()}return refreshId}scope.setDoseListRequest=function(orderItem){scope.isMSClinicalDoseWindow=true;scope.doseListRequest.doseRefreshId=generateRefreshId(scope.doseListRequest.doseRefreshId);if(orderItem.nDxId){scope.doseListRequest.dxId=orderItem.nDxId}else{scope.doseListRequest.dxId='0'}scope.doseListRequest.itemId=orderItem.nItemId;scope.doseListRequest.drugNameId=orderItem.sDrugNameId;scope.doseListRequest.routedDrugId=orderItem.routedDrugId;scope.doseListRequest.dispensableDrugId=orderItem.dispensableDrugId;scope.doseListRequest.parentId=orderItem.nParentID;scope.doseListRequest.rxType=scope.RxDefaultDosesTypeId;scope.doseListRequest.encounterId=scope.nEncounterId;scope.doseListRequest.patientId=scope.nPatientId;if(!angular.isUndefined(scope.formularyInfo.FormularyID)&&scope.formularyInfo.FormularyID!=""&&scope.formularyInfo.FormularySourceCode!==""){scope.doseListRequest.isformularyDoses=true;scope.doseListRequest.b_viewFormulary=scope.b_viewFormulary;scope.doseListRequest.coverageId=scope.formularyInfo.CoverageId;scope.doseListRequest.formularyID=scope.formularyInfo.FormularyID;scope.doseListRequest.formularySourceCode=scope.formularyInfo.FormularySourceCode;scope.doseListRequest.NLRxBrand_FS=scope.loadFormularyInfo.NLRxBrand_FS;scope.doseListRequest.NLRxGenericOTC_FS=scope.loadFormularyInfo.NLRxGenericOTC_FS;scope.doseListRequest.NLRxGeneric_FS=scope.loadFormularyInfo.NLRxGeneric_FS}else{scope.doseListRequest.isformularyDoses=false}scope.doseListRequest.nIsFormularyFilter=scope.qsFilterObj.nIsFormularyFilter;scope.doseListRequest.showObsoleteDrugs=scope.showDiscontinuedDrugs===-1;scope.doseListRequest.showNoPackDrugs=false;if(orderItem.sName){scope.doseListRequest.itemName=orderItem.sName}else{scope.doseListRequest.itemName=scope.selectedRxName}if(scope.encfacilityId){scope.doseListRequest.facilityId=scope.encfacilityId}else{scope.doseListRequest.facilityId=0}if(scope.isRtbcServiceEnabled){scope.isMedMulEquiDrug=rtbcService.checkMedispanMultumEquipmentSupply(orderItem.nParentID)}scope.doseListRequest.isRtbcServiceEnabled=scope.isRtbcServiceEnabled;scope.doseListRequest.isMedMulEquiDrug=scope.isMedMulEquiDrug;scope.doseListRequest.rtbcEligibilityFlag=scope.rtbcEligibilityFlag;scope.doseListRequest.rtbcEligibilityErrMsg=scope.rtbcEligibilityErrMsg};scope.drugDbCallback=function(){scope.setDosageCalcCombos();scope.showHideLevel2Div('show');scope.hideLoadingImage()};scope.selectDoseCallback=function(obj){scope.dosageResultSet[0]=obj;if(obj.hasOwnProperty("isRtbcButtonClicked"))scope.isRtbcButtonClicked=obj.isRtbcButtonClicked;scope.selectedRxName=obj.drugName;scope.selectedRxItemId=obj.ItemId;scope.selectedRxObject.nItemId=obj.ItemId;scope.nSelectedAssessmentId=obj.assessId;addAndSelectDxInArray(obj.assessmentDetails);if(scope.context==="ImmTherapeuticInjections"){scope.setInjectionMedicationMapping(0);return}scope.isRtbcPopupOpened=false;scope.selectDosage(0)};scope.selectEpaCallback=function(obj){scope.dosageResultSet[0]=obj;scope.selectedRxName=obj.drugName;scope.selectedRxItemId=obj.ItemId;scope.selectedRxObject.nItemId=obj.ItemId;scope.nSelectedAssessmentId=obj.assessId;addAndSelectDxInArray(obj.assessmentDetails);scope.ePAClicked(0)};scope.isValidForMSClinical=function(nParentID){if(scope.b_DrugDbEnabled==='yes'&&(nParentID===parseInt(scope.MedispanId,10)||nParentID===parseInt(scope.CustomRxId,10)))return true;return false};scope.updateStyleForRx=function(){if(scope.context=="PNscreen"){let right=document.getElementsByClassName('emr-wrap')[0].getBoundingClientRect().right-1050;$('.msclinical-dose-list-'+scope.topClassUniqueDivId).css({'position':'fixed','left':right+'px'});if(scope.isBaseResolutionAndPNSource()){$('.recommended-dosing-main-div-'+scope.topClassUniqueDivId).css({'height':'265px'});$('#drugDbFavoritesContent'+scope.topClassUniqueDivId).css({'height':'265px'});$('#drugDbEmarRxContent'+scope.topClassUniqueDivId).css({'height':'265px'});$('.diagnosis-table-vertical-scroll-'+scope.topClassUniqueDivId).css({'height':'265px'})}}else{$('.msclinical-dose-list-'+scope.topClassUniqueDivId).css({'left':'-95px'})}};scope.orderTest=function(orderItem){scope.bDxExistForVisit=quickSearchNS.checkIfDxExistForCurVisit(scope.nSelectedAssessmentId);quickSearchNS.setFocusOnSearchBox(scope.randNum,1);orderItem.nEncounterId=scope.nEncounterId;orderItem.nPatientId=scope.nPatientId;orderItem.nTrUserId=scope.nTrUserId;orderItem.nDxId=scope.nSelectedAssessmentId;orderItem.sDxCode=scope.nSelectedAssessmentCode;scope.selectedRxName=orderItem.sItemName;scope.selectedRxItemId=orderItem.nItemId;scope.genericEquivalent=[];scope.isRxEligibilitySuccessful=false;if(scope.context===MEASURE_MAPPING){scope.qsresponseObj.obj=orderItem;$rootScope.$broadcast("setMeasureMapping",orderItem);scope.hideAllQucikSearchDDiv();return}if(scope.context=="ascOrdersScreen"){orderItem.loginUserType=global.loginUserType;orderItem.orderingProvider=scope.qsrequestObj.orderFor;orderItem.orderNoteType=scope.qsrequestObj.noteType;if(!angular.isUndefined(scope.qsrequestObj.protocolType))orderItem.orderProtocolType=scope.qsrequestObj.protocolType}if(scope.context===PRE_VISIT_PLANNING_CONTEXT&&scope.qsrequestObj.hmFlag==1&&(_.trim(orderItem.itemType).toLocaleLowerCase()==='immunizations'||_.trim(orderItem.itemType).toLocaleLowerCase()==='injections')){orderItem.sIsFuture=scope.qsFilterObj.sIsFuture;orderItem.sFutureDate=scope.qsFilterObj.sFutureDate;orderItem.ptDob=scope.qsrequestObj.ptDob;openHmDialog(orderItem);return}if(scope.context=="PNscreen"||scope.context=="treatmentscreen"||scope.context=="ascOrdersScreen"||scope.context==="dermExecScreen"||scope.context=="FHIRTreatment"||scope.context==='SunohQuickOrders'||scope.topClass==="editLabDIProcSunohPopup"||scope.topClass==="sunohRxOrderClass"){if(scope.nEncounterId>0){scope.getRxandDx(scope.nEncounterId,scope.nPatientId,0,global.TrUserId)}}if(orderItem.sKeyname.toLowerCase()=='rx'||orderItem.sKeyname.toLowerCase()=='rxmedispan'){scope.oItemData=orderItem;scope.selectedRxObject=angular.copy(orderItem);scope.dosageResultSet=[];if(scope.isValidForMSClinical(orderItem.nParentID)){scope.setDoseListRequest(orderItem);scope.showHideLevel2Div('show');return}var sSynonymId="";if(scope.b_MedispanEnabled=="no"){sSynonymId=orderItem.sSupplierId}else{sSynonymId=orderItem.sDrugNameId}scope.selectedRxDrugNameId=sSynonymId;if(typeof scope.formularyInfo.FormularyID!="undefined"&&scope.formularyInfo.FormularyID!=""){if(sSynonymId>0&&scope.formularyInfo.FormularySourceCode!=""){scope.loadFormularyRxDoses(sSynonymId,orderItem.nItemId,scope.RxDefaultDosesTypeId)}else{scope.getDosage(orderItem.sDrugNameId,orderItem.nItemId,scope.RxDefaultDosesTypeId)}}else{scope.getDosage(orderItem.sDrugNameId,orderItem.nItemId,scope.RxDefaultDosesTypeId)}var url='/mobiledoc/jsp/ecwrx/getGenericdrugs.jsp?dnid='+sSynonymId;if(scope.bDispenseInventoryLinkEnabled){url=url+"&facilityID="+scope.encfacilityId}var promise=$http.post(makeURL(url));promise.success(function(data){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('AlternateDrugs')){if(jsonobj.Envelope.Body['return'].AlternateDrugs.length>0){scope.genericEquivalent=jsonobj.Envelope.Body['return'].AlternateDrugs}else{scope.genericEquivalent.push(jsonobj.Envelope.Body['return'].AlternateDrugs)}}if(scope.genericEquivalent[0].drugName.length>0){}}})}else if(orderItem.sKeyname=='labreports'||orderItem.sKeyname=='xrays'||orderItem.sKeyname=='procedures'){orderItem.sIsFuture=scope.qsFilterObj.sIsFuture;scope.qsFilterObj.sFutureDate=angular.isUndefined(scope.qsFilterObj.sFutureDate)||scope.qsFilterObj.sFutureDate.length==0?$filter('date')(new Date,'MM/dd/yyyy'):scope.qsFilterObj.sFutureDate;if(orderItem.sIsFuture==='1'&&!isDateAndTimeValid(scope.qsFilterObj.sFutureDate)){ecwAlert("There is an invalid input for Future Order Date. A valid format is 'MM/DD/YYYY'.");return false}orderItem.sFutureDate=scope.qsFilterObj.sFutureDate;orderItem.nBillToPhyForFutureOrder=scope.qsFilterObj.sBillToPhyForFutureOrders;var nLabConfigAssmtMandatory=scope.qsCommonJSONObj.itemKeysForQSDirective.nIsLabConfigAssmtMandatory;if((scope.isPAMAActionRequired&&orderItem.sKeyname==='xrays'||nLabConfigAssmtMandatory=="1"&&scope.context!==PRE_VISIT_PLANNING_CONTEXT)&&scope.nSelectedAssessmentId==0){if(scope.context=="treatmentscreen"){quickSearchNS.showOrdStatus("Order must be associated with assessment(s) while ordering.",'prompt',scope.randNum,1)}else{quickSearchNS.showOrdStatus("Order must be associated with assessment(s) while ordering.",'prompt',scope.randNum,scope.nShowInPlaceAlertStatus)}return false}var ccLabDIResultsToProviderIds="";var ccLabDIResultsToProviderNames="";angular.forEach(scope.providerForCCResultsTo.providerList,function(Obj,val){ccLabDIResultsToProviderIds+=Obj.Id+";";ccLabDIResultsToProviderNames+=Obj.Name+";"});if(ccLabDIResultsToProviderIds!=""&&ccLabDIResultsToProviderNames!=""){ccLabDIResultsToProviderIds=ccLabDIResultsToProviderIds.substring(0,ccLabDIResultsToProviderIds.length-1);ccLabDIResultsToProviderNames=ccLabDIResultsToProviderNames.substring(0,ccLabDIResultsToProviderNames.length-1)}orderItem.ccLabDIResultsToProviderId=ccLabDIResultsToProviderIds;orderItem.ccLabDIResultsToProviderNames=ccLabDIResultsToProviderNames;if(scope.context=="ascOrdersScreen"){$http.post(makeURL("/mobiledoc/ascWeb/ASC/PnIpOrders.go/Orders/loadASCOrders?sRequestFrom="+scope.context+"&sRequestType=checkIfOrderExists&actionType=processQuickSearchOrder&orderDetailsObject="+encodeURIComponent(JSON.stringify(orderItem)))).success(function(data,status,headers,config){if(data.bLabDIProcExists==true){if(scope.context==="ascOrdersScreen"&&scope.qsrequestObj.noteType===3){showMessage("Order already exists,You cannot place future order for Discharge Note.");return false}quickSearchNS.showOrdStatus("Order already exists.",'failed',scope.randNum,scope.nShowInPlaceAlertStatus);if(typeof scope.$parent.handlemultipleOrders=='function'){scope.$parent.handlemultipleOrders(orderItem,scope.ascOrderValidationCallback)}return}else{scope.saveLabsDIProcImmInjOrdWithSupplData(orderItem)}})}else{scope.saveLabsDIProcImmInjOrdWithSupplData(orderItem)}}else if(orderItem.sKeyname=='cptcodes'){if(scope.context===PRE_VISIT_PLANNING_CONTEXT){orderItem.sIsFuture=scope.qsFilterObj.sIsFuture;orderItem.sFutureDate=scope.qsFilterObj.sFutureDate;return quickSearchNS.savePreplanningOrders(orderItem)}if(orderItem.itemType==='injections'){injectionDrugInteractionService.checkAllergyInteraction(orderItem.medicationItemId,orderItem.medicationNDC,scope.nPatientId,scope.nEncounterId,encObj.encDate,allergyInteractionCallback)}else{if(_.trim(orderItem.itemType).toLocaleLowerCase()==='immunizations'){scope.saveLabsDIProcImmInjOrdWithSupplData(orderItem)}else{scope.saveLabsDIProcImmInjOrders(orderItem)}}}else if(orderItem.sKeyname&&(orderItem.sKeyname.toLowerCase()=='activity'||orderItem.sKeyname.toLowerCase()=='nursing'||orderItem.sKeyname.toLowerCase()=='diet')){scope.saveIPOrders(orderItem)}else if(scope.context===PRE_VISIT_PLANNING_CONTEXT&&(orderItem.sKeyname==='assessments'||orderItem.sKeyname==='orderset'||orderItem.sKeyname==='template')){orderItem.sIsFuture=scope.qsFilterObj.sIsFuture;orderItem.sFutureDate=scope.qsFilterObj.sFutureDate;return quickSearchNS.savePreplanningOrders(orderItem)}function allergyInteractionCallback(response){if(response){scope.saveLabsDIProcImmInjOrdWithSupplData(orderItem)}}};scope.saveLabsDIProcImmInjOrdWithSupplData=function(orderItem){if(scope.nSelectedAssessmentId!==undefined&&quickSearchNS.checkForAsmtInPrevDxList(scope.nSelectedAssessmentId)>-1&&!quickSearchNS.checkIfDxExistForCurVisit(scope.nSelectedAssessmentId)){scope.oItemData=orderItem;scope.loadSupplementPopUp()}else{scope.saveLabsDIProcImmInjOrders(orderItem)}};scope.favOrdersQsDirectiveRowClickHanlder=function(oItem,event){scope.isFromFvrtDiv=true;scope.qsDirectiveRowClickHanlder(oItem,event)};scope.ascOrderValidationCallback=function(orderItem){if(_.trim(scope.context)==="ascOrdersScreen"&&_.trim(orderItem)!==""&&_.trim(orderItem.qsFailedStatusMessage)!==""){quickSearchNS.showOrdStatus(orderItem.qsFailedStatusMessage,'failed',scope.randNum,scope.nShowInPlaceAlertStatus);orderItem.qsFailedStatusMessage="";return}scope.saveLabsDIProcImmInjOrders(orderItem)};quickSearchNS.savePreplanningOrders=function(orderItem){scope.todoService.addQuickItem(orderItem,scope.qsrequestObj.hmFlag,QUICK_ORDER_SOURCE_FOR_PRE_VISIT_PLANNING,quickSearchNS.todolistCallBack)};quickSearchNS.todolistCallBack=function(response,order){if(response.status===0){quickSearchNS.showOrdStatus(response.errorMsg,'failed',scope.randNum,scope.nShowInPlaceAlertStatus);return}order.id=response.status;order.orderAdded=true;let itemName=order.sKeyname==="referral"?"Referral":order.description;quickSearchNS.showOrdStatus(itemName,'success',scope.randNum,scope.nShowInPlaceAlertStatus);scope.qsresponseObj.obj=order;scope.setDataInParentScreen('neworder',order);scope.clearReferral();$rootScope.$broadcast('todoItemsCount')};scope.saveLabsDIProcImmInjOrders=function(orderItem){if(scope.context===PRE_VISIT_PLANNING_CONTEXT){return quickSearchNS.savePreplanningOrders(orderItem)}if(scope.context=="dermExecScreen"&&Object.keys(scope.obsIdVsTreatmentIds).length==0){quickSearchNS.showOrdStatus("Please select at least one observation for quick order.",'failed',scope.randNum,scope.nShowInPlaceAlertStatus);return}if(getItemKeyValue("ASCEnabled").toLowerCase()==="yes"&&typeof getAscEncTypeForCPOEOrder==="function"&&getAscEncTypeForCPOEOrder().indexOf(scope.qsrequestObj.nEncounterType)>-1&&getAnesthesiaAndSurgeonEncounterTypesForCPOEOrder().indexOf(scope.qsrequestObj.nEncounterType)===-1){ecwAlert("Order cannot be placed with this encounter type : "+scope.qsrequestObj.nEncounterType);return}var sRequestFrom="webEMRQuickOrder";var strUrl="/mobiledoc/jsp/Orders/SaveQuickOrders.jsp?orderDetailsObject="+encodeURIComponent(JSON.stringify(orderItem))+"&requestFrom="+sRequestFrom+"&rnd2="+Math.random();if(scope.context=="ascOrdersScreen"){strUrl+="&context=asc"}else if("PNscreen"===scope.context||"treatmentscreen"===scope.context){strUrl+="&context="+scope.context}var responsePromise=$http.post(makeURL(strUrl));var updateAssessmentsForASC=false;responsePromise.success(function(data,status,headers,config){var oRetObj={};var jsonData=xml2json($.trim(data));if(jsonData!=null&&jsonData!=undefined&&jsonData.Envelope.Body['return'].status!=undefined){if(!scope.bDxExistForVisit)scope.loadDxListInQSD();scope.bDxExistForVisit=true;var sStatus="";var OrderStatObj={sRequestType:'neworder',sStatus:'',sOrderName:orderItem.sItemName,sFailedReason:''};oRetObj=returnDataArray(jsonData.Envelope.Body['return']);oRetObj=oRetObj[0];sStatus=angular.lowercase($.trim(oRetObj.status));if(sStatus=='success'||sStatus=='failed'){if(sStatus=='success'){let isMessageAlreadyDisplayed=false;if(orderItem.sKeyname=='labreports'||orderItem.sKeyname=='xrays'||orderItem.sKeyname=='procedures'){if(typeof oRetObj.LabDIExits!='undefined'&&"yes"==oRetObj.LabDIExits){if(scope.context=="dermExecScreen"){var isItemNotOrdForSelObs=false;for(var obsId in scope.obsIdVsTreatmentIds){if(scope.obsIdVsTreatmentIds.hasOwnProperty(obsId)){var itemIds=scope.obsIdVsTreatmentIds[obsId];if(itemIds==undefined||itemIds&&itemIds.indexOf(orderItem.nItemId)<0){isItemNotOrdForSelObs=true}}}if(isItemNotOrdForSelObs){OrderStatObj.sStatus='success';if(!isMessageAlreadyDisplayed){quickSearchNS.showOrdStatus(orderItem.sItemName,'success',scope.randNum,scope.nShowInPlaceAlertStatus)}scope.setDataInParentScreen('neworder',OrderStatObj);return}}quickSearchNS.showOrdStatus("Order already exists.",'failed',scope.randNum,scope.nShowInPlaceAlertStatus);return}else{if(scope.context=="ascOrdersScreen"){updateAssessmentsForASC=true}else{OrderStatObj.sStatus='success';quickSearchNS.showOrdStatus(orderItem.sItemName,'success',scope.randNum,scope.nShowInPlaceAlertStatus);isMessageAlreadyDisplayed=true;if("PNscreen"===scope.context||"treatmentscreen"===scope.context){if(oRetObj.referralCreationSuccessMessage&&null!==oRetObj.referralCreationSuccessMessage){notification.show('success','Quick Search',oRetObj.referralCreationSuccessMessage,5e3)}if(oRetObj.referralCreationStatus&&"failed"===oRetObj.referralCreationStatus){ecwAlert(oRetObj.referralCreationErrorMessage)}}scope.setDataInParentScreen('neworder',OrderStatObj);if(scope.context==='SunohQuickOrders'){refreshDashboard(scope.nEncounterId,scope.nPatientId,"","pn")}if(scope.context=="dermExecScreen"){return}}}}if(updateAssessmentsForASC){strUrl=makeURL("/mobiledoc/ascWeb/ASC/PnIpOrders.go/Orders/loadASCOrders?sRequestFrom=ascOrdersScreen&sRequestType=updateAssmts&actionType=processQuickSearchOrder&orderDetailsObject="+encodeURIComponent(JSON.stringify(orderItem)));$http.post(strUrl).then(function(data){OrderStatObj.sStatus='success';quickSearchNS.showOrdStatus(orderItem.sItemName,'success',scope.randNum,scope.nShowInPlaceAlertStatus);scope.setDataInParentScreen('neworder',OrderStatObj)})}else{OrderStatObj.sStatus='success';if(!isMessageAlreadyDisplayed){quickSearchNS.showOrdStatus(orderItem.sItemName,'success',scope.randNum,scope.nShowInPlaceAlertStatus)}if(scope.selectedOrderItemKeyName.toLowerCase()==='cptcodes'){OrderStatObj.itemType=orderItem.itemType}if(orderItem.itemType==='injections'||orderItem.itemType==='immunizations'){if(scope.context==="dermExecScreen"){OrderStatObj.orderId=oRetObj.ImmId}}scope.setDataInParentScreen('neworder',OrderStatObj);if(scope.context==='SunohQuickOrders'&&!isMessageAlreadyDisplayed){refreshDashboard(scope.nEncounterId,scope.nPatientId,"","pn")}}if(orderItem.itemType==='injections'&&scope.context!=="treatmentscreen"){let tabsPanelScope=angular.element(document.getElementById('tabspanel')).scope();if(scope.context.toLowerCase()==="pnscreen"&&tabsPanelScope&&tabsPanelScope.tabSelected&&tabsPanelScope.tabSelected.orders){return}injectionDrugInteractionService.checkDrugInteractionSeverityForNDCCode(scope.nPatientId,scope.nEncounterId,trUserId)}}else if(sStatus=='failed'){ecwAlert("An error occured while saving Order");OrderStatObj.OrderStatObj='failed';scope.setDataInParentScreen('neworder',OrderStatObj)}}}})};scope.saveIPOrders=function(orderItem){if(orderItem){orderItem.nBillable=0;orderItem.encounterId=orderItem.nEncounterId;orderItem.userId=orderItem.nTrUserId;if(scope.context=="ascOrdersScreen"){orderItem.itemId=orderItem.nItemId;orderItem.parentId=orderItem.nParentID;orderItem.orderFor=scope.qsrequestObj.orderFor;orderItem.noteType=scope.qsrequestObj.noteType;if(scope.qsrequestObj.protocolType!=undefined){orderItem.protocolType=scope.qsrequestObj.protocolType}var requestParams=_.clone(scope.qsFilterObj);strUrl=makeURL("/mobiledoc/ascWeb/ASC/PnIpOrders.go/Orders/loadASCOrders?sRequestFrom="+scope.context+"&sRequestType=SaveQuickOrders&actionType=processQuickSearchOrder&orderDetailsObject="+encodeURIComponent(JSON.stringify(orderItem))+"&")}var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data,status,headers,config){var OrderStatObj={sRequestType:'neworder',sStatus:'',sOrderName:orderItem.sItemName,sFailedReason:''};if(data.status=='success'&&data.orderExists=='no'){OrderStatObj.sStatus='success';quickSearchNS.showOrdStatus(orderItem.sItemName,'success',scope.randNum,scope.nShowInPlaceAlertStatus);scope.setDataInParentScreen('neworder',OrderStatObj)}else if(data.orderExists=='yes'){if(data.message){quickSearchNS.showOrdStatus(data.message,'failed',scope.randNum,scope.nShowInPlaceAlertStatus)}else{quickSearchNS.showOrdStatus("Order already exists.",'failed',scope.randNum,scope.nShowInPlaceAlertStatus)}}else{quickSearchNS.showOrdStatus("Some error occurred.",'failed',scope.randNum,scope.nShowInPlaceAlertStatus)}})}};scope.setDxDetailsForPLPastDx=function(rxObj){if(rxObj){rxObj.assessmentDetails={AssessmentId:scope.nSelectedAssessmentId,DxCode:scope.nSelectedAssessmentCode,DxName:scope.nSelectedAssessmentName,previousPastDx:true}}};scope.rxEditClicked=function(index){var rxObj=scope.dosageResultSet[index];if(rxObj.assessId==undefined&&scope.nSelectedAssessmentId!=undefined){rxObj.assessId=scope.nSelectedAssessmentId;scope.setDxDetailsForPLPastDx(rxObj)}rxObj.isSunohMappedOrder=scope.selectedRxObject.isSunohMappedOrder;if(rxObj.isSunohMappedOrder){rxObj.rxStatus=scope.selectedRxObject.rxStatus}if(scope.topClass==="sunohRxOrderClass"){rxObj.isSunohInLineRxOrder=true}if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&rxObj.itemid!==undefined)rxObj.ItemId=rxObj.itemid;else{if((rxObj.ItemId==undefined||rxObj.ItemId==0)&&scope.selectedRxObject.nItemId!=undefined){rxObj.ItemId=scope.selectedRxObject.nItemId}}if(scope.b_MedispanEnabled=="no"){if((rxObj.DrugNameId==undefined||rxObj.DrugNameId==0)&&scope.selectedRxObject.sSupplierId!=undefined){rxObj.DrugNameId=scope.selectedRxObject.sSupplierId}}else{if((rxObj.DrugNameId==undefined||rxObj.DrugNameId==0)&&scope.selectedRxObject.sDrugNameId!=undefined){rxObj.DrugNameId=scope.selectedRxObject.sDrugNameId}}if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&rxObj.brand_description!==undefined&&rxObj.brand_description.length>0)rxObj.sItemName=rxObj.brand_description;else{if(rxObj.sItemName===undefined&&scope.selectedRxObject.sItemName!==undefined){rxObj.sItemName=scope.selectedRxObject.sItemName}}if(scope.selectedRxObject.isCompound==='true'){rxObj.isCompound=scope.selectedRxObject.isCompound;rxObj.CompoundIngredients=scope.selectedRxObject.CompoundIngredients}if(scope.context=="ascOrdersScreen"){rxObj.ascLoginUserType=global.loginUserType;rxObj.ascOrderingProvider=scope.qsrequestObj.orderFor;rxObj.ascOrderNoteType=scope.qsrequestObj.noteType;rxObj.ascOorderProtocolType=scope.qsrequestObj.protocolType;var stopDate=$filter('date')(new Date,'MM/dd/yyyy');rxObj.StopDateFormatted=stopDate;rxObj.ascContextName='ASC'}rxObj.isRTBCFeatureEnabled=scope.rtbcEligibilityFlag&&scope.isMedMulEquiDrug;rxObj.isDermaContext=false;if(scope.context=="dermExecScreen")rxObj.isDermaContext=true;if(getItemKeyValue("EnableNewRxEditScreen").toLowerCase()==="yes"||getItemKeyValue("EnableMSClinical").toLowerCase()==="yes"){rxObj.formularyInfo=scope.formularyInfo;rxObj.encFacilityId=scope.encfacilityId;rxObj.dosageResultSet=scope.dosageResultSet;$ocLazyLoad.load({name:'RxEditModule',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEdit/js/RxEditController.js','/mobiledoc/jsp/resources/jslib/angular-perfect-scrollbar/src/angular-perfect-scrollbar.min.js']}).then(function(){let modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEdit/rx-editmodal.html'),controller:'RxEditCtrl',windowClass:'rxeditscreen bluetheme rx-topmargin',backdrop:"static",keyboard:false,resolve:{patientID:function(){return scope.nPatientId},encounterID:function(){return scope.nEncounterId},RxEditObject:function(){return rxObj},loginuserid:function(){return scope.nTrUserId},parentName:function(){return"AddRxTreatment"}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){rxObj.formularyInfo={};rxObj.encFacilityId="";rxObj.dosageResultSet=[];if(!angular.isUndefined(modalInstanceResponse)&&typeof modalInstanceResponse==='object'){if(scope.context=="ascOrdersScreen"){scope.dosageResultSet[index].orderProtocolType=modalInstanceResponse.orderProtocolType?modalInstanceResponse.orderProtocolType.entryMethodKey:0;scope.dosageResultSet[index].orderPriority=modalInstanceResponse.orderPriority?modalInstanceResponse.orderPriority.orderPriorityKey:0}scope.dosageResultSet[index].dispense=modalInstanceResponse.dispense;scope.dosageResultSet[index].duration=modalInstanceResponse.duration;scope.dosageResultSet[index].formulation=modalInstanceResponse.formulation;scope.dosageResultSet[index].freq=modalInstanceResponse.freq;scope.dosageResultSet[index].ndc=modalInstanceResponse.ndc;scope.dosageResultSet[index].refills=modalInstanceResponse.refills;scope.dosageResultSet[index].route=modalInstanceResponse.route;scope.dosageResultSet[index].strength=modalInstanceResponse.strength;scope.dosageResultSet[index].take=modalInstanceResponse.take;scope.dosageResultSet[index].RxEditNotesValue=modalInstanceResponse.RxEditNotesValue;scope.dosageResultSet[index].RxSource=modalInstanceResponse.RxSource;scope.dosageResultSet[index].RxSourceID=modalInstanceResponse.RxSourceID;scope.dosageResultSet[index].startDate=modalInstanceResponse.startDate;scope.dosageResultSet[index].stopDate=modalInstanceResponse.stopDate;scope.dosageResultSet[index].isStopDateBlankFromRxEdit=true;if(modalInstanceResponse.stopDate){scope.dosageResultSet[index].isStopDateBlankFromRxEdit=false}scope.dosageResultSet[index].daw=modalInstanceResponse.daw;scope.dosageResultSet[index].AddInstructions=modalInstanceResponse.AddInstructions;scope.dosageResultSet[index].RxAdditionalNotes=modalInstanceResponse.RxAdditionalNotes;scope.dosageResultSet[index].PharmacyNCPDPId=modalInstanceResponse.PharmacyNCPDPId;scope.dosageResultSet[index].pharmacyId=modalInstanceResponse.pharmacyId;scope.dosageResultSet[index].assessId=modalInstanceResponse.assessId;addAndSelectDxInArray(modalInstanceResponse.assessmentDetails);scope.nSelectedAssessmentId=modalInstanceResponse.assessId;scope.dosageResultSet[index].isSplitPharmacy=modalInstanceResponse.isSplitPharmacy;if(modalInstanceResponse.isSplitPharmacy){scope.dosageResultSet[index].splitRx=modalInstanceResponse.splitRx}scope.isRtbcPopupOpened=false;scope.isRtbcButtonClicked=false;if(modalInstanceResponse.ePARequestFromRxEdit){scope.dosageResultSet[index].ePARequestFromRxEdit=modalInstanceResponse.ePARequestFromRxEdit;scope.dosageResultSet[index].ePARxName=modalInstanceResponse.ePARxName;scope.dosageResultSet[index].ItemId=modalInstanceResponse.ItemId;scope.dosageResultSet[index].awup=modalInstanceResponse.awup;scope.dosageResultSet[index].description=modalInstanceResponse.description;scope.dosageResultSet[index].brand_description=modalInstanceResponse.brand_description;scope.dosageResultSet[index].BrandDesc=modalInstanceResponse.BrandDesc;scope.dosageResultSet[index].drugName=modalInstanceResponse.drugName;scope.dosageResultSet[index].dxArray=modalInstanceResponse.dxArray;scope.ePAClicked(index);return}else{if(scope.topClass==="sunohRxOrderClass"){scope.addRxSunohPossibleMatches(index,"rxEditClick");return}scope.selectDosage(index);scope.setDosageCalcCombos()}}})})}else{$ocLazyLoad.load({name:'RxEditModule',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEditHelper.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEdit.jsp'),controller:'RxEditCtrl',windowClass:'app-modal-window1',backdrop:"static",keyboard:false,resolve:{patientID:function(){return scope.nPatientId},encounterID:function(){return scope.nEncounterId},RxEditObject:function(){return rxObj},loginuserid:function(){return scope.nTrUserId},parentName:function(){return"AddRxTreatment"}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){if(!angular.isUndefined(modalInstanceResponse)){if(scope.context==="ascOrdersScreen"){scope.dosageResultSet[index].orderProtocolType=modalInstanceResponse.orderProtocolType?modalInstanceResponse.orderProtocolType.entryMethodKey:0;scope.dosageResultSet[index].orderPriority=modalInstanceResponse.orderPriority?modalInstanceResponse.orderPriority.orderPriorityKey:0}scope.dosageResultSet[index].dispense=modalInstanceResponse.dispense;scope.dosageResultSet[index].duration=modalInstanceResponse.duration;scope.dosageResultSet[index].formulation=modalInstanceResponse.formulation;scope.dosageResultSet[index].freq=modalInstanceResponse.freq;scope.dosageResultSet[index].ndc=modalInstanceResponse.ndc;scope.dosageResultSet[index].refills=modalInstanceResponse.refills;scope.dosageResultSet[index].route=modalInstanceResponse.route;scope.dosageResultSet[index].strength=modalInstanceResponse.strength;scope.dosageResultSet[index].take=modalInstanceResponse.take;scope.dosageResultSet[index].RxEditNotesValue=modalInstanceResponse.RxEditNotesValue;scope.dosageResultSet[index].RxSource=modalInstanceResponse.RxSource;scope.dosageResultSet[index].RxSourceID=modalInstanceResponse.RxSourceID;scope.dosageResultSet[index].startDate=modalInstanceResponse.startDate;scope.dosageResultSet[index].stopDate=modalInstanceResponse.stopDate;scope.dosageResultSet[index].isStopDateBlankFromRxEdit=true;if(modalInstanceResponse.stopDate){scope.dosageResultSet[index].isStopDateBlankFromRxEdit=false}scope.isRtbcPopupOpened=false;scope.isRtbcButtonClicked=false;scope.selectDosage(index);scope.setDosageCalcCombos()}})})}};let addAndSelectDxInArray=function(dxDetails){try{if(dxDetails){let isDxFound=false;for(let index=0;index<scope.qsDxList.Dx.length&&!isDxFound;index++){if(scope.qsDxList.Dx[index].dxItemId.toString()===dxDetails.AssessmentId){isDxFound=true;scope.chkAssessment("Assessment",scope.qsDxList.Dx[index])}}if(!isDxFound){let newDx={dxItemId:parseInt(dxDetails.AssessmentId),dxItemCode:dxDetails.DxCode,dxItemName:dxDetails.DxName,DirtyFlag:'1'};scope.qsDxList.Dx.push(newDx);scope.chkAssessment("Assessment",newDx)}}}catch(e){}};scope.setDosageCalcCombos=function(){scope.RxEditStrengthObject=[];scope.RxEditFrequencyObject=[];scope.RxEditDurationObject=[];for(var i=0;i<=scope.dosageResultSet.length;i++){try{if(scope.RxEditStrengthObject.indexOf(scope.dosageResultSet[i].strength)<0){scope.RxEditStrengthObject.push(scope.dosageResultSet[i].strength)}if(scope.RxEditFrequencyObject.indexOf(scope.dosageResultSet[i].freq)<0){scope.RxEditFrequencyObject.push(scope.dosageResultSet[i].freq)}if(scope.RxEditDurationObject.indexOf(scope.dosageResultSet[i].duration)<0){scope.RxEditDurationObject.push(scope.dosageResultSet[i].duration)}}catch(e){}}};scope.rxDoseCalcClicked=function(index){scope.patientIdentifiers={};var rxObj=scope.dosageResultSet[index];rxObj.assessId=scope.nSelectedAssessmentId;rxObj.ItemId=scope.selectedRxObject.nItemId;if(scope.checkIsCompoundDrug(rxObj.isCompound)){ecwAlert("Dosage Calculator is disabled for Compound Medications. Please perform all necessary manual dose calculations prior to prescribing.");return}if(scope.b_MedispanEnabled=="no"){rxObj.DrugNameId=scope.selectedRxObject.sSupplierId}else{rxObj.DrugNameId=scope.selectedRxObject.sDrugNameId}if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&rxObj.brand_description!==undefined)rxObj.sItemName=rxObj.brand_description;else rxObj.sItemName=scope.selectedRxObject.sItemName;if(typeof rxObj.strength!=='undefined'&&rxObj.strength!=null){var bCheckIsDosageCalcEnabled=rxService.IsDosageCalcEnabled(rxObj.ItemId,rxObj.strength);if(bCheckIsDosageCalcEnabled==="false"){ecwAlert("The Dosage Calculator is disabled for this medication; since the medication has more than one ingredient the dosage may not be calculated correctly.");return}}if(rxObj.hasOwnProperty("strength")&&rxObj.strength!==""&&rxObj.strength!==null&&rxObj.strength.length>0&&rxObj.strength.indexOf("(")>-1&&rxObj.strength.indexOf(")")>-1){let msg='<b>Dosage Calculator - Cannot Calculate Dose</b><br/><br/>The dosage calculator is disabled because the selected medication\'s strength is provided by the drug database in a format that cannot be safely used for calculation.';showAlertMessage(msg,'','ErrorMsg','','QuickSearchDirective');return}$ocLazyLoad.load({name:'DosageCalculator',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/DosageCalculatorController.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/DosageCalculator.jsp?'+"encounterId="+scope.nEncounterId),controller:'DosageCalculatorController',size:'sm',windowClass:'app-modal-window1 bluetheme',backdrop:"static",keyboard:false,resolve:{loginuserid:function(){return global.TrUserId},parentName:function(){return"AddRxTreatment"},RxInfo:function(){return{RxEditDurationObject:scope.RxEditDurationObject,RxEditStrengthObject:scope.RxEditStrengthObject,RxEditFrequencyObject:scope.RxEditFrequencyObject,RxEditDefaultRxNameValue:rxObj.sItemName,RxEditDefaultStrengthValue:rxObj.strength,RxEditDefaultFormulationValue:rxObj.formulation,RxEditDefaultTakeValue:rxObj.take,RxEditDefaultRouteValue:rxObj.route,RxEditDefaultDurationValue:rxObj.duration,RxEditDefaultDispenseValue:rxObj.dispense,RxEditDefaultFrequencyValue:rxObj.freq,RxEditItemIdValue:rxObj.ItemId,RxEditDrugNameIdValue:rxObj.DrugNameId}},encounterId:function(){return scope.nEncounterId},patientIdentifiers:function(){return scope.patientIdentifiers}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){console.log(modalInstanceResponse);if(modalInstanceResponse!=null){try{rxObj.strength=modalInstanceResponse.RxEditDefaultStrengthValue;rxObj.formulation=modalInstanceResponse.RxEditDefaultFormulationValue;rxObj.take=modalInstanceResponse.RxEditDefaultTakeValue;rxObj.route=modalInstanceResponse.RxEditDefaultRouteValue;rxObj.freq=modalInstanceResponse.RxEditDefaultFrequencyValue;rxObj.duration=modalInstanceResponse.RxEditDefaultDurationValue;rxObj.dispense=modalInstanceResponse.RxEditDefaultDispenseValue;scope.isRtbcPopupOpened=false;scope.isRtbcButtonClicked=false;if(scope.topClass==="sunohRxOrderClass"){scope.addRxSunohPossibleMatches(index,"dosageClick");return}scope.selectDosage(index)}catch(e){console.log("Error while aplying Dosage")}}})})};scope.$on('saveTreatmentNow',function(e,obj){if(obj.context!==scope.context){return}if(scope.context==="treatmentscreen"){if(quickSearchNS.checkForConcurrencyinQs()){quickSearchNS.closeTreatmentScreenforConcurrencyinQS();return}}if(obj.bSaveSelectedRx===true||obj.bSaveSelectedRx==="true"){if(scope.rxedit==true){scope.rxEditSave()}else if(obj.ePAFlag){scope.openEPAInitializePopup()}else{if(scope.nSelectedAssessmentId!==undefined&&quickSearchNS.checkForAsmtInPrevDxList(scope.nSelectedAssessmentId)>-1&&!quickSearchNS.checkIfDxExistForCurVisit(scope.nSelectedAssessmentId)){scope.loadSupplementPopUp()}else{scope.saveRxFromQuickSearch()}}}else{scope.selectedRxObject={};scope.showHideLevel2Div('hide')}if(scope.rxedit==true){scope.rxedit=false}if(scope.dosageResultSet.length>0){scope.dosageResultSet[scope.selectedIndex].isCallFromePA=false;scope.dosageResultSet[scope.selectedIndex].ePARequestFromRxEdit=false}});scope.isRtbcButtonClicked=false;scope.viewControl=function(index,isRtbcButtonClicked){if(scope.topClass==="sunohRxOrderClass"){scope.addRxSunohPossibleMatches(index,"dosageClick");return}scope.isRtbcPopupOpened=false;if(isRtbcButtonClicked===true)scope.isRtbcButtonClicked=true;else scope.isRtbcButtonClicked=false;if(scope.context==="ImmTherapeuticInjections"){scope.setInjectionMedicationMapping(index)}else if(scope.b_enabledFormulary===true&&scope.b_viewFormulary===true&&scope.dosageResultSet[index].rxFormulary==='Y'){scope.viewAdminPopup(index)}else{scope.selectDosage(index)}};scope.addRxSunohPossibleMatches=function(index,callFrom){let selectedMedObj=scope.dosageResultSet[index];selectedMedObj.callFrom=callFrom;if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&selectedMedObj.brand_description!==undefined&&selectedMedObj.brand_description.length>0){selectedMedObj.name=selectedMedObj.brand_description}else{if(scope.selectedRxName){selectedMedObj.name=scope.selectedRxName}}if(scope.selectedRxItemId){selectedMedObj.itemId=scope.selectedRxItemId}selectedMedObj.selectedIndex=index;$rootScope.$broadcast('appendRxSunohPossibleMatches',selectedMedObj);scope.hideAllQucikSearchDDiv()};scope.sunohMedName="";scope.qsrequestObj.setRxNameFromSunoh=function(medObj){if(scope.loadQuickSearchData===undefined){let appElement=document.querySelector('.edit-rx-order-tbl .quick-search-modern-style');if(appElement){let scopeQuickSearch=angular.element(appElement).scope();scope=scopeQuickSearch}}if(medObj.vitals){if(medObj.vitals.weight){scope.patientVitalData.wtDisplayString=medObj.vitals.weight}if(medObj.vitals.height){scope.patientVitalData.htDisplayString=medObj.vitals.height}}scope.sunohMedName=medObj.name;scope.loadQuickSearchData()};scope.setTextBoxFromSunohAddRx=function(){scope.qsFilterObj.sQuickSearchText=scope.sunohMedName;$('#quick-search-textBox-'+scope.randNum).val(scope.sunohMedName);scope.sunohMedName="";scope.qsTextBoxKeyPress(true);quickSearchNS.setFocusOnSearchBox(scope.randNum,0)};scope.setInjectionMedicationMapping=function(dosageIndex){if(scope.dosageResultSet&&scope.dosageResultSet.length>dosageIndex){var medicationObject={};medicationObject.name=scope.selectedRxName;medicationObject.itemId=scope.selectedRxItemId;medicationObject.ndcCode=scope.dosageResultSet[dosageIndex].ndc;scope.qsFilterObj.sQuickSearchText=medicationObject.name;$rootScope.$broadcast("setInjectionMedicationMapping",medicationObject);if(scope.context==="ImmTherapeuticInjections"&&typeof resizeVBChromiumModal==="function"){resizeVBChromiumModal(immInjCompendium_size_772,immInjCompendium_size_496)}}};scope.viewAdminPopup=function(index){scope.resetAdministeredAndDispenseFlag();scope.selectedDrugIndex=index;var administerFlag=scope.dosageResultSet[index].AdministerFlag;var dispenseFlag=scope.dosageResultSet[index].DispenseFlag;var mailOrderFlag=scope.dosageResultSet[index].mailOrderFlag;var rxCardFlag=scope.dosageResultSet[index].rxCardFlag;$("#AdminPopup"+scope.topClassUniqueDivId).modal('show');$("#btnAdminFlag"+scope.topClassUniqueDivId).hide();$("#btnDispenseFlag"+scope.topClassUniqueDivId).hide();$("#btnMailOrderFlag"+scope.topClassUniqueDivId).hide();$("#btnRxCardFlag"+scope.topClassUniqueDivId).hide();if(administerFlag==='1')$("#btnAdminFlag"+scope.topClassUniqueDivId).show();if(dispenseFlag==='1')$("#btnDispenseFlag"+scope.topClassUniqueDivId).show();if(mailOrderFlag==='1')$("#btnMailOrderFlag"+scope.topClassUniqueDivId).show();if(rxCardFlag==='1')$("#btnRxCardFlag"+scope.topClassUniqueDivId).show()};scope.placeOrder=function(){var obj=scope.dosageResultSet[scope.selectedDrugIndex];obj.AdministerFlagValue=0;obj.DispenseFlagValue=0;obj.rxCardFlagValue=0;obj.mailOrderFlagValue=0;scope.selectDosage(scope.selectedDrugIndex);$("#AdminPopup"+scope.topClassUniqueDivId).modal('hide')};scope.administeredOrder=function(){var obj=scope.dosageResultSet[scope.selectedDrugIndex];obj.AdministerFlagValue=1;obj.DispenseFlagValue=0;obj.rxCardFlagValue=0;obj.mailOrderFlagValue=0;scope.selectDosage(scope.selectedDrugIndex);$("#AdminPopup"+scope.topClassUniqueDivId).modal('hide')};scope.dispenseOrder=function(){var obj=scope.dosageResultSet[scope.selectedDrugIndex];obj.AdministerFlagValue=0;obj.DispenseFlagValue=1;obj.rxCardFlagValue=0;obj.mailOrderFlagValue=0;scope.selectDosage(scope.selectedDrugIndex);$("#AdminPopup"+scope.topClassUniqueDivId).modal('hide')};scope.mailOrder=function(){var obj=scope.dosageResultSet[scope.selectedDrugIndex];obj.AdministerFlagValue=0;obj.DispenseFlagValue=0;obj.rxCardFlagValue=0;obj.mailOrderFlagValue=1;scope.selectDosage(scope.selectedDrugIndex);$("#AdminPopup"+scope.topClassUniqueDivId).modal('hide')};scope.rxCardOrder=function(){var obj=scope.dosageResultSet[scope.selectedDrugIndex];obj.AdministerFlagValue=0;obj.DispenseFlagValue=0;obj.mailOrderFlagValue=0;obj.rxCardFlagValue=1;scope.selectDosage(scope.selectedDrugIndex);$("#AdminPopup"+scope.topClassUniqueDivId).modal('hide')};scope.resetAdministeredAndDispenseFlag=function(){var obj=scope.dosageResultSet[scope.selectedDrugIndex];if(checkUndefinedOrNullOrBlank(obj,false)){return}obj.AdministerFlagValue=0;obj.DispenseFlagValue=0;obj.rxCardFlagValue=0;obj.mailOrderFlagValue=0};scope.closeAddInfo=function(){$("#AdminPopup"+scope.topClassUniqueDivId).modal('hide')};var ndcFlag=false;scope.selectDosage=function(index){var obj={};obj=scope.dosageResultSet[index];scope.itemIdForMultumFormulary=obj.itemid;if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&obj.brand_description!==undefined&&obj.brand_description.length>0){scope.selectedRxObjectBrandName=obj.brand_description;scope.selectedRxName=obj.brand_description}else{scope.selectedRxName=scope.selectedRxObject.sItemName}scope.selectedIndex=index;scope.saveRxObject="";try{if(obj.DrugNameId==0||typeof obj.DrugNameId==undefined||typeof obj.DrugNameId==="undefined")obj.DrugNameId=scope.selectedRxDrugNameId}catch(e){}if(scope.IsMedOrderingForPastVist(index)||bAlreadyCalled){if((obj.ndc==''||obj.ndc==undefined)&&!ndcFlag&&scope.showNDCWarningforNonNDCDrugDoses&&scope.selectedRxObject.isCompound!=='true'&&!obj.isCallFromePA){var selectedRx=scope.selectedRxName+" "+(obj.strength?obj.strength:"")+" "+(obj.formulation?obj.formulation:"");var msg="'"+escapeHtml(selectedRx)+"' does not have valid NDC code.\nPharmacy may not be able to dispense this medication as "+"written.\nYou will not be able to send this medication to a pharmacy as electronic prescription as it will "+"drop to fax.\n\nYou may want to choose an equivalent medication which are generally available in the market "+"in order to send it as electronic prescription.\n\nClick 'Yes' to continue without NDC.Otherwise click 'No'.";BootstrapDialog.show({title:"eClinicalWorks",message:msg,buttons:[{label:'Yes',cssClass:'btn-lgrey btn-xs',action:function(dialog){ndcFlag=true;scope.selectDosage(index);dialog.close()}},{label:'No',cssClass:'btn-lgrey btn-xs',action:function(dialog){ndcFlag=false;dialog.close();$("#searchBox").select();quickSearchNS.setFocusOnSearchBox(scope.randNum,1);return}}]})}else{ndcFlag=true}if(ndcFlag){bAlreadyCalled=false;if(scope.b_enabledFormulary){if(typeof obj.rxFormularyId==="undefined"){obj.rxFormularyId=0}if(typeof obj.IVHydration==="undefined"){obj.IVHydration=0}}scope.saveRxObject=rxService.RxChecksTobePerfomedBeforeSaving(scope.OrdersForEnc,obj,0,"RxTreatment",scope.selectedRxName,scope.selectedRxItemId,scope.nEncounterId,scope.bOrderingRxMultipleTimes,scope.context);ndcFlag=false}}};scope.CurrMedsVerified=function(){var bVerified=false;$.ajax({type:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/rx/isRxVerified.jsp?EncounterId="+scope.nEncounterId),data:"","async":false,success:function(msg){if(msg.length>0){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(msg.trim());if(typeof jsonobj!="undefined"||jsonobj!=null||jsonobj.Envelope.Body['return'].hasOwnProperty("verified")){var bIsVerified=jsonobj.Envelope.Body['return'].verified;if(bIsVerified=="true")bVerified=true}}else{alert("An error occured in CurrMedsVerified.")}},error:function(xhr){console.log("An error occured: "+xhr.status+" "+xhr.statusText)}});return bVerified};scope.saveMedVerified=function(){if(scope.nEncounterId>0){var xmldata="<S:Envelope xmlns:S='http://schemas.xmlsoap.org/soap/envelope/' xmlns:SOAP-ENC='http://schemas.xmlsoap.org/soap/encoding/' S:encodingStyle='http://schemas.xmlsoap.org/soap/encoding/' xmlns:xsd='http://www.w3.org/1999/XMLSchema' xmlns:xsi='http://www.w3.org/1999/XMLSchema-instance'>"+"<S:Body>"+"<m:NOOP xmlns:m='NOOP'>"+"<encounter xsi:type='xsd:string'>";xmldata+="<id xsi:type='xsd:int'>"+scope.nEncounterId+"</id>";xmldata+="<MedicationFlag xsi:type='xsd:string'>Y</MedicationFlag>";xmldata+="</encounter></m:NOOP>"+"</S:Body></S:Envelope>";$.ajax({type:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/setEncounterDetails.jsp"),data:"Id="+scope.nEncounterId+"&TrUserId="+global.TrUserId+"&FormData="+xmldata,"async":false,success:function(msg){}})}};scope.getActiveRxCount=function(){var nCount=0;var serverurl='/mobiledoc/jsp/catalog/xml/rx/getActiveRx.jsp?PatientId='+scope.nPatientId;serverurl=serverurl+'&Date='+scope.encdateAddRx+'&Time='+scope.enctimeAddRx+'&PopulateMeds=False';$.ajax({type:"POST",url:makeURL(serverurl),data:"","async":false,success:function(msg){if(msg.length>0){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(msg.trim());if(typeof jsonobj!="undefined"||jsonobj!=null||jsonobj.Envelope.Body['return'].hasOwnProperty("encounter")){nCount=jsonobj.Envelope.Body['return'].medcount}}else{alert("An error occured in getActiveRxCount: getactiverx.")}},error:function(xhr){console.log("An error occured: "+xhr.status+" "+xhr.statusText)}});return nCount};function doseCheckEnabled(){if(getItemKeyValue("ShowAllergicAlerts").toUpperCase()!=="YES"){return false}if(getItemKeyValue("EnableMedispan").toUpperCase()!=="YES"){return false}if(getItemKeyValue("EnableMSClinical").toUpperCase()!=="YES"){return false}return true}function isDoseAlertMessageExist(ptAllergyObj){if(!doseCheckEnabled()){return false}if(!ptAllergyObj.Envelope.Body["return"].hasOwnProperty("DoseCheckResponse")){return false}var doseCheckRes=ptAllergyObj.Envelope.Body["return"].DoseCheckResponse;if(doseCheckRes.doseCheckStatus==='200'&&angular.isDefined(doseCheckRes.doseCheckAlerts)){return true}return false}function setDoseCheckData(rxObj,doseCheckData){doseCheckData.itemId=rxObj.ItemId;doseCheckData.ndcCode=rxObj.ndc}function checkUndefinedOrNullOrBlank(value,shouldTrim){if(angular.isUndefined(value)){return true}if(value===null){return true}if(value===""){return true}if(shouldTrim&&value.trim()===""){return true}return false}scope.CheckAllergyInteraction=function(rxObject){var doseCheckData={};if(getItemKeyValue("ShowAllergicAlerts").toUpperCase()=="YES"){var sSynonymId="";if(scope.b_MedispanEnabled.toUpperCase()=="NO"){sSynonymId=scope.selectedRxObject.sSupplierId}else{sSynonymId=scope.selectedRxObject.sDrugNameId}var rxItemId="";if(rxObject.isRtbcRxObject){if(rxObject.ItemId){rxItemId=rxObject.ItemId}else if(rxObject.itemID){rxItemId=rxObject.itemID}}else{rxItemId=scope.selectedRxItemId}if(checkUndefinedOrNullOrBlank(rxObject.ndc,true)){rxObject.ndc=""}var url="/mobiledoc/jsp/ecwrx/CheckAllergyInteraction.jsp?encid="+scope.nEncounterId+"&eDate="+scope.encdateAddRx+"&patientId="+scope.nPatientId+"&RxId="+rxItemId+"&ndc="+rxObject.ndc+"&SynonymId="+sSynonymId;url+="&strength="+encodeURIComponent(rxObject.strength)+"&formulation="+encodeURIComponent(rxObject.formulation);if(doseCheckEnabled()){var doseCheckDataParam="&drugName="+encodeURIComponent(rxObject.drugName)+"&take="+encodeURIComponent(rxObject.take)+"&route="+encodeURIComponent(rxObject.route)+"&freq="+encodeURIComponent(rxObject.freq)+"&duration="+encodeURIComponent(rxObject.duration)+"&dispensableItemId="+encodeURIComponent(rxObject.DispensableItemId)+"&calledFrom=web";url=url+doseCheckDataParam}var promise=$http.get(makeURL(url));promise.then(function(xml){var x2js=new X2JS;var ptAllergyObj=x2js.xml_str2json(xml.data.trim());if(typeof ptAllergyObj!="undefined"&&ptAllergyObj!=null&&(ptAllergyObj.Envelope.Body["return"].hasOwnProperty("DDAllergy")||ptAllergyObj.Envelope.Body["return"].hasOwnProperty("allergy")||isDoseAlertMessageExist(ptAllergyObj))){continueSaveRx=false;$ocLazyLoad.load({name:'AllergyInteraction',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/js/allergyInteractionController.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/allergy/allergyInteraction.jsp'),controller:'AllergyInteractionController',windowClass:'bluetheme',backdrop:"static",size:'lg',resolve:{patientID:function(){return scope.nPatientId},encid:function(){return scope.nEncounterId},parentName:function(){return""},itemName:function(){return ptAllergyObj.Envelope.Body["return"].itemName},doseCheckResponse:function(){return ptAllergyObj.Envelope.Body["return"].DoseCheckResponse},doseCheckData:function(){return doseCheckData},ptAllergy:function(){if(scope.b_MedispanEnabled.toUpperCase()=="NO"){var tempArr=[];tempArr=returnDataArray(ptAllergyObj.Envelope.Body["return"].allergy);for(var i=0;i<tempArr.length;i++){if(tempArr[i].hasOwnProperty("drug")){tempArr[i]["patientallergy"]=tempArr[i]["drug"];delete tempArr[i]["drug"]}if(tempArr[i].hasOwnProperty("catDescr")){tempArr[i]["allergyclass"]=tempArr[i]["catDescr"];delete tempArr[i]["catDescr"]}if(tempArr[i].hasOwnProperty("allergyDesc")){tempArr[i]["allergytype"]=tempArr[i]["allergyDesc"];delete tempArr[i]["allergyDesc"]}if(tempArr[i].hasOwnProperty("classDescr")){tempArr[i]["description"]=tempArr[i]["classDescr"];delete tempArr[i]["classDescr"]}}return tempArr}else{return returnDataArray(ptAllergyObj.Envelope.Body["return"].DDAllergy)}}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){if(modalInstanceResponse=="Continue"){if(!scope.callFromePA){scope.m_bAllergyInteraction=false;if(doseCheckEnabled()&&isDoseAlertMessageExist(ptAllergyObj)){setDoseCheckData(rxObject,doseCheckData);rxObject.doseCheckData=doseCheckData}scope.saveRxData(rxObject)}else{scope.callFromePA=false;scope.openEPAInitializePopup(rxObject,true)}return}scope.callFromePA=false;if(doseCheckEnabled()&&modalInstanceResponse!="Continue"&&isDoseAlertMessageExist(ptAllergyObj)){setDoseCheckData(rxObject,doseCheckData);scope.saveDoseCheckLog(doseCheckData);return}})})}else{if(!scope.callFromePA){scope.m_bAllergyInteraction=false;scope.saveRxData(rxObject)}else{scope.callFromePA=false;scope.openEPAInitializePopup(rxObject,true)}}})}else{if(!scope.callFromePA){scope.m_bAllergyInteraction=false;scope.saveRxData(rxObject)}else{scope.callFromePA=false;scope.openEPAInitializePopup(rxObject,true)}}};scope.saveDoseCheckLog=function(doseCheckData){if(!doseCheckEnabled()){return}var url='/mobiledoc/cpoe/doseCheckLog/saveDoseCheckLog';url=makeURL(url);$http({method:'POST',url:url,headers:{},data:doseCheckData}).then(function(data){})};let isCurrMedsVerified=function(){return scope.m_bFirstRx&&rxService.isValidOffVisitForCurrentMeds(scope.nEncounterId,scope.nPatientId)};function checkIsValidForAllergyVerification(keyName,event){if(checkUndefinedOrNullOrBlank(keyName,true)){return false}if(keyName.toLowerCase()!=='rx'&&keyName.toLowerCase()!=='rxmedispan'){return false}if(event){let sId=event.target.id;if(sId.indexOf('favIcon')!==-1){return false}}if(scope.context&&(scope.context==='PNscreen'||scope.context==='treatmentscreen'||scope.context==='SunohQuickOrders')&&getItemKeyValue("EnablePriorAllergyVerificationPN").toUpperCase()==="YES"){return true}if(scope.context&&scope.context==='ascOrdersScreen'&&getItemKeyValue("EnablePriorAllergyVerificationASC").toUpperCase()==="YES"){return true}return false}var isAllergyVerified=false;scope.checkAllergyVerified=function(encId,oItem,event){if(isAllergyVerified){scope.checkAllergyVerifiedFlag=false;scope.qsDirectiveRowClickHanlder(oItem,event);return}var url='/mobiledoc/emr/medication/checkAllergyStatus?encounterId='+encId;url=makeURL(url);$http({method:'POST',url:url,headers:{'Content-Type':'application/json'},data:{}}).then(function(data){if(checkUndefinedOrNullOrBlank(data.data.AllergiesFlag,true)||data.data.AllergiesFlag.toUpperCase()!=='Y'){if(!checkUndefinedOrNullOrBlank(data.data.isASC,true)&&data.data.isASC.toLowerCase()==='true'){showIPMessage("<div class='text-left mt-24'><br/><b>Ordering Medications - Verify Allergies</b></br></br>Allergies have not been verified. Allergies must be verified prior to ordering medications.</div>",'','ErrorMsg','','','true')}else{showAlertMessage("<div class='text-left mt-24'><b>Ordering Medications - Verify Allergies</b><br/></br>Allergies have not been verified. Allergies must be verified prior to ordering medications.</div>",'','ErrorMsg')}return}isAllergyVerified=true;scope.checkAllergyVerifiedFlag=false;scope.qsDirectiveRowClickHanlder(oItem,event)})};let currMedsVerifiedCallbackBtn1="Bring forward patient's active medication list to Current Medication with the Previous Status";let currMedsVerifiedCallbackBtn2="Bring forward patient's active medication list to Current Medication with the Unknown Status";scope.CheckIfCurrMedsVerified=function(){if(isCurrMedsVerified()){let warningMsg="<b>Reconcile Current Medications</b></br></br>";warningMsg+="Records indicate that this patient may have been on some medication(s) which are not verified as of this encounter. One of the following actions is required to proceed further so that the patient's medication history is accurate.";let bottomNote="*To ensure that the current medication list is accurate and complete, go to Current Medications and perform medication reconciliation.";$timeout(function(){showAlertMessage(warningMsg,'','CustomConfirmMsg','currMedsVerifiedCallbackQSD','quick-search-textBox-'+scope.randNum,'650px',currMedsVerifiedCallbackBtn1,currMedsVerifiedCallbackBtn2,'reconcileMedCurrRxAlert',bottomNote)})}else{scope.m_bFirstRx=false;scope.saveRxFromQuickSearch()}};scope.currMedsVerifiedCallbackQSD=function(btnAction){let saveAsUnknown="";if(btnAction===currMedsVerifiedCallbackBtn2){saveAsUnknown="&saveAsUnknown=yes"}let url='/mobiledoc/jsp/catalog/xml/rx/copyCurrRx.jsp?ptid='+scope.nPatientId;url=url+'&encid='+scope.nEncounterId+'&encdate='+scope.encdateAddRx+'&enctime='+scope.enctimeAddRx+'&PopulateMeds=False'+saveAsUnknown;$.ajax({type:"POST",url:makeURL(url),data:"","async":false,success:function(msg){if(msg.indexOf('success')>-1){scope.m_bFirstRx=false;scope.saveRxFromQuickSearch()}else{ecwAlert("An error occured in Reconciling Current Medications")}},error:function(xhr){ecwAlert("An error occured in Reconciling Current Medications: "+xhr.status+" "+xhr.statusText)}})};scope.saveRxFromQuickSearch=function(){try{if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"){if(scope.selectedRxObject.nItemId!=undefined&&scope.selectedRxObject.nItemId!=""){if(!angular.isUndefined(scope.itemIdForMultumFormulary)&&scope.itemIdForMultumFormulary!==""&&scope.itemIdForMultumFormulary.length>0)scope.selectedRxObject.nItemId=scope.itemIdForMultumFormulary;else scope.selectedRxObject.nItemId=scope.selectedRxItemId}else{return}}else{if(scope.selectedRxObject.nItemId==undefined||scope.selectedRxObject.nItemId<=0){if(scope.selectedRxObject.ItemId!=undefined&&scope.selectedRxObject.ItemId!=""){scope.selectedRxObject.nItemId=scope.selectedRxObject.ItemId}else{return}}}if(angular.isUndefined(scope.selectedRxObject.nItemId)||scope.selectedRxObject.nItemId==null||scope.selectedRxObject.nItemId===""){alert("An error occured while adding medication, please try again later.");return}}catch(err){alert("An error occured while adding medication, please try again later.");return}if(scope.m_bFirstRx){scope.CheckIfCurrMedsVerified();return}var index=scope.selectedIndex;$("#searchBox").select();scope.rxPropertiesObj=getRxProperties();scope.strengthId=scope.rxPropertiesObj.Size;scope.formulationId=scope.rxPropertiesObj.Formulation;scope.takeId=scope.rxPropertiesObj.Take;scope.routeId=scope.rxPropertiesObj.Route;scope.frequencyId=scope.rxPropertiesObj.Frequency;scope.durationId=scope.rxPropertiesObj.Duration;scope.dispenseId=scope.rxPropertiesObj.Amount;scope.refillsId=scope.rxPropertiesObj.Refills;var obj=scope.dosageResultSet[index];if(scope.rtbcEligibilityFlag&&!scope.isRtbcPopupOpened&&scope.isMedMulEquiDrug&&obj.ndc!==''&&obj.ndc!==undefined&&obj.rxFormulary!=='Y'&&scope.showRtbcPopup&&scope.isValidDurationDispense(obj.duration)&&scope.isValidDurationDispense(obj.dispense)||scope.rtbcEligibilityFlag&&!scope.isRtbcPopupOpened&&scope.isMedMulEquiDrug&&obj.rxFormulary!=='Y'&&obj.ndc!==''&&obj.ndc!==undefined&&!scope.showRtbcPopup&&scope.isRtbcButtonClicked&&scope.isValidDurationDispense(obj.duration)&&scope.isValidDurationDispense(obj.dispense)){scope.isRtbcPopupOpened=true;scope.selectedEmrRxObject={};angular.copy(obj,scope.selectedEmrRxObject);scope.selectedEmrRxObject.nSelectedAssessmentId=scope.nSelectedAssessmentId;scope.selectedEmrRxObject.facilityId=scope.encfacilityId;scope.selectedEmrRxObject.showRtbcPopup=scope.showRtbcPopup;scope.selectedEmrRxObject.isRtbcButtonClicked=scope.isRtbcButtonClicked;rtbcService.openRtbcModalWindow(scope.nTrUserId,scope.nPatientId,scope.nEncounterId,scope.selectedEmrRxObject,scope.context);scope.isRtbcButtonClicked=false;return}else if(scope.rtbcEligibilityFlag&&scope.isRtbcPopupOpened){return}scope.saveRxData(obj)};scope.isValidDurationDispense=function(value){return rtbcService.isValidDurationDispense(value)};scope.updateFavoriteStatusForItem=function(orderItem){var sId="favIcon-"+orderItem.nItemId;var className=$('#'+sId).attr("class");if(className.indexOf("active")>-1)orderItem.nFavoriteFlag=0;else orderItem.nFavoriteFlag=1;orderItem.nTrUserId=scope.nTrUserId;var sRequestType="setFavoriteFlag";var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?ItemJsonObj="+encodeURIComponent(JSON.stringify(orderItem))+"&sRequestFrom="+scope.sRequestFrom+"&sRequestType="+sRequestType+"&rnd2="+Math.random();let responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data){updateFavoriteStatusForItemCallback(data,orderItem)})};let updateFavoriteStatusForItemCallback=function(data,orderItem){if(orderItem&&data&&data.favId>=0){orderItem.nFavoriteId=data.favId}if(data.status==='success'){$('#favIcon-'+orderItem.nItemId).toggleClass('active')}};scope.clearOrFavSearch=e=>{if(scope.context!=='dermExecScreen')return;if(document.getElementById('qs-fav-filter-'+scope.randNum)){let favFilterPositionStart=document.getElementById('qs-fav-filter-'+scope.randNum).getBoundingClientRect().x;if(e.clientX>favFilterPositionStart&&e.clientX<favFilterPositionStart+17){scope.setFavoriteFilterForQuickSearch();return}}if(document.getElementById('qs-clearable-'+scope.randNum)){let clearablePositionStart=document.getElementById('qs-clearable-'+scope.randNum).getBoundingClientRect().x;if(e.clientX>clearablePositionStart&&e.clientX<clearablePositionStart+5){scope.clearSearch()}}};scope.setFavoriteFilterForQuickSearch=function(){if(scope.qsFilterObj.FavoriteOrders==0)scope.qsFilterObj.FavoriteOrders=1;else scope.qsFilterObj.FavoriteOrders=0;scope.qsTextBoxKeyPress(true);scope.saveQuickSearchFilters('',true);quickSearchNS.setFocusOnSearchBox(scope.randNum,0)};scope.saveQuickSearchFilters=function(sRequestType,donotResetContains){quickSearchNS.hideDivBasedOnType(sRequestType);quickSearchNS.setFocusOnSearchBox(scope.randNum,0);scope.qsTextBoxKeyPress(donotResetContains);var sRequestType="saveQuickSearchFilter";var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?ItemJsonObj="+JSON.stringify(scope.qsFilterObj)+"&context="+scope.context+"&sRequestFrom=qsDirective&sRequestType="+sRequestType+"&rnd2="+Math.random();var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data,status,headers,config){updateUserProfileLocalCache("DefaultDrugDBLookUp",scope.qsFilterObj.RxDefaultListTypeId);updateUserProfileLocalCache("quickSearchRxDrugSearchType",scope.qsFilterObj.RxDrugSearchType);updateUserProfileLocalCache("quickSearchRxFormularyFilter",scope.qsFilterObj.nIsFormularyFilter);var userProfileKeyValPair={};userProfileKeyValPair["DefaultDrugDBLookUp"]=scope.qsFilterObj.RxDefaultListTypeId;saveUserProfileSettings(userProfileKeyValPair)});if(scope.context==="dermConfiScreen"){scope.qsFilterObj=scope.qsFilterObjBkp}};scope.checkForCCProviderLength=function(){if(!angular.isUndefined(scope.providerForCCResultsTo.providerList)&&scope.providerForCCResultsTo.providerList!=null&&scope.providerForCCResultsTo.providerList.length>5){showMessage("You cannot CC more than 5 providers.");scope.providerForCCResultsTo.providerList.length=5}};scope.loadDxListInQSD=function(){var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?QuickSearchFilterObj="+JSON.stringify(scope.qsrequestObj)+"&sRequestFrom=qsDirective&sRequestType=loadDxList&rnd2="+Math.random();var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data,status,headers,config){scope.qsDxList.Dx=data.Dx;scope.setDefaultsForQSDirective()})};quickSearchNS.checkIfDxExistForCurVisit=function(nDxItemId){var bDxExists=false;if(typeof scope.qsDxList.Dx!='undefined'&&scope.qsDxList.Dx.length>0){for(var i=0;i<scope.qsDxList.Dx.length;i++){if(scope.qsDxList.Dx[i].dxItemId==scope.nSelectedAssessmentId){bDxExists=true;break}}}return bDxExists};scope.chkAssessment=function(type,item){var assessmentSelected=false;if(type=="Assessment"){scope.nSelectedAssessmentId=item.dxItemId;scope.nSelectedAssessmentCode=item.dxItemCode;scope.nSelectedAssessmentName=item.dxItemName}else if(type=="ProblemList"){scope.nSelectedAssessmentId=item.itemid;scope.nSelectedAssessmentCode=item.itemcode;scope.nSelectedAssessmentName=item.itemname}else if(type=="PreviousAssessment"){scope.nSelectedAssessmentId=item.itemId;scope.nSelectedAssessmentCode=item.value;scope.nSelectedAssessmentName=item.name}for(var i=0;i<scope.qsDxList.Dx.length;i++){if(scope.qsDxList.Dx[i].dxItemId!=scope.nSelectedAssessmentId){scope.qsDxList.Dx[i].DirtyFlag="0"}else{scope.qsDxList.Dx[i].DirtyFlag="1";assessmentSelected=true}}for(var i=0;i<scope.qsDxList.probListDx.length;i++){if(scope.qsDxList.probListDx[i].itemid!=scope.nSelectedAssessmentId){scope.qsDxList.probListDx[i].DirtyFlag="0"}else{scope.qsDxList.probListDx[i].DirtyFlag="1";assessmentSelected=true}}for(var i=0;i<scope.qsDxList.prevDx.length;i++){if(scope.qsDxList.prevDx[i].itemId!=scope.nSelectedAssessmentId){scope.qsDxList.prevDx[i].DirtyFlag="0"}else{scope.qsDxList.prevDx[i].DirtyFlag="1";assessmentSelected=true}}var dxObj={sRequestType:'setDxDetails',DxId:scope.nSelectedAssessmentId,DxCode:scope.nSelectedAssessmentCode};scope.setDataInParentScreen('setDxDetails',dxObj);return assessmentSelected};scope.setDefaultAssessment=function(){if(typeof scope.qsDxList.Dx!='undefined'&&scope.qsDxList.Dx.length>0){for(var i=0;i<scope.qsDxList.Dx.length;i++){if(scope.qsDxList.Dx[i].dxItemId!=scope.nSelectedAssessmentId){scope.qsDxList.Dx[i].DirtyFlag="0"}else{scope.qsDxList.Dx[i].DirtyFlag="1";scope.nSelectedAssessmentName=scope.qsDxList.Dx[i].dxItemName;scope.nSelectedAssessmentCode=scope.qsDxList.Dx[i].dxItemCode}}}if(typeof scope.qsDxList.probListDx!='undefined'&&scope.qsDxList.probListDx.length>0){for(var i=0;i<scope.qsDxList.probListDx.length;i++){if(scope.qsDxList.probListDx[i].itemid!=scope.nSelectedAssessmentId){scope.qsDxList.probListDx[i].DirtyFlag="0"}else{scope.qsDxList.probListDx[i].DirtyFlag="1";scope.nSelectedAssessmentName=scope.qsDxList.probListDx[i].itemname;scope.nSelectedAssessmentCode=scope.qsDxList.probListDx[i].itemcode}}}if(typeof scope.qsDxList.prevDx!='undefined'&&scope.qsDxList.prevDx.length>0){for(var i=0;i<scope.qsDxList.prevDx.length;i++){if(scope.qsDxList.prevDx[i].itemId!=scope.nSelectedAssessmentId){scope.qsDxList.prevDx[i].DirtyFlag="0"}else{scope.qsDxList.prevDx[i].DirtyFlag="1";scope.nSelectedAssessmentName=scope.qsDxList.prevDx[i].name;scope.nSelectedAssessmentCode=scope.qsDxList.prevDx[i].value}}}};scope.setStOrdersFromQSDirective=function(sOrderItem){scope.sOrderDtForStandingOrd=sOrderItem};scope.setStOrdersFromQSD=function(){var sItemName=scope.sOrderDtForStandingOrd.sItemName;var sObjData={nPatientId:scope.nPatientId,nTrUserId:scope.nTrUserId,nEncounterId:scope.nEncounterId,oStadingOrderObj:scope.stOrderDtObj.obj.oOrderDates,nItemId:scope.sOrderDtForStandingOrd.nItemId,nDxId:scope.nSelectedAssessmentId,sType:scope.sOrderDtForStandingOrd.sKeyname};if(scope.context=="ascOrdersScreen"){sObjData.loginUserType=global.loginUserType;sObjData.orderingProvider=scope.qsrequestObj.orderFor;sObjData.orderNoteType=scope.qsrequestObj.noteType;sObjData.sKeyname=scope.sOrderDtForStandingOrd.sKeyname;sObjData.sIsFuture=true;sObjData.orderProtocolType=scope.qsrequestObj.protocolType!=undefined?scope.qsrequestObj.protocolType:0}var sRequestType="standingOrdersForLabDIProcedures";var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?ItemJsonObj="+JSON.stringify(sObjData)+"&sRequestFrom=qsDirective&sRequestType="+sRequestType+"&rnd2="+Math.random();var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data,status,headers,config){var jsonData=data;if(jsonData!=null&&jsonData!=undefined&&jsonData.status!=undefined){var sStatus="";var OrderStatObj={sRequestType:'neworder',sStatus:'',sOrderName:sItemName,sFailedReason:''};sStatus=jsonData.status;if(sStatus=='success'||sStatus=='failed'){if(sStatus=='success'){OrderStatObj.sStatus='success';var sExistingOrderDates=jsonData.sExistingOrderDates;if(sExistingOrderDates.length>0){}else{}scope.setDataInParentScreen('neworder',OrderStatObj)}else if(sStatus=='failed'){if(jsonData.sExistingOrderDates&&jsonData.sExistingOrderDates.length>0){showMessage("Order on "+jsonData.sExistingOrderDates+" already exists. ")}else{showMessage("Error occured while placing standing orders for Lab/DI/Procedures.")}OrderStatObj.OrderStatObj='failed';scope.setDataInParentScreen('neworder',OrderStatObj)}}}})};scope.addNewReasonToCreateRefObj=function(){var nReasonId=scope.oCreateRefObj.referralReasonDt.length;var sObj={sReason:"",id:nReasonId+1};scope.oCreateRefObj.referralReasonDt.push(sObj)};scope.removeReasonFromCreateRefObj=function(nId){var objReason=scope.oCreateRefObj.referralReasonDt;var nCount=-1;if(objReason.length>4){for(var k=0;k<objReason.length;k++){if(objReason[k].id==nId){objReason.splice(k,1);nCount=nId}if(nCount>-1){if(k<objReason.length){objReason[k].id=nCount;nCount++}}}if(nCount>-1)scope.oCreateRefObj.referralReasonDt=objReason}else{for(var k=0;k<objReason.length;k++){if(objReason[k].id==nId){objReason[k].sReason="";k=objReason.length;break}}scope.oCreateRefObj.referralReasonDt=objReason}};scope.clearReferral=function(){quickSearchNS.showQSDiv(scope.randNum);scope.RefAssingToNameData=quickSearchNS.getDefaultStaffObjForQSD();scope.setToDefaultValue()};scope.setToDefaultValue=function(){scope.oCreateRefObj=quickSearchNS.getDefaultParamsForQSD('createReferral');scope.RefToProviderNameData=quickSearchNS.getDefaultProviderObjForQSD();scope.setAssignToDefaultForReferral();scope.hideReferral()};scope.hideReferral=function(){var id="#icon-blackreferal-"+scope.randNum;if($(id).hasClass('active')){$(id).removeClass('active')}scope.oCreateRefObj.nSpecialityId=0};scope.setAssignToDefaultForReferral=function(){scope.oCreateRefObj.assignToProviderDt.staff.id=scope.qsFilterObj.DefaultAssingReferralToId;scope.oCreateRefObj.assignToProviderDt.staff.name=scope.qsFilterObj.DefaultAssingReferralToName;scope.RefAssingToNameData.staff.id=scope.qsFilterObj.DefaultAssingReferralToId;scope.RefAssingToNameData.staff.name=scope.qsFilterObj.DefaultAssingReferralToName};scope.setRefToProviderDt=function(){scope.oCreateRefObj.refToProviderDt.provider.Name=scope.RefToProviderNameData.provider.Name;scope.oCreateRefObj.refToProviderDt.provider.Id=scope.RefToProviderNameData.provider.Id;scope.oCreateRefObj.refToProviderDt.provider.P2PNPI=scope.RefToProviderNameData.provider.P2PNPI};scope.clearRefToProviderDt=function(){scope.oCreateRefObj.refToProviderDt.provider.Name="";scope.oCreateRefObj.refToProviderDt.provider.Id=0};scope.setAssignRefTo=function(){scope.oCreateRefObj.assignToProviderDt.staff.id=scope.RefAssingToNameData.staff.id;scope.oCreateRefObj.assignToProviderDt.staff.name=scope.RefAssingToNameData.staff.name};scope.clearAssignRefTo=function(){scope.oCreateRefObj.assignToProviderDt.staff.id=0;scope.oCreateRefObj.assignToProviderDt.staff.name=""};scope.setDefaultAssignToForReferral=function(id,name){scope.oCreateRefObj.assignToProviderDt.staff.id=id;scope.oCreateRefObj.assignToProviderDt.staff.name=name;scope.RefAssingToNameData.staff.id=id;scope.RefAssingToNameData.staff.name=name};scope.validateReferralDetail=function(orderItem){if(PRE_VISIT_PLANNING_CONTEXT!==scope.context&&$.trim(scope.referralMandatoryFields['Assigned To']).toLowerCase()==='y'&&orderItem.AssignToId<=0){quickSearchNS.showOrdStatus("Assign Referral To is mandatory",'failed',scope.randNum,1);return false}else if($.trim(scope.referralMandatoryFields['Reason']).toLowerCase()==='y'&&orderItem.referralReasonDt){var isReasonAvailable=false;for(var index=0;index<orderItem.referralReasonDt.length;index++){if(orderItem.referralReasonDt[index].sReason.length>0){isReasonAvailable=true;break}}if(!isReasonAvailable){quickSearchNS.showOrdStatus("Reason is mandatory",'failed',scope.randNum,1);return false}}return true};scope.createReferral=function(event){var sReferralTo="";if(scope.oCreateRefObj.refToProviderDt.provider.Id>0||scope.oCreateRefObj.nSpecialityId>0){var orderItem=scope.oCreateRefObj;if(scope.oCreateRefObj.nSpecialityId>0){for(var k=0;k<scope.qsCommonJSONObj.specialityList.length;k++){if(scope.qsCommonJSONObj.specialityList[k].Id==scope.oCreateRefObj.nSpecialityId){sReferralTo="Referral to "+scope.qsCommonJSONObj.specialityList[k].Speciality;break}}}if(orderItem.referralReasonDt&&orderItem.referralReasonDt.length>0){let isValid=refReasonValidationService.validateReferralReasons(orderItem.referralReasonDt,refReasonValidationService.refReasonValidationConstant.QS_REF_REASON_DIV_ID,refReasonValidationService.refReasonValidationConstant.QS_SCREEN_NAME,refReasonValidationService.refReasonValidationConstant.QS_REF_REASON_PARENT_DIV_ID,refReasonValidationService.refReasonValidationConstant.BLUE_THEME);if(!isValid){return false}}orderItem.ReferralToId=scope.oCreateRefObj.refToProviderDt.provider.Id;if(scope.oCreateRefObj.refToProviderDt.provider.Id>0){sReferralTo="Referral to "+scope.oCreateRefObj.refToProviderDt.provider.Name}var nAssingToId=0;if(scope.RefAssingToNameData.staff!=null&&scope.RefAssingToNameData.staff!=undefined&&scope.RefAssingToNameData.staff.id!=undefined){if(scope.RefAssingToNameData.staff.id>0){nAssingToId=scope.RefAssingToNameData.staff.id}}orderItem.attachDefaults=1;orderItem.AssignToId=nAssingToId;orderItem.nDxId=scope.nSelectedAssessmentId;orderItem.sDxCode=scope.nSelectedAssessmentCode;orderItem.nEncounterId=scope.nEncounterId;orderItem.nPatientId=scope.nPatientId;orderItem.nTrUserId=scope.nTrUserId;orderItem.nDoctorId=scope.qsrequestObj.nDoctorId;orderItem.refToNPI=scope.oCreateRefObj.refToProviderDt.provider.P2PNPI;orderItem.refToName=scope.oCreateRefObj.refToProviderDt.provider.Name;orderItem.sRequestType="createReferral";orderItem.timeZone=getTZ();orderItem.timeZoneName=getTZName();orderItem.browserTime=getBrowserTime();orderItem.visitAllow=getUserProfile("Default_Referral_visits");if(scope.context=="ascOrdersScreen"){orderItem.loginUserType=global.loginUserType;orderItem.orderingProvider=scope.qsrequestObj.orderFor;orderItem.orderNoteType=scope.qsrequestObj.noteType;orderItem.sKeyname="referrals";if(scope.qsrequestObj.protocolType!=undefined){orderItem.orderProtocolType=scope.qsrequestObj.protocolType}}if(!scope.validateReferralDetail(orderItem)){return}if(PRE_VISIT_PLANNING_CONTEXT===scope.context){orderItem.sFutureDate=scope.qsFilterObj.sFutureDate;quickSearchNS.savePreplanningOrders(orderItem);return}if(!orderItem.AssignToId){quickSearchNS.showOrdStatus("The Assigned To field cannot be left blank. Please assign a staff or provider.",'failed',scope.randNum,1,500);return false}var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp";var responsePromise=$http.post(makeURL(strUrl),"QSDirectiveObj="+encodeURIComponent(JSON.stringify(orderItem))+"&sRequestFrom="+scope.sRequestFrom+"&sRequestType=createReferral&rnd2="+Math.random());responsePromise.success(function(data,status,headers,config){var jsonData=data;if(jsonData!=null&&jsonData!=undefined&&jsonData.status!=undefined){if(jsonData.status=="success"){var OrderStatObj={sRequestType:'neworder',sStatus:'',sOrderName:"Referral to - "+scope.oCreateRefObj.refToProviderDt.provider.Name,sFailedReason:''};scope.selectedOrderItemKeyName='referral';OrderStatObj.sStatus='success';quickSearchNS.showOrdStatus(sReferralTo,'success',scope.randNum,scope.nShowInPlaceAlertStatus);scope.setDataInParentScreen('neworder',OrderStatObj);if(scope.context==='SunohQuickOrders'){refreshDashboard(scope.nEncounterId,scope.nPatientId,"","pn")}}}});if(event&&$(event.currentTarget).closest("#quickSunohQuickSearchLookup").length===0){scope.clearReferral()}else{scope.setToDefaultValue()}}else{quickSearchNS.showOrdStatus("Specialty or Provider is mandatory",'failed',scope.randNum,1,290)}scope.hideReferral()};scope.referral={};scope.referral.refFromRegNHX=0;scope.openRefToProviderList=function(){scope.parentName="quickReferral";var params={fromWebPage:'true',referralId:0,patientId:scope.nPatientId,refFromProvId:scope.qsrequestObj.nDoctorId,FromP2PNPI:scope.qsCommonJSONObj.refFromP2PNPI};var queryParams=$.param(params);$ocLazyLoad.load(refToLookupModuleDependencyService.getModule()).then(function(){scope.selRefToProvURL=makeURL(refToLookupModuleDependencyService.getModalURL()+"?"+queryParams)},function(e){console.log(e)})};scope.clearRefToProvider=function(){scope.RefToProviderNameData.provider={Id:0,Name:''};scope.setRefToProviderDt()};scope.setReferralToProvider=function(referralProvider){scope.RefToProviderNameData.provider.Id=referralProvider.id;scope.RefToProviderNameData.provider.Name=referralProvider.name;scope.RefToProviderNameData.provider.P2PNPI=referralProvider.NPI;scope.bSpecialitySelected=false;angular.forEach(scope.qsCommonJSONObj.specialityList,function(specialityObj){if(specialityObj.Speciality==referralProvider.speciality){scope.oCreateRefObj.nSpecialityId=specialityObj.Id+"";scope.bSpecialitySelected=true}});if(!scope.bSpecialitySelected){scope.oCreateRefObj.nSpecialityId=0}scope.setRefToProviderDt()};scope.getOrderCategory=item=>{let categories={'rx':'Medication','rxmedispan':'Medication','rxcims':'Medication','labreports':'Labs','xrays':'DI','procedures':'Procedure\t'};if(categories[item.sKeyname]){return categories[item.sKeyname]}return{'immunizations':'Immunization','injections':'Therapeutic Injection'}[item.itemType]};scope.qsTextBoxKeyPress=function(donotResetContains){scope.visitedOrderType={};if(!donotResetContains)scope.qsFilterObj.nContainsSearch=0;if(scope.topClass==="editLabDIProcSunohPopup"){scope.qsFilterObj.nContainsSearch=1}try{if(!$('#newTreatmentURL').find('#'+scope.copyIdForInline).length){var newScope=angular.element('#inlinetreatment').scope();if(newScope)newScope.closeInlineEdit()}}catch(e){}scope.futureOrd.nShowFutureOrdItemsOpt=1;scope.searchOrdersList=[];var sSearchString=scope.qsFilterObj.sQuickSearchText+"";if(scope.context=="dermExecScreen"){if(scope.qsrequestObj.assessments!=null&&scope.qsrequestObj.assessments.length>0){for(var index in scope.qsrequestObj.assessments){scope.nSelectedAssessmentId=scope.qsrequestObj.assessments[index].assessmentid;scope.nSelectedAssessmentCode=scope.qsrequestObj.assessments[index].assessmentcode;if(scope.chkAssessment()){break}}}}else if(scope.context==="dermConfiScreen"||scope.context==="ImmTherapeuticInjections"){scope.qsFilterObjBkp=angular.copy(scope.qsFilterObj);scope.qsFilterObj.RxOrders="1";scope.qsFilterObj.LabOrders="0";scope.qsFilterObj.DIOrders="0";scope.qsFilterObj.ProcedureOrders="0";scope.qsFilterObj.ImmInjOrders="0"}else if(PRE_VISIT_PLANNING_CONTEXT===scope.context){if(IMMUNIZATION_SCREEN.indexOf(scope.qsrequestObj.callingImmOrInjItemSource)!==-1){scope.qsFilterObj.RxOrders="0";scope.qsFilterObj.LabOrders="0";scope.qsFilterObj.DIOrders="0";scope.qsFilterObj.ProcedureOrders="0";scope.qsFilterObj.ImmInjOrders="1";scope.qsFilterObj.dxOrders="0";scope.qsFilterObj.templateFlag="0";scope.qsFilterObj.orderSetFlag="0"}else{scope.qsFilterObj.RxOrders="0";scope.qsFilterObj.LabOrders="1";scope.qsFilterObj.DIOrders="1";scope.qsFilterObj.ProcedureOrders="1";scope.qsFilterObj.ImmInjOrders="1"}}else if(MEASURE_MAPPING===scope.context){scope.qsFilterObj.RxOrders="0";scope.qsFilterObj.LabOrders="1";scope.qsFilterObj.DIOrders="1";scope.qsFilterObj.ProcedureOrders="1";scope.qsFilterObj.ImmInjOrders="0"}else if("FHIRTreatment"===scope.context){scope.qsFilterObj.RxOrders="1";scope.qsFilterObj.LabOrders="0";scope.qsFilterObj.DIOrders="0";scope.qsFilterObj.ProcedureOrders="0";scope.qsFilterObj.ImmInjOrders="0"}else if(scope.topClass==="editLabDIProcSunohPopup"){if(scope.qsrequestObj.onlyImm){scope.qsFilterObj.RxOrders="0";scope.qsFilterObj.LabOrders="0";scope.qsFilterObj.DIOrders="0";scope.qsFilterObj.ProcedureOrders="0";scope.qsFilterObj.ImmInjOrders="1"}}else if(scope.topClass==="sunohRxOrderClass"){scope.qsFilterObj.RxOrders="1";scope.qsFilterObj.LabOrders="0";scope.qsFilterObj.DIOrders="0";scope.qsFilterObj.ProcedureOrders="0";scope.qsFilterObj.ImmInjOrders="0";scope.qsFilterObj.EMSEnabled="true"}quickSearchNS.showHideQSDirectiveDivs(sSearchString,scope.randNum,scope.qsdLeftAlignAndSmall);if(sSearchString.length>=2)obj=scope.getQuickOrderSearchResults();else{scope.qsFilterObj.nContainsSearch=scope.topClass!=="editLabDIProcSunohPopup"?0:1}scope.hideTopAndBottomArrows('container');if(scope.context==="ImmTherapeuticInjections"||scope.context===MEASURE_MAPPING){quickSearchNS.showQSDiv(scope.randNum)}};scope.hideTopAndBottomArrows=function(container){var containerId=container+'-'+nRandomNumForQSD;if(scope.nCheckHideOfTopAndBottomArrows==0){if($('#'+containerId).length){var sHeight=$('#'+containerId).height();if(sHeight>0&&sHeight<340){$('#qsd-top-navigation-arrow-'+scope.randNum).addClass('hide');$('#qsd-bottom-navigation-arrow-'+scope.randNum).addClass('hide');$('#qsd-fav-top-navigation-arrow-'+scope.randNum).addClass('hide');$('#qsd-fav-bottom-navigation-arrow-'+scope.randNum).addClass('hide')}}scope.nCheckHideOfTopAndBottomArrows=1}};scope.loadMoreData=function(){if(scope.isMoreData){scope.getQuickOrderSearchResults(true)}};scope.getQuickOrderSearchResults=function(isScrollToEnd){if(scope.topClass!=="sunohRxOrderClass"&&(typeof scope.patientVitalData==='undefined'||scope.patientVitalData===null||Object.keys(scope.patientVitalData).length===0&&scope.patientVitalData.constructor===Object)){scope.loadPatientVitals(scope.nEncounterId,scope.nPatientId,true);return}$('#qsd-second-level-rxDiv-'+scope.randNum).addClass('hide');if(timer&&timer!=''){$timeout.cancel(timer)}scope.qsFilterObj.visitedOrderType=isScrollToEnd?scope.visitedOrderType:{};scope.checkAllergyVerifiedFlag=true;if(!isLoading){timer=$timeout(function(){if(filterType=="smartorder"&&scope.context&&scope.context=="dermExecScreen"){scope.getDermFavResultSet(scope.qsFilterObj.sQuickSearchText);filterType=""}else{isLoading=true;if(scope.bDispenseInventoryLinkEnabled){scope.qsFilterObj.facilityId=scope.encfacilityId}scope.qsFilterObj.RxDrugSearchType=getUserProfile('quickSearchRxDrugSearchType')+'';if(scope.qsFilterObj.RxDrugSearchType===''||scope.qsFilterObj.RxDrugSearchType==='0'||scope.qsFilterObj.RxDrugSearchType===0){scope.qsFilterObj.RxDrugSearchType='1'}var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp";if(scope.showDiscontinuedDrugs===-1){scope.qsFilterObj.ShowDiscontinuedDrugs="1"}else{scope.qsFilterObj.ShowDiscontinuedDrugs="0"}scope.qsFilterObj.callingImmOrInjItemSource=scope.qsrequestObj.callingImmOrInjItemSource;let qsParamFilterObj=scope.qsFilterObj;if(scope.topClass==="editLabDIProcSunohPopup"&&!scope.qsrequestObj.onlyImm){qsParamFilterObj=angular.copy(scope.qsFilterObj);qsParamFilterObj.RxOrders="0";qsParamFilterObj.ImmInjOrders="0"}var data=$.param({'QuickSearchFilterObj':JSON.stringify(qsParamFilterObj),'sRequestFrom':'qsDirective','sRequestType':'getQSResults','rnd2':Math.random()});if(scope.context=="ascOrdersScreen"){var requestParams=_.clone(scope.qsFilterObj);requestParams.ImmInjOrders=0;strUrl="/mobiledoc/ascWeb/ASC/PnIpOrders.go/Orders/loadASCOrders";data=$.param({'sRequestFrom':scope.context,'sRequestType':'getQSResultsForASC','actionType':'processQuickSearchOrder','reqParam':JSON.stringify(requestParams)})}var responsePromise=$http.post(makeURL(strUrl),data,{headers:{'Content-Type':'application/x-www-form-urlencoded'}});responsePromise.success(function(data,status,headers,config){if(data!=null&&!angular.equals({},data)){scope.isMoreData=!_.isEmpty(data.encData);if(isScrollToEnd){scope.searchOrdersList.push(...data.encData)}else{scope.searchOrdersList=data.encData}scope.visitedOrderType=data.visitedOrderType;if(scope.isPAMAActionRequired){updatePAMAActions()}if(!scope.hasFormularyCheckDone){scope.getRxFormulary()}}});isLoading=false}},800)}};var updatePAMAActions=function(){var diCPTItemLength=scope.diCPTItems.length;var labDIOrdersLength=scope.searchOrdersList.length;for(var index=0;index<labDIOrdersLength;index++){var cptMatched=false;for(var index1=0;index1<diCPTItemLength;index1++){if(_.trim(scope.searchOrdersList[index].nItemId)===_.trim(scope.diCPTItems[index1].itemId)){cptMatched=true;break}}if(!cptMatched){scope.searchOrdersList[index].pamaClass="no-cpt";scope.searchOrdersList[index].pamaTitle="Order lacks CPT mapping. Please map in DI compendium. AUC will not perform."}}};scope.updateDosageListForInjection=function(){if(scope.context==="ImmTherapeuticInjections"){scope.dosageResultSet=scope.prioritizeInjectableDosages(scope.dosageResultSet)}};scope.prioritizeInjectableDosages=function(medicationDosages){var injectableDosages=[];var otherDosages=[];if(medicationDosages&&medicationDosages.length>1){medicationDosages.forEach(function(dose){if(dose.route==="Injection"){injectableDosages.push(dose)}else{otherDosages.push(dose)}});return injectableDosages.concat(otherDosages)}return medicationDosages};function isNotSupplies(drugNameID){if(drugNameID!=="9999999"&&drugNameID!==9999999)return true;return false}scope.getDosage=function(drugNameID,itemID,RxType,rxObj,calledFrom){scope.dosageResultSet=[];scope.showLoadingImage();if(scope.isRtbcServiceEnabled){scope.isMedMulEquiDrug=rtbcService.checkMedispanMultumEquipmentSupply(scope.selectedRxObject.nParentID)}if(scope.b_MedispanEnabled=="no"){scope.showDiscontinuedRxIcon=false;scope.showObsoleteMessage=false;var url='/mobiledoc/jsp/catalog/xml/getDosesForRx.jsp?RxType='+RxType+'&rxId='+itemID+'&bObsolete='+scope.showDiscontinuedDrugs;if(scope.b_enabledFormulary&&scope.isShowFormularyFilter()){url+="&facilityID="+scope.encfacilityId+"&viewFormulary="+scope.b_viewFormulary}if(scope.bDispenseInventoryLinkEnabled){url=url+"&facilityId="+scope.encfacilityId}if(scope.selectedRxObject.nParentID!=scope.MultumId&&!scope.b_ShowMultumDosesFormCustom){url=url+"&multumDoses=0"}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.updateDosageListForInjection();scope.setDosageCalcCombos();if(scope.b_enabledFormulary){scope.isContainformularyRx=scope.isDoseContainFormularyRxDose()}}scope.getDoseCallBack(calledFrom,rxObj);scope.hideLoadingImage()});promise.error(function(error,status){scope.hideLoadingImage()})}else{if(scope.selectedRxObject.nParentID==scope.MedispanId||drugNameID>0&&isNotSupplies(drugNameID)||scope.selectedRxObject.nParentID==scope.compoundRxId){scope.showDiscontinuedRxIcon=false;scope.showObsoleteMessage=false;var url='/mobiledoc/jsp/ecwrx/getDoses.jsp?RxType='+RxType+'&dnid='+drugNameID+'&ItemId='+itemID+'&bObsolete='+scope.showDiscontinuedDrugs;if(scope.enableDOCFormulary&&scope.enableCorrectionalFeatures){url='/mobiledoc/jsp/Corrections/formulary/getDoses.jsp?RxType='+RxType+'&dnid='+drugNameID+'&ItemId='+itemID+'&bObsolete='+scope.showDiscontinuedDrugs}if(scope.b_enabledFormulary&&scope.isShowFormularyFilter()){url+="&facilityID="+scope.encfacilityId+"&viewFormulary="+scope.b_viewFormulary+"&formularyFilter="+scope.qsFilterObj.nIsFormularyFilter}if(scope.bDispenseInventoryLinkEnabled){url=url+"&facilityId="+scope.encfacilityId}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('status')&&jsonobj.Envelope.Body['return'].status==='failed'){scope.dosageResultSet.errorMessage=jsonobj.Envelope.Body['return'].errormsg;scope.dosageResultSet.status='failed'}if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.updateDosageListForInjection();scope.setDosageCalcCombos();if(scope.b_enabledFormulary){scope.isContainformularyRx=scope.isDoseContainFormularyRxDose()}try{if(scope.dosageResultSet.length===0&&jsonobj.Envelope.Body["return"].hasOwnProperty("showObsoleteMessage")){var val=jsonobj.Envelope.Body["return"]['showObsoleteMessage'];scope.showObsoleteMessage=val==="yes"?true:false}}catch(e){}}else{scope.showObsoleteMessage=false;if(scope.b_enabledFormulary&&scope.isShowFormularyFilter()&&(scope.qsFilterObj.nIsFormularyFilter===1||scope.qsFilterObj.nIsFormularyFilter==='1')){alert("No eMAR doses have been setup for this drug in the formulary. Please uncheck the filter to see other doses.")}}scope.getDoseCallBack(calledFrom,rxObj);scope.hideLoadingImage()});promise.error(function(error,status){scope.hideLoadingImage()})}else{var url='/mobiledoc/jsp/ecwrx/getCustomDoses.jsp?RxType='+RxType+'&itemid='+itemID+'&dnid='+drugNameID+'&trUserId='+global.TrUserId;if(scope.bDispenseInventoryLinkEnabled){url=url+"&facilityId="+scope.encfacilityId}if(scope.b_enabledFormulary&&scope.isShowFormularyFilter()){url+="&facilityID="+scope.encfacilityId+"&viewFormulary="+scope.b_viewFormulary+"&formularyFilter="+scope.qsFilterObj.nIsFormularyFilter+"&context="+scope.context}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.updateDosageListForInjection();scope.setDosageCalcCombos();if(scope.b_enabledFormulary){scope.isContainformularyRx=scope.isDoseContainFormularyRxDose()}}scope.showHideLevel2Div('show');scope.hideLoadingImage()});promise.error(function(error,status){scope.hideLoadingImage()})}}};scope.isDoseContainFormularyRxDose=function(){if(scope.dosageResultSet&&scope.dosageResultSet.length>0){for(let i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].rxFormulary&&scope.dosageResultSet[i].rxFormulary.toUpperCase()==='Y'){return true}}}return false};scope.getPriceFromCloud=function(drugName,facilityState,facilityCity,calledFrom){var url="/mobiledoc/jsp/webemr/progressnotes/ecwrx/currMedWeb/getCloudData.jsp?";var param='{"query":{"bool":{ "must":[ {"match":{"NPPES_PROVIDER_STATE":"'+facilityState.toUpperCase()+'"}}, {"match":{"DRUG_NAME":"'+drugName.toUpperCase()+'"}}, {"match":{"NPPES_PROVIDER_CITY":"'+facilityCity.toUpperCase()+'"}}]}},"aggs" : {"day_supply":{"sum" : { "field" : "TOTAL_DAY_SUPPLY"}},"Total_Cost":{"sum" :{"field" : "TOTAL_DRUG_COST"}}}}';$http.post(url,param).success(function(data){if(calledFrom=='Generic'){scope.genericPrice.totalDays=data.aggregations.day_supply.value;scope.genericPrice.totalCost=data.aggregations.Total_Cost.value;scope.genericPrice.costPerDay=scope.genericPrice.totalCost/scope.genericPrice.totalDays;scope.genericPrice.costPerDay=Math.round(scope.genericPrice.costPerDay*100)/100}else{scope.drugPrice.totalDays=data.aggregations.day_supply.value;scope.drugPrice.totalCost=data.aggregations.Total_Cost.value;scope.drugPrice.costPerDay=scope.drugPrice.totalCost/scope.drugPrice.totalDays;scope.drugPrice.costPerDay=Math.round(scope.drugPrice.costPerDay*100)/100}})};scope.showLoadingImage=function(){document.getElementById("divDrugOrderDosageLoading").style.display=""};scope.hideLoadingImage=function(){document.getElementById("divDrugOrderDosageLoading").style.display="none";$(window).resize()};scope.selectGeneric=function($event,item){var sSynonymId="";if(scope.b_MedispanEnabled==="no"){scope.selectedRxObject.sItemName=item.drugName}else{scope.selectedRxObject.sItemName=item.itemName}scope.selectedRxObject.nItemId=item.ItemId;scope.selectedRxObject.sDrugNameId=item.DrugId;scope.selectedRxObject.sSupplierId=item.DrugId;scope.qsDirectiveRowClickHanlder(scope.selectedRxObject,$event);$('#quick-search-textBox-'+nRandomNumForQSD).val(scope.selectedRxObject.sItemName);scope.genericEquivalent=[]};var bAlreadyCalled=false;scope.IsMedOrderingForPastVist=function(obj){var bIsMedOrderingForPastVist=false;var encounterDateofPN;var todayDate;try{encounterDateofPN=new Date(validateAndConvertDate(scope.encdateAddRx));if(scope.enctimeAddRx!=undefined&&scope.enctimeAddRx!=""){var timeUnits=[];timeUnits=scope.enctimeAddRx.split(":");encounterDateofPN.setHours(timeUnits[0]);encounterDateofPN.setMinutes(timeUnits[1]);encounterDateofPN.setSeconds(timeUnits[2])}todayDate=new Date;todayDate.setHours(0);todayDate.setMinutes(0);todayDate.setSeconds(0)}catch(e){encounterDateofPN=new Date(scope.encdateAddRx);encounterDateofPN=encounterDateofPN.toUTCString();todayDate=new Date;todayDate=todayDate.toUTCString()}if(scope.ShowMessageForPastVisitItemKey.toLowerCase()=="yes"&&!scope.dosageResultSet[obj].isCallFromePA){if(todayDate>encounterDateofPN){if(bAlreadyCalled)return true;var warningMsg="<b>Warning - Adding Medications to Past Encounter</b></br></br>Medications added to past encounters may not reflect in the active medication list or the ICW (Right Chart Panel) and may need to be reconciled in subsequent encounters. Interaction checks will only consider medications from this encounter and Medications as of Today on the ICW. Would you like to proceed with ordering this medication?";showAlertMessage(warningMsg,'','ConfirmMsg','showMsgForPastVisitConfirm','quick-search-textBox-'+scope.randNum);scope.showMsgForPastVisitConfirm=function(btnAction){if(!angular.isUndefined(btnAction)&&btnAction!==null&&btnAction.toLowerCase()==='yes'){bAlreadyCalled=true;scope.selectDosage(obj);bIsMedOrderingForPastVist=true}}}else{bIsMedOrderingForPastVist=true}}else{bIsMedOrderingForPastVist=true}return bIsMedOrderingForPastVist};scope.getRxandDx=function(encid,ptId,DxId,trUserId,callBackFunction){scope.OrdersForEnc=[];var promisegetRxandDx=rxService.getRxandDxinRxService(encid,ptId,trUserId);promisegetRxandDx.then(function(payload){scope.m_bFirstRx=true;var x2js=new X2JS;var jsonobj=x2js.xml_str2json(payload.data.trim());if(typeof jsonobj!="undefined"||jsonobj!=null||jsonobj.Envelope.Body['return'].hasOwnProperty("Dx")){if(jsonobj.Envelope.Body['return'].Dx.length>0){scope.OrdersForEnc=jsonobj.Envelope.Body['return'].Dx}else{scope.OrdersForEnc.push(jsonobj.Envelope.Body['return'].Dx);if(typeof scope.OrdersForEnc[0].Rx=="object"){}}}try{if(typeof scope.OrdersForEnc!="undefined"&&scope.OrdersForEnc!=null){for(var i=0;i<scope.OrdersForEnc.length;i++){if(scope.OrdersForEnc[i].hasOwnProperty("Rx")){scope.m_bFirstRx=false;break}}}if(callBackFunction==='selectDosage'){scope.selectDosage(scope.selectedIndex)}else if(callBackFunction==='addWithoutSig'){scope.addWithoutSig()}}catch(e){}},function(error){})};scope.loadFormularyRxDoses=function(nSynonymId,itemID,RxType){if(scope.isEpaServiceEnabled){scope.isRxEligibilitySuccessful=true}scope.dosageResultSet=[];if(scope.b_MedispanEnabled==="no"){scope.showDiscontinuedRxIcon=false;scope.showObsoleteMessage=false;var url='/mobiledoc/jsp/catalog/xml/RxHub/getFormularyDosesForRx.jsp?RxType='+RxType+'&synonymId='+nSynonymId+'&itemid='+itemID+"&DrugName="+scope.selectedRxName;if(scope.b_enabledFormulary&&scope.isShowFormularyFilter()){url+="&facilityID="+scope.encfacilityId+"&viewFormulary="+scope.b_viewFormulary}if(scope.selectedRxObject.nParentID!==scope.MultumId&&!scope.b_ShowMultumDosesFormCustom){url=url+"&multumDoses=0"}url=url+"&calledFrom=10eWEB&trUserId="+global.TrUserId;var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDataForFormulary();scope.setDosageCalcCombos();if(scope.b_enabledFormulary){scope.isContainformularyRx=scope.isDoseContainFormularyRxDose()}}scope.showHideLevel2Div('show')})}else{if(scope.selectedRxObject.nParentID==scope.MedispanId||nSynonymId>0&&isNotSupplies(nSynonymId)){scope.showDiscontinuedRxIcon=false;scope.showObsoleteMessage=false;var url='/mobiledoc/jsp/ecwrx/getDoses.jsp?RxType='+RxType+'&dnid='+nSynonymId+'&ItemId='+itemID+"&facilityID="+scope.encfacilityId+'&bObsolete='+scope.showDiscontinuedDrugs;if(scope.b_enabledFormulary&&scope.isShowFormularyFilter()){url+="&viewFormulary="+scope.b_viewFormulary+"&formularyFilter="+scope.qsFilterObj.nIsFormularyFilter}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDataForFormulary();scope.setDosageCalcCombos();if(scope.b_enabledFormulary){scope.isContainformularyRx=scope.isDoseContainFormularyRxDose()}scope.showHideLevel2Div('show');try{if(scope.dosageResultSet.length===0&&jsonobj.Envelope.Body["return"].hasOwnProperty("showObsoleteMessage")){var val=jsonobj.Envelope.Body["return"]['showObsoleteMessage'];scope.showObsoleteMessage=val==="yes"?true:false}}catch(e){}}else{scope.showObsoleteMessage=false;if(scope.b_enabledFormulary&&scope.isShowFormularyFilter()&&(scope.qsFilterObj.nIsFormularyFilter===1||scope.qsFilterObj.nIsFormularyFilter==='1')){alert("No eMAR doses have been setup for this drug in the formulary. Please uncheck the filter to see other doses.")}}})}else{var url='/mobiledoc/jsp/ecwrx/getCustomDoses.jsp?RxType='+RxType+'&itemid='+itemID+'&dnid='+nSynonymId+'&trUserId='+global.TrUserId;if(scope.b_enabledFormulary&&scope.isShowFormularyFilter()){url+="&facilityID="+scope.encfacilityId+"&viewFormulary="+scope.b_viewFormulary+"&formularyFilter="+scope.qsFilterObj.nIsFormularyFilter+"&context="+scope.context}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDosageCalcCombos();if(scope.b_enabledFormulary){scope.isContainformularyRx=scope.isDoseContainFormularyRxDose()}scope.showHideLevel2Div('show')}})}}if(scope.isRtbcServiceEnabled){scope.isMedMulEquiDrug=rtbcService.checkMedispanMultumEquipmentSupply(scope.selectedRxObject.nParentID)}};scope.setDataForFormulary=function(){if(scope.b_MedispanEnabled=="no"){for(var i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].synonymid==scope.dosageResultSet[i].brand_code||scope.dosageResultSet[i].brand_code==""){}else{}if(scope.dosageResultSet[i].gbo=="N"||scope.dosageResultSet[i].gbo=="U"){scope.dosageResultSet[i].gbo="B"}if(scope.dosageResultSet[i].gbo==""){scope.dosageResultSet[i].gbo="U"}if(scope.dosageResultSet[i].otc=="T"){scope.dosageResultSet[i].otc="O"}else if(scope.dosageResultSet[i].otc=="F"){scope.dosageResultSet[i].otc="P"}}scope.appendAdditionalDataForFavorites()}else{for(var i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].drugOTC=="O"||scope.dosageResultSet[i].drugOTC=="2"||scope.dosageResultSet[i].drugOTC=="3"){scope.dosageResultSet[i].OTC="O"}else if(scope.dosageResultSet[i].drugOTC=="R"||scope.dosageResultSet[i].drugOTC=="1"){scope.dosageResultSet[i].OTC="P"}else if(scope.dosageResultSet[i].drugOTC==""){scope.dosageResultSet[i].OTC="U"}if(scope.dosageResultSet[i].drugNameType=="N"||scope.dosageResultSet[i].drugNameType=="B"||scope.dosageResultSet[i].drugNameType=="2"||scope.dosageResultSet[i].drugNameType=="1"){scope.dosageResultSet[i].GBO="B"}else if(scope.dosageResultSet[i].drugNameType=="T"||scope.dosageResultSet[i].drugNameType=="3"||scope.dosageResultSet[i].drugNameType=="G"){scope.dosageResultSet[i].GBO="G"}scope.dosageResultSet[i].BrandDesc=scope.dosageResultSet[i].description}scope.appendAdditionalDataForFavorites()}scope.checkFormularyForDrug()};scope.appendAdditionalDataForFavorites=function(){try{var favorite=[];for(var i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].favorite==="1"){favorite.push(scope.dosageResultSet[i]);scope.dosageResultSet.splice(i,1);i=i-1}}if(scope.b_MedispanEnabled=="no"){scope.appendAdditionalDataForMultumFavorite(favorite)}else{scope.appendAdditionalDataForMedispanFavorite(favorite)}}catch(e){}};scope.appendAdditionalDataForMultumFavorite=function(favorite){try{if(favorite.length>0){for(var j=0;j<favorite.length;j++){for(var i=0;i<scope.dosageResultSet.length;i++){if(angular.lowercase(favorite[j].brand_description)===angular.lowercase(scope.dosageResultSet[i].brand_description)&&angular.lowercase(favorite[j].formulation)===angular.lowercase(scope.dosageResultSet[i].formulation)&&angular.lowercase(favorite[j].route)===angular.lowercase(scope.dosageResultSet[i].route)&&angular.lowercase(favorite[j].strength)===angular.lowercase(scope.dosageResultSet[i].strength)){favorite[j].gbo=scope.dosageResultSet[i].gbo;favorite[j].otc=scope.dosageResultSet[i].otc;favorite[j].main_multum_drug_code=scope.dosageResultSet[i].main_multum_drug_code;favorite[j].brand_code=scope.dosageResultSet[i].brand_code;scope.dosageResultSet.push(favorite[j]);break}}}}}catch(e){}};scope.appendAdditionalDataForMedispanFavorite=function(favorite){try{if(favorite.length>0){for(var j=0;j<favorite.length;j++){for(var i=0;i<scope.dosageResultSet.length;i++){if(angular.lowercase(favorite[j].ndc)===angular.lowercase(scope.dosageResultSet[i].ndc)&&angular.lowercase(favorite[j].formulation)===angular.lowercase(scope.dosageResultSet[i].formulation)&&angular.lowercase(favorite[j].route)===angular.lowercase(scope.dosageResultSet[i].route)&&angular.lowercase(favorite[j].strength)===angular.lowercase(scope.dosageResultSet[i].strength)){favorite[j].GBO=scope.dosageResultSet[i].GBO;favorite[j].OTC=scope.dosageResultSet[i].OTC;scope.dosageResultSet.push(favorite[j]);break}}}}}catch(e){}};scope.checkFormularyForDrug=function(){var xml="";if(scope.b_MedispanEnabled=="no"){scope.medispanAPI='no';var xw=new XMLWriter;startSoapPacket(xw);xw.writeStartElement('Info');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('RxList');xw.writeAttributeString('xsi:type','xsd:string');for(var i=0;i<scope.dosageResultSet.length;i++){xw.writeStartElement('Row');xw.writeAttributeString('xsi:type','xsd:string');if(scope.dosageResultSet[i].synonymid==""){scope.dosageResultSet[i].synonymid=0}addElement(xw,"synonymId",scope.dosageResultSet[i].synonymid,'xsi:type','xsd:string');if(scope.dosageResultSet[i].main_multum_drug_code==""){scope.dosageResultSet[i].main_multum_drug_code=0}addElement(xw,"mmdcode",scope.dosageResultSet[i].main_multum_drug_code,'xsi:type','xsd:string');if(scope.dosageResultSet[i].gbo=="B"){scope.dosageResultSet[i].gbo="N"}scope.dosageResultSet[i].GBO=scope.dosageResultSet[i].gbo;scope.dosageResultSet[i].OTC=scope.dosageResultSet[i].otc;addElement(xw,"GBO",scope.dosageResultSet[i].gbo,'xsi:type','xsd:string');if(scope.dosageResultSet[i].brand_code==""){scope.dosageResultSet[i].brand_code=0}addElement(xw,"BrandCode",scope.dosageResultSet[i].brand_code,'xsi:type','xsd:string');xw.writeEndElement()}xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);xml=xw.flush()}else{var xw=new XMLWriter;scope.medispanAPI='yes';startSoapPacket(xw);xw.writeStartElement('Info');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('RxList');xw.writeAttributeString('xsi:type','xsd:string');for(var i=0;i<scope.dosageResultSet.length;i++){xw.writeStartElement('Row');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,"NDCCode",scope.dosageResultSet[i].ndc,'xsi:type','xsd:string');xw.writeEndElement()}xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);xml=xw.flush()}scope.formularyDataForDrug=[];scope.dosageResultSetGreenDrugs=[];scope.dosageResultSetOrangeDrugs=[];scope.dosageResultSetYellowDrugs=[];scope.dosageResultSetRedDrugs=[];scope.dosageResultSetBlackDrugs=[];if(scope.formularyInfo.CoverageId===null||typeof scope.formularyInfo.CoverageId===null||scope.formularyInfo.CoverageId==="null")scope.formularyInfo.CoverageId="";var strUrl="/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/checkFormularyForDrug.jsp?FormularyId="+scope.formularyInfo.FormularyID+"&FormSourceId="+scope.formularyInfo.FormularySourceCode+"&CoverageId="+scope.formularyInfo.CoverageId+"&MedispanAPI="+scope.medispanAPI;var params="strData="+xml;var responsePromise=scope.LoadURL(strUrl,params);responsePromise.success(function(data){if(data.trim().length>0){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'].resultset.data.rows)>0){if(jsonobj.Envelope.Body['return'].resultset.data.rows.length>0){scope.formularyDataForDrug=jsonobj.Envelope.Body['return'].resultset.data.rows}else{scope.formularyDataForDrug.push(jsonobj.Envelope.Body['return'].resultset.data.rows)}scope.calculateFormulary();scope.sortDrugsByFormulary()}}})};scope.dosageResultSetGreenDrugs=[];scope.dosageResultSetOrangeDrugs=[];scope.dosageResultSetYellowDrugs=[];scope.dosageResultSetRedDrugs=[];scope.dosageResultSetBlackDrugs=[];scope.calculateFormulary=function(){for(var i=0;i<scope.dosageResultSet.length;i++){for(var j=i;j<scope.formularyDataForDrug.length;j++){if(scope.b_MedispanEnabled=="yes"){if(scope.formularyDataForDrug[j].NDC_Code==scope.dosageResultSet[i].ndc){if(scope.formularyDataForDrug[j].FormularyStatus=="01"){scope.dosageResultSet[i].FormularyStatus="1"}else if(scope.formularyDataForDrug[j].FormularyStatus=="02"){scope.dosageResultSet[i].FormularyStatus="2"}else if(scope.formularyDataForDrug[j].FormularyStatus=="03"){scope.dosageResultSet[i].FormularyStatus="3"}else if(scope.formularyDataForDrug[j].FormularyStatus=="00"){scope.dosageResultSet[i].FormularyStatus="0"}else{scope.dosageResultSet[i].FormularyStatus=scope.formularyDataForDrug[j].FormularyStatus}scope.dosageResultSet[i].PARequired=false;if(scope.formularyDataForDrug[j]&&scope.formularyDataForDrug[j].PARequired){if(scope.formularyDataForDrug[j].PARequired.toLowerCase()==='yes'){scope.dosageResultSet[i].PARequired=true}}break}}else{if(scope.formularyDataForDrug[j].mmdcode==scope.dosageResultSet[i].main_multum_drug_code){if(scope.formularyDataForDrug[j].FormularyStatus=="01"){scope.dosageResultSet[i].FormularyStatus="1"}else if(scope.formularyDataForDrug[j].FormularyStatus=="02"){scope.dosageResultSet[i].FormularyStatus="2"}else if(scope.formularyDataForDrug[j].FormularyStatus=="03"){scope.dosageResultSet[i].FormularyStatus="3"}else if(scope.formularyDataForDrug[j].FormularyStatus=="00"){scope.dosageResultSet[i].FormularyStatus="0"}else{scope.dosageResultSet[i].FormularyStatus=scope.formularyDataForDrug[j].FormularyStatus}scope.dosageResultSet[i].ndc=scope.formularyDataForDrug[j].NDC_Code;scope.dosageResultSet[i].PARequired=false;if(scope.formularyDataForDrug[j]&&scope.formularyDataForDrug[j].PARequired){if(scope.formularyDataForDrug[j].PARequired.toLowerCase()==='yes'){scope.dosageResultSet[i].PARequired=true}}break}}}}for(var i=0;i<scope.dosageResultSet.length;i++){var strFormularyStatus=scope.dosageResultSet[i].FormularyStatus;if(strFormularyStatus===""){if(scope.dosageResultSet[i].GBO==="B"&&scope.dosageResultSet[i].OTC==="O"){if($.trim(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])==="Unknown"){scope.dosageResultSet[i].FormularyStatus="U"}else if($.trim(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])===""){scope.dosageResultSet[i].FormularyStatus=""}else if($.trim(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])==="Not Reimbursable"){scope.dosageResultSet[i].FormularyStatus="0"}else if($.trim(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])==="Non Formulary"){scope.dosageResultSet[i].FormularyStatus="1"}else if($.trim(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])==="On Formulary(Not Preferred)"){scope.dosageResultSet[i].FormularyStatus="2"}else{if(scope.loadFormularyInfo.NLRxBrandOTC_FS!==""){if(scope.isNumeric(scope.Right(scope.loadFormularyInfo.NLRxBrandOTC_FS.trim(),2))){var nPrefLevel=scope.Right(scope.loadFormularyInfo.NLRxBrandOTC_FS.trim(),2)+2;scope.dosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(scope.dosageResultSet[i].GBO==="B"&&scope.dosageResultSet[i].OTC==="P"){if($.trim(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])==="Unknown"){scope.dosageResultSet[i].FormularyStatus="U"}else if($.trim(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])===""){scope.dosageResultSet[i].FormularyStatus=""}else if($.trim(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])==="Not Reimbursable"){scope.dosageResultSet[i].FormularyStatus="0"}else if($.trim(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])==="Non Formulary"){scope.dosageResultSet[i].FormularyStatus="1"}else if($.trim(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])==="On Formulary(Not Preferred)"){scope.dosageResultSet[i].FormularyStatus="2"}else{if(scope.loadFormularyInfo.NLRxBrand_FS!==""){if(scope.isNumeric(scope.Right(scope.loadFormularyInfo.NLRxBrand_FS.trim(),2))){var nPrefLevel=scope.Right(scope.loadFormularyInfo.NLRxBrand_FS.trim(),2)+2;scope.dosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(scope.dosageResultSet[i].GBO==="G"&&scope.dosageResultSet[i].OTC==="O"){if($.trim(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])==="Unknown"){scope.dosageResultSet[i].FormularyStatus="U"}else if($.trim(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])===""){scope.dosageResultSet[i].FormularyStatus=""}else if($.trim(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])==="Not Reimbursable"){scope.dosageResultSet[i].FormularyStatus="0"}else if($.trim(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])==="Non Formulary"){scope.dosageResultSet[i].FormularyStatus="1"}else if($.trim(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])==="On Formulary(Not Preferred)"){scope.dosageResultSet[i].FormularyStatus="2"}else{if(scope.loadFormularyInfo.NLRxGenericOTC_FS!==""){if(scope.isNumeric(scope.Right(scope.loadFormularyInfo.NLRxGenericOTC_FS.trim(),2))){var nPrefLevel=scope.Right(scope.loadFormularyInfo.NLRxGenericOTC_FS.trim(),2)+2;scope.dosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(scope.dosageResultSet[i].GBO==="G"&&scope.dosageResultSet[i].OTC==="P"){if($.trim(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])==="Unknown"){scope.dosageResultSet[i].FormularyStatus="U"}else if($.trim(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])===""){scope.dosageResultSet[i].FormularyStatus=""}else if($.trim(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])==="Not Reimbursable"){scope.dosageResultSet[i].FormularyStatus="0"}else if($.trim(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])==="Non Formulary"){scope.dosageResultSet[i].FormularyStatus="1"}else if($.trim(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])==="On Formulary(Not Preferred)"){scope.dosageResultSet[i].FormularyStatus="2"}else{if(scope.loadFormularyInfo.NLRxGeneric_FS!==""){if(scope.isNumeric(scope.Right(scope.loadFormularyInfo.NLRxGeneric_FS.trim(),2))){var nPrefLevel=scope.Right(scope.loadFormularyInfo.NLRxGeneric_FS.trim(),2)+2;scope.dosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}}if(typeof scope.dosageResultSet[i].FormularyStatus==undefined){scope.dosageResultSet[i].FormularyStatus="U"}if(scope.dosageResultSet[i].FormularyStatus==""){scope.dosageResultSet[i].FormularyStatus="U"}var nColorCode=scope.getProductStatusColorCode(scope.dosageResultSet[i].FormularyStatus);switch(nColorCode){case"white":scope.dosageResultSet[i].formularypic="icon-black-question";scope.dosageResultSet[i].formularypictooltip="Formulary Status - Unknown";scope.dosageResultSetBlackDrugs.push(scope.dosageResultSet[i]);break;case"red":scope.dosageResultSet[i].formularypic="icon-red-face";scope.dosageResultSet[i].formularypictooltip="Formulary Status - Not Covered";scope.dosageResultSetRedDrugs.push(scope.dosageResultSet[i]);break;case"orange":scope.dosageResultSet[i].formularypic="icon-orange-face";scope.dosageResultSet[i].formularypictooltip="Formulary Status - Non Formulary";scope.dosageResultSetOrangeDrugs.push(scope.dosageResultSet[i]);break;case"yellow":scope.dosageResultSet[i].formularypic="icon-yellow-face";scope.dosageResultSet[i].formularypictooltip="Formulary Status - On Formulary";scope.dosageResultSetYellowDrugs.push(scope.dosageResultSet[i]);break;default:scope.dosageResultSet[i].formularypic="icon-green-face";scope.dosageResultSet[i].formularypictooltip="Formulary Status - Preferred Drugs";scope.dosageResultSetGreenDrugs.push(scope.dosageResultSet[i]);break}}};scope.sortDrugsByFormulary=function(){scope.dosageResultSet=[];scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetGreenDrugs);scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetYellowDrugs);scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetOrangeDrugs);scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetRedDrugs);scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetBlackDrugs)};scope.getProductStatusColorCode=function(strProductStatusCode){switch(strProductStatusCode){case"U":return"white";break;case"0":return"red";case"00":return"red";break;case"1":return"orange";break;case"01":return"orange";break;case"2":return"yellow";break;case"02":return"yellow";break;case"":return"white";break;default:return"green";break}};scope.LoadURL=function(strUrl,data){return $http({method:'POST',url:makeURL(strUrl),data:data,"async":true,headers:{'Content-Type':'application/x-www-form-urlencoded'}})};scope.isNumeric=function(obj){return!jQuery.isArray(obj)&&obj-parseFloat(obj)+1>=0};scope.Right=function(str,nextCharlength){return str.substring(str.length-2,str.length)};scope.showHiveRefDivForQSDirective=function(){if(scope.context=="treatmentscreen"){if(quickSearchNS.checkForConcurrencyinQs()){quickSearchNS.closeTreatmentScreenforConcurrencyinQS();return}}if($('#container1-'+nRandomNumForQSD).length){var sHeight=$('#container1-'+nRandomNumForQSD).height();if(sHeight>0&&sHeight<360){$('#qsd-top-navigation-arrow-'+scope.randNum).addClass('hide');$('#qsd-bottom-navigation-arrow-'+scope.randNum).addClass('hide');$('#qsd-fav-top-navigation-arrow-'+scope.randNum).addClass('hide');$('#qsd-fav-bottom-navigation-arrow-'+scope.randNum).addClass('hide')}}scope.showHiveRefDiv()};scope.calculateHeightForPrompt=function(mainMeuHeight,qsHeight){if(scope.isBaseResolutionAndPNSource()){scope.qsdMainMenuHeight=mainMeuHeight;scope.qsdFirstLevelDivWidth=scope.b_DrugDbEnabled==='yes'?650:553;scope.qsDxHeight=qsHeight}if(scope.isBaseResolution()&&scope.QSDCustomParams.nShowDx===1){scope.qsdFirstLevelDivWidth=660}};quickSearchNS.applyStylesForRefferalDiv=id=>{$timeout(()=>{$('#qsd-referral-div-'+scope.randNum).show();$("#drag-icon-div-"+scope.randNum).hide();$("#quick-filter-icon-div-"+scope.randNum).hide();$('#first-level-qsd-actions-'+scope.randNum).show();if($(id).hasClass('active')){$('#qsd-quick-search-main-div-'+scope.randNum).addClass('open');$('#qsd-first-level-div-'+scope.randNum).removeClass('hide');$('#qsd-quick-menu-'+scope.randNum).css({'right':'-32px','top':'0'})}quickSearchNS.scrollDxToTop()})};scope.showHiveRefDiv=function(){var id="#icon-blackreferal-"+scope.randNum;if(scope.isBaseResolutionAndPNSource()){scope.calculateHeightForPrompt(355,345);quickSearchNS.applyStylesForRefferalDiv(id)}else{quickSearchNS.applyStylesForRefferalDiv(id)}$('.lab-data-div').hide();$('.future-order-box-div').addClass('hide');$(id).toggleClass('active');if($(id).hasClass('active')&&!(scope.qsrequestObj?.sContext==='PNscreen')){$('#qsd-quick-search-main-div-'+scope.randNum).addClass('open');$('#qsd-first-level-div-'+scope.randNum).removeClass('hide');$('#qsd-quick-menu-'+scope.randNum).css({'right':'-70px','top':'0'})}if(!$(id).hasClass('active')){if(scope.qsdLeftAlignAndSmall==1)$('#qsd-quick-menu-'+scope.randNum).css({'right':quickSearchNS.getQsMainMenuRight(),'top':'100%'});else $('#qsd-quick-menu-'+scope.randNum).css({'right':'0','top':'100%'});var sVal=jQuery('#quick-search-textBox-'+scope.randNum).val();if(sVal.length<2)$('#qsd-first-level-div-'+scope.randNum).addClass('hide');quickSearchNS.setFocusOnSearchBox(scope.randNum,0)}};scope.moveDxDiv=function(id,spd){moveDxDiv(id,spd,scope.randNum)};function openHmDialog(item){scope.hmItem=item;scope.hmItem.itemid=item.nItemId;scope.hmItem.itemName=item.sItemName;scope.hmItem.context='quicksearch';scope.hmItem.itemType=item.itemType?item.itemType:item.sKeyname;$('#qsd-first-level-div-'+scope.randNum).addClass('hide');scope.showHmDetails=true}scope.placeHmOrder=function(){quickSearchNS.savePreplanningOrders(scope.hmItem);scope.closeHmDialog()};scope.closeHmDialog=function(){scope.hmItem={};$('#qsd-first-level-div-'+scope.randNum).removeClass('hide');scope.showHmDetails=false};scope.showHideLevel2Div=function(sRequestType){if(sRequestType=='show'){$('#qsd-first-level-div-'+scope.randNum).addClass('hide');$('#qsd-second-level-rxDiv-'+scope.randNum).removeClass('hide');let rxDivRight=scope.qsrequestObj?.sContext==='PNscreen'?'308px':'-95px';$('#qsd-second-level-rxDiv-'+scope.randNum).css({'right':rxDivRight});if(scope.qsrequestObj?.sContext==='PNscreen'){$('#qsd-second-level-rxDiv-'+scope.randNum).css({'width':'790px'})}if(scope.b_DrugDbEnabled&&scope.b_DrugDbEnabled.toLowerCase()!=='yes'){if(scope.qsrequestObj?.sContext!=='PNscreen'){$('#qsd-second-level-rxDiv-'+scope.randNum).css({'width':'860px'})}if(scope.qsrequestObj?.sContext==='PNscreen'){$('#qsd-second-level-rxDiv-'+scope.randNum).css({'position':'absolute'})}if(scope.qsdLeftAlignAndSmall==1){$('#qsd-quick-menu-'+scope.randNum).css({'right':'-340px'})}if(scope.qsrequestObj?.sContext==="FHIRTreatment"){$('#qsd-second-level-rxDiv-'+scope.randNum).css({'width':'825px'})}}}else{$('#qsd-first-level-div-'+scope.randNum).removeClass('hide');$('#qsd-second-level-rxDiv-'+scope.randNum).addClass('hide');if(scope.selectedRxObject.doNotOpenFirstLevelDiv!==1){$('#qsd-first-level-div-'+scope.randNum).removeClass('hide');if(scope.qsdLeftAlignAndSmall==1){$('#qsd-quick-menu-'+scope.randNum).css({'right':quickSearchNS.getQsMainMenuRight()})}quickSearchNS.setFocusOnSearchBox(scope.randNum,1)}if(scope.context==="ImmTherapeuticInjections"&&typeof resizeVBChromiumModal==="function"){resizeVBChromiumModal(immInjCompendium_size_772,immInjCompendium_size_650)}}};scope.showHideCCResultsToDiv=function(){if(scope.context=="treatmentscreen"){if(quickSearchNS.checkForConcurrencyinQs()){quickSearchNS.closeTreatmentScreenforConcurrencyinQS();return}}if($('#quickOrder-divMenu-OrderDetail-'+scope.randNum).hasClass('open')){$('.lookupinput').removeClass('open');$('#listFilteredProviderId_providerlookupforCCResultsInQSD').removeClass('displayBlock');$('#quickOrder-divMenu-OrderDetail-'+scope.randNum).removeClass('open')}else{$('#quickOrder-divMenu-OrderDetail-'+scope.randNum).addClass('open')}};scope.toggleQuickSeachFilterForSunoh=function(){if($('#quickOrder-divMenu-sunoh-filterDetail-'+scope.randNum).hasClass('open')){$('#quickOrder-divMenu-sunoh-filterDetail-'+scope.randNum).removeClass('open')}else{$('#quickOrder-divMenu-sunoh-filterDetail-'+scope.randNum).addClass('open')}};scope.showHideQuickSearch=function(){if(scope.context=="treatmentscreen"){if(quickSearchNS.checkForConcurrencyinQs()){quickSearchNS.closeTreatmentScreenforConcurrencyinQS();return}}if($('#quickOrder-divMenu-filterDetail-'+scope.randNum).hasClass('open')){$('#quickOrder-divMenu-filterDetail-'+scope.randNum).removeClass('open')}else{$('#quickOrder-divMenu-filterDetail-'+scope.randNum).addClass('open')}};scope.hideAllQucikSearchDDiv=function(){if(!$('#left-nag-button').hasClass('disabled'))$('#left-nag-button').addClass('disabled');if(!$('#left-nag-div').hasClass('disabled'))$('#left-nag-div').addClass('disabled');if(!$('#right-nag-button').hasClass('disabled'))$('#right-nag-button').addClass('disabled');if(!$('#right-nag-div').hasClass('disabled'))$('#right-nag-div').addClass('disabled');$('.qsd-first-level-div').addClass('hide');$('.qsd-second-level-rxDiv').addClass('hide');$('.ref-div').hide();$('#first-level-qsd-actions-'+scope.randNum).hide();$('.lab-data-div').show();$('.quickOrder-divMenu-filterDetail,.quickOrder-divMenu-OrderDetail').removeClass('hide');$('.future-order-box-div').removeClass('hide');if(scope.context!=="ImmTherapeuticInjections"){$('.quick-menu').css({'right':'0','top':'100%'})}$('#quick-search-textBox-'+nRandomNumForQSD).val('');scope.qsFilterObj.nContainsSearch=scope.topClass!=="editLabDIProcSunohPopup"?0:1;scope.qsFilterObj.sQuickSearchText='';$('quickOrder-divMenu-sunoh-filterDetail-'+scope.randNum).removeClass("open")};scope.setContainsSearchForQuickSearch=function(){scope.qsFilterObj.nContainsSearch=scope.qsFilterObj.nContainsSearch==1?0:1;scope.qsTextBoxKeyPress(scope.qsFilterObj.nContainsSearch);quickSearchNS.setFocusOnSearchBox(scope.randNum,0)};scope.favorite={};scope.favorite.patientId=scope.nPatientId;scope.favorite.patientId=scope.nEncounterId;scope.favorite.TrUserId=scope.nTrUserId;scope.favorite.counter=1;scope.favorite.searchby=0;scope.favorite.MAXCOUNT=10;scope.favorite.LabId=0;scope.favorite.keyName="LabReports";scope.favorite.rootNode=2;scope.favorite.orderIHFlag=0;scope.favorite.inactiveFlag=0;scope.favorite.lookupOption=0;scope.favorite.MyFavFlag=1;scope.favorite.HideAliasColumn=0;scope.favorite.IsEncLocked="False";scope.favorite.securityAccess=true;scope.favorite.IsEMPIEnabled="False";scope.favorite.b3rdPartyPortal="False";scope.favorite.defaultId=1;scope.favorite.rowCount=0;scope.favorite.isNextDisabled=false;scope.favorite.isPreviousDisabled=false;scope.favoriteItems=[];scope.currentOrdersIds=[];scope.proceedCallBack=function(){scope.transfetVisitToCurrentOrd(scope.orderObj,scope.event,scope.orderIndex)};scope.checkDayThresholdBeforeTrnsfr=function(obj,event,index){if($.inArray(obj.id,scope.currentOrdersIds)!=-1){showMessage(escapeHtml(obj.name)+" is already in the selected list.");return}var futureOrdTransferDays={};getItemKeyValuePair("FutureOrdTransferDaysLimit",futureOrdTransferDays);if(futureOrdTransferDays.keyValue==="yes"){var dayThreshold=parseInt(futureOrdTransferDays.itemId,10);var alertMsg=getTrnsfrFutrToTodayAlertMsg(scope.futureOrd.orderDate,obj.FutureOrderDate,obj.name,dayThreshold);if(alertMsg!==""&&alertMsg.length>0&&alertMsg!=="failed"){scope.orderObj=obj;scope.event=event;scope.orderIndex=index;ecwConfirm(alertMsg,"Transfer Lab/DI/Procedure",scope.proceedCallBack,'','',true,true,"Proceed","Cancel")}else if(alertMsg!==""&&alertMsg.length>0&&alertMsg==="failed"){ecwAlert('An error occurred on the server while checking for threshold limit in between future order date and visit date.','Transfer Future Order');scope.transfetVisitToCurrentOrd(obj,event,index)}else{scope.transfetVisitToCurrentOrd(obj,event,index)}}else{scope.transfetVisitToCurrentOrd(obj,event,index)}};scope.transfetVisitToCurrentOrd=function(Obj,event,index){event.stopImmediatePropagation();if($.inArray(Obj.id,scope.currentOrdersIds)!=-1){showMessage(escapeHtml(Obj.name)+" is already in the selected list.");return}else{scope.itemArray=[];var item=new Object;item.encounterId=Obj.orderEncId;item.reportId=Obj.reportId;scope.itemArray.push(item);Obj.orderInstructions=Obj.orderinstructions;Obj.reviewed=0;if(scope.context==="ascOrdersScreen"&&(Obj.sKeyname==="labreports"||Obj.sKeyname==="xrays"||Obj.sKeyname==="procedures")&&(scope.qsrequestObj.nEncounterType===operative_encType||scope.qsrequestObj.nEncounterType===intra_anesthesia)){cptDropService.loadICDCPTPopup(Obj,item,scope.nEncounterId,scope.isPAMAActionRequired,scope.transferFutureOrderToCurrentCallback)}else{scope.transferFutureOrderToCurrentCallback(Obj)}}};scope.transferFutureOrderToCurrentCallback=function(Obj){scope.todaysOrder.push(Obj);scope.favoriteItems.splice(index,1);let associationOfICDCPTstr='';if(Obj.mngOrderAssociationICDCPT)associationOfICDCPTstr=JSON.stringify(Obj.mngOrderAssociationICDCPT);var bodyData=$.param({transferJson:JSON.stringify(scope.itemArray),sRequestFrom:'addEditLabOrder',currentOrderDirtyFlag:1,transferOrderDirtyFlag:1,encounterId:scope.nEncounterId,encId:scope.nEncounterId,futureOrderDirtyFlag:0,billType:scope.futureOrd.billType,currentOrder:JSON.stringify(scope.todaysOrder),futureOrder:JSON.stringify(scope.favoriteItems),patientId:scope.nPatientId,orderProtocolType:scope.qsrequestObj.protocolType,orderingProvider:scope.qsrequestObj.orderFor,orderNoteType:scope.qsrequestObj.noteType,billedToPhy:scope.futureOrd.isBilledToPhy,context:"ASC_ORDER",TrUserId:scope.nTrUserId,type:scope.futureOrd.nCurrType,reportType:scope.futureOrd.currType,categoryId:scope.futureOrd.categoryId,facilityId:scope.futureOrd.facilityId,orderDate:scope.futureOrd.orderDate,associationOfICDCPT:associationOfICDCPTstr});$.ajax({url:makeURL('/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?'),type:"POST",cache:false,dataType:"json","async":false,data:bodyData,success:function(data){if(data.success==='no'){if(data.message){ecwAlert(data.message,'Transfer Future Order')}else{ecwAlert('Error occurred while transferring Future order to Current visit.','Transfer Future Order')}}var OrderStatObj={sRequestType:'neworder',sStatus:'',sOrderName:Obj.name,sFailedReason:''};scope.setDataInParentScreen('neworder',OrderStatObj);scope.getFutureOrd(scope.futureOrd.currType,scope.futureOrd.prevIndex,scope.futureOrd.nextIndex)}})};scope.futureOrd={};scope.futureOrd.prevIndex=0;scope.futureOrd.nextIndex=scope.favorite.MAXCOUNT;scope.futureOrd.futureOrdLength=0;scope.futureOrd.nShowFutureOrdItemsOpt=1;scope.futureOrd.currType='LabReports';scope.futureOrd.nCurrType=0;scope.futureOrd.billType="";scope.todaysOrder=[];scope.getFutureOrd=function(type,prev,next){scope.futureOrd.nShowFutureOrdItemsOpt=0;scope.favoriteItems=[];scope.currentOrdersIds=[];scope.futureOrd.currType=type;scope.futureOrd.nCurrType=0;if(type==='XRays'){scope.futureOrd.nCurrType=1}else if(type==='Procedures'){scope.futureOrd.nCurrType=3}else{$('#futureOrdLab').addClass('active');$('#futureOrdProc').removeClass('active');$('#futureOrdDI').removeClass('active')}scope.getFutureOrdStyle={"width":"480px"};$.ajax({url:makeURL('/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?encounterId='+scope.nEncounterId+'&sRequestFrom=getManageOrderJson&patientId='+scope.nPatientId+'&TrUserId='+scope.nTrUserId+'&labType='+scope.futureOrd.nCurrType+'&context'+scope.context),type:"POST",cache:false,dataType:"json","async":false,success:function(data){if(data.status!=='success'){ecwAlert('Error occurred while loading Future orders.','Loading Future Order')}var tempFutureOrder=returnDataArray(data.futureLabOrders.item);scope.todaysOrder=returnDataArray(data.currentLabOrders.item);scope.futureOrd.isBilledToPhy=data.selectBilling?"1":"0";scope.futureOrd.billType="N";scope.futureOrd.categoryId=data.categoryId;scope.futureOrd.facilityId=data.encounterJson.facilityId;scope.futureOrd.orderDate=data.encounterJson.date;scope.futureOrd.prevIndex=angular.isUndefined(prev)?0:prev;scope.futureOrd.nextIndex=angular.isUndefined(next)?scope.favorite.MAXCOUNT:next;scope.futureOrd.futureOrdLength=!angular.isUndefined(tempFutureOrder)?tempFutureOrder.length:0;scope.favorite.isNextDisabled=scope.futureOrd.futureOrdLength<=scope.favorite.MAXCOUNT||scope.futureOrd.nextIndex>=scope.futureOrd.futureOrdLength?true:false;scope.favorite.isPreviousDisabled=scope.futureOrd.prevIndex==0||scope.futureOrd.prevIndex<scope.favorite.MAXCOUNT?true:false;angular.forEach(tempFutureOrder,function(Obj){if(!angular.isUndefined(Obj)){Obj.sKeyname=type.toLowerCase();Obj.nItemId=Obj.id;Obj.nBillable=Obj.billable;Obj.sIsFuture="1";Obj.sFutureDate=Obj.FutureOrderDate.replace(/(\d{4})-(\d{2})-(\d{2})/,'$2/$3/$1');Obj.sFutureDate=Obj.sFutureDate?Obj.sFutureDate:Obj.FutureOrderDate;Obj.DxTitle=angular.isUndefined(Obj.DxTitle)||Obj.DxTitle.length==0?'N/A Other':Obj.DxTitle;var reviewed=Obj.reviewed=="1";var received=Obj.received=="1";if(scope.futureOrderFilter||!reviewed&&!received){if(scope.hideForOSAdmin){if(Obj.orderEncId==scope.nEncounterId&&Obj.reviewed==0){scope.favoriteItems.push(Obj)}}else{scope.favoriteItems.push(Obj)}}}});var tempCurrentOrder=returnDataArray(data.currentLabOrders.item);angular.forEach(tempCurrentOrder,function(Obj){if(!angular.isUndefined(Obj.id)){scope.currentOrdersIds.push(Obj.id)}})}})};scope.getFavorites=function(type,bResetCounter){scope.futureOrd.nShowFutureOrdItemsOpt=1;scope.getFutureOrdStyle={};switch(scope.topClass){case'PNQuickSearch':$("#quickSearchDirective_PNQuickSearch_Ul2").css({"z-index":"90"});if(scope.qsrequestObj?.sContext==='PNscreen'){$("#quickSearchDirective_PNQuickSearch_Ul2").css({'left':'-715px'})}$(".stndgOrderDiv2").css({"z-index":"90"});break;case'treatmentQuickSearch':$("#quickSearchDirective_treatmentQuickSearch_Ul2").css({"z-index":"90"});$(".stndgOrderDiv2").css({"z-index":"90"});break;default:}if(scope.context=="treatmentscreen"){if(quickSearchNS.checkForConcurrencyinQs()){quickSearchNS.closeTreatmentScreenforConcurrencyinQS();return}}if(scope.isBaseResolutionAndPNSource()){scope.favorite.MAXCOUNT=8}if(bResetCounter){scope.favorite.rowCount=0;scope.favorite.counter=1}$.ajax({url:makeURL('/mobiledoc/jsp/webemr/progressnotes/treatment/getFavoriteLabDIProcedures.jsp?encptId='+scope.nPatientId+'&ptSpecificData=no&nEncId='+scope.nEncounterId+'&counter='+scope.favorite.counter+'&searchby=0&MAXCOUNT='+scope.favorite.MAXCOUNT+'&LabId=0&keyName='+type+'&rootNode=2&orderIHFlag=0&inactiveFlag=0&lookupOption=0&MyFavFlag=1&TrUserId='+scope.nTrUserId+'&HideAliasColumn=0&IsEncLocked=False&securityAccess=true&IsEMPIEnabled=False&b3rdPartyPortal=False&defaultId=1'),type:"POST",cache:false,dataType:"JSON","async":false,success:function(data){scope.favoriteItems=data;scope.favorite.keyName=type;scope.favorite.rowCount=scope.favoriteItems.length;scope.disableNextPreviousButtons();for(var i=0;i<scope.favoriteItems.length;i++){scope.favoriteItems[i].sKeyname=type.toLowerCase();scope.favoriteItems[i].nItemId=scope.favoriteItems[i].id;scope.favoriteItems[i].nBillable=scope.favoriteItems[i].billable==""?0:1;scope.favoriteItems[i].sItemName=scope.favoriteItems[i].name}$timeout(function(){scope.hideTopAndBottomArrows('container1')})}})};scope.getPrevFavorites=function(){if(scope.futureOrd.nShowFutureOrdItemsOpt==0){if(scope.futureOrd.prevIndex==0||scope.futureOrd.prevIndex<scope.favorite.MAXCOUNT){scope.favorite.isPreviousDisabled=true;return}scope.futureOrd.prevIndex=scope.futureOrd.prevIndex-scope.favorite.MAXCOUNT;scope.futureOrd.nextIndex=scope.futureOrd.nextIndex-scope.favorite.MAXCOUNT;scope.favorite.isPreviousDisabled=scope.futureOrd.prevIndex==0||scope.futureOrd.prevIndex<scope.favorite.MAXCOUNT?true:false;scope.favorite.isNextDisabled=false;return}if(scope.favorite.counter>1)scope.favorite.counter=scope.favorite.counter-scope.favorite.MAXCOUNT;scope.getFavorites(scope.favorite.keyName,false)};scope.getNextFavorites=function(){if(scope.futureOrd.nShowFutureOrdItemsOpt==0){if(scope.futureOrd.nextIndex>=scope.futureOrd.futureOrdLength||scope.futureOrd.futureOrdLength<=scope.favorite.MAXCOUNT){scope.favorite.isNextDisabled=true;return}scope.futureOrd.prevIndex=scope.futureOrd.prevIndex+scope.favorite.MAXCOUNT;scope.futureOrd.nextIndex=scope.futureOrd.nextIndex+scope.favorite.MAXCOUNT;scope.favorite.isNextDisabled=scope.futureOrd.futureOrdLength<=scope.favorite.MAXCOUNT||scope.futureOrd.nextIndex>=scope.futureOrd.futureOrdLength?true:false;scope.favorite.isPreviousDisabled=false;return}if(scope.favorite.rowCount>scope.favorite.MAXCOUNT)scope.favorite.counter=scope.favorite.counter+scope.favorite.MAXCOUNT;scope.getFavorites(scope.favorite.keyName,false)};scope.disableNextPreviousButtons=function(){if(scope.favorite.rowCount<scope.favorite.MAXCOUNT){if(scope.favorite.counter==1){scope.favorite.isNextDisabled=true;scope.favorite.isPreviousDisabled=true}else if(scope.favorite.counter>1){scope.favorite.isNextDisabled=true;scope.favorite.isPreviousDisabled=false}}else{if(scope.favorite.counter==1){scope.favorite.isNextDisabled=false;scope.favorite.isPreviousDisabled=true}else if(scope.favorite.counter>1){scope.favorite.isNextDisabled=false;scope.favorite.isPreviousDisabled=false}}};scope.hideFavDiv=function(){scope.futureOrd.nShowFutureOrdItemsOpt=1;$('.favDrop-'+scope.randNum).removeClass('open');$('.standorder-div').css('display','none')};scope.addWithoutSig=function(btnClick){var obj={};obj.name=scope.selectedRxName;if(scope.b_MedispanEnabled=="no"){obj.supplierID=scope.selectedRxObject.sSupplierId}else{obj.supplierID=scope.selectedRxObject.sDrugNameId}obj.DrugNameId=obj.supplierID;obj.itemID=scope.selectedRxObject.nItemId;obj.strength="";obj.formulation="";obj.route="";obj.take="";obj.freq="";obj.duration="";if(scope.checkIsCompoundDrug(scope.selectedRxObject.isCompound)){obj.dispense=scope.dosageResultSet[0].dispense}else{obj.dispense=""}obj.refills="";obj.ndc="";obj.controlledCode="";obj.controlled="";obj.IsRxSupplies="";obj.favorite="";obj.awup="";obj.MMDCode="";scope.dosageResultSet.push(obj);if(scope.topClass==="sunohRxOrderClass"&&btnClick){scope.addRxSunohPossibleMatches(scope.dosageResultSet.length-1,"addWithoutSig");return}scope.isRtbcPopupOpened=false;scope.isRtbcButtonClicked=false;if(scope.context==="ImmTherapeuticInjections"){scope.setInjectionMedicationMapping(scope.dosageResultSet.length-1)}else{scope.selectDosage(scope.dosageResultSet.length-1)}};scope.setSmartOrderFilterForQuickSearch=function(){filterType="smartorder";scope.qsTextBoxKeyPress();quickSearchNS.setFocusOnSearchBox(scope.randNum,0);scope.qsFilterObj.sQuickSearchText="   ";scope.qsTextBoxKeyPress()};scope.addItemsToEncList=function(encList,itemList,lesionId){for(var itemIndex in itemList){var itemObj={};itemObj.nItemId=itemList[itemIndex].itemid;itemObj.sItemName=itemList[itemIndex].itemname;itemObj.sKeyname=itemList[itemIndex].keyname.toLowerCase();itemObj.sName=itemList[itemIndex].itemname;itemObj.mstId=itemList[itemIndex].mstid;itemObj.sDrugNameId=itemList[itemIndex].drugid;itemObj.lesionId=lesionId;itemObj.nBillable=itemList[itemIndex].billable;itemObj.isCompound="false";if(itemList[itemIndex].keyname.toLowerCase()==='rx'||itemList[itemIndex].keyname.toLowerCase()==='rxmedispan'){itemObj.isCompound=itemList[itemIndex].isCompound;if(itemObj.isCompound==='true'){itemObj.CompoundIngredients=itemList[itemIndex].CompoundIngredients}}if(itemList[itemIndex].itemType){itemObj.itemType=itemList[itemIndex].itemType}encList.push(itemObj)}};scope.getDermFavResultSet=function(searchString){searchString=searchString.trim();isLoading=true;var lesionArray=scope.$parent.prepareJSONObjectForAdmin();var url='/mobiledoc/jsp/derm/conf/dermconfigcontroller.jsp?action=34&selectedUserId='+global.TrUserId+"&searchString="+searchString;url=makeURL(url);var xsrf=$.param({queryparams:JSON.stringify(lesionArray)});var responsePromise=$http({method:'POST',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'},data:xsrf});responsePromise.success(function(data){var lesionList=scope.$parent.getSelectedLesionList();var encList=[];for(var lesionIndex in lesionList){var lesionId=lesionList[lesionIndex].lesionId;if(data[lesionId]){scope.addItemsToEncList(encList,data[lesionId].labs,lesionId);scope.addItemsToEncList(encList,data[lesionId].di,lesionId);scope.addItemsToEncList(encList,data[lesionId].procedures,lesionId);scope.addItemsToEncList(encList,data[lesionId].medications,lesionId);scope.addItemsToEncList(encList,data[lesionId].ti,lesionId)}}scope.searchOrdersList=encList;if(!scope.hasFormularyCheckDone){scope.getRxFormulary()}});isLoading=false};var bSaveAsInventoryProduct=false;var bAlreadyCalledInventory=false;scope.isInventoryProduct=function(rxObject){if(bAlreadyCalledInventory)return true;if(rxObject.hasOwnProperty('InvProductId')&&rxObject.InvProductId>0){bootbox.confirm({buttons:{cancel:{label:'No',className:'btn btn-lblue btn-sm btn-xs pull-right  ml10'},confirm:{label:'Yes',className:'btn btn-lblue btn-sm btn-xs pull-right'}},message:" Select 'Yes' if you would like to prescribe this medication from the inventory otherwise select 'No'. ",title:'Warning',callback:function(result){if(result){bSaveAsInventoryProduct=true;bAlreadyCalledInventory=true;scope.saveRxData(rxObject)}else{bSaveAsInventoryProduct=false;bAlreadyCalledInventory=true;scope.saveRxData(rxObject)}}})}else{bAlreadyCalledInventory=true;scope.saveRxData(rxObject)}};scope.showInventory=function(itemid){var param="";param="itemid="+itemid;var url=makeURL("/mobiledoc/jsp/inventory/rxinventory.jsp?"+param);$("#invCont").attr("src",url);$('#invModal').modal()};function getKeyLength(object){var count=0;for(var property in object){if(object.hasOwnProperty(property)){count++;break}}return count}scope.CloseInvModal=function(){$('#invModal').modal('hide')};scope.$on('saveToProgressNoteFromRtbc',function(e,obj){if(scope.context==='PNscreen'&&scope.isRtbcServiceEnabled){scope.saveRxData(obj)}});scope.$on('saveToTreatmentFromRtbc',function(e,obj){if(scope.context==='treatmentscreen'&&scope.isRtbcServiceEnabled){scope.saveRxData(obj)}});scope.$on('saveToProgressNoteFromEPA',function(e,objData){if(scope.context==='PNscreen'){var obj=objData.rxInfoResponse;var rxSaveObj={};rxSaveObj.isRtbcRxObject='yes';scope.strengthId=obj.strengthProp;scope.formulationId=obj.formulationProp;scope.takeId=obj.takeProp;scope.routeId=obj.routeProp;scope.frequencyId=obj.frequencyProp;scope.durationId=obj.durationProp;scope.dispenseId=obj.amountProp;scope.refillsId=obj.refillsProp;rxSaveObj.rxDetailId=objData.rxDetailId;rxSaveObj.duration=obj.duration;rxSaveObj.dispense=obj.dispense;rxSaveObj.dispense.pharmacyNCPDPId=obj.ncpdp;rxSaveObj.patientPayAmt=obj.patientPayAmount;rxSaveObj.strength=obj.strength;rxSaveObj.formulation=obj.formulation;rxSaveObj.route=obj.route;rxSaveObj.freq=obj.frequency;rxSaveObj.take=obj.take;rxSaveObj.refills=obj.refill;rxSaveObj.description=obj.drugDescription;rxSaveObj.ndc=obj.ndcCode;rxSaveObj.doseunit=obj.doseunit;rxSaveObj.drugOTC=obj.drugOTC;rxSaveObj.drugNameType=obj.drugNameType;rxSaveObj.MMDCode=obj.mmdCode;rxSaveObj.controlledCode=obj.controlledCode;rxSaveObj.ItemId=obj.itemId;rxSaveObj.DrugNameId=obj.drugNameId;rxSaveObj.ObsoleteDate=obj.obsoleteDate;rxSaveObj.controlled=obj.controlled;rxSaveObj.InvProductId=obj.invProductId;rxSaveObj.InvExpiryDate=obj.invExpiryDate;rxSaveObj.InventoryQty=obj.inventoryQty;rxSaveObj.sItemName=obj.itemName;rxSaveObj.rxNotes=obj.rxNotes;rxSaveObj.isFromEPA=true;scope.oItemData={};scope.dosageResultSet[0]={};scope.saveRxData(rxSaveObj)}});scope.ePAClicked=function(index){scope.dosageResultSet[index].isCallFromePA=true;scope.selectDosage(index)};scope.openEPAInitializePopup=function(existingRxObject,allergyInteractionsPassed){let rxObject=existingRxObject;if(typeof rxObject==='undefined'){rxObject=angular.copy(scope.dosageResultSet[scope.selectedIndex])}if(!rxObject){return}if(!allergyInteractionsPassed){scope.callFromePA=true;scope.CheckAllergyInteraction(rxObject);return}if(rxObject.ItemId){rxObject.ItemId=rxObject.ItemId}else if(rxObject.itemID){rxObject.ItemId=rxObject.itemID}else if(scope.itemIdForMultumFormulary){rxObject.ItemId=scope.itemIdForMultumFormulary}if(scope.formularyInfo.FormularyID&&scope.formularyInfo.FormularyID.length>0){rxObject.isFormularyEnabled=true}rxObject.isMedispanEnabled=scope.b_MedispanEnabled==='yes'?true:false;rxObject.selectedRxItemName=scope.selectedRxObject.sItemName;rxObject.nSelectedAssessmentId=scope.nSelectedAssessmentId;scope.setDxDetailsForPLPastDx(rxObject);scope.epaObject={rxObject:rxObject,context:scope.context,userId:scope.nTrUserId,patientId:scope.nPatientId,encounterId:scope.nEncounterId,facilityId:scope.encfacilityId,erxMsgId:0};rxObject.isCallFromePA=false;ePAOrderService.openEPAInitializePopup(scope.epaObject)};let trimData=function(text){if(typeof text==='undefined'){return""}if(null===text){return""}return String.prototype.trim.call(text)};scope.saveDefaultUISetting=function(){scope.global.wrapText=!scope.global.wrapText;$http({method:'POST',url:'/mobiledoc/jsp/webemr/common/setUIDefault.jsp',params:{'formName':'quickOrder','uiDefaults':JSON.stringify({"wrapText":scope.global.wrapText}),'doctorId':global.TrUserId}})};scope.saveRxData=function(rxObject){if(!bAlreadyCalledInventory&&scope.bDispenseInventoryLinkEnabled){scope.isInventoryProduct(rxObject);return}if(scope.m_bAllergyInteraction){scope.CheckAllergyInteraction(rxObject);return}else{scope.m_bAllergyInteraction=true;processFormularyApprovalForm(rxObject)}bAlreadyCalledInventory=false;var xw=new XMLWriter;startSoapPacket(xw);xw.writeStartElement('return');xw.writeStartElement('items');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('item');xw.writeAttributeString('xsi:type','xsd:string');var itemName='';let itemId=0;if(rxObject.isRtbcRxObject){if(rxObject.ItemId){addElement(xw,"id",rxObject.ItemId,'xsi:type','xsd:int');itemId=rxObject.ItemId}else if(rxObject.itemID){addElement(xw,"id",rxObject.itemID,'xsi:type','xsd:int');itemId=rxObject.itemID}itemName=rxObject.sItemName}else{addElement(xw,"id",scope.selectedRxObject.nItemId,'xsi:type','xsd:int');itemName=scope.selectedRxObject.sItemName;itemId=scope.selectedRxObject.nItemId;if(rxObject.DrugNameId===0||rxObject.DrugNameId==="0"||rxObject.DrugNameId===""||typeof rxObject.DrugNameId===undefined||typeof rxObject.DrugNameId==="undefined"){if(scope.b_MedispanEnabled==="no"){rxObject.DrugNameId=scope.selectedRxObject.sSupplierId}else{rxObject.DrugNameId=scope.selectedRxObject.sDrugNameId}}}addElement(xw,"doctorFlag",'1','xsi:type','xsd:int');addElement(xw,"AssessId",scope.nSelectedAssessmentId,'xsi:type','xsd:int');xw.writeStartElement('properties');xw.writeStartElement('property');addElement(xw,"id",scope.strengthId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.strength+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.formulationId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.formulation+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.takeId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.take+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.routeId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.route+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.frequencyId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.freq+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.durationId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.duration+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.dispenseId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.dispense+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.refillsId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.refills+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeEndElement();addElement(xw,"GBO","",'xsi:type','xsd:string');addElement(xw,"FormularyStatus","",'xsi:type','xsd:string');if(scope.b_MedispanEnabled==="no"){addElement(xw,"MMDCode","",'xsi:type','xsd:string')}else{addElement(xw,"MMDCode",rxObject.MMDCode,'xsi:type','xsd:string')}if(rxObject.hasOwnProperty("ndc")&&!angular.isUndefined(rxObject.ndc)){addElement(xw,"NDCCode",rxObject.ndc,'xsi:type','xsd:string')}if(bSaveAsInventoryProduct&&scope.bDispenseInventoryLinkEnabled){addElement(xw,"InvProductId",rxObject.InvProductId,'xsi:type','xsd:string');bSaveAsInventoryProduct=false}addElement(xw,"FormularyId","",'xsi:type','xsd:string');addElement(xw,"PayerSourceName","",'xsi:type','xsd:string');addElement(xw,"BrandCode","",'xsi:type','xsd:string');addElement(xw,"SymID","",'xsi:type','xsd:string');try{if(angular.isUndefined(rxObject.startDate)||rxObject.startDate==='')addElement(xw,"StartDate",$filter('date')(new Date,'yyyy/MM/dd'),'xsi:type','xsd:string');else addElement(xw,"StartDate",rxObject.startDate,'xsi:type','xsd:string')}catch(e){}var sStopDt="";try{if(rxObject.stopDate===undefined||rxObject.stopDate===''||rxObject.stopDate===null||rxObject.stopDate==='null'){if(rxObject.isRtbcRxObject){if(rxObject.ItemId){sStopDt=rxService.calculateStopDate(rxObject.ItemId,$filter('date')(new Date,'yyyy/MM/dd'),rxObject.duration,rxObject.refills,"yyyy-mm-dd")}else if(rxObject.itemID){sStopDt=rxService.calculateStopDate(rxObject.itemID,$filter('date')(new Date,'yyyy/MM/dd'),rxObject.duration,rxObject.refills,"yyyy-mm-dd")}}else{sStopDt=rxService.calculateRxStopDateWithBlank(rxObject,scope.selectedRxObject.nItemId)}}else{sStopDt=rxObject.stopDate}}catch(e){}if(scope.context==="ascOrdersScreen"){var stopDate=$filter('date')(new Date,'yyyy/MM/dd');addElement(xw,"StopDate",stopDate,'xsi:type','xsd:string')}else if(getItemKeyValue("isFormularyEnabled").toLowerCase()==="yes"&&!angular.isUndefined(rxObject.AdministerFlagValue)&&(rxObject.AdministerFlagValue===1||rxObject.AdministerFlagValue==="1")){if(angular.isUndefined(rxObject.startDate)||rxObject.startDate===''){addElement(xw,"StopDate",$filter('date')(new Date,'yyyy/MM/dd'),'xsi:type','xsd:string')}else{addElement(xw,"StopDate",rxObject.startDate,'xsi:type','xsd:string')}}else{addElement(xw,"StopDate",sStopDt,'xsi:type','xsd:string')}var preparedBy=global.TrUserName+" "+$filter('date')(new Date,'yyyy/MM/dd');addElement(xw,"PreparedBy","<![CDATA["+preparedBy+"]]>",'xsi:type','xsd:string');addElement(xw,"RxOrderNo","",'xsi:type','xsd:string');if(trimData(rxObject.isRxKOP)===""){rxObject.isRxKOP='No'}addElement(xw,"rxKOP",rxObject.isRxKOP,'xsi:type','xsd:string');addElement(xw,"rxDrugSource","",'xsi:type','xsd:string');addElement(xw,"awp","",'xsi:type','xsd:string');addElement(xw,"awup","",'xsi:type','xsd:string');addElement(xw,"OldRxMainId","",'xsi:type','xsd:string');try{if(angular.isUndefined(rxObject.RxSource)){addElement(xw,"rxSource","<![CDATA["+global.TrUserName+"]]>",'xsi:type','xsd:string')}else{addElement(xw,"rxSource","<![CDATA["+rxObject.RxSource+"]]>",'xsi:type','xsd:string')}if(angular.isUndefined(rxObject.RxSourceID)){addElement(xw,"rxSourceId",global.TrUserId,'xsi:type','xsd:int')}else{addElement(xw,"rxSourceId",rxObject.RxSourceID,'xsi:type','xsd:int')}if(angular.isUndefined(rxObject.RxEditNotesValue)){addElement(xw,"rxNotes","",'xsi:type','xsd:string')}else{addElement(xw,"rxNotes","<![CDATA["+rxObject.RxEditNotesValue+"]]>",'xsi:type','xsd:string')}}catch(e){}addElement(xw,"RxAdditionalNotes","<![CDATA["+trimData(rxObject.RxAdditionalNotes)+"]]>",'xsi:type','xsd:string');addElement(xw,"AdditionalInstructions","<![CDATA["+trimData(rxObject.AddInstructions)+"]]>",'xsi:type','xsd:string');addElement(xw,"daw",trimData(rxObject.daw)==="1"?1:0,'xsi:type','xsd:int');if(angular.isUndefined(rxObject.PharmacyNCPDPId)){addElement(xw,"PharmacyNCPDPId",trimData(rxObject.pharmacyNCPDPId),'xsi:type','xsd:int')}else{addElement(xw,"PharmacyNCPDPId",trimData(rxObject.PharmacyNCPDPId),'xsi:type','xsd:int')}addElement(xw,"pharmacyId",trimData(rxObject.pharmacyId),'xsi:type','xsd:int');addElement(xw,"encounterId",trimData(scope.nEncounterId),'xsi:type','xsd:string');addElement(xw,"loginUserType",global.loginUserType,'xsi:type','xsd:int');if(scope.context==="ascOrdersScreen"){addElement(xw,"orderingProvider",scope.qsrequestObj.orderFor,'xsi:type','xsd:int');addElement(xw,"orderNoteType",scope.qsrequestObj.noteType,'xsi:type','xsd:int');if(!angular.isUndefined(rxObject.orderProtocolType))addElement(xw,"orderProtocolType",rxObject.orderProtocolType,'xsi:type','xsd:int');if(!angular.isUndefined(rxObject.orderPriority))addElement(xw,"orderPriority",rxObject.orderPriority,'xsi:type','xsd:int')}try{if(trimData(rxObject.AdministerFlagValue)===""){rxObject.AdministerFlagValue='0'}if(trimData(rxObject.DispenseFlagValue)===""){rxObject.DispenseFlagValue='0'}if(trimData(rxObject.mailOrderFlagValue)===""){rxObject.mailOrderFlagValue='0'}if(trimData(rxObject.rxCardFlagValue)===""){rxObject.rxCardFlagValue='0'}if(trimData(rxObject.rxFormularyId)===""){rxObject.rxFormularyId='0'}if(trimData(rxObject.IVHydration)===""){rxObject.IVHydration='0'}if(getItemKeyValue("isFormularyEnabled").toLowerCase()==="yes"){addElement(xw,"Administered",rxObject.AdministerFlagValue,'xsi:type','xsd:string');addElement(xw,"Dispense",rxObject.DispenseFlagValue,'xsi:type','xsd:string');addElement(xw,"mailOrder",rxObject.mailOrderFlagValue,'xsi:type','xsd:string');addElement(xw,"rxCard",rxObject.rxCardFlagValue,'xsi:type','xsd:string');addElement(xw,"rxFormularyId",rxObject.rxFormularyId,'xsi:type','xsd:string');addElement(xw,"IVHydration",rxObject.IVHydration,'xsi:type','xsd:string')}}catch(e){}if(rxObject.isRtbcRxObject){addElement(xw,"rtbcRxFlag","<![CDATA["+rxObject.isRtbcRxObject+"]]>",'xsi:type','xsd:string');if(rxObject.description){addElement(xw,"rtbcDrugName","<![CDATA["+rxObject.description+"]]>",'xsi:type','xsd:string')}if(rxObject.pharmacyNCPDPId){addElement(xw,"rtbcPharmNCPDP","<![CDATA["+rxObject.pharmacyNCPDPId+"]]>",'xsi:type','xsd:string')}if(rxObject.drugInteractionMsg){addElement(xw,"rtbcDrugIntMsg","<![CDATA["+rxObject.drugInteractionMsg+"]]>",'xsi:type','xsd:string')}addElement(xw,"rtbcDuration","<![CDATA["+rxObject.duration+"]]>",'xsi:type','xsd:string');addElement(xw,"rtbcDispense","<![CDATA["+rxObject.dispense+"]]>",'xsi:type','xsd:string');if(rxObject.patientPayAmt){addElement(xw,"rtbcPayAmt","<![CDATA["+rxObject.patientPayAmt+"]]>",'xsi:type','xsd:string')}if(rxObject.ePAFlag){addElement(xw,"rtbcEPAFlag","<![CDATA["+rxObject.ePAFlag+"]]>",'xsi:type','xsd:string')}if(rxObject.serviceCodeDUR){addElement(xw,"rtbcServiceCodeDUR","<![CDATA["+rxObject.serviceCodeDUR+"]]>",'xsi:type','xsd:string')}if(rxObject.pharmacyName){addElement(xw,"rtbcPharmacyName","<![CDATA["+rxObject.pharmacyName+"]]>",'xsi:type','xsd:string')}if(rxObject.isAlternatePharmacy){addElement(xw,"rtbcAlternatePharmacyFlag","<![CDATA["+rxObject.isAlternatePharmacy+"]]>",'xsi:type','xsd:string')}if(rxObject.isAlternateMedication){addElement(xw,"rtbcAlternateMedicationFlag","<![CDATA["+rxObject.isAlternateMedication+"]]>",'xsi:type','xsd:string')}}if(doseCheckEnabled()&&rxObject.doseCheckData){var doseCheckData=JSON.stringify(rxObject.doseCheckData);addElement(xw,"doseCheckData","<![CDATA["+doseCheckData+"]]>",'xsi:type','xsd:string')}if(rxObject.isFromEPA&&rxObject.rxDetailId){addElement(xw,"epaRxDetailId","<![CDATA["+rxObject.rxDetailId+"]]>",'xsi:type','xsd:string')}if(scope.context==="dermExecScreen"){scope.$parent.prepareSelectedObservationList();addElement(xw,"assessmentCode","<![CDATA["+trimData(scope.nSelectedAssessmentCode)+"]]>",'xsi:type','xsd:string');addElement(xw,"observationDetailId","<![CDATA["+trimData(scope.qsrequestObj.selectedObservations)+"]]>",'xsi:type','xsd:string')}xw.writeEndElement();xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();var assmtData="&specify="+encodeURIComponent(trimData(scope.oItemData.specify))+"&notes="+encodeURIComponent(trimData(scope.oItemData.notes))+"&OnsetDate="+trimData(scope.oItemData.OnsetDate)+"&risk="+trimData(scope.oItemData.risk)+"&hasSupplementDetails"+trimData(scope.oItemData.hasSupplementDetails);if(scope.dosageResultSet[scope.selectedIndex].isSplitPharmacy){rxService.saveSplitPrescription(scope.nEncounterId,scope.dosageResultSet[scope.selectedIndex].splitRx.assessId,scope.dosageResultSet[scope.selectedIndex].splitRx)}let url="/mobiledoc/jsp/catalog/xml/rx/saveRx.jsp";if(scope.selectedRxObject.isSunohMappedOrder||scope.context==='SunohQuickOrders'||scope.context==='rxQuickOrderScreen'){url="/mobiledoc/emr/sunoh.ecw/accept-rx";scope.showLoadingImage()}$http({method:"POST",url:makeURL(url),data:"EncounterId="+scope.nEncounterId+"&AsmtId="+scope.nSelectedAssessmentId+assmtData+"&requestFrom=saveRx&type=ModernRx&parentFrom=QuickOrderSearch&TrUserId="+scope.nTrUserId+"&FormData="+encodeURIComponent(xml)+"&rnd2="+Math.random()}).success(function(msg){if(msg.length>0&&msg.indexOf("failed")<0){if(!scope.selectedRxObject.isSunohMappedOrder){scope.showHideLevel2Div('hide')}if(!scope.bDxExistForVisit)scope.loadDxListInQSD();scope.bDxExistForVisit=true;var OrderStatObj={sRequestType:'neworder',sOrderType:'rxorder',sStatus:'',sOrderName:rxObject.description,sFailedReason:''};if(scope.context==="ascOrdersScreen"){strUrl=makeURL("/mobiledoc/ascWeb/ASC/PnIpOrders.go/Orders/loadASCOrders?sRequestFrom=ascOrdersScreen&sRequestType=updateAssmts&actionType=processQuickSearchOrder&orderDetailsObject="+encodeURIComponent(JSON.stringify(scope.selectedRxObject)));$http.post(strUrl).then(function(data){OrderStatObj.sStatus='success';quickSearchNS.showOrdStatus(itemName,'success',scope.randNum,scope.nShowInPlaceAlertStatus);scope.setDataInParentScreen('neworder',OrderStatObj)})}else if(scope.context==='dermExecScreen'){OrderStatObj.sStatus='success';showRxOrderStatus(itemName);scope.setDataInParentScreen('neworder',OrderStatObj)}else if(scope.selectedRxObject.isSunohMappedOrder){if(scope.context==='SunohQuickOrders'){let message=escapeHtml(itemName)+' Ordered.';notification.show('success','Sunoh',message,4e3)}try{rxObject.assessId=parseInt(scope.nSelectedAssessmentId)}catch(e){}if(itemName){rxObject.itemName=itemName}if(itemId!==0){rxObject.ItemId=itemId}rxObject.context=scope.context;$rootScope.$broadcast('sunohRxOrderAcceptClicked',rxObject)}else{OrderStatObj.sStatus='success';showRxOrderStatus(itemName);scope.setDataInParentScreen('neworder',OrderStatObj);if(scope.context==='SunohQuickOrders'){rxObject.fromSunohQuickSearch=true;$rootScope.$broadcast('sunohRxOrderAcceptClicked',rxObject)}}if(scope.context==='FHIRTreatment'){scope.$parent.meic.FHIRIObjSelectedRxName=itemName;scope.$parent.meic.setqsDetails()}else if(scope.selectedRxObject.isSunohMappedOrder||scope.context==='SunohQuickOrders'||scope.context==='rxQuickOrderScreen'){scope.hideLoadingImage();refreshDashboard(scope.nEncounterId,scope.nPatientId,"","pn")}}else{if(scope.enableCorrectionalFeatures&&msg&&msg.contains("failed:NDCMismatch")){let medNameForNDCMisMatch=itemName+" "+rxObject.strength+" "+rxObject.formulation;let msg="The medication(s) cannot be saved because the NDC for "+medNameForNDCMisMatch+" is not correct.<br>Try to correct NDC from Admin -> Rx Classification -> Click Edit icon for respective dosage.";ecwAlert(msg)}else{ecwAlert("Error: adding medication.")}if(scope.selectedRxObject.isSunohMappedOrder||scope.context==='SunohQuickOrders'||scope.context==='rxQuickOrderScreen'){scope.hideLoadingImage()}}}).error(function(error){if(scope.selectedRxObject.isSunohMappedOrder||scope.context==='SunohQuickOrders'||scope.context==='rxQuickOrderScreen'){scope.hideLoadingImage()}ecwAlert('Medication is not ordered!');console.log("An error occured: "+error.status+" "+error.statusText)});scope.selectedRxObject.nItemId=0};function showRxOrderStatus(itemName){var orderedRxName="";if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter")if(!angular.isUndefined(scope.selectedRxObjectBrandName)&&scope.selectedRxObjectBrandName!==""&&scope.selectedRxObjectBrandName.length>0)orderedRxName=scope.selectedRxObjectBrandName;else orderedRxName=itemName;else orderedRxName=itemName;quickSearchNS.showOrdStatus(orderedRxName,'success',scope.randNum,scope.nShowInPlaceAlertStatus)}function processFormularyApprovalForm(rxObject){if(scope.enableDOCFormulary&&scope.enableCorrectionalFeatures){if($('#TJellyDetailViewd #formularyApporvalForm').length){$('#formularyApporvalForm').insertAfter($("#TJellyDetailViewd"))}rxObject.formularystatus=parseInt(rxObject.formularystatus,10);var TEMPLATE_USER=8663;if(TEMPLATE_USER!==parseInt(scope.nPatientId,10)&&(rxObject.formularystatus===2||rxObject.formularystatus===4)){try{if(rxObject.formularystatus===4){ecwAlert(scope.selectedRxObject.sItemName+" "+rxObject.strength+" is a Non-formulary drug. In order for this drug to be given an approval must be attained. Please click OK button to fill and print the approval form.","",function(){setRxApprovalFormDataByEncId(scope.selectedRxObject.sItemName,rxObject.strength,rxObject.take,rxObject.route,rxObject.freq,rxObject.formularystatus,scope.nEncounterId,scope.nSelectedAssessmentName);$('#formularyApporvalForm').modal()},"","","",false,'formulary-alert-display')}else if(rxObject.formularystatus===2){ecwAlert(scope.selectedRxObject.sItemName+" "+rxObject.strength+" is a Restricted drug. <br> The drug restriction is follows: "+rxObject.formularystatusreason+". If you do not meet the restriction criteria, then approval must be attained. Please click OK button to fill and print the approval form.","",function(){setRxApprovalFormDataByEncId(scope.selectedRxObject.sItemName,rxObject.strength,rxObject.take,rxObject.route,rxObject.freq,rxObject.formularystatus,scope.nEncounterId,scope.nSelectedAssessmentName);$('#formularyApporvalForm').modal()},"","","",false,'formulary-alert-display')}else{setRxApprovalFormDataByEncId(scope.selectedRxObject.sItemName,rxObject.strength,rxObject.take,rxObject.route,rxObject.freq,rxObject.formularystatus,scope.nEncounterId,scope.nSelectedAssessmentName);scope.correctionalFlag_showRxApprovalForm=true;$('#formularyApporvalForm').modal()}}catch(err){ecwAlert("Not able to show Restricted/Non-Formulary Approval Form")}}}}scope.changeDiscontinuedFlag=function(obj){if(scope.showDiscontinuedDrugs===-1){scope.showDiscontinuedDrugs=0;var userProfileKeyValPair={};userProfileKeyValPair["ShowDiscontinuedDrugs"]=0;updateUserProfileLocalCache("ShowDiscontinuedDrugs",0);saveUserProfileSettings(userProfileKeyValPair)}else{scope.showDiscontinuedDrugs=-1;var userProfileKeyValPair={};userProfileKeyValPair["ShowDiscontinuedDrugs"]=1;updateUserProfileLocalCache("ShowDiscontinuedDrugs",1);saveUserProfileSettings(userProfileKeyValPair)}};scope.showIconForDiscontinuedRx=function(dose,selectedObject){try{if(scope.showDiscontinuedDrugs===0){scope.showDiscontinuedRxIcon=false;dose.showIcon=false;return false}else{if(dose.hasOwnProperty('ObsoleteDate')){if(dose.ObsoleteDate!==''){if(dose.hasOwnProperty("IsRxSupplies")&&angular.$$lowercase(dose.IsRxSupplies)==='no'){scope.showDiscontinuedRxIcon=true;dose.showIcon=true;return true}else{dose.showIcon=false;return true}}else{dose.showIcon=false;return false}}if(scope.b_MedispanEnabled==='no'){if(scope.formularyInfo.hasOwnProperty("FormularySourceCode")&&scope.formularyInfo.FormularySourceCode!==""){if(dose.hasOwnProperty("brand_code")&&dose.hasOwnProperty("synonymid")){dose.brand_code=dose.brand_code===""||dose.brand_code==="0"||dose.brand_code===0?scope.selectedRxDrugNameId:dose.brand_code;if(dose.brand_code===dose.synonymid){if(selectedObject.hasOwnProperty('isObsolete')&&selectedObject.isObsolete==='T'){scope.showDiscontinuedRxIcon=true;dose.showIcon=true;return true}}else{dose.showIcon=false;return false}}dose.showIcon=false;return false}else{if(selectedObject.hasOwnProperty('isObsolete')&&selectedObject.isObsolete==='T'){scope.showDiscontinuedRxIcon=true;dose.showIcon=true;return true}dose.showIcon=false;return false}}}}catch(e){}};scope.getSelectedDoseIndex=function(medication){let index;let doseFound=false;for(let i=0;i<scope.dosageResultSet.length&&doseFound===false;i++){if(compareMedInfo(medication,i)&&(scope.context!=="rxQuickOrderScreen"||scope.context==="rxQuickOrderScreen"&&i===medication.selectedIndex)){doseFound=true;index=i}}return index};function compareMedInfo(medication,i){return trimData(scope.dosageResultSet[i].ndc)===trimData(medication.NDC)&&trimData(scope.dosageResultSet[i].strength)===trimData(medication.dosage)&&trimData(scope.dosageResultSet[i].formulation)===trimData(medication.Formulation)&&trimData(scope.dosageResultSet[i].route)===trimData(medication.route)}scope.initilizeBeforeSunohSave=function(medication){scope.selectedRxObject={};scope.selectedRxName=medication.name;if(scope.context!=="rxQuickOrderScreen"){scope.selectedRxItemId=medication.itemid}scope.selectedRxObject.ItemId=scope.selectedRxItemId;scope.selectedRxObject.nItemId=scope.selectedRxItemId;scope.selectedRxObject.sItemName=scope.selectedRxName;scope.selectedRxObject.rxOrderNumber=medication.RxOrderNo;if(scope.b_MedispanEnabled==='yes'){scope.selectedRxObject.nParentID=scope.MedispanId;scope.selectedRxObject.sDrugNameId=medication.drugId;scope.selectedRxObject.sKeyname='rxmedispan'}else{scope.selectedRxObject.nParentID=scope.MultumId;scope.selectedRxObject.sSupplierId=medication.drugId;scope.selectedRxObject.sKeyname='rx'}scope.oItemData=scope.selectedRxObject;scope.selectedRxObject.isSunohMappedOrder=true;scope.nSelectedAssessmentId=medication.assmtId;if(medication.status){scope.selectedRxObject.rxStatus={"Id":"1","name":medication.status}}if(scope.nEncounterId>0){scope.getRxandDx(scope.nEncounterId,scope.nPatientId,0,global.TrUserId,medication.callBackFunction)}};scope.getDoseCallBack=function(calledFrom,rxObj){if(calledFrom==="SunohMappedRx"){scope.qsrequestObj.sunohOrderRx(rxObj,true)}else if(calledFrom==="SunohMappedEditRx"){scope.qsrequestObj.sunohEditRx(rxObj,true)}else if(calledFrom==="SunohGetDoseMappedRx"){scope.qsrequestObj.sunohGetDose(rxObj,true)}else{scope.showHideLevel2Div('show')}};scope.qsrequestObj.sunohGetDose=function(medication,dosagesLoaded){if(!dosagesLoaded){scope.getDosage(medication.drugId,medication.itemid,0,medication,"SunohGetDoseMappedRx");return}scope.initilizeBeforeSunohSave(medication);prgNoteCurrTab="";scope.selectedRxObject.doNotOpenFirstLevelDiv=1;scope.qsDirectiveRowClickHanlder(scope.oItemData)};scope.qsrequestObj.sunohOrderRx=function(medication,dosagesLoaded){if(scope.getDosage===undefined){let appElement=document.querySelector('#quickSunohQuickSearchLookup .quick-search-modern-style');if(appElement){let scopeQuickSearch=angular.element(appElement).scope();scope=scopeQuickSearch}}if(!dosagesLoaded&&medication.callFrom!=="addWithoutSig"){let rxType=0;if(medication.favorite&&(medication.favorite==="1"||medication.favorite==="2")){rxType=1}scope.getDosage(medication.drugId,medication.itemid,rxType,medication,"SunohMappedRx");return}if(medication.context&&medication.context==='rxQuickOrderScreen'){scope.context=medication.context}if(medication.callFrom==="addWithoutSig"){medication.callBackFunction="addWithoutSig"}else{let index=scope.getSelectedDoseIndex(medication);scope.selectedIndex=index;medication.callBackFunction="selectDosage"}scope.initilizeBeforeSunohSave(medication)};scope.qsrequestObj.sunohEditRx=function(medication,dosagesLoaded){if(scope.getDosage===undefined){let appElement=document.querySelector('#quickSunohQuickSearchLookup .quick-search-modern-style');if(appElement){let scopeQuickSearch=angular.element(appElement).scope();scope=scopeQuickSearch}}if(!dosagesLoaded){let rxType=0;if(medication.favorite&&(medication.favorite==="1"||medication.favorite==="2")){rxType=1}scope.getDosage(medication.drugId,medication.itemid,rxType,medication,"SunohMappedEditRx");return}let index=scope.getSelectedDoseIndex(medication);scope.initilizeBeforeSunohSave(medication);scope.rxEditClicked(index)};scope.qsrequestObj.sunohSetDx=function(assessmentId){if(trimData(assessmentId)!==''){let dxObj={AssessmentId:assessmentId.toString()};addAndSelectDxInArray(dxObj)}};scope.qsrequestObj.getDxList=function(){return{Dx:scope.qsDxList.Dx,probListDx:scope.qsDxList.probListDx,prevDx:scope.qsDxList.prevDx}}}}}}).directive('whenScrolled',function(){return function(scope,elm,attr){var raw=elm[0];elm.bind('scroll',function(){if(raw.scrollTop+raw.offsetHeight>=raw.scrollHeight){scope.$apply(attr.whenScrolled)}})}});var topClassDivIdForStOrders="";var nRandomNumForQSD="";var quick_search_callFrom="";$(document).on('click','.qs-directive .standing-orders-div',function(e){var _that=this;$('#'+topClassDivIdForStOrders).show().animate({},100,function(){$(this).position({of:_that,my:'center-50 top+14',at:'center top',collision:"flipfit"}).animate({"opacity":1},100)})});function moveDxDiv(id,spd,nRandNumber){var sId=id+"-"+nRandNumber;var obj=document.getElementById(sId),max=-obj.offsetHeight+obj.parentNode.offsetHeight,top=parseInt(obj.style.top);if(spd>0&&top<=0||spd<0&&top>=max){obj.style.top=top+spd+"px";moveDxDiv.to=setTimeout(function(){moveDxDiv(id,spd,nRandNumber)},20)}else{obj.style.top=(spd>0?0:max)+"px"}}
var isTwoFAEnabled="";var isEmailToVerify=false;angular.module('webemrApp',["ngRoute",'cfp.hotkeys']).controller('userProController',userProController);function userProController($scope,$ocLazyLoad,dataTruncUtilityService,$timeout){$scope.isSecurityPopupOpen=false;if(getItemKeyValue("i18nEnabled").toLowerCase()!='yes'){$("#umobile").mask("999-999-9999")}else{applyMask("umobile")}$scope.openResetFaceId=function(){$scope.loadURL="";$scope.isFaceSetupReset=true;$ocLazyLoad.load({name:'faceIdSetupApp',files:['/mobiledoc/jsp/webemr/login/css/10ewidget.css','/mobiledoc/jsp/webemr/login/css/fis.css','/mobiledoc/jsp/webemr/login/css/face-setup.css','/mobiledoc/jsp/webemr/login/webcamjs/webcam.min.js','/mobiledoc/jsp/webemr/login/webcamjs/faceIDSetupController.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/login/faceIdSetupContent.jsp");$scope.loadURL=url},function(e){console.log(e)})};$scope.goToChangePwd=function(){var url=makeURL("/mobiledoc/jsp/webemr/menu/file/changePassword.jsp");$ocLazyLoad.load({name:'',files:['/mobiledoc/jsp/webemr/menu/file/changePassword.js']}).then(function(){$scope.changePasswordUrl=url},function(e){console.log(e)})};$scope.goToLoginSettings=function(){$('#jtn-userprofile').modal('hide');window.location="#/mobiledoc/jsp/webemr/uadmin/provider/LoginSettings.jsp"};$scope.checkMail=function(){var uemail=$('#uemail').val();var verifiedMail=$('#verifiedMail').val();$('#emailVerificationDiv').hide();$('#emailErrorMsg').hide();if(uemail==null||uemail==""||!validateEmail()){$('#emailErrorMsg').show();$('#emailVerificationDiv').show();$('#codeStatus').removeClass('user-email-verified');$('#codeStatus').addClass('user-email-unverified')}else{$('#codeStatus').removeClass('user-email-unverified');$('#codeStatus').addClass('user-email-verified');if(verifiedMail==null||verifiedMail==""||uemail!=verifiedMail){$('#emailVerificationDiv').show();$('#codeStatus').removeClass('user-email-verified');$('#codeStatus').addClass('user-email-unverified');$('#isMailChanged').val("Y")}}};$scope.updateUserLogs=function(){$("#usrLogTable").empty();var nResults=$('#nResults :selected').text();if(nResults==null||nResults==undefined||nResults==""){nResults=5}var uid=$("#userProId").val();var requestJSON={uid:uid,nResults:nResults};var url="/mobiledoc/jsp/webemr/uadmin/requestHandler.jsp?requestFor=getUserLoginDetails";$.ajax({url:url,data:$.param({requestJSON:JSON.stringify(requestJSON)}),"async":false,success:function(response){var resultJson=response;var nRecords=Object.keys(resultJson).length;for(var i=1;i<=nRecords;i++){var key="userJson"+i;if(resultJson[key]){var tr="<tr><td>"+escapeHtml(resultJson[key]['HostIP'])+"</td><td>"+escapeHtml(resultJson[key]['LastloginTime'])+"</td><td>"+escapeHtml(resultJson[key]['lastLogoutTime'])+"</td></tr>";$('#usrLogTable').append(tr)}}}})};$scope.closeUserProfile=function(){$scope.validation['show']=false;$scope.validation['msg']=''};$scope.saveUserProfile=function(){$('#emailErrorMsg').hide();$scope.validation['show']=false;$scope.validation['msg']='';var varUfname=$("#ufname").val();if(!varUfname||varUfname.toString().trim().length===0){$scope.validation['show']=true;$scope.validation['msg']='Please enter First Name.';$("#ufname").focus();return false}var varUlname=$("#ulname").val();if(!varUlname||varUlname.toString().trim().length===0){$scope.validation['show']=true;$scope.validation['msg']='Please enter Last Name.';$("#ulname").focus();return false}var varUmobile=$("#umobile").val();var varUemail=$("#uemail").val();var varUserType=$("#userType").val();var isMailChanged=$("#isMailChanged").val();var uid=$("#userProId").val();var picId=$("#picId").val();var otpType=$('#otpType option:selected').val();var OTPReset=$("#OTPReset").prop('checked');let isDataValid=dataTruncUtilityService.getTextFieldWidthsFromTable('user_profile','jtn-userprofile','bluetheme');if(!isDataValid){return false}if(OTPReset==true){OTPReset="Y"}else{OTPReset="N"}if(!varUemail||validateEmail()){requestJSON={ufname:varUfname,ulname:varUlname,umobile:varUmobile,uemail:varUemail,isMailChanged:isMailChanged,uid:uid,picId:picId,isTwoFAEnabled:isTwoFAEnabled,userType:varUserType};if(isTwoFAEnabled!="N"){requestJSON.otpType=otpType;requestJSON.OTPReset=OTPReset}strRequestJSON=JSON.stringify(requestJSON);$.ajax({url:'/mobiledoc/jsp/webemr/security/saveUserProfile?action=1009',type:"POST","async":false,data:{requestJSON:strRequestJSON},success:function(result){if(result==='Invalid Email'){$('#emailErrorMsg').show();$('#codeStatus').removeClass('user-email-verified');$('#codeStatus').addClass('user-email-unverified')}else{ecwAlert(result,"eClinicalWorks");$('#jtn-userprofile').modal('hide')}},error:function(request,textStatus,errorThrown){ecwAlert("Some error occurred while processing the request. Please try again.","eClinicalWorks");$('#jtn-userprofile').modal('hide')}})}else{$('#emailErrorMsg').show();$('#codeStatus').removeClass('user-email-verified');$('#codeStatus').addClass('user-email-unverified')}};$scope.getUserProfileData=function(){$scope.validation={};$('#validateUserCredentials').on('hide.bs.modal',function(e){if(isEmailToVerify==true){if(isMailVerifiedPopUpCancel==true){$('#emailErrorMsg').hide();verifyUserEmail();isMailVerifiedPopUpCancel=false;isEmailToVerify=false}}});$('#emailErrorMsg').hide();$("#usrLogTable").empty();var nResults=$('#nResults :selected').text();if(nResults==null||nResults==undefined||nResults==""){nResults=5}var requestJSON={nResults:nResults};var url="/mobiledoc/jsp/webemr/uadmin/requestHandler.jsp?requestFor=getUserProfileData";$('#otpEnabledDiv').hide();$('#otpDisabledDiv').hide();$.ajax({url:url,data:$.param({requestJSON:JSON.stringify(requestJSON)}),"async":false,success:function(response){var resultJson=response;var uname=resultJson.userName;var ufname=resultJson.userFName;var ulname=resultJson.userLName;var uemail=resultJson.userEmail;var umobile=resultJson.userMobile;var userType=resultJson.userType;var isMailVerified=resultJson.isMailVerified;$('#unameProfile').val(uname);$('#ufname').val(ufname);$('#ulname').val(ulname);$('#uemail').val(uemail);$('#umobile').val(umobile);$('#userType').val(userType);if(uemail!=null&&uemail!=""){if(isMailVerified!=null&&isMailVerified!=undefined&&isMailVerified=="YES"){$('#emailVerificationDiv').css('display','none');$('#codeStatus').removeClass('user-email-unverified');$('#codeStatus').addClass('user-email-verified');$('#verifiedMail').val(uemail)}else{$('#emailVerificationDiv').css('display','inline-block');$('#codeStatus').removeClass('user-email-verified');$('#codeStatus').addClass('user-email-unverified');$('#verifiedMail').val("")}}else{$('#codeStatus').removeClass('user-email-unverified');$('#codeStatus').removeClass('user-email-unverified')}var isFaceRecognitionEnabledForPractice=resultJson.isFaceRecognitionEnabledForPractice;isTwoFAEnabled=resultJson.isTwoFAEnabledStr;var otpType=resultJson.otpType;$('#faceIdSetup').hide();$('#faceRecognition').hide();$("#otpType").attr("disabled",false);$("#OTPReset").attr("disabled",false);var faceEnabledForUser=isFaceRecognitionEnabledForPractice&&otpType==="face";if(isTwoFAEnabled!=null&&isTwoFAEnabled!=undefined&&isTwoFAEnabled!='N'&&(otpType!=="face"||isFaceRecognitionEnabledForPractice)){$('#otpEnabledDiv').show();$("#otpType").val(otpType).change();$('#otpDisabledDiv').hide();if(faceEnabledForUser){$('#faceIdSetup').show();$('#faceRecognition').show();$("#otpType").attr("disabled",true);$("#OTPReset").attr("disabled",true)}}else{$('#otpEnabledDiv').hide();$('#otpDisabledDiv').show()}var strPicPath=resultJson.strPicPath;var nPicId=resultJson.nPicId;$("#proPic").attr("src",strPicPath);$('#picId').val(nPicId);$('div').removeClass('img-selected');var imageDivId="img"+nPicId+"-sel";$('#'+imageDivId).addClass('img-selected');var nRecords=Object.keys(resultJson).length;for(var i=1;i<=nRecords;i++){var key="userJson"+i;if(resultJson[key]){var tr="<tr><td>"+escapeHtml(resultJson[key]['HostIP'])+"</td><td>"+escapeHtml(resultJson[key]['LastloginTime'])+"</td><td>"+escapeHtml(resultJson[key]['lastLogoutTime'])+"</td></tr>";$('#usrLogTable').append(tr)}}}})};$scope.securityIconPopup=function(value){$("#monumentLi").addClass("active");$("#animalLi").removeClass("active");$("#landscapeLi").removeClass("active");$scope.isSecurityPopupOpen=value;$timeout(function(){loadImageEvents()},600)};$('.close-sec').on('click',function(){$('.security-popup').hide()});$('.security-popup').hide();$('.img-wrappersec').show();$('.imagesDiv a').on('click',function(){$('.img-wrappersec').show();$('.security-popup,.security-data').hide()});$('#choose-img').on('click',function(){$('.security-popup').show();monumentClick()});$('.edt_pf.left0').on('click',function(){$('.security-popup').show();monumentClick()});$('.setting-lg').on('click',function(){$(this).closest('.jtnpro-profile').removeClass('open');$('#jtn-userprofile').modal();$scope.getUserProfileData();$scope.updateUserLogs();$('.security-data').show()});$(document).on('click',function(e){var filterDroupdown=$('.security-popup');var filterBtn=$('.for-security-sec');if(!filterDroupdown.is(e.target)&&filterDroupdown.has(e.target).length===0&&!filterBtn.is(e.target)&&filterBtn.has(e.target).length===0){filterDroupdown.hide()}});$(document).on('click','.selection-click',function(e){var _that=$(this).closest('.select-box');$(document).find('.selection-options').removeClass('open');$(document).off('click.dropdownclose');if($(this).parent().find('.selection-options').hasClass('open')){$(this).parent().find('.selection-options').removeClass('open')}else{if(!$(this).hasClass('drop-up')){$(this).parent().find('.selection-options').addClass('open');$(this).parent().find('.selection-options').show().animate({},100,function(){$(this).position({of:_that,my:'left top+24',at:'left top',collision:"flipfit"}).animate({"opacity":1},100)})}else{$(this).parent().find('.selection-options').addClass('open');$(this).parent().find('.selection-options').show().animate({},100,function(){$(this).position({of:_that,my:'left bottom-24',at:'left bottom',collision:"flipfit"}).animate({"opacity":1},100)})}$(document).on('click.dropdownclose',function(e){var container=$('.selection-options');var containerPrev=$('.selection-click');if(!container.is(e.target)&&container.has(e.target).length===0&&!containerPrev.is(e.target)){container.removeClass('open');$(document).off('click.dropdownclose');$(document).off('click','.selection-options > li')}});$(document).on('click','.selection-options > li',function(e){e.stopPropagation();var putText=$(this).text();$(this).parent().prev().text(putText);$(this).parent().prev('.selection-input').val(putText);$(this).parent().removeClass('open');$(document).off('click.dropdownclose');$(document).off('click','.selection-options > li')})}});function loadProfileImageEvents(){var id=$(this).attr('id');var picsrc=$(this).attr('src');$('#proPic').attr('src',picsrc);$('#picId').val(id);$('div').removeClass('img-selected');var imageDivId="img"+id+"-sel";$('#'+imageDivId).addClass('img-selected')}function loadImageEvents(){$('.propicsel').on('click',loadProfileImageEvents)}loadImageEvents();$('#otpType').on('change',function(){var otpType=$('#otpType option:selected').val();if(otpType=="SMS"){$('#footerMsg').html('Standard eClinicalMessenger Charges Apply.')}else{$('#footerMsg').html('')}});$('#uploadfile1').change(function(event){$scope.uploadImage(event)})}function showValidationPopup(){var uemail=$('#uemail').val();$('#emailErrorMsg').hide();if(validateEmail()){if(isSamlAuthEnabled){$('#emailErrorMsg').hide();verifyUserEmail();isMailVerifiedPopUpCancel=false;isEmailToVerify=false}else{if(uemail!=null&&uemail!=""){if(!isSessionExpiredPopupVisible){$("#validateUserCredentials").modal();$(".modal-backdrop").addClass("displaynone");$(".modal-backdrop").removeClass("sessiontimepoutbackdrop");$("#timeCntr").css("display","none");$('#sessExpErrormsg').html('');$('#passwordField').val('');$('#loginAgainBtn').val('Confirm');$("#cancelBtn").attr('onClick','hideAuthPopUp()');isEmailToVerify=true}}}}else{$('#emailErrorMsg').show();$('#codeStatus').removeClass('user-email-verified');$('#codeStatus').addClass('user-email-unverified')}}function hideAuthPopUp(){isEmailToVerify=false;$("#validateUserCredentials").modal('hide')}function validateEmail(){var uemail=$('#uemail').val();var emailReg=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;return emailReg.test(uemail)}function verifyUserEmail(){var uname=$('#unameProfile').val();var uemail=$('#uemail').val();if(uemail==null||uemail==""||uemail==undefined){uemail=$('#uemail').val()}$('#email1').text(uemail);$('#email2').text(uemail);var vCode=$('#vCode').val();$('#vCode').val("");if(uname!=null){var requestJSON={user:uname,uemail:uemail};if(vCode!=null&&vCode!=""&&vCode!=undefined){requestJSON.verificationCode=sha256Hash(vCode.trim())}var url="/mobiledoc/jsp/webemr/uadmin/requestHandler.jsp?requestFor=verifyEmailDetails";$.ajax({type:"POST",url:url,data:{requestJSON:JSON.stringify(requestJSON)},"async":true,success:function(response){var resultJson=response;if(resultJson!==null){if(resultJson.success){if(vCode!=null&&vCode!=""&&vCode!=undefined){$('#jtn-emailverify').modal('hide');showMessage("Your email id is verified. ")}else{$('#jtn-emailverify').modal('show');$('#jtn-userprofile').modal('hide')}}else{if(vCode!=null&&vCode!=""&&vCode!=undefined){showMessage(resultJson.errMsg,"eclinicalWorks")}else{showMessage("Something went wrong. Please try after some time.","eclinicalWorks")}}}},error:function(response){var resultJson=$.parseJSON(response);console.log("Error while verifying email id.");showMessage(resultJson.message,"eclinicalWorks")}})}}var monumentClick=function(){$('#monuments').removeClass('disables');$('#animals').addClass('disables');$('#landscapes').addClass('disables')};var animalClick=function(){$('#monuments').addClass('disables');$('#animals').removeClass('disables');$('#landscapes').addClass('disables')};var landscapeClick=function(){$('#monuments').addClass('disables');$('#animals').addClass('disables');$('#landscapes').removeClass('disables')};
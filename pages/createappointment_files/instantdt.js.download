(function(){const inputSelector="input[type='text'],input[type='textbox'],input:not([type]),textarea,[contenteditable],[designMode]";const pipelineSelector="iframe,input[type='text'],input[type='textbox'],input:not([type]),textarea,[contenteditable],[designMode]";const mutationConfig={attributes:true,childList:true,subtree:true,characterData:false,attributeFilter:["contenteditable"]};const playgroundDoc=document.createDocumentFragment();const relevantFieldItems={};let config={pattern:[{expr:"",description:"",nnflag:"",autoReplace:false}],exclusions:[{fieldSelector:"",endpointUrl:"",paramName:"",exclusionLevel:0}],substitutions:[{unicodeValue:"",replaceValue:"",autoReplace:0}]};async function getViewMappings(){return await $.ajax({url:"/mobiledoc/emr/instantdt/idt-views",type:"GET",data:{modality:"web"}})}async function getConfig(){return await $.ajax({url:"/mobiledoc/emr/instantdt/idt-config",type:"GET",data:{modality:"web"}})}function selectorIsValid(playground,selector){try{playground.querySelector(selector);return true}catch(e){return false}}function elementIsExcluded(element){if(element==null){return false}const match=config.exclusions.filter(item=>selectorIsValid(playgroundDoc,item.fieldSelector)&&element.matches(item.fieldSelector)&&(item.exclusionLevel===1||item.exclusionLevel===3));return match.length>0}function recordMissingMap(screenName,field,modality){if(getItemKeyValue("EnableInstantDataTruncationLogger").toLowerCase()!=="yes"){return}const keyRefs=["data-fieldname","ng-bind","data-ng-bind","ng-model","data-ng-model","name","id","class"];let fieldName="Unknown";let fieldType="Unknown";if(field!=null){for(let ref of keyRefs){const attr=field.getAttribute(ref);if(attr!=null&&attr.length>0){fieldType=ref;fieldName=attr;break}}}else{fieldName="Unknown"}$.ajax({url:"/mobiledoc/emr/instantdt/idt-log",type:"POST",data:{screenName:screenName,fieldName:fieldName,fieldType:fieldType,modality:modality}})}function getScreenDataFromRemote(idtElement){let response={data:[]};$.ajax({url:"/mobiledoc/emr/instantdt/idt-screen",type:"GET","async":false,data:{viewId:idtElement,modality:"web"},success:function(data){response=data},error:function(data){response=data}});return response}function getAvailableIdentifierForElement(element){const matches=[];const identifiers=Object.keys(relevantFieldItems);for(let item of identifiers){if(element.matches(item)){matches.push(item)}}if(matches.length===0){return undefined}else{matches.sort(SPECIFICITY.compare);return matches[matches.length-1]}}function getScreenDataFromSource(idtRefElement){if(idtRefElement==null){return[]}let validKeyName=getAvailableIdentifierForElement(idtRefElement);if(validKeyName==null){const idtElement=`${idtRefElement.nodeName.toLowerCase()}#${idtRefElement.getAttribute("id")}`;const response=getScreenDataFromRemote(idtElement);relevantFieldItems[idtElement]=response.data;return relevantFieldItems[idtElement]}else{if(relevantFieldItems[validKeyName]==null){const response=getScreenDataFromRemote(validKeyName);relevantFieldItems[validKeyName]=response.data}return relevantFieldItems[validKeyName]}}function getGenericValidationData(configuredMaxLength){let maxLengthAttVal=configuredMaxLength;if(maxLengthAttVal==null){maxLengthAttVal=Number.POSITIVE_INFINITY}let pattern=/^[a-zA-Z 0-9~`!@#$%^&*()-_+={[}\]|\\;:'",<>.\/?]+$/;if(config.pattern!=null&&config.pattern.expr!=null&&config.pattern.expr.length>0){pattern=atob(config.pattern.expr)}let description="All U.S. keyboard characters";let nnflag=1;if(config.pattern!=null){description=config.pattern.description;nnflag=config.pattern.nnflag}return{ecw_col_min_length:0,ecw_col_max_length:maxLengthAttVal,SpecialCharPattern:pattern,PatternDescription:description,nnflag:nnflag,autoReplace:true,genericIDT:true}}function getRelevantFieldsForElement(element,idtRefElement){const limits=getScreenDataFromSource(idtRefElement);let data=[];const keyRefs=["data-fieldname","ng-bind","data-ng-bind","ng-model","data-ng-model","name","id"];let attributeName="";for(attributeName of keyRefs){if(element.hasAttribute(attributeName)){data=limits.filter(item=>item.uiscreenfieldname===element.getAttribute(attributeName))}if(data.length>0){break}}let maxLengthAttVal=element.getAttribute("idt-maxlength");if(data.length>0){if(maxLengthAttVal!=null){let idx=0;if(maxLengthAttVal&&data[idx].ecw_col_max_length>0){let fieldMaxLength=parseInt(maxLengthAttVal,10);let metaLength=parseInt(data[idx].ecw_col_max_length,10);if(fieldMaxLength>0&&fieldMaxLength<metaLength){data[idx].ecw_col_max_length=maxLengthAttVal}}}}else{data=[getGenericValidationData(maxLengthAttVal)]}return data}function focusElement(element){element.classList.add("idt-alert-subject");window.idtFocusElement=element}function onFrameChange(iframe){if(iframe.contentWindow!=null){try{if(iframe.contentWindow.location.href!==iframe.currLoc){iframe.currLoc=iframe.contentWindow.location.href}if(iframe.contentWindow.idtObserver==null){iframe.contentWindow.dtValidation=dtValidation;iframe.contentWindow.idtObserver=observeMutations;setupListeners(iframe.contentWindow)}}catch(err){}}}function naHelperIsAbsent(windowContext){return new Promise(function(resolve,reject){(function(winCtx){if(winCtx!=null&&winCtx.na_isEnableFullRequestEncryption===undefined){return resolve(winCtx)}else{return reject(winCtx)}})(windowContext)})}function onFrameUnload(iframe){setTimeout(()=>onFrameChange(iframe),0)}function setupFrameHandler(iframe){try{if(iframe.contentWindow!=null){iframe.contentWindow.removeEventListener("unload",onFrameUnload);iframe.contentWindow.addEventListener("unload",()=>onFrameUnload(iframe))}}catch(err){}}function addStylesheet(element){if(element.ownerDocument.defaultView!==window.top&&element.ownerDocument.querySelector("link[href='/mobiledoc/jsp/webemr/css/instantdt.css']")==null){try{const cssLink=element.ownerDocument.createElement("link");cssLink.href="/mobiledoc/jsp/webemr/css/instantdt.css";cssLink.rel="stylesheet";cssLink.type="text/css";if(element.ownerDocument.head!=null){element.ownerDocument.head.appendChild(cssLink)}}catch(err){}}}function addObserver(iframe){let timeout=setTimeout(function(iframeObj){if(iframeObj.contentWindow!=null){iframeObj.contentWindow.addEventListener("click",monitorDocumentClick,true);naHelperIsAbsent(iframeObj.contentWindow).then(function(winCtx){new MutationObserver(observeMutations).observe(winCtx.document,mutationConfig)})["catch"](function(){});monitorElements(iframeObj.contentWindow.document)}clearTimeout(timeout)},1e3,iframe)}function setupIFrameHandlers(iframe,loaded){setupFrameHandler(iframe);onFrameChange(iframe);if(loaded){addObserver(iframe)}else{let timeout=setTimeout(function(iframeObj){addObserver(iframeObj);clearTimeout(timeout)},1e3,iframe)}}function loadFrame(iframe){iframe.loaded=true;setupIFrameHandlers(iframe,true)}function initFrame(iframe){iframe.currLoc=null;iframe.addEventListener("load",loadFrame.bind(null,iframe));let timeout=setTimeout(frame=>{if(frame.loaded===true){clearTimeout(timeout);return}setupIFrameHandlers(frame,false);clearTimeout(timeout)},1e3,iframe);setupFrameHandler(iframe)}function setupIFrame(iframe){if(iframe.hasAttribute("idt-check-valid")){return}iframe.setAttribute("idt-check-valid",1);initFrame(iframe)}function getFieldIdentifier(field){let screenIdentifier=field.closest("[id]");if(screenIdentifier!=null){screenIdentifier=`${screenIdentifier.nodeName.toLowerCase()}#${screenIdentifier.getAttribute("id")}`}else{screenIdentifier="Unknown"}return screenIdentifier}function showError(e,element,value,relevantField,validations,dataTypeArray,refElementId,valueHtml){e.preventDefault();if(willHandFocusToSecondValidation(element)){return false}element.classList.add("idt-subject-error");const uiGridElementParent=getUIGridElement(e.path,element);addStylesheet(element);showExpPrompt(element,value,valueHtml,uiGridElementParent,relevantField,validations,dataTypeArray);return true}function getUIGridElement(eventPath,element){let uiGridElementParent=undefined;if(element.hasAttribute("ui-grid-editor")){if(element.closest("[ui-grid-cell]")!=null){uiGridElementParent=element.closest("[ui-grid-cell]").querySelector("[ng-cell-text]");if(uiGridElementParent!=null){uiGridElementParent.classList.add("idt-subject-error");const gridCellInput=uiGridElementParent.querySelector("[data-fieldname]");if(gridCellInput!=null){gridCellInput.classList.add("idt-subject-error")}}}else{for(let item of eventPath){if(item.hasAttribute("ui-grid-cell")){uiGridElementParent=item.querySelector("[ng-cell-text]");uiGridElementParent.classList.remove("ui-grid-cell-focus");uiGridElementParent.classList.add("idt-subject-error");const gridCellInput=uiGridElementParent.querySelector("[data-fieldname]");if(gridCellInput!=null){gridCellInput.classList.add("idt-subject-error")}break}}}}return uiGridElementParent}function showExpPrompt(element,value,valueHtml,uiGridElementParent,relevantField,validations,dataTypeArray){const angularApp=angular.element(document.getElementById("webemrApp"));const $ocLazyLoad=angularApp.injector().get("$ocLazyLoad");const $modal=angularApp.injector().get("$modal");$ocLazyLoad.load({name:"ecw.global.instantdt",files:["/mobiledoc/jsp/webemr/templates/instantdt-tpl.js"]}).then(function(){let modalInstance=$modal.open({templateUrl:"/mobiledoc/jsp/webemr/templates/instantdt-tpl.html",controller:"InstantDTUIController",controllerAs:"idtController",windowClass:`medium-width idt-alert`,backdrop:"static",keyboard:false,resolve:{options:function(){return{value:{plain:value,html:valueHtml},validation:{metadata:relevantField,results:validations,dataType:dataTypeArray},source:{element:element,grid:uiGridElementParent},configuration:config,returnFocus:function(){if(uiGridElementParent!=null){uiGridElementParent.dispatchEvent(new MouseEvent('dblclick',{'view':window,'bubbles':true,'cancelable':true}))}let timeout=setTimeout(()=>{element.focus();focusElement(element);clearTimeout(timeout)})}}}}});modalInstance.result.then(function(){},function(modalResponse){if(uiGridElementParent!=null){uiGridElementParent.dispatchEvent(new MouseEvent('dblclick',{'view':window,'bubbles':true,'cancelable':true}));let timeout=setTimeout(function(){setOriginTextboxValue(uiGridElementParent.parentNode.querySelector("input[type='text']"),modalResponse);clearTimeout(timeout)})}else{setOriginTextboxValue(element,modalResponse)}element.removeAttribute("idt-popup-source");element.classList.remove("idt-subject-error");window.idtErrorElement=undefined})})}function setOriginTextboxValue(element,valueObj){let timeout=setTimeout(function(){if(isFormattedField(element)){element.innerHTML=valueObj.html}else{element.value=valueObj.value}updateWysEditor(element);["input","keydown","keyup"].forEach(event=>{element.dispatchEvent(new Event(event,{bubbles:true}))});element.focus();focusElement(element);clearTimeout(timeout)})}function updateWysEditor(element){if(element.classList.contains("wysihtml5-editor")){const subjectElement=getUpdatedSubjectElementIfEditor(element);if(subjectElement.hasAttribute("text-editor")){const editor=$(subjectElement).data("wysihtml5").editor;const value=editor.getValue();$(subjectElement).controller("ngModel").$setViewValue(value);editor.textarea.setValue(value);editor.currentView.setValue(value)}}}function shouldHandFocusToSecondValidation(frameDocument){const rvValidationPopup=frameDocument.getElementById("splcharstable");if(rvValidationPopup!=null){const modal=rvValidationPopup.closest(".modal.in");if(modal!=null&&getComputedStyle(modal).display!=="none"){return true}}const scdtValidationPopup=frameDocument.getElementById("generateDTSPLValidationMsgModal");if(scdtValidationPopup!=null&&getComputedStyle(scdtValidationPopup).display!=="none"){return true}const specialCharRemovedDialogue=frameDocument.getElementById("specialCharRemovedMessage");if(specialCharRemovedDialogue!=null&&getComputedStyle(specialCharRemovedDialogue).display!=="none"){return true}let dtValidationPopups;if(frameDocument.body!=null){dtValidationPopups=frameDocument.body.getElementsByClassName("dataTruncationMsgTbl")}else{dtValidationPopups=frameDocument.getElementsByClassName("dataTruncationMsgTbl")}if(dtValidationPopups!=null&&dtValidationPopups.length>0){for(let i=0;i<dtValidationPopups.length;i++){const popup=dtValidationPopups[i];const modal=popup.closest(".modal.in");if(modal!=null&&getComputedStyle(modal).display!=="none"){return true}}}let idtAlertPopups;if(frameDocument.body!=null){idtAlertPopups=frameDocument.body.getElementsByClassName("idt-alert")}else{idtAlertPopups=frameDocument.getElementsByClassName("idt-alert")}if(idtAlertPopups!=null&&idtAlertPopups.length>0){for(let i=0;i<idtAlertPopups.length;i++){const modal=idtAlertPopups[i].closest(".modal.in");if(modal!=null&&getComputedStyle(modal).display!=="none"){return true}}}return false}function willHandFocusToSecondValidation(element){const shouldHandFocus=shouldHandFocusToSecondValidation(element.ownerDocument);if(!shouldHandFocus){return shouldHandFocusToSecondValidation(document)}else{return shouldHandFocus}}function shouldSkipValidation(element){const skipCandidates=[element.hasAttribute("idt-popup-source"),!element.hasAttribute("idt-check-valid"),element.hasAttribute("readonly"),element.hasAttribute("disabled"),willHandFocusToSecondValidation(element),!element.hasAttribute("contenteditable")&&element.value==null];return skipCandidates.some(item=>item)}function isFormattedField(element){return element.hasAttribute("contenteditable")&&!element.matches("input[type='text']")&&!element.matches("input[type='textbox']")&&!element.matches("textarea")}function getElementTextWithoutHiddenCharacters(field,element){let replacedChars=false;const props=["value","innerHTML","innerText"];const charCodes=[160,8203,8239,65279];let isCodeAllowed=false;charCodes.forEach(code=>{isCodeAllowed=!dtValidation.validatePattern(field.SpecialCharPattern,"ecw"+String.fromCharCode(code)+"ecw",field.nnflag).includes(String.fromCharCode(code));if(isCodeAllowed){return}props.forEach(prop=>{if(element[prop]&&element[prop].includes(String.fromCharCode(code))){element[prop]=element[prop].replace(new RegExp(String.fromCharCode(code),"g")," ");replacedChars=true}})});return replacedChars}function getSubjectReferenceElements(eventPath,element){let dtSubjectElement=element;let idtRefElement=getAncestorBySelector(element,config.idtSources);if(element.hasAttribute("ui-grid-editor")){for(let item of eventPath){if(item.hasAttribute&&item.hasAttribute("ui-grid-cell")){dtSubjectElement=item.querySelector("[ng-cell-text] [data-fieldname]");if(idtRefElement!=null){break}}if(item===idtRefElement){idtRefElement=item;break}}}return{dtSubjectElement:dtSubjectElement,idtRefElement:idtRefElement}}function getUpdatedSubjectElementIfEditor(element){let dtSubjectElement=element;if(dtSubjectElement.classList.contains("cke_editable")||dtSubjectElement.classList.contains("wysihtml5-editor")){const isWys=dtSubjectElement.classList.contains("wysihtml5-editor");let ancestorSelector=".cke.cke_browser_webkit";let textareaSelector="textarea";if(isWys){ancestorSelector="iframe.wysihtml5-sandbox";textareaSelector="textarea"}const container=getAncestorBySelector(dtSubjectElement,ancestorSelector);if(container!=null){dtSubjectElement=Array.from(container.parentNode.children).filter(item=>item.matches(textareaSelector))[0]}}return dtSubjectElement}function getAllIFrames(){const frames=[];const fn=windowCtx=>{Array.from(windowCtx.document.body.getElementsByTagName("iframe")).forEach(iframe=>{try{return fn(iframe.contentWindow)}catch(e){return[]}});frames.push(...windowCtx.document.body.getElementsByTagName("iframe"))};fn(window.top);return frames}function getAncestorBySelector(element,selector){let allIFrames=undefined;let parent=element.parentNode;while(parent!=null){if(parent.matches&&parent.matches(selector)){return parent}else{if(parent.parentNode==null&&parent.defaultView===window.top){return null}if(parent.parentNode==null){if(element.ownerDocument.defaultView===window.top){return null}else{if(allIFrames==null){allIFrames=getAllIFrames()}const currentFrame=allIFrames.filter(item=>item.contentWindow===parent.defaultView);if(currentFrame.length===0){return null}else{parent=currentFrame[0]}}}else{parent=parent.parentNode}}}}function recordMissingField(idtRefElement,dtSubjectElement,element){let screenIdentifier;if(idtRefElement!=null){screenIdentifier=`${idtRefElement.nodeName.toLowerCase()}#${idtRefElement.getAttribute("id")}`}else{screenIdentifier=element.parentNode;if(screenIdentifier!=null){screenIdentifier=getFieldIdentifier(screenIdentifier)}else{screenIdentifier=getFieldIdentifier(element)}}const subj=dtSubjectElement!=null?dtSubjectElement:element;recordMissingMap(screenIdentifier,subj,"web")}function getValidationItems(element,relevantFields,refId,value,valueHtml,dataTypeCb){let allValidations=dtValidation.getTextValidations(relevantFields,refId,()=>{},false,[value],[valueHtml],true);const hasNonDataTypeErrors=["maxLength","minLength","maxValue","minValue","splChar"].some(x=>allValidations[x].length>0);if(hasNonDataTypeErrors){allValidations.dataType=[];return{allValidations:allValidations,dataType:[]}}if(allValidations.dataType.length>0){const businessDataType=dtValidation.validateBusinessDataType(allValidations.dataType);if(businessDataType.isBusinessDataValid===false){return{allValidations:allValidations,dataType:businessDataType}}else{return{}}}else{return{allValidations:allValidations,dataType:[]}}}function doConditionalAutoReplace(relevantFields,element){const allowsAutoReplace=relevantFields[0].autoReplace;if(idtConfig.autoReplace!==true||!allowsAutoReplace){return[]}return doAutoReplace(element,idtConfig.substitutions)}function unmarkElement(element,eventPath){element.classList.remove("idt-subject-error");if(element.hasAttribute("ui-grid-editor")){if(element.closest("[ui-grid-cell]")!=null){const uiGridElementParent=element.closest("[ui-grid-cell]").querySelector("[ng-cell-text]");if(uiGridElementParent!=null){uiGridElementParent.classList.remove("idt-subject-error");const gridCellInput=uiGridElementParent.querySelector("[data-fieldname]");if(gridCellInput!=null){gridCellInput.classList.remove("idt-subject-error")}}}else{for(let item of eventPath){if(item.hasAttribute("ui-grid-cell")){const uiGridElementParent=item.querySelector("[ng-cell-text]");uiGridElementParent.classList.remove("idt-subject-error");const gridCellInput=uiGridElementParent.querySelector("[data-fieldname]");if(gridCellInput!=null){gridCellInput.classList.remove("idt-subject-error")}break}}}}element.classList.remove("idt-alert-subject")}function valueIsInvalid(e,element){window.idtFocusElement=undefined;let[value,valueHtml]=getValuesForField(element);if(value.length===0&&valueHtml.length===0){unmarkElement(element,e.path);return false}if(shouldAllowInteractionWithElement(e)){return false}if(shouldSkipValidation(element)){unmarkElement(element,e.path);return false}let{dtSubjectElement,idtRefElement}=getSubjectReferenceElements(e.path,element);dtSubjectElement=getUpdatedSubjectElementIfEditor(dtSubjectElement);const relevantFields=getRelevantFieldsForElement(dtSubjectElement,idtRefElement);let didReplaceChars=getElementTextWithoutHiddenCharacters(relevantFields[0],element);if(didReplaceChars){element.dispatchEvent(new Event("input",{bubbles:true}))}const itemsReplaced=doConditionalAutoReplace(relevantFields,element);if(itemsReplaced.length>0){["input","keydown","keyup"].forEach(event=>{element.dispatchEvent(new Event(event,{bubbles:true}))});element.focus();showToasterForAutoReplace(itemsReplaced)}[value,valueHtml]=getValuesForField(element);value=value.trim();valueHtml=valueHtml.trim();const idtError=getValidationResults(relevantFields,dtSubjectElement,idtRefElement,value,valueHtml,element,e);if(idtError===false&&!element.hasAttribute("idt-popup-source")){unmarkElement(element,e.path)}return idtError}function shouldAllowInteractionWithElement(e){const attentionModals=["sessionExpiredMessageModal"];for(let modal of attentionModals){const modalRef=document.getElementById(modal);if(modalRef){const modalRequiresAttention=modalRef.contains(e.relatedTarget);if(modalRequiresAttention){$(modalRef).on("hidden.bs.modal",function(){e.target.focus()});return true}else{return false}}}}function getValuesForField(element){if(isFormattedField(element)){return[$(element).text(),$(element).html()]}else{return[element.value,element.value]}}function doAutoReplace(element,relevantSubstitutions){if(element.value!=null&&element.value.length>0){return autoReplaceStandardTextbox(element,relevantSubstitutions)}else{return autoReplaceHTMLBox(element,relevantSubstitutions)}}function autoReplaceStandardTextbox(element,relevantSubstitutions){const seenCharacters=new Set;let replaceList=[];relevantSubstitutions.forEach(item=>{if(item.autoReplace!==1){return}const character=String.fromCharCode(`0x${item.unicodeValue}`);const substitute=item.replaceValue;if(element.value.includes(character)){element.value=element.value.split(character).join(substitute);if(!seenCharacters.has(character)){seenCharacters.add(character);replaceList.push({unsupportedChar:character,substitute:substitute})}}});return replaceList}function autoReplaceHTMLBox(element,relevantSubstitutions){const seenCharacters=new Set;let replaceList=[];const textNodes=getTextNodesInElement(element);relevantSubstitutions.forEach(item=>{if(item.autoReplace!==1){return}const character=String.fromCharCode(`0x${item.unicodeValue}`);const substitute=item.replaceValue;textNodes.forEach(node=>{if(node.nodeValue.includes(character)){node.nodeValue=node.nodeValue.split(character).join(substitute);if(!seenCharacters.has(character)){seenCharacters.add(character);replaceList.push({unsupportedChar:character,substitute:substitute})}}})});if(replaceList.length>0){updateWysEditor(element)}return replaceList}function getTextNodesInElement(element){const nodes=[];const traverse=node=>{if(node.nodeType===Node.TEXT_NODE){if(!/^\s*$/.test(node.nodeValue)){nodes.push(node)}}else{node.childNodes.forEach(traverse)}};traverse(element);return nodes}function showToasterForAutoReplace(items){let closeTimeout=undefined;const closeNotification=()=>{toasterContainer.classList.remove("visible");let timeout=setTimeout(function(){toasterContainer.remove();clearTimeout(timeout)},100)};const scheduleForClose=function(){closeTimeout=setTimeout(function(){closeNotification()},1e4)};let toasterContainer=document.createElement("div");toasterContainer.className="idt-global-toaster";const lastToaster=$(".idt-global-toaster:last");toasterContainer.style.bottom=`${parseFloat(lastToaster.css("bottom"))+lastToaster.height()+10}px`;document.body.appendChild(toasterContainer);const progressBar=document.createElement("div");progressBar.className="toaster-progress-bar";toasterContainer.appendChild(progressBar);const contentContainer=document.createElement("div");contentContainer.className="toaster-container";toasterContainer.appendChild(contentContainer);const leftBar=document.createElement("div");leftBar.className="side-bar left";contentContainer.appendChild(leftBar);const leftBarIcon=document.createElement("img");leftBarIcon.src="/mobiledoc/jsp/webemr/img/infoicon.png";leftBarIcon.height=17;leftBar.appendChild(leftBarIcon);const textContainer=document.createElement("div");textContainer.className="text-container";contentContainer.appendChild(textContainer);const heading=document.createElement("span");heading.className="heading";heading.innerText="Unsupported Characters";textContainer.appendChild(heading);const subHeading=document.createElement("span");subHeading.className="subheading";if(items.length===1){subHeading.innerHTML="The following character was <u><b>auto-replaced</b></u> with its substitute:"}else{subHeading.innerHTML="The following characters were <u><b>auto-replaced</b></u> with their substitutes:"}textContainer.appendChild(subHeading);const replaceList=document.createElement("div");replaceList.className="replace-list";textContainer.appendChild(replaceList);items.forEach(item=>{const replaceItem=document.createElement("div");replaceItem.className="replace-item";replaceList.appendChild(replaceItem);const unsupportedChar=document.createElement("span");unsupportedChar.className="unsupported-character";unsupportedChar.innerText=item.unsupportedChar;replaceItem.appendChild(unsupportedChar);const separator=document.createElement("span");separator.className="item-separator";separator.innerHTML="&rarr;";replaceItem.appendChild(separator);const substituteValue=document.createElement("span");substituteValue.className="substitute-value";substituteValue.innerText=item.substitute;replaceItem.appendChild(substituteValue)});toasterContainer.onmouseenter=function(){toasterContainer.classList.remove("show-progress");clearTimeout(closeTimeout)};toasterContainer.onmouseleave=function(){toasterContainer.classList.add("show-progress");clearTimeout(closeTimeout);scheduleForClose()};const rightBar=document.createElement("div");rightBar.className="side-bar right";contentContainer.appendChild(rightBar);const rightBarIcon=document.createElement("img");rightBarIcon.src="/mobiledoc/jsp/webemr/img/closeicon.png";rightBarIcon.height=17;rightBarIcon.title="Dismiss";rightBarIcon.onclick=function(){closeNotification()};rightBar.appendChild(rightBarIcon);let timeout=setTimeout(function(){toasterContainer.classList.add("visible");toasterContainer.classList.add("show-progress");scheduleForClose();clearTimeout(timeout)})}function getValidationResults(relevantFields,dtSubjectElement,idtRefElement,value,valueHtml,element,e){if(relevantFields[0].genericIDT===true){recordMissingField(idtRefElement,dtSubjectElement,element)}let refId="webemrApp";if(idtRefElement!=null){refId=idtRefElement.getAttribute("id")}const validationsArray=getValidationItems(element,relevantFields,refId,value,valueHtml);if(validationsArray!=null&&Object.keys(validationsArray).length>0){const{allValidations,dataType}=validationsArray;if(allValidations.hasError===true){return showError(e,element,value,relevantFields[0],allValidations,dataType,refId,valueHtml)}}return false}function getPipelineItems(node){let items=[];if(node){items=node.querySelectorAll(pipelineSelector)}return items}function monitorElements(doc){const pipeline=getPipelineItems(doc);pipeline.forEach(function(element){if(element.id==="evainput"||element.className==="xdsoft_autocomplete_hint"){return}if(element.tagName.toLowerCase()==="iframe"){setupIFrame(element)}else if(element.matches(inputSelector)){if(element.id==="evainput"||element.className==="xdsoft_autocomplete_hint"){return}if(element.hasAttribute("idt-check-valid")){return}if(elementIsExcluded(element)){element.classList.add("idt-ignored");return}element.setAttribute("idt-check-valid",1);if(element.hasAttribute("maxlength")){element.setAttribute("idt-maxlength",element.getAttribute("maxlength"));element.removeAttribute("maxlength")}element.boundOnFocusIDT=()=>{const instantdtPopup=document.getElementById("instantdt");if(instantdtPopup==null){focusElement(element)}};element.addEventListener("focus",element.boundOnFocusIDT);element.boundOnBlurIDT=e=>{if(e.idtVisited){return}e.idtVisited=true;const instantdtPopup=document.getElementById("instantdt");if(instantdtPopup==null){if(valueIsInvalid(e,element)){e.preventDefault();e.stopImmediatePropagation();window.idtErrorElement=e.target}else{window.idtErrorElement=undefined}}};element.addEventListener("blur",element.boundOnBlurIDT)}})}function observeMutations(mutations){let timeout=setTimeout(function(mutationItems){if(mutationItems.length>0&&mutationItems[0].target!=null){monitorElements(mutationItems[0].target.ownerDocument)}clearTimeout(timeout)},0,mutations)}function isUserEditing(e){return window.idtErrorElement!=null&&e.target!==window.idtErrorElement}function isUserPressingNavigationKeyOnError(e){if(e.key==="Escape"){const instantdtPopup=document.getElementById("instantdt");if(instantdtPopup==null){return window.idtErrorElement!=null||window.idtFocusElement!=null}else{return true}}else{return false}}function isUserInteractingWithDTPopup(e){const alertIds=["splcharstable","generateDTSPLValidationMsgModal","specialCharRemovedMessage"];let alertId="";let alertPopupElement=null;for(alertId of alertIds){alertPopupElement=e.target.ownerDocument.getElementById(alertId);if(alertPopupElement!=null&&alertPopupElement.contains(e.target)){return true}}const iframeDTDialogue=e.target.ownerDocument.getElementById("DataTruncationAlertDialogue");if(iframeDTDialogue!=null){const modal=iframeDTDialogue.closest(".DTAlertDialog");if(modal!=null&&modal.contains(e.target)){return true}}const modalClasses=["dataTruncationMsgTbl","RxEditHelperValidation"];let className="";for(className of modalClasses){if(isElementInModal(e,className)){return true}}let idtAlertPopups;if(e.target.ownerDocument.body!=null){idtAlertPopups=e.target.ownerDocument.body.getElementsByClassName("idt-alert")}else{idtAlertPopups=e.target.ownerDocument.getElementsByClassName("idt-alert")}if(idtAlertPopups!=null&&idtAlertPopups.length>0){for(let i=0;i<idtAlertPopups.length;i++){const modal=idtAlertPopups[i].closest(".modal.in");if(modal!=null&&modal.contains(e.target)){return true}}}return false}function isElementInModal(e,className){let idtAlertPopups;if(e.target.ownerDocument.body!=null){idtAlertPopups=e.target.ownerDocument.body.getElementsByClassName(className)}else{idtAlertPopups=e.target.ownerDocument.getElementsByClassName(className)}if(idtAlertPopups!=null&&idtAlertPopups.length>0){for(let i=0;i<idtAlertPopups.length;i++){const modal=idtAlertPopups[i].closest(".modal.in");if(modal!=null&&modal.contains(e.target)){return true}}}return false}function getUpdatedListener(ctx,e,handler){const eventName=e.type;if(eventName==="mousedown"&&e.idtVisited==null&&window.idtFocusElement!=null&&e.target.matches("div[ng-click]")){e.idtVisited=true;handler.call(ctx,e);window.idtFocusElement.blur()}else if(eventName==="blur"&&e.target.matches&&e.target.matches(inputSelector)&&e.idtVisited==null){e.idtVisited=true;const instantdtPopup=document.getElementById("instantdt");if(instantdtPopup==null){if(valueIsInvalid(e,e.target)){e.preventDefault();e.stopImmediatePropagation();window.idtErrorElement=e.target}else{window.idtErrorElement=undefined;handler.call(ctx,e)}}else{handler.call(ctx,e)}}else if(e.idtVisited==null&&(eventName==="click"&&isUserEditing(e)&&!isUserInteractingWithDTPopup(e)||(eventName==="keydown"||eventName==="keyup")&&isUserPressingNavigationKeyOnError(e))){e.idtVisited=true;e.preventDefault();e.stopImmediatePropagation()}else{handler.call(ctx,e)}}function setupListeners(windowContext){const idtHandlers=["click","blur","keydown","keyup","mousedown"];const monitoredHandler=function(handler){if(!handler.listener){handler.listener=function(e){getUpdatedListener(this,e,handler)}}return handler.listener};const addListener=windowContext.EventTarget.prototype.addEventListener;windowContext.EventTarget.prototype.addEventListener=function(eventName,eventHandler,opts){let handler=eventHandler;if(idtHandlers.includes(eventName)){handler=monitoredHandler(eventHandler)}addListener.call(this,eventName,handler,opts)};const removeListener=windowContext.EventTarget.prototype.removeEventListener;windowContext.EventTarget.prototype.removeEventListener=function(eventName,eventHandler,opts){if(eventHandler==null){return}let handler=eventHandler.listener;if(handler==null){handler=eventHandler}removeListener.call(this,eventName,handler,opts)}}function removeListeners(screen){screen.querySelectorAll("[idt-check-valid]").forEach(el=>{el.removeEventListener("focus",el.boundOnFocusIDT);delete el.boundOnFocusIDT;el.removeEventListener("blur",el.boundOnBlurIDT);delete el.boundOnBlurIDT})}function monitorDocumentClick(e){if(isUserEditing(e)&&!isUserInteractingWithDTPopup(e)){e.preventDefault();e.stopImmediatePropagation()}}function setupIDT(){Promise.all([getViewMappings(),getConfig()]).then(responses=>{let idt_sources="";for(let item of responses[0].data){const identifier=item.viewIdentifier;if(!selectorIsValid(playgroundDoc,identifier)){continue}relevantFieldItems[identifier]=undefined;idt_sources+=identifier+","}if(idt_sources.length>0){idt_sources=idt_sources.substring(0,idt_sources.length-1)}config=responses[1].data;config.idtSources=idt_sources;window.idtConfig={autoReplace:config.substitutions.some(item=>item.autoReplace===1),substitutions:config.substitutions};new MutationObserver(observeMutations).observe(document,mutationConfig)})}document.addEventListener("click",monitorDocumentClick,true);setupListeners(window);document.addEventListener("DOMContentLoaded",setupIDT);document.addEventListener("screenClose",e=>{removeListeners(e.detail.screen)})})();
var highlightedElementId=undefined;var elementBackgroundColor=undefined;(function(){let head=document.head||document.getElementsByTagName("head")[0];let htmlElement=document.createElement('link');htmlElement.rel="stylesheet";htmlElement.href="/mobiledoc/jsp/webemr/help/itemkeySupport/css/search-setting.component.css";head.appendChild(htmlElement);angular.module('ecw.component.searchSetting',['ecw.dir.ai-generate-btn','ecw.datatruncUtilityModule']).constant('SEARCH_SETTING_STATUS_CODE',{"FOUND_SETTINGS":1,"SCREEN_NOT_MATCHED":2,"NOT_FOUND_IN_AI":3,"SECURITY_SETTING_DISABLED":4,"AI_HUB_UNAVAILABLE":5}).directive('searchSettings',function($http,$ocLazyLoad,$modal,SEARCH_SETTING_STATUS_CODE,dataTruncUtilityService){return{restrict:'E',replace:'true',templateUrl:'/mobiledoc/jsp/webemr/help/itemkeySupport/search-setting.component.html',scope:{placeHolder:'@?',onCustomKeyDown:'&?',screenName:'@?',buttonLabel:'@?'},link:function(scope){scope.settingDetails={};scope.settingPrompt={text:''};scope.isInterpretationInProgress=false;scope.isAISearchSettingEnabled=true;scope.isAiTriggered=false;scope.isWarningPopup=false;scope.isSpeechEnabled=!isSpeechEnabled?false:true;scope.aiCommandList=[{"id":1,"category":"Menu Search – How to Queries","commands":["How to create a template","How to configure vitals","How to configure lab attributes"],"showCommands":true},{"id":2,"category":"Security Settings – Permission Queries","commands":["Permission to delete rx","Permission to create templates","Permission to...."],"showCommands":true},{"id":3,"category":"Practice Default – Search Queries","commands":["Attach Medical Summary by Default in Outgoing Referral","Setting for Concurrency on Appointment Screen and Progress Note Lock","Carry forward Current Medications"],"showCommands":true}];let observer;let observerRemoveHighlight;var isTargetScreenOpen=false;var isWarningPopupVisible=false;var highlightTimeout;if(!scope.placeHolder){scope.placeHolder='For example, "Attach Medical Summary to Outgoing Referral"'}if(!scope.screenName){scope.screenName='Main Menu'}let screen=scope.screenName.replaceAll(' ','_');scope.screenId='searchSetting_'+screen;scope.inputId='ai_search_input_'+screen;scope.init=function(){if(scope.screenName!=='Main Menu'){setTimeout(function(){$("#"+scope.inputId).focus()},200)}};scope.getSettings=function(){isTargetScreenOpen=false;if(!dataTruncUtilityService.getTextFieldWidthsFromTable("web_searchsetting",scope.screenId,"bluetheme")||scope.settingPrompt.text===''){scope.isAiTriggered=false;return false}if(!getPermission("AllowSettingsAssistant",global.TrUserId)){scope.isAiTriggered=false;displayWarningPopup('Settings Assistant','Please contact your administrator to get access to this security setting: <b>"Settings Assistant."</b>',openMenuScreen,'Security Setting');return}scope.isInterpretationInProgress=true;try{if(observer){observer?.disconnect();observer=undefined}}catch(e){}$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},url:makeURL("/mobiledoc/emr/settings/get?settingPrompt="+scope.settingPrompt.text+"&screenName="+scope.screenName),method:'GET'}).then(function(response){scope.isInterpretationInProgress=false;scope.isAiTriggered=false;isWarningPopupVisible=false;try{let settingDetailsData=angular.fromJson(response.data);if(scope.screenName==='Main Menu'&&settingDetailsData.length>1){scope.openMultipleOptionPrompt(settingDetailsData)}else{scope.settingDetails=settingDetailsData[0];scope.openSingleOptionPrompt()}}catch(err){displayWarningPopup('Unable to process Input','The system is not able to process your input.',openMenuScreen)}},function(error){scope.isInterpretationInProgress=false})};scope.openSingleOptionPrompt=function(){if(scope.settingDetails.statusCode===SEARCH_SETTING_STATUS_CODE.FOUND_SETTINGS){var highlightedElement=$(highlightedElementId);if(highlightedElement.length>0){highlightedElement.css('background-color',elementBackgroundColor);highlightedElement.removeAttr('highlighted');clearTimeout(highlightTimeout)}if(scope.screenName!=='Main Menu'){moveToFieldLocation()}else{if(scope.settingDetails.screenName!=='Main Menu'){observer=new MutationObserver(mutations=>monitorScreenChange(mutations));observer.observe(document.getElementById("webemrApp"),{childList:true,subtree:true,attributes:true})}if(scope.isElementExist(scope.settingDetails.screenSelector)){isTargetScreenOpen=true;document.querySelector(scope.settingDetails.screenSelector).click()}}}else if(scope.settingDetails.statusCode===SEARCH_SETTING_STATUS_CODE.SCREEN_NOT_MATCHED){displayWarningPopup('Input not valid for selected feature','The system matched your input to data associated with '+scope.settingDetails.screenName+'. Please search on '+scope.settingDetails.screenName+' or use a different word or phrase and try again.')}else if(scope.settingDetails.statusCode===SEARCH_SETTING_STATUS_CODE.NOT_FOUND_IN_AI){scope.isWarningPopup=true;scope.toggleAiCommandPopup()}else if(scope.settingDetails.statusCode===SEARCH_SETTING_STATUS_CODE.SECURITY_SETTING_DISABLED){displayWarningPopup('Settings Assistant','Please contact your administrator to get access to this security setting: <b>"Settings Assistant."</b>',undefined,'Security Setting')}else if(scope.settingDetails.statusCode===SEARCH_SETTING_STATUS_CODE.AI_HUB_UNAVAILABLE){ecwAlert('An error occurred on AI hub while processing the request.','eClinicalWorks',openMenuScreen)}};scope.openMultipleOptionPrompt=function(settingDetailsData){let dataOptions=[];settingDetailsData.forEach(setting=>{dataOptions.push({columns:[{name:setting.screenName,"class":'w20p'},{name:setting.settingDescription,"class":'w80p'}],data:setting})});let strUrl="/mobiledoc/jsp/webemr/help/itemkeySupport/aiMultiOptionListPrompt.html";$ocLazyLoad.load({name:"aiMultiOptionListModule",files:["/mobiledoc/jsp/webemr/help/itemkeySupport/js/aiMultiOptionListPromptCtrl.js"],cache:true}).then(function(){let modalInstance=$modal.open({templateUrl:makeURL(strUrl),controller:'aiMultiOptionListCtrl',windowClass:'app-modal-window searchSettingModal bluetheme  medium-width',backdrop:"static",keyboard:false,resolve:{resolveData:function(){return{listData:dataOptions,listHeaders:[{name:'Area',"class":'w20p'},{name:'Description',"class":'w80p'}],title:'Select Screen/Setting',subTitle:'Setting Finder Assistant',headerMsg:'The system has identified multiple settings/screens, please select the screen/setting name you would like to continue with'}}}});modalInstance.result.then(function(responseObj){if(responseObj==='cancel'){isTargetScreenOpen=false;openMenuScreen()}else{scope.settingDetails=responseObj;isTargetScreenOpen=false;scope.openSingleOptionPrompt()}},function(){})})};scope.hideCommandsPopup=function(){if($(".aiCommandsPopupSettingSearch").is(':visible')){scope.aiCommandList.forEach(category=>{category.showCommands=false});$(".aiCommandsPopupSettingSearch").hide();scope.isWarningPopup=false}};scope.resetSettingInput=function(){if($(".aiCommandsPopupSettingSearch").is(':visible')){scope.hideCommandsPopup()}jQuery(function($){function tog(v){return v?'addClass':'removeClass'}$('#'+scope.screenId).on('input','.clearable',function(){$(this)[tog(this.value)]('x')}).on('mousemove','.x',function(e){$(this)[tog(this.offsetWidth-18<e.clientX-this.getBoundingClientRect().left)]('onX')}).on('click','.onX',function(){$(this).removeClass('x onX').val('').change();if(scope.screenName==='Main Menu'){scope.onCustomKeyDown({searchval:''})}})})};scope.resetSettingInput();scope.menuKeyUpEvent=function(){if($(".aiCommandsPopupSettingSearch").is(':visible')){scope.hideCommandsPopup()}if(event.keyCode!==13){if(scope.screenName==='Main Menu'){scope.onCustomKeyDown({searchval:scope.settingPrompt.text})}}else{if(!scope.isAiTriggered){scope.isAiTriggered=true;scope.getSettings()}}};scope.isElementExist=function(elementId,isCheckVisibility){if($(elementId).length>0){if(isCheckVisibility&&!$(elementId).is(":visible")){if(!isWarningPopupVisible){isWarningPopupVisible=true;displayWarningPopup('No Setting Found','Search resulted in a setting for a feature that is not activated. Please contact your Administrator')}return false}return true}else{if(!isWarningPopupVisible){isWarningPopupVisible=true;displayWarningPopup('No Setting Found','Search resulted in a setting for a feature that is not activated. Please contact your Administrator',openMenuScreen)}return false}};scope.addClearIcon=function(){if(scope.settingPrompt.text.length!==0&&!$('#'+scope.inputId).hasClass("x")){$('#'+scope.inputId).addClass('x')}};var displayWarningPopup=function(screenTitle,message,callback,titleHeader){if(!titleHeader){titleHeader='Find Setting'}commonWarningPopup({screenName:'',screenTitle:'<div class="warningAiScreen"><i class="icon-ai-primary icon-ai-warning"></i><span>'+titleHeader+'</span></div>'+' - '+screenTitle,buttons:[{label:"OK",cssClass:'btn-blue',callbackEvent:function(){if($.isFunction(callback)){callback()}}}],message:message,isErrorPopup:true,screenSpecificClass:'doNotCloseModalIfAlertOpen',isKeyboardClose:false},$ocLazyLoad,$modal)};var moveToFieldLocation=function(){if(scope.settingDetails.fieldSelector){let elements=document.querySelectorAll(scope.settingDetails.fieldSelector[0]);if(elements.length>0){var clickableElement=$(elements[0]);clickableElement.click();scope.settingDetails.fieldSelector.shift()}}setTimeout(function(){highlightField(scope.settingDetails.elementSelectorForHighlighting)},500)};var highlightField=function(elementSelectorForHighlighting){let highlightElement=$(elementSelectorForHighlighting);if(!scope.isElementExist(elementSelectorForHighlighting,true)){if(observer){observer?.disconnect();observer=undefined}return false}scope.$apply(function(){scope.settingPrompt.text="";$("#"+scope.inputId).removeClass('x onX').val('').change()});var attr=highlightElement.attr('highlighted');if(highlightElement&&(typeof attr==='undefined'||attr===false)&&$(highlightElement).is(":visible")===true){var element=$(".fixed-table-container:has( "+elementSelectorForHighlighting+")");var jScrollPaneInstance=$(element).data('jsp');if(element&&jScrollPaneInstance){let pos=highlightElement.position();jScrollPaneInstance.scrollTo(parseInt(0,10),parseInt(pos.top,10));highlightElement.focus();highlightElement.css('background-color','#FFFF00');highlightElement.attr('highlighted','true');removeHighlightOnChange(elementSelectorForHighlighting,'transparent');highlightTimeout=setTimeout(function(){highlightElement.css('background-color','transparent');highlightElement.removeAttr('highlighted')},2e4)}else{if(scope.settingDetails.screenName==='Security Settings'&&$(".scheduleCustomScroll").length>0){$(".scheduleCustomScroll").mCustomScrollbar("scrollTo",$(elementSelectorForHighlighting)[0])}else{highlightElement.get(0).scrollIntoView({behavior:'smooth'})}var defaultColor=highlightElement.css('background-color');highlightElement.css('background-color','#FFFF00');highlightElement.attr('highlighted','true');removeHighlightOnChange(elementSelectorForHighlighting,defaultColor);highlightTimeout=setTimeout(function(){highlightElement.css('background-color',defaultColor?defaultColor:'transparent');highlightElement.removeAttr('highlighted')},2e4)}}if(observer){observer?.disconnect();observer=undefined}};var monitorScreenChange=function(records){setTimeout(mutatedItems=>{if(mutatedItems.length>0&&mutatedItems[0].target!=null){const bodyRecords=records.filter(d=>d.target.ownerDocument!=null&&d.target.ownerDocument.body.childNodes.length>0);if(bodyRecords.length>0){let doc=bodyRecords[0].target.ownerDocument;if(scope.settingDetails.fieldSelector&&scope.settingDetails.fieldSelector.length>0){let elements=doc.querySelectorAll(scope.settingDetails.fieldSelector[0]);if(elements.length>0){var clickableElement=$(elements[0]);var clickedTabAttr=clickableElement.attr('clicked');if(typeof clickedTabAttr==='undefined'||clickedTabAttr===false){clickableElement.attr('clicked','true');clickableElement.click();scope.settingDetails.fieldSelector.shift()}}}else{setTimeout(function(){try{highlightField(scope.settingDetails.elementSelectorForHighlighting)}catch(e){if(observer){observer?.disconnect();observer=undefined}}},500)}}}},0,records)};var removeHighlightOnChange=function(element,backgroundColor){if(observerRemoveHighlight){observerRemoveHighlight?.disconnect()}highlightedElementId=element;elementBackgroundColor=backgroundColor;observerRemoveHighlight=new MutationObserver(mutations=>monitorHighlightedElement(mutations));observerRemoveHighlight.observe(document.getElementById("webemrApp"),{childList:true,subtree:true,attributes:true})};var monitorHighlightedElement=function(records){setTimeout(mutatedItems=>{if(mutatedItems.length>0&&mutatedItems[0].target!=null){const bodyRecords=records.filter(d=>d.target.ownerDocument!=null&&d.target.ownerDocument.body.childNodes.length>0);if(bodyRecords.length>0){removeHighlight()}}},0,records)};var removeHighlight=function(){var highlightedElement=$(highlightedElementId);if(highlightedElement.length>0&&!highlightedElement.is(":visible")){highlightedElement.css('background-color',elementBackgroundColor);highlightedElement.removeAttr('highlighted');clearTimeout(highlightTimeout);if(observerRemoveHighlight){observerRemoveHighlight?.disconnect();observerRemoveHighlight=undefined}}};var openMenuScreen=function(){if(scope.screenName==='Main Menu'&&!isTargetScreenOpen){setTimeout(function(){$("#leftnavApp .icon-label-menu").click();$("#"+scope.inputId).focus()},500)}};scope.$on('clear-search-setting-input',function(){scope.settingPrompt.text='';$("#"+scope.inputId).removeClass('x onX').val('').change()});function msieversion(){jQuery(function($){function tog(v){return v?'addClass':'removeClass'}$(document).on('input','.aisearchSettingScreen .clearable',function(){$(this)[tog(this.value)]('x')}).on('mousemove','.x',function(e){$(this)[tog(this.offsetWidth-50<e.clientX-this.getBoundingClientRect().left)]('onX')}).on('click','.onX',function(){$(this).removeClass('x onX').val('').change()})});return false}msieversion();scope.toggleAiCommandPopup=function(){if($(".aiCommandsPopupSettingSearch").is(':visible')){scope.hideCommandsPopup()}else{$(".aiCommandsPopupSettingSearch").show();$(".aicommandlistDiv").scrollTop(0);scope.aiCommandList.forEach(category=>{category.showCommands=true});$("#"+scope.inputId).on("focus",function(){if($(".aiCommandsPopupSettingSearch").is(':visible')){scope.hideCommandsPopup()}})}};$(".aiCommandsPopupSettingSearch").hide();scope.toggleCommands=function(category){category.showCommands=!category.showCommands};scope.$on('$destroy',function(){if(observer){observer?.disconnect()}if(observerRemoveHighlight){observerRemoveHighlight?.disconnect()}})}}})})();
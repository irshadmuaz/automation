angular.module('ihubRefreshIconModule',[]).directive('ihubRefreshIconDir',function(){return{restrict:'EA',scope:{patientId:'=',userId:'=',showTooltipIcon:'=?',successCallback:'&?'},templateUrl:'/mobiledoc/jsp/interop/template/refresh-icon/refresh-icon-tpl.html',controllerAs:'ihubRefIconCtrl',controller:function($scope,$http,$timeout){var ihubRefIconCtrl=this;ihubRefIconCtrl.patientId=$scope.patientId;ihubRefIconCtrl.userId=$scope.userId;ihubRefIconCtrl.showTooltipIcon=$scope.showTooltipIcon;ihubRefIconCtrl.successCallback=$scope.successCallback;ihubRefIconCtrl.disabledRefreshBtnFlag=false;ihubRefIconCtrl.triggerMonthsDiff="36";ihubRefIconCtrl.showErrMsg=false;var timer;ihubRefIconCtrl.init=function(){ihubRefIconCtrl.ehx_rcp_containerid=Math.floor(Math.random()*1e3*Math.floor(3));ihubRefIconCtrl.showErrMsg=false;timer=$timeout(function(){ihubRefIconCtrl.initDocQueryData();ihubRefIconCtrl.initDataAfterView();ihubRefIconCtrl.hideDatePicker()},1e3)};ihubRefIconCtrl.initDocQueryData=function(){$.ajax({type:"GET",url:"/mobiledoc/jsp/interop/trigger/triggerService.jsp",data:{action:'initDocQueryData',patientId:ihubRefIconCtrl.patientId},"async":false,success:function(response){response=$.trim(response);if(response){var jsonObj=JSON.parse(response);ihubRefIconCtrl.disabledRefreshBtnFlag=jsonObj.isIhubDataRequested;ihubRefIconCtrl.triggerMonthsDiff=jsonObj.ptDataRange}},error:function(xhr,ajaxOptions,thrownError){}})};ihubRefIconCtrl.ajaxCount=0;ihubRefIconCtrl.lastQueryInitiatedMsg=function(){$.ajax({type:"GET",url:"/mobiledoc/jsp/interop/trigger/triggerService.jsp?c="+ihubRefIconCtrl.ajaxCount,data:{action:'lastTriggerTime',patientId:ihubRefIconCtrl.patientId},"async":true,success:function(response){ihubRefIconCtrl.setLastFetchTime(response)},error:function(xhr,ajaxOptions,thrownError){ihubRefIconCtrl.setLastFetchTime()}});$("#ehx-rcp-doc-query-tolltipinfo"+ihubRefIconCtrl.ehx_rcp_containerid).removeClass('hidden')};ihubRefIconCtrl.lastQueryInitiatedMsgHide=function(){$("#ehx-rcp-doc-query-tolltipinfo"+ihubRefIconCtrl.ehx_rcp_containerid).addClass('hidden');ihubRefIconCtrl.ajaxCount++};ihubRefIconCtrl.initDataAfterView=function(){$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker({showButtonPanel:true,dateFormat:'mm/dd/yy',changeMonth:true,changeYear:true,maxDate:new Date,defaultDate:"-"+ihubRefIconCtrl.triggerMonthsDiff+"m",onSelect:function(selectedDate,instance){ihubRefIconCtrl.setTriggerToDate(selectedDate,instance)}});$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker('setDate',ihubRefIconCtrl.getTriggerDefaultFromDt());$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker({showButtonPanel:true,dateFormat:'mm/dd/yy',changeMonth:true,changeYear:true,maxDate:new Date,onSelect:function(selectedDate,instance){ihubRefIconCtrl.setTriggerFromDate(selectedDate,instance)}});$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker('setDate',new Date);$("#cuton-date-picker"+ihubRefIconCtrl.ehx_rcp_containerid+" .icon-inputcalender").on('click',ihubRefIconCtrl.calendarIconClickHandler)};ihubRefIconCtrl.calendarIconClickHandler=function(){$(this).parent().parent().find('input[type="text"]').datepicker("show")};ihubRefIconCtrl.setLastFetchTime=function(respMessage){$("#lastQueryInitiatedSpan"+ihubRefIconCtrl.ehx_rcp_containerid).html($.trim(respMessage))};ihubRefIconCtrl.setTriggerToDate=function(selectedDate,instance){var monthDiff=parseInt(ihubRefIconCtrl.triggerMonthsDiff);var fromDate=$.datepicker.parseDate(instance.settings.dateFormat,selectedDate,instance.settings);var fromDateAfterMonthDiff=$.datepicker.parseDate(instance.settings.dateFormat,selectedDate,instance.settings);fromDateAfterMonthDiff.setMonth(fromDateAfterMonthDiff.getMonth()+monthDiff);fromDateAfterMonthDiff.setDate(fromDateAfterMonthDiff.getDate()-1);var todayDate=new Date;var toDate=$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).val();if(toDate!==undefined&&toDate!==""){var toDateBeforeMonthDiff=$.datepicker.parseDate(instance.settings.dateFormat,toDate,instance.settings);toDate=$.datepicker.parseDate(instance.settings.dateFormat,toDate,instance.settings);toDateBeforeMonthDiff.setMonth(toDateBeforeMonthDiff.getMonth()-monthDiff);if(selectedDate>todayDate){$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker("option","maxDate",new Date);$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).val("")}else if(fromDate<=toDateBeforeMonthDiff||fromDate>toDate&&fromDate>=toDateBeforeMonthDiff){if(fromDateAfterMonthDiff>todayDate){$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker("option","maxDate",new Date)}else{$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker("option","maxDate",fromDateAfterMonthDiff)}$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).val("")}}else{if(fromDate===undefined){$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker('setDate',fromDateAfterMonthDiff)}else{$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker("option","maxDate",new Date)}}};ihubRefIconCtrl.setTriggerFromDate=function(selectedDate,instance){var monthDiff=parseInt(ihubRefIconCtrl.triggerMonthsDiff);var toDate=$.datepicker.parseDate(instance.settings.dateFormat,selectedDate,instance.settings);var toDateBeforeMonthDiff=$.datepicker.parseDate(instance.settings.dateFormat,selectedDate,instance.settings);toDateBeforeMonthDiff.setMonth(toDateBeforeMonthDiff.getMonth()-monthDiff);var fromDate=$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).val();if(fromDate!==undefined&&fromDate!==""){var fromDateAfterMonthDiff=$.datepicker.parseDate(instance.settings.dateFormat,fromDate,instance.settings);fromDate=$.datepicker.parseDate(instance.settings.dateFormat,fromDate,instance.settings);fromDateAfterMonthDiff.setMonth(fromDateAfterMonthDiff.getMonth()+monthDiff);if(toDateBeforeMonthDiff>fromDate||fromDate>toDate&&fromDate>toDateBeforeMonthDiff){$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).val("")}}else{if(fromDate===undefined){$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker('setDate',toDateBeforeMonthDiff)}}};ihubRefIconCtrl.getTriggerDefaultFromDt=function(){var monthDiff=parseInt(ihubRefIconCtrl.triggerMonthsDiff);var fromDate=new Date;fromDate.setMonth(fromDate.getMonth()-monthDiff);fromDate.setDate(fromDate.getDate()+1);return fromDate};ihubRefIconCtrl.createQueryInitiate=function(){ihubRefIconCtrl.showErrMsg=false;var startDate=$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).val();var endDate=$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).val();ihubRefIconCtrl.createQueryInitiateWithDate(endDate,startDate)};ihubRefIconCtrl.createQueryInitiateWithDate=function(endDate,startDate){ihubRefIconCtrl.showErrMsg=false;if(!ihubRefIconCtrl.validateToDateAndFromDate(startDate,endDate)){ihubRefIconCtrl.showErrMsg=true;return}$("#trigger-date-dropdown"+ihubRefIconCtrl.ehx_rcp_containerid).hide();$("#queryInitiateBtn"+ihubRefIconCtrl.ehx_rcp_containerid).attr("disabled","disabled");$("#queryInitiateDropDown"+ihubRefIconCtrl.ehx_rcp_containerid).attr("disabled","disabled");$.ajax({type:"POST",url:"/mobiledoc/jsp/interop/trigger/triggerService.jsp",data:{patientId:ihubRefIconCtrl.patientId,TrUserId:ihubRefIconCtrl.userId,startDate:startDate,endDate:endDate},"async":true,cache:false,success:function(response){if(ihubRefIconCtrl.successCallback){ihubRefIconCtrl.successCallback()}return},error:function(xhr,ajaxOptions,thrownError){return}})};ihubRefIconCtrl.validateToDateAndFromDate=function(startDate,endDate){if(!endDate){$("#errorMsg"+ihubRefIconCtrl.ehx_rcp_containerid).html("From Date can not be empty.");return false}else if(!startDate){$("#errorMsg"+ihubRefIconCtrl.ehx_rcp_containerid).html("To Date can not be empty.");return false}else if(!ihubRefIconCtrl.isValidDateMMDDYYYY(endDate)){$("#errorMsg"+ihubRefIconCtrl.ehx_rcp_containerid).html("Please enter valid From Date.");return false}else if(!ihubRefIconCtrl.isValidDateMMDDYYYY(startDate)){$("#errorMsg"+ihubRefIconCtrl.ehx_rcp_containerid).html("Please enter valid To Date.");return false}else if(!ihubRefIconCtrl.isValidDiffBetweenTwoDates(startDate,endDate)){$("#errorMsg"+ihubRefIconCtrl.ehx_rcp_containerid).html("Difference between From Date and To date should be within "+ihubRefIconCtrl.triggerMonthsDiff+" month(s)");return false}return true};ihubRefIconCtrl.isValidDiffBetweenTwoDates=function(startDate,endDate){var date1=new Date(endDate);var date2=new Date(startDate);var months;months=(date2.getFullYear()-date1.getFullYear())*12;months-=date1.getMonth();months+=date2.getMonth();if(months<0||months>parseInt(ihubRefIconCtrl.triggerMonthsDiff)){return false}return true};ihubRefIconCtrl.isValidDateMMDDYYYY=function(dateString){if(!/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString))return false;var parts=dateString.split("/");var day=parseInt(parts[1],10);var month=parseInt(parts[0],10);var year=parseInt(parts[2],10);if(year<1e3||year>3e3||month===0||month>12)return false;var monthLength=[31,28,31,30,31,30,31,31,30,31,30,31];if(year%400===0||year%100!==0&&year%4===0)monthLength[1]=29;return day>0&&day<=monthLength[month-1]};ihubRefIconCtrl.closeGearDatePicker=function(){ihubRefIconCtrl.showErrMsg=false;$("#trigger-date-dropdown"+ihubRefIconCtrl.ehx_rcp_containerid).removeClass("show");$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker('setDate',ihubRefIconCtrl.getTriggerDefaultFromDt());$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker("option","maxDate",new Date);$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker('setDate',new Date);ihubRefIconCtrl.hideDatePicker()};ihubRefIconCtrl.setToAndFromDate=function(weekOrMonth,count){var todayDate=new Date;var fromDate=new Date;if(weekOrMonth==='W'){fromDate.setDate(fromDate.getDate()-count*7)}else if(weekOrMonth==='M'){fromDate.setMonth(fromDate.getMonth()-count)}ihubRefIconCtrl.createQueryInitiateWithDate(ihubRefIconCtrl.getFormattedDate(fromDate),ihubRefIconCtrl.getFormattedDate(todayDate))};ihubRefIconCtrl.getFormattedDate=function(date){let year=date.getFullYear();let month=(1+date.getMonth()).toString().padStart(2,'0');let day=date.getDate().toString().padStart(2,'0');return month+'/'+day+'/'+year};$scope.$on('$destroy',function(){if(timer){$timeout.cancel(timer)}$("#ehx-rcp-doc-query-info-blankicon"+ihubRefIconCtrl.ehx_rcp_containerid).off('mouseover');$("#ehx-rcp-doc-query-dateFrom"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker('destroy');$("#ehx-rcp-doc-query-dateTo"+ihubRefIconCtrl.ehx_rcp_containerid).datepicker('destroy');$("#cuton-date-picker"+ihubRefIconCtrl.ehx_rcp_containerid+" .icon-inputcalender").off('click',ihubRefIconCtrl.calendarIconClickHandler)});ihubRefIconCtrl.hideDatePicker=function(){$('#cuton-date-picker'+ihubRefIconCtrl.ehx_rcp_containerid).css("display","none");$('#fix-date-range'+ihubRefIconCtrl.ehx_rcp_containerid).removeClass("col-sm-5");$('#fix-date-range'+ihubRefIconCtrl.ehx_rcp_containerid).addClass("col-sm-12");$('#trigger-date-dropdown'+ihubRefIconCtrl.ehx_rcp_containerid).css("min-width","100px")};ihubRefIconCtrl.showCustomDateRange=function(){$('#cuton-date-picker'+ihubRefIconCtrl.ehx_rcp_containerid).css("display","block");$('#fix-date-range'+ihubRefIconCtrl.ehx_rcp_containerid).removeClass("col-sm-12");$('#fix-date-range'+ihubRefIconCtrl.ehx_rcp_containerid).addClass("col-sm-5");$('#trigger-date-dropdown'+ihubRefIconCtrl.ehx_rcp_containerid).css("min-width","")}}}});
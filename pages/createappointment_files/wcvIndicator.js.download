angular.module('wCVIndicatorDirective',[]).directive('wcvIndicator',function($http,$ocLazyLoad,$templateCache){return{restrict:"E",scope:{topClass:"@",callingFrom:"@",patientId:"=patientId",wcvStatus:"=wcvStatus"},templateUrl:'/mobiledoc/jsp/webemr/wellchildvisit/wcvIndicator.jsp',link:function(scope){try{scope.isWEB=true;if(isVb()){scope.isWEB=false}scope.showAppointment=false;let wcvControllerScope={};scope.isAccessForAppointment=typeof getPermission==='function'?getPermission('Appointments',global.TrUserId):false;scope.openAppointment=function(status,callingFrom){if(scope.patientId&&parseInt(scope.patientId)>0){scope.showAppointment=true;scope.ptIdentifier=scope.$parent.patientIdentifiers&&typeof scope.$parent.patientIdentifiers==='object'?scope.$parent.patientIdentifiers:scope.patientId;scope.prepareWCVMessage(status);let responsePromise=$http.get(makeURL("/mobiledoc/emr/appointmentwcv/getUpcomingAppointmentList?patientId="+scope.patientId));responsePromise.success(function(resp){if(resp.status&&resp.status.toUpperCase()==="SUCCESS"){scope.upComingAppList=resp.result;$('#wcv-appointment-'+callingFrom).modal();$('#wcvmodal').addClass('wcv-modal-width')}else{ecwAlert('An error occurred while getting patient upcoming appointment list','','bluetheme')}})}};scope.prepareWCVMessage=function(wcvStatus){scope.popupMessage="Patient is "+wcvStatus.toLowerCase()+" for their Well-Child visit. Carefully review their upcoming appointments and schedule a Well-Child visit.";if('Current'===wcvStatus){scope.popupMessage="Patient is up to date with their Well-Child visit. Carefully review their upcoming appointments and schedule a Well-Child visit if necessary."}};scope.closeWCV=function(callingFrom){scope.closeApptOrActionInParent();$('#wcv-appointment-'+callingFrom).modal('hide')};scope.createAppointmentOrActionFromWCV=function(screen){wcvControllerScope=angular.element(document.getElementById('wcv-controller')).scope();if(wcvControllerScope&&!angular.equals({},wcvControllerScope)){if('appointment'===screen){let patientName='';patientName=scope.ptIdentifier.lastName&&scope.ptIdentifier.firstName?scope.ptIdentifier.lastName+", "+scope.ptIdentifier.firstName:'';$ocLazyLoad.load({name:'Appointment',files:["/mobiledoc/jsp/webemr/scheduling/js/newAppointment.js","/mobiledoc/jsp/webemr/scheduling/css/appointment.css"],cache:false}).then(function(){let urlAppointment=makeURL('/mobiledoc/jsp/webemr/scheduling/newAppointment.jsp?encounterId=&start=&end=&id='+global.TrUserId+'&name=&date='+moment().format("MM/DD/YYYY")+'&pinAppointment=&visitType=&visitTypeDesc=&visitColor=&facilityId=&facilityName=&parentScreen=wellChildVisit&patientId='+scope.patientId+"&patientName="+patientName);wcvControllerScope.linkScreenUrlWCV='';wcvControllerScope.linkScreenUrlWCV=urlAppointment},function(e){ecwAlert("An error occurred while opening create Appointment screen.")})}else if('actions'===screen){let params={ActionId:"0",patientId:scope.patientId,ms:(new Date).getTime()};params.context="WellChildVisit";params=$.param(params);$ocLazyLoad.load({name:'actionsDetailViewApp',cache:false,files:['/mobiledoc/jsp/webemr/lookup/lookup.js','/mobiledoc/jsp/webemr/js/dateformat.js','/mobiledoc/jsp/webemr/templates/keywords-tpl.js','/mobiledoc/jsp/webemr/templates/structuredata-tpl.js','/mobiledoc/jsp/webemr/js/xeditable.min.js','/mobiledoc/jsp/webemr/css/xeditable.css','/mobiledoc/jsp/webemr/jellybean/telephoneencounter/actionsDetailView.js']}).then(function(){let urlAction=makeURL("/mobiledoc/jsp/webemr/jellybean/telephoneencounter/actionsDetailView.jsp?"+params);wcvControllerScope.linkScreenUrlWCV='';wcvControllerScope.linkScreenUrlWCV=urlAction},function(e){ecwAlert("An error occurred while opening create Action screen.")})}}};scope.closeApptOrActionInParent=function(){if(wcvControllerScope&&wcvControllerScope.linkScreenUrlWCV){$templateCache.remove(wcvControllerScope.linkScreenUrlWCV);wcvControllerScope.linkScreenUrlWCV=''}}}catch(e){ecwAlert("An error occurred while loading WCV indicator module. "+e)}}}});
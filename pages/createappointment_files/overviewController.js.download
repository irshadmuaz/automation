let overviewModule=angular.module('overviewModule',['oc.lazyLoad','ngSanitize','ecw.dir.keywords','ecw.spellchecker','ecw.service.PSAC','ecw.dir.alertmessage','ecw.service.EncDetailsService','wCVIndicatorDirective','RxHelper','ecw.rxinfotooltipicon']);overviewModule.controller('overviewController',function rpTabsCtrl($scope,$http,$ocLazyLoad,$sce,$templateCache,$modal,$interval,$rootScope,$timeout,PSACService,EncDetailsService,rxService,$compile){$scope.dbencid="";$scope.encdate="";$scope.context=$scope.$parent.context;$scope.patientid=$scope.$parent.patientid;$scope.encounterid=$scope.$parent.encounterid;$scope.trUserId=global.TrUserId;$scope.ShowMedSummaryinPNRPCurrMed="false";$scope.linkColor="";$scope.cqwframeurl="";$scope.cqwPatientid;$scope.carePlanProblemList=[];$scope.currentPage=1;$scope.noOfPages=0;$scope.totalNoOfRows=0;$scope.pageSize=0;$scope.noOfPages=[];$scope.currentPageEpa=1;$scope.noOfPagesEpa=0;$scope.totalNoOfEpaRows=0;$scope.pageSizeEpa=0;$scope.noOfPagesEpa=[];$scope.selected_sub_id=null;$scope.selected_id={};$scope.previousBtn="Previous";$scope.hasMedicationAlerts=false;$scope.showRxFillStatus=false;$scope.isCorrectionalOn=getItemKeyValue("EnableCorrectionalFeatures").toLowerCase()==="yes";$scope.bImoLexicalDisplay=getItemKeyValue("IMOLexicalDisplay").toUpperCase()==='YES';$scope.potentialDiagnosisCount=0;var isPDXChange=false;$scope.encLockVal_RP=0;$scope.virtualFlagVal=virtualFlagValue;$scope.showHCConPL=getItemKeyValue("showHCConPL").toLowerCase();$scope.enableWVIndicator=getItemKeyValue("EnableWVIndicator").toLowerCase()==="yes";$scope.isEpaServiceEnabled=getItemKeyValue("EnableePAService").toLowerCase()==="yes";$scope.passSynonymId=true;$scope.showLeftarrow=true;$scope.hideSecondaryGaps=false;var sectionOpenedInPN=false;if($("#mainPNContent")&&$("#mainPNContent").length>0)sectionOpenedInPN=true;if(getItemKeyValue("showRxFillStatus").toLowerCase()=='yes'){$scope.showRxFillStatus=true}$scope.callFrom=$scope.$parent.callFrom;$scope.hasHubPLAccessRP=getPermission("HubProblemList",global.TrUserId);if(!$scope.hasHubPLAccessRP){$("#overview_problemlist").attr("title","You do not have access to Problem List in the Hub and ICW.\nPlease contact your administrator.\n\n Please go to Assessments in Progress Notes to edit the Problem List.")}$scope.isEmarFeaturesEnabled=false;if(getItemKeyValue("EnableEmarFeatures").toLowerCase()=='yes'){try{$scope.isEmarFeaturesEnabled=true;$scope.eMARSummary={};$scope.eMARSummaryDefault={id:0,label:"All"};$scope.eMARSummaryJSON="";$scope.eMARSummary.CategoryItems=getCommonCategoryItems("RxItemDrugSource");if($scope.eMARSummary.CategoryItems.length>0){$scope.eMARSummary.CategoryItems.splice(0,0,$scope.eMARSummaryDefault);$scope.drugSource=$scope.eMARSummary.CategoryItems[0].id}}catch(ex){}}var refreshSnomedTimeout;var x2js=new X2JS;var showCQWLink=false;$scope.overviewpopup="";$scope.overviewjson="";$scope.isEnablePotentialDiagnosis=getItemKeyValue("EnablePotentialDiagnosis").toUpperCase()=="YES";$scope.plVerified="";$scope.showCQWLog=false;$scope.setCQWLink=function(){try{$http({url:"/mobiledoc/jsp/webemr/sws/getCQWData.jsp?encounterId="+$scope.encounterid+"&patientId="+$scope.patientid+"&TrUserId="+$scope.trUserId+"&webemr=yes",method:'post'}).success(function(data){if(data.cqwData.isACOWorksheet=="true"&&data.cqwData.isCQWShowLinkInRHP=="true"){$scope.linkColor='green';if(data.cqwData.isShowCQWLog!="true"){if(data.cqwData.isUnAnsweredQuestionsFound=="true"&&data.cqwData.isCheckforBeneficiary=="true"){$scope.linkColor='red'}$scope.showCQWLog=false}else{$scope.showCQWLog=true}}})}catch(e){$scope.showCQWLog=false}};$scope.initializeFilters=function(){$scope.filters=[{name:'All',value:'0'},{name:'Managed by me',value:'1'},{name:'My primary service location',value:'2'}];$scope.filter=$scope.filters[0].value;if(isSupportsLocalStorage()){if(containsKey("rpParams")){var rpParams=JSON.parse(get("rpParams"));if(rpParams.plfilter)$scope.filter=rpParams.plfilter}}};$scope.initializeFilters();$scope.initializeFilters1=function(){$scope.filters1=[{name:'Active HCC Gaps',value:'0'},{name:'Suppressed HCC Gaps',value:'1'}];$scope.hccgap=$scope.filters1[0].value;if(isSupportsLocalStorage()){if(containsKey("rpParams")){var rpParams=JSON.parse(get("rpParams"));if(rpParams.plfilter)$scope.filter=rpParams.plfilter}}};$scope.initializeFilters1();$scope.loadOverviewData=function(){var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&context='+$scope.context+'&encounterId='+$scope.encounterid+'&trigger=overviewjson&strFilter='+$scope.filter;var overviewjson=urlGet(serverUrl);$scope.overviewjson=escapeXml(JSON.parse(overviewjson));if($scope.$parent.isAssignSNOMEDEnabled){refreshSnomedTimeout=$timeout($scope.refreshSnomed)}if(getItemKeyValue("EnableACOWorksheet").toLowerCase()==="yes"&&getItemKeyValue("CQWShowLinkInRHP").toLowerCase()==="yes"){$scope.setCQWLink()}};$scope.refreshSnomed=function(){$scope.checkSnomed(showPLSnomed)};$scope.getEncLockVal_RP=function(){let isEncLock=$scope.$parent.isRCPEncounterLocked();return isEncLock?"1":"0"};$scope.loadOverviewData();if($scope.context==='progressnotes'){$scope.encLockVal_RP=$scope.getEncLockVal_RP()}$scope.showExternalICDCodes=function(){$ocLazyLoad.load({name:'externalICDApp',files:['/mobiledoc/jsp/webemr/rightpanel/js/potentialdiagnosisController.js']}).then(function(){$scope.carePlanHubUrlForOverview=makeURL('/mobiledoc/jsp/webemr/rightpanel/externalICDCodes.jsp?patientId='+$scope.patientid+"&TrUserId="+global.TrUserId+"&pnencId="+$scope.encounterid+"&dbEncId="+$scope.dbencid)},function(e){console.log(e)})};$scope.opencqwmodal=function(){$scope.cqwPatientid=$scope.patientid;var url="/mobiledoc/jsp/sws_ccmr/SWS_SearchWithData.jsp?isccmrcall=false&webemr=yes&pgstatus=load&TrUserId="+global.TrUserId+"&patientid="+$scope.cqwPatientid+"&encid="+$scope.encounterid+"&isccmrcall=true&rnd="+Math.random();$("#cqw").attr("style","color:#fff; font-size:14px; font-weight:600;");$("#cqw").modal({backdrop:"static",keyboard:false});$('#cqw').contents().find('html').html('');$("#SWSDataFrm").attr("esrc",url);$("#btnFrmSave").hide()};$scope.loadSWSLog=function(){var url="/mobiledoc/jsp/sws/SWS_DataLog.jsp?isccmrcall=false&webemr=yes&pgstatus=load&TrUserId="+global.TrUserId+"&pid="+$scope.patientid+"&encid="+$scope.encounterid+"&rand="+Math.random();$("#cqw").attr("style","color:#fff; font-size:14px; font-weight:600;");$("#cqw").modal({backdrop:"static",keyboard:false});$('#cqw').contents().find('html').html('');$("#SWSDataFrm").attr("esrc",url);$("#btnFrmSave").hide()};$scope.closeSWSView=function(){try{$('#cqw').modal('hide');if($scope.context==='progressnotes'){refreshDashboard($scope.encounterid,$scope.patientid)}$scope.setCQWLink()}catch(e){}};$scope.setPagination=function(){$scope.noOfPages=[];var maxpages=5;var parentScr=$scope.context;if(parentScr==="patienthub"||parentScr==="Treatment"||parentScr==="telenc"||parentScr==="epa"){maxpages=3;$scope.previousBtn="Prev"}if($scope.totalNoOfRows>$scope.pageSize){$scope.pages=Math.ceil($scope.totalNoOfRows/$scope.pageSize);var totalPages=$scope.pages;var currPage=$scope.currentPage;var num=1;if(currPage<=3&&totalPages<=maxpages){for(var i=1;i<=totalPages;i++){$scope.noOfPages.push(i)}}else if(currPage<=3&&totalPages>maxpages&&maxpages>currPage){for(var i=1;i<=maxpages;i++){$scope.noOfPages.push(i)}}else if(currPage<totalPages-1){if(maxpages==3){num=currPage-1}else{num=currPage-2}for(var i=1;i<=maxpages;i++){$scope.noOfPages.push(num++)}}else if(currPage==4&&totalPages==4){if(maxpages==3){num=2;for(var i=1;i<=maxpages;i++){$scope.noOfPages.push(num++)}}else{num=1;for(var i=1;i<=totalPages;i++){$scope.noOfPages.push(num++)}}}else{if(maxpages==3){num=totalPages-2}else{num=totalPages-4}for(var i=1;i<=maxpages;i++){$scope.noOfPages.push(num++)}}}};$scope.setEpaPagination=function(){$scope.noOfPagesEpa=[];var maxpages=5;var parentScr=$scope.context;if(parentScr==="patienthub"||parentScr==="Treatment"||parentScr==="telenc"||parentScr==="epa"){maxpages=3;$scope.previousBtn="Prev"}if($scope.totalRowsEpa>$scope.pageSizeEpa){$scope.pagesEpa=Math.ceil($scope.totalRowsEpa/$scope.pageSizeEpa);var totalPages=$scope.pagesEpa;var currPage=$scope.currentPageEpa;var num=1;if(currPage<=3&&totalPages<=maxpages){for(var i=1;i<=totalPages;i++){$scope.noOfPagesEpa.push(i)}}else if(currPage<=3&&totalPages>maxpages&&maxpages>currPage){for(var i=1;i<=maxpages;i++){$scope.noOfPagesEpa.push(i)}}else if(currPage<totalPages-1){if(maxpages==3){num=currPage-1}else{num=currPage-2}for(var i=1;i<=maxpages;i++){$scope.noOfPagesEpa.push(num++)}}else if(currPage==4&&totalPages==4){if(maxpages==3){num=2;for(var i=1;i<=maxpages;i++){$scope.noOfPagesEpa.push(num++)}}else{num=1;for(var i=1;i<=totalPages;i++){$scope.noOfPagesEpa.push(num++)}}}else{if(maxpages==3){num=totalPages-2}else{num=totalPages-4}for(var i=1;i<=maxpages;i++){$scope.noOfPagesEpa.push(num++)}}}};$scope.setPage=function(obj){if(obj>0&&obj<=$scope.pages){$scope.currentPage=obj;var startIndex=(obj-1)*$scope.pageSize;var subGroupBy="";if(typeof $scope.rxSubGroupBy!=='undefined'){subGroupBy=$scope.rxSubGroupBy}var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&context='+$scope.context+'&encounterId='+$scope.encounterid+'&strFilter=Medication&groupBy='+$scope.selected_id.name+'&subgroupBy='+subGroupBy+'&trigger=rxlistdata&startIndex='+startIndex;var rxjson=JSON.parse(urlGet(serverUrl));$scope.setPagination();$scope.MedSummarys=preProcessHTMLContent(rxjson)}};$scope.setPageEpa=function(objPage){if(objPage>0&&objPage<=$scope.pagesEpa){$scope.currentPageEpa=objPage;var startIndexEpa=(objPage-1)*$scope.pageSizeEpa;var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&context='+$scope.context+'&encounterId='+$scope.encounterid+'&trigger=epalistdata&startIndexEpa='+startIndexEpa;var epaJson=JSON.parse(urlGet(serverUrl));$scope.setEpaPagination();$scope.epaList=preProcessEpaHTMLContent(epaJson)}};var preProcessEpaHTMLContent=function(epaJson){var epaList=$.isArray(epaJson.ePAList)?epaJson.ePAList:x2js.asArray(epaJson.ePAList)[0];var nSize=epaList.length;var epaData={};for(var index=0;index<nSize;index++){epaData=epaList[index];epaData.drugDescription=$sce.trustAsHtml(epaData.drugDescription)}return epaList};$scope.subText=function(text,length){if(text&&text.length>length){return text.substr(0,length)+"..."}return text};$scope.subToolTip=function(text,length){if(text&&text.length>length){return text}return""};var preProcessHTMLContent=function(rxJson){var medSummarys=$.isArray(rxJson.MedSummarys.MedSummary)?rxJson.MedSummarys.MedSummary:x2js.asArray(rxJson.MedSummarys)[0];var nSize=medSummarys.length;var medSummary={};var nRxSize=0;var rxArray={};for(var index=0;index<nSize;index++){medSummarys[index].nameHeading=$sce.trustAsHtml(medSummarys[index].nameHeading);medSummary=medSummarys[index].array;nRxSize=medSummary.length;for(var rxIndex=0;rxIndex<nRxSize;rxIndex++){rxArray=medSummary[rxIndex];rxArray.medHeading=$sce.trustAsHtml(rxArray.medHeading)}}return medSummarys};$scope.loadCCMRcp=function(){$ocLazyLoad.load({name:'ccmRcp',files:['/mobiledoc/jsp/webemr/rightpanel/ccm-rcp/ccm-rcp.css','/mobiledoc/jsp/webemr/ccm/userfacing/programenrollment/js/directive/ccmProgramEnrollment-tpl.js','/mobiledoc/jsp/webemr/ccmr/rpm/enrollment/js/directive/rpmPatientDisenrollment-tpl.js']}).then(function(){},function(e){})};try{$scope.globalalerts=$.isArray($scope.overviewjson.globalAlerts.Alert)?$scope.overviewjson.globalAlerts.Alert:x2js.asArray($scope.overviewjson.globalAlerts)[0]}catch(e){}try{$scope.cptdaysalert=$scope.overviewjson.globalAlerts.CPTDaysAlert}catch(e){}try{$scope.advanceddirective=$.isArray($scope.overviewjson.advancedDirective.advDir)?$scope.overviewjson.advancedDirective.advDir:x2js.asArray($scope.overviewjson.advancedDirective)[0]}catch(e){}try{$scope.currentmedicines=$.isArray($scope.overviewjson.CurrentMedicines.CurrentMedicine)?$scope.overviewjson.CurrentMedicines.CurrentMedicine:x2js.asArray($scope.overviewjson.CurrentMedicines)[0]}catch(e){}try{$scope.wcvAppointment=$.isArray($scope.overviewjson.wcvAppointmentData.wcvAppointment)?$scope.overviewjson.wcvAppointmentData.wcvAppointment:x2js.asArray($scope.overviewjson.wcvAppointmentData.WCVAppointment)[0];$scope.wcvIndicator=$scope.overviewjson.wcvAppointmentData.wcvIndicator;$scope.isPatientAgeUnder22=$scope.wcvAppointment&&$scope.wcvAppointment[0]?$scope.wcvAppointment[0].isPatientAgeUnder22:false}catch(e){}try{$scope.transitionOfCare=$scope.overviewjson.overviewdata.transitionOfCare;if($scope.context==='progressnotes'&&$scope.transitionOfCare==='true'){if($scope.overviewjson.overviewdata.PLVerifiedVal==="1")$scope.plVerified="1";else $scope.plVerified="0"}}catch(e){}$scope.showMedSummaryAlert=function(){var labType=0;var parentname="MedicationAlerts";var medicationAlertDataObject={encounterId:$scope.encounterid,patientId:$scope.patientid,trUserId:global.TrUserId,parentName:parentname,requestedFrom:'frmPNRightPanel',context:'frmPNRightPanel',nDxId:""};$ocLazyLoad.load({name:'medicationSummAlertApp',files:['/mobiledoc/jsp/webemr/rightpanel/js/medicationAlerts.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL("/mobiledoc/jsp/webemr/rightpanel/medicationAlerts.jsp"),controller:'medicationSummAlertController',windowClass:'app-modal-window bluetheme',backdrop:"static",resolve:{medicationAlertDataObject:function(){return medicationAlertDataObject}}});modalInstance.result.then(function(responseObj){},function(responseObj){if(responseObj=='success'){$scope.hasMedicationAlerts=false}})})};$scope.openMedicationSummary=function(){var labType=0;var parentname="RxSummary_ManageOrders";var medSummaryContext="frmPNRightPanel";if($scope.context==="telenc"){medSummaryContext="frmTelRCPMedSummary"}var manageOrderDataObject={encounterId:$scope.encounterid,patientId:$scope.patientid,trUserId:global.TrUserId,labType:labType,parentName:parentname,requestedFrom:'frmPNRightPanel',context:medSummaryContext,nDxId:""};$ocLazyLoad.load({name:'manageOrdersModule',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/manageOrders.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/EncDetailsService.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL("/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/manageOrders.jsp"),controller:'manageOrdersCtrl',windowClass:'app-modal-window bluetheme',keyboard:false,backdrop:"static",resolve:{manageOrderDataObject:function(){return manageOrderDataObject}}});modalInstance.result.then(function(responseObj){},function(responseObj){$scope.AddtoProgressNotes('div_medSummary','','','')})})};try{$scope.mainoptions=[{id:0,name:'Date'},{id:1,name:'Medication'},{id:2,name:'Provider'}];var defaultGroupBy=$scope.overviewjson.DefaultmedSummaryGroupby;$scope.rcpMedSummaryOldView=getItemKeyValue("rcpMedSummaryOldView").toUpperCase()==="YES";$scope.getDefaultSubGroupVal=function(groupBy){return $scope.rcpMedSummaryOldView?"All":groupBy==='Date'?"-- As of Today --":"-- Select --"};let defaultSubGroupVal=$scope.getDefaultSubGroupVal(defaultGroupBy);$scope.subGroupDDLabel=defaultSubGroupVal;if(defaultGroupBy=='Date'){$scope.selected_id=$scope.mainoptions[0];$scope.rxGroupBy="Date";$scope.subGroupLabel=defaultSubGroupVal}else if(defaultGroupBy=='Medication'){$scope.selected_id=$scope.mainoptions[1];$scope.rxGroupBy="Medication";$scope.subGroupLabel=defaultSubGroupVal}$scope.hasMedicationAlerts=$scope.overviewjson.CheckMedicationAlerts}catch(e){}try{$scope.allergies=$.isArray($scope.overviewjson.Allergies.Allergy)?$scope.overviewjson.Allergies.Allergy:x2js.asArray($scope.overviewjson.Allergies)[0];$scope.uncodedAllergyCount=$scope.overviewjson.uncodedAllergyCount?$scope.overviewjson.uncodedAllergyCount:0}catch(e){}try{$scope.epaList=$scope.overviewjson.ePAList;$scope.totalRowsEpa=$scope.overviewjson.TotalRowsEpa;$scope.pageSizeEpa=$scope.overviewjson.NoOfRowsPageEpa;$scope.setEpaPagination()}catch(e){}try{$scope.problemlist=$.isArray($scope.overviewjson.Problems.prob)?$scope.overviewjson.Problems.prob:x2js.asArray($scope.overviewjson.Problems)[4];$scope.problemlistcount=$scope.overviewjson.Problems.itemCount;$scope.problemlistCnt=$scope.overviewjson.Problems.nCnt;$scope.NKPFlag=$scope.overviewjson.Problems.NKPFlag;$scope.hccWarning=$scope.overviewjson.Problems.hccWarning;$scope.showLeftarrow=$scope.overviewjson.overviewdata.showLeftarrow}catch(e){}try{$scope.immunizations=$.isArray($scope.overviewjson.immunizations.immunization)?$scope.overviewjson.immunizations.immunization:x2js.asArray($scope.overviewjson.immunizations)[0]}catch(e){}try{$scope.injections=$.isArray($scope.overviewjson.injections.injection)?$scope.overviewjson.injections.injection:x2js.asArray($scope.overviewjson.injections)[0]}catch(e){}try{$scope.circleOfCare=$.isArray($scope.overviewjson.circleOfCare.coc)?$scope.overviewjson.circleOfCare.coc:x2js.asArray($scope.overviewjson.circleOfCare)[0]}catch(e){}try{if(typeof rpCCMController==="function"){rpCCMController($scope,$http,$ocLazyLoad,$sce,$templateCache,$modal,$interval)}}catch(e){console.log("right panel ccm: "+e)}try{if(typeof rpCPOController==="function"){rpCPOController($scope,$http,$ocLazyLoad,$sce,$templateCache,$modal,$interval)}}catch(e){console.log("right panel ccm: "+e)}try{$scope.isCQWorksheet=$scope.overviewjson.overviewdata.isCQWorksheet;$scope.isUnAnsweredQuestionsFound=$scope.overviewjson.overviewdata.isUnAnsweredQuestionsFound;$scope.isCheckforBeneficiary=$scope.overviewjson.overviewdata.isCheckforBeneficiary;$scope.isShowCQWLog=$scope.overviewjson.overviewdata.isShowCQWLog;$scope.isProblemListEditable=$scope.overviewjson.overviewdata.isProblemListEditable;$scope.isCurrentMedsEditable=$scope.overviewjson.overviewdata.isCurrentMedsEditable;$scope.isAllergiesEditable=$scope.overviewjson.overviewdata.isAllergiesEditable;$scope.isAlertsEditable=$scope.overviewjson.overviewdata.isAlertsEditable;$scope.isImmunizationEditable=$scope.overviewjson.overviewdata.isImmunizationEditable;$scope.isProgressNoteParent=$scope.overviewjson.overviewdata.isProgressNoteParent;$scope.ShowMedSummaryinPNRPCurrMed=$scope.overviewjson.overviewdata.ShowMedSummaryinPNRPCurrMed;$scope.enableCarePlan=$scope.overviewjson.overviewdata.enableCarePlan}catch(e){}if($scope.enableCarePlan=='true'){try{$scope.careplanlist=$.isArray($scope.overviewjson.careplanlist.careplan)?$scope.overviewjson.careplanlist.careplan:x2js.asArray($scope.overviewjson.careplanlist)[0]}catch(e){}}$scope.onMedSummaryAction=function(obj){$scope.selectedMedSummAction=obj};$scope.orderRxFromEpa=function(ePAData){ecwConfirm("Are you sure to Order "+ePAData.drugDescription+" ? ",'Confirm',function(){$rootScope.$broadcast('saveToProgressNoteFromEPA',ePAData)},null,"orangetheme")};$scope.openCarePlanHub=function(CarePlanId){$ocLazyLoad.load({name:'carePlan',files:["/mobiledoc/jsp/webemr/progressnotes/careplan/carePlanHubController.js","/mobiledoc/jsp/webemr/jellybean/fax/canvasUtil.js","/mobiledoc/jsp/webemr/js/xml2json.js","/mobiledoc/jsp/webemr/js/scriptel-easyscript.js"]}).then(function(){$scope.carePlanHubUrlForOverview=makeURL('/mobiledoc/jsp/webemr/progressnotes/careplan/patientcarehub.jsp?pid='+$scope.patientid+'&caseid='+CarePlanId+'&requestFrom=pn&newCarePlan=false')},function(e){console.log(e)})};$scope.clearCareplanHubURL=function(){$templateCache.remove($scope.carePlanHubUrlForOverview);$scope.carePlanHubUrlForOverview=""};$scope.openCarePlan=function(carePlanId,problem,initator){if(initator=="problemList"){$("#carePlanProblemList").modal("hide");$scope.isProblemMoved=false;$("#pnController").scope().loadProgressNotePopup('Problems:')}else{$scope.copyCarePlanProblems(carePlanId,problem)}};$scope.copyCarePlanProblems=function(carePlanId,problem){$http({url:'/mobiledoc/jsp/webemr/progressnotes/careplan/carePlanHandler.jsp?OpType=CopyCarePlanProblems&careplanid='+carePlanId+'&problem='+problem+'&encId='+$scope.encounterid+'&TrUserId='+$scope.trUserId,method:'post'}).success(function(data){if(data.status=='success'){$("#pnController").scope().loadProgressNotePopup('Problems:')}else{alert("Failed to load care plan")}})};$scope.showCarePlanProblemList=function(carePlanId,problem){$scope.carePlanId=carePlanId;$scope.selectedProblem=problem;$http({url:'/mobiledoc/jsp/webemr/progressnotes/careplan/carePlanHandler.jsp?OpType=getCarePlanProblemList&careplanid='+carePlanId+'&problem='+problem,method:'post'}).success(function(data){if(data.status=='success'){$scope.carePlanProblemList=data.data;$("#carePlanProblemList").modal("show")}else{alert("Failed to load problem list")}})};$scope.closeProblemListPopup=function(){if($scope.isProblemMoved){$scope.openCarePlan(undefined,undefined,"problemList")}else{$("#carePlanProblemList").modal("hide")}};$scope.linkProblemId=function(id,index){if(id!=undefined){$http({method:"POST",url:'/mobiledoc/jsp/webemr/progressnotes/careplan/carePlanHandler.jsp?OpType=LINKPROMBLEMID&id='+id+'&encid='+$scope.encounterid+'&userid='+$scope.trUserId+'&careplanid='+$scope.carePlanId}).success(function(data){$scope.isProblemMoved=true;if(data.status=="success"){$scope.carePlanProblemList.splice(index,1)}})}};$scope.subProblemList=function(encCode,obj){if(!$.trim($('#problemlist'+obj+"_"+$scope.context).html()).length){$http({url:'/mobiledoc/jsp/webemr/rightpanel/problist_enc.jsp?ptId='+$scope.patientid+'&enccode='+encCode,method:'post'}).success(function(data){$('#problemlist'+obj+"_"+$scope.context).html(data)})}};$scope.loadCircleOfCare=function(){$ocLazyLoad.load({name:'circleOfCareMain',files:['/mobiledoc/jsp/webemr/rightpanel/js/cocMainController.js']}).then(function(){$scope.linkUrlForOverview=makeURL('/mobiledoc/jsp/webemr/rightpanel/cocMain.jsp?PatientId='+$scope.patientid+"&trigger=overview_rp")},function(e){console.log(e)})};$scope.getdisplay=function(itemid){if($('#problemlist'+itemid).hasClass("in")||$('#problemlist'+itemid).hasClass("collapsing"))return'';else if($('#list'+itemid).hasClass("collapsed"))return'none';else return'none'};$scope.to_trusted=function(html_code){return $sce.trustAsHtml(html_code)};$scope.overviewPopUp=function(url){};$scope.applyFilters=function(){var rpParams={};if(isSupportsLocalStorage()){if(!containsKey("rpParams")){rpParams={"plfilter":$scope.filter};put("rpParams",JSON.stringify(rpParams))}else{rpParams=JSON.parse(get("rpParams"));rpParams.plfilter=$scope.filter;put("rpParams",JSON.stringify(rpParams))}}var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&context='+$scope.context+'&encounterId='+$scope.encounterid+'&strFilter='+$scope.filter+'&trigger=problemlistdata';var pljson=JSON.parse(urlGet(serverUrl));$scope.problemlist=$.isArray(pljson.prob)?pljson.prob:x2js.asArray(pljson)[4];$scope.problemlistcount=pljson.itemCount;$scope.problemlistCnt=pljson.nCnt;$scope.NKPFlag=pljson.NKPFlag;$scope.hccWarning=pljson.hccWarning;if($scope.isEnablePotentialDiagnosis&&isPDXChange){$scope.loadPDList();isPDXChange=false}};$scope.refreshAdvDirList=function(){var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&trigger=advancedir';var advdirjson=JSON.parse(urlGet(serverUrl));$scope.advanceddirective=$.isArray(advdirjson.AdvDir)?advdirjson.AdvDir:x2js.asArray(advdirjson.AdvDir)[0]};$scope.refreshcoc=function(){var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&trigger=circleofcare';var cocjson=JSON.parse(urlGet(serverUrl));$scope.circleOfCare=$.isArray(cocjson.coc)?cocjson.coc:x2js.asArray(cocjson.coc)[0]};$scope.refreshProblemlist=function(){var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&context='+$scope.context+'&encounterId='+$scope.encounterid+'&strFilter='+$scope.filter+'&trigger=problemlistdata';var pljson=JSON.parse(urlGet(serverUrl));$scope.problemlist=$.isArray(pljson.prob)?pljson.prob:x2js.asArray(pljson)[4];$scope.problemlistcount=pljson.itemCount;$scope.problemlistCnt=pljson.nCnt;$scope.NKPFlag=pljson.NKPFlag;$scope.hccWarning=pljson.hccWarning};$scope.AddtoProgressNotes=function(divId,itemid,onsetdate,convert,SNOMED,itemcode,itemname){$.ajaxSetup({"async":false});if($scope.dbencid==""){$.ajax({type:"POST",url:"/mobiledoc/jsp/dashboard/GetDBEncounterId.jsp",data:{ptId:$scope.$parent.patientid},success:function(data){var xmlDoc=$.parseXML(data);var $title=$(xmlDoc).find("encounterid");$scope.dbencid=$.trim($title.text())}})}if($scope.encdate==""){$.ajax({type:"POST",url:"/mobiledoc/jsp/catalog/xml/getValuesForEnctrId.jsp?encounterId="+$scope.$parent.encounterid+"&TrUserId="+global.TrUserId,success:function(data){var xmlDoc=$.parseXML(data);var $title=$(xmlDoc).find("date");$scope.encdate=$.trim($title.text())}})}$.ajaxSetup({"async":true});var strurl="";var bEnabledConcurLock=getItemKeyValue("EnableConcurLock").toUpperCase()=="YES";if(divId=='div_allergy'){if($scope.encLockVal_RP==="1"){return false}strurl="/mobiledoc/jsp/dashboard/MergeAllergyData.jsp?patientId="+$scope.patientid+"&encounterId="+$scope.encounterid+"&dbEncId="+$scope.dbencid+"&eDate="+$scope.encdate;strurl=makeURL(strurl);if(bEnabledConcurLock){var lockObj={formName:"frmHistory",uniqueKey:"frmHistory"+$scope.encounterid,g_cancel:false,strKey:"",isOpenform:false};acquireFormLock(lockObj,acquireFormLockCallBack);function acquireFormLockCallBack(){if(lockObj.g_cancel){return}else{ajaxCall(strurl,divId);releaseFormLock(lockObj)}}}else{ajaxCall(strurl,divId)}}else if(divId==='div_all_problemlist'){if($scope.encLockVal_RP==="1"){ecwAlert('Problem list codes cannot be added to a locked encounter');return false}$scope.confirmAllMergeAssessment(divId,itemid,onsetdate,convert,SNOMED,itemcode,bEnabledConcurLock)}else if(divId==='div_problemlist'||divId==='div_potentialConditionList'){if($scope.encLockVal_RP==="1"){ecwAlert('Problem list codes cannot be added to a locked encounter');return false}var lockObj={formName:"frmAssessments",uniqueKey:"frmAssessments"+$scope.encounterid,g_cancel:false,strKey:"",isOpenform:false,actionable:true};if(convert=="0"){$scope.confirmMergeAssessment(itemcode,itemid,onsetdate,SNOMED,divId,lockObj,bEnabledConcurLock,true,itemname)}else if(convert=="1"){var addSingleDiagnosisToAssessment=function(){if(bEnabledConcurLock){acquireFormLock(lockObj,acquireFormLockCallBack);function acquireFormLockCallBack(){if(lockObj.g_cancel){return}else{openIcdConversionModal(itemid,onsetdate,lockObj,true,itemcode)}}}else{openIcdConversionModal(itemid,onsetdate,lockObj,false,itemcode)}};var url='/mobiledoc/jsp/catalog/xml/getICDValidity.jsp?scode='+itemcode;url+='&encdate='+$scope.encdate;url+='&itemid='+itemid;url=makeURL(url);var isInvalidCode=false;$.ajax({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,"async":false}).success(function(data){try{if(data!==undefined&&data!==""&&x2js.xml_str2json(data).Envelope.Body["return"].Reminders.Reminder.Name==="Invalid"){isInvalidCode=true}}catch(err){}});if(isInvalidCode){ecwConfirm("ICD Code: "+itemcode+" not active or non billable for Encounter Date. Do you want to choose this anyway?","eClinicalWorks",addSingleDiagnosisToAssessment,null);return}else{addSingleDiagnosisToAssessment()}}}else{strurl="";ajaxCall(strurl,divId)}};$scope.showAllergyTooltip=function(){var strTooltip="Add allergies to notes";if($scope.encLockVal_RP==="1"){strTooltip="Allergies cannot be added to a locked encounter"}else if($scope.virtualFlagVal==="0"){strTooltip="Import is disabled because this visit is not marked as a Virtual visit."}return strTooltip};$scope.markToDoAsCompleted=function(itemcode,itemname){$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"markToDoAsCompleted",patientId:$scope.patientid,itemcode:itemcode,itemname:itemname})}).success(function(response){$rootScope.$broadcast('refreshTodolistCount')})};var ajaxCall=function(strurl,divId){$http({url:strurl,method:'post'}).success(function(){if(divId==='div_medSummary'){refreshDashboard($scope.encounterid,$scope.patientid,"rightPanelMedSummary");$scope.pdmpEnable=getItemKeyValue('EnablePDMP').toLowerCase()=="yes";$scope.pdmpActive=getItemKeyValue('IsPDMPActive').toLowerCase()=="yes";$scope.pdmpEnableForBottomPanel=getItemKeyValue('EnablePDMPForBottomPanel').toLowerCase()=="yes";if($scope.pdmpEnable===true&&$scope.pdmpActive===true&&$scope.pdmpEnableForBottomPanel===true){var tabsPanelScope=angular.element(document.getElementById('tabspanel')).scope();var bottomScope=angular.element(document.getElementById('bottomPanelApp')).scope();if(bottomScope&&bottomScope!=null){if(tabsPanelScope.tabAction=="progressNote"){bottomScope.checkPdmpColorAlertStatus($scope.encounterid)}}}}else if(divId==='div_all_problemlist'||divId==='div_problemlist'){$scope.refreshProblemlist();refreshDashboard($scope.encounterid,$scope.patientid);$scope.showOverviewMergeSuccessMsg('Problem List')}else{refreshDashboard($scope.encounterid,$scope.patientid);if(divId==='div_allergy'){$scope.showOverviewMergeSuccessMsg('Allergies')}}})};$scope.showOverviewMergeSuccessMsg=function(title){if($scope.context==='progressnotes'&&!$scope.$parent.isRCPEncounterLocked()){notification.show('success',title,'Successfully merged to the Progress Note.',4e3,'','#progress_content')}};var openIcdConversionModal=function(itemid,onsetdate,lockObj,bEnabledConcurrency,itemcode){var xmldata;$ocLazyLoad.load({name:'pl9to10',files:['/mobiledoc/jsp/webemr/toppanel/patientHub/PL9to10ConversionController.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/patientHub/ICD9toICD10Main.jsp?webemr=yes&frm=pl&search=&TrUserId="+global.TrUserId+"&encounterId="+$scope.encounterid+"&ptId="+$scope.patientid+"&useicd10=1&vendorcode=IMO&hcc=0&itm="+itemid);var modalInstance=$modal.open({templateUrl:makeURL(url),controller:'pl9to10Controller',backdrop:"static"});modalInstance.result.then(function(value){if(bEnabledConcurrency){var isClosed=false;if(lockObj.strKey!==""){if(!isLockMine2(lockObj)){isClosed=true}}if(isClosed){return}}if(value=="1"){var xw=new XMLWriter;startSoapPacket(xw);xw.writeStartElement('xml');xw.writeStartElement('assessment');xw.writeStartElement('EnCounterId');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA($scope.encounterid);xw.writeEndElement();xw.writeStartElement('code');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA(itemcode);xw.writeEndElement();xw.writeStartElement('id');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA(itemid);xw.writeEndElement();xw.writeStartElement('onsetdate');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA(onsetdate);xw.writeEndElement();xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);xmldata=xw.flush();var strurl="/mobiledoc/jsp/dashboard/MergeAssessments.jsp?Id="+$scope.encounterid+"&FormData="+xmldata;$http({url:strurl,method:'post'}).success(function(){if(bEnabledConcurrency)releaseFormLock(lockObj);refreshDashboard($scope.encounterid,$scope.patientid);$scope.showOverviewMergeSuccessMsg('Problem List')})}else if(value=="0"){if(bEnabledConcurrency){releaseFormLock(lockObj)}refreshDashboard($scope.encounterid,$scope.patientid)}},function(){})},function(e){console.log(e)})};$scope.confirmMergeAssessment=function(itemcode,itemid,onsetdate,snomedCode,divId,lockObj,bConcurLock,bConfirm,itemname){if(!bConfirm){$scope.mergeAssessment(itemcode,itemid,onsetdate,snomedCode,divId,lockObj,bConcurLock,null);return}var url='/mobiledoc/jsp/catalog/xml/getICDValidity.jsp?scode='+itemcode;url+='&encdate='+$scope.encdate;url+='&itemid='+itemid;url=makeURL(url);var strValidCode=false;var bCodeValid=false;try{$.ajax({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,"async":false}).success(function(data){if(data!=undefined&&data!=""){var confirmMsg="";var icdJSONData=x2js.xml_str2json(data);if(icdJSONData.Envelope.Body["return"].Reminders){var strValidCode=icdJSONData.Envelope.Body["return"].Reminders.Reminder.Name;if(strValidCode==="Invalid"){confirmMsg="ICD Code: "+itemcode+" not active or non billable for Encounter Date. Do you want to choose this anyway?";BootstrapDialog.show({title:"eClinicalWorks",message:confirmMsg,cssClass:'zindex-bootstrap',buttons:[{label:'Yes',cssClass:'btn-lgrey btn-xs',action:function(dialog){{$scope.mergeAssessment(itemcode,itemid,onsetdate,snomedCode,divId,lockObj,bConcurLock,itemname)}dialog.close();$scope.$apply()}},{label:'No',cssClass:'btn-lgrey btn-xs',action:function(dialog){switch(flag){case 1:focusSearch("description");break;case 2:focusSearch("description");break}dialog.close();return}}],closeByBackdrop:false,closeByKeyboard:false})}else{$scope.mergeAssessment(itemcode,itemid,onsetdate,snomedCode,divId,lockObj,bConcurLock,itemname)}}}})}catch(err){}};$scope.mergeAssessment=function(itemcode,itemid,onsetdate,snomedCode,divId,lockObj,bConcurLock,itemname){var xw=new XMLWriter;startSoapPacket(xw);xw.writeStartElement('xml');xw.writeStartElement('assessment');xw.writeStartElement('EnCounterId');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA($scope.encounterid);xw.writeEndElement();xw.writeStartElement('code');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA(itemcode);xw.writeEndElement();xw.writeStartElement('id');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA(itemid);xw.writeEndElement();xw.writeStartElement('onsetdate');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA(onsetdate);xw.writeEndElement();xw.writeStartElement('SNOMED');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA(snomedCode);xw.writeEndElement();xw.writeStartElement('synonymid');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA($scope.getLexicalIdFromItemCode(itemid,itemcode));xw.writeEndElement();xw.writeStartElement('comment');xw.writeAttributeString('xsi:type','xsd:string');xw.writeCDATA('Imported from Right Chart Panel');xw.writeEndElement();xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);var xmldata=xw.flush();var strurl="/mobiledoc/jsp/dashboard/MergeAssessments.jsp?Id="+$scope.encounterid+"&FormData="+xmldata;if(bConcurLock){acquireFormLock(lockObj,acquireFormLockCallBack);function acquireFormLockCallBack(){if(lockObj.g_cancel){return}else{$scope.markToDoAsCompleted(itemcode,itemname);ajaxCall(strurl,divId);releaseFormLock(lockObj)}}}else{$scope.markToDoAsCompleted(itemcode,itemname);ajaxCall(strurl,divId)}};$scope.loadmodalurl=function(){if($scope.encounterid==null||$scope.encounterid==undefined||$scope.encounterid==""){$scope.encounterid=0}var overview_plencid;if($scope.context==='patienthub'){overview_plencid=0}else{overview_plencid=$scope.encounterid}var url="/mobiledoc/jsp/webemr/rightpanel/problemList.jsp?context="+$scope.context+"&pid="+$scope.patientid+"&encId="+overview_plencid+"&callFrom=rigthPanelOverview";$ocLazyLoad.load({name:'problemlist',files:['/mobiledoc/jsp/webemr/js/vendor/jscrollpane.js','/mobiledoc/jsp/webemr/rightpanel/js/plListController.js','/mobiledoc/jsp/webemr/progressnotes/billing/assessmentNotes-tpl.js','/mobiledoc/jsp/resources/jslib/angular-ui-bootstrap/dist/ui-bootstrap-tpls.js','/mobiledoc/jsp/webemr/progressnotes/assessment/assessment-import-module.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL(url),controller:'problemListController',scope:$scope,keyboard:false,backdrop:"static"});modalInstance.result.then(function(val){if(val!=undefined&&val=="1"){if($scope.context!=='progressnotes'){$scope.loadOverviewData()}$timeout(function(){$scope.problemlist=$.isArray($scope.overviewjson.Problems.prob)?$scope.overviewjson.Problems.prob:x2js.asArray($scope.overviewjson.Problems)[4];$scope.problemlistcount=$scope.overviewjson.Problems.itemCount;$scope.problemlistCnt=$scope.overviewjson.Problems.nCnt;$scope.NKPFlag=$scope.overviewjson.Problems.NKPFlag;$scope.hccWarning=$scope.overviewjson.Problems.hccWarning},300)}else{$templateCache.remove(url)}},function(e){$templateCache.remove(url)})})};$scope.openAlertSuppress=function(gapItem,arrayIndex){if(gapItem.source==='S'){$scope.source='Secondary'}else if(gapItem.source==='H'){$scope.source='Historical'}else if(gapItem.source==='E'){$scope.source='External'}else{$scope.source='Manual'}$scope.gapItemname=gapItem.itemname;$scope.gapItemcode=gapItem.itemcode;$scope.reason=false;$scope.alertReasonText="";$('#suppressAlertDialogRCP').modal({backdrop:'static',keyboard:false,show:true})};$scope.cancelSuppressAlert=function(){$('#suppressAlertDialogRCP').modal('hide').data('bs.modal',null)};$scope.suppressAlert=function(reason,alertReasonText){if(reason==='Other'){$scope.alertReasonText=reason+' - '+alertReasonText}else{$scope.alertReasonText=reason}$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"suppressgap",patientId:$scope.patientid,gapitemname:$scope.gapItemname,gapitemcode:$scope.gapItemcode,gapreason:$scope.alertReasonText,gapsource:$scope.source})}).success(function(){refreshDashboard($scope.encounterid,$scope.patientid)});$('.suppressAlertDialogRCP').modal('hide').data('bs.modal',null)};$scope.ReactivateHCCGap=function(gapItem){bootbox.confirm("Are you sure you want to reactivate  "+gapItem.itemcode+" HCC Gap recommendation?",function(result){if(result){$scope.Reactivated_id=gapItem.id;$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"ReactivateHCCGap",patientId:$scope.patientid,Reactivated_id:$scope.Reactivated_id})}).success(function(){refreshDashboard($scope.encounterid,$scope.patientid)})}})};$scope.clearReview=function(item,reviewType){$('textarea[id="suppressReasonValue"]').val("")};$scope.loadADmodalurl=function(){$scope.linkUrlForOverview=makeURL("/mobiledoc/jsp/webemr/rightpanel/advanceDirective.jsp?patientId="+$scope.patientid)};$scope.getallergyname=function(AllergyName,Reaction,criticality,onsetDate){var strAllergeyInfo=AllergyName;if(Reaction!=null&&Reaction.trim().length>0){strAllergeyInfo+=' : '+Reaction}if(criticality!=null&&criticality.trim().length>0){if(strAllergeyInfo.indexOf(':')>-1){strAllergeyInfo+=" - Criticality "+criticality}else{strAllergeyInfo+=" : Criticality "+criticality}}if(onsetDate!=null&&onsetDate.trim().length>0){if(strAllergeyInfo.indexOf(':')>-1){strAllergeyInfo+=" - Onset Date "+onsetDate}else{strAllergeyInfo+=" : Onset Date "+onsetDate}}return strAllergeyInfo};$scope.openAllergyDialog=function(){if(!sectionOpenedInPN)$scope.triggerDataUpdateWarning('Allergies',launchAllergies);else ecwAlert("This action is not allowed when a progress note screen is open in the background as it might result in data loss.")};var launchAllergies=function(){var url=makeURL("/mobiledoc/jsp/webemr/progressnotes/medicalhistory/rpMedicalHx.jsp?patientId="+$scope.patientid+"&section=allergy"+"&parentName=frmHistory");$ocLazyLoad.load({name:'rpMedicalHx',files:['/mobiledoc/jsp/webemr/progressnotes/medicalhistory/medicalhistorycontroller.js','/mobiledoc/jsp/webemr/progressnotes/medicalhistory/rpMedicalHxCtrl.js','/mobiledoc/jsp/webemr/progressnotes/hpi/hpicontroller.js','/mobiledoc/jsp/webemr/templates/customitem-tpl.js','/mobiledoc/jsp/webemr/templates/customproperties-tpl.js'],cache:false}).then(function(){$scope.linkUrlForOverview=url},function(e){console.log(e)})};$scope.editTInjections=function(nImmInjType){$ocLazyLoad.load({name:'ImmInjHxApp',files:getDependencies('ImmInjHxApp')}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/labs/immunizations/ImmunizationHx.jsp?nImmInjType="+nImmInjType+"&toppanelencounterId="+$scope.encounterid+"&patientId="+$scope.patientid+"&userId="+global.TrUserId+"&nd="+(new Date).getTime());$scope.linkUrlForOverview=url},function(e){console.log(e)})};$scope.isDataLoadingForMedSumm=false;$scope.setAsOfTodayRxCount=function(rxData){let hasRxInAsOfToday=false;if($scope.rxGroupBy=='Date'&&$scope.subGroupDDLabel==="-- As of Today --"&&rxData.MedSummarys.MedSummary[0].array.length>0&&rxData.MedSummarys.MedSummary[0].array[0].medName.indexOf("-- NONE --")===-1){hasRxInAsOfToday=true}$scope.hasRxInAsOfToday=hasRxInAsOfToday};$scope.changeDDVal=function(obj){$scope.currentPage=1;$scope.selected_id=obj;$scope.rxGroupBy=obj.name;$scope.subGroupDDLabel=$scope.getDefaultSubGroupVal(obj.name);$scope.selected_sub_id=null;$scope.isDataLoadingForMedSumm=true;var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp';var requestData='patientId='+$scope.patientid+'&context='+$scope.context+'&encounterId='+$scope.encounterid+'&strFilter=Medication&groupBy='+$scope.selected_id.name+'&subgroupBy=&trigger=rxlistdata&startIndex=0';var promise=$.ajax({url:makeURL(serverUrl),type:"POST","async":true,data:requestData});promise.done(function(data){try{$scope.isDataLoadingForMedSumm=false;var rxjson=JSON.parse(data);$scope.totalNoOfRows=rxjson.TotalNoOfMedSummarys.TotalRows;$scope.setAsOfTodayRxCount(rxjson);$scope.pageSize=rxjson.TotalNoOfMedSummarys.NoOfRowsPage;$scope.setPagination();$scope.MedSummarys=preProcessHTMLContent(rxjson);$scope.MedSummaryDropDowns=$.isArray(rxjson.MedSummaryDropDowns.MedSummaryDropDown)?rxjson.MedSummaryDropDowns.MedSummaryDropDown:x2js.asArray(rxjson.MedSummaryDropDowns)[0];$scope.$evalAsync()}catch(e){$scope.isDataLoadingForMedSumm=false}})};$scope.changeSubDDVal=function(obj){$scope.rxSubGroupBy=0;if(obj!=null)$scope.rxSubGroupBy=obj.DropDownId;$scope.currentPage=1;$scope.isDataLoadingForMedSumm=true;var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp';var requestData='patientId='+$scope.patientid+'&context='+$scope.context+'&encounterId='+$scope.encounterid+'&strFilter=Medication&groupBy='+$scope.selected_id.name+'&subgroupBy='+$scope.rxSubGroupBy+'&trigger=rxlistdata&startIndex=0';var promise=$.ajax({url:makeURL(serverUrl),type:"POST","async":true,data:requestData});promise.done(function(data){try{$scope.isDataLoadingForMedSumm=false;var rxjson=JSON.parse(data);$scope.totalNoOfRows=rxjson.TotalNoOfMedSummarys.TotalRows;$scope.pageSize=rxjson.TotalNoOfMedSummarys.NoOfRowsPage;$scope.setPagination();$scope.MedSummarys=preProcessHTMLContent(rxjson);$scope.$evalAsync()}catch(e){$scope.isDataLoadingForMedSumm=false}})};$scope.changeDDVal($scope.selected_id);$scope.toggleActiveClass=function(name,index){$("#inner"+name+index).toggleClass('active')};$scope.getPPDImmunization=function(ImmInjId){$http({method:"POST",url:'/mobiledoc/jsp/dashboard/AttachPastOrders.jsp',cache:false,params:{EncounterId:$scope.encounterid,ImmInjId:ImmInjId,Type:"0"}}).success(function(data){setActiveTab($scope.currentTab,$scope.currentTabUrl);refreshDashboard($scope.encounterid,$scope.patientid)}).error(function(data){console.log("Error occured while saving information")})};$scope.refreshCOCdata=function(){$scope.loadOverviewData();$scope.circleOfCare=$.isArray($scope.overviewjson.circleOfCare.coc)?$scope.overviewjson.circleOfCare.coc:x2js.asArray($scope.overviewjson.circleOfCare)[0]};var hideBsCollapse=function(event){$(this).parents(".collhead").find(".collicon").removeClass("icon rounded-blueminus");$(this).parents(".collhead").find(".collicon").addClass("icon rounded-blueplus")};var showBsCollapse=function(event){$(this).parents(".collhead").find(".collicon").removeClass("icon rounded-blueplus");$(this).parents(".collhead").find(".collicon").addClass("icon rounded-blueminus")};$(document).on("hide.bs.collapse",".coll",hideBsCollapse);$(document).on("show.bs.collapse",".coll",showBsCollapse);$scope.$on('$destroy',function(){$(document).off("hide.bs.collapse",".coll",hideBsCollapse);$(document).off("show.bs.collapse",".coll",showBsCollapse);$timeout.cancel(refreshSnomedTimeout);virtualFlagValue=null});$scope.geteMARSummaryData=function(){if($scope.isEmarFeaturesEnabled){var drugSource="";for(var i=1;i<$scope.eMARSummary.CategoryItems.length;i++){if($scope.eMARSummary.CategoryItems[i].id===$scope.drugSource){drugSource=$scope.eMARSummary.CategoryItems[i].label}}var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&context='+$scope.context+'&trigger=eMARSummaryCorrections';serverUrl=serverUrl+"&showCQWLink="+showCQWLink;let data={drugSource:drugSource,encounterId:$scope.encounterid};var eMARSummaryJSON=urlPost(serverUrl,data);if($.trim(eMARSummaryJSON)!==undefined&&$.trim(eMARSummaryJSON)!=='')$scope.eMARSummaryJSON=JSON.parse(eMARSummaryJSON);else $scope.eMARSummaryJSON=""}};$scope.openMedicationAdministrationScheduleDetails=function(eMarMedScheduleId,eMARMedId){$scope.MASDetails=null;var files=['/mobiledoc/jsp/webemr/medicationadministration/MedicationAdministrationScheduleDetailsCtrl.js','/mobiledoc/jsp/webemr/js/skinnytip.js','/mobiledoc/jsp/webemr/js/emr-screen.js','/mobiledoc/jsp/webemr/css/emrscreen.css','/mobiledoc/jsp/webemr/corrections/js/CorrectionService.js','/mobiledoc/jsp/webemr/medicationadministration/dirPagination.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js'];$ocLazyLoad.load({name:'MedicationAdministrationScheduleDetailsModule',files:files}).then(function(){var rawUrl='/mobiledoc/jsp/webemr/medicationadministration/MedicationAdministrationScheduleDetails.jsp?'+'patientId='+$scope.patientid+'&eMarMedScheduleId='+eMarMedScheduleId+'&TrUserId='+global.TrUserId+'&eMARMedId='+eMARMedId;var url=makeURL(rawUrl);$scope.MASDetails=url},function(e){})};$scope.callPrintCurrentRx=function(){if($scope.context=='patienthub'){var varUrl="/mobiledoc/jsp/catalog/xml/PrintCurrentRx.jsp?&patientId="+$scope.patientid;varUrl=makeURL(varUrl);$.ajax({type:"POST",url:varUrl,success:function(response){var obj=document.getElementById('currRxDialogApp');$('#currRxContent').html("");$(obj).modal();$('#currRxContent').html(response)}})}};$scope.closeCurrentPrintRx=function(){$("#currRxDialogApp").modal('hide')};$scope.printRxDialog=function(){var windowContent=$('#currRxContent').html();var printWin=window.open('','','width=750,height=650,top=50,left=50,toolbars=no,scrollbars=yes,status=no,resizable=yes');printWin.document.open();printWin.document.write(windowContent);printWin.document.close();printWin.focus();printWin.print()};$scope.isCorrectionalFeaturesOn=getItemKeyValue("EnableCorrectionalFeatures").toLowerCase()==="yes";$scope.loadCancelRx=function(rxOrderNo,drugName,rxFullName){if($scope.isCorrectionalFeaturesOn===true||getItemKeyValue("EnableCancelRxForStoppedRx").toLowerCase()==='yes'){if(getItemKeyValue("EnableCancelRx").toLowerCase()==='yes'||getItemKeyValue("EnablePICancelRx").toLowerCase()==='yes'){if(getUserProfile("cancelRxAlert")==='1'){var cancelRxMsg="To send a cancellation request to the pharmacy, please click CANCEL for this medication and the appropriate pharmacy in the ePrescription Logs.";cancelRxMsg+="\n\n Would you like to open the ePrescription Logs?";BootstrapDialog.show({title:"Cancel Rx Alert",message:cancelRxMsg,closable:true,draggable:false,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:'Yes',action:function(dialog){dialog.close();$scope.openCancelRx(rxOrderNo,drugName);$scope.closeCancelRxFromRightChartPanel()}},{label:'No',action:function(dialog){dialog.close();$scope.closeCancelRxFromRightChartPanel()}}]})}else{notification.show('success','Overview Screen',''+escapeHtml(rxFullName)+' Stopped. To send a cancellation to the pharmacy go to Patient Hub > ePrescription Logs.',4e3)}}}};$scope.openCancelRx=function(rxOrderNo,drugName){$scope.eRxLogsURLRightChartPanel="";$ocLazyLoad.load({name:'myApp.Ejellybean.controllers',files:['/mobiledoc/jsp/webemr/jellybean/refillrequest/js/ejelly.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/RxFillIndicator.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/eRxMessageViewer.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/commonRxRequest.js'],cache:false}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/ePrescription/ePrescriptionPtHub.jsp?pthub=yes&ptid='+$scope.patientid+'&rxOrderNo='+rxOrderNo+"&calledFrom=CancelRxRightChartPanel&drugName="+drugName;url=makeURL(url);$scope.eRxLogsURLRightChartPanel=url},function(e){console.log(e)})};$scope.closeCancelRxFromRightChartPanel=function(bCloseCancelRxMsg){if(typeof bCloseCancelRxMsg=='undefined'){$("#ptHubeRxLogs").modal('hide')}if($scope.context=='progressnotes'){$scope.AddtoProgressNotes('div_medSummary','','','')}else if($scope.context=='telenc'){if($("#virtualvisittab").hasClass("active")){$scope.checkEncounterB4getVirtualVisit()}else if($("#rxtab").hasClass("active")){$scope.$parent.getRx()}}};$scope.PLVerifiedNKPCheck=function(){var param={pnencid:$scope.encounterid,trUserId:global.TrUserId,plVerfiedVal:1,patientId:$scope.patientid};var plVerified=urlPost(makeURL('/mobiledoc/jsp/dashboard/PLVerified.jsp'),param);if($.trim(plVerified)&&$.trim(plVerified)=='success'){$scope.NKPFlag=1}$timeout(function(){$scope.plVerified='1'},0)};$scope.setPLVerified=function(){try{if(!($scope.plVerified==="1")){ecwConfirm("Are you sure you want to mark the Problem List  Verified for "+$scope.$parent.patientName+" ? ","Problem List Verified Confirmation",function(){$scope.PLVerifiedNKPCheck()},function(){return})}}catch(e){console.log(e)}};$scope.overviewPrintDialog=function(){var windowContent=$('#OverviewPreviewContent').html();var id='tempEncTypePrintPreviewDiv';var strHTML="<HTML>"+windowContent+"  <style> @media print { @page { margin-bottom:0px; } }   </style> </HTML>";$('<iframe id="'+id+'" name="'+id+'" >').appendTo('body');var doc=$("#"+id)[0].contentWindow.document;doc.open();doc.write(strHTML);doc.close();$scope.onReadyStateLoadHTML(id)};$scope.onReadyStateLoadHTML=function(id){var timeOut=0;try{$timeout(function(){if($('#'+id).contents().find("body").html()){timeOut=0;window.frames[id].focus();window.frames[id].print()}else{timeOut++;if(timeOut>1500){timeOut=0;showMessage("Could Not Load the Requested page,try again!","");return false}$scope.onReadyStateLoadHTML()}},2500)}catch(e){ecwAlert("An error occured while printing")}};$scope.loadPDList=function(){$scope.potentialDiagnosisCount=0;var param={patientId:$scope.patientid,flag:"potentialdata",page:1,ncounterVal:0};var response=urlPost("/mobiledoc/jsp/dashboard/potentialdiagnosis/getPotentialDiagnosis.jsp",param);if(response){var data=JSON.parse(response);var bFlag=jQuery.isEmptyObject(data);if(bFlag){data.totalexternalICDS=0}$scope.potentialDiagnosisCount=data.totalexternalICDS}};$scope.isPDXListChanged=function(flag){isPDXChange=flag};if($scope.isEnablePotentialDiagnosis){$scope.loadPDList()}$scope.loadHiPdxPage=function(){$scope.loadHIRightPanelURL="";if(getItemKeyValue("HealowInsightsMenu").toLowerCase()==="yes"&&getItemKeyValue("HealowInsightsOverviewPDX").toLowerCase()==="yes"&&(getPermission("AllowHealowInsightsOverviewPDX",global.TrUserId)||getPermission("AllowHealowInsightsOverviewPDXReadOnly",global.TrUserId)||getPermission("HealowInsightsUnrestrictedDisagreeAndRestrictedAgree",global.TrUserId)||getPermission("HealowInsightsRestrictedDisagreeAndAgree",global.TrUserId))){$ocLazyLoad.load({name:'hiOverviewTab',files:['/mobiledoc/jsp/resources/jslib/perfect-scrollbar/dist/perfect-scrollbar.min.js','/mobiledoc/jsp/resources/jslib/perfect-scrollbar/css/perfect-scrollbar.css','/mobiledoc/jsp/healowInsights/rightpanel/js/hiHospiceHccCommentService.js','/mobiledoc/jsp/healowInsights/components/js/hcc-filter-service.js','/mobiledoc/jsp/healowInsights/rightpanel/js/hiOverviewController.js']}).then(function(){var url='/mobiledoc/jsp/healowInsights/rightpanel/view/hiOverviewTab.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&pnencId='+$scope.encounterid;$scope.loadHIRightPanelURL=makeURL(url)},function(e){})}};$scope.confirmAllMergeAssessment=function(divId,itemid,onsetdate,convert,SNOMED,itemcode,bEnabledConcurLock){var url="/mobiledoc/jsp/dashboard/checkAllValidityOfProblemListToNotes.jsp?patientId="+$scope.patientid+"&encounterId="+$scope.encounterid+"&dbEncId="+$scope.dbencid+"&eDate="+$scope.encdate;$.ajax({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,"async":false}).success(function(data){if(data!=undefined&&data!=""){var JSONData=x2js.xml_str2json(data);var data=JSONData.Envelope.Body["return"];if(data.status==="success"){if(data.codes!==""){var val=data.codes.replace(/,/g,", ");ecwConfirm("ICD Code: "+val+" not active or non billable for Encounter Date. Do you want to choose this anyway?","eClinicalWorks",$scope.addAllProblemListToNotes,null)}else{$scope.addAllProblemListToNotes(divId,itemid,onsetdate,convert,SNOMED,itemcode,bEnabledConcurLock)}}}})};$scope.addAllProblemListToNotes=function(divId,itemid,onsetdate,convert,SNOMED,itemcode,bEnabledConcurLock){if(divId===undefined){divId="div_all_problemlist"}var lockObj={formName:"frmAssessments",uniqueKey:"frmAssessments"+$scope.encounterid,g_cancel:false,strKey:"",isOpenform:false};var strurl="/mobiledoc/jsp/dashboard/AddAllProblemlistToNote.jsp?patientId="+$scope.patientid+"&encounterId="+$scope.encounterid+"&dbEncId="+$scope.dbencid+"&eDate="+$scope.encdate;if(bEnabledConcurLock){acquireFormLock(lockObj,acquireFormLockCallBack);function acquireFormLockCallBack(){if(lockObj.g_cancel){return}else{ajaxCall(strurl,divId);releaseFormLock(lockObj)}}}else{ajaxCall(strurl,divId)}};$scope.loadPreviewDialogueWithPSACCheck=function(encid){PSACService.checkBothStaffAndChartPermission($scope.patientid,encid,'','',function(data){$("#previewDialogAppXSLManageOrders").modal({backdrop:'static',keyboard:false});var varUrl=makeURL('/mobiledoc/jsp/catalog/xml/printChartOptions.jsp?isHtml=true&style=ModernI'+'&encounterID='+encid+'&TrUserId='+global.TrUserId);$http({method:"GET",url:varUrl}).success(function(response,status,headers,config){var obj=document.getElementById('overviewPreviewApp');$('#OverviewPreviewContent').html("");$(obj).modal();$('#OverviewPreviewContent').html(response)})},function(){},"1")};$scope.encdateAddRx='';$scope.enctimeAddRx='';try{var encDetails=EncDetailsService.getEncDetailsByEncId($scope.encounterid);if(typeof encDetails!=='undefined'&&typeof encDetails.encDate!=='undefined'){if(encDetails&&encDetails.encDate){$scope.encdateAddRx=encDetails.encDate;$scope.enctimeAddRx=encDetails.encTime}}}catch(e){}$scope.ShowMessageForPastVisitItemKey=getItemKeyValue("ShowMessageForPastVisit");$scope.isMedOrderingForPastVist=function(values,type,obj){var bIsMedOrderingForPastVist=false;var encounterDateOfPN;var todayDate;try{encounterDateOfPN=new Date(validateAndConvertDate($scope.encdateAddRx));if(!angular.isUndefined($scope.enctimeAddRx)&&$scope.enctimeAddRx!==""){timeUnits=[];timeUnits=$scope.enctimeAddRx.split(":");encounterDateOfPN.setHours(timeUnits[0]);encounterDateOfPN.setMinutes(timeUnits[1]);encounterDateOfPN.setSeconds(timeUnits[2])}var todayDate=new Date;todayDate.setHours(0);todayDate.setMinutes(0);todayDate.setSeconds(0)}catch(e){encounterDateOfPN=new Date($scope.encdateAddRx);encounterDateOfPN=encounterDateOfPN.toUTCString();todayDate=new Date;todayDate=todayDate.toUTCString()}if($scope.ShowMessageForPastVisitItemKey.toLowerCase()==="yes"){if(todayDate>encounterDateOfPN){let warningMsg="<b>Warning  Adding Medications to Past Encounter</b></br></br>Medications added to past encounters may not reflect in the active medication list or the ICW (Right Chart Panel) and may need to be reconciled in subsequent encounters. Interaction checks will only consider medications from this encounter and Medications as of Today on the ICW. Would you like to proceed with ordering this medication?";showAlertMessage(warningMsg,'','ConfirmMsg','showMsgForPastVisitConfirm','overviewController');$scope.showMsgForPastVisitConfirm=function(btnAction){if(!angular.isUndefined(btnAction)&&btnAction!==null&&btnAction.toLowerCase()==='yes'){fnAjaxSaveSummaryData1RP(values,type,obj);bIsMedOrderingForPastVist=true}}}else{bIsMedOrderingForPastVist=true}}else{bIsMedOrderingForPastVist=true}return bIsMedOrderingForPastVist};$scope.popupForPRN=function(jsonObj){jsonObj=JSON.parse(jsonObj);var refill=jsonObj.RefillVal;var prnFound=false;if(refill.toUpperCase()==='PRN'){ecwAlert("This medication was previously prescribed with the designation of PRN (as needed) Refills.  Refills must be a numeric value for e-prescriptions.  Please select a Refill quantity as appropriate (default is 0).");prnFound=true}return prnFound};$scope.subHCCGapsList=function(encCode,obj,prItemCode,prItemName,PRdone,PRdetails,SRdone,SRdetails,primaryReview,primaryReviewer,secondaryReview,secondaryReviewer,index){if(!$.trim($('#gaplist'+obj+"_"+$scope.context+index).html()).length){$http({url:'/mobiledoc/jsp/webemr/rightpanel/problist_enc.jsp?ptId='+$scope.patientid+'&enccode='+(prItemCode==""?encCode:prItemCode),method:'post'}).success(function(data){let reviewHtml="";if(getItemKeyValue("Pophealth_HCC_worklist",false).toUpperCase()==="YES"){reviewHtml="<div class='bluefoot' style='margin-left: 6%;margin-right:6%'>";if(primaryReview){reviewHtml+="Primary Review: "+primaryReview+", ("+primaryReviewer+")"}else{reviewHtml+="Primary Review: Review pending"}if(secondaryReview){reviewHtml+="<br/>Secondary Review: "+secondaryReview+", ("+secondaryReviewer+")</span>"}else{reviewHtml+="<br/>Secondary Review: Review pending </span>"}}if(prItemCode!=""){reviewHtml="<span class='bluefoot' style='margin-left: 6%;margin-right:6%'>Primary Code: "+prItemCode+" ("+prItemName+")<span/>"+reviewHtml}$('#gaplist'+obj+"_"+$scope.context+index).html(reviewHtml);$('#gaplist'+obj+"_"+$scope.context+index).append(data)})}};$scope.isHCCEnabled=function(){$scope.isHCCEnabled=false;$scope.HCCDisabledReason="Visit Not Eligible";if(itemKeyValueJsonCache['Pophealth_HCC'].itemID!="1"||itemKeyValueJsonCache['Pophealth_HCC'].value==""){$scope.isHCCEnabled=false;$scope.HCCDisabledReason="Package Not Enabled"}if(!encObj||new Date(encObj.encDate)>=new Date(itemKeyValueJsonCache['Pophealth_HCC'].value)){$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"getRiskScores",patientId:$scope.patientid,encounterId:$scope.encounterid,encounterDate:!encObj?"":encObj.encDate})}).success(function(response){if(response.DISABLED=="yes"){$scope.isHCCEnabled=false;$scope.HCCDisabledReason="Patient Not Eligible"}else{var data=response;$scope.HCCRiskScores=data.HCCRiskScores;$scope.isHCCEnabled=true;$scope.disclaimerAccepted=data.disclaimerAccepted;$scope.disclaimerAcceptedOn=data.disclaimerAcceptedOn;$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"getREC_webemrRCP",patientId:$scope.patientid,encounterId:$scope.encounterid})}).success(function(response){let set=new Set,temp=[];for(let list of response){let id=Object.values(list.itemcode).join('');let source=Object.values(list.source).join('');if(!set.has(id+"-"+source)){set.add(id+"-"+source);temp.push(list)}else{const index=temp.findIndex(item=>item.itemcode===id&&item.source===source);if(index>-1&&!temp[index].RAF.includes(list.RAF)){temp[index].RAF=temp[index].RAF+","+list.RAF}}}$scope.getREC_webemrRCP_response=temp;$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"getREC_SuppressedRCP",patientId:$scope.patientid})}).success(function(response){var data=response;$scope.getREC_SuppressedRCP_response=data});$http({method:'POST',url:makeURL('/mobiledoc/jsp/webemr/analytics/hccDashboard/hccDashboardRequestHandler.jsp'),data:$.param({callingFor:'getHccConfig',configName:'hide_rcp_accept_reject'})}).success(function(response){$scope.showHccAcceptRejectGaps="Yes";if(undefined!=response.value){$scope.showHccAcceptRejectGaps=response.value}})})}});$.ajax({url:'/mobiledoc/jsp/webemr/analytics/hccDashboard/hccDashboardRequestHandler.jsp',type:'POST',data:{callingFor:'getHccConfig',configName:'Hide_secondary_gaps'},success:function(response){var result=JSON.parse(response);$scope.hideSecondaryGaps=result.value==='yes'?true:false}})}};$scope.hccGapsDisclaimerAccept=function(){$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"disclaimerAccepted",patientId:$scope.patientid,encounterId:$scope.encounterid})}).then(function(response){$scope.disclaimerAccepted='1';$scope.disclaimerAcceptedOn=(new Date).getFullYear()+'-'+((new Date).getMonth()+1)+'-'+(new Date).getDate()+' '+(new Date).getHours()+":"+(new Date).getMinutes()+":"+(new Date).getSeconds()})};$scope.rejectHCCGap=function(gapItem){bootbox.confirm("Are you sure you want to reject the HCC gap.",function(result){if(result){$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"rejectHccGap",patientId:$scope.patientid,itemName:gapItem.itemname,itemCode:gapItem.itemcode,codeSource:getSourceCode(gapItem.source)})}).success(function(){refreshDashboard($scope.encounterid,$scope.patientid)})}})};let getSourceCode=sourceIntial=>{let sourceName="";switch(sourceIntial){case'S':sourceName='Secondary';break;case'H':sourceName='Historical';break;case'E':sourceName='External';break;case'M':sourceName='Manual';break}return sourceName};$scope.calcHCCRisk=function(){$scope.HCCRiskScores.ERROR='';$scope.HCCRiskScores.disabled='disabled';$scope.HCCRiskScores.ERROR='Request Sent. Waiting For Response.';$http({method:'POST',url:makeURL('/mobiledoc/jsp/analytics/hccRequestHandler.jsp'),data:$.param({callingFor:"updateThisYrRiskScore",patientId:$scope.patientid,encounterId:$scope.encounterid,encounterDate:encObj.encDate,assessmentItemIDs:''})}).success(function(response){$scope.HCCRiskScores.disabled='';var data=response;if(data.ERROR==''){$scope.HCCRiskScores.thisYrUpdatedHCC=data.HCCRiskScores.thisYrUpdatedHCC;$scope.HCCRiskScores.ERROR='Score Update Successful'}else{$scope.HCCRiskScores.ERROR=data.ERROR}})};$scope.patientRxSummaryUrlRCP="";$scope.launchPatientRxSummary=function(){var jsName='/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/patientRxSummary.js';if($scope.patientRxSummaryUrlRCP!==""){$templateCache.remove($scope.patientRxSummaryUrlRCP)}$ocLazyLoad.load({name:'PatientMedicationSummaryModule',files:[jsName]}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/patientRxSummary.jsp?encounterId='+$scope.encounterid+'&patientId='+$scope.patientid+'&trUserId='+global.TrUserId+"&defaultTimeLine=yes");$scope.patientRxSummaryUrlRCP=url})};$scope.deleteRx=function(RxOrder,isRxOrderNo){var addParams='';if(isRxOrderNo){addParams="&isRxOrderNo=yes&rxOrderNo="+RxOrder}bootbox.confirm({buttons:{cancel:{label:'No',className:'btn btn-lblue btn-sm btn-xs pull-right  ml10'},confirm:{label:'Yes',className:'btn btn-lblue btn-sm btn-xs pull-right'}},message:"Are you sure you want to delete the medication?",title:'Delete Medication',callback:function(result){if(result===true){$.ajax({type:"POST",url:"/mobiledoc/jsp/catalog/xml/rx/deleteRx.jsp",data:"EncounterId="+$scope.encounterid+"&rxlist="+RxOrder.RxId+addParams+"&rnd2="+Math.random(),success:function(msg){if(msg.length>0){if($scope.context=='progressnotes'){refreshDashboard($scope.encounterid,$scope.patientid,"rightPanelMedSummary")}else if($scope.context=='telenc'){if($("#virtualvisittab").hasClass("active")){$scope.checkEncounterB4getVirtualVisit()}else if($("#rxtab").hasClass("active")){$scope.$parent.getRx()}}}else{alert("Sorry, couldn't delete ")}},error:function(xhr){alert("Sorry, couldn't delete ")}})}}})};$scope.notificationRxRCP={timeoutObj:null,time:5e3,show:function(type,body,timeout,rxOrderNo){var toasterId=(new Date).getUTCMilliseconds();$('<div class="notification-alert-box notification-theme-'+type+' notification-animate-fadeup" id="confirm-toaster'+toasterId+'">'+'    <div class="notification-toast-wrap no-pad-left no-pad-right">'+'        <div class="notification-dflex notification-aligncenter mr10">'+'            <i class="icon notification-icon-confirmed pull-left" />'+'            <div class="pull-left">'+'                <p class="fnt13 bold ml10 mr10 pull-left" style="max-width: 450px !important;" title="'+body+'">'+body+'                </p>'+'            </div>'+'            <div >'+'                <p class="bold ml10">'+'                                   <button type="button" class="btn btn-xs" style="font-weight:bold;border :2px solid white;color:green;box-shadow:1px 1px grey;" onclick="deleteRxForRCP(\''+rxOrderNo+'\')">Undo</button>'+'                </p>'+'            </div>'+'        </div>'+'        <i class="icon notification-iconclose mt3" />'+'    </div>'+'</div><div class="notification-toast-wrapper notification-toast-bottom-right"/>').appendTo('body');var clone=$('#confirm-toaster'+toasterId).clone().appendTo('.notification-toast-wrapper');setTimeout(function(){clone.addClass('active')},0);setTimeout(function(){clone.fadeOut().remove()},timeout);clone.find('.notification-iconclose').on('click',function(){clone.remove()})}};$scope.rxDefaultSearchText='';$scope.rxDefaultSearchItemId='';let stopRefillRxValues='';let stopRefillRxObj={};let hStopRefillActionType='';$scope.refillForDiscontinuedRx=function(values,obj,dnid,type){$scope.rxDefaultSearchText=obj.getAttribute('itemname');$scope.rxDefaultSearchItemId=obj.getAttribute('itemid');stopRefillRxValues=values;stopRefillRxObj=obj;hStopRefillActionType=type;var genericEquivalentNamesOnly=[];var url='/mobiledoc/jsp/ecwrx/getGenericdrugs.jsp?dnid='+dnid;var promise=$http.post(makeURL(url));promise.success(function(data){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLengthForAddRx(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('AlternateDrugs')){var genericEquivalent=[];if(jsonobj.Envelope.Body['return'].AlternateDrugs.length>0){genericEquivalent=jsonobj.Envelope.Body['return'].AlternateDrugs}else{genericEquivalent.push(jsonobj.Envelope.Body['return'].AlternateDrugs)}for(var index=0;index<genericEquivalent.length;index++){genericEquivalentNamesOnly.push(genericEquivalent[index].drugName)}}}let warningMsg="<b>Medication Summary - Refill Medication</b></br></br>"+obj.getAttribute('itemname')+" is obsolete and may fail ePrescription. Would you like to proceed with Refilling this medication or would you like to STOP this medication and Replace with ";if(genericEquivalentNamesOnly.length>0){warningMsg+="the Generic Equivalent of "+genericEquivalentNamesOnly.join(" or ")+"?"}else{warningMsg+="an alternative?"}showAlertMessage(warningMsg,'','CustomConfirmMsg','stopAndReplaceRx','overviewController','650px','Refill','Close','','','Stop and Replace')})};$scope.stopAndReplaceRx=function(btnAction){if(btnAction==='Stop and Replace'){fnAjaxSaveSummaryData1RP(stopRefillRxValues,10,stopRefillRxObj,true)}else if(btnAction==='Refill'){fnAjaxSaveSummaryData1RP(stopRefillRxValues,hStopRefillActionType,stopRefillRxObj,false,true)}else{$scope.rxDefaultSearchText='';$scope.rxDefaultSearchItemId=''}};$scope.redirectoToAddRx=function(){$scope.openManageOrderPopup('AddNewRx')};$scope.getLexicalIdFromItemCode=function(itemid,itemcode){if($scope.passSynonymId){for(var i=0;i<$scope.problemlist.length;i++){if($scope.problemlist[i].itemcode===itemcode&&$scope.problemlist[i].itemid===itemid){if($scope.problemlist[i].synonymid===undefined||$scope.problemlist[i].synonymid===""){return"0"}else{return $scope.problemlist[i].synonymid}}}}$scope.passSynonymId=true;return"0"};var appendArrayDx=function(jsonDataFrom,jsonDataTo){var len=jsonDataTo.length;for(var iCnt=0;iCnt<len;++iCnt){jsonDataFrom.push(jsonDataTo[iCnt])}return jsonDataFrom};$scope.openLexicalPopup=function(divId,problem){if($scope.bImoLexicalDisplay&&problem.synonymid!==undefined&&problem.synonymid!==null&&problem.synonymid!=="0"){$scope.lexicalDetails=[];$.ajax({type:"GET",url:"/mobiledoc/jsp/catalog/xml/getAssessment.jsp?Id="+$scope.encounterid,data:"","async":false,success:function(response){var jsonobj=x2js.xml_str2json($.trim(response));$scope.primaryAssessmentList=returnDataArray(jsonobj.Envelope.Body["return"].assessment.primary.code);$scope.assessmentList=appendArrayDx(returnDataArray(jsonobj.Envelope.Body["return"].assessment.primary.code),returnDataArray(jsonobj.Envelope.Body["return"].assessment.secondary.code))},error:function(jqXHR,status,err){}});for(var i=0;i<$scope.problemlist.length;i++){if($scope.problemlist[i].synonymid===problem.synonymid){$scope.lexicalDetails.push($scope.problemlist[i])}}for(var i=0;i<$scope.assessmentList.length;i++){for(var j=0;j<$scope.lexicalDetails.length;j++){if($scope.assessmentList[i].id===$scope.lexicalDetails[j].itemid&&$scope.assessmentList[i].name===$scope.lexicalDetails[j].itemname){$scope.passSynonymId=false}}}if($scope.lexicalDetails.length>1&&$scope.passSynonymId){$ocLazyLoad.load({cache:false,serie:true,absolute:true,name:'plLexicalModuleApp',files:['/mobiledoc/jsp/webemr/rightpanel/js/lexicalPopupCtrl.js','/mobiledoc/jsp/webemr/rightpanel/css/lexical/lexical-popup.css']}).then(function(){$scope.icdDetails=[];$scope.icdDetails.itemid=problem.itemid;$scope.icdDetails.itemname=problem.itemname;$scope.icdDetails.clinicalDiagnosis=problem.clinicalDiagnosis;$scope.icdDetails.callFrom="rightCPanel";$scope.icdDetails.lexical=$scope.lexicalDetails;var modalInstance=$modal.open({templateUrl:makeURL("/mobiledoc/jsp/webemr/rightpanel/lexicalPopup.html"),controller:'lexicalPopupCtrl',windowClass:"lexicalDocumentModal",backdrop:"static",animation:'true',resolve:{icdDetails:function(){return $scope.icdDetails}}});modalInstance.result.then(function(modalInstanceResponse){if(modalInstanceResponse){if(modalInstanceResponse.isSelectAll){for(var i=0;i<$scope.lexicalDetails.length;i++){$scope.AddtoProgressNotes('div_problemlist',$scope.lexicalDetails[i].itemid,$scope.lexicalDetails[i].onsetdate,$scope.lexicalDetails[i].convFlag,$scope.lexicalDetails[i].snowMedCode,$scope.lexicalDetails[i].itemcode)}}else{$scope.passSynonymId=false;$scope.AddtoProgressNotes('div_problemlist',problem.itemid,problem.onsetdate,problem.convFlag,problem.snowMedCode,problem.itemcode)}}},function(e){})},function(e){ecwAlert("Error occurred while loading lexical popup. Error : "+e)})}else{$scope.AddtoProgressNotes('div_problemlist',problem.itemid,problem.onsetdate,problem.convFlag,problem.snowMedCode,problem.itemcode)}}else{$scope.AddtoProgressNotes('div_problemlist',problem.itemid,problem.onsetdate,problem.convFlag,problem.snowMedCode,problem.itemcode)}};$scope.openManageOrderPopup=function(actionName){var manageOrderDataObj={encounterId:$scope.encounterid,patientId:$scope.patientid,trUserId:global.TrUserId,labType:0,parentName:actionName,requestedFrom:'Stop&ReplaceRx',context:"PNHeader",nDxId:0,rxDefaultSearchText:$scope.rxDefaultSearchText,rxDefaultSearchItemId:$scope.rxDefaultSearchItemId};$ocLazyLoad.load({name:'manageOrdersModule',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/manageOrders.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL("/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/manageOrders.jsp"),controller:'manageOrdersCtrl',windowClass:'app-modal-window bluetheme',keyboard:false,backdrop:"static",resolve:{manageOrderDataObject:function(){return manageOrderDataObj}}});modalInstance.result.then(function(responseObj){},function(responseObj){if($scope.context=='progressnotes'){refreshDashboard($scope.encounterid,$scope.patientid,"rightPanelMedSummary")}else if($scope.context=='telenc'){if($("#virtualvisittab").hasClass("active")){$scope.checkEncounterB4getVirtualVisit()}else if($("#rxtab").hasClass("active")){$scope.$parent.getRx()}}})})};function getKeyLengthForAddRx(object){var count=0;for(var property in object){if(object.hasOwnProperty(property)){count++;break}}return count}$scope.unescapeHtml=function(value){return decodeHtml(value)};$scope.validateIcdAndOrderRxOC=function(values,type,obj){var valuesJson=JSON.parse(values);if(valuesJson.assessId===undefined||valuesJson.assessId===0||valuesJson.assessId==='0'){fnAjaxSaveSummaryData1RP(values,type,obj);return}var promise=fetchAssessmentStatusOC([valuesJson.assessId]);promise.success(function(response){if(response!==undefined&&response.length!==0){let rxName=obj.getAttribute('itemvalue');let warningMsg="<b>Medication Summary - Inactive/Expired Assessment</b></br></br>The assessment linked to "+rxName+" is inactive or expired and can not be carried forward.</br>Would you like to continue/refill the medication under N/A - Other instead?";showAlertMessage(warningMsg,'','CustomConfirmMsg','addRxOnValidateIcdYes','overviewController','500px','Yes','No','');$scope.addRxOnValidateIcdYes=function(btnAction){if(!angular.isUndefined(btnAction)&&btnAction!==null&&btnAction.toLowerCase()==='yes'){valuesJson.assessId=-1;fnAjaxSaveSummaryData1RP(JSON.stringify(valuesJson),type,obj)}};return}fnAjaxSaveSummaryData1RP(values,type,obj)})};function fetchAssessmentStatusOC(assessmentid){return $.ajax({type:"POST",contentType:'application/json',url:'/mobiledoc/emr/medication/icd/validateIcd',data:JSON.stringify(assessmentid)})}let currMedsVerifiedCallbackBtn1="Bring forward patient's active medication list to Current Medication with the Previous Status";let currMedsVerifiedCallbackBtn2="Bring forward patient's active medication list to Current Medication with the Unknown Status";let currMedsVerifiedCallbackArgObj={};let setCurrMedsVerifiedCallbackArg=function(values,type,obj,isRedirectToAddRx,forceRefill){currMedsVerifiedCallbackArgObj={};currMedsVerifiedCallbackArgObj.values=values;currMedsVerifiedCallbackArgObj.type=type;currMedsVerifiedCallbackArgObj.obj=obj;currMedsVerifiedCallbackArgObj.isRedirectToAddRx=isRedirectToAddRx;currMedsVerifiedCallbackArgObj.forceRefill=forceRefill};let isCurrMedsVerified=function(){return rxService.isValidOffVisitForCurrentMeds($scope.encounterid,$scope.patientid)};$scope.checkIfCurrMedsVerified=function(values,type,obj,isRedirectToAddRx,forceRefill){let validationChecklist={isCheckIfCurrMedsVerifiedPerformed:true};if(isCurrMedsVerified()){let warningMsg="<b>Reconcile Current Medications</b></br></br>";warningMsg+="Records indicate that this patient may have been on some medication(s) which are not verified as of this encounter. One of the following actions is required to proceed further so that the patient's medication history is accurate.";let bottomNote="*To ensure that the current medication list is accurate and complete, go to Current Medications and perform medication reconciliation.";setCurrMedsVerifiedCallbackArg(values,type,obj,isRedirectToAddRx,forceRefill);$timeout(function(){showAlertMessage(warningMsg,'','CustomConfirmMsg','currMedsVerifiedCallback','overviewController','650px',currMedsVerifiedCallbackBtn1,currMedsVerifiedCallbackBtn2,'reconcileMedCurrRxAlert',bottomNote)})}else{fnAjaxSaveSummaryData1RP(values,type,obj,isRedirectToAddRx,forceRefill,validationChecklist);currMedsVerifiedCallbackArgObj={}}};$scope.currMedsVerifiedCallback=function(btnAction){let saveAsUnknown="";if(btnAction===currMedsVerifiedCallbackBtn2){saveAsUnknown="&saveAsUnknown=yes"}let url='/mobiledoc/jsp/catalog/xml/rx/copyCurrRx.jsp?ptid='+$scope.patientid;url+='&encid='+$scope.encounterid+'&encdate='+$scope.encdateAddRx+'&enctime='+$scope.enctimeAddRx+'&PopulateMeds=False'+saveAsUnknown;$.ajax({type:"POST",url:makeURL(url),data:"","async":false,success:function(msg){if(msg.indexOf('success')>-1){let validationChecklist={isCheckIfCurrMedsVerifiedPerformed:true};fnAjaxSaveSummaryData1RP(currMedsVerifiedCallbackArgObj.values,currMedsVerifiedCallbackArgObj.type,currMedsVerifiedCallbackArgObj.obj,currMedsVerifiedCallbackArgObj.isRedirectToAddRx,currMedsVerifiedCallbackArgObj.forceRefill,validationChecklist)}else{ecwAlert("An error occured in Reconciling Current Medications")}},error:function(xhr){ecwAlert("An error occured in Reconciling Current Medications: "+xhr.status+" "+xhr.statusText)}})};$scope.isFirstTreatmentRx=function(){return rxService.isFirstTreatmentRx($scope.encounterid)};$scope.hccWorkListUrl="";$scope.isWorklistEnable=getItemKeyValue("Pophealth_HCC_worklist",false).toUpperCase()==="YES";$scope.mouseOverOnPatientName=false;$scope.openWorkList=function(){let pid=$scope.patientid;let pname=$scope.$parent.patientName;if($scope.isWorklistEnable){$ocLazyLoad.load({name:'hccWorklistApp',files:['/mobiledoc/jsp/webemr/spellcheck/lookup/js/spell.check.js','/mobiledoc/jsp/webemr/analytics/hccworklist/app/service/analyticsConcurrencyService.js','/mobiledoc/jsp/webemr/analytics/hccworklist/app/service/hccWorklistService.js','/mobiledoc/jsp/webemr/analytics/hccworklist/assets/css/hcc-worklist.css','/mobiledoc/jsp/resources/jslib/perfect-scrollbar/css/perfect-scrollbar.css','/mobiledoc/jsp/resources/jslib/perfect-scrollbar/dist/perfect-scrollbar.min.js','/mobiledoc/jsp/resources/jslib/angular-perfect-scrollbar/src/angular-perfect-scrollbar.js','/mobiledoc/jsp/webemr/analytics/hccworklist/app/hccWorklistController.js']}).then(function(){var params={patientId:pid,nm:pname};$scope.hccWorkListUrl=makeURL('/mobiledoc/jsp/webemr/analytics/hccworklist/hccWorkListMain.jsp?'+$.param(params))})}};function showPLSnomed(){let $plSnomed=$("#problemListSnomed_"+$scope.$parent.rcpUniqueId);let $snomedDummyElem=$("#SNOMEDTab"+$scope.$parent.rcpUniqueId);if($snomedDummyElem.css("display")==="none"){$plSnomed.html("")}else{let snomedHtml=$snomedDummyElem.parent().html();$plSnomed.html($compile(snomedHtml)($scope))}if($plSnomed.html()===""){$plSnomed.css("width","0%")}else{$plSnomed.css("width","23%")}}});function closePreviewDialog(){$("#overviewPreviewApp").modal('hide')}function showEnc(encid){var overViewScope=$('[ng-controller="overviewController"]').scope();overViewScope.loadPreviewDialogueWithPSACCheck(encid)}function loadOverviewPreviewDialog(encid){$.ajax({type:"POST",url:makeURL('/mobiledoc/jsp/catalog/xml/getPatientIdfromEncounterId.jsp?EncounterId='+encid),success:function(response){var patientid=$.trim($(response).find("uid").text());$.ajax({type:"POST",url:makeURL('/mobiledoc/jsp/uadmin/getStaffCategoryPermission.jsp?PatientId='+patientid+'&StaffId='+global.TrUserId),dataType:"xml",success:function(response){if($.trim($(response).find("status").text())==='success'){$.ajax({type:"POST",url:makeURL('/mobiledoc/jsp/catalog/xml/edi/checkChartPermissions.jsp?EncounterId='+encid+'&StaffId='+global.TrUserId),dataType:"xml",success:function(response){if($.trim($(response).find("status").text())==='success'){var varUrl='/mobiledoc/jsp/catalog/xml/printChartOptions.jsp?isHtml=true&encounterID='+encid;varUrl=makeURL(varUrl);$.ajax({type:"POST",url:varUrl,success:function(response){var obj=document.getElementById('overviewPreviewApp');$('#OverviewPreviewContent').html("");$(obj).modal();$('#OverviewPreviewContent').html(response)}})}}})}}})}})}function imgTypeClick(obj,type){if(getItemKeyValue("EnableEmarFeatures").toLowerCase()=="yes"){if(typeof correctionalCheckFlag_overviewController=="undefined"||correctionalCheckFlag_overviewController==false){activeEmarCheckFlag_overviewController(obj,type,imgTypeClick);return}correctionalCheckFlag_overviewController=false}if(obj.getAttribute('value')==""){return}var objid=obj.getAttribute('itemid');var objrxoderno=obj.getAttribute('rxOrderNo');var ids="";var rxordernos="";var rxOderNosItemKey="";var objidname=obj.getAttribute('itemname');var strType="";fnAjaxSaveSummaryDataRP(obj.getAttribute('value'),type,obj)}function fnAjaxSaveSummaryDataRP(values,type,obj){var $scope=angular.element(obj).scope();if(type===10||type===20||$scope.isMedOrderingForPastVist(values,type,obj)){if($scope.isCorrectionalFeaturesOn){var cancelRxMsg="You have choosen to stop the medication. Once you click Yes, you will have to send Stop Order to pharmacy. Are you sure you want to continue?";BootstrapDialog.show({title:"Stop Rx Confirmation",message:cancelRxMsg,closable:true,draggable:false,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:'Yes',action:function(dialog){dialog.close();$scope.validateIcdAndOrderRxOC(values,type,obj)}},{label:'No',action:function(dialog){dialog.close()}}]})}else{$scope.validateIcdAndOrderRxOC(values,type,obj)}}}var isRxSelected=false;function fnAjaxSaveSummaryData1RP(values,type,obj,isRedirectToAddRx,forceRefill,validationChecklist){var $scope=angular.element(obj).scope();if(type!==10&&(!validationChecklist||validationChecklist.isCheckIfCurrMedsVerifiedPerformed===false)&&$scope.isFirstTreatmentRx()){$scope.checkIfCurrMedsVerified(values,type,obj,isRedirectToAddRx,forceRefill);return}var callType="";if($scope.encounterid>0){if(isRxSelected){return}isRxSelected=true;var params="&encid="+$scope.encounterid;params+="&hAssessId=0";params+="&hRefillVal=0";params+="&hUserIdVal="+$scope.trUserId;params+="&hViewType="+$scope.context;if(Array.isArray(values)){for(var i=0;i<values.length-1;i++){params+="&hData="+escape(encodeURIComponent(values[i]))}callType=values[values.length-1]}else{params+="&hData="+escape(encodeURIComponent(values))}params+="&hasDelimiter=nodelimiter";if(forceRefill===true){params+="&forceRefill=yes"}params+='&patientId='+$scope.patientid;$.ajax({type:"POST",url:"/mobiledoc/jsp/ecwrx/medManagement/saveMedSummaryData.jsp",data:"hNA="+type+params,success:function(msg){isRxSelected=false;var bDuplicateFlag=false;if(callType!='fnAllClick'){if(msg.indexOf("exist")>-1){BootstrapDialog.show({title:"eClinicalWorks",message:"The medication you selected already exists in the current encounter. ",buttons:[{label:'OK',cssClass:'btn-lgrey btn-xs okButtonFromDialog',action:function(dialog){dialog.close()}}]});bDuplicateFlag=true}else if(/^\s*(failed:NDCMismatch)/.test(msg)){let itemName=$(obj).attr("itemname");let msg="The medication(s) cannot be saved because the NDC for "+itemName+" is not correct.<br>You can either (1) click in the column under the triangle icon on the Treatment screen to update the NDC or (2) stop the medication and create a new order.";showAlertMessage(msg,'','ErrorMsg','','','600px')}else if(/^\s*(stoppedInFuture:)/.test(msg)){let msg="<b>Medication Summary - Cannot Refill or Continue</b></br></br>";msg+="This medication cannot be Refilled or Continued because the medication is stopped and is no longer on the patients current medication list. The medication must be ordered as a new prescription.";showAlertMessage(msg,'','CustomErrorMsg','','','600px','','','warning-stoppedinfuture')}else{if(isRedirectToAddRx){$scope.redirectoToAddRx()}if(type===11){try{if(Array.isArray(values)){var prnFound=false;for(i=0;i<values.length&&!prnFound;i++){prnFound=$scope.popupForPRN(values[i])}}else{$scope.popupForPRN(values)}}catch(ex){}}}if(msg.indexOf("exist")==-1&&(type==10||type==20)&&getItemKeyValue("EnableEmarFeatures").toLowerCase()=="yes"&&obj.getAttribute('TotoalCount')>0){stopActiveEmarMedications_overviewController(obj,type)}if(type===2&&/^\s*(success:discontinued)/.test(msg)){let rxOrderNo=obj.getAttribute('rxOrderNo');var itemName=obj.getAttribute('itemname');var toastMessage=itemName+" has been updated to Continue. Note: This medication cannot be ePrescribed due to removal from the market by the manufacturer.";$scope.notificationRxRCP.show('success',toastMessage,4e3,rxOrderNo)}else if(/^\s*(discontinued)/.test(msg)&&(type==11||type==31||type==91)){let dnid=trimContentRCPOverview(msg).substring(13);if(dnid.indexOf("^^")>-1){dnid=dnid.substring(0,dnid.trim().indexOf("^^"))}$scope.refillForDiscontinuedRx(values,obj,dnid,type)}}if(type==10&&!bDuplicateFlag){var rxFullName=obj.getAttribute('itemname');if(obj.getAttribute('itemvalue')){rxFullName=obj.getAttribute('itemvalue')}setTimeout(function(){if($scope.isCorrectionalFeaturesOn){$scope.openCancelRx(obj.getAttribute('rxOrderNo'),obj.getAttribute('itemname'));$scope.closeCancelRxFromRightChartPanel()}else{$scope.loadCancelRx(obj.getAttribute('rxOrderNo'),obj.getAttribute('itemname'),rxFullName)}},2500)}else{if($scope.context=='progressnotes'){$scope.AddtoProgressNotes('div_medSummary','','','')}else if($scope.context=='telenc'){if($("#virtualvisittab").hasClass("active")){$scope.checkEncounterB4getVirtualVisit()}else if($("#rxtab").hasClass("active")){$scope.$parent.getRx()}}}},error:function(xhr){isRxSelected=false}})}else{if($scope.context=="telenc"){$scope.checkEncounterB4getRxfromMedCRSRP(values,type,obj)}else{alert("Please save the encounter before adding medication from the right panel.")}}}let trimContentRCPOverview=function(text){if(typeof text==='undefined'){return""}if(null===text){return""}if(text==="____"){return""}return String.prototype.trim.call(text)};function fnActionAllClick(obj,type){var $scope=angular.element(obj).scope();var values=[];for(var i=0;i<$scope.MedSummarys[0].array.length;i++){var data=$scope.MedSummarys[0].array[i].crsimages;var str=data.substring(data.indexOf('value='),data.indexOf('itemid='));var result=str.substring(str.indexOf("'")+1,str.lastIndexOf("'"));values.push(result)}values.push('fnAllClick');if(type===10||type===20||$scope.isMedOrderingForPastVist(values,type,obj)){fnAjaxSaveSummaryData1RP(values,type,obj)}$('#addMedOnMedSummaryRP').removeClass('open')}function deleteRxForRCP(rxOrderNo){var scope=angular.element("#overview_rpSel2").scope();scope.deleteRx(rxOrderNo,true)}function saveSWS(){try{var x=document.getElementById('SWSDataFrm');var y=x.contentWindow||x.contentDocument;y.document.getElementById("frmSWSLite").contentWindow.document.getElementById("btnSave").click()}catch(e){}}function stopActiveEmarMedications_overviewController(obj,type){$.ajax({method:'POST',url:"/mobiledoc/jsp/Corrections/emar/MarkAllAdminFailedForDrug.jsp",headers:{'Content-Type':'application/x-www-form-urlencoded'},transformRequest:function(obj){var str=[];for(var p in obj)str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")},data:{EMARMedId:obj.getAttribute('EMARMedId'),TrUserId:global.TrUserId,Reason:'Medication Stopped',MedStopped:1}}).then(function successCallback(response){},function errorCallback(response){})}function activeEmarCheckFlag_overviewController(obj,type,callbackfoo){var itemname=obj.getAttribute('itemvalue');var totoalCount=obj.getAttribute('TotoalCount');if(obj.getAttribute('TotoalCount')>0){var msg='<div class="alert alert-danger"><strong>Warning!</strong> Medication already scheduled</div>'+'There are '+totoalCount+' active administration for '+itemname+'. If you stop '+itemname+' then these administrations will be marked as "Not Given" with reason "Medication Stopped". '+'Are you sure you want to stop the medication and mark these administration as "Not Given"?';var title="eClinicalWorks";ecwConfirm(msg,title,function yesCallBack(){correctionalCheckFlag_overviewController=true;callbackfoo(obj,type)},function noCallBack(){},"",false);return}else{correctionalCheckFlag_overviewController=true;callbackfoo(obj,type)}}
(function(){let recommendedDosingApp=angular.module('ecw.recommendedDosing',[]);recommendedDosingApp.service('recommendedDosingService',['$http',recommendedDosingService]);recommendedDosingApp.component('recommendedDosingComponent',{bindings:{refreshId:'<',requestParam:'=',topClass:'=',context:'=',contextClass:'=',showHideLevel2:'&',updateStyle:'&',selectCallBack:'&',epaSelectCallBack:'&',successCallback:'&',favRefreshCallback:'&'},controller:['$http','recommendedDosingService','$ocLazyLoad','$modal','$timeout',recommendedDosingController],controllerAs:'vm',templateUrl:"/mobiledoc/jsp/webemr/progressnotes/ecwrx/patientCentricDosing/recommendedDosing/html/recommendedDosing-tpl.html",transclude:true});function recommendedDosingController($http,recommendedDosingService,$ocLazyLoad,$modal,$timeout){let vm=this;vm.errorMessage="";vm.isNoDosingEnabled=false;vm.isNoRecommendedEnabled=false;vm.contextClass="PNQuickSearch-DoseList";vm.patientProfile={};vm.dosageResultSet=[];vm.doseNameDetail=[];vm.doseName="";vm.drugNameItem={};function trimInt(val){var retValue=0;try{retValue=angular.isUndefined(val)||val===null||val===''||val==='null'?0:parseInt(val,10)}catch(e){retValue=0}return retValue}function trimStr(val){return angular.isUndefined(val)||val===null||val===''||val==='null'||val==='undefined'?'':val.trim()}vm.MedispanId=getItemKeyValue("MedispanRx",true);vm.CustomRxId=getItemKeyValue("CustomRx",true);vm.b_enabledFormulary=getItemKeyValue("isFormularyEnabled").toLowerCase()==="yes";vm.isEpaServiceEnabled=getItemKeyValue("EnableePAService").toLowerCase()==="yes";vm.formularyInfo={};vm.$onChanges=function(changes){if(changes.refreshId.currentValue>0){vm.loadDoses()}$timeout(function(){if(vm.updateStyle){vm.updateStyle()}})};vm.editDose=function(doseSel,flag){doseSel.editEnabled=flag};vm.drugProducts=[];vm.isWeightBased=false;vm.loadDoses=function(){vm.dosageResultSet=[];vm.doseNameDetail=[];vm.drugProducts=[];vm.genericProduct={};vm.doseName="";vm.isWeightBased=false;vm.isNoDosingEnabled=false;vm.isNoRecommendedEnabled=false;vm.requestParam.scheduleType="";vm.drugNameItem={};if(trimInt(vm.requestParam.parentId)!==trimInt(vm.MedispanId)&&trimInt(vm.requestParam.parentId)!==trimInt(vm.CustomRxId)){return}vm.isTemplateOrOrderSet=false;if(trimInt(getItemKeyValue("TemplatePatientId",true))===trimInt(vm.requestParam.patientId)||vm.context==='frmOSAdmin'){vm.isTemplateOrOrderSet=true}vm.requestParam.routedDrugId=vm.requestParam.routedDrugId===''?0:vm.requestParam.routedDrugId;vm.requestParam.dispensableDrugId=vm.requestParam.dispensableDrugId===''?0:vm.requestParam.dispensableDrugId;let requestData={rxId:vm.requestParam.itemId,rxType:vm.requestParam.rxType,obsoleteFilter:vm.requestParam.showObsoleteDrugs,noPackFilter:vm.requestParam.showNoPackDrugs,drugNameId:vm.requestParam.drugNameId,routedDrugId:vm.requestParam.routedDrugId,dispensableDrugId:vm.requestParam.dispensableDrugId,encounterId:vm.requestParam.encounterId,patientId:vm.requestParam.patientId,rxDrugSearchType:vm.requestParam.rxDrugSearchType,ndcCode:vm.requestParam.NDCCode,roundOption:vm.requestParam.roundOption};$("."+vm.contextClass+" .recommended-dosing-loader-div").css("display","block");vm.errorMessages=[];if(vm.isTemplateOrOrderSet||vm.context==='ImmTherapeuticInjections'||vm.context==='anesthesia'||vm.context==='frmOSAdmin'){vm.showLoadingImage();let promise=$http({method:'POST',url:'/mobiledoc/cpoe/drugDosage/allDosages',data:requestData,headers:{}});promise.then(function(data){vm.drugProducts=data.data.drugProducts;vm.requestParam.scheduleType=data.data.scheduleType;vm.genericProduct=data.data.genericDrugProduct;vm.dosageResultSet=data.data.drugProducts;vm.drugNameItem=data.data.drugNameItem;for(var i=0;i<vm.dosageResultSet.length;i++){if(!vm.isTemplateOrOrderSet){recommendedDosingService.setDefaultTakeItem(vm.dosageResultSet[i])}else{vm.dosageResultSet[i].drugOrder.takes=[]}vm.dosageResultSet[i].refill=0;if(vm.dosageResultSet[i].drugOrder&&vm.dosageResultSet[i].drugOrder.doseRoute&&vm.dosageResultSet[i].drugOrder.doseRoute.length>0){vm.dosageResultSet[i].doseRoute=vm.dosageResultSet[i].drugOrder.doseRoute[0]}}vm.hideLoadingImage();initRecommendedDosingHorizontalScrollArrows();if(!vm.drugProducts||vm.drugProducts.length===0){vm.isNoDosingEnabled=true}vm.successCallback({arg0:vm.isNoDosingEnabled,arg1:vm.drugNameItem});vm.isNoRecommendedEnabled=true})}else{vm.showLoadingImage();let promise=$http({method:'POST',url:'/mobiledoc/cpoe/drugDosage/recommendedDosages',data:requestData,headers:{}});promise.then(function(data){$("."+vm.contextClass+" .recommended-dosing-loader-div").css("display","none");vm.isWeightBased=data.data.weightBased;vm.requestParam.scheduleType=data.data.scheduleType;vm.drugNameItem=data.data.drugNameItem;if(data.data.messages&&data.data.messages.length>0){vm.errorMessages=data.data.messages;vm.hideLoadingImage();vm.successCallback({arg0:true,arg1:vm.drugNameItem});return}vm.patientProfile=data.data.patientProfile;vm.drugProducts=data.data.drugProducts;vm.genericProduct=data.data.genericDrugProduct;if(data.data.weightBased){vm.doseNameDetail=data.data.recommendedDosages}else{vm.dosageResultSet=data.data.drugProducts;for(var i=0;i<vm.dosageResultSet.length;i++){recommendedDosingService.setDefaultTakeItem(vm.dosageResultSet[i]);vm.dosageResultSet[i].refill=0;if(vm.dosageResultSet[i].drugOrder&&vm.dosageResultSet[i].drugOrder.doseRoute&&vm.dosageResultSet[i].drugOrder.doseRoute.length>0){vm.dosageResultSet[i].doseRoute=vm.dosageResultSet[i].drugOrder.doseRoute[0]}}}if(vm.requestParam.isformularyDoses&&vm.drugNameItem&&vm.drugNameItem.drugNameId>0){vm.formularyInfo={CoverageId:vm.requestParam.coverageId,FormularyID:vm.requestParam.formularyID,FormularySourceCode:vm.requestParam.formularySourceCode,CopayId:vm.requestParam.CopayId,AlternativeId:vm.requestParam.AlternativeId};vm.loadFormularyRxDoses()}vm.hideLoadingImage();initRecommendedDosingHorizontalScrollArrows();if(!vm.drugProducts||vm.drugProducts.length===0){vm.isNoDosingEnabled=true}vm.successCallback({arg0:vm.isNoDosingEnabled,arg1:vm.drugNameItem});vm.isNoRecommendedEnabled=true})}};vm.launchFormulary=function(index){var rxObj=vm.dosageResultSet[index];var sSynonymId=vm.drugNameItem.drugNameId;$ocLazyLoad.load({name:'launchFormulary',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/formularyInfo/launchFormulary.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/formularyInfo/launchFormulary.jsp'),controller:'launchFormularyController',backdrop:"static",resolve:{patientID:function(){return vm.requestParam.patientId},encounterID:function(){return vm.requestParam.encounterId},RxEditObject:function(){return rxObj},loginuserid:function(){return global.TrUserId},parentName:function(){return"AddRxTreatment"},formularyInfo:function(){return vm.formularyInfo},SynonymId:function(){return sSynonymId}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){if(modalInstanceResponse!=null){vm.LoadAlternativeDrug(modalInstanceResponse)}})})};vm.LoadAlternativeDrug=function(item){var obj=getItemIdFromNDCCode(item.NDC_Code,true,false,true);if(obj.itemId>0){vm.qosResultObj={};vm.qosResultObj.resultSet={};vm.qosResultObj.resultSet.sItemName=obj.itemName;vm.qosResultObj.resultSet.nItemId=obj.itemId;vm.qosResultObj.resultSet.sDrugNameId=item.Synonym_id;vm.qosResultObj.resultSet.sSupplierId=item.Synonym_id;vm.qosResultObj.resultSet.sKeyname=vm.requestParam.sKeyname;vm.qosResultObj.resultSet.nParentID=vm.requestParam.parentId;vm.qosResultObj.resultSet.NDCCode=item.NDC_Code;vm.qosResultObj.resultSet.loadAlternativeDrug=true;vm.qosResultObj.resultSet.isCompound='false';let scope=getAddRxControllerScope('[ng-controller=AddRxCtrl_1]');scope.rowClicked(vm.qosResultObj.resultSet);$('#AddRxSearch').val(obj.itemName);setFocusOnSearchBoxForAddRx()}else{ecwAlert("Not able to properly map selected drug. Please try selecting this drug manually from drug lookup screen. ")}};function getAddRxControllerScope(selecter){let appElement=document.querySelector(selecter);if(appElement){return angular.element(appElement).scope()}else{return undefined}}function setFocusOnSearchBoxForAddRx(){var id='AddRxSearch';setTimeout(function(){document.getElementById(id).focus()},1);jQuery('#'+id).trigger("focus");document.getElementById(id).focus();var sValue=jQuery('#'+id).val();if(sValue&&sValue.length>0){$('#'+id).trigger("select")}}vm.openEPAInitializePopup=function(index){vm.callFromePA=true;let doseObj=vm.dosageResultSet[index];vm.epaSelectCallBack({arg0:convertToResponseObj(doseObj)})};vm.loadGenericDoses=function(){if(trimInt(vm.genericProduct.routedDrugId)>0){vm.requestParam.routedDrugId=vm.genericProduct.routedDrugId}else{vm.requestParam.routedDrugId=0}vm.requestParam.dispensableDrugId=vm.genericProduct.dispensableDrugId;vm.requestParam.itemName=vm.genericProduct.name;vm.loadDoses()};vm.changeTake=function(dose){setDispenseDefault(dose);recommendedDosingService.setDefaultRoute(dose,dose.takeItem);recommendedDosingService.calculateDispense(dose)};vm.changeDoseRoute=function(dose){setDispenseDefault(dose);recommendedDosingService.setDefaultFrequency(dose,dose.routeItem);recommendedDosingService.calculateDispense(dose)};vm.changeFrequency=function(dose){setDispenseDefault(dose);recommendedDosingService.setDefaultDuration(dose,dose.freqItem);recommendedDosingService.calculateDispense(dose)};vm.showLoadingImage=function(){$(".recommendedtab-loader").css('display','block')};vm.hideLoadingImage=function(){$(".recommendedtab-loader").css('display','none')};function setDispenseDefault(dose){dose.drugPacks=dose.drugPackages;if(dose.drugPackages&&dose.drugPackages.length>0){dose.dispenseItem=dose.drugPackages[0]}}vm.changeDuration=function(dose){if(dose.durationItem.value===''){dose.durationItem.description=""}else{dose.durationItem.description=dose.durationItem.value+" Days"}setDispenseDefault(dose);if(/\D/.test(dose.durationItem.value)||dose.durationItem.value==='0'){if($(".recommended-dosing-duration-alert").length==0){ecwAlert("Duration (days) must be numeric.","","","","","","","recommended-dosing-duration-alert")}dose.durationItem.value="";dose.dispense="";return}recommendedDosingService.calculateDispense(dose)};vm.changeDispense=function(dose){if(dose&&dose.dispenseItem&&trimStr(''+dose.dispenseItem.size)!==''){dose.dispense=dose.dispenseItem.size+" "+dose.dispenseItem.unit;dose.ndc=dose.dispenseItem.ndc}};vm.openRxEditModal=function(doseObj){let formularyInfo={CoverageId:vm.requestParam.coverageId,FormularyID:vm.requestParam.formularyID,FormularySourceCode:vm.requestParam.formularySourceCode};doseObj.formularyInfo=formularyInfo;doseObj.encFacilityId=vm.requestParam.facilityId;doseObj.dosageResultSet=vm.dosageResultSet;if(vm.requestParam.context){doseObj.context=vm.requestParam.context}else{doseObj.context=vm.context}if(vm.context==='TelEncounter'){doseObj.isTelephonicEncounter=true}doseObj.isRTBCFeatureEnabled=vm.requestParam.rtbcEligibilityFlag&&vm.requestParam.isMedMulEquiDrug;$ocLazyLoad.load({name:'RxEditModule',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEdit/js/RxEditController.js','/mobiledoc/jsp/resources/jslib/angular-perfect-scrollbar/src/angular-perfect-scrollbar.min.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEdit/rx-editmodal.html'),controller:'RxEditCtrl',windowClass:'rxeditscreen bluetheme rx-topmargin',backdrop:"static",keyboard:false,resolve:{patientID:function(){return vm.requestParam.patientId},encounterID:function(){return vm.requestParam.encounterId},RxEditObject:function(){return doseObj},loginuserid:function(){return global.TrUserId},parentName:function(){return"RxQuickSearch"}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){doseObj.formularyInfo={};doseObj.encFacilityId="";doseObj.dosageResultSet=[];if(!angular.isUndefined(modalInstanceResponse)&&typeof modalInstanceResponse==='object'){if(modalInstanceResponse.ePARequestFromRxEdit){vm.epaSelectCallBack({arg0:modalInstanceResponse})}else{vm.selectCallBack({arg0:modalInstanceResponse})}}else if(vm.favRefreshCallback){vm.favRefreshCallback()}})})};vm.openRxEditOnClickHere=function(){let doseObj={};doseObj.ItemId=vm.drugNameItem.itemId;doseObj.RxItemId=vm.drugNameItem.itemId;doseObj.drugName=vm.drugNameItem.itemName;doseObj.DispensableItemId=0;doseObj.take='';doseObj.strength='';doseObj.formulation='';doseObj.route='';doseObj.freq='';doseObj.duration='';doseObj.refills='';doseObj.controlled='';doseObj.dispense='';doseObj.AddInstructions='';doseObj.MMDCode='';doseObj.DrugNameId=vm.drugNameItem.drugNameId;doseObj.routedDrugId=vm.requestParam.routedDrugId;doseObj.dispensableDrugId=vm.requestParam.dispensableDrugId;doseObj.DispensableItemId=0;doseObj.ndc='';if(vm.requestParam.dxId){doseObj.assessId=vm.requestParam.dxId}else{doseObj.assessId="0"}vm.openRxEditModal(doseObj)};vm.openRxEdit=function(index){let doseObj=vm.dosageResultSet[index];doseObj.routedDrugId=vm.requestParam.routedDrugId;doseObj.dispensableDrugId=vm.requestParam.dispensableDrugId;doseObj.DispensableItemId=doseObj.itemIdDispensableDrug;vm.openRxEditModal(convertToResponseObj(doseObj))};vm.isRtbcButtonClicked=false;vm.selectDose=function(index,onRtbcBtnClickRecDosing){let doseObj=vm.dosageResultSet[index];if(onRtbcBtnClickRecDosing)doseObj.isRtbcButtonClicked=true;else doseObj.isRtbcButtonClicked=false;vm.selectCallBack({arg0:convertToResponseObj(doseObj)})};vm.changeRoute=function(dose,route){dose.drugRoute=route};function convertToResponseObj(doseObj){var newObj={};newObj.isRtbcButtonClicked=doseObj.isRtbcButtonClicked;newObj.PARequired=doseObj.PARequired;newObj.AdministerFlag="0";newObj.DispenseFlag="0";newObj.DrugNameId=doseObj.drugNameId;newObj.routedDrugId=doseObj.routedDrugId;newObj.dispensableDrugId=doseObj.dispensableDrugId;newObj.IVHydration="0";newObj.IsRxSupplies=doseObj.rxSupplies||"NO";newObj.ItemId=doseObj.itemIdDrugName;newObj.RxItemId=doseObj.itemIdDrugName;newObj.DispensableItemId=doseObj.itemIdDispensableDrug;newObj.drugName=doseObj.drugName;newObj.dosageResultSet=doseObj.dosageResultSet;newObj.sItemName=doseObj.drugName;newObj.MMDCode=doseObj.mmdcode||"";newObj.ObsoleteDate=doseObj.obsoleteDate||"";newObj.awup="";newObj.controlled=doseObj.controlled||"";newObj.controlledCode=doseObj.controlledSubstanceCode||"";newObj.description=doseObj.description;newObj.dispense=doseObj.dispense||"";newObj.doseunit="";newObj.drugNameType=doseObj.drugNameType||"";newObj.drugOTC=doseObj.drugOTC||"";if(doseObj.durationItem&&doseObj.durationItem.description!==""){newObj.duration=doseObj.durationItem.description}else{newObj.duration=""}newObj.favorite="0";newObj.formulation=doseObj.formulation;if(doseObj.freqItem){newObj.freq=doseObj.freqItem.description}else{newObj.freq=''}newObj.rxNorm=doseObj.rxnorm;var additionalInstructions=addAdditionalInstructions(doseObj.prn,doseObj);if(additionalInstructions&&additionalInstructions.length>0){newObj.AddInstructions=additionalInstructions}else{newObj.AddInstructions=""}newObj.isCompound="0";if(doseObj.ndc==null){newObj.ndc='';newObj.NDC=''}else{newObj.ndc=doseObj.ndc;newObj.NDC=doseObj.ndc}newObj.refills=doseObj.refill;if(doseObj.routeItem&&doseObj.routeItem.routeName){newObj.route=doseObj.routeItem.routeName}else{newObj.route=''}newObj.rxFormulary="";newObj.rxFormularyId="";newObj.strength=doseObj.strength;if(doseObj.takeItem){if(doseObj.takeItem.weightBased&&doseObj.takeItem.weightBasedFormulation){newObj.take=doseObj.takeItem.weightBasedDoseFormulationValue+" "+doseObj.takeItem.weightBasedDoseFormulationUnit}else if(doseObj.takeItem.weightBased&&doseObj.takeItem.weightBasedStrength){newObj.take=doseObj.takeItem.weightBasedDoseStrengthValue+" "+doseObj.takeItem.weightBasedDoseStrengthUnit}else{newObj.take=doseObj.takeItem.doseFormulationValue+" "+doseObj.takeItem.doseFormulationUnit}}else{newObj.take=''}if(vm.requestParam.dxId){newObj.assessId=vm.requestParam.dxId}else{newObj.assessId="0"}return newObj}function addAdditionalInstructions(prn,doseObj){var additionalInstructions="";if(prn&&prn==='1'){additionalInstructions=" as needed"}if(doseObj&&doseObj.additionalInstructions){for(var i=0;i<doseObj.additionalInstructions.length;i++){if(doseObj.additionalInstructions[i].checked===true||doseObj.additionalInstructions[i].checked==='true'){if(additionalInstructions!==""){additionalInstructions+=" "}additionalInstructions+=doseObj.additionalInstructions[i].name}}}return additionalInstructions.trim()}vm.selectedDosing={};vm.changeDoseName=function(doseName){vm.showLoadingImage();let requestData={drugProducts:vm.drugProducts,recommendedDrugDose:doseName,isWeightBased:vm.isWeightBased};vm.doseName=doseName.name;vm.selectedDosing=doseName;vm.dosageResultSet=recommendedDosingService.getRecommendedDosagesByName(vm.drugProducts,doseName,vm.isWeightBased);for(var i=0;i<vm.dosageResultSet.length;i++){vm.dosageResultSet[i].refill=0;if(vm.dosageResultSet[i].drugOrder&&vm.dosageResultSet[i].drugOrder.doseRoute&&vm.dosageResultSet[i].drugOrder.doseRoute.length>0){vm.dosageResultSet[i].doseRoute=vm.dosageResultSet[i].drugOrder.doseRoute[0]}vm.roundUpAndDownMessages(vm.dosageResultSet[i])}vm.hideLoadingImage()};vm.durationClick=function(dose,duration){dose.durationItem={'value':duration,'unit':'Days','description':duration+" Days"};vm.changeDuration(dose)};vm.setRouteFromTake=function(product){if(product&&product.routeItem&&product.routeItem.routeName&&product.takeItem&&product.takeItem.doseRoutes){for(var i=0;i<product.takeItem.doseRoutes.length;i++){if(product.takeItem.doseRoutes[i].routeName===product.routeItem.routeName){product.routeItem=product.takeItem.doseRoutes[i];break}}}};vm.calculateRoundUpAndDown=function(product,upOrDown){let requestData={drugTake:product.takeItem,drugFrequency:product.freqItem,upOrDown:upOrDown,weightInKgs:vm.patientProfile.weightInKgs};let promise=$http({method:'POST',url:'/mobiledoc/cpoe/drugDosage/roundUpAndDown',data:requestData,headers:{}});promise.then(function(data){product.takeItem=data.data.drugTake;vm.setRouteFromTake(product);product.freqItem=data.data.drugFrequency;vm.roundUpAndDownMessages(product);recommendedDosingService.validateDrugPackages(product);if(product.freqItem.dailyDoseValue>vm.selectedDosing.dose*1.1||product.freqItem.dailyDoseValue<vm.selectedDosing.dose*.9){product.freqItem.dailyDoseColor="red";product.freqItem.dailyDoseMessage="The dose adjustment has changed beyond 10% of the calculated daily dose."}else{product.freqItem.dailyDoseColor="#000000";product.freqItem.dailyDoseMessage=""}vm.changeDuration(product)})};vm.hasDoseAtLowestFormulationValue=function(dose){let drugTake=dose.takeItem;if(drugTake.weightBasedDoseFormulationUnit===undefined||drugTake.weightBasedDoseFormulationUnit===null){return false}if("ml"===trimStr(drugTake.weightBasedDoseFormulationUnit).toLowerCase()){return drugTake.weightBasedDoseFormulationValue===.01}else if("capsule"===trimStr(drugTake.weightBasedDoseFormulationUnit).toLowerCase()){return drugTake.weightBasedDoseFormulationValue<=1}return drugTake.weightBasedDoseFormulationValue<=.5};vm.selectTake=function(dose,doseObj){dose.takeItem=doseObj;vm.changeTake(dose);vm.roundUpAndDownMessages(dose)};vm.roundUpAndDownMessages=function(product,upOrDown){var baseMessage=vm.getRoundBaseMessage(product);if(baseMessage&&baseMessage!==''){product.takeItem.roundUpTitle="Round up to the nearest "+baseMessage;if(vm.hasDoseAtLowestFormulationValue(product)){product.takeItem.roundDownTitle=""}else{product.takeItem.roundDownTitle="Round down to the nearest "+baseMessage}}else{product.takeItem.roundUpTitle="";product.takeItem.roundDownTitle=""}};vm.roundUp=function(dose){vm.calculateRoundUpAndDown(dose,"up")};vm.loadFormularyRxDoses=function(nSynonymId,itemID){vm.formularyDosageResultSet=[];vm.showObsoleteMessage=false;vm.showDiscontinuedRxIcon=false;if(!angular.isUndefined(vm.dosageResultSet)&&vm.dosageResultSet!=null&&vm.dosageResultSet.length>0){vm.formularyDosageResultSet=vm.dosageResultSet;vm.setDataForFormulary()}};vm.setDataForFormulary=function(){for(var i=0;i<vm.formularyDosageResultSet.length;i++){if(vm.formularyDosageResultSet[i].otcCode==="O"||vm.formularyDosageResultSet[i].otcCode==="2"||vm.formularyDosageResultSet[i].otcCode==="3"){vm.formularyDosageResultSet[i].OTC="O"}else if(vm.formularyDosageResultSet[i].otcCode==="R"||vm.formularyDosageResultSet[i].otcCode==="1"){vm.formularyDosageResultSet[i].OTC="P"}else if(vm.formularyDosageResultSet[i].otcCode===""){vm.formularyDosageResultSet[i].OTC="U"}if(vm.formularyDosageResultSet[i].nameTypeCode==="N"||vm.formularyDosageResultSet[i].nameTypeCode==="B"||vm.formularyDosageResultSet[i].nameTypeCode==="2"||vm.formularyDosageResultSet[i].nameTypeCode==="1"){vm.formularyDosageResultSet[i].GBO="B"}else if(vm.formularyDosageResultSet[i].nameTypeCode==="T"||vm.formularyDosageResultSet[i].nameTypeCode==="3"||vm.formularyDosageResultSet[i].nameTypeCode==="G"){vm.formularyDosageResultSet[i].GBO="G"}}vm.checkFormularyForDrug()};vm.checkFormularyForDrug=function(){var xml="";var xw=new XMLWriter;startSoapPacket(xw);xw.writeStartElement('Info');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('RxList');xw.writeAttributeString('xsi:type','xsd:string');for(var i=0;i<vm.formularyDosageResultSet.length;i++){xw.writeStartElement('Row');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,"NDCCode",vm.formularyDosageResultSet[i].ndc,'xsi:type','xsd:string');xw.writeEndElement()}xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);xml=xw.flush();vm.formularyDataForDrug=[];vm.dosageResultSetGreenDrugs=[];vm.dosageResultSetOrangeDrugs=[];vm.dosageResultSetYellowDrugs=[];vm.dosageResultSetRedDrugs=[];vm.dosageResultSetBlackDrugs=[];if(vm.requestParam.coverageId===null||typeof vm.requestParam.coverageId===null||vm.requestParam.coverageId==="null")vm.requestParam.coverageId="";var strUrl="/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/checkFormularyForDrug.jsp?FormularyId="+vm.requestParam.formularyID+"&FormSourceId="+vm.requestParam.formularySourceCode+"&CoverageId="+vm.requestParam.coverageId;var params="strData="+xml;var responsePromise=vm.LoadURL(strUrl,params);responsePromise.success(function(data){if(data.trim().length>0){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'].resultset.data.rows)>0){if(jsonobj.Envelope.Body['return'].resultset.data.rows.length>0){vm.formularyDataForDrug=jsonobj.Envelope.Body['return'].resultset.data.rows}else{vm.formularyDataForDrug.push(jsonobj.Envelope.Body['return'].resultset.data.rows)}vm.calculateFormulary();vm.sortDrugsByFormulary()}}})};vm.LoadURL=function(strUrl,data){return $http({method:'POST',url:makeURL(strUrl),data:data,"async":true,headers:{'Content-Type':'application/x-www-form-urlencoded'}})};vm.calculateFormulary=function(){for(var i=0;i<vm.formularyDosageResultSet.length;i++){for(var j=i;j<vm.formularyDataForDrug.length;j++){if(vm.formularyDataForDrug[j].NDC_Code===vm.formularyDosageResultSet[i].ndc){if(vm.formularyDataForDrug[j].FormularyStatus==="01"){vm.formularyDosageResultSet[i].FormularyStatus="1"}else if(vm.formularyDataForDrug[j].FormularyStatus==="02"){vm.formularyDosageResultSet[i].FormularyStatus="2"}else if(vm.formularyDataForDrug[j].FormularyStatus==="03"){vm.formularyDosageResultSet[i].FormularyStatus="3"}else if(vm.formularyDataForDrug[j].FormularyStatus==="00"){vm.formularyDosageResultSet[i].FormularyStatus="0"}else{vm.formularyDosageResultSet[i].FormularyStatus=vm.formularyDataForDrug[j].FormularyStatus}if(vm.formularyDataForDrug[j].PARequired==="Yes"){vm.formularyDosageResultSet[i].PARequired=true}else{vm.formularyDosageResultSet[i].PARequired=false}break}}}for(var i=0;i<vm.formularyDosageResultSet.length;i++){var strFormularyStatus=vm.formularyDosageResultSet[i].FormularyStatus;if(strFormularyStatus===""){if(vm.formularyDosageResultSet[i].GBO==="B"&&vm.formularyDosageResultSet[i].OTC==="O"){if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()==="Unknown"){vm.formularyDosageResultSet[i].FormularyStatus="U"}else if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()===""){vm.formularyDosageResultSet[i].FormularyStatus=""}else if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()==="Not Reimbursable"){vm.formularyDosageResultSet[i].FormularyStatus="0"}else if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()==="Non Formulary"){vm.formularyDosageResultSet[i].FormularyStatus="1"}else if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()==="On Formulary(Not Preferred)"){vm.formularyDosageResultSet[i].FormularyStatus="2"}else{if(vm.requestParam.NLRxBrandOTC_FS!==""){if(vm.isNumeric(vm.Right(vm.requestParam.NLRxBrandOTC_FS.trim(),2))){var nPrefLevel=vm.Right(vm.requestParam.NLRxBrandOTC_FS.trim(),2)+2;vm.formularyDosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(vm.formularyDosageResultSet[i].GBO==="B"&&vm.formularyDosageResultSet[i].OTC==="P"){if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()==="Unknown"){vm.formularyDosageResultSet[i].FormularyStatus="U"}else if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()===""){vm.formularyDosageResultSet[i].FormularyStatus=""}else if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()==="Not Reimbursable"){vm.formularyDosageResultSet[i].FormularyStatus="0"}else if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()==="Non Formulary"){vm.formularyDosageResultSet[i].FormularyStatus="1"}else if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()==="On Formulary(Not Preferred)"){vm.formularyDosageResultSet[i].FormularyStatus="2"}else{if(vm.requestParam.NLRxBrand_FS!==""){if(vm.isNumeric(vm.Right(vm.requestParam.NLRxBrand_FS.trim(),2))){var nPrefLevel=vm.Right(vm.requestParam.NLRxBrand_FS.trim(),2)+2;vm.formularyDosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(vm.formularyDosageResultSet[i].GBO==="G"&&vm.formularyDosageResultSet[i].OTC==="O"){if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()==="Unknown"){vm.formularyDosageResultSet[i].FormularyStatus="U"}else if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()===""){vm.formularyDosageResultSet[i].FormularyStatus=""}else if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()==="Not Reimbursable"){vm.formularyDosageResultSet[i].FormularyStatus="0"}else if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()==="Non Formulary"){vm.formularyDosageResultSet[i].FormularyStatus="1"}else if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()==="On Formulary(Not Preferred)"){vm.formularyDosageResultSet[i].FormularyStatus="2"}else{if(vm.requestParam.NLRxGenericOTC_FS!==""){if(vm.isNumeric(vm.Right(vm.requestParam.NLRxGenericOTC_FS.trim(),2))){var nPrefLevel=vm.Right(vm.requestParam.NLRxGenericOTC_FS.trim(),2)+2;vm.formularyDosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(vm.formularyDosageResultSet[i].GBO==="G"&&vm.formularyDosageResultSet[i].OTC==="P"){if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()==="Unknown"){vm.formularyDosageResultSet[i].FormularyStatus="U"}else if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()===""){vm.formularyDosageResultSet[i].FormularyStatus=""}else if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()==="Not Reimbursable"){vm.formularyDosageResultSet[i].FormularyStatus="0"}else if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()==="Non Formulary"){vm.formularyDosageResultSet[i].FormularyStatus="1"}else if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()==="On Formulary(Not Preferred)"){vm.formularyDosageResultSet[i].FormularyStatus="2"}else{if(vm.requestParam.NLRxGeneric_FS!==""){if(vm.isNumeric(vm.Right(vm.requestParam.NLRxGeneric_FS.trim(),2))){var nPrefLevel=vm.Right(vm.requestParam.NLRxGeneric_FS.trim(),2)+2;vm.formularyDosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}}if(typeof vm.formularyDosageResultSet[i].FormularyStatus==undefined){vm.formularyDosageResultSet[i].FormularyStatus="U"}if(vm.formularyDosageResultSet[i].FormularyStatus===""){vm.formularyDosageResultSet[i].FormularyStatus="U"}var nColorCode=vm.getProductStatusColorCode(vm.formularyDosageResultSet[i].FormularyStatus);switch(nColorCode){case"white":vm.dosageResultSet[i].formularypic="icon-black-question";vm.dosageResultSet[i].formularypictooltip="Formulary Status - Unknown";vm.dosageResultSetBlackDrugs.push(vm.dosageResultSet[i]);break;case"red":vm.dosageResultSet[i].formularypic="icon-red-face";vm.dosageResultSet[i].formularypictooltip="Formulary Status - Not Covered";vm.dosageResultSetRedDrugs.push(vm.dosageResultSet[i]);break;case"orange":vm.dosageResultSet[i].formularypic="icon-orange-face";vm.dosageResultSet[i].formularypictooltip="Formulary Status - Non Formulary";vm.dosageResultSetOrangeDrugs.push(vm.dosageResultSet[i]);break;case"yellow":vm.dosageResultSet[i].formularypic="icon-yellow-face";vm.dosageResultSet[i].formularypictooltip="Formulary Status - On Formulary";vm.dosageResultSetYellowDrugs.push(vm.dosageResultSet[i]);break;default:vm.dosageResultSet[i].formularypic="icon-green-face";vm.dosageResultSet[i].formularypictooltip="Formulary Status - Preferred Drugs";vm.dosageResultSetGreenDrugs.push(vm.dosageResultSet[i]);break}}};vm.isNumeric=function(obj){return!Array.isArray(obj)&&obj-parseFloat(obj)+1>=0};vm.Right=function(str,nextCharlength){return str.substring(str.length-2,str.length)};vm.getProductStatusColorCode=function(strProductStatusCode){switch(strProductStatusCode){case"U":return"white";break;case"0":return"red";case"00":return"red";break;case"1":return"orange";break;case"01":return"orange";break;case"2":return"yellow";break;case"02":return"yellow";break;case"":return"white";break;default:return"green";break}};vm.sortDrugsByFormulary=function(){vm.dosageResultSet=[];vm.dosageResultSet=vm.dosageResultSet.concat(vm.dosageResultSetGreenDrugs);vm.dosageResultSet=vm.dosageResultSet.concat(vm.dosageResultSetYellowDrugs);vm.dosageResultSet=vm.dosageResultSet.concat(vm.dosageResultSetOrangeDrugs);vm.dosageResultSet=vm.dosageResultSet.concat(vm.dosageResultSetRedDrugs);vm.dosageResultSet=vm.dosageResultSet.concat(vm.dosageResultSetBlackDrugs)};vm.roundDown=function(dose){vm.calculateRoundUpAndDown(dose,"down")};vm.getRoundBaseMessage=function(product){if(!(product.takeItem.weightBased&&product.takeItem.weightBasedFormulation))return"";if(product.takeItem.weightBasedDoseFormulationUnit.toLowerCase().indexOf('ml')>=0){if(product.takeItem.weightBasedDoseFormulationValue>0&&product.takeItem.weightBasedDoseFormulationValue<=1){return"hundredth"}else if(product.takeItem.weightBasedDoseFormulationValue>1&&product.takeItem.weightBasedDoseFormulationValue<=3){return"tenth"}else if(product.takeItem.weightBasedDoseFormulationValue>3&&product.takeItem.weightBasedDoseFormulationValue<=5){return"quarter"}else if(product.takeItem.weightBasedDoseFormulationValue>5){return"half"}}else if(product.takeItem.weightBasedDoseFormulationUnit.toLowerCase().indexOf('capsule')>=0){return"whole integer"}else{return"half"}return""};function initRecommendedDosingHorizontalScrollArrows(){$timeout(function(){vm.hideShowScrollButtons()})}vm.scrollHorizontally=function(direction){var scrollLeftPos=$("#horizontal-scroll-main-"+vm.topClass+" .horizontal-scroll-content").scrollLeft();if(direction==='left'){if(scrollLeftPos>=100){scrollLeftPos-=100}else{scrollLeftPos=0}}else{scrollLeftPos+=100}$("#horizontal-scroll-main-"+vm.topClass+" .horizontal-scroll-content").animate({scrollTop:0,scrollLeft:scrollLeftPos},300,'swing',function(){vm.hideShowScrollButtons()})};var lastScrollPosition=0;vm.hideShowScrollButtons=function(){var scrollLeftPos=$("#horizontal-scroll-main-"+vm.topClass+" .horizontal-scroll-content").scrollLeft();var containerWidth=$("#horizontal-scroll-main-"+vm.topClass+" .horizontal-scroll-content").width();var parentWidth=$("#horizontal-scroll-main-"+vm.topClass).parent().parent().width()-150;if(containerWidth<parentWidth){$("#horizontal-scroll-main-"+vm.topClass+" .btn-horizontal-scroll.left").hide();$("#horizontal-scroll-main-"+vm.topClass+" .btn-horizontal-scroll.right").hide();return}if(scrollLeftPos===0){$("#horizontal-scroll-main-"+vm.topClass+" .btn-horizontal-scroll.left").hide()}else{$("#horizontal-scroll-main-"+vm.topClass+" .btn-horizontal-scroll.left").show()}if(scrollLeftPos!==0&&scrollLeftPos-lastScrollPosition>=0&&scrollLeftPos-lastScrollPosition<100){$("#horizontal-scroll-main-"+vm.topClass+" .btn-horizontal-scroll.right").hide()}else{$("#horizontal-scroll-main-"+vm.topClass+" .btn-horizontal-scroll.right").show()}lastScrollPosition=scrollLeftPos};vm.validateDurationDispense=function(value){var pattern=/^([^0-9]*)$/;if(value){if(!pattern.test(value)){return true}}return false}}function recommendedDosingService($http){function setAdditionalInformation(dose,freqItem){var additionalInstructions=[];if(freqItem.mandatoryAdditionalInstructions&&freqItem.mandatoryAdditionalInstructions.length>0){var array=freqItem.mandatoryAdditionalInstructions;for(var i=0;i<array.length;i++){var obj={'name':array[i],'mandatory':true,'checked':true};additionalInstructions.push(obj)}}if(freqItem.optionalAdditionalInstructions&&freqItem.optionalAdditionalInstructions.length>0){var array=freqItem.optionalAdditionalInstructions;for(var i=0;i<array.length;i++){var obj={'name':array[i],'mandatory':false,'checked':false};additionalInstructions.push(obj)}}dose.additionalInstructions=additionalInstructions}function setDefaultRoute(dose,take){if(!take.doseRoutes||take.doseRoutes.length===0){dose.routeItem=null;dose.freqItem=null;dose.durationItem=null;return}dose.routeItem=take.doseRoutes[0];setDefaultFrequency(dose,dose.routeItem)}function setDefaultFrequency(dose,route){if(!route.frequencies||route.frequencies.length===0){dose.freqItem=null;dose.durationItem=null;validateDrugPackages(dose);return}dose.freqItem=route.frequencies[0];setAdditionalInformation(dose,dose.freqItem);setDefaultDuration(dose,dose.freqItem)}function setDefaultDuration(dose,frequency){if(!frequency.drugDurations||frequency.drugDurations.length===0){dose.durationItem=null;validateDrugPackages(dose);return}dose.durationItem=frequency.drugDurations[0];calculateDispense(dose)}function calculateDispense(dose){var take="";dose.dispense="";if(!dose.takeItem||!dose.freqItem||!dose.freqItem.dosesPerDay||!dose.durationItem||!dose.durationItem.value){validateDrugPackages(dose);return}if(dose.takeItem.weightBased&&dose.takeItem.weightBasedFormulation){take=dose.takeItem.weightBasedDoseFormulationValue+" "+dose.takeItem.weightBasedDoseFormulationUnit}else if(dose.takeItem.weightBased&&dose.takeItem.weightBasedStrength){take=dose.takeItem.weightBasedDoseStrengthValue+" "+dose.takeItem.weightBasedDoseStrengthUnit}else{take=dose.takeItem.doseFormulationValue+" "+dose.takeItem.doseFormulationUnit}let requestData={take:take,frequency:dose.freqItem.description,duration:dose.durationItem.value};$.get({url:'/mobiledoc/cpoe/dispense/calculate',"async":false,data:requestData}).done(function(data){if(data.dispense){dose.dispense=data.dispense}else{dose.dispense=''}validateDrugPackages(dose)})}function validateDrugPackages(dose){var drugPackages=new Array;if(dose.drugPackages&&dose.drugPackages.length>0){var dispenseItem={'size':dose.dispense,'unit':'',ndc:dose.ndc};drugPackages.push(dispenseItem);for(var i=0;i<dose.drugPackages.length;i++){drugPackages.push(dose.drugPackages[i])}dose.dispenseItem=drugPackages[0]}dose.drugPacks=drugPackages}function getRecommendedDosagesByName(drugProducts,recommendedDrugDose,isWeightBased){var products=new Array;angular.copy(drugProducts,products);var drugProductList=new Array;if(!products||!recommendedDrugDose)return;for(var i=0;i<products.length;i++){var drugProduct=products[i];var drugTake=getDefaultTakeItemByName(drugProduct,recommendedDrugDose.name);if(drugTake!=null){drugProduct.takeItem=drugTake;drugProduct.drugPacks=drugProduct.drugPackages;setDefaultRoute(drugProduct,drugProduct.takeItem);drugProductList.push(drugProduct)}}return drugProductList}function getDefaultTakeItemByName(drugProduct,doseName){var drugTake=null;var newTakes=new Array;if(!doseName||doseName.trim()===''||!drugProduct.drugOrder)return drugTake;var takes=drugProduct.drugOrder.takes;if(takes!=null&&takes.length>0){for(var i=0;i<takes.length;i++){var take=takes[i];if(doseName&&doseName.toLowerCase()===take.doseName.toLowerCase()&&drugTake==null){drugTake=take;newTakes.push(take)}else if(doseName&&doseName.toLowerCase()===take.doseName.toLowerCase()){newTakes.push(take)}}}drugProduct.drugOrder.takes=newTakes;return drugTake}function getKeyLength(object){var count=0;for(var property in object){if(object.hasOwnProperty(property)){count++;break}}return count}function setDefaultTakeItem(drugProduct){if(!drugProduct.drugOrder)return;var takes=drugProduct.drugOrder.takes;if(takes!=null&&takes.length>0){drugProduct.takeItem=takes[0];drugProduct.drugPacks=drugProduct.drugPackages;setDefaultRoute(drugProduct,drugProduct.takeItem)}}let doseListObj={};doseListObj.setDefaultRoute=setDefaultRoute;doseListObj.setDefaultFrequency=setDefaultFrequency;doseListObj.setDefaultDuration=setDefaultDuration;doseListObj.calculateDispense=calculateDispense;doseListObj.getRecommendedDosagesByName=getRecommendedDosagesByName;doseListObj.setDefaultTakeItem=setDefaultTakeItem;doseListObj.validateDrugPackages=validateDrugPackages;return doseListObj}})();
angular.module('ecw.telemed').directive('telemedMessaging',["$sce","telemedAPIService","telemedSessionService","telemedLoggingService","$timeout","telemedCommonUtils","telemedCallRunningService",function($sce,telemedAPIService,telemedSessionService,telemedLoggingService,$timeout,telemedCommonUtils,telemedCallRunningService){return{restrict:'E',replace:'false',templateUrl:'/mobiledoc/jsp/webemr/telemed/messaging/telemed-messaging.html',scope:{},link:function(scope,$element,$attrs,ctrl){var callbacks={};var sessionContexts={};var DisplayLimit={DAYS:30,WEEKS:24,MONTHS:24};var chatHistoriesToSave={chatHistories:[],chatHistoryAcks:[]};var ChatStatus={SENT:1,DELIVERED:2,FAILED:3};var msgCounter=0;function initVariables(){scope.txtMsgSend="";scope.chats={};scope.isMultiMessagingModule=false;scope.patientOnlineCount=0;scope.singlePatientIdentifer={};scope.selectedEncounters={};scope.processing=false;scope.topLoaderClass="alert-info";scope.topLoaderMessage="Please wait while loading the patient list";msgCounter=0;sessionContexts={};scope.isPatientCallRunning=false}initVariables();callbacks[telemedSessionService.events.CONNECT]=function(eventIdentifier,error){if(error){scope.selectedEncounters[eventIdentifier]["errorMsg"]="Unable to send message";setScope()}};callbacks[telemedSessionService.events.CONNECTION_CREATED]=function(eventIdentifier,event){try{var eventData=$.parseJSON(event.connection.data).data;if(eventData&&eventData.usertype==="patient"&&eventIdentifier===eventData.encId){if(!scope.selectedEncounters[eventIdentifier]["connection"]){scope.patientOnlineCount++}scope.selectedEncounters[eventIdentifier]["online"]=true;scope.selectedEncounters[eventIdentifier]["connection"]=event.connection;setScope()}}catch(e){telemedLoggingService.error(e)}};callbacks[telemedSessionService.events.CONNECTION_DESTROYED]=function(eventIdentifier,event){try{var eventData=$.parseJSON(event.connection.data).data;if(eventData&&eventData.usertype==="patient"&&eventIdentifier===eventData.encId&&scope.selectedEncounters[eventIdentifier]["connection"].connectionId===event.connection.connectionId){scope.selectedEncounters[eventIdentifier]["online"]=false;delete scope.selectedEncounters[eventIdentifier]["connection"];scope.patientOnlineCount--;setScope()}}catch(e){telemedLoggingService.error(e)}};callbacks[telemedSessionService.events.SIGNAL]=function(eventIdentifier,event){if("signal:practiceMessageAck"===event.type||"practiceMessageAck"===event.type){var _msgId=typeof event.data==='string'?$.parseJSON(event.data).msgId:event.data.msgId;var chatAckObj={encId:eventIdentifier,msgId:_msgId,deliveredTime:moment().utc().format('YYYY-MM-DD HH:mm:ss'),status:ChatStatus.DELIVERED};if(scope.isMultiMessagingModule){var statusObj=scope.chats[_msgId].deliveredMsgList.find(function(element){return element.encId===eventIdentifier});if(statusObj!=null&&!statusObj.status){statusObj.status=true;scope.chats[_msgId]["deliveredCount"]=scope.chats[_msgId]["deliveredCount"]+1;chatHistoriesToSave["chatHistoryAcks"].push(chatAckObj)}}else{scope.chats[_msgId]["deliveredCount"]=scope.chats[_msgId]["deliveredCount"]+1;chatHistoriesToSave["chatHistoryAcks"].push(chatAckObj)}saveAppointmentChatHistory();setScope()}};scope.$on("showTelemedMessagingModal",function(evt,data){initVariables();$("#telemedMessagingModal").modal("show");$("#txtTVMsgSend").on("keydown",scope.countCharLeft);try{startProcess(data)}catch(e){telemedLoggingService.error(e);showHideTopLoader("alert-danger","Unable to perform the operation at this moment.")}});function setScope(){try{if(scope.$root.$$phase!=='$apply'&&scope.$root.$$phase!=='$digest'){scope.$apply()}}catch(e){}}function showHideTopLoader(_class,message){scope.topLoaderClass=_class;scope.topLoaderMessage=message}function hasSessionToken(encObj){if(!encObj.session||!encObj.token)return false;return true}function getPatientIdentifier(arr,userId){for(var i in arr){if(parseInt(arr[i].uid,10)===userId){var obj=arr[i];return{id:obj.uid,lastName:obj.lastname,firstName:obj.firstname,middleInitial:obj.middleinitial,suffix:obj.suffix,dateOfBirth:obj.dateofbirth,sex:obj.sex,accountNumber:obj.accountnumber}}}return{}}function getAgeFromDob(dob){var formattedAge;var ageInDays=moment().diff(dob,'days');var ageInWeeks=moment().diff(dob,'weeks');var ageInMonths=moment().diff(dob,'months');if(ageInDays<=DisplayLimit.DAYS){formattedAge=ageInDays+' do'}else if(ageInWeeks<=DisplayLimit.WEEKS){formattedAge=ageInWeeks+' wo'}else if(ageInMonths<=DisplayLimit.MONTHS){formattedAge=ageInMonths+' mo'}else{formattedAge=moment().diff(dob,'years')+' yo'}return formattedAge}function formatSex(sex){switch(sex.toUpperCase()){case'MALE':case'M':return'M';case'FEMALE':case'F':return'F';case'UNKNOWN':case'U':return'U';default:return'Other'}}function getPatientIdentierForUI(obj){try{var userObj={};var fullName=obj.lastName.toUpperCase()+', '+obj.firstName;if(obj.middleInitial){fullName+=' '+obj.middleInitial}if(obj.suffix){fullName+=' '+obj.suffix}userObj["fullName"]=fullName;var dob=moment(obj.dateOfBirth,['MM/DD/YYYY','YYYY-MM-DD']);userObj["dob"]=dob.format('MMM D, YYYY');userObj["age"]=getAgeFromDob(dob);userObj["sex"]=formatSex(obj.sex);userObj["accNo"]=obj.accountNumber;return userObj}catch(e){return{}}}function connectToSession(apiKey,encObj){var sessionService=telemedSessionService.initSession();sessionService.registerCallback(encObj.encId,callbacks);sessionService.connect(apiKey,encObj.session,encObj.token);sessionContexts[encObj.encId]=sessionService}var started=false;var timer=null;var interval=5e3;function saveAppointmentChatHistory(){if(started||!started&&timer){return}timer=setTimeout(function(){if(!started&&hasAtleastOneChatDataToSave()){started=true;var tmpData=chatHistoriesToSave;chatHistoriesToSave={chatHistories:[],chatHistoryAcks:[]};var url='/mobiledoc/modules/webemr/telehealth/messaging/saveAppointmentChatHistory';telemedAPIService.invokePostAsBody(url,tmpData).success(function(data){started=false;clearSaveAppointmentChatHistoryTimer();if(hasAtleastOneChatDataToSave()){saveAppointmentChatHistory()}}).error(function(err){started=false;clearSaveAppointmentChatHistoryTimer();if(hasAtleastOneChatDataToSave()){saveAppointmentChatHistory()}})}},interval)}function hasAtleastOneChatDataToSave(){var chats=chatHistoriesToSave["chatHistories"];var acks=chatHistoriesToSave["chatHistoryAcks"];return Object.keys(chats).length>0||Object.keys(acks).length>0}function clearSaveAppointmentChatHistoryTimer(){if(timer){clearTimeout(timer);timer=null}}function startProcess(data){if(!angular.isArray(data)||data.length<=0){showHideTopLoader("alert-danger","Unable to perform the operation at this moment.");return}var url='/mobiledoc/modules/webemr/telehealth/messaging/getAppointmentSessionInfo';var data={"encIds":data.join(',')};telemedAPIService.invokePost(url,data).success(function(data){try{if(data.status==="success"){var apiKey=data.response["api_key"];var responseInfo=data.response["info"];var ptIdentifiers=data.response["pt_identifiers"];scope.isMultiMessagingModule=responseInfo.length>1;if(!scope.isMultiMessagingModule){var chathistory=data.response["chat_history"];if(chathistory!=null&&chathistory.length>0){for(var i in chathistory){var chatHistoryObject=chathistory[i];var localTime=moment.utc(chatHistoryObject.sentTime).toDate();scope.chats[chatHistoryObject.msgId]={time:moment(localTime).format('hh:mm A '),message:$sce.trustAsHtml(chatHistoryObject.message),msgId:chatHistoryObject.msgId,totalCount:ChatStatus.DELIVERED,deliveredCount:chatHistoryObject.status,failedParticipants:[],deliveredMsgList:[]}}}}if(responseInfo.length===1){var encObj=responseInfo[0];var connect=hasSessionToken(encObj);scope.singlePatientIdentifer=getPatientIdentifier(ptIdentifiers,encObj.userId);scope.selectedEncounters[encObj.encId]={userId:encObj.userId,online:false,errorMsg:!connect?"Can't send the message":"",isCallRunning:false};if(tvCallRunning(encObj.encId,encObj.session)){scope.selectedEncounters[encObj.encId].isCallRunning=true}else{if(connect){connectToSession(apiKey,encObj)}}}else{for(var i in responseInfo){var encObj=responseInfo[i];var connect=hasSessionToken(encObj);scope.selectedEncounters[encObj.encId]={userId:encObj.userId,online:false,errorMsg:!connect?"Can't send the message":"",userIdentifier:getPatientIdentierForUI(getPatientIdentifier(ptIdentifiers,encObj.userId)),isCallRunning:false};if(tvCallRunning(encObj.encId,encObj.session)){scope.selectedEncounters[encObj.encId].isCallRunning=true}else{if(connect){connectToSession(apiKey,encObj)}}}}showHideTopLoader(false,'','')}}catch(e){showHideTopLoader("alert-danger","Unable to perform the operation at this moment.")}}).error(function(error){showHideTopLoader("alert-danger","Unable to perform the operation at this moment.")})}function generateUniqueMessageId(){var text=global.TrUserId+'_'+moment().unix();var nonce="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<6;i++){nonce+=possible.charAt(Math.floor(Math.random()*possible.length))}return text+'_'+nonce}scope.sendMessage=function(){try{var msgId=generateUniqueMessageId();var trimMsg=scope.txtMsgSend.trim();if(trimMsg.length>0){scope.processing=true;var messageToSend=telemedCommonUtils.escapeHtml(trimMsg);trimMsg=$sce.trustAsHtml(messageToSend);var time=moment().format('hh:mm A');scope.chats[msgId]={time:time,message:trimMsg,msgId:msgId,totalCount:0,deliveredCount:0,failedParticipants:[],deliveredMsgList:[]};var chatContainer=$('#telemedMessagingModal').find('.mesgs');if(chatContainer){chatContainer.animate({scrollTop:chatContainer[0].scrollHeight})}$.each(sessionContexts,function(encId,sessionService){if(scope.selectedEncounters[encId]["online"]===true){if(scope.selectedEncounters[encId].userIdentifier!=null){scope.chats[msgId].deliveredMsgList.push({"fullName":scope.selectedEncounters[encId].userIdentifier.fullName,"status":false,"encId":encId})}scope.chats[msgId]["totalCount"]=scope.chats[msgId]["totalCount"]+1;if(scope.selectedEncounters[encId].connection){sessionService.sendSignalTo(scope.selectedEncounters[encId].connection,"practiceMessage",{message:messageToSend,msgId:msgId},function(error){var chatObj={encId:encId,senderId:global.TrUserId,msgId:msgId,message:messageToSend,sentTime:moment().utc().format('YYYY-MM-DD HH:mm:ss')};chatObj["status"]=error?ChatStatus.FAILED:ChatStatus.SENT;chatHistoriesToSave["chatHistories"].push(chatObj);saveAppointmentChatHistory()})}}});cleanTextBox()}else{cleanTextBox()}}catch(e){telemedLoggingService.error(e)}};function cleanTextBox(){scope.txtMsgSend="";scope.processing=false;var txtBox=$('#telemedMessagingModal').find('#txtMsgSend');txtBox.val('');txtBox.focus()}function tvCallRunning(encId,sessionId){var info=telemedCallRunningService.getCallRunningInfo();if(info!=null&&(info.identifier===encId||info.sessionId===sessionId)){scope.isPatientCallRunning=true;return true}else{return false}}scope.closeTelemedMessagingModal=function(){$.each(sessionContexts,function(encId,sessionService){sessionService.disconnect(encId,callbacks)});sessionContexts={};$("#telemedMessagingModal").modal("hide");$("#txtTVMsgSend").off("keydown",scope.countCharLeft);initVariables()};scope.countCharLeft=function(event){let message=scope.txtMsgSend.trim();let max=160;if(event.keyCode===13&&message.length<=max){scope.sendMessage();return}if(message.length>max-1&&event.keyCode!==46&&event.keyCode!==8){scope.txtMsgSend=message.substring(0,max).trim();setScope();return false}}}}}]);
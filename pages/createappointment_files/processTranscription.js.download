var evaService={currentEvaScope:null,setScope:function(getEvaScope){evaService.currentEvaScope=getEvaScope},getScope:function(){return evaService.currentEvaScope},processCommandFromFT:function(final_transcript,commandName,patientData,askEvaContext){evaService.setScope(getFloatingEVAScope());evaService.currentEvaScope.historyObj=[];evaService.processCommand(final_transcript,commandName,patientData,askEvaContext)},processCommandFromEVA:function(final_transcript,commandName,patientData,askEvaContext){evaService.setScope(getEVAScope());evaService.processCommand(final_transcript,commandName,patientData,askEvaContext);let historyObjLength=0;if(getEVAScope().historyObj){historyObjLength=getEVAScope().historyObj.length}if(historyObjLength>0&&getEVAScope().historyObj[historyObjLength-1].templateURL==="multiplePatientsView"){evaService.currentEvaScope.changePatientInEva(patientData.uid,evaService.currentEvaScope.patientChangeData.patientInEmr.uid,'multiplePatient')}},refreshEva:function(){evaService.currentEvaScope.reloadScope()},processCommand:function(final_transcript,commandName,patientData,askEvaContext){var filter=/[a-zA-Z 0-9'-]*/;if(!validate(filter,final_transcript,true)){final_transcript=""}evaService.preProcessor(final_transcript);var assistantResponse="";try{var requestObj=null;let contextData=askEvaContext?askEvaContext:null;evaglobal.currentscreenData=currentPageDetailForEva;requestObj={TrUserId:global.TrUserId,action:'getResponse',requestFrom:'assistant',authToken:eAuthToken,knowledgeArea:evaService.currentEvaScope.knowledgeLevel,currentscreenData:evaglobal.currentscreenData,contextData:JSON.stringify(contextData)};if(commandName&&patientData){requestObj.notes="";requestObj.processCommand=commandName;requestObj.patientData=JSON.stringify(patientData);requestObj.callOnClick=true}else{requestObj.notes=final_transcript;requestObj.callOnClick=false}postRequest(handleSuccess,handleFail);function postRequest(resolve,reject){$.post("/mobiledoc/eva.do",requestObj,function(res){if(res.error){reject(res)}else{resolve(res)}},'json').fail(function(res){reject(res)})}function handleSuccess(res){try{let commandGroup=evaService.getScope().commandGroup;let resetCommadGroups=res.template!=="askeva/askevatemplate.jsp";evaService.currentEvaScope.knowledgeLevel='eva';if(res.data&&commandGroup&&resetCommadGroups){let index=commandGroup.findIndex(x=>x.value===final_transcript);if(index!==undefined&&index>=0){commandGroup.splice(index,1)}if(res.data.commandGroup&&res.data.commandGroup.length>0){commandGroup.forEach(function(item){let commandGroupIndex=res.data.commandGroup.findIndex(x=>x.name===item.name);if(commandGroupIndex===-1){res.data.commandGroup.push(item)}})}else{res.data.commandGroup=commandGroup}}evaService.handleCommandGrouping([],60);if(res.data.commandName=="createtelwebEncounter"){if(!getPermission("TelephoneEncounter",global.TrUserId)){res.responseType=-1;evaService.pushAssistantResponse("You don't have permissions to access Telephone Encounters. Please contact your administrator.")}}switch(res.responseType){case 0:case 1:if(res.data.assistantData==undefined){evaService.pushAssistantResponse(res.instruction.responseString,res.audioString,res.data)}if(angular.isDefined(res.data.commandGroup)&&res.data.commandGroup.length>0){evaService.handleCommandGrouping(res.data.commandGroup,145)}if(res.template&&res.template!=""){evaService.pushAssistantTemplateResponse(res.template,res.data)}let fromScreen="Eva";evaService.currentEvaScope.changePatientInEva(res.patientId.toString(),evaService.currentEvaScope.patientChangeData.patientInEmr.uid,fromScreen);break;case 2:if(res.modalType&&res.modalType==1){evaService.openModalByService(res)}else{evaService.openModal(res)}evaService.pushAssistantResponse(res.instruction.responseString,"",res.data);break;case 3:evaService.pushAssistantResponse(res.instruction.responseString,"",res.data);if(res.jsp&&res.jsp!=""){window.location.href="#"+res.jsp}break;case-1:break;case'accessDenied':evaService.handleAccessDeniedMessages();break;default:evaService.pushAssistantResponse("Unable to fetch your request! Please try again");break}}catch(e){}evaService.postProcessor()}function handleFail(res){if(res.AssistantException){assistantResponse=res.errorText}else{assistantResponse="The server and I aren't coordinating right now, please try again"}evaService.handleCommandGrouping([],75);evaService.pushAssistantResponse(assistantResponse);evaService.resetInputmode()}}catch(e){}},processInterimResult:function(textFromServer){try{var scope=evaService.getScope();var interim_transcript='';var isFinalTranscript=false;interim_transcript=textFromServer;$('#TextId').css('display','flex');if(evaSpeechService.showWelcomeText){$('.welcome-text').animate({'display':'none','opacity':'0'},500,function(){});setTimeout(function(){$('.welcome-text').addClass('hide');if(evaService.currentEvaScope.smartPanelEva===false){evaglobal.inputField.focus()}else{evaFTglobal.inputField.focus()}},1e3);$('.brand-logo').animate({'display':'none','opacity':'0'},500,function(){});setTimeout(function(){$('.brand-logo').addClass('hide');if(scope.smartPanelEva===false){evaglobal.inputField.focus()}else{evaFTglobal.inputField.focus()}},1e3)}evaSpeechService.showWelcomeText=false;scope.SpeechText=evaSpeechService.linebreak(interim_transcript);evaService.refreshEva();if(scope.smartPanelEva===false){evaService.scrollToBottom()}$('.search-record-process').css('display','block')}catch(e){}},setScrollHeight:function(height_deduction){if($('.char-body').height()>0){if(eVAScope&&eVAScope.patientChangeData&&eVAScope.patientChangeData.showAlert){height_deduction=height_deduction+60}var height=$('.char-body').height()-height_deduction;if(height>100){let searchPanel=$('.chatscroll');searchPanel.height(height);searchPanel.jScrollPane({contentWidth:null,autoReinitialise:true});if(searchPanel.hasClass("jspScrollable")){searchPanel.jScrollPane({contentWidth:'0px',autoReinitialise:true})}}}},handleCommandGrouping:function(cammands_array,height_deduction){var scope=evaService.getScope();scope.commandGroup=cammands_array;if(scope.smartPanelEva===false){if(!evaglobal.restrictAction)evaService.setScrollHeight(height_deduction)}evaService.refreshEva();if(scope.smartPanelEva===false){if(cammands_array.length>0){setTimeout(function(){var o=$('.suggestion-list-wrapper').get(0);evaService.scrolled(o)},500)}}},scrolled:function(o){var this_=$('.suggestion-list-wrapper');if(this_.get(0).scrollWidth>this_.width()){$('.navigate-suggestion-list .btn-rounded').prop('disabled',false);$('.navigate-suggestion-list .btn-rounded').removeClass('disabled');if(o.scrollLeft===0){$('.navigate-suggestion-list .btn-rounded:first').prop('disabled',true).addClass('disabled')}if(o.offsetWidth+o.scrollLeft===o.scrollWidth){$('.navigate-suggestion-list .btn-rounded:last').prop('disabled',true).addClass('disabled');$('.navigate-suggestion-list .btn-rounded:first').prop('disabled',false).removeClass('disabled')}if(o.scrollLeft>0){$('.navigate-suggestion-list .btn-rounded:first').prop('disabled',false).removeClass('disabled')}}else{$('.navigate-suggestion-list .btn-rounded:first').prop('disabled',true);$('.navigate-suggestion-list .btn-rounded').addClass('disabled')}},processResult:function(textFromServer){try{recognizing=true;var scope=evaService.getScope();var isFinalTranscript=true;scope.SpeechText="";scope.startListening(false);$('#TextId').css('display','none');final_transcript=textFromServer;evaService.processCommand(final_transcript,false);$('.search-record-process').css('display','block')}catch(e){}},scrollToBottom:function(scrollToTopTemplateId){try{setTimeout(function(){var searchPanel=$('.chatscroll');var api=searchPanel.data('jsp');if(scrollToTopTemplateId){api.scrollToElement($('#scrollToTemplate'+scrollToTopTemplateId),{stickToTop:true},true)}else{if(evaService.currentEvaScope.smartPanelEva===false&&evaglobal.currentscope&&evaglobal.currentscope.scrollHere){api.scrollToElement($('#scrollToTemplate'+evaglobal.currentscope.templateId),{stickToTop:true},true)}else{if(evaService.currentEvaScope.smartPanelEva===false){api.scrollToBottom()}}}},1e3);if(!evaSpeechService.showWelcomeText){$('.icon-chat-landing').animate({'margin-top':'-140px'},500,function(){});$('.welcome-text').animate({'display':'none','opacity':'0'},500,function(){if(evaService.currentEvaScope.smartPanelEva===false){evaglobal.inputField.focus()}else{evaFTglobal.inputField.focus()}})}}catch(e){}},getPatientEncounterBasedOnFilterAssistant:function(patientId){try{var url="/mobiledoc/jsp/catalog/xml/getPtEncounters.jsp?PatientId="+patientId+"&EncOptions=0";url=makeURL(url);var xsrf='';var infoJson=JSON.parse(get('loggedInInfo'));var https=evaService.getScope().getHttp();return https({headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},dataType:'text',method:'POST',url:url,data:xsrf})}catch(e){}},openLatestPNForAssistant:function(encounters,patientId){try{var canCodesArray=getCancelledCodesCommon();for(var i=0;i<encounters.length;i++){if(checkCancelledStatus(encounters[i].status,canCodesArray)||!validEncType(encounters[i].encType)){encounters.splice(i,1);i=i-1}}if(encounters.length&&encounters.length>0){$('.search-panel').fadeOut();var encId=evaService.getDefaultEncounterId(encounters);var http=evaService.getScope().getHttp();if(parseInt(encId)>0){doChecksForPN(encId,patientId,http,"patient_hub")}else{doChecksForPN(encounters[0].encounterID,patientId,http,"patient_hub")}}else{evaService.pushAssistantResponse("There are no valid encounters to be viewed for this patient.","","eClinicalWorks")}}catch(e){}},openPNForAssistant:function(encId,patientId){try{var http=evaService.getScope().getHttp();doChecksForPN(encId,patientId,http,"patient_hub")}catch(e){}},getDefaultEncounterId:function(encounters){var encId=0;try{for(var i=0;i<encounters.length;i++){var encDate=parseStringToDate(encounters[i].date,"yyyy-mm-dd","-");if(encDate!==''){var date=new Date;date=new Date(date.getFullYear(),date.getMonth(),date.getDate());var diff=days_between_wo_abs(encDate,date);if(diff<=0){encId=encounters[i].encounterID;break}}}}catch(e){}return encId},openProgressNote:function(ptId){try{evaService.getPatientEncounterBasedOnFilterAssistant(ptId).success(function(data){var encounters=getPatientEncountersForTab(data);encounters,ptId})}catch(e){}},getEncounterIdFromPatientId:function(id){let encounterId=0;var enc=getPatientEncounters(id);if(enc!=undefined){if(enc.length!=undefined)encounterId=enc[0].encounterID;else encounterId=enc.encounterID}return encounterId},getPatientDemograpicForAssistant:function(id){var encounterId=0;try{var enc=getPatientEncounters(id);if(enc!=undefined){if(enc.length!=undefined)encounterId=enc[0].encounterID;else encounterId=enc.encounterID}var serverUrl=makeURL('/mobiledoc/jsp/webemr/toppanel/patientHub/fetchPatientHub.jsp?pid='+id+'&encounterId='+encounterId);return urlGet(serverUrl)}catch(e){}},pushAssistantResponse:function(responseString,audioString,data){try{var eVAScope=evaService.getScope();if(data&&typeof data==='object'){let executedCommandObj=eVAScope.historyObj[eVAScope.historyObj.length-1];eVAScope.addCommandMeta(data.commandName,executedCommandObj);eVAScope.markExecutedCommandIfFavorite(executedCommandObj)}if(eVAScope.smartPanelEva===false){eVAScope.historyObj.push({responseString:responseString,source:'assistant',timeStamp:moment().format('hh:mm A'),templateIndexToScroll:Math.random()*999|0})}evaService.refreshEva();let audioStr=audioString&&audioString!==""?audioString:responseString;evaService.setTTS(audioStr)}catch(e){}},pushUserRequest:function(transcript){try{var eVAScope=evaService.getScope();eVAScope.historyObj.push({responseString:transcript,source:'me',timeStamp:moment().format('hh:mm A'),userString:transcript,templateIndexToScroll:Math.random()*999|0,isRecentCommand:true})}catch(e){}},pushAssistantTemplateResponse:function(template,data){try{let scope=evaService.getScope();data.historyObj=scope.historyObj;if(scope.assistantData.length==0){scope.assistantData[0]=data}else{scope.assistantData[scope.assistantData.length]=data}obj={isHTML:true,templateURL:template,source:'assistant',timeStamp:moment().format('hh:mm A'),templateIndexToScroll:Math.random()*999|0};if(data.isRecentCommand){obj.isRecentCommand=data.isRecentCommand;obj.userString='Select '+data.patient.name}if(scope.smartPanelEva===false){scope.historyObj.push(obj)}else{scope.historyObj=[];scope.historyObj.push(obj)}}catch(e){}},handleAccessDeniedMessages:function(res){let scope=evaService.getScope();evaService.pushAssistantResponse("I do not have permission to answer this query.");if(scope.assistantData.length==0){scope.assistantData[0]={}}else{scope.assistantData[scope.assistantData.length]={}}obj={isHTML:true,templateURL:"accessDenied",source:'assistant',timeStamp:moment().format('hh:mm A'),templateIndexToScroll:Math.random()*999|0};scope.historyObj.push(obj)},openModal:function(res){let scope=evaService.getScope();scope.getOcLazyLoadObj().load({name:res.modulename,files:res.js}).then(function(){scope.assistantModalUrl=makeURL(res.jsp)},function(e){})},speak:{text:"",isEnable:false,audioObj:new Audio},setTTS:function(text){evaService.speak.text=text},startTTS:function(){evaService.speak.isEnable=true},endTTS:function(){var speakAudio=evaService.speak.audioObj;if(speakAudio&&speakAudio!=null&&!speakAudio.paused){speakAudio.pause()}speakAudio=null;evaService.speak.isEnable=false},speakText:function(){var _speakText=evaService.speak.text;var speakAudio=evaService.speak.audioObj;if(_speakText!==""&&evaService.speak.isEnable){var url=getTextOfSpeech(_speakText,eAuthToken);if(!speakAudio){speakAudio=new Audio}if(url!="Text string is empty."){speakAudio.src=url;speakAudio.play()}}},resetInputmode:function(){let scope=evaService.getScope();scope.thinking=false;scope.changeInputMode('text');evaService.refreshEva();if(scope.smartPanelEva===false){evaglobal.inputField.focus()}else{evaFTglobal.inputField.focus()}},postProcessor:function(){if(evaService.currentEvaScope.smartPanelEva===false){evaglobal.currentscope=null;cleanUpChathistory();evaService.speakText();evaSpeechService.showWelcomeText=false;evaService.scrollToBottom();evaService.resetInputmode()}else{evaFTglobal.currentscope=null;evaService.speakText();evaSpeechService.showWelcomeText=false;evaService.resetInputmode()}},preProcessor:function(transcript){var scope=evaService.getScope();scope.listening=false;scope.thinking=true;if(transcript&&transcript!=""&&evaService.currentEvaScope.smartPanelEva===false){evaService.pushUserRequest(transcript);evaService.refreshEva()}},scrollToTop:function(){let searchPanel=$('.chatscroll');let api=searchPanel.data('jsp');api.scrollByY(-api.getContentPositionY())},previousTempObj:{"askEvaOverlay":""},disablePreviousTemplate:function(key,value){let val=evaService.previousTempObj[key];if(val!==""){$("#"+key+val).show()}evaService.previousTempObj[key]=value},saveAiSetting:function(flagValue){let url=makeURL('/mobiledoc/jsp/webemr/assistant/assistantController.jsp');if(evaService.getScope()==null){evaService.setScope(getEVAScope())}var https=evaService.getScope().getHttp();let result=https({headers:{'Content-Type':'application/json; charset=UTF-8'},dataType:'json',method:'POST',url:url,params:{action:"saveAiSetting",evaFloatingIconRequiredOnLogin:flagValue}}).then(function(result){if(result!==undefined&&result!==''&&result!==null){var data=result.data.replace(/\W/g,'');if("true"===data){isEvaFloatingIconRequiredOnLogin=flagValue;$('#evaSettingConfirmDia').modal('hide')}}})}};
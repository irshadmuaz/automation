var isTelemedSupported=true;var isVideoCallRunning=false;var multipleVideoReferences={};var masterDestroyConnectionCalled=false;var videoDestroyConnectionCalled=false;var multipleMasterUserReferenecs={};var callingInfo={};angular.module("ecw.telemed.service").service('rosterService',function($http){return{invokeService:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp?"+param),data:"",headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},downloadQuestionaire:function(){var param={action:'downloadQuestionaire'};param=$.param(param);try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}},getEncodedEncryptedParams:function(ptId,encId){var param={trUserId:global.TrUserId,ptId:ptId,encId:encId,action:'getEncodedEncryptedParams'};param=$.param(param);try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){}}}}).service('opentokService',function($http){var isInitalized=false;var isGeneralSessionInit=false;var session;var generalSession;return{init:function(sessionId){try{var apikey=document.getElementById("apikey").value;session=OT.initSession(apikey,sessionId);isInitalized=true;OT.setLogLevel(OT.NONE)}catch(err){}},getSession:function(){if(!isInitalized)this.init();return session},destorySession:function(){if(session!=null){session.off();session.disconnect()}session=null},initGeneralSession:function(apikey,sessionId){try{this.destroyGeneralSession();generalSession=OT.initSession(apikey,sessionId);isGeneralSessionInit=true}catch(error){console.log("Error in init general session ::>"+error.message)}},getGeneralSession:function(){if(!isGeneralSessionInit)this.initGeneralSession();return generalSession},destroyGeneralSession:function(){if(generalSession){generalSession.disconnect();generalSession.off();generalSession=null}}}}).service('opentokVideoService',function($http){var session=null;return{init:function(apikey,sessionId){try{session=OT.initSession(apikey,sessionId)}catch(err){console.log(err)}},getSession:function(){return session},destorySession:function(){if(session!=null){session.off();session.disconnect()}session=null}}}).service('patientDocumentService',["$http","EncDetailsService",function($http,encDetailsService){return{getImages:function(encounterId){var param={action:'getImages',trUserId:global.TrUserId,encId:encounterId};param=$.param(param);return $http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp?"+param),data:"",headers:{'Content-Type':'application/x-www-form-urlencoded'}})},uploadImageScannedDoc:function(encId,ptid,filename,customname,reason,scannedDate,folderDirPath){var encObj=encDetailsService.getEncDetailsByEncId(encId);var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('return');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('Document');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,"ReportId","0",'xsi:type','xsd:string');addElement(xw,"FileName",filename,'xsi:type','xsd:string');addElement(xw,"DirPath",folderDirPath,'xsi:type','xsd:string');addElement(xw,"FtpServer","",'xsi:type','xsd:string');addElement(xw,"CustomName",customname,'xsi:type','xsd:string');addElement(xw,"EncounterId",encId,'xsi:type','xsd:string');addElement(xw,"PatientId",ptid,'xsi:type','xsd:string');addElement(xw,"ScannedDate",scannedDate,'xsi:type','xsd:string');addElement(xw,"ScannedBy",global.TrUserName,'xsi:type','xsd:string');addElement(xw,"Description",reason,'xsi:type','xsd:string');addElement(xw,"Review","1",'xsi:type','xsd:string');addElement(xw,"ReviewerId",encObj.providerId,'xsi:type','xsd:string');addElement(xw,"ReviewerName",global.TrUserName,'xsi:type','xsd:string');addElement(xw,"FacilityId",global.facilityId,'xsi:type','xsd:string');addElement(xw,"Priority","0",'xsi:type','xsd:string');addElement(xw,"AttachTo","EMR",'xsi:type','xsd:string');addElement(xw,"ReviewDocAndLab","0",'xsi:type','xsd:string');addElement(xw,"PublishToeHX","0",'xsi:type','xsd:string');addElement(xw,"pncatId","0",'xsi:type','xsd:string');addElement(xw,"pnitemId","0",'xsi:type','xsd:string');addElement(xw,"EhxConsentDoc","1",'xsi:type','xsd:string');xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();var xsrf=$.param({action:'uploadImageScannedDoc',trUserId:global.TrUserId,encId:encId,FormData:xml});return $http({url:'/mobiledoc/jsp/telemed/telemedResponse.jsp',method:'post',transformRequest:[],headers:{'Content-Type':'application/x-www-form-urlencoded'},data:xsrf})},uploadImage:function(id,filename,encounterId,documentId){var xsrf=$.param({action:'uploadImage',trUserId:global.TrUserId,filename:filename,encounterId:encounterId,documentId:documentId,imageId:id});return $http({url:'/mobiledoc/jsp/telemed/telemedResponse.jsp',method:'post',transformRequest:[],headers:{'Content-Type':'application/x-www-form-urlencoded'},data:xsrf})},storeImage:function(encId,image,ptId){var xsrf=$.param({action:'storeImage',trUserId:global.TrUserId,encId:encId,ptId:ptId,dataURL:image});return $http({url:'/mobiledoc/jsp/telemed/telemedResponse.jsp',method:'post',transformRequest:[],headers:{'Content-Type':'application/x-www-form-urlencoded'},data:xsrf})},deleteImages:function(encId){var xsrf=$.param({action:'deleteImages',trUserId:global.TrUserId,encId:encId});return $http({url:'/mobiledoc/jsp/telemed/telemedResponse.jsp',method:'post',transformRequest:[],headers:{'Content-Type':'application/x-www-form-urlencoded'},data:xsrf})},deleteImageById:function(id){var xsrf=$.param({action:'deleteImageById',trUserId:global.TrUserId,id:id});return $http({url:'/mobiledoc/jsp/telemed/telemedResponse.jsp',method:'post',transformRequest:[],headers:{'Content-Type':'application/x-www-form-urlencoded'},data:xsrf})}}}]).service('compatibilityService',function($http){var me={checkBrowser:function(){var UrAgent=navigator.userAgent;var browser='';var verOffset='';var version='';if((verOffset=UrAgent.indexOf('OPR'))!=-1){browser='Opera';version=UrAgent.substring(verOffset+4);if((verOffset=UrAgent.indexOf('Version'))!=-1){version=UrAgent.substring(verOffset+8)}return browser+"."+version}else if((verOffset=UrAgent.indexOf('MSIE'))!=-1){isIE=true;browser='Internet Explorer';version=UrAgent.substring(verOffset+5);var iversion=parseFloat(version);if(iversion<9){return browser+"."+iversion+".iversion"}else{return browser+"."+iversion}}else if((verOffset=UrAgent.indexOf('Chrome'))!=-1){browser='Chrome';version=UrAgent.substring(verOffset+7);return browser+"."+version}else if((verOffset=UrAgent.indexOf('Safari'))!=-1){browser='Safari';version=UrAgent.substring(verOffset+7);if((verOffset=UrAgent.indexOf('Version'))!=-1){version=UrAgent.substring(verOffset+8)}return browser+"."+version}else if((verOffset=UrAgent.indexOf('Firefox'))!=-1){browser='Firefox';version=UrAgent.substring(verOffset+8);return browser+"."+version}else if(UrAgent.indexOf('Trident/')!=-1){isIE=true;browser='Internet Explorer';version=UrAgent.substring(UrAgent.indexOf('rv:')+3);return browser+"."+version}else{nameOffset=UrAgent.lastIndexOf(' ')+1;verOffset=UrAgent.lastIndexOf('/');if(nameOffset<verOffset){browser=UrAgent.substring(nameOffset,verOffset);version=UrAgent.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName}return browser+"."+version}}},isCompatible:function(callback){var browsercheck=true;var browser=me.checkBrowser();var browsersplit=browser.split(".");var browsername=browsersplit[0];var browserversion=browsersplit[1];if(browsername.indexOf("Safari")==0){browsercheck=false}else if(browsername.indexOf("Internet")==0){browsercheck=false}else if(browsername.indexOf("Chrome")==0){var minbroversion=browserversion.split(".");if(parseInt(minbroversion[0],10)<23)browsercheck=false}else if(browsername.indexOf("Firefox")==0){var minbroversion1=browserversion.split(".");if(parseInt(minbroversion1[0],10)<22)browsercheck=false}else if(browsername.indexOf("Opera")==0){var minbroversion2=browserversion.split(".");if(parseInt(minbroversion2[0],10)<18)browsercheck=false}else{browsercheck=false}if(typeof callback=="function"){callback(browsercheck)}}};return me}).service('internetConnection',['opentokService','$timeout',function(opentokService,$timeout){var secondTimerObj=null;var maxTimerSeconds=30;var timerSeconds=maxTimerSeconds;var maxRetrialAttempt=5;var manualReattempt=false;var retrial=maxRetrialAttempt;var isRetrying=false;var isConnected=false;var service={lost:function(success,errorCallBack){service.clearTimeout();timerSeconds=maxTimerSeconds;isRetrying=false;if(retrial>0){secondTimerObj=$timeout(function(){service.updateTimer(success,errorCallBack)},1e3)}else{if(typeof errorCallBack==="function"){retrial=maxRetrialAttempt;errorCallBack()}}},clearTimeout:function(){if(secondTimerObj){$timeout.cancel(secondTimerObj);secondTimerObj=null}},getTimer:function(){return timerSeconds},updateTimer:function(success,errorCallBack){timerSeconds--;service.clearTimeout();if(timerSeconds===0){service.retry(success,errorCallBack,false)}else{secondTimerObj=$timeout(function(){service.updateTimer(success,errorCallBack)},1e3)}},getRetrivalStatus:function(){return isRetrying},getManualReattemptStatus:function(){return manualReattempt},retry:function(success,errorCallBack,retryingAttempt){manualReattempt=retryingAttempt;isRetrying=true;retrial--;opentokService.getSession().connect(document.getElementById("tokenId").value.replace(/(\r\n|\n|\r)/gm,""),function(error){if(!error){if(!isConnected&&typeof success==="function"){isConnected=true;retrial=maxRetrialAttempt;success()}}else{if(manualReattempt===true&&typeof errorCallBack==="function"){retrial=maxRetrialAttempt;manualReattempt=false;errorCallBack()}else{service.lost(success,errorCallBack)}}})},resetConnectionStatus:function(){isConnected=false},resetManualReattempt:function(){manualReattempt=false}};return service}]).factory('mySharedService',function($rootScope){var sharedService={};sharedService.encounterId='';sharedService.patientId='';sharedService.userId='';sharedService.providerID='';sharedService.isLocked=false;sharedService.isInOtherProgressNote=null;sharedService.prismaOpenedFrom="";sharedService.nextEncounterId=null;sharedService.nextPatientId=null;sharedService.nextUserId=null;sharedService.nextProviderID=null;sharedService.prepForBroadcast=function(encounterId,patientId,userId,providerID){if(!sharedService.isLocked){sharedService.encounterId=encounterId;sharedService.patientId=patientId;sharedService.userId=userId;sharedService.providerID=providerID}else{sharedService.nextEncounterId=encounterId;sharedService.nextPatientId=patientId;sharedService.nextUserId=userId;sharedService.nextProviderID=providerID}if(sharedService.nextEncounterId!=null&&sharedService.encounterId!=sharedService.nextEncounterId){sharedService.isInOtherProgressNote=true}if(sharedService.nextEncounterId!=null&&sharedService.encounterId==sharedService.nextEncounterId){sharedService.isInOtherProgressNote=false}this.broadcastItem()};sharedService.outForBroadcast=function(){this.outbroadcastItem()};sharedService.broadcastItem=function(){if(sharedService.isLocked){$rootScope.$broadcast('inProgressNoteBroadcastLocked')}else{this.callInProgressNoteBroadcast()}};sharedService.outbroadcastItem=function(){$rootScope.$broadcast('outProgressNoteBroadcast')};sharedService.lock=function(){sharedService.isLocked=true};sharedService.unLock=function(){sharedService.isLocked=false};sharedService.inProgressNoteBroadcast=function(){};sharedService.callInProgressNoteBroadcast=function(){if(sharedService.inProgressNoteBroadcast){sharedService.inProgressNoteBroadcast()}};sharedService.setInProgressNoteBroadcastFn=function(inProgressNoteBroadcastFn){sharedService.inProgressNoteBroadcast=inProgressNoteBroadcastFn};sharedService.swapEncounter=function(){sharedService.encounterId=sharedService.nextEncounterId;sharedService.nextEncounterId=null;sharedService.patientId=sharedService.nextPatientId;sharedService.nextPatientId=null;sharedService.userId=sharedService.nextUserId;sharedService.nextUserId=null;sharedService.providerID=sharedService.nextProviderID;sharedService.nextProviderID=null};return sharedService}).filter('orderObjectBy',function(){return function(items,field,reverse){var filtered=[];angular.forEach(items,function(item){filtered.push(item)});filtered.sort(function(a,b){return a[field]>b[field]?1:-1});if(reverse){filtered.reverse()}return filtered}}).directive('resizable',function(){return{restrict:'A',scope:{callback:'&onResize'},link:function postLink(scope,elem,attrs){elem.resizable({handles:'n, e, s, w, ne, se, sw, nw',minWidth:595,minHeight:465});elem.on('resize',function(evt,ui){scope.$apply(function(){if(scope.callback){scope.callback({$evt:evt,$ui:ui})}})})}}});angular.module('ecw.telemed',['ecw.telemed.service','ngSanitize','HealowConnect']).directive('telemedcontrol',function(rosterService,opentokService,opentokVideoService,internetConnection,$timeout,$http,mySharedService,patientDocumentService,$window,compatibilityService,$sce,$compile,$modal,$ocLazyLoad,telemedRosterPresenceService,telemedLoggingService,telemedCallRunningService,telemedInviteService,telemedCallBandwidthService,SessionService,SunohService){return{restrict:'A',replace:'true',templateUrl:'/mobiledoc/jsp/webemr/telemed/televisit-tpl.html',scope:{callContext:"=?callcontext"},link:function(scope){function sendDetailsToJTN(callReason,inviteid,teleVisitConv,teleVisitOrgConv,summary,convoId,callback){try{let param=telemedInviteService.utils.getRequestObject(callReason,inviteid,scope,LOG_REASONS);if(param[inviteid]){param[inviteid]["telemedCallBandwidthLog"]=telemedCallBandwidthService.logCallBandwidthDetails()}stopRecordingDateTime=getCurrentDateTime();if((scope.isUserModerator||callReason===LOG_REASONS.REASON_PROVIDER_CHECKEDOUT_CALL)&&scope.providerPatientOrgConv.length>0&&scope.providerPatientConv!==''&&scope.isUserStartedTranscription){scope.isUserModerator=false;scope.isUserStartedTranscription=false;processingSummaryCSS();notifySummaryStatus();storeSunohRecording()}$http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp"),data:"action=sendDetailsToJTN&data="+encodeURIComponent(JSON.stringify(param)),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){callback(data,teleVisitOrgConv)}).error(function(err){telemedLoggingService.error("Error while sending details ::> "+err)});if(callReason===5||callReason===8){delete telemedInviteService.utils.participantDetail[inviteid]}}catch(err){telemedLoggingService.error("Error while sending details ::> "+err)}}window.onbeforeunload=function(event){try{if(scope.isVideoCallRunning){if(scope.staffInviteId==0){if(scope.isUserStartedTranscription){sendSignalToEnableAction()}sendDetailsToJTN(LOG_REASONS.REASON_PROVIDER_DISCONNECTED_CALL,0,scope.providerPatientConv,scope.providerPatientOrgConv,scope.gptAnalysis,scope.convoId,isSummaryUpdated)}}opentokService.destroyGeneralSession()}catch(err){telemedLoggingService.error("Issue while updating the log "+err)}};function restrictBoundary(event,ui){var maxMenuWidth=$(".main-wrap").width();var maxMenuHeight=$(".main-wrap").height()+$("#JellyBeanCountCntrl").height();var widthOfDiv=0;var heightOfDiv=0;var tmpEle=$('.chatbox');if(tmpEle){heightOfDiv=tmpEle.height();widthOfDiv=tmpEle.width()}if(ui.position.top+heightOfDiv>=maxMenuHeight){ui.position.top=maxMenuHeight-heightOfDiv}var leftPosition=ui.position.left;if(leftPosition+widthOfDiv>=maxMenuWidth){ui.position.left=maxMenuWidth-widthOfDiv}}scope.prismaDivId="teleVisitView_"+scope.$id;scope.isHttps=true;scope.isHttp=true;if(location.protocol!='https:'){scope.isHttps=false}$('.chatbox').draggable({containment:".main-wrap",scroll:false,drag:restrictBoundary});$("#me_"+scope.$id).draggable({containment:"#videoContainer",scroll:false});$('#videoContainer').hover(function(){$('#teleFooter').animate({bottom:"0"},{queue:false})},function(){$('#teleFooter').animate({bottom:"-60px"},{queue:false})});$('.stickyTabList > .contpad > a').click(function(e){e.preventDefault();$('.stickyContentPane').removeClass('hidden')});$('.btnlistview').on('click',function(){if($('#stickyViewVital').hasClass('active')){$('#stickyViewVital').removeClass('active');$('#stickyViewVital').css('display','none')}if($('#stickyViewquestionnaire').hasClass('active')){$('#stickyViewquestionnaire').removeClass('active');$('#stickyViewquestionnaire').css('display','none')}if($('#stickyViewchat').hasClass('active')){$('#stickyViewchat').removeClass('active');$('#stickyViewchat').css('display','none')}});$('#vitalview').click(function(e){e.preventDefault();if($('#docViewquestionnaire').hasClass('active')){$('#docViewquestionnaire').removeClass('active');$('#docViewquestionnaire').css('display','none')}if($('#docViewVital').hasClass('active')){$('#docViewVital').removeClass('active');$('#docViewVital').css('display','none')}else{$('#docViewVital').addClass('active');$('#docViewVital').css('display','block')}});$('#stickyvitalview').click(function(e){e.preventDefault();if($('#stickyViewquestionnaire').hasClass('active')){$('#stickyViewquestionnaire').removeClass('active');$('#stickyViewquestionnaire').css('display','none')}if($('#stickyViewchat').hasClass('active')){$('#stickyViewchat').removeClass('active');$('#stickyViewchat').css('display','none')}if($('#stickyViewVital').hasClass('active')){$('#stickyViewVital').removeClass('active');$('#stickyViewVital').css('display','none')}else{$('#stickyViewVital').addClass('active');$('#stickyViewVital').css('display','block')}});$('#questionnaireview').click(function(e){e.preventDefault();if($('#docViewVital').hasClass('active')){$('#docViewVital').removeClass('active');$('#docViewVital').css('display','none')}if($('#docViewquestionnaire').hasClass('active')){$('#docViewquestionnaire').removeClass('active');$('#docViewquestionnaire').css('display','none')}else{$('#docViewquestionnaire').addClass('active');$('#docViewquestionnaire').css('display','block')}});$('#stickyquestionnaiview').click(function(e){e.preventDefault();if($('#stickyViewVital').hasClass('active')){$('#stickyViewVital').removeClass('active');$('#stickyViewVital').css('display','none')}if($('#stickyViewchat').hasClass('active')){$('#stickyViewchat').removeClass('active');$('#stickyViewchat').css('display','none')}if($('#stickyViewquestionnaire').hasClass('active')){$('#stickyViewquestionnaire').removeClass('active');$('#stickyViewquestionnaire').css('display','none')}else{$('#stickyViewquestionnaire').addClass('active');$('#stickyViewquestionnaire').css('display','block')}});$('#stickychatview').click(function(e){e.preventDefault();if($('#stickyViewVital').hasClass('active')){$('#stickyViewVital').removeClass('active');$('#stickyViewVital').css('display','none')}if($('#stickyViewquestionnaire').hasClass('active')){$('#stickyViewquestionnaire').removeClass('active');$('#stickyViewquestionnaire').css('display','none')}if($('#stickyViewchat').hasClass('active')){$('#stickyViewchat').removeClass('active');$('#stickyViewchat').css('display','none')}else{$('#stickyViewchat').addClass('active');$('#stickyViewchat').css('display','block');scope.missedMsg=0;$("#stickyviewtxtMsgSend").focus();if($('#chat-display')[0]!=undefined&&$('#chat-display').scrollTop($('#chat-display')[0].scrollHeight)!=undefined){$('#chat-display').scrollTop($('#chat-display')[0].scrollHeight)}}});$('#rosterMainDiv a').click(function(e){e.preventDefault();if($('#docViewVital').hasClass('active')){$('#docViewVital').removeClass('active');$('#docViewVital').css('display','none')}if($('#docViewquestionnaire').hasClass('active')){$('#docViewquestionnaire').removeClass('active');$('#docViewquestionnaire').css('display','none')}if($('#stickyViewVital').hasClass('active')){$('#stickyViewVital').removeClass('active');$('#stickyViewVital').css('display','none')}if($('#stickyViewquestionnaire').hasClass('active')){$('#stickyViewquestionnaire').removeClass('active');$('#stickyViewquestionnaire').css('display','none')}if($('#stickyViewchat').hasClass('active')){$('#stickyViewchat').removeClass('active');$('#stickyViewchat').css('display','none')}if($('#televisit-tplUl113').is(":visible")&&scope.loginUserType==scope.USER_TYPE_PROVIDER){$("#televisit-tplUl113").hide();$("#televisit-tplUl114").hide()}});let LOG_REASONS={ONLY_PROVIDER:0,REASON_PROVIDER_DISCONNECTED_CALL:1,REASON_PROVIDER_INTERRUPTED_CALL:2,REASON_PROVIDER_CHECKEDOUT_CALL:3,REASON_PATIENT_DISCONNECTED_CALL:4,REASON_PATIENT_ENDED_CALL:5,CALL_IS_ON_HOLD:6,REASON_CONTACT_DISCONNECTED_CALL:7,REASON_CONTACT_ENDED_CALL:8};var props={maxRatio:3/2,minRatio:9/16,fixedRatio:false,scaleLastRow:true,alignItems:'center',bigClass:"OT_big",bigPercentage:.8,minBigPercentage:0,bigFixedRatio:false,bigScaleLastRow:true,bigAlignItems:'center',smallAlignItems:'center',maxWidth:Infinity,maxHeight:Infinity,smallMaxWidth:Infinity,smallMaxHeight:Infinity,bigMaxWidth:Infinity,bigMaxHeight:Infinity,bigMaxRatio:3/2,bigMinRatio:9/16,bigFirst:true,animate:true,window:window,ignoreClass:'OT_ignore',onLayout:null};var containerC2Call;var msgTimer=null;var sec=-1,min=0,hour=0,timer=null;var minWidth=595,minHeight=335;var jcrop_api;var errorStatustimeout=3e3;var Alerts={ERROR:1,WARNING:2,STATUS:3,SUCCESS:4,LINK:5};scope.USER_TYPE_PROVIDER=1;scope.USER_TYPE_STAFF=2;scope.loginUserType=scope.USER_TYPE_PROVIDER;scope.callAlreadyInProgress=false;scope.showMsgCallAlreadyInProgress=false;scope.msgCallAlreadyInProgress="Call is already in Progress with this patient.";let isGroupDocumentationEnabled="yes";let rejoinAfterForceDisconnect=false;let multipleVideoConnections={};let callRunningUserID;var timertosendNotification;var timerforsuccessmsg;scope.users=[];scope.inviteList=[];scope.invitedUserList=[];scope.staffInviteId=0;scope.invitebyId=0;scope.convoId=0;scope.inviterName='';scope.joinRequestSent=false;scope.isAdmitResponseReceived=false;scope.isCompatible=true;scope.isInProgressNote=false;scope.callRunningEncId=0;scope.isVideoCallRunning=false;telemedCallRunningService.clearCallRunning();scope.isPublishing=false;scope.stickyNoteView=false;scope.dockView=false;scope.fullView=false;scope.isFullScreen=false;scope.onTop=true;scope.showQuestionnaire=true;scope.showImgCaptControl=true;scope.subscriber;scope.screenSubscriber;scope.isScreenSubscribed=false;scope.screenShareContainer;scope.publisher;scope.videoSessionData;scope.videoTokenData;scope.isStaffOnBehalf=false;scope.screenPublisher;scope.isScreenSharingRunning=false;scope.showScreenMsg=false;scope.isVideoPause=false;scope.isMuted=false;scope.time;scope.isPatientOnline=false;scope.reconnecting=false;scope.starttime=false;scope.VitalPage={popout:'',docked:'',sticky:'',hConnect:''};scope.trackersPage;scope.w=minWidth;scope.h=minHeight;scope.chats={};scope.teleView=0;scope.currentCallPatientName="";scope.inviterName="";scope.patientName="";scope.encounterId="";scope.appointmentTime="";scope.missedMsg=0;scope.onlinecount=0;scope.showLimitMsg=false;scope.onCallUserSet=new Set;scope.isAllowStaffProvider=false;scope.invitecount=0;scope.capturing=false;scope.magnify=false;scope.window=$(window);scope.callStatus="";scope.calling=false;scope.apptCount=0;scope.patientDocs=[];scope.isTvjellyHover=false;scope.questionnaires="";scope.hideQuestionnairesIntakeMsg=true;scope.enableQuestionnaireImportbtn=false;scope.docType="";scope.ad="";scope.someSafeContent="";scope.docName="";scope.qid="";scope.documentName="";scope.inviterUserId=0;scope.requestToJoinUserList=[];scope.pgNo="";scope.index="";scope.noOfPages="";scope.subQuestionnaires="";scope.mySharedServiceInstance=mySharedService;scope.showPtDocs=false;scope.showstickyviewcontrols=false;var isSwitchingCamera=false;scope.isCameraSwitching=false;var selectedVideoDeviceId="";var selectedAudioDeviceId="";scope.audioInputDevices=[];scope.videoInputDevices=[];scope.showImageUpload=false;scope.endTelevisitWithCheckoutFlag=false;scope.endTelevisitWithoutCheckoutFlag=false;scope.multipleLoginFound=false;scope.showMultipleLoginFoundMessage=false;scope.isScreenShot=false;scope.SnapDeleteId=-1;scope.SnapDeleteConfirmation=false;scope.isUploadMsgShow=false;var currentdate=new Date;var cdate=currentdate.getFullYear()+'-'+(currentdate.getMonth()+1)+'-'+currentdate.getDate();scope.snapLoading=false;scope.takesnapLoading=true;scope.isdeleteAll=false;scope.isInOtherProgressNote=false;scope.hasInternetConnection=true;var isNetworkDisconnected=false;scope.retrying="";scope.isHealowLive=true;scope.deleteSelectedSnaps=false;var isErrorCalled=false;scope.isVideoSessionConnected=true;scope.isMsgDisplay=true;scope.shownotificationLoader=false;scope.showPattientOffline=true;scope.showsuccessMsg=false;scope.appgoesBackgroungsignalreceived=false;scope.isHealowPlusUser=getItemKeyValue("isHealowPlusEnabled").toUpperCase()==='YES';scope.isTVPrivateChatEnabled=getItemKeyValue("TVPrivateChatEnabled").toUpperCase()==='YES';var clickedOnCopyCodeBtn=false;scope.showCallRunningMsg=false;scope.ptHangUp=false;scope.closedCaption="";scope.patientCaption="";scope.providerCaption="";scope.providerPatientConv="";scope.patientOrgCaption="";scope.providerOrgCaption="";scope.providerPatientOrgConv=[];scope.allowClosedCaption=false;scope.gptAnalysis={};scope.showclosedCaptionDiv=false;scope.disableCCAction=false;scope.tvAISummaryEnabled=isTVAISummaryEnabled;scope.displayCCBtn=false;scope.pauseCaption=false;scope.isUserStartedTranscription=false;scope.isUserModerator=false;let isSummaryGenerated=false;let isSummaryAvailable=false;let subscriberTranscript=null;let publisherTranscript=null;let allowPublisherClosedCaption=false;let publisherConnection=null;scope.translatorAdded=false;scope.isTranslatorEnabled=getItemKeyValue('TvAiTranslator').toUpperCase()==='YES';scope.patientLang="en";scope.providerLang="en";scope.isMaleVoice=0;scope.sourceLanguage="en";scope.targetLanguage="en";function setAudioVideoOnSessionExpired(flag){try{if(scope.isVideoCallRunning){scope.publisher.publishAudio(flag);scope.publisher.publishVideo(flag);scope.subscriber.subscribeToVideo(flag);scope.subscriber.subscribeToAudio(flag)}}catch(error){console.log("Error in TeleVisit setAudioVideoOnSessionExpired::> "+error)}}$('#sessionExpiredMessageModal').on('shown.bs.modal',function(){setAudioVideoOnSessionExpired(false)});$('#sessionExpiredMessageModal').on('hide.bs.modal',function(){setAudioVideoOnSessionExpired(true)});let isHealowPlusUser=getItemKeyValue("isHealowPlusEnabled").toUpperCase()==='YES';let televisitWrapperDIV=isHealowPlusUser?".healow-connect #containerDIV ":"#televisitWrapper ";$(televisitWrapperDIV+'#staticBackdrop').on('hide.bs.modal',function(){$(televisitWrapperDIV+"#invitePopupWrapper").css("pointer-events","")});scope.setTVContainerLayout=function(ms){setContainerLayout(ms)};var containerLayoutTimer;var screenLayoutTimer;function setContainerLayout(milliseconds){if(containerLayoutTimer){clearTimeout(containerLayoutTimer);containerLayoutTimer=null}if(screenLayoutTimer){clearTimeout(screenLayoutTimer);screenLayoutTimer=null}containerLayoutTimer=setTimeout(function(){if(containerC2Call){containerC2Call.layout();clearTimeout(containerLayoutTimer);containerLayoutTimer=null}if(scope.screenShareContainer){scope.screenShareContainer.layout()}},milliseconds);screenLayoutTimer=setTimeout(function(){if(scope.screenShareContainer){scope.screenShareContainer.layout();clearTimeout(screenLayoutTimer);screenLayoutTimer=null}},milliseconds)}var readjustSelfView=function(){if(scope.capturing){$(".playermenu").css('visibility','visible');scope.capturing=false;jcrop_api.destroy()}var v={width:$('#videoContainer').outerWidth(),height:$('#videoContainer').height(),left:$('#videoContainer').offset().left,top:$('#videoContainer').offset().top};var m={width:$("#me_"+scope.$id).outerWidth(),height:$("#me_"+scope.$id).height(),left:$("#me_"+scope.$id).offset().left,top:$("#me_"+scope.$id).offset().top};if(v.width+v.left-200<m.left||v.top+v.height-72<m.top){$("#me_"+scope.$id).offset({top:v.top+v.height-72,left:v.left+10})}if(scope.isScreenSharingRunning){var screemShareDIV=$('#screen-publisher');var m={width:screemShareDIV.outerWidth(),height:screemShareDIV.height(),left:screemShareDIV.offset().left,top:screemShareDIV.offset().top};if(v.width+v.left-200<m.left||v.top+v.height-72<m.top){screemShareDIV.offset({top:v.top+v.height-72,left:v.left+10})}}};scope.resize=function(evt,ui){$(".playermenu").css('visibility','visible');scope.w=ui.size.width;scope.h=ui.size.height-150;if(scope.w<=minWidth)scope.w=minWidth;if(scope.h<=minHeight)scope.h=minHeight;if(scope.capturing)jcrop_api.destroy();scope.capturing=false;readjustSelfView();telemedInviteService.utils.setHeightInviteeWrapper();setContainerLayout(20);if(scope.showUserNavigationMsg){resetModalHeight(true,scope.h)}};scope.showAppointments=function(){$("#rosterMainDiv").addClass("open")};scope.hideAppointments=function(){$("#rosterMainDiv").removeClass("open")};scope.updateAppointmentCount=function(){scope.apptCount=0;angular.forEach(scope.users,function(user){scope.apptCount+=1});scope.apptCount+=scope.invitedUserList.length};scope.togglePtDocs=function(){if(scope.showPtDocs){scope.showPtDocs=false}else{scope.showPtDocs=true}if(!scope.isHealowPlusUser){setContainerLayout(20)}};scope.viewPtDocs=function(){scope.showPtDocs=true;if(!scope.isHealowPlusUser){setContainerLayout(20)}};scope.mapAlertCssClass=function(whichAlert){if(whichAlert==Alerts.ERROR)return"alert alert-danger";else if(whichAlert==Alerts.WARNING)return"alert alert-warning";else if(whichAlert==Alerts.STATUS)return"alert alert-info";else if(whichAlert==Alerts.SUCCESS)return"alert alert-success";else if(whichAlert===Alerts.LINK){return"alert alert-danger text-center"}};scope.createAlertDown=function(div,alertType,headingtext,msgtext,autohide,autohidetime){$(div).show();$(div).attr("class","");$(div).addClass(scope.mapAlertCssClass(alertType));$(div).slideDown("slow",function(){$(div).find("#heading").html(headingtext);$(div).find("#msg").html(msgtext);if(autohide){msgTimer=setTimeout(function(){scope.createAlertUp(div,false,'')},autohidetime)}else{clearTimeout(msgTimer)}})};scope.createAlertDownWithRetryLink=function(div,alertType,headingtext,msgtext,autohide,autohidetime,retryTextLink){$(div).show();$(div).attr("class","");$(div).addClass(scope.mapAlertCssClass(alertType));$(div).slideDown("slow",function(){$(div).find("#heading").html(headingtext);$(div).find("#msg").html('');var temp=$compile(retryTextLink)(scope);angular.element(document.getElementById('msg')).append(msgtext);angular.element(document.getElementById('msg')).append(temp);if(autohide){msgTimer=setTimeout(function(){scope.createAlertUp(div,false,'')},autohidetime)}else{clearTimeout(msgTimer)}})};scope.createAlertUp=function(div,autohide,autohidetime){if(!$(div).is(":hidden")){$(div).slideUp("slow",function(){if(autohide){msgTimer=setTimeout(function(){$(div).hide()},autohidetime)}})}else{$(div).hide()}};scope.hideMsg=function(){scope.createAlertUp('#errorstatus',false,'')};scope.copyTVCode=function(code,encid,name,age,encTime){clickedOnCopyCodeBtn=true;name=name.replace(/-/g,',');let m=moment(new Date);var encdate=m.format('LL');var healowurl=getItemKeyValue("healowserverprotocol")+getItemKeyValue("healowservername");let isTvGenerationLinkEnabled=getItemKeyValue("tvgeneratelinkonappt").toUpperCase()==="YES";var content='healowTV link for '+name+','+age+'Y for appointment on '+encdate+' at '+encTime+" - ";var copiedContent="";if(isTvGenerationLinkEnabled){copiedContent=content+healowurl+'/apps/tv/custom/'+code}else{copiedContent=content+healowurl+'/apps/tv/'+code}const el=document.createElement('textarea');el.value=copiedContent;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);var elem='showcopy_'+encid;$('#'+elem).delay(10).fadeIn(400);$('#'+elem).delay(1500).fadeOut(400)};scope.handleErrorStatus=function(textstatus,status){if(textstatus=='timeout'){scope.createAlertDown('#errorstatus',Alerts.STATUS,'Timeout','Please try again.',true,errorStatustimeout)}else if(status==404){scope.createAlertDown('#errorstatus',Alerts.ERROR,'Status','Page not found.',true,errorStatustimeout)}else if(status==500){scope.createAlertDown('#errorstatus',Alerts.ERROR,'Status','Unable to reach eClinicalWorks.',true,errorStatustimeout)}else{scope.createAlertDown('#errorstatus',Alerts.ERROR,'Error','Something went Wrong.',true,errorStatustimeout)}};var inProgressTimer;scope.$on('inProgressNoteBroadcastLocked',function(){scope.isInProgressNote=true;scope.checkConflict();if(scope.isFullScreen){clearTimeout(inProgressTimer);inProgressTimer=setTimeout(function(){scope.isFullScreen=false;scope.fullScreen();clearTimeout(inProgressTimer);inProgressTimer=null},1e3)}});scope.$on('inProgressNoteBroadcast',function(){scope.inProgressNote()});scope.checkConflict=function(){scope.isInOtherProgressNote=mySharedService.isInOtherProgressNote;scope.showUserNavigationMsg=scope.isInOtherProgressNote;resetModalHeight(scope.showUserNavigationMsg);setScope()};function updateRosterList(newList){try{var oldList=scope.users;scope.users=newList;if($.isEmptyObject(newList)===false){if(Object.keys(oldList).length>0){for(var ol in oldList){var oldObj=oldList[ol];if(oldObj.groupvisit==="1"){var groupEncObj=scope.users[oldObj.encounterID];if(!groupEncObj||!groupEncObj["ptEncIds"]){continue}var newObj=groupEncObj["ptEncIds"];groupEncObj.totalParticipants=Object.keys(newObj).length;if(Object.keys(newObj).length>0){var onlineCount=0;for(var ptEncId in newObj){var tmpObj=oldObj["ptEncIds"];if(tmpObj&&tmpObj.hasOwnProperty(ptEncId)){newObj[ptEncId]=tmpObj[ptEncId];if(newObj[ptEncId]===true){onlineCount++}}}groupEncObj.onlineParticipants=onlineCount}}else{if(scope.users[oldObj.encounterID]!==undefined){scope.users[oldObj.encounterID].presence=oldObj.presence;scope.users[oldObj.encounterID].groupvisit="0"}}}}}else{scope.users=[]}scope.updateAppointmentCount()}catch(e){telemedLoggingService.error(e)}}function updateRosterListPresence(encId,presence){try{var oldList=scope.users;if(Object.keys(oldList).length>0){for(var ol in oldList){var oldObj=oldList[ol];if(oldObj.groupvisit==="1"){var groupEncObj=scope.users[oldObj.encounterID];if(!groupEncObj||!groupEncObj["ptEncIds"]){continue}var newObj=groupEncObj["ptEncIds"];groupEncObj.totalParticipants=Object.keys(newObj).length;if(Object.keys(newObj).length>0){var onlineCount=0;if(oldObj.onlineParticipants!==undefined){onlineCount=oldObj.onlineParticipants}for(var ptEncId in newObj){if(ptEncId===encId){newObj[ptEncId]=presence;if(presence===true){onlineCount++}else{onlineCount--}}}groupEncObj.onlineParticipants=onlineCount}}else{if(scope.users[oldObj.encounterID]!==undefined&&oldObj.encounterID===encId){scope.users[oldObj.encounterID].presence=presence;scope.isPatientOnline=presence}}}}}catch(e){telemedLoggingService.error(e)}telemedRosterPresenceService.notify(encId,presence)}function resetRosterListPresence(){var oldList=scope.users;if(Object.keys(oldList).length>0){for(var ol in oldList){var oldObj=oldList[ol];if(oldObj.groupvisit==="1"){var newObj=scope.users[oldObj.encounterID]["ptEncIds"];if(Object.keys(newObj).length>0){for(var ptEncId in newObj){newObj[ptEncId]=false;telemedRosterPresenceService.notify(ptEncId,false)}}scope.users[oldObj.encounterID]["onlineParticipants"]=0}else{scope.users[oldObj.encounterID].presence=false}}}}scope.getpatientData=function(){$http({method:"POST",url:makeURL('/mobiledoc/jsp/webemr/rightpanel/getpatientData.jsp'),cache:true,params:{nd:(new Date).getTime(),trigger:'demographics',patientId:mySharedService.patientId}}).success(function(data,status,headers,config){if(data!=null){scope.currentCallPatientName=data.fullname}}).error(function(data,status,headers,config){})};scope.inProgressNote=function(){if(typeof OT==="undefined"){scope.loadOTScript();return}SunohService.isTVOutPN=false;scope.hideInvitation();scope.joinRequestSent=false;scope.appgoesBackgroungsignalreceived=false;isSummaryAvailable=false;if(scope.isHealowLive===false||scope.isHttps===false||scope.multipleLoginFound==true)return;scope.getpatientData();if(scope.isVideoCallRunning)scope.checkConflict();var params={action:'telemedlist',trUserId:global.TrUserId,prID:mySharedService.providerID,userType:global.loginUserType,grpvisit:isGroupDocumentationEnabled,time:$("#time").val(),t:(new Date).getTime(),currentdate:cdate};params=$.param(params);rosterService.invokeService(params).success(function(data){updateRosterList(data);scope.enableQuestionnaireImportbtn=false;$(".tVquestionnaireContent").html('');$("#docview_patient_questionnaire_msg").html('');if($('#docViewquestionnaire').hasClass('active')){$('#docViewquestionnaire').removeClass('active');$('#docViewquestionnaire').css('display','none')}if($('#docViewVital').hasClass('active')){$('#docViewVital').removeClass('active');$('#docViewVital').css('display','none')}if(scope.users[mySharedService.encounterId]){scope.isPatientOnline=scope.users[mySharedService.encounterId].presence;scope.isInProgressNote=true}else{scope.isInProgressNote=false}if(scope.isVideoCallRunning==false){scope.starttime=false;var chkparam={action:'chkPatientOnlineFromApp',encId:mySharedService.encounterId};chkparam=$.param(chkparam);$http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp"),data:chkparam,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){if(data.trim()=="true"){scope.appgoesBackgroungsignalreceived=true}});if(scope.loginUserType===scope.USER_TYPE_STAFF||scope.USER_TYPE_PROVIDER===global.loginUserType){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/getEncInviteDetail"),data:{encId:mySharedService.encounterId,userId:global.TrUserId},type:"POST","async":false,success:function(data){if($.isEmptyObject(data)===false){scope.staffInviteId=data['inviteId'];scope.invitebyId=data['inviterId']}},error:function(e){console.log("get Staff Invite Detail ERROR :"+e.message)}})}scope.inviteeFeature.cleanupScope();telemedInviteService.bindListeners();setScope();var params={action:'getVideoSession',encID:mySharedService.encounterId,ptId:mySharedService.patientId,prId:mySharedService.providerID,userType:global.loginUserType,source:"WebEMR",t:(new Date).getTime(),invitedID:scope.staffInviteId};if(scope.staffInviteId>0){params.action='getInviteVideoSession';params.userName=global.TrUserName;params.inviterId=scope.invitebyId}params=$.param(params);rosterService.invokeService(params).success(function(data){if(data){if(scope.staffInviteId>0&&global.TrUserId!=mySharedService.providerID&&(scope.USER_TYPE_STAFF===global.loginUserType||scope.USER_TYPE_PROVIDER===global.loginUserType)){if(data.masterToken&&data.masterToken.length>0&&data.masterSession&&data.masterSession.length>0){scope.isStaffEnableforTv=data.isStaffAssociated;connectToMasterSession(data.masterSession,data.masterToken.replace(/(\r\n|\n|\r)/gm,""));$("#televisit-tplLink5").hide()}else{scope.createAlertDown('#errorstatus',Alerts.ERROR,'','Unable to connect televisit session',false,0);return}}else if(scope.staffInviteId==0&&global.TrUserId!=mySharedService.providerID&&scope.USER_TYPE_STAFF===global.loginUserType){if(data.masterToken&&data.masterToken.length>0&&data.masterSession&&data.masterSession.length>0){scope.isStaffEnableforTv=data.isStaffAssociated;if(scope.USER_TYPE_STAFF===global.loginUserType){$("#sessionId").val(data.masterSession);$("#tokenId").val(data.masterToken.replace(/(\r\n|\n|\r)/gm,""));connectToMasterSession(data.masterSession,data.masterToken.replace(/(\r\n|\n|\r)/gm,""))}}}scope.videoSessionData=data.videoSession;scope.videoTokenData=data.videoToken;scope.inviteeFeature.isInviteContactEnable=data.isInviteContactEnable;if(scope.staffInviteId==0&&scope.USER_TYPE_PROVIDER===global.loginUserType){scope.signalCallRunningStatus()}if(scope.staffInviteId>0){scope.onCallUserSet.clear();scope.signalCallRunningStatus();scope.inviterName=data.inviterName}}});rosterService.downloadQuestionaire().success(function(data){scope.loadQuestionnaire()});rosterService.getEncodedEncryptedParams(mySharedService.patientId,mySharedService.encounterId).success(function(data){var iframe=$('#trackerIframe');iframe.attr('src',data.baseURL+"/jsp/healowHub/patient_trackers.jsp?u="+data.token)})}else{rosterService.downloadQuestionaire().success(function(data){scope.loadQuestionnaire()});rosterService.getEncodedEncryptedParams(mySharedService.patientId,mySharedService.encounterId).success(function(data){var iframe=$('#trackerIframe');iframe.attr('src',data.baseURL+"/jsp/healowHub/patient_trackers.jsp?u="+data.token)});scope.reconnecting=true;scope.calling=false;telemedCallRunningService.clearCallRunning()}})};var callInProgressNote=function(){scope.inProgressNote()};mySharedService.setInProgressNoteBroadcastFn(callInProgressNote);scope.connectToVideoSession=function(){if(mySharedService.encounterId!=undefined&&multipleVideoReferences[mySharedService.encounterId]==1){delete multipleVideoReferences[mySharedService.encounterId]}opentokVideoService.destorySession();opentokVideoService.init(document.getElementById("apikey").value,scope.videoSessionData);opentokVideoService.getSession().connect(scope.videoTokenData.replace(/(\r\n|\n|\r)/gm,""),scope.connect);opentokVideoService.getSession().on("connectionCreated",scope.connectionCreatedHandler);opentokVideoService.getSession().on("streamCreated",scope.streamCreated);opentokVideoService.getSession().on("signal:patient",scope.signalRecievedHandler);opentokVideoService.getSession().on("signal:contact",signalRecievedHandlerContact);opentokVideoService.getSession().on("signal:handShakeCall",handShakeHandler);opentokVideoService.getSession().on("signal:textMessagePatient",scope.signalRecievedTextHandler);opentokVideoService.getSession().on("signal:textMessageContact",scope.signalRecievedTextHandler);opentokVideoService.getSession().on("signal:textMessageDoctor",scope.signalRecievedTextHandler);opentokVideoService.getSession().on("signal:textMessageStaff",scope.signalRecievedTextHandler);opentokVideoService.getSession().on("signal:disableActionEMR",scope.disableActionHandlerEMR);opentokVideoService.getSession().on("signal:switchToAudio",handlerForSwitchToAudio);opentokVideoService.getSession().on("signal:enableAction",enableActionHandler);opentokVideoService.getSession().on("signal:pauseTranscription",scope.pauseTranscriptionHandler);opentokVideoService.getSession().on("streamDestroyed",scope.streamDestroyedHandler);opentokVideoService.getSession().on("connectionDestroyed",scope.connectionDestroyedHandler);opentokVideoService.getSession().on("sessionDisconnected",scope.sessionDisconnectHandler);opentokVideoService.getSession().on("streamPropertyChanged",scope.streamPropertyChanged);opentokVideoService.getSession().on("signal:textMessageCamera",scope.patientDeviceSwitchingHandler);opentokVideoService.getSession().on("signal:setAudioVideo",scope.setAudioVideoHandler);opentokVideoService.getSession().on("signal:doctor",scope.hangupHandler)};scope.streamPropertyChanged=function(event){if(event.changedProperty==='videoDimensions'){setContainerLayout(750)}scope.inviteeFeature.setAudioVideoIcon(event);setScope()};scope.patientDeviceSwitchingHandler=function(event){telemedCallBandwidthService.clearBandwidthStream(mySharedService.patientId);if(scope.stickyNoteView===true||scope.dockView===true){scope.changeViewToFullView()}scope.createAlertDown('#errorstatus',Alerts.WARNING,'',event.data,true,5e3)};scope.closedCaptionHandler=function(event){if(event.data.encID===mySharedService.encounterId&&event.data.userId!==global.TrUserId){scope.providerCaption=event.data.role+": "+event.data.cc+".\n";scope.providerPatientConv=scope.providerPatientConv+scope.providerCaption;scope.closedCaption=event.data.cc;scope.role=event.data.role;let captionJson={};let detailedDesc={};captionJson['transcription']=event.data.cc;captionJson['speakerId']=event.data.role;detailedDesc['DisplayText']=event.data.cc;detailedDesc['SpeakerId']=event.data.role;captionJson['isTV']=1;captionJson['detailedTranscription']=detailedDesc;scope.providerPatientOrgConv.push(captionJson)}};scope.setAudioVideoHandler=function(event){let data=event.data;if(!data){return}if(data.unMuteAudio===false&&!scope.isMuted){scope.muteAudio();createAlertDown('#errorstatus',Alerts.WARNING,'','You have been muted by provider.',true,5e3)}else if(data.unBlockVideo===false&&!scope.isVideoPause){scope.pauseVideo();createAlertDown('#errorstatus',Alerts.WARNING,'','Your video has been blocked by provider.',true,5e3)}};scope.loadVitalsInfo=function(view){if(view==='hConnect'){scope.VitalPage[view]="/mobiledoc/jsp/portal/VitalsInfo_Tele.jsp?encounterId="+mySharedService.encounterId+"&uid="+mySharedService.patientId+"&f_load1=0&app=10e&"+"module="+"hConnect"+"&nd="+(new Date).getTime()}else{scope.VitalPage[view]="/mobiledoc/jsp/portal/VitalsInfo_Tele.jsp?encounterId="+mySharedService.encounterId+"&uid="+mySharedService.patientId+"&f_load1=0&app=10e&"+(new Date).getTime()}};scope.loadQuestionnaire=function(){$ocLazyLoad.load({files:['/mobiledoc/jsp/webemr/portal/formsConcurrency.js']}).then(function(){var responsePromise=$http.post(makeURL("/mobiledoc/jsp/webemr/portal/getQuestToBeImported.jsp?patientId="+mySharedService.patientId+"&encounterId="+mySharedService.encounterId+"&nd="+(new Date).getTime()));responsePromise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());var value=[];value=returnDataArray(jsonobj.Envelope.Body['return'].questionnaire);if(value){if(value.length>0){scope.questionnaires=value}}scope.hideQuestionnairesIntakeMsg=value.length>0&&scope.questionnaires.length>0;if(scope.hideQuestionnairesIntakeMsg){if(scope.isHealowPlusUser){$("#tvQuestionnaireModule").css({'height':480})}scope.QuestionnaireTabsClick(scope.questionnaires[0].id,scope.questionnaires[0].type,scope.questionnaires[0].docName,scope.questionnaires[0].pageNum,0,'',scope.questionnaires[0].MaxPageNum)}else{scope.enableQuestionnaireImportbtn=true;var msg="No intake forms are available for review at this time.<BR>If you're expecting additional information, reload the tab at a later time.";showQuestionnaireIntakeMessage(msg)}})})};function showQuestionnaireIntakeMessage(msg){if(scope.isHealowPlusUser){$("#tvQuestionnaireModule").html("<p style='  margin-top: 20%; margin-left: 20%;font-size: 15px;font-family: 'open_sanssemibold''>"+msg+"</p>");$("#tvQuestionnaireModule").css({'height':514});$("#questionnaireFooter").hide()}$("#docview_patient_questionnaire_msg").html("<p style='  margin-top: 20%; margin-left: 5%;'>"+msg+"</p>");$("#stickyview_patient_questionnaire_msg").html("<p style='  margin-top: 20%; margin-left: 5%;'>"+msg+"</p>");$("#popout_patient_questionnaire_msg").html("<p style='padding-top: 50px; margin-left: 5%;'>"+msg+"</p>")}scope.QuestionnaireTabsClick=function(questionnaireID,questionnaireType,questionnaireName,pageNum,questIndex,param,pageCount){$("#done").show();$("#skip").show();$("#reject").show();$("#importCurrent").show();$("#noOfPages").show();$('.importmsg').hide();var responsePromise="";questionnaireName=questionnaireName.trim();let queInviteId=scope.staffInviteId;if(scope.staffInviteId>0&&scope.loginUserType==scope.USER_TYPE_STAFF&&scope.isStaffEnableforTv){queInviteId=0}if(questionnaireName==="healow CHECK-IN Updates"){$("#quesFooter").hide();responsePromise=$http.post(makeURL("/mobiledoc/jsp/webemr/portal/eCheckinUpdates.jsp?patientId="+mySharedService.patientId+"&encId="+mySharedService.encounterId+"&nd="+(new Date).getTime()));scope.docType="healow CHECK-IN Updates"}else if(questionnaireName=="SurgicalHistoryAndAllergies"){responsePromise=$http.post(makeURL("/mobiledoc/jsp/webemr/portal/SHAllergy.jsp?noheader=yes&uid="+mySharedService.patientId+"&encId="+mySharedService.encounterId+"&qid="+questionnaireID+"&questionnaireType="+questionnaireType+"&action=importSH&trUserId="+global.TrUserId+"&nd="+(new Date).getTime()));scope.docType="SurgicalHistoryAndAllergies"}else if(questionnaireType=="immunization"){responsePromise=$http.post(makeURL("/mobiledoc/jsp/webemr/portal/getQuestionnaireData.jsp?patientId="+mySharedService.patientId+"&encounterId="+mySharedService.encounterId+"&qId="+questionnaireID+"&questionnaireType="+questionnaireType+"&questionnaireName="+questionnaireName+"&nd="+(new Date).getTime()+"&staffInviteID="+queInviteId));scope.docType="Immunization"}else{responsePromise=$http.post(makeURL("/mobiledoc/jsp/webemr/portal/getQuestionnaireData.jsp?patientId="+mySharedService.patientId+"&encounterId="+mySharedService.encounterId+"&qId="+questionnaireID+"&questionnaireType="+questionnaireType+"&questionnaireName="+questionnaireName+"&nd="+(new Date).getTime()+"&staffInviteID="+queInviteId));scope.docType=""}responsePromise.success(function(data,status,headers,config){data=data.trim();if(data.length>0){var compiledquestionnaireContentPopUp=$compile('<table>'+data.trim()+'</table>')(scope);scope.compiledQuestionnaire=compiledquestionnaireContentPopUp;if(questionnaireName.localeCompare("SurgicalHistoryAndAllergies")==0){$(".tVquestionnaireContent").html($compile(data.trim())(scope))}else{$(".tVquestionnaireContent").html(compiledquestionnaireContentPopUp)}scope.docName=questionnaireName;scope.qid=questionnaireID;scope.documentName=questionnaireName;scope.pgNo=pageNum;scope.index=questIndex;scope.noOfPages=pageCount;scope.enableQuestionnaireImportbtn=true;$timeout(function(){scope.loadDetails_1()})}else{$("#popout_questionnaireContent").html("<p style='  margin-top: 20%; margin-left: 5%;'>This Intake Forms have been reviewed for this patient.</p>");$("#stickyview_questionnaireContent").html("<p style='  margin-top: 20%; margin-left: 5%;'>This Intake Forms have been reviewed for this patient.</p>");$("#docview_questionnaireContent").html("<p style='  margin-top: 20%; margin-left: 5%;'>This Intake Forms have been reviewed for this patient.</p>");$("#done").hide();$("#skip").hide();$("#reject").hide();$("#importCurrent").hide();$("#noOfPages").hide()}if(param==""){$(".helow-nav li").css({"background":"none","border-top":"0pc","border-bottom":" 0px","line-height":" 25px","color":" #000000","cursor":" pointer"});$("#"+questionnaireID).parent().css({"background":"#e88842","border-top":"1px solid #c7763b","border-bottom":" 1px solid #c7763b","line-height":" 25px","color":" #fff","cursor":" pointer"})}})};scope.loadDetails_1=function(){var iN_cbs=$window.document.getElementsByTagName('input');for(var iNo=0;iNo<iN_cbs.length;iNo++){if(iN_cbs[iNo].checked==true){scope.showChildren1(iN_cbs[iNo].title)}}};scope.showChildren1=function(rowName){if(rowName.length>0){var zxc0;var zxccbs=$window.document.getElementsByName(rowName);for(zxc0=0;zxc0<zxccbs.length;zxc0++){if(zxccbs[zxc0].style.display!=null)zxccbs[zxc0].style.display=""}}};scope.saveQuestionnaire=function(strAct,pageCount){var formValue=$('#popout_patient_questionnaire').find('#TP_TeleVisit').serialize();if(scope.isVideoCallRunning&&scope.dockView){formValue=$('#stickyview_patient_questionnaire').find('#TP_Sticky').serialize()}else if(scope.isInProgressNote&&!scope.isVideoCallRunning){formValue=$('#docview_patient_questionnaire').find('#TP_DocView').serialize()}scope.verifyConcurrency(strAct,pageCount,formValue)};scope.verifyConcurrency=function(strAct,pageCount,formValue){let docname=$("#TP_TeleVisit :input[name='documentName']").val();let encId=$("#TP_TeleVisit :input[name='encId']").val();let isConcurrencyFlag=getItemKeyValue("EnableConcurLock").toUpperCase()==="YES";if(isConcurrencyFlag){let isToContinue=true;let catName;let isImported=false;scope.catPresentInQuest=[];let categories=[];if(scope.docType=='SurgicalHistoryAndAllergies'){categories.push({'catName':'Surgical/Hospitalization/Allergy','catFormName':'frmSurgical'+encId});categories.push({'catName':'Surgical/Hospitalization/Allergy','catFormName':'frmHistory'+encId})}else{$.ajax({type:'POST',url:'/mobiledoc/jsp/webemr/portal/getQuestionnaireMainCategories.jsp',"async":false,data:'encId='+encId+'&docName='+docname+'&trUserId='+global.TrUserId+'&action=getAllCat',headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},success:function(data){categories=jQuery.parseJSON(data)}})}let loopCount=0;$.each(categories,function(key,value){if(!isImported){catName=value.catName;catFormName=value.catFormName;++loopCount;lockObjForms={formName:"FullQuestImport",uniqueKey:catFormName,g_cancel:false,strKey:"",isOpenform:false,sectionName:catName,shouldContinue:true,TrUserId:global.TrUserId};formsConcurrencyQuestImport.acquireFormLockForForms(lockObjForms,callBackFuncsFullQuestImport);scope.catPresentInQuest.push(lockObjForms);function callBackFuncsFullQuestImport(){scope.catPresentInQuest.push(lockObjForms);if(lockObjForms.shouldContinue){$.each($scope.catPresentInQuest,function(key,value){formsConcurrencyQuestImport.makeEntryForOverwrittingForForms(value,value.uniqueKey)});isImported=true;scope.submitSaveQuestionnaire(strAct,pageCount,formValue)}else{isImported=true;scope.releaseLockForHealowHubImport();return}}if(!lockObjForms.shouldContinue){isToContinue=false;return}else{scope.releaseLockForHealowHubImport()}}});if(loopCount===categories.length&&lockObjForms.shouldContinue&&isToContinue){scope.submitSaveQuestionnaire(strAct,pageCount,formValue)}else{scope.releaseLockForHealowHubImport()}}else{scope.submitSaveQuestionnaire(strAct,pageCount,formValue)}};scope.submitSaveQuestionnaire=function(strAct,pageCount,formValue){$.post('/mobiledoc/jsp/webemr/portal/saveQuestionnaire.jsp?'+formValue+'&uid='+$('#ptid').val()+'&qid='+$('#qid').val()+'&pageNum='+$('#pageNo').val()+'&encId='+$('#encId').val()+'&docName='+$('#documentName').val()+'&action='+strAct+'&trUserId='+global.TrUserId,function(data){if(strAct!="skip"){$('.importmsg').show()}if(data.trim().length>0){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());var tempValues=[];tempValues=returnDataArray(jsonobj.Envelope.Body['return'].questionnaire);if(tempValues!=""){if(tempValues.length>0){scope.subQuestionnaires=tempValues}else{scope.subQuestionnaires.push(tempValues)}}if(tempValues!=""&&scope.subQuestionnaires.length>0&&$('#documentName').val().trim().localeCompare(scope.subQuestionnaires[0].docName.trim())==0){$timeout(function(){});scope.QuestionnaireTabsClick(scope.subQuestionnaires[0].id,scope.subQuestionnaires[0].type,scope.subQuestionnaires[0].docName,scope.subQuestionnaires[0].pageNum,parseInt($("#index").val(),10),'subPages',pageCount);if(strAct!="skip"){$('.importmsg').hide()}}else{var xIndex=parseInt($("#index").val(),10);scope.hideQuestionnairesIntakeMsg=xIndex<scope.questionnaires.length-1;if(scope.hideQuestionnairesIntakeMsg){$('.importmsg').hide();scope.QuestionnaireTabsClick(scope.questionnaires[xIndex+1].id,scope.questionnaires[xIndex+1].type,scope.questionnaires[xIndex+1].docName,scope.questionnaires[xIndex+1].pageNum,xIndex+1,'',scope.questionnaires[xIndex+1].doccount)}else{var msg='All submitted Intake Forms have been reviewed for this patient.';showQuestionnaireIntakeMessage(msg)}}}})};scope.getPatientId=function(){return mySharedService.patientId};scope.showUserNavigationMsg=false;scope.$on('outProgressNoteBroadcast',function(){if(mySharedService.prismaOpenedFrom==="progressnotes"){return}scope.isInProgressNote=false;scope.isInOtherProgressNote=false;if(scope.isVideoCallRunning){scope.showUserNavigationMsg=true;resetModalHeight(scope.showUserNavigationMsg);scope.isMsgDisplay=true}if(scope.stickyNoteView||scope.dockView)scope.changeViewToFullView();if(scope.isFullScreen&&!scope.stickyNoteView){scope.isFullScreen=false;scope.fullScreen()}unbindOTListeners()});function unbindOTListeners(){try{if(scope.loginUserType===scope.USER_TYPE_STAFF&&!scope.isVideoCallRunning){scope.publisher&&opentokVideoService.getSession()?opentokVideoService.getSession().unpublish(scope.publisher):"";scope.translator&&opentokVideoService.getSession()?opentokVideoService.getSession().unpublish(scope.translator):"";if(scope.subscriber){opentokVideoService.getSession().unsubscribe(scope.subscriber)}opentokService.destorySession();opentokVideoService.destorySession()}else if(scope.loginUserType===scope.USER_TYPE_PROVIDER&&!scope.isVideoCallRunning){opentokVideoService.destorySession()}if(scope.staffInviteId>0&&!scope.isVideoCallRunning){opentokService.destorySession();opentokVideoService.destorySession()}}catch(e){telemedLoggingService.error(e)}}scope.nomalizeWindow=function(){scope.w=minWidth;scope.h=minHeight;$(".chatbox").css("right","0px");$(".chatbox").css("left","");setContainerLayout(20);scope.isFullScreen=false;setTimeout(function(){telemedInviteService.utils.setHeightInviteeWrapper();$('.chatbox').draggable({containment:".main-wrap",scroll:false,drag:restrictBoundary});$("#me_"+scope.$id).draggable({containment:"#videoContainer",scroll:false});readjustSelfView()},100)};scope.changeViewToDockView=function(){scope.stickyNoteView=false;scope.fullView=false;scope.dockView=true;scope.teleView=0;$('.televisionbox').parent().css('width','')};scope.showTeleView=function(viewId){scope.teleView=viewId;if(viewId===1||viewId===2||viewId===3||viewId===4){$("#teleVideoNote").append($("#containerDIV"));$("#patientIdentifierTV").hide();$("#teleVideoNote").find(".tv_invitee").hide();telemedCallBandwidthService.setTVView(false);if(scope.isScreenSharingRunning){$("#teleVideoNote").find("#screen-publisher").hide()}setTimeout(function(){$(".VideoSignalDiv").hide()},1e3);$("#teleVideoNote").find("#containerDIV").css({'height':52,'width':scope.w/5-4,'background':'black'});$("#teleVideoNote").find("#C2CallApplet_"+scope.$id).css({'height':52,'width':scope.w/5-4});setContainerLayout(250)}if(viewId==0){$("#tvFullView").append($("#containerDIV"));if(scope.showPtDocs){$("#tvFullView").find("#containerDIV").css({'height':scope.h-4,'width':scope.w-100});$("#tvFullView").find("#C2CallApplet_"+scope.$id).css({'height':scope.h-4,'width':scope.w-100})}else{$("#tvFullView").find("#containerDIV").css({'height':scope.h,'width':scope.w-2});$("#tvFullView").find("#C2CallApplet_"+scope.$id).css({'height':scope.h,'width':scope.w-2})}if(scope.isScreenSharingRunning){$("#tvFullView").find("#screen-publisher").show()}$("#patientIdentifierTV").show();$("#tvFullView").find(".tv_invitee").show();telemedCallBandwidthService.setTVView(true);$(".VideoSignalDiv").show();setContainerLayout(0)}else if(viewId==3){scope.missedMsg=0;$("#txtMsgSend").focus();$('#chat-display').scrollTop($('#chat-display')[0])}};scope.changeViewToFullView=function(){telemedCallBandwidthService.setTVView(true);$("#tvFullView").append($("#containerDIV"));if(scope.showPtDocs){$("#tvFullView").find("#containerDIV").css({'height':scope.h-4,'width':scope.w-100});$("#tvFullView").find("#C2CallApplet_"+scope.$id).css({'height':scope.h-4,'width':scope.w-100})}else{$("#tvFullView").find("#containerDIV").css({'height':scope.h-4,'width':scope.w-2});$("#tvFullView").find("#C2CallApplet_"+scope.$id).css({'height':scope.h-4,'width':scope.w-2})}if(scope.isScreenSharingRunning){$("#tvFullView").find("#screen-publisher").show()}$("#patientIdentifierTV").show();$("#tvFullView").find(".tv_invitee").show();$(".VideoSignalDiv").show();if(scope.isFullScreen){scope.isFullScreen=false;scope.fullScreen()}else{telemedInviteService.utils.setHeightInviteeWrapper()}scope.stickyNoteView=false;scope.fullView=true;scope.dockView=false;$('.televisionbox').parent().css('width','');setContainerLayout(250)};scope.changeViewToStickyNoteView=function(){if(scope.isInProgressNote){scope.stickyNoteView=true;scope.fullView=false;scope.dockView=false;scope.teleView=0;$('.televisionbox').parent().css('width','70px');var targetClassName="#_toppanel_healowhub";$("#stickyNoteView").css("width",$(targetClassName).width());$("#stickyNoteView").css("height",$(targetClassName).innerHeight());$("#stickyNoteView").css("right","60%");$("#stickyNoteView").css("top","5px");$("#stickyvideo").append($("#containerDIV"));if(scope.isScreenSharingRunning){$("#stickyvideo").find("#screen-publisher").hide()}$("#stickyvideo").find("#containerDIV").css({'height':94,'width':'100%'});$("#stickyViewPoffline").hide();$("#patientIdentifierTV").hide();$("#stickyvideo").find(".tv_invitee").hide();telemedCallBandwidthService.setTVView(false);setTimeout(function(){$(".VideoSignalDiv").hide()},1e3);setContainerLayout(250)}};scope.fullScreen=function(){try{if(scope.isFullScreen){return}var targetClassName="main-wrap";var targetClassWidth;if(scope.isInProgressNote){targetClassName="progress-tab";targetClassWidth=targetClassName;if(scope.fullView){$(".chatbox").css("height",$("."+targetClassName).height())}else{$(".chatbox").css("height",$("."+targetClassName).height()-36)}if(scope.showUserNavigationMsg){scope.h=$("."+targetClassName).height()-116-$("#tvShowMsgOutside").get(0).clientHeight}else{scope.h=$("."+targetClassName).height()-116}}else{targetClassWidth="main-cont";if(scope.fullView){$(".chatbox").css("height",$("."+targetClassName).height())}else{$(".chatbox").css("height",$("."+targetClassName).height()-36)}if(scope.showUserNavigationMsg){scope.h=$("."+targetClassName).height()-136-$("#tvShowMsgOutside").get(0).clientHeight}else{scope.h=$("."+targetClassName).height()-136}}scope.w=$("."+targetClassWidth).width();if(scope.$root.$$phase!='$apply'&&scope.$root.$$phase!='$digest'){scope.$apply()}telemedInviteService.utils.setHeightInviteeWrapper();$(".chatbox").css("width",$("."+targetClassWidth).width());$(".chatbox").css("top",$("."+targetClassName).offset().top);$(".chatbox").css("left",$("."+targetClassWidth).offset().left);scope.isFullScreen=true;readjustSelfView();setContainerLayout(500);var isDraggable=$('.chatbox').hasClass("ui-draggable");if(isDraggable){$('.chatbox').draggable("destroy")}}catch(e){console.log("Error in fullScreen:: "+e)}};scope.changeViewToFullScreen=function(){if(!scope.isFullScreen){scope.fullScreen();$("#teleChatBox").resizable("destroy")}else{scope.nomalizeWindow();$('#teleChatBox').resizable({handles:'n, e, s, w, ne, se, sw, nw',minWidth:595,minHeight:465});resetModalHeight(scope.showUserNavigationMsg)}};scope.startTeleVisit=function(){scope.azureSpeech=getItemKeyValue('AzureSpeechTeleVisit')==="1"?true:false;$ocLazyLoad.load({name:'TeleVisit',files:['/mobiledoc/jsp/webemr/telemed/css/jcrop/jquery.Jcrop.css','/mobiledoc/jsp/webemr/telemed/js/jcrop/jquery.Jcrop.js']}).then(function(){scope.signalCallRunningStatus();if(scope.tvAISummaryEnabled){telemedInviteService.utils.getAuth_Token(global.TrUserId)}setTimeout(function(){if(scope.onCallUserSet.size>0){scope.joinTeleVisit()}else{if(SessionService.getCallRunning()){scope.showCallRunningMsg=true;return}else{scope.showCallRunningMsg=false}if(scope.callAlreadyInProgress){scope.calling=false;scope.reconnecting=true;scope.showMsgCallAlreadyInProgress=true;return}if(scope.inviteeFeature.isPatientHasInviteeFeature&&scope.inviteeFeature.isInviteContactEnable){scope.inviteeFeature.cleanupScope();telemedInviteService.bindListeners();setScope()}if(scope.staffInviteId>0){scope.displayConfirmationPopup();scope.joinRequestSent=true}else{scope.connectToVideoSession();scope.callStatus="Ringing..";opentokVideoService.getSession().signal({type:"doctor",data:{to:mySharedService.patientId,from:mySharedService.providerID,loginUID:global.TrUserId,action:"connect",status:"online",isClosedCaptionEnabled:true}},function(error){if(!error){scope.starttime=true;scope.calling=true;scope.callStatus="Ringing..";scope.$apply()}else{scope.callStatus="Faild";scope.$apply();console.log("Error in sending Signal"+error.code+"->"+error.message)}})}}},1500)})};scope.joinTeleVisit=function(){scope.azureSpeech=getItemKeyValue('AzureSpeechTeleVisit')==="1"?true:false;$ocLazyLoad.load({name:'TeleVisit',files:['/mobiledoc/jsp/webemr/telemed/css/jcrop/jquery.Jcrop.css','/mobiledoc/jsp/webemr/telemed/js/jcrop/jquery.Jcrop.js']}).then(function(){scope.signalCallRunningStatus();if(scope.tvAISummaryEnabled){telemedInviteService.utils.getAuth_Token(global.TrUserId)}setTimeout(function(){let userLimit=parseInt(getItemKeyValue("TVInviteStaffLimit"));let isProviderConnected=scope.onCallUserSet.has(mySharedService.providerID);if(isProviderConnected){userLimit=userLimit+1}if(scope.onCallUserSet.size>=userLimit&&scope.loginUserType!=scope.USER_TYPE_PROVIDER){scope.showLimitMsg=true;if(isProviderConnected){userLimit=userLimit-1}}else{if(scope.loginUserType===scope.USER_TYPE_STAFF||scope.USER_TYPE_PROVIDER===global.loginUserType){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/getEncInviteDetail"),data:{encId:mySharedService.encounterId,userId:global.TrUserId},type:"POST","async":false,success:function(data){if($.isEmptyObject(data)===false){scope.staffInviteId=data['inviteId'];scope.invitebyId=data['inviterId']}},error:function(e){console.log("get Staff Invite Detail ERROR :"+e.message)}})}if(SessionService.getCallRunning()&&scope.staffInviteId==0){scope.showCallRunningMsg=true;return}else{scope.showCallRunningMsg=false}if(scope.callAlreadyInProgress&&scope.staffInviteId==0){scope.calling=false;scope.reconnecting=true;scope.showMsgCallAlreadyInProgress=true;return}if(scope.inviteeFeature.isPatientHasInviteeFeature&&scope.inviteeFeature.isInviteContactEnable){scope.inviteeFeature.cleanupScope();telemedInviteService.bindListeners();setScope()}isNetworkDisconnected=false;if(scope.staffInviteId>0){scope.joinRequestSent=true;scope.displayConfirmationPopup()}else{scope.connectToVideoSession();scope.callStatus="Ringing..";opentokVideoService.getSession().signal({type:"doctor",data:{to:mySharedService.encounterId,from:mySharedService.providerID,loginUID:global.TrUserId,action:"reconnect",status:"online",isClosedCaptionEnabled:true}},function(error){if(!error){scope.reconnecting=true;scope.calling=true;scope.callStatus="Ringing..";scope.$apply()}else{scope.callStatus="Failed";console.log("Error in sending Signal"+error.code+"->"+error.message);scope.$apply()}})}}},1500)})};scope.forcejoinTeleVisit=function(){rejoinAfterForceDisconnect=true;if(scope.staffInviteId>0){scope.displayConfirmationPopup()}else{scope.displayTvUserConfirmPopup()}};scope.togglePin=function(){if(scope.onTop){$("#teleChatBox").css("z-index","999");scope.onTop=false}else{$("#teleChatBox").css("z-index","99999999999999");scope.onTop=true}};scope.layout=function(){container.layout();scope.$emit('otLayoutComplete')};var toggleExpand=function(){scope.$apply();scope.$emit('otLayout')};angular.element(document.getElementById("C2CallApplet_"+scope.$id)).on('click',toggleExpand);angular.element(document.getElementById("C2CallApplet_"+scope.$id)).parent().on('dblclick',toggleExpand);scope.isPubInitiated=false;let signalToDisableAction=false;scope.streamCreated=function(event){var data=$.parseJSON(event.stream.connection.data);if(event.stream.videoType==='screen'){let props={maxRatio:3/2,minRatio:9/16,fixedRatio:false,scaleLastRow:true,alignItems:'center',bigClass:"OT_big",bigPercentage:.8,minBigPercentage:0,bigFixedRatio:false,bigScaleLastRow:true,bigAlignItems:'center',smallAlignItems:'center',maxWidth:Infinity,maxHeight:Infinity,smallMaxWidth:Infinity,smallMaxHeight:Infinity,bigMaxWidth:Infinity,bigMaxHeight:Infinity,bigMaxRatio:3/2,bigMinRatio:9/16,bigFirst:true,animate:true,window:window,ignoreClass:'OT_ignore',onLayout:null};scope.screenShareContainer=otl.initLayoutContainer($("#screen-subscriber")[0],props);let subOptions={insertMode:"append",width:$('#C2CallApplet_'+scope.$id).width(),height:$('#C2CallApplet_'+scope.$id).height(),showControls:false,style:{videoDisabledDisplayMode:'on'}};scope.screenSubscriber=opentokVideoService.getSession().subscribe(event.stream,'screen-subscriber',subOptions,function(error){if(!error){scope.isScreenSubscribed=true;$(".userchat").hide();setContainerLayout(20)}else{createAlertDown('#errorstatus',Alerts.ERROR,'','Issue while Provider sharing the screen',true,8e3)}})}else{if(data&&data.st&&data.st==="vst"&&scope.staffInviteId==0&&!scope.isAdmitResponseReceived&&!scope.isAllowStaffProvider){allowedUserToSubscribe=false;scope.callAlreadyInProgress=true;scope.reconnecting=true;callRunningUserID=data.uid;scope.msgCallAlreadyInProgress="This Patient is currently on a call with another user. Are you sure you want to join this visit ? ";scope.calling=false;scope.isVideoCallRunning=false;telemedCallRunningService.clearCallRunning();setScope();$("#televisit-tplBtn10_newconnect").show();if(scope.allowClosedCaption&&!signalToDisableAction){signalToDisableAction=true;sendSignalToDisableCCForEMR();signalToRestartCaptionOnStaffJoin();if(scope.pauseCaption){sendSignalToPauseTranscription()}}return}if(scope.reconnecting==false&&scope.starttime==false&&!scope.isPublishing&&scope.staffInviteId==0&&!scope.isAdmitResponseReceived&&!scope.isAllowStaffProvider){scope.reconnecting=true;scope.starttime=true}else{if(!allowedUserToSubscribe&&scope.staffInviteId==0&&!scope.isAdmitResponseReceived&&!scope.isAllowStaffProvider){return}var isContact=false;if(data.data&&data.data.usertype&&data.data.usertype==="contact"){isContact=true;data.data.encId=mySharedService.encounterId}else if(data.st&&data.st==="vst"){data.data=data;data.data.inviteid=0;data.data.encId=mySharedService.encounterId}if(data.data&&data.data.inviteid==0){updateRosterListPresence(data.data.encId,true)}if(scope.staffInviteId==0){scope.isPatientOnline=scope.users[data.data.encId].presence}else{scope.isPatientOnline=true}scope.setPatient("online",isContact);if(event.stream.name==='Virtual Translator'){console.log("Translator to subscribe")}if(!scope.isVideoCallRunning||scope.isPatientOnline||scope.staffInviteId>0){scope.isCameraSwitching=false;if(data.data.usertype==="patient"&&scope.staffInviteId==0){scope.currentCallPatientName=scope.users[mySharedService.encounterId].fullName}scope.isVideoCallRunning=true;telemedCallRunningService.setCallRunning(data.data.encId,event.target.sessionId);mySharedService.lock();isVideoCallRunning=true;if(!isContact){if(scope.isPublishing)scope.setPatient("reconnected");else scope.setPatient("connected")}if(!callingInfo){callingInfo={};callingInfo["startTime"]=(new Date).getTime()}scope.changeViewToFullView();if(isContact){scope.inviteeFeature.subscribeToContactStream(data,event,scope.$id,reInitCaptionForUser);$('#'+scope.inviteeFeature.contSubscriber[data.data.inviteid].id).dblclick(function(){if($('#'+scope.inviteeFeature.contSubscriber[data.data.inviteid].id).hasClass('OT_big')){$('#'+scope.inviteeFeature.contSubscriber[data.data.inviteid].id).removeClass('OT_big')}else{$('#'+scope.inviteeFeature.contSubscriber[data.data.inviteid].id).addClass('OT_big')}setContainerLayout(20)});$('#'+scope.inviteeFeature.contSubscriber[data.data.inviteid].id).click(function(){$('#'+scope.inviteeFeature.contSubscriber[data.data.inviteid].id).trigger('dblclick')});return}if(event.stream.name==='Virtual Translator'){scope.subscriber=opentokVideoService.getSession().subscribe(event.stream,document.getElementById("translatorDiv"),{insertMode:"append",showControls:false,width:"100%",height:"100%",subscribeToVideo:false},function(error){if(error){console.log(error)}})}else{let subscriberOption={insertMode:"append",showControls:false,width:"100%",height:"100%"};let patientDevice="";if(data.data['device']){patientDevice=data.data['device']}if(patientDevice!==""&&(patientDevice.toUpperCase()==='ANDROID'||patientDevice.toUpperCase()==='IOS')){subscriberOption['fitMode']='contain'}scope.subscriber=opentokVideoService.getSession().subscribe(event.stream,document.getElementById("C2CallApplet_"+scope.$id),subscriberOption,function(error){if(!error){if(Object.keys(scope.inviteeFeature.contSubscriber).length>0&&scope.staffInviteId==0){scope.inviteeFeature.setPatientIdentifier(scope.subscriber)}scope.subscriber['hasAudio']=event.stream.hasAudio;scope.subscriber['hasVideo']=event.stream.hasVideo;var date=new Date;var outTime=date.getHours()+":"+date.getMinutes()+":"+date.getSeconds();$.post("/mobiledoc/jsp/telemed/telemedResponse.jsp","action=statusCheckIn&trUserId="+global.TrUserId+"&encId="+mySharedService.encounterId+"&patientId="+mySharedService.patientId+"&time="+outTime+"&strStatus=CheckIn"+"&t="+new Date).done(function(data){});scope.startTimer();if(data.data&&data.data.usertype&&(data.data.usertype==="2"||data.data.usertype==="1")){if(isSwitchedToAudio){scope.switchToAudioCall(true)}if(scope.allowClosedCaption&&!signalToDisableAction){signalToDisableAction=true;sendSignalToDisableCCForEMR();signalToRestartCaptionOnStaffJoin();if(scope.pauseCaption){sendSignalToPauseTranscription()}}}scope.subscriber.on("videoDisabled",scope.videoDisabledHandler);scope.subscriber.on("videoEnabled",scope.videoEnabledHandler);scope.subscriber.on("videoDisableWarning",scope.videoDisabledWarningHandler);scope.subscriber.on("videoDisableWarningLifted",scope.videoDisableWarningLiftedHandler);var callSource="";if(data.data['device']){callSource=data.data['device']}callingInfo["streamID"]=event.stream.streamId;callingInfo["providerConnectionID"]=event.target.connection.id;callingInfo["patientConnectionID"]=event.stream.connection.connectionId;callingInfo["masterSessionID"]=document.getElementById("sessionId").value;callingInfo["videoSessionID"]=event.target.id;callingInfo["patientSourceCall"]=callSource;callingInfo["contactSourceCall"]=callSource;callingInfo["startTime"]=(new Date).getTime();callingInfo["userName"]=data.data['username'];callingInfo["userType"]=data.data['usertype'];if(callingInfo["patientSourceCall"]==='portal'){scope.displayCCBtn=true}if(!telemedInviteService.utils.participantDetail[0]){telemedInviteService.utils.participantDetail[0]={}}$.extend(telemedInviteService.utils.participantDetail[0],callingInfo);if(!telemedInviteService.utils.hasElement('id',0,scope.inviteeFeature.onlinePersonList)){scope.inviteeFeature.onlinePersonList.push({"userName":scope.currentCallPatientName,"id":0})}if(data.data&&data.data.usertype&&data.data.usertype==="patient"&&scope.staffInviteId==0){scope.publishVideoStream()}scope.refreshPatientDocuments()}else{console.log("Error"+error.code+"->"+error.message)}})}if(data.data&&data.data.usertype&&data.data.usertype==="patient"){telemedCallBandwidthService.getTelemedCallBandwidth(scope.subscriber,data.data.ptid);scope.inviteeFeature.setInviteStaffPatientIdentifier(scope.subscriber,scope.currentCallPatientName)}if(data.st&&data.st==="vst"){telemedCallBandwidthService.getTelemedCallBandwidth(scope.subscriber,data.uid);scope.inviteeFeature.setInviteStaffProviderIdentifier(scope.subscriber,data.username)}let subscribeID=scope.subscriber.id;$('#'+subscribeID).dblclick(function(){console.log('id:'+subscribeID);if($('#'+subscribeID).hasClass('OT_big')){$('#'+subscribeID).removeClass('OT_big')}else{$('#'+subscribeID).addClass('OT_big')}setContainerLayout(20)});$('#'+subscribeID).click(function(){$('#'+subscribeID).trigger('dblclick')})}}}scope.$apply()};let reInitCaptionForUser=function(relation){if(scope.allowClosedCaption){if(relation&&(relation==='Staff'||relation==='Provider')){sendSignalToDisableCCForEMR()}else{signalToRestartCaptionOnStaffJoin()}if(scope.pauseCaption){sendSignalToPauseTranscription()}}};scope.publishVideoStream=function(){if(!scope.isPublishing&&!scope.isPubInitiated){scope.isPubInitiated=true;var pubOptions={width:61,height:61,insertMode:"append",showControls:false,name:global.TrUserName,publishCaptions:true};let publisherElement=$("#me_"+scope.$id)[0];scope.publisher=OT.initPublisher(publisherElement,pubOptions,function(error){scope.publisher.on("streamCreated",scope.publisherStreamCreatedHandler);if(!error){opentokVideoService.getSession().publish(scope.publisher,function(error){if(!error){scope.isPublishing=true;scope.reconnecting=false;scope.publisher.on("destroyed",scope.publisherDestroyedHandler);scope.publisher.on("streamDestroyed",scope.publisherStreamDestroyedHandler);telemedCallBandwidthService.getTelemedCallBandwidth(scope.publisher,mySharedService.providerID)}else{opentokVideoService.getSession().unpublish(scope.publisher);scope.publisherErrorHandler(error);console.log("Error  in publihing"+error.code+"->"+error.message)}})}else{console.log("Error"+error.code+"->"+error.message);scope.publisherErrorHandler(error)}});if(scope.isVideoPause){scope.publisher.publishVideo(false)}if(scope.isMuted){scope.publisher.publishAudio(false)}}};scope.publisherStreamCreatedHandler=function(event){callingInfo["providerStreamID"]=event.stream.streamId};scope.publisherStreamDestroyedHandler=function(event){if(event.reason=="mediaStopped"){scope.createAlertDownWithRetryLink('#errorstatus',Alerts.ERROR,'','"Please reattach camera/ microphone and try again..."',false,0,"<a href='#' ng-click='rePublishDoctorVideo(true);' class='televisitRetryLink'>Click here to Retry ..</a>")}};scope.stopScreenSharing=function(){try{if(scope.isScreenSharingRunning){scope.showScreenMsg=false;scope.isScreenSharingRunning=false;opentokVideoService.getSession().unpublish(scope.screenPublisher);if($('#screen-publisher').is(':data(ui-draggable)')){$('#screen-publisher').draggable("destroy")}scope.screenPublisher=null}}catch(e){ecwAlert('Issue while trying to stop screen share')}};function compatibilityOfScreenShare(){var isCompatible=true;try{var raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(!(raw&&raw.length>=3&&parseInt(raw[2],10)>=72)){ecwAlert('This browser does not support screen sharing. Please use Google Chrome version 72+');isCompatible=false}}catch(e){ecwAlert('Issue while trying to screen share');isCompatible=false}return isCompatible}function setScope(){if(scope.$root.$$phase!=='$apply'&&scope.$root.$$phase!=='$digest'){scope.$apply()}}scope.screenshare=function(){if(scope.isScreenSharingRunning){scope.showScreenMsg=true;if(scope.$root.$$phase!=='$apply'&&scope.$root.$$phase!=='$digest'){scope.$apply()}return}if(scope.isScreenSubscribed){return}var msg="Important!  You are currently sharing your desktop/screen with a patient in a live TeleVisit appointment. "+" Use caution when navigating between screens.";ecwConfirm(msg,'eClinicalWorks',function(){startScreenShare()},'','bluetheme',true,'','I understand','Cancel')};function startScreenShare(){if(!compatibilityOfScreenShare()){return}OT.checkScreenSharingCapability(function(response){try{if(response.supported){var temp=$compile('<div id="screen-publisher" class="screenshare" ng-show="isScreenSharingRunning" style="top:-100px;"></div>')(scope);angular.element(document.getElementById('containerDIV')).append(temp);scope.screenPublisher=OT.initPublisher(document.getElementById("screen-publisher"),{videoSource:'screen'},function(error){if(error){ecwAlert('There is a problem while sharing the scrren.')}else{$('#screen-publisher').draggable({containment:"#videoContainer",scroll:false});opentokVideoService.getSession().publish(scope.screenPublisher,function(error){if(error){ecwAlert('There is a problem while sharing the screen.')}else{scope.screenPublisher.on("destroyed",function(){scope.isScreenSharingRunning=false});scope.screenPublisher.on("streamDestroyed",function(){scope.isScreenSharingRunning=false});scope.isScreenSharingRunning=true;if(scope.fullView&&!scope.isHealowPlusUser){scope.changeViewToStickyNoteView()}}})}})}else{ecwAlert('There is a problem while sharing the scrren')}}catch(e){ecwAlert('There is a problem while sharing the scrren')}})}function sendSignalToStartPublish(type){try{opentokVideoService.getSession().signal({type:"initPublish",data:{encID:mySharedService.encounterId,to:mySharedService.patientId,from:mySharedService.providerID,initalCallerID:global.TrUserId,type:type,action:"initPublish",apuId:getItemKeyValue('AutoUpgradeKey'),auth_token:scope.tvAISummaryEnabled?telemedInviteService.utils.getAuth_Token(global.TrUserId):'',aiEndPoint:getItemKeyValue("SunohEndPoint")}},function(error){if(error){allowedUserToSubscribe=false}})}catch(e){ecwAlert('There is a problem while starting TeleVisit.')}}var allowedUserToSubscribe=false;function handShakeHandler(event){try{if(event.data&&typeof event.data==="string"){event.data=$.parseJSON(event.data)}allowedUserToSubscribe=event.data&&parseInt(event.data.initalCallerID,10)===parseInt(global.TrUserId,10);if(!allowedUserToSubscribe){scope.callAlreadyInProgress=true;scope.reconnecting=true;callRunningUserID=event.data.initalCallerID;scope.msgCallAlreadyInProgress="This Patient is currently on a call with "+getProviderFullNameWithSuffixInProperFormate(callRunningUserID)+". ";scope.calling=false;$("#televisit-tplBtn10_newconnect").hide()}else{sendSignalToStartPublish(event.data.type)}setScope()}catch(e){ecwAlert('There is a problem while starting TeleVisit.')}}function signalRecievedHandlerContact(event){try{event.data=typeof event.data==='string'?telemedInviteService.utils.parseJSONUtility(event.data):event.data}catch(e){telemedLoggingService.error(e)}if(event.data.action==="hangup"){callingInfo["hangup"]=8;scope.stopScreenSharing()}}scope.signalRecievedHandler=function(event){try{event.data=$.parseJSON(event.data).data}catch(e){}if(event.data.action==="hangup"){callingInfo["hangup"]=5;scope.unPublishProvider();scope.setPatient('ptCheckout');scope.ptHangUp=true;scope.hoverControlsIn()}};function verifiedConnectionData(data){var connectionData;try{connectionData=$.parseJSON(data)}catch(e){return null}return connectionData}scope.connectionCreatedHandler=function(event){scope.calling=false;var remoteData=verifiedConnectionData(event.connection.data);if(remoteData&&remoteData.data){if(remoteData.data.inviteid){scope.inviteeFeature.isPatientHasInviteeFeature=true;telemedInviteService.utils.participantList[remoteData.data.inviteid]={};telemedInviteService.utils.participantList[remoteData.data.inviteid]["connection"]=event.connection}else{if(telemedInviteService.utils.participantList&&telemedInviteService.utils.participantList[telemedInviteService.utils.PATIENT_ID_INVITEE]===undefined){telemedInviteService.utils.participantList[telemedInviteService.utils.PATIENT_ID_INVITEE]={}}telemedInviteService.utils.participantList[telemedInviteService.utils.PATIENT_ID_INVITEE]["connection"]=event.connection}}if(remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="patient"){if(!callingInfo){callingInfo={}}callingInfo["startTime"]=(new Date).getTime();if(!telemedInviteService.utils.participantDetail[0]){telemedInviteService.utils.participantDetail[0]={}}$.extend(telemedInviteService.utils.participantDetail[0],callingInfo);videoDestroyConnectionCalled=false;scope.isVideoSessionConnected=true;scope.isPatientOnline=true;scope.callRunningEncId=remoteData.data.encId;var ref=$.parseJSON(event.connection.data);if(event.connection.data!=undefined&&ref.data.encId!=undefined){if(multipleVideoReferences[ref.data.encId]==null){multipleVideoReferences[ref.data.encId]=1}else if(multipleVideoReferences[ref.data.encId]!=null){multipleVideoReferences[ref.data.encId]=2}}$(".playermenu").css('visibility','visible');if(scope.capturing){scope.capturing=false;jcrop_api.destroy()}if(scope.staffInviteId==0||scope.staffInviteId>0&&global.loginUserType==scope.USER_TYPE_PROVIDER){opentokVideoService.getSession().signal({type:"doctor",data:{to:mySharedService.patientId,from:global.TrUserId,loginUID:global.TrUserId,action:"connect",status:"online",isClosedCaptionEnabled:true,isCCOn:scope.allowClosedCaption,auth_token:scope.tvAISummaryEnabled?telemedInviteService.utils.getAuth_Token(global.TrUserId):'',aiEndPoint:getItemKeyValue("SunohEndPoint")}},function(error){if(!error){scope.starttime=true;scope.calling=true;scope.callStatus="Ringing..";scope.$apply()}else{scope.callStatus="Faild";scope.$apply();console.log("Error in sending Signal"+error.code+"->"+error.message)}})}}else{let connectedUserId=0;if(remoteData.uid){connectedUserId=remoteData.uid}else if(remoteData.data.uid){connectedUserId=remoteData.data.uid}else if(remoteData.data.userid){connectedUserId=remoteData.data.userid}if(scope.inviteeFeature.onlineUserIds===null){scope.inviteeFeature.onlineUserIds=new Set}scope.inviteeFeature.onlineUserIds.add(connectedUserId);for(var i=0;i<scope.inviteeFeature.scheduledProvider.length;i++){if(scope.inviteeFeature.onlineUserIds.has(""+scope.inviteeFeature.scheduledProvider[i].id)){scope.inviteeFeature.scheduledProvider[i].isExist=true}}for(var i=0;i<scope.inviteeFeature.assignStaffList.length;i++){if(scope.inviteeFeature.onlineUserIds.has(""+scope.inviteeFeature.assignStaffList[i].id)){scope.inviteeFeature.assignStaffList[i].isExist=true;scope.inviteeFeature.assignStaffList[i].status=1}}for(var i=0;i<scope.inviteeFeature.invitedStaffList.length;i++){if(scope.inviteeFeature.onlineUserIds.has(""+scope.inviteeFeature.invitedStaffList[i].id)){scope.inviteeFeature.invitedStaffList[i].isExist=true;scope.inviteeFeature.invitedStaffList[i].status=1}}var remoteVideoData=$.parseJSON(event.connection.data);var selfVideoData=$.parseJSON(event.target.connection.data);if(selfVideoData&&remoteVideoData&&remoteVideoData.mdid===selfVideoData.mdid&&event.target.connection.id!==event.connection.id&&remoteVideoData.uid==global.TrUserId||selfVideoData&&remoteVideoData&&selfVideoData.data&&remoteVideoData.data&&remoteVideoData.data.mdid===selfVideoData.data.mdid&&event.target.connection.id!==event.connection.id&&remoteVideoData.data.userid==global.TrUserId){if(scope.onCallUserSet.has(global.TrUserId)&&opentokVideoService.getSession().connection.creationTime<event.connection.creationTime&&!scope.isAllowStaffProvider){scope.multipleLoginFound=true;scope.showMultipleLoginFoundMessage=true;scope.onCallUserSet.clear();if(scope.isVideoCallRunning){opentokVideoService.getSession().unsubscribe(scope.subscriber);opentokVideoService.getSession().unpublish(scope.publisher);stopSubscriberCloseCaption();stopPublisherCloseCaption()}opentokService.destorySession();opentokVideoService.destorySession();scope.$apply();return}else{scope.isAllowStaffProvider=true;scope.onCallUserSet.add(connectedUserId)}}scope.onCallUserSet.add(connectedUserId)}if(remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="contact"&&scope.staffInviteId>0&&remoteData.data.userid&&remoteData.data.userid===global.TrUserId){if(remoteData&&remoteData.data&&(remoteData.data.usertype&&remoteData.data.usertype==="contact")||remoteData.data.relation&&remoteData.data.relation==="Provider"){scope.showQuestionnaire=false;scope.showImgCaptControl=false;$('.borTop').hide()}scope.publishVideoStream()}scope.$apply()};scope.hangupHandler=function(event){if(event.data&&event.data.action&&event.data.action==="hangup"&&event.data.loggedInId+''!==global.TrUserId+''){scope.interruptTeleVisit()}};scope.signalRecievedTextHandler=function(event){let remoteData=verifiedConnectionData(event.from.data);if(scope.isVideoCallRunning===false||remoteData&&remoteData.uid&&remoteData.uid===global.TrUserId||remoteData&&remoteData.data&&remoteData.data.userid&&remoteData.data.userid===global.TrUserId){return}let name=scope.currentCallPatientName;if(remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="contact"){name=remoteData.data.username}if(remoteData&&remoteData.usertype&&remoteData.usertype==="1"){name=remoteData.username}let msgData='';if(event.data&&event.data.msg){msgData=event.data.msg}else{msgData=event.data}let msgType=event.type;let msgIcon="pat";if(msgType.includes("Doctor")){msgIcon="ProviderEMR"}else if(msgType.includes("Staff")){msgIcon="StaffEMR"}else if(msgType.includes("Contact")){msgIcon="ContactEMR"}var message=$sce.trustAsHtml(msgData);var currentdate=new Date;var msgtime=scope.formatDate(currentdate);var chat={isMine:false,msgtime:msgtime,message:message,userName:name};if(remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="contact"){chat.relation='('+remoteData.data.relation+')'}chat.chatIcon=msgIcon;if(scope.chats[mySharedService.encounterId]===undefined){scope.chats[mySharedService.encounterId]=[]}scope.chats[mySharedService.encounterId].push(chat);$('#chatdisplaydiv').animate({scrollTop:$('#chatdisplaydiv')[0].scrollHeight});$('#chatdisplaydivsticky').animate({scrollTop:$('#chatdisplaydivsticky')[0].scrollHeight});if(scope.teleView==0||scope.teleView==1||scope.teleView==2||scope.isHealowPlusUser){scope.missedMsg+=1}scope.$apply()};let isSwitchedToAudio=false;scope.videoDisabledHandler=function(event){if(isSwitchedToAudio){scope.createAlertDown('#errorstatus',Alerts.WARNING,'','You have been switched to audio only mode due to low bandwidth.',false,0)}else{scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Patient stopped broadcasting.',true,8e3)}telemedCallBandwidthService.hideBandwidthDiv(scope.subscriber)};scope.videoEnabledHandler=function(event){scope.setPatient("broadcasting");scope.subscriber.subscribeToVideo(true);telemedCallBandwidthService.showBandwidthDiv(scope.subscriber)};scope.videoDisabledWarningHandler=function(event){scope.createAlertDownWithRetryLink("#errorstatus",Alerts.LINK,'','Poor network connection detected. In order to have a better experience we recommend audio only mode.',false,0,"<span>&nbsp;Please&nbsp;</span><a href='javascript:void(0)' ng-click='switchToAudioCall()' style='color: blue;cursor: pointer;'><u>click here</u></a><span>&nbsp;to switch to audio-only mode.</span>")};scope.videoDisableWarningLiftedHandler=function(event){scope.createAlertUp('#errorstatus',false,'')};scope.setPatient=function(status,isInvited){if(status=="online"){$("#poffline").hide();$("#C2CallApplet_"+scope.$id).show();if(scope.isVideoCallRunning==true){if(isInvited){scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Waiting for the admitted participant to accept the displayed device access prompt...',false,0)}else{scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Waiting for the patient to accept the displayed device access prompt...',false,0)}}}else if(status=="offline"){$("#C2CallApplet_"+scope.$id).hide();$("#poffline").show();if(scope.isVideoCallRunning==true)scope.createAlertDown('#errorstatus',Alerts.ERROR,'','We have lost connection with the patient. The connection will resume automatically when the patient reconnects.',false,0)}else if(status=="ptCheckout"){$("#C2CallApplet_"+scope.$id).hide();$("#poffline").show();if(scope.isVideoCallRunning==true)scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Patient has disconnected the call. Please end the call now.',false,0)}else if(status=="reconnected"){$("#poffline").hide();$("#C2CallApplet_"+scope.$id).show();if(scope.isVideoCallRunning==true)scope.createAlertDown('#errorstatus',Alerts.SUCCESS,'','We are back!',true,5e3)}else if(status=="connected"){$("#poffline").hide();$("#C2CallApplet_"+scope.$id).show();if(scope.isVideoCallRunning==true)scope.createAlertDown('#errorstatus',Alerts.SUCCESS,'','Connected.',true,5e3)}else if(status=="broadcasting"){$("#poffline").hide();$("#C2CallApplet_"+scope.$id).show()}};scope.endTeleVisitCheck=function(){if(Object.keys(scope.patientDocs).length>0){if(scope.ptHangUp){if(scope.dockView){$(".ptOfflineMsgDock").removeClass('show')}else if(scope.stickyNoteView){$(".ptOfflineMsgSticky").removeClass('show')}}scope.showImageUpload=true;return false}else{if(scope.staffInviteId>0){if(scope.onCallUserSet.size==1&&scope.onCallUserSet.has(global.TrUserId)||scope.isStaffEnableforTv&&global.loginUserType===scope.USER_TYPE_STAFF){scope.endTelevisitWithCheckoutFlag=true}else{scope.interruptTeleVisit()}}else{scope.endTelevisitWithCheckoutFlag=true}}};function isSummaryUpdated(data,conversation){if(conversation&&conversation!==''){isSummaryGenerated=true}}scope.interruptTeleVisit=function(callendReason){scope.inviteeFeature.onlineUserIds=null;scope.inviteeFeature.hideInviteLayout();$("#invitePopupWrapper").css('display','none');$("#tvFullView").append($("#containerDIV"));$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/endCall"),data:{inviteeId:global.TrUserId,encounterId:mySharedService.encounterId},type:"POST","async":false,success:function(){let staffEndCallData={data:{encounterId:mySharedService.encounterId,inviteeId:global.TrUserId}};opentokService.getGeneralSession().signal({type:"staffEndCall",data:staffEndCallData},function(error){if(error){ecwAlert("Unable to perform operation.")}})},error:function(e){console.log("decline Staff Invite ERROR :"+e.message)}});removeSunohSession();telemedInviteService.unbindEventListeners();callendReason=callendReason||2;scope.stopScreenSharing();scope.calling=false;scope.isFullScreen=false;scope.isVideoCallRunning=false;scope.isPubInitiated=false;scope.joinRequestSent=false;telemedCallRunningService.clearCallRunning();scope.onCallUserSet["delete"](global.TrUserId);scope.endTelevisitWithCheckoutFlag=false;if(scope.isPatientOnline&&scope.staffInviteId==0){scope.endTelevisitWithoutCheckoutFlag=true;scope.reconnecting=true;$(".teleVisitJoinBtn").html("<i ng-show=\"isPatientOnline\" class=\"icon icon-online\"></i> Join TeleVisit");$(".teleVisitJoinBtn").removeClass('disabled');$(".icon-online").show()}else{$(".teleVisitJoinBtn").hide();scope.isPatientOnline=false}scope.isPublishing=false;scope.isInOtherProgressNote=false;scope.showUserNavigationMsg=false;scope.isMsgDisplay=true;scope.missedMsg=0;scope.isScreenSubscribed=false;isNetworkDisconnected=false;scope.isTranslationON=false;scope.translatorAdded=false;scope.patientLang="en";scope.providerLang="en";scope.isMaleVoice=0;scope.sourceLanguage="en";scope.targetLanguage="en";scope.azureSpeech=false;scope.isProviderTranslationON=false;scope.isTranslatorON=false;stopSubscriberCloseCaption();stopPublisherCloseCaption();scope.pauseCaption=false;scope.disableCCAction=false;scope.teleView=0;opentokVideoService.getSession().unsubscribe(scope.subscriber);if(scope.screenSubscriber){opentokVideoService.getSession().unsubscribe(scope.screenSubscriber)}opentokVideoService.getSession().unpublish(scope.publisher);if(scope.translator){opentokVideoService.getSession().unpublish(scope.translator);scope.translator.destroy();scope.translator=null}if(opentokVideoService.getSession()){opentokVideoService.getSession().disconnect()}opentokVideoService.destorySession();if(scope.onCallUserSet.size<=0&&scope.providerPatientConv!==''&&scope.providerPatientOrgConv.length>0){openTVSummary()}sendDetailsToJTN(callendReason,scope.staffInviteId,scope.providerPatientConv,scope.providerPatientOrgConv,scope.gptAnalysis,scope.convoId,isSummaryUpdated);scope.showclosedCaptionDiv=false;scope.providerPatientOrgConv=[];scope.providerPatientConv="";callingInfo=null;var date=new Date;var checkoutTime=date.getHours()+":"+date.getMinutes()+":"+date.getSeconds();$.post("/mobiledoc/jsp/telemed/telemedResponse.jsp","action=timeoutwithoutstatusCheckOut&trUserId="+global.TrUserId+"&encId="+mySharedService.encounterId+"&patientId="+mySharedService.patientId+"&time="+checkoutTime+"&t="+new Date).done(function(data){patientDocumentService.deleteImages(mySharedService.encounterId).success(function(data){})});mySharedService.unLock();if(scope.isInProgressNote&&mySharedService.nextEncounterId!=null&&mySharedService.nextPatientId!=null&&mySharedService.nextUserId!=null){mySharedService.swapEncounter()}if(scope.isHealowPlusUser){$(".televisionbox").hide();$("#teleVisitView_"+scope.$id).show()}if(scope.isInProgressNote)scope.inProgressNote();scope.isInOtherProgressNote=false;$timeout(function(){scope.endTelevisitWithoutCheckoutFlag=false},1e4);scope.screenShareContainer=null;$("#teleChatBox").css("right","0px");$("#teleChatBox").css("left","");$("#teleChatBox").css("top","40px");scope.w=minWidth;scope.h=minHeight;if(scope.stickyNoteView)$('.televisionbox').parent().css('width','')};function processingSummaryCSS(){$('.sunohicons-sunoh-summary1').removeClass('sunoh-right-btn-green');$('.sunohicons-sunoh-summary1').addClass('sunoh-right-btn-blink');$('.sunoh-right-btn').attr('title','Sunoh Summary is being generated');$('.sunoh-right-btn').css('background','#fff')}function openTVSummary(){if(!scope.tvAISummaryEnabled){return}SunohService.checkSummaryStatus();let summaryInterval=setInterval(function(){if(isSummaryGenerated){isSummaryGenerated=false;clearInterval(summaryInterval)}},2e3)}function notifySummaryStatus(){notification.show('success','','Sunoh Summary for this visit will be available on Progress note.',1e4)}scope.closeInvitation=function(){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/closeInvite"),data:{encounterId:mySharedService.encounterId},type:"POST",success:function(data){let closeInvitesData={data:{encounterId:mySharedService.encounterId}};opentokService.getGeneralSession().signal({type:"closeInvites",data:closeInvitesData},function(error){if(error){ecwAlert("Unable to perform operation.")}})},error:function(e){console.log("close invites have ERROR :"+e.message)}})};scope.unPublishProvider=function(){opentokVideoService.getSession().unpublish(scope.publisher)};scope.endTeleVisit=function(){scope.inviteeFeature.hideInviteLayout();$("#invitePopupWrapper").css('display','none');scope.inviteeFeature.onlineUserIds=null;telemedInviteService.unbindEventListeners();scope.closeInvitation();scope.stopScreenSharing();$("#tvFullView").append($("#containerDIV"));scope.endTelevisitWithCheckoutFlag=false;scope.showImageUpload=false;scope.isInOtherProgressNote=false;scope.calling=false;scope.isFullScreen=false;scope.joinRequestSent=false;scope.isVideoCallRunning=false;scope.teleView=0;scope.isPubInitiated=false;scope.screenShareContainer=null;isNetworkDisconnected=false;scope.onCallUserSet["delete"](global.TrUserId);if(scope.isPatientOnline&&scope.staffInviteId==0){scope.reconnecting=true;$(".teleVisitJoinBtn").html("<i ng-show=\"isPatientOnline\" class=\"icon icon-online\"></i> Join TeleVisit");$(".teleVisitJoinBtn").removeClass('disabled');$(".icon-online").show()}else{$(".teleVisitJoinBtn").hide();$("#patientOfflineSpan").hide();scope.isPatientOnline=false}removeSunohSession();opentokVideoService.getSession().signal({type:"doctor",data:{to:mySharedService.patientId,from:mySharedService.providerID,loggedInId:global.TrUserId,action:"hangup"}},function(error){if(!error){scope.isVideoCallRunning=false;telemedCallRunningService.clearCallRunning();scope.showUserNavigationMsg=false;scope.isMsgDisplay=true;scope.isFullScreen=false;isVideoCallRunning=false;scope.isPubInitiated=false;scope.starttime=false;scope.reconnecting=false;scope.calling=false;scope.callStatus="";scope.missedMsg=0;scope.showPtDocs=false;scope.stopTimer();opentokVideoService.getSession().unpublish(scope.publisher);opentokVideoService.getSession().unsubscribe(scope.subscriber);if(scope.screenSubscriber){opentokVideoService.getSession().unsubscribe(scope.screenSubscriber)}if(scope.translator){opentokVideoService.getSession().unpublish(scope.translator);scope.translator.destroy();scope.translator=null}scope.showclosedCaptionDiv=false;scope.pauseCaption=false;scope.disableCCAction=false;stopSubscriberCloseCaption();stopPublisherCloseCaption();scope.isScreenSubscribed=false;if(opentokVideoService.getSession()){opentokVideoService.getSession().disconnect()}opentokVideoService.destorySession();var date=new Date;var checkoutTime=date.getHours()+":"+date.getMinutes()+":"+date.getSeconds();$.post("/mobiledoc/jsp/telemed/telemedResponse.jsp","action=statusCheckOut&trUserId="+global.TrUserId+"&encId="+mySharedService.encounterId+"&patientId="+mySharedService.patientId+"&time="+checkoutTime+"&strStatus=CheckOut"+"&t="+new Date).done(function(data){patientDocumentService.deleteImages(mySharedService.encounterId).success(function(data){})});if(scope.ptHangUp){scope.isScreenShot=false}if(scope.isHealowPlusUser){$(".televisionbox").hide();$("#teleVisitView_"+scope.$id).show();SessionService.showHConnectActivity();SessionService.resetTVVarOnEndCall()}if(scope.chats[mySharedService.encounterId]!==undefined){delete scope.chats[mySharedService.encounterId];scope.missedMsg=0}if(typeof callingInfo["hangup"]=='undefined'){callingInfo["hangup"]=3}let reason=scope.ptHangUp?LOG_REASONS.REASON_PATIENT_ENDED_CALL:LOG_REASONS.REASON_PROVIDER_CHECKEDOUT_CALL;if(scope.onCallUserSet.size<=0&&scope.providerPatientConv!==''&&scope.providerPatientOrgConv.length>0){openTVSummary()}if(scope.staffInviteId==0||scope.isStaffEnableforTv){let invitedStaffId=scope.staffInviteId;if(scope.staffInviteId!==0&&scope.isStaffEnableforTv){invitedStaffId=0}sendDetailsToJTN(LOG_REASONS.REASON_PROVIDER_CHECKEDOUT_CALL,invitedStaffId,scope.providerPatientConv,scope.providerPatientOrgConv,scope.gptAnalysis,scope.convoId,isSummaryUpdated)}scope.providerPatientOrgConv=[];scope.providerPatientConv="";scope.ptHangUp=false;callingInfo=null;mySharedService.unLock();if(scope.isInProgressNote&&mySharedService.nextEncounterId!=null&&mySharedService.nextPatientId!=null&&mySharedService.nextUserId!=null){mySharedService.swapEncounter()}if(scope.isInProgressNote){scope.inProgressNote()}$('.televisionbox').parent().css('width','auto')}else{console.log("Error"+error.code+"->"+error.message)}});scope.isPublishing=false;$("#teleChatBox").css("right","0px");$("#teleChatBox").css("left","");$("#teleChatBox").css("top","40px");scope.w=minWidth;scope.h=minHeight};scope.startTimer=function(){var updateTime=function(){sec++;if(sec==60){sec=0;min=min+1}if(min==60){min=0;hour+=1}if(sec<=9){sec="0"+sec}var time=hour>0?(hour<=9?"0"+hour+":":hour)+(min<=9?"0"+min:min)+":"+sec:""+(min<=9?"0"+min:min)+":"+sec;scope.time=time;scope.cancelTimer();timer=$timeout(updateTime,1e3)};updateTime()};scope.stopTimer=function(){sec=-1;min=0;hour=0;scope.cancelTimer()};scope.pauseTimer=function(){scope.cancelTimer()};scope.cancelTimer=function(){if(timer!=null){$timeout.cancel(timer);timer=null}};scope.isExistingInvite=function(enc){for(var i=0;i<scope.invitedUserList.length;i++){if(scope.invitedUserList[i].encounterId===enc){return true}}return false};$(".lastStaffInviteLog").each(function(index){let sentTime=$(this).attr("sentTime");let lastInviteDate=new Date(sentTime);let lastInviteTime=lastInviteDate.getTime();let timeDiff=currentTime-lastInviteTime;let lastInviteText=scope.getLastStaffInviteText(timeDiff);$(this).html(" "+lastInviteText)});scope.lastInvitedLog=undefined;scope.getUpdatedLastInvited=function(){let currentDate=new Date;let startTimeMillisUTC=new Date(currentDate.getTime()+currentDate.getTimezoneOffset()*6e4);let currentTime=startTimeMillisUTC.getTime();$(".lastInviteNotifyLog").each(function(index){let sentTime=$(this).attr("sentTime");let lastInviteDate=new Date(sentTime);let lastInviteTime=lastInviteDate.getTime();let timeDiff=currentTime-lastInviteTime;let lastInviteText=scope.getLastInviteText(timeDiff);$(this).html("Invited "+lastInviteText)})};scope.getLastStaffInviteText=function(timeDiff){let secs=Math.floor(timeDiff/1e3);if(secs<60)return"Last invited few seconds ago";if(secs<3600)return"Last invited "+Math.floor(secs/60)+" minutes ago";if(secs<86400)return"Last invited "+Math.floor(secs/3600)+" hours ago";if(secs<2592001)return"Last invited "+Math.floor(secs/86400)+" days ago"};scope.getLastInviteText=function(timeDiff){let secs=Math.floor(timeDiff/1e3);if(secs<60)return" few seconds ago";if(secs<3600)return Math.floor(secs/60)+" minutes ago";if(secs<86400)return Math.floor(secs/3600)+" hours ago";if(secs<2592001)return Math.floor(secs/86400)+" days ago"};scope.getInviteStaffPopUp=function(enc,isRequireOpenNotification,isMessage){if(!scope.isExistingInvite(enc)||isMessage){for(var i=0;i<scope.inviteList.length;i++){if(scope.inviteList[i].encounterId==enc){scope.updateInvitedUserList(scope.inviteList[i]);break}}scope.invitecount=scope.invitedUserList.length;if(isRequireOpenNotification&&scope.invitecount>0){$("#televisit-tplUl113").show();scope.getTelemedAppt(isRequireOpenNotification)}setScope()}};scope.updateInvitedUserList=function(inviteItem){for(var i=0;i<scope.invitedUserList.length;i++){if(scope.invitedUserList[i].encounterId==inviteItem.encounterId){scope.invitedUserList.splice(i,1)}}scope.invitedUserList.push(inviteItem)};scope.getTelemedAppt=function(callByInviteStaff){if(scope.loginUserType==scope.USER_TYPE_STAFF&&scope.invitedUserList.length>0){if(!$('#televisit-tplUl113').is(':visible')){$("#televisit-tplUl113").show()}else if($('#televisit-tplUl113').is(':visible')&&!callByInviteStaff){$("#televisit-tplUl113").hide()}}scope.isMsgDisplay=true;var params={action:'telemedlist',trUserId:global.TrUserId,prID:mySharedService.providerID,userType:global.loginUserType,time:$("#time").val(),grpvisit:isGroupDocumentationEnabled,t:(new Date).getTime(),currentdate:cdate};params=$.param(params);rosterService.invokeService(params).success(function(data){updateRosterList(data)})};scope.openChatBox=function(enc){if(scope.isHealowPlusUser){return}if(clickedOnCopyCodeBtn){clickedOnCopyCodeBtn=false;return}if(!scope.isVideoCallRunning){if(opentokVideoService.getSession()){opentokVideoService.getSession().disconnect()}opentokVideoService.destorySession()}if(enc.groupvisit!==null&&enc.groupvisit!==undefined&&enc.groupvisit==="1"){scope.editGroupApptPopup(enc.encounterID,enc.uid)}else{doChecksForPN(enc.encounterID,enc.uid,$http,'ovLoader')}document.getElementById("rosterMainDiv").className="pull-right"};scope.editGroupApptPopup=function(encId,docId){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs(scope,$ocLazyLoad,undefined,$modal).groupDocEditLink(encId,docId,global.TrUserId)},function(e){})};scope.openCurrentPN=function(){doChecksForPN(mySharedService.encounterId,mySharedService.patientId,$http,'ovLoader')};scope.connect=function(error){if(error){console.log("Error"+error.code+"->"+error.message);scope.calling=false}};scope.generalSessionConnectionCreated=function(event){console.log("General Session connection created.")};scope.connectionCreated=function(event){try{var remoteData=$.parseJSON(event.connection.data);var isPatient=remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="patient";if(isPatient){if(event.connections.length>0){scope.isPatientOnline=true;masterDestroyConnectionCalled=false;scope.onlinecount=scope.onlinecount+1;var data=$.parseJSON(event.connection.data);if(scope.users[data.data.encId]==undefined){var params={action:'telemedlist',trUserId:global.TrUserId,prID:mySharedService.providerID,userType:global.loginUserType,grpvisit:isGroupDocumentationEnabled,time:$("#time").val(),t:(new Date).getTime(),currentdate:cdate};params=$.param(params);rosterService.invokeService(params).success(function(response){updateRosterList(response);updateRosterListPresence(data.data.encId,true);if(Object.keys(scope.users).length>0){if(data.data.encId!=undefined&&multipleMasterUserReferenecs[data.data.encId]==null){multipleMasterUserReferenecs[data.data.encId]=1}var localDate=new Date;var arrivalTime=localDate.getHours()+":"+localDate.getMinutes()+":"+localDate.getSeconds();$.post("/mobiledoc/jsp/telemed/telemedResponse.jsp","action=statusArrival&trUserId="+$("#trUserId").val()+"&encId="+data.data.encId+"&time="+arrivalTime+"&patientId="+data.data.ptid).done(function(data){})}})}else{updateRosterListPresence(data.data.encId,true);if(data.data.encId!=undefined&&multipleMasterUserReferenecs[data.data.encId]==null){multipleMasterUserReferenecs[data.data.encId]=1}else if(data.data.encId!=undefined&&multipleMasterUserReferenecs[data.data.encId]!=null){multipleMasterUserReferenecs[data.data.encId]=2}scope.$apply();var localDate=new Date;var arrivalTime=localDate.getHours()+":"+localDate.getMinutes()+":"+localDate.getSeconds();$.post("/mobiledoc/jsp/telemed/telemedResponse.jsp","action=statusArrival&trUserId="+$("#trUserId").val()+"&encId="+data.data.encId+"&time="+arrivalTime+"&patientId="+data.data.ptid).done(function(data){})}scope.getInviteStaffPopUp(data.data.encId,false,false)}scope.$apply()}else if(remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="contact"&&remoteData.data.relation&&remoteData.data.relation!="Staff"&&remoteData.data.relation!="Provider"&&remoteData.data.encId===mySharedService.encounterId&&isVideoCallRunning&&!telemedInviteService.utils.contactsConnectionReferences[remoteData.data.inviteid]){let sendToUserID=scope.getSendToId(true);if(sendToUserID===global.TrUserId){telemedInviteService.utils.displayConfirmationToolTip(event,remoteData)}setScope()}else if(remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="contact"&&remoteData.data.relation&&(remoteData.data.relation==="Staff"||remoteData.data.relation==="Provider")&&remoteData.data.encId===mySharedService.encounterId){scope.isInProgressNote=true;setTimeout(function(){scope.signalCallRunningStatus()},1e3);setScope()}else if(scope.staffInviteId==0&&scope.USER_TYPE_STAFF===global.loginUserType&&remoteData&&remoteData.uid&&remoteData.uid==global.TrUserId){scope.signalCallRunningStatus()}}catch(e){telemedLoggingService.error(e)}};scope.signalCallRunningStatus=function(){opentokService.getSession().signal({type:"getRunningStatus",data:{userId:global.TrUserId}},function(error){if(error){console.log("Error in sending Signal"+error.code+"->"+error.message)}})};scope.displayConfirmationPopup=function(){let providerInfo=getCachedProviderInfo(mySharedService.providerID);let sendToId=scope.getSendToId(false);if(sendToId>0){let confirmPopupData={data:{inviteid:scope.staffInviteId,inviteby:scope.inviterName,username:global.TrUserName,relation:global.loginUserType==2?'Staff':'Provider',userid:global.TrUserId,sendTo:sendToId}};opentokService.getSession().signal({type:"inviteStaffConfirmation",data:confirmPopupData},function(error){if(error){ecwAlert("Unable to perform operation.")}else{$("#patientOfflineSpan").show();$("#patientOfflineSpan").text("Request pending");$(".teleVisitJoinBtn").text("Request pending");$(".teleVisitJoinBtn").addClass('disabled')}})}else{scope.connectToVideoSession()}};scope.getSendToId=function(isInviteContact){if(scope.onCallUserSet.size>0){if(scope.staffInviteId>0&&scope.invitebyId>0&&scope.onCallUserSet.has(scope.invitebyId.toString())){return scope.invitebyId}else{var onCallUserArr=Array.from(scope.onCallUserSet);if(scope.onCallUserSet.has(mySharedService.providerID)&&(mySharedService.providerID!=global.TrUserId||isInviteContact)){return mySharedService.providerID}else if(onCallUserArr[0]!==mySharedService.providerID){return onCallUserArr[0]}else{return onCallUserArr[1]}}}else{return 0}};scope.displayTvUserConfirmPopup=function(){let confirmPopupData={data:{username:global.TrUserName,userid:global.TrUserId,encId:mySharedService.encounterId,sendTo:scope.getSendToId(false)}};opentokService.getSession().signal({type:"tvUserConfirmation",data:confirmPopupData},function(error){if(error){ecwAlert("Unable to perform operation.")}else{$(".teleVisitJoinBtn").text("Request pending");$(".teleVisitJoinBtn").addClass('disabled');setScope()}})};scope.streamDestroyedHandler=function(event){telemedInviteService.utils.clearContactStream(event);setContainerLayout(100);if(event.stream.videoType==='screen'){if(scope.screenSubscriber){opentokVideoService.getSession().unsubscribe(scope.screenSubscriber)}scope.isScreenSubscribed=false;$(".userchat").show();setContainerLayout(20)}};scope.changeStatusOfInviteStaff=function(connectedUserId){scope.inviteeFeature.onlineUserIds["delete"](connectedUserId);for(var i=0;i<scope.inviteeFeature.scheduledProvider.length;i++){if(scope.inviteeFeature.scheduledProvider[i].id===connectedUserId&&scope.inviteeFeature.scheduledProvider[i].status===1){scope.inviteeFeature.scheduledProvider[i].status=2;scope.inviteeFeature.scheduledProvider[i].isExist=false}}for(var i=0;i<scope.inviteeFeature.assignStaffList.length;i++){if(scope.inviteeFeature.assignStaffList[i].id===connectedUserId&&scope.inviteeFeature.assignStaffList[i].status===1){scope.inviteeFeature.assignStaffList[i].status=2}}for(var i=0;i<scope.inviteeFeature.invitedStaffList.length;i++){if(scope.inviteeFeature.invitedStaffList[i].id===connectedUserId&&scope.inviteeFeature.invitedStaffList[i].status===1){scope.inviteeFeature.invitedStaffList[i].status=2}}};scope.connectionDestroyedHandler=function(event){var remoteData=$.parseJSON(event.connection.data);if(remoteData.data&&remoteData.data.usertype&&(remoteData.data.usertype==="patient"||remoteData.data.usertype==="contact")){if(remoteData.data.usertype==="patient"){var encRef=$.parseJSON(event.connection.data);if(scope.isVideoCallRunning){var date=new Date;var checkoutTime=date.getHours()+":"+date.getMinutes()+":"+date.getSeconds();$.post("/mobiledoc/jsp/telemed/telemedResponse.jsp","action=timeoutwithoutstatusCheckOut&trUserId="+global.TrUserId+"&encId="+encRef.data.encId+"&patientId="+encRef.data.ptid+"&time="+checkoutTime+"&t="+new Date).done(function(data){});if(scope.staffInviteId==0){sendDetailsToJTN(LOG_REASONS.REASON_PATIENT_DISCONNECTED_CALL,0,scope.providerPatientConv,scope.providerPatientOrgConv,scope.gptAnalysis,scope.convoId,isSummaryUpdated)}}if(encRef.data!=undefined&&multipleVideoReferences[encRef.data.encId]!=undefined&&multipleMasterUserReferenecs[encRef.data.encId]!=undefined&&multipleVideoReferences[encRef.data.encId]==2&&multipleMasterUserReferenecs[encRef.data.encId]==2){if(!masterDestroyConnectionCalled){videoDestroyConnectionCalled=true;return}else{multipleVideoReferences[encRef.data.encId]=1;multipleMasterUserReferenecs[encRef.data.encId]=1;return}}if(encRef.data.encId!=undefined&&multipleVideoReferences[encRef.data.encId]!=undefined){delete multipleVideoReferences[encRef.data.encId]}scope.pauseTimer();if(scope.ptHangUp){if(scope.staffInviteId>0){scope.closeInvitation()}scope.setPatient("ptCheckout");return}scope.setPatient("offline");scope.$apply(function(){scope.isPatientOnline=false;scope.calling=false;scope.reconnecting=false});$(".playermenu").css('visibility','display');if(scope.capturing){scope.capturing=false;jcrop_api.destroy()}$("#stickyvideo").hide();$("#stickyViewPoffline").show();if(remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="patient"){if(scope.isPublishing==false){scope.isVideoCallRunning=false;isVideoCallRunning=false;telemedCallRunningService.clearCallRunning()}}scope.createAlertDown('#errorstatus',Alerts.WARNING,'',scope.currentCallPatientName+' has left the call.',false,0)}else{scope.inviteeFeature.removeParticipant(remoteData);if(scope.staffInviteId==0){sendDetailsToJTN(LOG_REASONS.REASON_CONTACT_DISCONNECTED_CALL,remoteData.data.inviteid,scope.providerPatientConv,scope.providerPatientOrgConv,scope.gptAnalysis,scope.convoId,isSummaryUpdated)}let connectedUserId=0;if(remoteData.uid){connectedUserId=remoteData.uid}else if(remoteData.data.uid){connectedUserId=remoteData.data.uid}else if(remoteData.data.userid){connectedUserId=remoteData.data.userid}scope.changeStatusOfInviteStaff(connectedUserId);scope.createAlertDown('#errorstatus',Alerts.WARNING,'',remoteData.data.username+' has left the call.',false,0);if(connectedUserId!=global.TrUserId){scope.onCallUserSet["delete"](connectedUserId)}}}else{let connectedUserId=0;if(remoteData.uid){connectedUserId=remoteData.uid}else if(remoteData.data.uid){connectedUserId=remoteData.data.uid}else if(remoteData.data.userid){connectedUserId=remoteData.data.userid}scope.changeStatusOfInviteStaff(connectedUserId);var remoteVideoData=$.parseJSON(event.connection.data);var selfVideoData=$.parseJSON(event.target.connection.data);if(connectedUserId!=global.TrUserId){scope.onCallUserSet["delete"](connectedUserId)}if(selfVideoData&&remoteVideoData&&remoteVideoData.mdid===selfVideoData.mdid&&event.target.connection.id!==event.connection.id){}scope.createAlertDown('#errorstatus',Alerts.WARNING,'',remoteVideoData.username+' has left the call.',false,0);setScope()}};scope.sessionDisconnectHandler=function(event){scope.isVideoSessionConnected=false;if(scope.isVideoCallRunning&&event.reason!=='forceDisconnected'&&scope.staffInviteId==0){sendDetailsToJTN(LOG_REASONS.REASON_PROVIDER_DISCONNECTED_CALL,0,scope.providerPatientConv,scope.providerPatientOrgConv,scope.gptAnalysis,scope.convoId,isSummaryUpdated)}if(scope.isVideoCallRunning&&event.reason==='forceDisconnected'){scope.interruptTeleVisit()}};let handlerForSwitchToAudio=function(){if(global.TrUserId!==event.data['initiatedCallerId']){scope.isVideoPause=false;scope.pauseVideo();isSwitchedToAudio=true;scope.createAlertDown('#errorstatus',Alerts.WARNING,'','You have been switched to audio only mode due to low bandwidth.',false,0)}};scope.switchToAudioCall=function(isMultiparty){var data={initiatedCallerId:global.TrUserId};opentokVideoService.getSession().signal({type:'switchToAudio',data:data},function(error){if(error){console.log(error)}else{scope.isVideoPause=false;scope.pauseVideo();isSwitchedToAudio=true;if(isMultiparty.toString()!=='true'){scope.createAlertDown('#errorstatus',Alerts.WARNING,'','You have been switched to audio only mode due to low bandwidth.',false,0)}}})};scope.pauseVideo=function(){if(scope.isVideoPause==false){scope.publisher.publishVideo(false);scope.isVideoPause=true;telemedCallBandwidthService.hideBandwidthDiv(scope.publisher)}else{scope.publisher.publishVideo(true);scope.isVideoPause=false;if(isSwitchedToAudio.toString()==='true'){isSwitchedToAudio=false}telemedCallBandwidthService.showBandwidthDiv(scope.publisher)}};scope.muteAudio=function(){if(!scope.isMuted){scope.publisher.publishAudio(false);scope.isMuted=true}else{scope.publisher.publishAudio(true);scope.isMuted=false}};scope.generalSessionDestoryConnection=function(event){console.log("general Session Destory Connection")};scope.destoryConnection=function(event){var remoteData=verifiedConnectionData(event.connection.data);if(remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="patient"){if(event.connections.length>0){var data=$.parseJSON(event.connection.data);let oldSizeInvitedUserList=scope.invitedUserList.length;for(var i=0;i<scope.invitedUserList.length;i++){if(scope.invitedUserList[i].encounterId==data.data.encId){scope.invitedUserList.splice(i,1)}}scope.invitecount=scope.invitedUserList.length;scope.apptCount=scope.apptCount-(oldSizeInvitedUserList-scope.invitedUserList.length);$("#televisit-tplUl113").hide();scope.onlinecount=scope.onlinecount-1;if(scope.onlinecount==0){scope.isPatientOnline=false}if(data.data.encId!=undefined&&multipleVideoReferences[data.data.encId]!=undefined&&multipleMasterUserReferenecs[data.data.encId]!=undefined&&multipleVideoReferences[data.data.encId]==2&&multipleMasterUserReferenecs[data.data.encId]==2){if(!videoDestroyConnectionCalled){masterDestroyConnectionCalled=true;return}else{multipleVideoReferences[data.data.encId]=1;multipleMasterUserReferenecs[data.data.encId]=1;return}}if(data&&scope.users[data.data.encId]&&multipleMasterUserReferenecs[data.data.encId]&&multipleMasterUserReferenecs[data.data.encId]===2){multipleMasterUserReferenecs[data.data.encId]=1;return}if(data&&scope.users[data.data.encId]&&multipleMasterUserReferenecs[data.data.encId]&&multipleMasterUserReferenecs[data.data.encId]===1){delete multipleMasterUserReferenecs[data.data.encId]}updateRosterListPresence(data.data.encId,false);scope.$apply()}}else if(remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="contact"&&telemedInviteService.utils.contactsConnectionReferences[remoteData.data.inviteid]&&telemedInviteService.utils.contactsConnectionReferences[remoteData.data.inviteid].id===event.connection.id){delete telemedInviteService.utils.contactsStreams[remoteData.data.inviteid];delete telemedInviteService.utils.contactsConnectionReferences[remoteData.data.inviteid]}else if(remoteData&&remoteData.data&&remoteData.data.usertype&&remoteData.data.usertype==="contact"&&remoteData.data.relation&&(remoteData.data.relation==="Staff"||remoteData.data.relation==="Provider")&&remoteData.data.encId===mySharedService.encounterId){delete telemedInviteService.utils.contactsStreams[remoteData.data.inviteid];delete telemedInviteService.utils.contactsConnectionReferences[remoteData.data.inviteid]}};scope.sessionDisconnect=function(event){if(event.reason==="networkDisconnected"||event.reason==="networkTimedout"){scope.$apply(function(){scope.retrying=""});var counter=0;isErrorCalled=false;scope.hasInternetConnection=false;isNetworkDisconnected=true;scope.onlinecount=0;scope.resetUserPresence();if(scope.users[mySharedService.encounterId]){scope.isPatientOnline=scope.users[mySharedService.encounterId].presence}scope.pauseTimer();internetConnection.resetConnectionStatus();internetConnection.resetManualReattempt();internetConnection.lost(scope.reconnectedToSession,scope.internetError);var msg="Internet connection is lost. Retrying in "+internetConnection.getTimer()+" second(s)";scope.createAlertDown('#errorstatus',Alerts.ERROR,'',msg,false,0);scope.$watch(function(){return internetConnection.getTimer()},function(){if(internetConnection.getTimer()===0&&!isErrorCalled){counter++;msg="Retrying...";scope.retrying=msg;scope.createAlertDown('#errorstatus',Alerts.SUCCESS,'',msg,false,0)}else{if(!internetConnection.getManualReattemptStatus()&&!isErrorCalled){msg=counter>0?"Failed to reconnect("+counter+"). Retrying in "+internetConnection.getTimer()+" second(s).":"Internet connection is lost. Retrying in "+internetConnection.getTimer()+" second(s)";scope.retrying=msg;scope.messageDisplay(msg,Alerts.ERROR)}}})}};scope.messageDisplay=function(msg,alertType){$('#msg').text('');$('#errorstatus').attr("class","");$('#errorstatus').addClass(scope.mapAlertCssClass(alertType));$('#msg').text(msg)};scope.reconnectedToSession=function(){scope.$apply(function(){scope.createAlertUp('#errorstatus',false,'');scope.hasInternetConnection=true});if(scope.loginUserType===scope.USER_TYPE_STAFF){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/getEncInviteDetail"),data:{encId:mySharedService.encounterId,userId:global.TrUserId},type:"POST","async":false,success:function(data){if($.isEmptyObject(data)===false){scope.staffInviteId=data['inviteId'];scope.invitebyId=data['inviterId']}},error:function(e){console.log("get Staff Invite Detail ERROR :"+e.message)}})}if(scope.isVideoCallRunning){var params={action:'getVideoSession',encID:mySharedService.encounterId,ptId:mySharedService.patientId,prId:mySharedService.providerID,userType:global.loginUserType,source:"WebEMR",t:(new Date).getTime(),invitedID:scope.staffInviteId};if(scope.staffInviteId>0){params.action='getInviteVideoSession';params.userName=global.TrUserName;params.inviterId=scope.invitebyId}params=$.param(params);rosterService.invokeService(params).success(function(data){if(data){if(scope.USER_TYPE_STAFF===global.loginUserType){if(data.masterToken&&data.masterToken.length>0&&data.masterSession&&data.masterSession.length>0){if(scope.staffInviteId>0){scope.displayConfirmationPopup()}}else{return}}opentokVideoService.getSession().connect(data.videoToken.replace(/(\r\n|\n|\r)/gm,""),function(error){if(!error){if(!scope.isPatientOnline){scope.isVideoCallRunning=false;telemedCallRunningService.clearCallRunning();isVideoCallRunning=false;scope.isFullScreen=false;scope.calling=false;scope.isPublishing=false;scope.callStatus="";scope.isInOtherProgressNote=false;scope.stopTimer();mySharedService.unLock();if(scope.isInProgressNote&&mySharedService.nextEncounterId!=null&&mySharedService.nextPatientId!=null&&mySharedService.nextUserId!=null){mySharedService.swapEncounter()}if(scope.stickyNoteView){scope.changeViewToDockView()}isNetworkDisconnected=false;if(scope.isInProgressNote){scope.inProgressNote()}}else{scope.rePublishDoctorVideo(false)}}});if(scope.staffInviteId>0){scope.displayConfirmationPopup();scope.inviterName=data.inviterName}}else{console.log("Error in getting videoSession")}})}else{isNetworkDisconnected=false;if(scope.isInProgressNote){scope.inProgressNote()}}};scope.internetError=function(){isErrorCalled=true;var msg="Unable to reconnect due to network failure";scope.$apply(function(){scope.retrying=msg});scope.createAlertDownWithRetryLink('#errorstatus',Alerts.ERROR,'',msg,false,0,"<a href='#' ng-click='retryConnection();' class='televisitRetryLink'>Click here to Retry ..</a>");scope.$watch(function(){return internetConnection.getManualReattemptStatus()},function(){if(internetConnection.getManualReattemptStatus()){msg="Retrying...";scope.retrying=msg;scope.createAlertDown('#errorstatus',Alerts.SUCCESS,'',msg,false,0)}})};scope.retryConnection=function(){internetConnection.retry(scope.reconnectedToSession,scope.internetError,true)};scope.resetUserPresence=function(){resetRosterListPresence()};scope.masterSessionReconnecting=function(){scope.hasInternetConnection=false;scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Video connectivity issue, retrying...',false,0);scope.retrying="Video connectivity issue, retrying...";if(scope.$root.$$phase!='$apply'&&scope.$root.$$phase!='$digest'){scope.$apply()}};scope.masterSessionReconnected=function(){scope.hasInternetConnection=true;scope.createAlertDown('#errorstatus',Alerts.SUCCESS,'','Video connected successfully...',true,2e3);scope.retrying="Video connected successfully...";if(scope.$root.$$phase!='$apply'&&scope.$root.$$phase!='$digest'){scope.$apply()}};scope.sendPushNotification=function(encId,$event){try{if(encId!=null&&encId!=undefined){var param={action:'sendPushNotificationByHealow',encId:encId};param=$.param(param);$http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){if(data.trim()=="success"){scope.showPattientOffline=false;scope.shownotificationLoader=false;scope.showsuccessMsg=true;clearTimeout(timertosendNotification);timerforsuccessmsg=$timeout(function(){scope.showsuccessMsg=false;scope.appgoesBackgroungsignalreceived=false},3e3)}else{scope.appgoesBackgroungsignalreceived=true;scope.showPattientOffline=true;ecwAlert("Error while sending pushNotification","eClinicalWorks")}}).error(function(data,status,headers,config){clearTimeout(timertosendNotification);scope.showsuccessMsg=false;scope.shownotificationLoader=false;scope.showPattientOffline=true;ecwAlert("Error while sending pushNotification","eClinicalWorks")});if(timertosendNotification!=null){clearTimeout(timertosendNotification);timertosendNotification=null}if(timerforsuccessmsg!=null){clearTimeout(timerforsuccessmsg);timerforsuccessmsg=null}}}catch(err){console.log(err)}};scope.putOnHold=function(){try{var data={ut:scope.loginUserType,uid:global.TrUserId};opentokVideoService.getSession().signal({data:data,type:"putOnHold"},function(error){if(!error){scope.interruptTeleVisit(6)}else{ecwAlert("Issue while putting the call on Hold. Please try again later.")}})}catch(e){ecwAlert("Issue while putting the call on Hold. Please try again later.")}};scope.sendMessage=function(){var trimMsg=scope.txtMsgSend.trim();if(trimMsg.length>0){trimMsg=scope.escapeHtml(trimMsg);let data={data:trimMsg,type:global.loginUserType==1?"textMessageDoctor":"textMessageStaff",username:global.TrUserName};if(!scope.inviteeFeature.isBroadCastMessaging){scope.inviteeFeature.sendChatToSelectedPerson(data)}else{let uname=global.TrUserName;if(scope.staffInviteId>0){if(global.loginUserType==1){uname=uname+'(Provider)'}else{uname=uname+'(Staff)'}opentokVideoService.getSession().signal({type:global.loginUserType==1?"textMessageDoctor":"textMessageStaff",data:{msg:trimMsg,username:uname}},function(error){if(!error){scope.updateChatWindow(trimMsg)}})}else{opentokVideoService.getSession().signal(data,function(error){if(!error){scope.updateChatWindow(trimMsg)}})}}}else{$('#txtMsgSend').val('');$('#txtMsgSend').focus()}};scope.updateChatWindow=function(trimMsg){let currentdate=new Date;let msgtime=scope.formatDate(currentdate);let message=$sce.trustAsHtml(trimMsg);let chat={isMine:true,msgtime:msgtime,message:message};if(scope.chats[mySharedService.encounterId]===undefined){scope.chats[mySharedService.encounterId]=[]}scope.chats[mySharedService.encounterId].push(chat);var chatDIV=scope.dockView===true?$('#chatdisplaydivsticky'):$('#chatdisplaydiv');scope.stickyviewtxtMsgSend="";scope.txtMsgSend="";setScope();if(chatDIV.animate({scrollTop:chatDIV[0]})!==undefined){chatDIV.animate({scrollTop:chatDIV[0].scrollHeight})}};scope.stickyviewsendMessage=function(){var trimMsg=scope.stickyviewtxtMsgSend.trim();if(trimMsg.length>0){let data={data:trimMsg,type:"textMessageDoctor",username:global.TrUserName};if(!scope.inviteeFeature.isBroadCastMessaging){scope.inviteeFeature.sendChatToSelectedPerson(data)}else{let uname=global.TrUserName;if(scope.staffInviteId>0){if(global.loginUserType==1){uname=uname+'(Provider)'}else{uname=uname+'(Staff)'}}opentokVideoService.getSession().signal({type:global.loginUserType==1?"textMessageDoctor":"textMessageStaff",data:{msg:trimMsg,username:uname}},function(error){if(!error){scope.updateChatWindow(trimMsg)}})}}else{$('#stickyviewtxtMsgSend').val('');$('#stickyviewtxtMsgSend').focus()}};scope.$on('$destroy',function(){scope.lastInvitedLog=undefined});scope.takeSnap=function(){scope.takesnapLoading=false;scope.snapLoading=true;scope.imageData={};scope.endTelevisitWithCheckoutFlag=false;var imgData=scope.subscriber.getImgData();patientDocumentService.storeImage(mySharedService.encounterId,imgData,mySharedService.patientId).success(function(data){scope.refreshPatientDocuments();scope.viewPtDocs();scope.isScreenShot=true;scope.snapLoading=false;scope.takesnapLoading=true;$("#selectAllImg").attr('checked',false)})};scope.deleteSnapConfirmation=function(id,$event){$("#snapDeleteConfDialog").css('top',angular.element($event.target).offset().top+10).css('right',$(window).width()-angular.element($event.target).offset().left-25);scope.SnapDeleteConfirmation=true;scope.SnapDeleteId=id};scope.deleteSnapConfirmed=function(){scope.deleteSnap(scope.SnapDeleteId)};scope.closeSnapConfirm=function(){scope.SnapDeleteConfirmation=false};scope.deleteSnap=function(id){scope.showImageUpload=false;scope.endTelevisitWithCheckoutFlag=false;scope.endTelevisitWithoutCheckoutFlag=false;patientDocumentService.deleteImageById(id).success(function(data){if(Object.keys(scope.patientDocs).length==1)scope.patientDocs=[];else delete scope.patientDocs[id];if(Object.keys(scope.patientDocs).length==0){scope.showPtDocs=false;scope.isScreenShot=false;if(!scope.isHealowPlusUser){setContainerLayout(20)}else{scope.totalSelectedImages=0;SessionService.hideImgPanel()}}});scope.SnapDeleteConfirmation=false;$('.chatbox').draggable({containment:".main-wrap",scroll:false,drag:restrictBoundary})};scope.deleteAllSnapConfirmed=function(){scope.isdeleteAll=false;var flag=false;angular.forEach(scope.patientDocs,function(value,key){if(value.selected){flag=true;patientDocumentService.deleteImageById(key).success(function(data){delete scope.patientDocs[key];if(Object.keys(scope.patientDocs).length<=1){scope.showPtDocs=false;scope.isScreenShot=false;if(!scope.isHealowPlusUser){setContainerLayout(20)}else{scope.totalSelectedImages=0;SessionService.hideImgPanel()}}})}});if(!flag){patientDocumentService.deleteImages(mySharedService.encounterId).success(function(data){scope.patientDocs=[];scope.showPtDocs=false;scope.isScreenShot=false;if(!scope.isHealowPlusUser){setContainerLayout(20)}else{SessionService.hideImgPanel();scope.totalSelectedImages=0}})}};scope.checkDelete=function(){scope.deleteSelectedSnaps=false;angular.forEach(scope.patientDocs,function(value,key){if(value.selected){scope.deleteSelectedSnaps=true}});scope.isImageMasterSel=false};scope.lowestKeyPtDoc=0;scope.highestKeyPtDoc=0;scope.totalImages=0;scope.refreshPatientDocuments=function(){patientDocumentService.getImages(mySharedService.encounterId).success(function(data){scope.patientDocs=data;if($.isEmptyObject(scope.patientDocs)==false){scope.showPtDocs=true;scope.isScreenShot=true}else{scope.showPtDocs=false}if(!scope.isHealowPlusUser){setContainerLayout(20)}else{var keys=Object.keys(scope.patientDocs).sort();scope.lowestKeyPtDoc=keys[0];scope.highestKeyPtDoc=keys.pop()}scope.totalImages=Object.keys(scope.patientDocs).length})};scope.startUpload=function(){var flag=false;var imgCounter=0;angular.forEach(scope.patientDocs,function(value,key){if(value.selected){flag=true}});if(flag==false){scope.isUploadMsgShow=true}else{scope.showImageUpload=false;scope.endTelevisitWithCheckoutFlag=false;scope.endTelevisitWithoutCheckoutFlag=false;angular.forEach(scope.patientDocs,function(capture,key){if(capture.selected){imgCounter++;scope.patientDocs[capture.id].uploading=true;var currDate=new Date;var scannedDate=scope.formatUploadDocDate(currDate,1);var customname=scope.formatUploadDocDate(currDate,2);var folderDirPath="mobiledoc/"+scope.formatUploadDocDate(currDate,3);var filename=capture.encId+"_"+(new Date).getTime()+"_"+imgCounter+".png";var reason=scope.users[capture.encId].reason;if(reason!=''&&reason!='Reason not mentioned')customname+='-'+reason;else reason="";patientDocumentService.uploadImageScannedDoc(capture.encId,capture.ptId,filename,customname,reason,scannedDate,folderDirPath).success(function(strXML){var x2js=new X2JS;strXML=strXML.replace(/(?:\r\n|\r|\n)/g,'');var jsonData=x2js.xml_str2json(strXML);patientDocumentService.uploadImage(capture.id,filename,capture.encId,jsonData.Envelope.Body["return"].documentId).success(function(data){if(scope.isInProgressNote&&!scope.isInOtherProgressNote&&!scope.isHealowPlusUser)refreshDashboard(capture.encId,capture.ptId,"progressNote","");delete scope.patientDocs[capture.id];if(Object.keys(scope.patientDocs).length===0){scope.togglePtDocs();SessionService.hideImgPanel()}scope.isImageMasterSel=false})})}})}};scope.totalSelectedImages=0;scope.isImageMasterSel=false;scope.selectImage=function(id){if(scope.patientDocs[id].selected===false){scope.patientDocs[id].selected=true;++scope.totalSelectedImages}else{scope.patientDocs[id].selected=false;--scope.totalSelectedImages;if(scope.totalSelectedImages===0){scope.isImageMasterSel=false}}};scope.selectAllImages=function(){if(!scope.isImageMasterSel){scope.isImageMasterSel=true;angular.forEach(scope.patientDocs,function(value,key){++scope.totalSelectedImages;value.selected=scope.isImageMasterSel})}else{angular.forEach(scope.patientDocs,function(value,key){--scope.totalSelectedImages;if(scope.totalSelectedImages===0){scope.isImageMasterSel=false}value.selected=scope.isImageMasterSel})}};scope.imageDataArr=[];scope.imageData={};scope.startCapture=function(){$(".playermenu").css('visibility','hidden');scope.capturing=true;scope.takepicture();scope.cropImage()};scope.cancelCapturing=function(){if(scope.capturing){$(".playermenu").css('visibility','visible');scope.capturing=false;if(jcrop_api!=null){jcrop_api.destroy()}}};scope.cropImage=function(){$.removeData($('#telepic'),'elevateZoom');$('.zoomContainer').remove();jQuery(function($){$('#telepic').Jcrop({onSelect:function(c){var canvas=document.getElementById("teleCanvas");var context=canvas.getContext("2d");var photo=document.getElementById("telepic");context.clearRect(0,0,canvas.width,canvas.height);context.drawImage(photo,c.x,c.y,c.w,c.h,0,0,canvas.width,canvas.height);var imgData=canvas.toDataURL();scope.imageData={};scope.imageData['imgSrc']=imgData;scope.imageData['isSelected']=false;scope.imageDataArr.push(scope.imageData);imgData=imgData.replace("data:image/png;base64,","");patientDocumentService.storeImage(mySharedService.encounterId,imgData,mySharedService.patientId).success(function(data){scope.refreshPatientDocuments()});scope.stopCapture();$(".playermenu").css('visibility','visible')},aspectRatio:1},function(){jcrop_api=this})})};scope.magnifyPicture=function(){scope.takepicture();$('#telepic').elevateZoom({zoomType:"lens",lensShape:"round",lensSize:200});scope.magnify=true};scope.stopMagnify=function(){scope.magnify=false;$.removeData($('#photo'),'elevateZoom');$('.zoomContainer').remove()};scope.stopCapture=function(){scope.viewPtDocs();scope.capturing=false;jcrop_api.destroy()};scope.takepicture=function(){$("#telepic").show();var photo=document.getElementById("telepic");var canvas=document.getElementById("teleCanvas");var context=canvas.getContext('2d');var video=$("#C2CallApplet_"+scope.$id).find("video").get(0);var width=$("#"+scope.subscriber.id).width(),height=$("#"+scope.subscriber.id).height();var top=$("#"+scope.subscriber.id).css("top");canvas.width=width;canvas.height=height;context.clearRect(0,0,canvas.width,canvas.height);context.drawImage(video,0,0,width,height);var factor=$("#C2CallApplet_"+scope.$id).width()-width;var marginLeft;marginLeft=factor>1?Math.round(factor/2):factor;$('.output').css('margin-left',marginLeft+"px");$('.output').css('top',top);var data=canvas.toDataURL('image/png');if(jcrop_api!=null){jcrop_api.setImage(data)}photo.setAttribute('src',data);$("#telepic").width(width);$("#telepic").height(height)};scope.clearphoto=function(){var photo=document.getElementById("telepic");var canvas=document.getElementById("teleCanvas");var context=canvas.getContext('2d');context.fillRect(0,0,canvas.width,canvas.height);var data=canvas.toDataURL('image/png');photo.setAttribute('src',data)};scope.formatDate=function(d){var hh=d.getHours();var m=d.getMinutes();var dd="AM";var h=hh;if(h>=12){h=hh-12;dd="PM"}if(h==0){h=12}m=m<10?"0"+m:m;h=h<10?"0"+h:h;var time=h+':'+m+' '+dd;return time};scope.formatUploadDocDate=function(d,mode){var year=d.getFullYear();var month=d.getMonth()+1;var date=d.getDate();month=month<10?"0"+month:month;date=date<10?"0"+date:date;if(mode==1)return year+"-"+month+"-"+date;else if(mode==3)return year+"/"+month+date+year;var hh=d.getHours();var m=d.getMinutes();var s=d.getSeconds();var dd="AM";var h=hh;if(h>=12){dd="PM"}m=m<10?"0"+m:m;s=s<10?"0"+s:s;if(mode==2)return year+"-"+month+"-"+date+"."+hh+":"+m+":"+s+"."+dd+"-TV";else return null};scope.hoverIn=function(){scope.isTvjellyHover=true};scope.hoverOut=function(){scope.isTvjellyHover=false};scope.showMultipleLoginMessage=function(){scope.showMultipleLoginFoundMessage=true};scope.hideMultipleLoginMessage=function(){scope.showMultipleLoginFoundMessage=false};scope.hoverControlsIn=function(){$('#stickyviewcontrolpanel').css('display','');$('#stickyviewheader').css('display','');$('#stickyviewcontrolpanel').addClass('videoControlsOnHover');$('#stickyviewheader').addClass('videostickyviewheader')};scope.hoverControlsOut=function(){if(scope.ptHangUp){return}$('#stickyviewcontrolpanel').css('display','none');$('#stickyviewheader').css('display','none');$('#stickyviewcontrolpanel').removeClass('videoControlsOnHover');$('#stickyviewheader').removeClass('videostickyviewheader')};scope.showAndHideControl=function(){$('#stickyviewcontrolpanel').css('display','');$('#stickyviewheader').css('display','');$('#stickyviewcontrolpanel').addClass('videoControlsOnHover');$('#stickyviewheader').addClass('videostickyviewheader')};scope.redirectToOfficeVisit=function(){if(scope.isHealowPlusUser){$window.location='#/mobiledoc/jsp/webemr/healowPlus/trackingBoard/healowTrackingboard.jsp'}else{$window.location='#/mobiledoc/jsp/webemr/jellybean/officevisit/officeVisits.jsp'}};scope.escapeHtml=function(text){var map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};return text.replace(/[&<>"']/g,function(m){return map[m]})};scope.getDevices=function(){OT.getDevices(function(error,devices){angular.forEach(devices,function(value,key){if(value.kind=="audioInput"){value.label=scope.formatDeviceLabel(value.label);scope.audioInputDevices.push(value)}else if(value.kind=="videoInput"){value.label=scope.formatDeviceLabel(value.label);scope.videoInputDevices.push(value)}});if(scope.audioInputDevices.length==0){var obj={deviceId:"-1",kind:"audioInput",label:"No audio device found"};scope.audioInputDevices.push(obj)}if(scope.videoInputDevices.length==0){var obj1={deviceId:"-1",kind:"videoInput",label:"No video device found"};scope.videoInputDevices.push(obj1)}})};scope.openLoaderforPushNotification=function(event){event.stopPropagation();scope.shownotificationLoader=true;scope.showPattientOffline=false;try{timertosendNotification=$timeout(function(){scope.shownotificationLoader=false;scope.showPattientOffline=true},7e3)}catch(error){clearTimeout(timertosendNotification);scope.shownotificationLoader=false;scope.showPattientOffline=true}};scope.signalappBackgoundRecievedHandler=function(event){try{event.data=$.parseJSON(event.data);var param={action:'savePushnotificationDtl',encounterId:event.data.encId,time:(new Date).getTime(),pushNotificationData:JSON.stringify({healow_guid:event.data.healow_guid,healow_uid:event.data.healow_uid,encId:event.data.encId,udid:event.data.udid,bundle_id:event.data.bundle_id,access_token:event.data.access_token})};param=$.param(param);$http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(data){console.log(data);scope.appgoesBackgroungsignalreceived=true}).error(function(data,status,headers,config){console.log("ERROR")})}catch(e){console.log(e)}};scope.staffEndCall=function(event){let inviteeId=event.data.data.inviteeId;for(var i=0;i<scope.inviteeFeature.assignStaffList.length;i++){scope.inviteeFeature.assignStaffList[i].status=0;if(scope.inviteeFeature.assignStaffList[i].id===inviteeId){scope.inviteeFeature.assignStaffList[i].isExist=false}}for(var i=0;i<scope.inviteeFeature.invitedStaffList.length;i++){scope.inviteeFeature.invitedStaffList[i].status=0;if(scope.inviteeFeature.invitedStaffList[i].id===inviteeId){scope.inviteeFeature.assignStaffList[i].isExist=false}}for(var i=0;i<scope.inviteeFeature.scheduledProvider.length;i++){scope.inviteeFeature.scheduledProvider[i].status=0;if(scope.inviteeFeature.scheduledProvider[i].id===inviteeId){scope.inviteeFeature.assignStaffList[i].isExist=false}}if(scope.inviteeFeature.scheduledProvider.length>0&&scope.inviteeFeature.scheduledProvider[0].id==inviteeId){scope.inviteeFeature.scheduledProvider[0].isExist=false}if(inviteeId==global.TrUserId){for(var i=0;i<scope.invitedUserList.length;i++){if(scope.invitedUserList[i].encounterId==event.data.data.encounterId){scope.invitedUserList.splice(i,1);scope.updateAppointmentCount();scope.invitecount=scope.invitedUserList.length;scope.getTelemedAppt(false);scope.hideInvitation()}}}};scope.closeInvites=function(event){for(var i=0;i<scope.invitedUserList.length;i++){if(scope.invitedUserList[i].encounterId==event.data.data.encounterId){scope.invitedUserList.splice(i,1);scope.updateAppointmentCount();scope.invitecount=scope.invitedUserList.length;scope.getTelemedAppt(false);scope.hideInvitation()}}};function connectToMasterSession(sessionID,tokenData){try{if(!containerC2Call){containerC2Call=otl.initLayoutContainer($("#C2CallApplet_"+scope.$id)[0],props)}opentokService.init(sessionID);opentokService.getSession().connect(tokenData,scope.connect);opentokService.getSession().on("connectionCreated",scope.connectionCreated);opentokService.getSession().on("signal:appGoesInBackground",scope.signalappBackgoundRecievedHandler);opentokService.getSession().on("signal:inviteStaffConfirmation",scope.inviteStaffConfirmationHandler);opentokService.getSession().on("signal:tvUserConfirmation",scope.tvUserConfirmationHandler);opentokService.getSession().on("connectionDestroyed",scope.destoryConnection);opentokService.getSession().on("sessionDisconnected",scope.sessionDisconnect);opentokService.getSession().on("sessionReconnecting",scope.masterSessionReconnecting);opentokService.getSession().on("sessionReconnected",scope.masterSessionReconnected);opentokService.getSession().on("signal:closedCaption",scope.closedCaptionHandler);opentokService.getSession().on("signal:getRunningStatus",function(event){if(event.data.userId!=global.TrUserId&&scope.isPatientOnline){opentokService.getSession().signal({type:"callRunningStatus",data:{encId:scope.callRunningEncId,senderUserId:global.TrUserId,isVideoCallRunning:scope.isVideoCallRunning,requestedUserId:event.data.userId,onCallUserSet:Array.from(scope.onCallUserSet).join(',')}},function(error){if(error){console.log("Error in sending Signal"+error.code+"->"+error.message)}})}});opentokService.getSession().on("signal:callRunningStatus",function(event){let respUserSet=event.data.onCallUserSet.split(",");if(event.data.senderUserId!=global.TrUserId&&event.data.encId>0&&scope.onCallUserSet.size!=respUserSet.length&&event.data.encId==mySharedService.encounterId&&event.data.requestedUserId==global.TrUserId&&scope.isPatientOnline){scope.onCallUserSet.clear();for(let i=0;i<respUserSet.length;i++){if(respUserSet[i]!=global.TrUserId){scope.onCallUserSet.add(respUserSet[i])}}scope.isPatientOnline=true;allowedUserToSubscribe=false;scope.callAlreadyInProgress=event.data.isVideoCallRunning;scope.reconnecting=true;callRunningUserID=event.data.userId;scope.msgCallAlreadyInProgress="This Patient is currently on a call with another user. Are you sure you want to join this visit ? ";scope.calling=false;scope.isVideoCallRunning=false;telemedCallRunningService.clearCallRunning();$(".teleVisitJoinBtn").html("<i ng-show=\"isPatientOnline\" class=\"icon icon-online\"></i> Join TeleVisit");$(".teleVisitJoinBtn").removeClass('disabled');$(".teleVisitJoinBtn").show();$(".icon-online").show();setScope();return}});opentokService.getSession().on("signal:permissionForTvUser",function(event){$(".teleVisitJoinBtn").html("<i ng-show=\"isPatientOnline\" class=\"icon icon-online\"></i> Join TeleVisit");$(".teleVisitJoinBtn").removeClass('disabled');$(".icon-online").show();scope.isAdmitResponseReceived=true;if(event.data&&global.TrUserId==event.data.userid&&!scope.onCallUserSet.has(event.data.userid)&&event.data.isallow===true&&mySharedService.encounterId==event.data.encid){scope.isAllowStaffProvider=true;scope.connectToVideoSession()}else{let isInvited=false;for(var i=0;i<scope.invitedUserList.length;i++){if(scope.invitedUserList[i].encounterId==event.data.encid){isInvited=true}}if(isInvited){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/cancelInvite"),data:{staffId:event.data.userid,encounterId:event.data.encid},type:"POST","async":false,success:function(){if(event.data.userid==global.TrUserId){scope.hideInvitation();for(var i=0;i<scope.invitedUserList.length;i++){if(scope.invitedUserList[i].encounterId==event.data.encid){scope.invitedUserList.splice(i,1)}}scope.invitecount=scope.invitedUserList.length;scope.getTelemedAppt(false)}},error:function(e){console.log("decline Staff Invite ERROR :"+e.message)}})}scope.isAllowStaffProvider=false;notification.show('info','Your request to join the Televisit call is declined')}});opentokService.getSession().on("signal:permissionForConnect",function(event){if(scope.joinRequestSent){if(event.data&&scope.staffInviteId==event.data.inviteId&&event.data.isAllow===true){scope.connectToVideoSession();$(".teleVisitJoinBtn").html("<i ng-show=\"isPatientOnline\" class=\"icon icon-online\"></i> Join TeleVisit");$(".teleVisitJoinBtn").removeClass('disabled');$(".icon-online").show()}else{if(event.data.userId==global.TrUserId){scope.hideInvitation();for(let i=0;i<scope.invitedUserList.length;i++){if(scope.invitedUserList[i].encounterId==event.data.encId){scope.invitedUserList.splice(i,1)}}scope.invitecount=scope.invitedUserList.length;scope.getTelemedAppt(false);notification.show('info','Your request to join the Televisit call is declined')}scope.inProgressNote()}}});scope.getDevices()}catch(e){ecwAlert("Issue while connecting to TeleVisit, Please try again later.")}}function connectToGeneralSession(apiKey,sessionID,tokenData){try{opentokService.initGeneralSession(apiKey,sessionID);let generalSession=opentokService.getGeneralSession();generalSession.connect(tokenData,scope.connect);generalSession.on("connectionCreated",scope.generalSessionConnectionCreated);generalSession.on("signal:inviteStaff",scope.inviteStaffHandler);generalSession.on("signal:requestToJoin",scope.requestToJoinHandler);generalSession.on("signal:sendMsg",scope.sendMsg);generalSession.on("signal:cancelStaffInvite",scope.cancelStaffInvite);generalSession.on("signal:closeInvites",scope.closeInvites);generalSession.on("signal:staffEndCall",scope.staffEndCall);generalSession.on("connectionDestroyed",scope.generalSessionDestoryConnection)}catch(e){ecwAlert("Issue while connecting to general session, Please try again later.")}}scope.isOTFunctionCalled=false;var timerOfOTScript;function clearOTTimer(){clearTimeout(timerOfOTScript);timerOfOTScript=null}scope.sendMsg=function(event){if(event.data.receiver==global.TrUserId){scope.encounterId=event.data.encounterID;scope.inviterUserId=event.data.inviterUserId;mySharedService.patientId=event.data.patientId;scope.getStaffInviteDetail(true,scope.encounterId)}};scope.requestToJoinHandler=function(event){if(event.data.userInfo[0]==global.TrUserId){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/requestToJoin"),data:{encId:event.data.encounterID,userId:event.data.inviterUserId},type:"POST",success:function(data){scope.requestToJoinUserList=data.requestToJoin;$("#televisit-tplUl114").show()},error:function(e){console.log("Request To Join ERROR :"+e.message)}})}};scope.inviteStaffHandler=function(event){if(event.data.userInfo[0]==global.TrUserId){scope.encounterId=event.data.encounterID;scope.inviterUserId=event.data.inviterUserId;mySharedService.patientId=event.data.patientId;scope.getStaffInviteDetail(true,scope.encounterId)}};scope.cancelStaffInvite=function(event){if(event.data.staffId===global.TrUserId){scope.hideInvitation();for(var i=0;i<scope.invitedUserList.length;i++){if(""+scope.invitedUserList[i].encounterId===event.data.encounterId){scope.invitedUserList.splice(i,1)}}scope.invitecount=scope.invitedUserList.length;scope.getTelemedAppt(false)}};scope.inviteStaffConfirmationHandler=function(event){if(event.data.data.userid!=global.TrUserId&&event.data.data.sendTo==global.TrUserId){let remoteData=event.data;telemedInviteService.utils.displayConfirmationToolTip(event,remoteData)}};scope.tvUserConfirmationHandler=function(event){if(event.data.data.userid!=global.TrUserId&&event.data.data.sendTo==global.TrUserId){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/inviteEncounterData"),data:{encounterId:mySharedService.encounterId},type:"POST","async":false,success:function(data){let invitedUserCount=data.inviteDetails.length;let userLimit=parseInt(getItemKeyValue("TVInviteStaffLimit"));let isProviderConnected=scope.onCallUserSet.has(mySharedService.providerID);if(isProviderConnected){userLimit=userLimit+1}if(invitedUserCount>0){if(invitedUserCount<userLimit&&scope.onCallUserSet.size<=userLimit||mySharedService.providerID===event.data.data.userid){telemedInviteService.utils.displayTvUserConfirmation(event,event.data)}else if(invitedUserCount==userLimit){scope.inviteeFeature.setInviteStaff();telemedInviteService.utils.displayRevokeInviteContent(event,event.data)}}else{telemedInviteService.utils.displayTvUserConfirmation(event,event.data)}}})}};scope.openPN=function(encounterId,patientId){scope.hideInvitation();doChecksForPN(encounterId,patientId,$http,'ovLoader')};scope.hideInvitation=function(){$("#televisit-tplUl113").hide();$("#televisit-tplUl114").hide();document.getElementById("rosterMainDiv").className="pull-right"};scope.getStaffInviteDetail=function(isRequireOpenNotification,enc){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/getStaffInviteDetail"),data:{currentDate:cdate,userId:global.TrUserId},type:"POST",success:function(data){scope.inviteList=data.inviteDetails;if(enc){scope.getInviteStaffPopUp(enc,isRequireOpenNotification,true)}else{scope.invitedUserList=[];for(var i=0;i<scope.inviteList.length;i++){scope.invitedUserList.push(scope.inviteList[i])}scope.invitecount=scope.invitedUserList.length;scope.updateAppointmentCount();scope.invitecount=scope.invitedUserList.length}},error:function(e){}})};scope.loadOTScript=function(){if(scope.isOTFunctionCalled===true){return}scope.isOTFunctionCalled=true;scope.loginUserType=global.loginUserType;timerOfOTScript=setTimeout(function(){if(typeof OT==="undefined"&&scope.isHealowLive){scope.isHealowLive=false;setScope();clearOTTimer()}},6e4);$ocLazyLoad.load({files:[{type:'js',path:getItemKeyValue("opentoksdklocation")}]}).then(function(){clearOTTimer();scope.isHealowLive=true;if(scope.isHttps===false){return}scope.getStaffInviteDetail(false);if(scope.loginUserType===scope.USER_TYPE_PROVIDER){connectToMasterSession(document.getElementById("sessionId").value,document.getElementById("tokenId").value.replace(/(\r\n|\n|\r)/gm,""))}let reqParam={action:'getTelemedGeneralDetails'};reqParam=$.param(reqParam);rosterService.invokeService(reqParam).success(function(respData){let teleAPIKey=respData.data.apiKey;let teleGeneralSessionId=respData.data.session;let teleGeneralSessionToken=respData.data.token;connectToGeneralSession(teleAPIKey,teleGeneralSessionId,teleGeneralSessionToken)});compatibilityService.isCompatible(function(isCompatible){scope.isCompatible=isCompatible;if(isCompatible){var params={action:'telemedlist',trUserId:global.TrUserId,prID:mySharedService.providerID,userType:global.loginUserType,grpvisit:isGroupDocumentationEnabled,time:$("#time").val(),t:(new Date).getTime(),currentdate:cdate};params=$.param(params);rosterService.invokeService(params).success(function(data){updateRosterList(data);if(Object.keys(scope.users).length>0){if(scope.users[mySharedService.encounterId]){scope.isInProgressNote=true}else{scope.isInProgressNote=false}}if(scope.isInProgressNote){scope.inProgressNote()}})}})},function(e){clearOTTimer();scope.isHealowLive=false;setScope()})};scope.formatDeviceLabel=function(label){if(label!=null&&label!=""){if(label.indexOf('(')!=-1&&label.indexOf(')')!=-1){var tmpVal=label.substring(label.indexOf('('),label.indexOf(')')+1);label=label.replace(tmpVal,'')}}return label};scope.endTeleVisitWithImg=function(){if(Object.keys(scope.patientDocs).length>0){scope.showImageUpload=false;scope.endTelevisitWithCheckoutFlag=true;scope.endTeleVisit();return false}else{scope.endTelevisitWithCheckoutFlag=true}};scope.switchDevice=function(id,deviceType){if(scope.isVideoCallRunning){if($(".tenetelefooter #cameraDeviceListUL > li").length==1){$(".tenetelefooter #cameraDeviceListUL > li[id='"+id+"'] > img").css('display','');return}isSwitchingCamera=true;$('#cameraList').removeClass('open');if(id==null||id==""||id=="-1")return;scope.isCameraSwitching=true;var msg="";scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Please wait while your device is switching.',false,0);if(deviceType==1){$(".tenetelefooter #cameraDeviceListUL > li > img").css('display','none');$(".tenetelefooter #cameraDeviceListUL > li[id='"+id+"'] > img").css('display','');selectedVideoDeviceId=id;msg="Please wait while doctor is switching camera."}else if(deviceType==2){$(".tenetelefooter #microphoneDeviceListUL > li > img").css('display','none');$(".tenetelefooter #microphoneDeviceListUL > li[id='"+id+"'] > img").css('display','');selectedAudioDeviceId=id;msg="Please wait while doctor is switching microphone."}else{selectedVideoDeviceId="";selectedAudioDeviceId=""}opentokVideoService.getSession().signal({type:"providerDeviceSwitching",data:msg},function(error){if(error){console.log("Error while sending signal providerDeviceSwitching")}});telemedCallBandwidthService.clearBandwidthStream(mySharedService.providerID);if(scope.publisher)scope.publisher.destroy()}};scope.rePublishDoctorVideo=function(isRetrying){if(isRetrying){scope.createAlertDown('#errorstatus',Alerts.SUCCESS,'','Retrying...',false,0)}if(!scope.isPublishing){var pubOptions={width:61,height:61,insertMode:"append",showControls:false};if(selectedAudioDeviceId!=""&&selectedVideoDeviceId!=""){pubOptions={width:61,height:61,insertMode:"append",showControls:false,videoSource:selectedVideoDeviceId,audioSource:selectedAudioDeviceId}}else if(selectedAudioDeviceId!=""&&selectedVideoDeviceId==""){pubOptions={width:61,height:61,insertMode:"append",showControls:false,audioSource:selectedAudioDeviceId}}else if(selectedVideoDeviceId!=""&&selectedAudioDeviceId==""){pubOptions={width:61,height:61,insertMode:"append",showControls:false,videoSource:selectedVideoDeviceId}}if(scope.isMuted===true){pubOptions["publishAudio"]=false}if(scope.isVideoPause===true){pubOptions["publishVideo"]=false}let publisherElement=$("#me_"+scope.$id)[0];scope.publisher=OT.initPublisher(publisherElement,pubOptions,function(error){scope.publisher.on("streamCreated",scope.publisherStreamCreatedHandler);if(!error){opentokVideoService.getSession().publish(scope.publisher,function(error){if(!error){scope.isPublishing=true;scope.isCameraSwitching=false;scope.isAllowStaffProvider=false;scope.publisher.on("destroyed",scope.publisherDestroyedHandler);scope.publisher.on("streamDestroyed",scope.publisherStreamDestroyedHandler);if(!isRetrying&&isSwitchingCamera){isSwitchingCamera=false;scope.createAlertDown('#errorstatus',Alerts.SUCCESS,'','Your device switching is done.',true,2e3)}else{scope.createAlertUp('#errorstatus',false,'')}telemedCallBandwidthService.getTelemedCallBandwidth(scope.publisher,mySharedService.providerID)}else{scope.publisherErrorHandler(error);console.log("Error :: rePublishDoctorVideo() > publish() => code:"+error.code+" :: message: "+error.message)}})}else{scope.publisherErrorHandler(error);console.log("Error :: rePublishDoctorVideo() > initPublisher() => code:"+error.code+" :: message: "+error.message)}})}};scope.publisherDestroyedHandler=function(event){scope.isPublishing=false;if(isSwitchingCamera){scope.rePublishDoctorVideo(false)}else{scope.isPubInitiated=false}};scope.publisherErrorHandler=function(error){if(scope.publisher){scope.publisher.destroy();scope.publisher=null}if(error.code===1500&&error.message.indexOf('Publisher Access Denied:')>=0){scope.createAlertDown('#errorstatus',Alerts.ERROR,'','"Please allow your browser to access your webcam or microphone.  <a href="#" onClick="window.location.reload()" class="televisitRetryLink">Click here to Retry...</a> "',false,0)}else if(error.code===1500&&error.message.indexOf('Video and Audio was disabled')>=0){scope.createAlertDownWithRetryLink('#errorstatus',Alerts.ERROR,'','"Failed to access your camera and microphone."',false,0,"<a href='#' ng-click='rePublishDoctorVideo(true);' class='televisitRetryLink'>Click here to Retry ..</a>")}else if(error.code===1500&&error.message.indexOf("Could not publish")>=0){scope.isCameraSwitching=false;scope.createAlertDownWithRetryLink('#errorstatus',Alerts.ERROR,'','"Failed to access your camera and microphone. Please verify your webcam not being used by another application."',false,0,"<a href='#' ng-click='rePublishDoctorVideo(true);' class='televisitRetryLink'>Click here to Retry ..</a>")}else if(error.code===1553||error.code===1500&&error.message.indexOf("Publisher PeerConnection Error:")>=0){scope.createAlertDownWithRetryLink('#errorstatus',Alerts.ERROR,'','"We could not make an audio/video connection. Verify your network policies, firewall, and/or antivirus is not blocking this connection and refresh to try again."',false,0,"<a href='#' ng-click='rePublishDoctorVideo(true);' class='televisitRetryLink'>Click here to Retry ..</a>")}else{scope.createAlertDown('#errorstatus',Alerts.ERROR,'','There was an error in making an audio/video connection. Please refresh and try again, otherwise contact support '+'<a href="#" onClick="window.location.reload()" class="televisitRetryLink">Click here to Retry ..</a> "',false,0)}};scope.healowHubSaveIndvQuestionnaire=function(inputID,category,type){var formValue=$('#popout_patient_questionnaire').find('#TP_TeleVisit').serialize();if(scope.isVideoCallRunning&&scope.dockView){formValue=$('#stickyview_patient_questionnaire').find('#TP_Sticky').serialize()}else if(scope.isInProgressNote&&!scope.isVideoCallRunning){formValue=$('#docview_patient_questionnaire').find('#TP_DocView').serialize()}let docname=$("#TP_TeleVisit :input[name='documentName']").val();let encId=$("#TP_TeleVisit :input[name='encId']").val();let isConcurrencyFlag=getItemKeyValue("EnableConcurLock").toUpperCase()==="YES";if(isConcurrencyFlag){let isToContinue=true;let catName;let isImported=false;scope.catPresentInQuest=[];let categories=[];if(scope.docType=='SurgicalHistoryAndAllergies'){categories.push({'catName':'Surgical/Hospitalization/Allergy','catFormName':'frmSurgical'+encId});categories.push({'catName':'Surgical/Hospitalization/Allergy','catFormName':'frmHistory'+encId})}else{$.ajax({type:'POST',url:'/mobiledoc/jsp/webemr/portal/getQuestionnaireMainCategories.jsp',"async":false,data:'encId='+encId+'&docName='+docname+'&trUserId='+global.TrUserId+'&action=getAllCat',headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},success:function(data){categories=jQuery.parseJSON(data)}})}let loopCount=0;$.each(categories,function(key,value){if(!isImported){catName=value.catName;catFormName=value.catFormName;++loopCount;lockObjForms={formName:"FullQuestImport",uniqueKey:catFormName,g_cancel:false,strKey:"",isOpenform:false,sectionName:catName,shouldContinue:true,TrUserId:global.TrUserId};formsConcurrencyQuestImport.acquireFormLockForForms(lockObjForms,callBackFuncsFullQuestImport);scope.catPresentInQuest.push(lockObjForms);function callBackFuncsFullQuestImport(){scope.catPresentInQuest.push(lockObjForms);if(lockObjForms.shouldContinue){$.each($scope.catPresentInQuest,function(key,value){formsConcurrencyQuestImport.makeEntryForOverwrittingForForms(value,value.uniqueKey)});isImported=true;scope.saveIndvQuestionnaire(formValue,inputID,category,type)}else{isImported=true;scope.releaseLockForHealowHubImport();return}}if(!lockObjForms.shouldContinue){isToContinue=false;return}else{scope.releaseLockForHealowHubImport()}}});if(loopCount===categories.length&&lockObjForms.shouldContinue&&isToContinue){scope.saveIndvQuestionnaire(formValue,inputID,category,type)}else{scope.releaseLockForHealowHubImport()}}else{scope.saveIndvQuestionnaire(formValue,inputID,category,type)}};scope.releaseLockForHealowHubImport=function(){$.each(scope.catPresentInQuest,function(key,value){formsConcurrencyQuestImport.releaseFormLockForForms(value)})};scope.saveIndvQuestionnaire=function(formValue,inputID,category,type){$.post('/mobiledoc/jsp/webemr/portal/saveIndvQuestionnaire.jsp?'+formValue+'&category='+category+'&uid='+$('#ptid').val()+'&qid='+$('#qid').val()+'&pageNum='+$('#pageNo').val()+'&encId='+$('#encId').val()+'&docName='+$('#documentName').val()+'&TrUserId='+global.TrUserId+'&type='+type,function(data){var position=category.split("^");var mainInputID=inputID.split("_");if(position[0]=="M"){$('[id^='+inputID+']').find('input').attr('disabled',true);$('[id^='+inputID+'] i').attr('class','icon big-grncheck');$('[id^='+inputID+']').closest('div').removeClass("btn-default btn-warning btn-xs ng-scope");$('[id^='+inputID+']').attr('onclick','').unbind('click');$('[id^='+inputID+']').css('cursor','default')}else{$('#'+inputID).find('input').attr('disabled',true);$('#'+inputID+'_H').attr('class','icon big-grncheck');$('#'+inputID+'_H ').attr('class','icon big-grncheck');$('#'+inputID+'_H ').closest('div').removeClass("btn-default btn-warning btn-xs ng-scope");$('#'+inputID+'_H ').parent('div').removeClass("btn-default btn-warning btn-xs ng-scope");$('#'+inputID+'_H ').closest('div').removeAttr("style");$('[id='+inputID+'_H]').attr('onclick','').unbind('click');$('[id='+inputID+'_H]').css('cursor','default');$('[id='+inputID+'_H]').attr('onclick','').unbind('click');$('[id='+inputID+'_H]').css('cursor','default');$('#'+inputID).find('input').attr('disabled',true);$('#'+mainInputID[0]+'_H').attr('class','icon big-grncheck');$('#'+mainInputID[0]+'_H ').attr('class','icon big-grncheck');$('#'+mainInputID[0]+'_H ').closest('div').removeClass("btn-default btn-warning btn-xs ng-scope");$('#'+mainInputID[0]+'_H ').parent('div').removeClass("btn-default btn-warning btn-xs ng-scope");$('#'+mainInputID[0]+'_H ').closest('div').removeAttr("style");$('[id='+mainInputID[0]+'_H]').attr('onclick','').unbind('click');$('[id='+mainInputID[0]+'_H]').css('cursor','default');$('[id='+mainInputID[0]+'_H]').attr('onclick','').unbind('click');$('[id='+mainInputID[0]+'_H]').css('cursor','default')}scope.loadQuestionnaire()});if(scope.isInProgressNote&&!scope.isInOtherProgressNote)refreshDashboard($('#encId').val(),$('#ptid').val(),"progressNote","")};function resetModalHeight(msgVisible,height){if(!height){height=minHeight}height+=132;setTimeout(function(){if(msgVisible){$('#teleChatBox').height(height+$("#tvShowMsgOutside").get(0).clientHeight)}else{$('#teleChatBox').height(height)}})}scope.patientLang="en";scope.providerLang="en";scope.hideCloseCaptionSettings=function(){$('.closedCaption-setting-panel ').find('.caption-settingpopup').toggleClass('togglepanel')};scope.showLiveCaptions=function(){scope.isUserStartedTranscription=true;scope.isUserModerator=true;if(!scope.pauseCaption){scope.startCloseCaption(true)}else{$('.closedCaptionTextDiv').find('.chat-section').addClass('chat-sectiondisplay');scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Sunoh Recording is On',true,8e3);scope.showclosedCaptionDiv=true;scope.pauseCaption=false;if(publisherTranscript){publisherTranscript.pauseSendingAudio(true)}sendSignalToPauseTranscription()}};scope.startCloseCaption=function(isUserModerator){try{if(!scope.publisher||!validateSunohSession(isUserModerator)){return}if(publisherTranscript!=null&&publisherTranscript.socket!==null){if(publisherTranscript.socket.readyState===0||publisherTranscript.socket.readyState===2){return}}scope.closedCaption="";scope.providerCaption="";scope.patientCaption="";scope.allowClosedCaption=true;scope.showclosedCaptionDiv=true;scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Sunoh Recording is On',true,8e3);if(!$('.closedCaptionTextDiv').find('.chat-section').hasClass('chat-sectiondisplay')){$('.closedCaptionTextDiv').find('.chat-section').addClass('chat-sectiondisplay')}let publisherStream=$("#me_"+scope.$id).find('video')[0].captureStream();var role=scope.loginUserType===scope.USER_TYPE_PROVIDER?'provider':'staff';publisherTranscript=new Transcription(publisherStream,ccCallBack,'en-US','en-US');publisherTranscript.startTranscription(role,mySharedService.encounterId,telemedInviteService.utils.getAuth_Token(global.TrUserId),resetCloseCaptionOnErr);allowPublisherClosedCaption=true}catch(e){scope.showclosedCaptionDiv=false;scope.isUserStartedTranscription=false;scope.createAlertDown('#errorstatus',Alerts.ERROR,'','something went wrong please try again.',true,8e3)}};let startRecordingDateTime='';let stopRecordingDateTime='';function getCurrentDateTime(){return moment(new Date).format("YYYY-MM-DD HH:mm:ss")}function validateSunohSession(isUserModerator){if(scope.isUserStartedTranscription&&isUserModerator){let sunohSession=localStorage.getItem("sunohSession");if(sunohSession&&JSON.parse(sunohSession).sessionEncid!=SunohService.encId&&SunohService.type==="widget"){ecwAlert("There is an active Sunoh session for patient "+JSON.parse(sunohSession).sessionPatientFullName+". Concurrent Sunoh sessions are not permitted.</br>"+"Please end the active session before attempting to start a new one.</br>"+"If you are experiencing an error, please log out and log back in to eClinicalWorks.");return false}else{let sunohSessionObj={"sessionEncid":mySharedService.encounterId,"type":"widget","sessionPatientFullName":scope.currentCallPatientName,"sunohRecording":"true"};localStorage.setItem("sunohSession",JSON.stringify(sunohSessionObj));return true}}else if(!isUserModerator){return true}}function removeSunohSession(){let sunohSession=localStorage.getItem("sunohSession");if(sunohSession){localStorage.removeItem("sunohSession")}}let ccCallBack=function(msg){if(msg.allow==='true'&&!isSignalSent){startRecordingDateTime=getCurrentDateTime();let url="/mobiledoc/modules/webemr/telehealth/sunoh/startConversation";let payload={encId:mySharedService.encounterId,userId:global.TrUserId,startDate:startRecordingDateTime};$http({method:"POST",url:makeURL(url),data:$.param(payload)}).success(function(response){if(response.status==='success'){scope.convoId=response.convoId}});isSignalSent=true;sendSignalToDisableCCPortal();sendSignalToDisableCCForEMR()}if(msg.eof===1){if(!scope.translatorAdded){let captionJson={};let detailedDesc={};captionJson['transcription']=msg.transcription;captionJson['speakerId']=msg.role;detailedDesc['DisplayText']=msg.transcription;detailedDesc['SpeakerId']=msg.role;captionJson['isTV']=1;captionJson['detailedTranscription']=detailedDesc;scope.providerCaption=msg.role+": "+msg.transcription+".\n";scope.providerPatientConv=scope.providerPatientConv+scope.providerCaption;scope.closedCaption=msg.transcription;scope.role=msg.role;scope.providerPatientOrgConv.push(captionJson);sendClosedCaption(msg.transcription,msg.role)}}};function getSunohRecordingDuration(){let duration=moment.duration(moment(stopRecordingDateTime).diff(moment(startRecordingDateTime)));return duration.asSeconds()}function storeSunohRecording(){var url="/mobiledoc/modules/webemr/telehealth/sunoh/saveSunohTVRecording";var payload={"conversation":scope.providerPatientConv,"orgConversation":JSON.stringify(scope.providerPatientOrgConv),"id":scope.convoId,"endDate":stopRecordingDateTime,"duration":getSunohRecordingDuration(),"encId":mySharedService.encounterId,"userId":mySharedService.patientId};$http({method:"POST",url:makeURL(url),data:payload}).success(function(response){if(response&&response['status']==='success'){isSummaryGenerated=true;scope.providerPatientConv='';scope.providerPatientOrgConv=[];SunohService.checkSummaryStatus();let summaryInterval=setInterval(function(){if(isSummaryGenerated){isSummaryGenerated=false;clearInterval(summaryInterval)}},5e3)}}).error(function(error){})}scope.stopRecording=function(){if(scope.isUserStartedTranscription){scope.isUserStartedTranscription=false;scope.hideCaption(true);if(scope.onCallUserSet.size>0){sendSignalToEnableAction()}sendSignalToStopRecording();removeSunohSession()}stopRecordingDateTime=getCurrentDateTime();storeSunohRecording();processingSummaryCSS();scope.allowClosedCaption=false;publisherTranscript.closeSocket();publisherTranscript=null;scope.providerPatientConv='';scope.providerPatientOrgConv=[];scope.pauseCaption=false;isSignalSent=false};let sendSignalToStopRecording=function(){try{opentokVideoService.getSession().signal({type:"stopTranscription",data:{stopRecording:true,initiatedCallerId:global.TrUserId}},function(error){if(error){allowedUserToSubscribe=false}})}catch(e){ecwAlert('There is a problem while stopping sunoh recording.')}};function stopSubscriberCaption(){if(subscriberTranscript!==null&&subscriberTranscript.socket!==null){subscriberTranscript.stopStreaming();subscriberTranscript=null;scope.allowClosedCaption=false;scope.showclosedCaptionDiv=false}}let resetCloseCaptionOnErr=function(){scope.allowClosedCaption=false;scope.showclosedCaptionDiv=false;scope.disableCCAction=false;scope.isUserStartedTranscription=false;scope.isUserModerator=false;$('.closedCaption-setting-panel').find('#caption-settings-btn').removeClass('brdr-green');$('.closedCaption-setting-panel').find('.settingsec-panel').removeClass('active');$('.closedCaption-setting-panel').find('.caption-settingpopup').removeClass('togglepanel');$('.closedCaption-setting-panel').find('.ccbuttonclick').removeClass('active');$('.closedCaptionTextDiv').find('.chat-section').removeClass('chat-sectiondisplay')};let stopSubscriberCloseCaption=function(){if(scope.isUserStartedTranscription){scope.hideCaption(true);if(scope.onCallUserSet.size>0){sendSignalToEnableAction()}}stopSubscriberCaption()};scope.hideCaption=function(isEndCall){if(scope.onCallUserSet.size>0&&publisherTranscript){publisherTranscript.pauseSendingAudio(false)}if(!isEndCall){scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Sunoh Recording is paused',true,8e3);scope.pauseCaption=true;sendSignalToPauseTranscription()}else{scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Sunoh Recording is Off',true,8e3);scope.pauseCaption=false}scope.showclosedCaptionDiv=false;$('.closedCaption-setting-panel').find('.settingsec-panel').removeClass('active');$('.closedCaption-setting-panel').find('.ccbuttonclick').removeClass('active');$('.closedCaptionTextDiv').find('.chat-section').removeClass('chat-sectiondisplay')};scope.disableActionHandlerEMR=function(event){if(event.data&&typeof event.data==="string"){event.data=$.parseJSON(event.data)}if(global.TrUserId!==event.data['initiatedCallerId']&&!scope.allowClosedCaption){isSignalSent=true;scope.disableCCAction=true;scope.startCloseCaption(false)}};let sendSignalToPauseTranscription=function(){try{opentokVideoService.getSession().signal({type:"pauseTranscription",data:{pauseCaption:!scope.pauseCaption,initiatedCallerId:global.TrUserId}},function(error){if(error){allowedUserToSubscribe=false}})}catch(e){ecwAlert('There is a problem while starting TeleVisit.')}};scope.pauseTranscriptionHandler=function(event){if(event.data&&typeof event.data==="string"){event.data=$.parseJSON(event.data)}if(global.TrUserId!==event.data['initiatedCallerId']){scope.pauseCaption=!event.data['pauseCaption'];if(scope.pauseCaption){$('.closedCaptionTextDiv').find('.chat-section').removeClass('chat-sectiondisplay');scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Sunoh Recording is paused',true,8e3)}else{$('.closedCaptionTextDiv').find('.chat-section').addClass('chat-sectiondisplay');scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Sunoh Recording is on',true,8e3)}publisherTranscript.pauseSendingAudio(event.data['pauseCaption'])}};let sendSignalToEnableAction=function(){try{opentokVideoService.getSession().signal({type:"enableAction",data:{initiatedCallerId:global.TrUserId}},function(error){if(error){allowedUserToSubscribe=false}})}catch(e){console.log('There is a problem sending close caption on/off signal.')}};let enableActionHandler=function(event){if(event.data&&typeof event.data==="string"){event.data=$.parseJSON(event.data)}if(global.TrUserId!==event.data['initiatedCallerId']){scope.disableCCAction=false;if(publisherTranscript){isSignalSent=false;publisherTranscript.closeSocket();scope.allowClosedCaption=false;scope.showclosedCaptionDiv=false;scope.isUserStartedTranscription=false;scope.pauseCaption=false;publisherTranscript=null;scope.providerPatientOrgConv=[];scope.providerPatientConv='';scope.createAlertDown('#errorstatus',Alerts.WARNING,'','Sunoh Recording is Off',true,8e3)}}};let sendSignalToDisableCCForEMR=function(){try{opentokVideoService.getSession().signal({type:"disableActionEMR",data:{initiatedCallerId:global.TrUserId}},function(error){if(error){console.log(error);allowedUserToSubscribe=false}else{signalToDisableAction=false}})}catch(e){ecwAlert('There is a problem sending close caption on/off signal.')}};let signalToRestartCaptionOnStaffJoin=function(){try{opentokVideoService.getSession().signal({type:"restartCaption",data:{initiatedCallerId:global.TrUserId,auth_token:telemedInviteService.utils.getAuth_Token(global.TrUserId)}},function(error){if(error){allowedUserToSubscribe=false}})}catch(e){ecwAlert('There is a problem sending restart close caption on/off signal.')}};let sendSignalToDisableCCPortal=function(){try{opentokVideoService.getSession().signal({type:"disableAction",data:{initiatedCallerId:global.TrUserId,auth_token:telemedInviteService.utils.getAuth_Token(global.TrUserId)}},function(error){if(error){allowedUserToSubscribe=false}})}catch(e){ecwAlert('There is a problem sending close caption on/off signal.')}};let isSignalSent=false;let sendClosedCaption=function(closedCaption,role){try{opentokService.getSession().signal({type:"closedCaption",data:{encID:mySharedService.encounterId,cc:closedCaption,role:role,userId:global.TrUserId}},function(error){if(error){allowedUserToSubscribe=false}})}catch(e){ecwAlert('There is a problem while starting TeleVisit.')}};let stopPublisherCloseCaption=function(){if(publisherTranscript!==null&&publisherTranscript.socket!==null){publisherTranscript.stopStreaming();scope.allowClosedCaption=false;scope.showclosedCaptionDiv=false;scope.pauseCaption=false;isSignalSent=false;if($('.caption-settingpopup').find("#ccOn").is(':checked')){$('.caption-settingpopup').find("#ccOn").prop('checked',false);$('.caption-settingpopup').find("#ccOff").prop('checked',true)}publisherTranscript=null;allowPublisherClosedCaption=false;publisherConnection=null}};scope.settingButtonClick=function(){$('.closedCaption-setting-panel ').find('.caption-settingpopup').toggleClass('togglepanel')};scope.analysisButtonClick=function(){$('.closedCaption-setting-panel ').find('.caption-analysis').toggleClass('togglepanel')};scope.closeCaptionClick=function(){$('.closedCaption-setting-panel ').find('.caption-settingpopup').toggleClass('togglepanel')};scope.closeGPTAnalysis=function(){$('.gpt-analysis').modal('hide')};scope.openTranslator=function(){$('.translator-div').show('slide',{direction:'right'},300)};scope.smallbtnclick=function(){$('.closedCaptionTextDiv').find('.conversationtxt').addClass('conversationtxtsmall');$('.closedCaptionTextDiv').find('.conversationtxt').removeClass('conversationtxtmedium');$('.closedCaptionTextDiv').find('.conversationtxt').removeClass('conversationtxtlarge');$('.closedCaption-setting-panel').find('.toggle-btn-group label').removeClass('active');$('.closedCaption-setting-panel').find('#ccFontSmallLbl').addClass('active')};scope.mediumbuttonclick=function(){$('.closedCaptionTextDiv').find('.conversationtxt').addClass('conversationtxtmedium');$('.closedCaptionTextDiv').find('.conversationtxt').removeClass('conversationtxtsmall');$('.closedCaptionTextDiv').find('.conversationtxt').removeClass('conversationtxtlarge');$('.closedCaption-setting-panel').find('.toggle-btn-group label').removeClass('active');$('.closedCaption-setting-panel').find('#ccFontMediumLbl').addClass('active')};scope.largebuttonclick=function(){$('.closedCaptionTextDiv').find('.conversationtxt').addClass('conversationtxtlarge');$('.closedCaptionTextDiv').find('.conversationtxt').removeClass('conversationtxtmedium');$('.closedCaptionTextDiv').find('.conversationtxt').removeClass('conversationtxtsmall');$('.closedCaptionTextDiv').find('.conversationtxtsmall, .conversationtxtmedium').hide();$('.closedCaption-setting-panel').find('.toggle-btn-group label').removeClass('active');$('.closedCaption-setting-panel').find('#ccFontLargeLbl').addClass('active')}}}}).directive('teleendcallpopup',function(){return{restrict:'A',replace:'true',templateUrl:'/mobiledoc/jsp/webemr/telemed/teleEndCallPopup-tpl.html'}});$(document).ready(function(){var interval;var timerValue;try{$(window).resize(function(){var scope=angular.element($("#teleChatBox")).scope();if(scope&&scope.isFullScreen){if(timerValue){clearTimeout(timerValue);timerValue=null}timerValue=setTimeout(function(){scope.isFullScreen=false;scope.fullScreen();clearTimeout(timerValue);timerValue=null},200)}});$(".navgator").on("click",function(){var scope=angular.element($("#teleChatBox")).scope();if(scope){interval=setInterval(function(){if(!$("#leftnavApp").is(':animated')){if(scope.isFullScreen){scope.isFullScreen=false;scope.fullScreen()}clearInterval(interval)}},200)}})}catch(e){clearInterval(interval);console.log(e)}$('html').on('click mousedown',function(e){var container=$("#snapDeleteConfDialog");if(!container.is(e.target)&&container.has(e.target).length===0&&e.target.innerHTML!=="x"){var scope=angular.element($("#snapDeleteConfDialog")).scope();if(scope!=undefined&&scope.SnapDeleteConfirmation!=undefined&&scope.SnapDeleteConfirmation){scope.SnapDeleteConfirmation=false}}})});function loadOTScript(){try{var telemedScope=angular.element($("#televisitWrapper .televisionbox")).scope();telemedScope.lastInvitedLog=setInterval(telemedScope.getUpdatedLastInvited,5e3);if(telemedScope){telemedScope.loadOTScript()}}catch(e){}}
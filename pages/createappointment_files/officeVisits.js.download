var encObj;var frmOfficeVisit=true;var nuclearTestVisitFlg=false;angular.module('officeVisit.controllers',['ecw.dir.centeredmodal','ecw.service.EncDetailsService','providerlookup','officeVisit.services','ecw.pagination','facilitylookup','xeditable','facilitygrouplookup','dashboardTile','oc.lazyLoad','ecw.dir.datepicker','healowPlusActivitiesPanelApp','departmentlookup','insurancelookup','stafflookup','ecw.dir.keywords','ecw.dir.savePrompt','patientlookup','ecw.service.PSAC','ecw.filter.stringtruncate','ngPatternRestrict','ecw.datatruncUtilityModule','ecw.addEmcodeOnLockPN']).controller('officeVisitController',["$scope","$http","EncDetailsService","officeVisitService","$timeout","$interval","$ocLazyLoad","$templateCache","$filter","$window","$rootScope","$modal","PSACService","dataTruncUtilityService","$compile","addEmcodeOnLockPNService",function($scope,$http,EncDetailsService,officeVisitService,$timeout,$interval,$ocLazyLoad,$templateCache,$filter,$window,$rootScope,$modal,PSACService,dataTruncUtilityService,$compile,addEmcodeOnLockPNService){g_mainScreenName="officeVisitCTRL";var x2js=new X2JS;var sortBy=emrOfficeVisitJellybeanObj.sortBy;var apptTime=emrOfficeVisitJellybeanObj.apptTime;var viewType=emrOfficeVisitJellybeanObj.viewType;var resourceId=emrOfficeVisitJellybeanObj.resourceId;var tabId=emrOfficeVisitJellybeanObj.tabId;var trUserName=emrOfficeVisitJellybeanObj.trUserName;var providersId=emrOfficeVisitJellybeanObj.providersId;var multiPVDSel=emrOfficeVisitJellybeanObj.multiPVDSel;var facId=emrOfficeVisitJellybeanObj.facId;var facName=emrOfficeVisitJellybeanObj.facName;var vFacilityGrpId=emrOfficeVisitJellybeanObj.vFacilityGrpId;var displayDate=emrOfficeVisitJellybeanObj.displayDate;var displayToDate=emrOfficeVisitJellybeanObj.displayToDate;var trUserId=emrOfficeVisitJellybeanObj.trUserId;var fromPageLoad=emrOfficeVisitJellybeanObj.fromPageLoad;var maxCount=emrOfficeVisitJellybeanObj.maxCount;var prvdrPagingEnabled=emrOfficeVisitJellybeanObj.prvdrPagingEnabled;var accessOrders=emrOfficeVisitJellybeanObj.accessOrders;var patientPagingEnabled=emrOfficeVisitJellybeanObj.patientPagingEnabled;var pnPermission=emrOfficeVisitJellybeanObj.pnPermission;var chartLock=emrOfficeVisitJellybeanObj.chartLock;var officeVisitStrXML=emrOfficeVisitJellybeanObj.officeVisitStrXML;var cookie=emrOfficeVisitJellybeanObj.cookie;var serverTimeStamp=emrOfficeVisitJellybeanObj.serverTimeStamp;var selectedStickeyChkShowASCvisits=emrOfficeVisitJellybeanObj.selectedStickeyChkShowASCvisits;var uiDefaults=emrOfficeVisitJellybeanObj.uiDefaults;var preUiDefaults=angular.copy(emrOfficeVisitJellybeanObj.uiDefaults);var dashboardDtFocusHandler=emrOfficeVisitJellybeanObj.dashboardDtFocusHandler;var dashboardInputCalClkHandler=emrOfficeVisitJellybeanObj.dashboardInputCalClkHandler;var $demo1=emrOfficeVisitJellybeanObj.$demo1;var isEventToValidateEncRoomNo=true;$scope.Telelinkurl="";$scope.isEnableUTCScheduling="yes"===getItemKeyValue("EnableUTCScheduling").toLowerCase();$scope.include={url:""};$scope.currentStatusCode={};$scope.showStatusBreadCrumb=false;$scope.getLocalTimeZoneId=function(){return moment().tz(moment.tz.guess()).format('z')};$scope.getCurrentDate=function(){return new Date};var getTimeInFacilityTZ=function(time,tzTime,facilityTimeZone){var utcTime="";if(tzTime){if($scope.isEnableUTCScheduling&&facilityTimeZone){utcTime=$scope.convert24HourToAMPM(moment(tzTime).format("HH:mm:ss"))+" "+facilityTimeZone}else{utcTime=$scope.convert24HourToAMPM(moment(tzTime).format("HH:mm:ss"))}}else{utcTime=$scope.convert24HourToAMPM(time)}return utcTime};$scope.showHISummaryPopup=function(elem){let popupContainer=$("#hi-summary-popup");let openHISummaryPopupPosition=angular.element(elem.target);popupContainer.toggle().animate({},100,function(){popupContainer.position({of:openHISummaryPopupPosition,my:'right top',at:'right-20 top-24',collision:"flipfit"}).animate({"opacity":1},100)});$("#hi-summary-popup .prompt-arrow-1").show().animate({},100,function(){$(this).position({of:openHISummaryPopupPosition,my:'right top',at:'right-22 top+5',collision:"flipfit"})})};const getCurrentSettingForHealowInsights=function(){let HealowInsightsOVSummaryViewConfig=getHealowInsightsUserSettings("officeVisitSummaryViewConfig");if(!HealowInsightsOVSummaryViewConfig){HealowInsightsOVSummaryViewConfig=getItemKeyValue("HealowInsightsOVSummaryViewConfig")}$scope.HealowInsightsOVSummaryViewConfig=JSON.parse(HealowInsightsOVSummaryViewConfig)};getCurrentSettingForHealowInsights();$scope.getHICounts=function(elem,patientId){$http({method:'POST',url:makeHealowInsightsAPIURL('patient/alert/office-visit'),data:$.param({patientid:patientId}),headers:{'Content-Type':'application/json'},cache:false}).then(function(response){if(response.data&&response.data.status&&response.data.status==='success'){$scope.hiTotalRecords=0;if($scope.isHealowInsightsHCCEnabled()){$scope.unreviewedCount=response.data.unreviewed;$scope.reviewedCount=response.data.reviewed;$scope.hiTotalRecords=$scope.hiTotalRecords+parseInt(response.data.unreviewed)+parseInt(response.data.reviewed)}if($scope.isHealowInsightsQMEnabled()){$scope.warningCount=response.data.warningCount;$scope.overdueList=response.data.overdueList;$scope.overdueCount=response.data.overdueCount;$scope.warningList=response.data.warningList;$scope.hiTotalRecords=$scope.hiTotalRecords+parseInt(response.data.overdueCount)+parseInt(response.data.warningCount)}if($scope.isHealowInsightsPDXEnabled()){$scope.pdxReviewedCount=response.data.pdxReviewed;$scope.pdxUnreviewedCount=response.data.pdxUnreviewed;$scope.hiTotalRecords=$scope.hiTotalRecords+parseInt(response.data.pdxReviewed)+parseInt(response.data.pdxUnreviewed)}if($scope.isHealowInsightsGICEnabled()){$scope.gicUnreviewedCount=response.data.gicUnreviewedCount;$scope.gicUnreviewedList=response.data.gicUnreviewedList;$scope.gicReviewedCount=response.data.gicReviewedCount;$scope.hiTotalRecords=$scope.hiTotalRecords+parseInt(response.data.gicReviewedCount)+parseInt(response.data.gicUnreviewedCount)}$scope.showHISummaryPopup(elem)}else{if(response.data.message){notification.show('error','Notification',response.data.message,5e3)}else{notification.show('error','Notification','Unable to get healow Insights data.',5e3)}}},function(){notification.show('error','Notification','Unable to get healow Insights data.',5e3)})};$scope.hideHISummaryPopup=function(){let hiSummaryPopup=$('#hi-summary-popup');if(hiSummaryPopup.is(':visible')){hiSummaryPopup.hide()}};const isHealowInsightsEnabled=function(){return isItemKeyEnabled("HealowInsightsMenu")};const isHealowInsightsItemKeyEnabled=function(itemKey){return isHealowInsightsEnabled()&&isItemKeyEnabled(itemKey)};const isHealowInsightsItemKeyEnabledAndUserAuthorized=function(itemKey,securityKeyList){let hasAccess=false;if(isHealowInsightsItemKeyEnabled(itemKey)){for(let skIndex in securityKeyList){if(getPermission(securityKeyList[skIndex],global.TrUserId)){hasAccess=true;break}}}return hasAccess};$scope.isHealowInsightsQMEnabled=function(){return isHealowInsightsItemKeyEnabledAndUserAuthorized("HealowInsightsQMAlertReportTab",["AllowHealowInsightsQMAlertReport"])};$scope.isHealowInsightsHCCEnabled=function(){return isHealowInsightsItemKeyEnabled("HealowInsightsHCCListTab")};$scope.isHealowInsightsPDXEnabled=function(){return isHealowInsightsItemKeyEnabled("HealowInsightsMemberInsightsTab")};$scope.isHealowInsightsGICEnabled=function(){return isHealowInsightsItemKeyEnabledAndUserAuthorized("HealowInsightsMemberInsightsTab",["AllowMemberInsightsTab","AllowHealowInsightsWorkLists"])};const healowInsightsSummaryLoad=function(){if(isHealowInsightsEnabled()){$ocLazyLoad.load({name:'healowInsightsSummary',files:['/mobiledoc/jsp/healowInsights/officevisits/healow-insights-office-visits.css']}).then(function(){$scope.healowInsightsSummary='/mobiledoc/jsp/healowInsights/officevisits/healow-insights-office-visits-summary-view.html'},function(){ecwAlert("Failed to load page, Please try again.","eClinicalWorks",null,"","orangetheme")})}};healowInsightsSummaryLoad();var getTimeInUTC=function(time,tzTime){var utcTime=time;if(tzTime){utcTime=moment(tzTime).format("HH:mm:ss")}return utcTime};$scope.trUserId=trUserId;$scope.viewPNName="View Progress Notes";$scope.tileDashboard="Open Dashboard Tiles";var refreshOffVisits={};getItemKeyValuePair("RefreshOffVisits",refreshOffVisits);var refreshInterval=60;if(Number(refreshOffVisits.itemId)>0){refreshInterval=refreshOffVisits.itemId*60}var paused=false;$scope.todaysDate="";var isXMLICDTrnsmt=false;$scope.enblDepartmnts=false;var ignrLoadReq=true;var nWebportal=0;$scope.enblVoice=false;$scope.bwebportalEnabled=false;$scope.shwVMsgIcon=false;$scope.enblPager=false;$scope.enblSurg=false;$scope.patientIdlist=[];$scope.encStsCyclTime=false;$scope.enblClaimPrvdrMenu=false;$scope.enblTMHPMenu=false;$scope.enblAcuityFormMenu=false;$scope.enblPatientPanelMenu=false;$scope.trnsmtChrgVisible=false;$scope.nyFPEncFormVisible=false;$scope.chngMulApptPrvider=false;$scope.isGroupDocEnabled=false;$scope.screenName="Office Visit";$scope.activeTabId=1;$scope.bh_TimerPopupMessage="";$scope.TabFlag_Session="0";$scope.selectedTab="3";$scope.selectedEncounters=[];$scope.isEncounterFormOpened=false;$scope.enableVisitQueueDashBaord=false;$scope.showASCvisitsUnderOfficeVsit=getItemKeyValue("OfficeVisitsShowASCVisits").toLowerCase()==='yes'&&getItemKeyValue("ASCEnabled").toLowerCase()==='yes'?true:false;$scope.isActivitiesEnabledOfficeVisit="YES"===getItemKeyValue("CentralActivitiesisEnabled").toUpperCase();$scope.isDashboardTilesEnabledOfficeVisit="YES"===getItemKeyValue("CentralDashboardTilesisEnabled").toUpperCase();$scope.healowConnectColumnHeader=" ";if(getItemKeyValue("healowConnectEnabled").toLowerCase()==='yes'){$scope.healowConnectColumnHeader="Healow Connect"}$scope.selectedChkShowASCvisits=selectedStickeyChkShowASCvisits&&$scope.showASCvisitsUnderOfficeVsit;if($scope.selectedChkShowASCvisits===true){$scope.chkShowASCvisits=1}else{$scope.chkShowASCvisits=0}var item={itemId:0,keyValue:'',isExists:false};function resetItemObj(){item={itemId:0,keyValue:'',isExists:false}}var ECW_VISITSTATUSCODE_MAPPING_CHECKIN="Arrived";var ECW_VISITSTATUSCODE_MAPPING_CHKOUT="Checked out";var ECW_VISITSTATUSCODE_MAPPING_CANCEL="Cancelled";var ECW_VISITSTATUSCODE_MAPPING_NOSHOW="No Show";var ECW_VISITSTATUSCODE_MAPPING_PENDING="Pending";var ECW_VISITSTATUSCODE_MAPPING_RESCHEDULED="Rescheduled";var strPrintDefaultStyle='Default';var strLockDefaultStyle='Default';var strFaxDefaultStyle='Default';var getEcwVisitStatusCodeMapping=function(strStatusDescription){var respData=getCachedData("/mobiledoc/jsp/catalog/xml/GetEcwVisitStatusCodes.jsp");try{var x2js=new X2JS;var jsonData=x2js.xml_str2json(respData.trim());var visitStatusCodeMap=jsonData.Envelope.Body['return'].resultset.data.row;for(var visitStatusIndex in visitStatusCodeMap){if(strStatusDescription===visitStatusCodeMap[visitStatusIndex].description){return visitStatusCodeMap[visitStatusIndex].code}}}catch(err){console.log(err)}if(ECW_VISITSTATUSCODE_MAPPING_CHECKIN===strStatusDescription){return"ARR"}else if(ECW_VISITSTATUSCODE_MAPPING_CHKOUT===strStatusDescription){return"CHK"}else if(ECW_VISITSTATUSCODE_MAPPING_PENDING===strStatusDescription){return"PEN"}else if(ECW_VISITSTATUSCODE_MAPPING_RESCHEDULED===strStatusDescription){return"R/S"}else if(ECW_VISITSTATUSCODE_MAPPING_NOSHOW===strStatusDescription){return"N/S"}else if(ECW_VISITSTATUSCODE_MAPPING_CANCEL===strStatusDescription){return"CANC"}};$scope.openHub=function(){if($scope.validateSingleEncSelection()){PSACService.checkCommonStaffPermission($scope.selectedEncouterObj.patientId,function(data){$ocLazyLoad.load({name:'NewHub',files:['/mobiledoc/jsp/webemr/templates/topPanel-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientHub/patienthubController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientHub/patient-hub.jsp?contextFrom=officevisits&patientId='+$scope.selectedEncouterObj.patientId+'&nd='+(new Date).getTime());$scope.linkurl=url;$timeout(function(){$("#phub_dialog").draggable({handle:'.modal-header.clearfix'});$('#phub_dialog .modal-header.clearfix').css("cursor","all-scroll")},1e3)},function(e){})})}};$scope.todayDateForTelevisit=(new Date).format("mm/dd/yyyy");$scope.openTelemedMessagingModal=function(officeVisit){var data=[officeVisit.encounterId];$rootScope.$broadcast("showTelemedMessagingModal",data)};$scope.openTelemedMessagingModalForMultiplePatient=function(){if($scope.selectedEncounters.length===0){ecwAlert("Please select atleast one Encounter.","ECW Alert")}else{var data=[];var isAllowToOpen=true;for(var i=0;i<$scope.selectedEncounters.length;i++){var officeVisitObject=$scope.filteredOfficeVisitList.find(function(element){return element.encounterId===$scope.selectedEncounters[i]});if(officeVisitObject.telemedVisit==="0"||officeVisitObject.telemedVisit===0||officeVisitObject.status!=='ARR'){isAllowToOpen=false;break}if((officeVisitObject.telemedVisit==="1"||officeVisitObject.telemedVisit===1)&&officeVisitObject.status==='ARR'){data.push($scope.selectedEncounters[i])}}if(isAllowToOpen){$rootScope.$broadcast("showTelemedMessagingModal",data)}else{ecwAlert("Please only select patients that have a televisit and have arrived.","ECW Alert")}}};$scope.isWordBreakRequired=function(reason){var response=false;if(reason){reason=reason.trim();var content=reason.split(" ");for(var speaceIndex in content){if(content[speaceIndex].length>=15){response=true}}}return response};$scope.convert24HourToAMPM=function(time){if(time.indexOf(":")>0){var timeArr=time.split(":");var hours=timeArr[0];var min=timeArr[1];if(hours<12){if(hours==="00")hours="12";return hours+':'+min+' AM'}else{hours=hours===12?hours:hours-12;hours=hours<10?'0'+hours:hours;if(hours==="00")hours="12";return hours+':'+min+' PM'}}else{return"12:00 AM"}};$scope.showASCvisits=function(){if($scope.chkShowASCvisits===1){if(!getPermission("allowAccessASCEncounters",global.TrUserId)){ecwAlert("Permission denied.");$scope.selectedChkShowASCvisits=false;$scope.chkShowASCvisits=0;return false}if($scope.selFacVal==="Departments"||$scope.selFacVal==="FacilityGroup"){$scope.selFacVal="Facility";if($scope.facilityForFilter&&$scope.facilityForFilter.facility&&!$scope.facilityForFilter.facility.Name){$scope.facilityForFilter.facility.Name="All";$scope.facilityForFilter.facility.Id=0}}$scope.selectedChkShowASCvisits=true;$scope.strOrderBy="";$scope.nSortOrder=-1;var currentPageNo=$scope.currentPage===undefined?1:$scope.currentPage;var doctorIds="";if(!multiPVDSel){var provider=$scope.providerForFilter.provider;if(provider&&provider.Id){doctorIds=provider.Id}else{doctorIds="0"}}else{angular.forEach($scope.providerForFilter.providerList,function(provider,$index){doctorIds+=provider.Id;if($index!==$scope.providerForFilter.providerList.length-1){doctorIds+=","}})}let nFacId=0;nFacId=!$scope.facilityForFilter?0:!$scope.facilityForFilter.facility?0:!$scope.facilityForFilter.facility.Id?0:$scope.facilityForFilter.facility.Id;$scope.dataToPost={nSurgeonId:doctorIds,nFacilityId:nFacId,nResourceId:$scope.selectedOR,bStatusAll:$scope.aptAll,bStatusActive:$scope.aptActive,bStatusDischarged:$scope.aptDischarged,strAptDate:$scope.selectedDate,aspFilter:$scope.aspFilters,selectedAnesthesiaType:$scope.selectedAnesthesiaType,nApptTime:$scope.apptTime};setAutoItemsPerPageReturnsPromise($scope.autoPaginationWrapperId,$scope.rowsPerPageDropdownId,$scope.rowOption.value,$scope.currentPage).then(function(results){$scope.rowOption.value=results;$http({method:'POST',url:'/mobiledoc/ascWeb/ORRoom.go/censusList/getJsonOfAscVisitsForOfficeVisit',headers:{'Content-Type':'application/x-www-form-urlencoded'},data:$.param({'data':JSON.stringify($scope.dataToPost),'orderBy':$scope.strOrderBy,'sortOrder':$scope.nSortOrder,'recordsPerPage':$scope.rowOption.value,'fromPage':currentPageNo}),cache:false}).then(function successCallback(response){if(response.data&&response.data.error){ecwAlert(response.data.error);$scope.selectedChkShowASCvisits=false;$scope.chkShowASCvisits=0;return false}$scope.filteredOfficeVisitList=response.data.rows;$scope.totalEncounter=response.data.totalRecords;for(var listIndex in $scope.filteredOfficeVisitList){$scope.filteredOfficeVisitList[listIndex].viewApptTime=$scope.convert24HourToAMPM($scope.filteredOfficeVisitList[listIndex].ScheduledStartTime);if($scope.filteredOfficeVisitList[listIndex].Gender.toLowerCase()=='male'){$scope.filteredOfficeVisitList[listIndex].viewGender="M"}else if($scope.filteredOfficeVisitList[listIndex].Gender.toLowerCase()=='female'){$scope.filteredOfficeVisitList[listIndex].viewGender="F"}else if($scope.filteredOfficeVisitList[listIndex].Gender.toLowerCase()=='unknown'){$scope.filteredOfficeVisitList[listIndex].viewGender="U"}else{$scope.filteredOfficeVisitList[listIndex].viewGender="-"}}},function errorCallback(response){});$('#this-tableOV').floatThead('reflow')})}else{$scope.selectedChkShowASCvisits=false;$scope.filterData()}};$scope.openProgressNoteASC=function(officeVisit){var url="";var isCallFromPATAppt=0;$scope.ASCMasterEncType=1001;url='#r=PnPanel.go/getPtDashboardView/'+officeVisit.encounterId+'/'+officeVisit.patientId+'/'+global.TrUserId+'/'+$scope.ASCMasterEncType+'/'+isCallFromPATAppt;location.href=url};$scope.timeDuration=function(encObj,time){var arrvTime=time;var outTime='00:00:00';var status=encObj.stsAfterArr;if(encObj.status!=='CHK'){var afterCheckIn=encObj.stsAfterChkIn;if(afterCheckIn.length>0&&afterCheckIn!=="OUT"){status=afterCheckIn}}if(status==='OUT'&&encObj.timeOut!=='00:00:00'){outTime=encObj.timeOut;if(encObj.UTCArrTime&&encObj.UTCTimeOut){arrvTime=getTimeInUTC(arrvTime,encObj.UTCArrTime);outTime=getTimeInUTC(outTime,encObj.UTCTimeOut)}}else if(encObj.depTime!=='00:00:00'){outTime=getTimeInUTC(encObj.depTime,encObj.UTCDepTime)}else{outTime=moment.utc().format("HH:mm:ss")}var totalDuration=timeInCalculation(arrvTime,outTime);return totalDuration};init();function init(){$scope.checkShowDateRange=function(viewType){$scope.showDateRange=false;if(isItemKeyEnabled('showUnlockedEnc')){if(viewType=="4"){$scope.selectedToDate=getmmddyyyyFormattedDate(new Date);$scope.formatSelectedToDate=getyyyymmddFormattedDate(new Date);if(displayToDate){$scope.selectedToDate=displayToDate;$scope.formatSelectedToDate=$.datepicker.formatDate('yy-mm-dd',new Date($scope.selectedToDate))}$scope.showDateRange=true}}if(viewType=="5"){$scope.selectedDate=getmmddyyyyFormattedDate(new Date((new Date).setDate((new Date).getDate()-29)));$scope.foramtSelectedDate=getyyyymmddFormattedDate(new Date((new Date).setDate((new Date).getDate()-29)));$scope.selectedToDate=getmmddyyyyFormattedDate(new Date);$scope.formatSelectedToDate=getyyyymmddFormattedDate(new Date);$scope.showDateRange=true}if($scope.prevViewType==="5"){$scope.selectedDate=getmmddyyyyFormattedDate(new Date);$scope.foramtSelectedDate=getyyyymmddFormattedDate(new Date)}};$scope.checkShowDateRange(viewType);if(facId!=="0"&&facName.length<=0){facId="0";facName="All"}facName=facId==="0"?"All":facName;var dataPair=facName.split(":");if(dataPair.length>1)facName=dataPair[dataPair.length-1];$scope.facId=facId;$scope.facName=facName;resetItemObj();getItemKeyValuePair("AhlersFamilyPlanning",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes")$scope.nyFPEncFormVisible=true;resetItemObj();getItemKeyValuePair("EnableCorrectionalFeatures",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes")$scope.chngMulApptPrvider=true;resetItemObj();getItemKeyValuePair("TransmitCharges",item);if(item.isExists&&item.itemId>0&&item.keyValue==="2")isXMLICDTrnsmt=true;resetItemObj();getItemKeyValuePair("EnableDepartments",item);if(item.isExists&&item.keyValue==="yes")$scope.enblDepartmnts=true;resetItemObj();getItemKeyValuePair("Enable_TMHP_FP_String",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.enblTMHPMenu=true}resetItemObj();getItemKeyValuePair("EnablePager",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.enblPager=true}resetItemObj();getItemKeyValuePair("EnableTENTSurgicalInterface",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.enblSurg=true}resetItemObj();getItemKeyValuePair("EncStatusCycleTime",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.encStsCyclTime=true}resetItemObj();getItemKeyValuePair("EnableVoiceInterface",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.enblVoice=true;$scope.shwVMsgIcon=true}getItemKeyValuePair("EnableWebPortal",item);if(item.isExists&&item.itemId>0&&item.itemId==="1"){$scope.bwebportalEnabled=true;nWebportal=1}resetItemObj();getItemKeyValuePair("EnableOverlakeAcuity",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.enblAcuityFormMenu=true}resetItemObj();getItemKeyValuePair("IgnoreProviderMap",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.enblClaimPrvdrMenu=true}resetItemObj();getItemKeyValuePair("IsPtPanelsEnabled",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.enblPatientPanelMenu=true}var itemId=getItemKeyValue("TransmitCharges");if(itemId.toLowerCase()==="yes")$scope.trnsmtChrgVisible=true;resetItemObj();getNextPreviousDate("today");officeVisits_checkIfPagerEnabled();checkIfPSACEnabled();checkForPNPermission();setPFLSettings();getVisitStsCodes();if(multiPVDSel&&multiPVDSel=='true'){multiPVDSel=true}else{multiPVDSel=false}getItemKeyValuePair("GroupDocumentation",item);if(item.isExists&&item.keyValue.toLowerCase()==="yes"){$scope.isGroupDocEnabled=true}$scope.fetchVisitQueueDashboardSetting=function(){officeVisitService.getVisitQueueDashboardSetting().success(function(result){$scope.enableVisitQueueDashBaord=result})};$scope.fetchVisitQueueDashboardSetting()}function checkForPNPermission(){$scope.permissionGranted=pnPermission}function checkIfPSACEnabled(){$scope.isPSACEnabled=false;var val=getItemKeyValue("EnablePSAC");if(val.toLowerCase()==="yes"||val==="1")$scope.isPSACEnabled=true}$scope.resourceList=[];$scope.staffList=[];$scope.resourceTabLoaded=false;$scope.loadResources=function(){if(!$scope.resourceTabLoaded){officeVisitService.getResources().success(function(result){var tempResourceList=xml2json(result);$scope.resourceList=validateResultArray($filter('filter')(validateResultArray(tempResourceList.Envelope.Body["return"].resource),{resourceType:'9'}));$scope.staffList=validateResultArray($filter('filter')(validateResultArray(tempResourceList.Envelope.Body["return"].resource),{resourceType:'2'}));$scope.resourceTabLoaded=true}).error(function(result){ecwAlert("An error occurred while loading Resources.","ECW"+" Alert")})}};if(parseInt(tabId,10)===2){$scope.loadResources()}function officeVisits_checkIfPagerEnabled(){$scope.pagerEnabled=false;var val=getItemKeyValue("EnablePager");if(val.toLowerCase()==="yes")$scope.pagerEnabled=true}$scope.pagerData=[];$scope.providerPagerData=[];$scope.pageInterval=[];$scope.usediffpager=false;$scope.selectedPagerCode="";$scope.encID="";$scope.pID="";$scope.selectedPagerCode="";$scope.selectedPagerInterval="";$scope.pagerGivenAt=moment().format("hh:mm:ss");$scope.pagingTime="0";$scope.pagermsg="";$scope.ppagermsg="";$scope.initCapCode="";$scope.initInterval="";$scope.machinename="";$scope.PagerVendor="";$scope.cancelPagingBtn=false;$scope.pagerStatusDesc="";$scope.allowSendingPageToPatient=patientPagingEnabled;$scope.allowSendingPageToProviders=prvdrPagingEnabled;$scope.patientPagingTabActive={attr:true};$scope.allowSendingPageToPatient=emrOfficeVisitJellybeanObj.allowSendingPageToPatient;$scope.allowSendingPageToProviders=emrOfficeVisitJellybeanObj.allowSendingPageToProviders;$scope.isPagerInitialised=false;$scope.showSelected=function(){$scope.pagingTime=moment().format("hh:mm:ss")};$scope.getMachineName=function(){var strUrl="/mobiledoc/jsp/webemr/menu/emr/configuration/deviceconfiguration/getDevicesConfiguration.jsp?";strUrl=strUrl+"id="+"getMachineName";strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){$scope.machinename=strContentData.trim()}};$scope.getPagerVendor=function(){var strUrl="/mobiledoc/jsp/webemr/menu/emr/configuration/deviceconfiguration/getDevicesConfiguration.jsp?";strUrl=strUrl+"id="+"getPagerVendor";strUrl=strUrl+"&facId="+$scope.facId;strUrl=strUrl+"&modality="+"Pager";strUrl=strUrl+"&macname="+$scope.machinename;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){$scope.PagerVendor=strContentData.trim()}};$scope.loadInitializedPager=function(){strUrl="/mobiledoc/jsp/catalog/xml/selectPagerNumberAndIntervalDesc.jsp?EncounterID="+$scope.encID;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData).Envelope.Body['return'].resultset.data.row;if(jsond!=undefined){$scope.pagerStatusDesc=jsond.StatusDesc;if($scope.pagerStatusDesc==='Cancelled'){}else{$scope.pagermsg=jsond.PagerTextMsg;$scope.initCapCode=jsond.SelectedPagerNumber;$scope.pagerData=[{"CapCode":$scope.initCapCode,"PagerID":jsond.PagerID,"PagerType":jsond.PagerType}];$scope.selectedPagerCode={inidata:$scope.pagerData[0]};$scope.pagerGivenAt=jsond.PagerGivenAt;$scope.pagingTime=jsond.PagingTime;$scope.isPagerInitialised=true;$scope.cancelPagingBtn=true}}}};$scope.initializePager=function(){var checkPagerFieldsLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_schedulepager","sendPageID","bluetheme");if(checkPagerFieldsLength){if($scope.selectedPagerCode.inidata.CapCode=="NA"){ecwAlert("Invalid Pager ID","eClinicalWorks",null,"","bluetheme")}else{$scope.showSelected();var xmlWriter=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xmlWriter);xmlWriter.writeStartElement('Item');xmlWriter.writeAttributeString('xsi:type','xsd:string');addElement(xmlWriter,"patientid",$scope.pID,'xsi:type','xsd:string');addElement(xmlWriter,"encounterid",$scope.encID,'xsi:type','xsd:string');addElement(xmlWriter,"facilityid",$scope.facid,'xsi:type','xsd:string');addElement(xmlWriter,"capcode",$scope.selectedPagerCode.inidata.CapCode,'xsi:type','xsd:string');addElement(xmlWriter,"pagergivenat",$scope.pagerGivenAt,'xsi:type','xsd:string');addElement(xmlWriter,"pagingtime",$scope.pagingTime,'xsi:type','xsd:string');addElement(xmlWriter,"userid",global.TrUserId,'xsi:type','xsd:string');addElement(xmlWriter,"pagermsg",$scope.pagermsg,'xsi:type','xsd:string');addElement(xmlWriter,"StatusDesc","",'xsi:type','xsd:string');xmlWriter.writeEndElement();endSoapPacket(xmlWriter);strUrl=makeURL("/mobiledoc/jsp/catalog/xml/InitialisePager.jsp");$http({headers:{"Content-Type":"application/x-www-form-urlencoded"},method:'POST',url:strUrl,data:"FormData="+xmlWriter.flush()}).success(function(response){var x2js=new X2JS;var jsonObject=x2js.xml_str2json(response);if(jsonObject.Envelope.Body["return"].status=="success"){$('.pgrdrpup').removeClass('open');$scope.isPagerInitialised=true;$scope.cancelPagingBtn=true}else{$('.pgrdrpup').removeClass('open')}})}}};$scope.cancelPaging=function(encId){strUrl="/mobiledoc/jsp/catalog/xml/CancelPaging.jsp?EncounterID="+encId;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);if(!angular.equals(strContentData,"")&&!angular.equals(strContentData,null)&&!angular.equals(strContentData,"null")){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);if(jsond.Envelope.Body["return"].status==="success"){$scope.cancelPagingBtn=false;$scope.isPagerInitialised=false;$('.pgrdrpup').removeClass('open')}}};$scope.loadDefaultFacility=function(){strUrl="/mobiledoc/jsp/catalog/xml/LoadUserProfile.jsp?UserId="+global.TrUserId;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);$scope.facid=jsond.Envelope.Body['return'].resultset.data.row.FacilityId}};$scope.PageNow=function(cookie,facilityid,encId,encDate){var checkPagerFieldsLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_schedulepager","sendPageID","bluetheme");if(checkPagerFieldsLength){var token=encodeURIComponent(csrfToken);$scope.cookie=cookie;var UrlDeviceName="pager";var UrlTestType=$scope.PagerVendor;var TrUserId=global.TrUserId;var Capcode=0;var PagerId=0;var PagerType="";var encFacId=facilityid;var patientId=$scope.pID;var PagerMsg="";if($('.active.tab-pane').hasClass('prvdr')){Capcode=$scope.selectedProviderPagerCode.inidata.CapCode;PagerId=$scope.selectedProviderPagerCode.inidata.PagerID;PagerType=$scope.selectedProviderPagerCode.inidata.PagerType;PagerMsg=$("#ppagermsg").val()}else{Capcode=$scope.selectedPagerCode.inidata.CapCode;PagerId=$scope.selectedPagerCode.inidata.PagerID;PagerType=$scope.selectedPagerCode.inidata.PagerType;PagerMsg=$("#pagermsg").val()}var deviceparam="DeviceParams="+encodeURIComponent(getDeviceParamsForOfficeVisit(UrlDeviceName,UrlTestType,global.TrUserId,encFacId,patientId,encId,encDate,Capcode,PagerId,PagerType,PagerMsg));$scope.RefreshButton=true;try{launchPlugin('id=pager|DeviceType='+UrlTestType+'|facilityId='+encFacId+'|encId='+encId+'|encDate='+encDate+'|patientId='+patientId+'|CapCode='+Capcode+'|PagerID='+PagerId+'|PagerMsg='+PagerMsg+'|userId='+encodeURIComponent(TrUserId)+'|'+deviceparam)}catch(err){console.log(err)}}};function getDeviceParamsForOfficeVisit(devicename,modality,uid,encFacId,patientId,encId,encDate,CapCode,PagerID,PagerType,PagerMsg){var newxml="<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>";newxml+="<SOAP-ENV:Envelope xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:xsd=\"http://www.w3.org/1999/XMLSchema\" xmlns:xsi=\"http://www.w3.org/1999/XMLSchema-instance\"><SOAP-ENV:Body><return><Document><UserId>"+uid+"</UserId><ItemType>"+modality+"</ItemType><DeviceName>"+devicename+"</DeviceName><facilityId>"+encFacId+"</facilityId><patientId>"+patientId+"</patientId><server>"+window.location.host+"</server><encId>"+encId+"</encId><encDate>"+encDate+"</encDate><CapCode>"+CapCode+"</CapCode><PagerID>"+PagerID+"</PagerID><PagerType>"+PagerType+"</PagerType><PagerMsg>"+PagerMsg+"</PagerMsg></Document></return></SOAP-ENV:Body></SOAP-ENV:Envelope>";return newxml}$scope.openPager=function(){$('.pgrdrpup').toggleClass('open')};$scope.loadPagerData=function(){$scope.chkActvTab();$scope.encID=this.officeVisit.encounterId;$scope.pID=this.officeVisit.patientId;name=this.officeVisit.name;time=this.officeVisit.time;time=moment(time,"HH:mm:ss").format("HH:mm A");$scope.ppagermsg=name+" is here for the "+time+" appt";$scope.loadDefaultFacility();$scope.getMachineName();$scope.getPagerVendor();$scope.loadInitializedPager();if($scope.pagerData.length==0){strUrl="/mobiledoc/jsp/catalog/xml/getPagerNumberData.jsp?FacilityID="+$scope.facId;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);$scope.pagerData=returnDataArray(jsond.Envelope.Body['return'].resultset.data.row);if($scope.pagerData===undefined||$scope.pagerData.length==0){$scope.pagerData=[{"CapCode":"NA","PagerID":"NA","PagerType":"NA"}]}else{$scope.selectedPagerCode={inidata:$scope.pagerData[0]}}}}if($scope.providerPagerData.length==0){strUrl="/mobiledoc/jsp/catalog/xml/getPagerNumberDataForProvider.jsp?FacilityID="+$scope.facid;strUrl=makeURL(strUrl);var strContentData=getUrlRespData(strUrl);strContentData=$.trim(strContentData);if(strContentData!=""&&strContentData!=null&&strContentData!="null"){x2js=new X2JS;var jsond=x2js.xml_str2json(strContentData);$scope.providerPagerData=returnDataArray(jsond.Envelope.Body['return'].resultset.data.row);if($scope.providerPagerData===undefined||$scope.providerPagerData.length==0){$scope.providerPagerData=[{"CapCode":"NA","PagerID":"NA","PagerType":"NA"}]}$scope.selectedProviderPagerCode={inidata:$scope.providerPagerData[0]}}}};function getVisitStsCodes(){var response=getVisitCodesAndStatuses();if(response!==null){try{$scope.visitCodes=response.VisitStatuses.resultset.data.row}catch(e){ecwAlert(e.message,"ECW Alert")}}}$scope.getVisitStsClr=function(code){var clrCode='#FFFFFF';angular.forEach($scope.visitCodes,function(visitStsCode,index){if(visitStsCode.code===code)clrCode='#'+visitStsCode.color});return clrCode};$scope.changViewType=function(){$scope.checkShowDateRange($scope.viewType);if(isItemKeyEnabled('showUnlockedEnc')){$scope.patientIdlist=[];$scope.hideSidePanel();$scope.closeDetailData();$scope.filterData()}$scope.prevViewType=$scope.viewType};$scope.setDepartment=function(){try{if(uiDefaults.selectedDepartment){$scope.departmentForFilter={};$scope.departmentForFilter.department=JSON.parse(uiDefaults.selectedDepartment)}}catch(err){console.log(err)}};$scope.setFacilityGroup=function(){try{if(uiDefaults.selectedFacilityGroup){$scope.facilityGrpForFilter={};$scope.facilityGrpForFilter.facilitygroup=JSON.parse(uiDefaults.selectedFacilityGroup)}}catch(err){console.log(err)}};$scope.setFacility=function(){try{if(uiDefaults.selectedFacility){$scope.facilityForFilter={};$scope.facilityForFilter.facility=JSON.parse(uiDefaults.selectedFacility)}}catch(err){console.log(err)}};$scope.selFacVal='Facility';if($scope.selectedChkShowASCvisits&&(uiDefaults&&(uiDefaults.selFacVal==="Departments"||uiDefaults.selFacVal==="FacilityGroup"))){$scope.chkShowASCvisits=0;selectedStickeyChkShowASCvisits=false;$scope.selectedChkShowASCvisits=false}if(uiDefaults&&uiDefaults.selFacVal){$scope.selFacVal=uiDefaults.selFacVal;if($scope.selFacVal=="Facility"){$scope.setFacility()}else if($scope.selFacVal=="FacilityGroup"){$scope.setFacilityGroup()}else if($scope.selFacVal=="Departments"){$scope.setDepartment()}}$scope.changeFacSel=function(val){$scope.selFacVal=val;if($scope.selFacVal=="Facility"){$scope.facilityGrpForFilter={facilitygroup:{Name:""}};$scope.departmentForFilter={department:{Name:""}};$scope.setFacility()}else if($scope.selFacVal=="FacilityGroup"){$scope.facilityForFilter={facility:{Name:""}};$scope.departmentForFilter={department:{Name:""}};$scope.setFacilityGroup()}else if($scope.selFacVal=="Departments"){$scope.facilityForFilter={facility:{Name:""}};$scope.facilityGrpForFilter={facilitygroup:{Name:""}};$scope.setDepartment()}$("#facDropDown").removeClass("open")};var intervalPromise=$interval(function(){if(!paused&&$scope.getActiveTabId()===1){$scope.autoRefresh=true;$scope.filterData()}},refreshInterval*1e3);$scope.saveUIDefaultData=function(){var selectedDocList=[];var doctorIds="";if(!multiPVDSel){var provider=$scope.providerForFilter.provider;if(provider&&provider.Id){selectedDocList.push({"id":provider.Id,"name":provider.Name});doctorIds=provider.Id}else{selectedDocList.push({"id":"0","name":"All"});doctorIds="0"}}else{angular.forEach($scope.providerForFilter.providerList,function(provider,$index){selectedDocList.push({"id":provider.Id,"name":provider.Name});doctorIds+=provider.Id;if($index!==$scope.providerForFilter.providerList.length-1){doctorIds+=","}})}var facIds="0";if($scope.facilityForFilter.facility.Id==undefined){facIds="0"}else{facIds=$scope.facilityForFilter.facility.Id}var resId="0";if($scope.resourceFilter==undefined){resId="0"}else{resId=$scope.resourceFilter}var selectedFacilityGroup={"GroupId":"0","Name":"All"};var selectedFacilityGroupId="0";if($scope.facilityGrpForFilter&&$scope.facilityGrpForFilter.facilitygroup.GroupId){selectedFacilityGroup.GroupId=$scope.facilityGrpForFilter.facilitygroup.GroupId;selectedFacilityGroup.Name=$scope.facilityGrpForFilter.facilitygroup.Name;selectedFacilityGroupId=$scope.facilityGrpForFilter.facilitygroup.GroupId}var selectedFacility={"Id":"0","Name":"All"};var selectedFacilityId="0";if($scope.facilityForFilter&&$scope.facilityForFilter.facility.Id){selectedFacility.Id=$scope.facilityForFilter.facility.Id;selectedFacility.Name=$scope.facilityForFilter.facility.Name;selectedFacilityId=$scope.facilityForFilter.facility.Id}var selectedDepartment={};var selectedDepartmentId=0;if($scope.departmentForFilter&&$scope.departmentForFilter.department.DeptId){selectedDepartment.DeptId=$scope.departmentForFilter.department.DeptId;selectedDepartment.DeptName=$scope.departmentForFilter.department.DeptName;selectedDepartmentId=$scope.departmentForFilter.department.DeptId}if(!uiDefaults){uiDefaults={}}uiDefaults.Facility=""+facIds;uiDefaults.Provider=""+doctorIds;uiDefaults.ApptTime=""+$scope.apptTime;uiDefaults.CheckStatus=""+$scope.viewType;uiDefaults.SortBy=""+$scope.sortType;uiDefaults.DocList=JSON.stringify(selectedDocList);uiDefaults.Resource=""+resId;uiDefaults.selResourceFilter=$scope.selResourceFilter;uiDefaults.selFacVal=$scope.selFacVal;uiDefaults.selectedFacilityGroup=JSON.stringify(selectedFacilityGroup);uiDefaults.selectedFacilityGroupId=selectedFacilityGroupId;uiDefaults.selectedFacility=JSON.stringify(selectedFacility);uiDefaults.selectedFacilityId=selectedFacilityId;uiDefaults.selectedDepartment=JSON.stringify(selectedDepartment);uiDefaults.selectedDepartmentId=selectedDepartmentId.toString();uiDefaults.selectedChkShowASCvisits=""+$scope.selectedChkShowASCvisits;if(isUiDefaultsChanged()){preUiDefaults=angular.copy(uiDefaults);var serverUrl="/mobiledoc/jsp/webemr/common/setUIDefault.jsp?doctorId="+global.TrUserId+"&formName=frmDoctorsView";serverUrl=makeURL(serverUrl);var xsrf=$.param({uiDefaults:JSON.stringify(uiDefaults)});var aPromise=$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:serverUrl,data:xsrf}).then(function(response){},function(response){})}};function isUiDefaultsChanged(){return!_.isEqual(uiDefaults,preUiDefaults)}$scope.resizeOfficeVisit=function(){try{setTimeout(function(){emrOfficeVisitJellybeanObj.$demo1.floatThead('reflow')},500)}catch(err){}};$("#jellybean-panelLink4").click($scope.resizeOfficeVisit);$("#jellybean-panelLink5").click($scope.resizeOfficeVisit);$scope.$on('$destroy',function(){$interval.cancel(intervalPromise);$scope.saveUIDefaultData();ovCleanup();try{var $table=$('#this-tableOV');$table.floatThead('destroy');$table=null;if(dashboardDtFocusHandler&&typeof dashboardDtFocusHandler=='function'){$(".only-date").off('focus',dashboardDtFocusHandler)}if(dashboardInputCalClkHandler&&typeof dashboardInputCalClkHandler){$(".icon-inputcalender").off('click',dashboardInputCalClkHandler)}$('#filter').off('shown.bs.collapse');$('#filter').off('hidden.bs.collapse');$('.main-wrap').off("click",fnHideSidePanel);var elem1=$('#officeVisitCTRL').find('.hplus-sidePanel');if(elem1){fnDestroyActivityPanel(elem1)}$("#jellybean-panelLink4").unbind("click",$scope.resizeOfficeVisit);$("#jellybean-panelLink5").unbind("click",$scope.resizeOfficeVisit);if(groupBtnClickHandler&&typeof groupBtnClickHandler=='function'){$("#btnOkGroupVisit,#btnGroupApptModalClose").off('click',groupBtnClickHandler)}}catch(err){}emrOfficeVisitJellybeanObj=null});function ovCleanup(){sortBy=null,apptTime=null,viewType=null,resourceId=null,tabId=null,trUserName=null,providersId=null,multiPVDSel=null,facId=null,facName=null;vFacilityGrpId=null,displayDate=null,displayToDate=null,trUserId=null,fromPageLoad=null,maxCount=null,prvdrPagingEnabled=null;accessOrders=null,patientPagingEnabled=null,pnPermission=null,chartLock=null,officeVisitStrXML=null,resourceListXML=null;serverTimeStamp=null,uiDefaults=null;encObj=null,frmOfficeVisit=null,nuclearTestVisitFlg=null;ECW_VISITSTATUSCODE_MAPPING_CHECKIN=null,ECW_VISITSTATUSCODE_MAPPING_CHKOUT=null;ECW_VISITSTATUSCODE_MAPPING_CANCEL=null,ECW_VISITSTATUSCODE_MAPPING_NOSHOW=null;ECW_VISITSTATUSCODE_MAPPING_PENDING=null,ECW_VISITSTATUSCODE_MAPPING_RESCHEDULED=null;$demo1=null;$element=null;g_mainScreenName=null}$scope.nextPrevDate=function(val){$scope.closeDetailData();$scope.patientIdlist=[];$scope.hideSidePanel();getNextPreviousDate(val)};function getNextPreviousDate(val){var date="";var setDateRange=false;if($scope.showDateRange&&getDateDiffInDay($scope.selectedDate,$scope.selectedToDate)===30){setDateRange=true}if(val==="today"){date=new Date;$scope.todaysDate=date.format("yyyy-mm-dd")}else if(val==="next"){date=new Date($scope.selectedDate);date.setDate(date.getDate()+1)}else if(val==="toNext"){date=new Date($scope.selectedToDate);date.setDate(date.getDate()+1)}else if(val==="previous"){date=new Date($scope.selectedDate);date.setDate(date.getDate()-1)}else{date=new Date($scope.selectedToDate);date.setDate(date.getDate()-1)}if(val==="toNext"||val==="toPrevious"||val==="toToday"){$scope.selectedToDate=getmmddyyyyFormattedDate(date);$scope.formatSelectedToDate=$.datepicker.formatDate('yy-mm-dd',new Date(date));$scope.dateChangeFrom='ToDate';if(setDateRange){$scope.selectedDate=getAdjustDateRangeDate(val,$scope.selectedDate)}}else{$scope.selectedDate=getmmddyyyyFormattedDate(date);$scope.foramtSelectedDate=$.datepicker.formatDate('yy-mm-dd',new Date(date));$scope.dateChangeFrom='FromDate';if(setDateRange){$scope.selectedToDate=getAdjustDateRangeDate(val,$scope.selectedToDate)}}}function getAdjustDateRangeDate(val,selectedDate){var date=new Date(selectedDate);if(val==="next"||val==="toNext"){date.setDate(date.getDate()+1)}else if(val==="previous"||val==="toPrevious"){date.setDate(date.getDate()-1)}return getmmddyyyyFormattedDate(date)}$scope.$watch('selectedDate',function(newValue,oldValue){if(newValue!==oldValue){$scope.dateChangeFrom='FromDate';$scope.selectedDate=newValue;$scope.foramtSelectedDate=$.datepicker.formatDate('yy-mm-dd',new Date(newValue));$scope.closeDetailData();$scope.patientIdlist=[];$scope.hideSidePanel();$scope.filterData()}});$scope.$watch('selectedToDate',function(newValue,oldValue){if(newValue!==oldValue){$scope.dateChangeFrom='ToDate';$scope.selectedToDate=newValue;$scope.formatSelectedToDate=$.datepicker.formatDate('yy-mm-dd',new Date(newValue));$scope.patientIdlist=[];$scope.closeDetailData();$scope.hideSidePanel();$scope.filterData()}});$scope.apptTime=apptTime;$scope.viewType=viewType;$scope.prevViewType=$scope.viewType;$scope.sortType=sortBy;$scope.resourceFilter=resourceId;const rawListArray=['25','50','100'];$scope.autoPaginationWrapperId="officeVisitListWrapper";$scope.rowsPerPageDropdownId="officeVisitsSel8";$scope.rowOptionList=getRecordsPerPageWithAutoOption(rawListArray,maxCount);let maxCountIndex=rawListArray.indexOf(maxCount);if(maxCountIndex>=0){$scope.rowOption=$scope.rowOptionList[maxCountIndex]}else{$scope.rowOption=$scope.rowOptionList[initializeItemsPerPage($scope.rowOptionList,$scope.rowOptionList.length-1)]}$scope.multiPVDSel=multiPVDSel;var providersName="";$scope.providerForFilter={provider:{},providerList:[]};if(uiDefaults.DocList){var selectedDocList=JSON.parse(uiDefaults.DocList);if(selectedDocList.length<=0){var name=getProviderName(providersId);var tempPrvdr={};tempPrvdr["Id"]=providersId;tempPrvdr["Name"]=name;if(multiPVDSel){$scope.providerForFilter.providerList.push(tempPrvdr)}else{$scope.providerForFilter.provider=tempPrvdr}}else{for(var selDocIndex=0;selDocIndex<selectedDocList.length;selDocIndex++){var tempPrvdr={};tempPrvdr["Id"]=selectedDocList[selDocIndex].id;tempPrvdr["Name"]=selectedDocList[selDocIndex].name;if(multiPVDSel){$scope.providerForFilter.providerList.push(tempPrvdr)}else{$scope.providerForFilter.provider=tempPrvdr}}}}else{if(providersId.length>0){var ids=providersId.split(",");for(var i=0;i<ids.length;i++){if($.trim(ids[i])!=""){var name=getProviderName($.trim(ids[i]));var tempPrvdr={};tempPrvdr["Id"]=ids[i];tempPrvdr["Name"]=ids[i]=='0'?"All":name;if(multiPVDSel){$scope.providerForFilter.providerList.push(tempPrvdr)}else{$scope.providerForFilter.provider=tempPrvdr}}}}}$scope.selectedRow=function(){$scope.selectedRowObj=this.officeVisit};$scope.saveEncRoomNo=function(officeVisitRow){if(isEventToValidateEncRoomNo){$scope.validateEncRoomNo(officeVisitRow)}};$scope.saveEncRoomNoWithDebounce=function(){let timer;return officeVisitRow=>{$scope.pauseIntervalOfOvRefresh();clearTimeout(timer);timer=setTimeout(()=>{$scope.saveEncRoomNo(officeVisitRow)},2e3)}};$scope.saveRoomNo=$scope.saveEncRoomNoWithDebounce();$scope.validateEncRoomNo=function(officeVisitRow){isEventToValidateEncRoomNo=false;if(!validateRoom(officeVisitRow.encounterId)){$scope.resumeIntervalOfOvRefresh();$timeout(function(){isEventToValidateEncRoomNo=true},1e3);return}$timeout(function(){isEventToValidateEncRoomNo=true},1e3);$scope.doSaveEncRoomNo(officeVisitRow)};$scope.doSaveEncRoomNo=function(officeVisitRow){var param={encounterId:officeVisitRow.encounterId,roomNo:officeVisitRow.room};officeVisitService.saveEncRoomNo(param).success(function(){var doctorIds="";angular.forEach($scope.providerForFilter.providerList,function(provider,$index){doctorIds+=provider.Id;if($index!==$scope.providerForFilter.providerList.length-1)doctorIds+=", "});if($scope.selectedTab===2){doctorIds="";if($scope.resourceFilter!=="0"){doctorIds=$scope.resourceFilter}else{angular.forEach($scope.resourceList,function(resource,$index){doctorIds+=resource.id;if($index!==$scope.resourceList.length-1)doctorIds+=", "})}}$scope.doctorId=$scope.selectedTab===1?0:doctorIds===""?$scope.trUserId:doctorIds;prepareParam();$scope.resumeIntervalOfOvRefresh()}).error(function(){$scope.resumeIntervalOfOvRefresh()})};$scope.resumeIntervalOfOvRefresh=function(){paused=false};$scope.pauseIntervalOfOvRefresh=function(){paused=true};$scope.saveEncStatus=function(){var date=new Date;var logDate=date.format("yyyy-mm-dd HH:MM:ss");var param={encounterId:$scope.selectedRowObj.encounterId,userId:$scope.trUserId,logDate:logDate,status:$scope.selectedStatusCode.code,name:$scope.selectedStatusCode.name,calledby:'officevisit'};officeVisitService.saveEncStatus(param).success(function(){var doctorIds="";angular.forEach($scope.providerForFilter.providerList,function(provider,$index){doctorIds+=provider.Id;if($index!==$scope.providerForFilter.providerList.length-1)doctorIds+=", "});if($scope.selectedTab===2){doctorIds="";if($scope.resourceFilter!=="0"){doctorIds=$scope.resourceFilter}else{angular.forEach($scope.resourceList,function(resource,$index){doctorIds+=resource.id;if($index!==$scope.resourceList.length-1)doctorIds+=", "})}}$scope.doctorId=$scope.selectedTab===1?0:doctorIds===""?$scope.trUserId:doctorIds;prepareParam()})};$scope.openGlobalAlert=function(){if($scope.validateSingleEncSelection()){$scope.patientIdentifiers=$scope.encounterObj.patientId;$scope.PNOptionsPopUpURL="";var param={patientId:$scope.encounterObj.patientId,Patientname:$scope.encounterObj.name};param=$.param(param);$ocLazyLoad.load({name:'NewBillingGlobalAlert',files:['/mobiledoc/jsp/webemr/billingalert/billingGlobalalert.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/billingalert/billingGlobalDetails.jsp?'+param);$scope.PNOptionsPopUpURL=url},function(e){console.log(e)})}};$scope.transmitCharges=function(){if($scope.validateSingleEncSelection()){var nEncId=$scope.selectedEncouterObj.encounterId;var param={"encounterId":nEncId};officeVisitService.generateHL7Msg(param).success(function(result){var x2js=new X2JS;jsonData=x2js.xml_str2json(result);retObj=jsonData.Envelope.Body['return'].status;if(retObj==="success")ecwAlert("Transmitted charges successfully.","ECW Alert");else ecwAlert("An error occurred while generating HL7 Messages.","ECW Alert")}).error(function(result){ecwAlert("An error occurred while generating HL7 Messages.","ECW Alert")})}};$scope.openPNOptionModal=function(id){if(id!="changeVisitSts"){if($scope.validateSingleEncSelection()){if(id==="claimProvider"){$scope.PNOptionsPopUpURL="";var params={TrUserId:trUserId,encounterId:$scope.encounterObj.encounterId,ms:(new Date).getTime()};params=$.param(params);$ocLazyLoad.load({name:'claimProvider',files:['/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/claimProviderController.js']}).then(function(){var url="/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/claimProvider.jsp?"+params;$scope.PNOptionsPopUpURL=url},function(e){})}else if(id==="changeApptProvider"){var encObj=[];var selectedEncList=[];encObj.doctorId=$scope.encounterObj.ProviderId;encObj.ResourceId=$scope.encounterObj.ResourceId;encObj.resourceType=$scope.encounterObj.ResourceType;encObj.name=$scope.encounterObj.name;encObj.encounterId=$scope.encounterObj.encounterId;encObj.encDate=$scope.encounterObj.date;encObj.encFacilityId=$scope.encounterObj.facilityId;selectedEncList.push(encObj);var initCustomData={selectedEncList:selectedEncList};$scope.PNOptionsPopUpURL="";$ocLazyLoad.load({name:'assignProvider',files:['/mobiledoc/jsp/webemr/templates/browseCommon-tpl.js','/mobiledoc/jsp/webemr/templates/keywords-tpl.js','/mobiledoc/jsp/webemr/templates/change-appt-provider.js']}).then(function(){$scope.frmOfficeVisit=true;var url='/mobiledoc/jsp/webemr/templates/change-appt-provider.jsp';url=makeURL(url);var customStructModalInstance=$modal.open({templateUrl:url,controller:'ChangeApptProviderController',windowClass:'app-modal-window bluetheme',backdrop:"static",size:"mid",resolve:{initCustomData:function(){return initCustomData}}});customStructModalInstance.result.then(function(responseObj){},function(responseObj){if(responseObj){$scope.refreshData('button')}})},function(e){console.log(e)})}else if(id==="acuityForm"){$scope.PNOptionsPopUpURL="";$ocLazyLoad.load({name:'printHealthRecordMDL',files:['/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/AcuityController.js']}).then(function(){var url='/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/AcuityForm.jsp?encId='+$scope.encounterObj.encounterId+'&ptId='+$scope.encounterObj.patientId+"&TrUserId="+trUserId;$scope.PNOptionsPopUpURL=url},function(e){console.log(e)})}else if(id==="tmhp"){$scope.PNOptionsPopUpURL="";$ocLazyLoad.load({name:"tmhp",cache:false,files:['/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/tmhpController.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url="/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/tmhp.jsp?encounterId="+$scope.encounterObj.encounterId+"&TrUserId="+trUserId;$scope.PNOptionsPopUpURL=makeURL(url)},function(e){console.log(e)})}else if(id==="km3KIDMED"){$("#km3KidMed").modal({backdrop:"static",keyboard:false});var url='/mobiledoc/jsp/catalog/xml/edi/KIDMEDbillingform.jsp?fromWeb=yes&EncId='+$scope.encounterObj.encounterId;$scope.km3KidMedFrameURL=makeURL(url)}$("#viewPNOptions").removeClass("open")}}else if(id==="changeVisitSts"&&$scope.selectedEncounters){$scope.PNOptionsPopUpURL="";for(var rIndex in $scope.filteredOfficeVisitList){if($scope.filteredOfficeVisitList[rIndex].offVisitRowChecked){if($scope.filteredOfficeVisitList[rIndex].encLock=='1'){$scope.alertMessage="One or more selected encounters are locked. System can not change the visit status for locked encounters. Please unselect the locked encounters and try again.";ecwAlert($scope.alertMessage,"ECW Alert");return}}}$ocLazyLoad.load({name:'changevststs',files:['/mobiledoc/jsp/webemr/progressnotes/physiciandashboard/changeVisitStatusController.js']}).then(function(){var url='/mobiledoc/jsp/webemr/progressnotes/physiciandashboard/changeVisitStatus.jsp';$scope.frmOfficeVisit=true;url=makeURL(url);$scope.PNOptionsPopUpURL=url},function(e){console.log(e)});$("#viewPNOptions").removeClass("open")}else{$scope.alertMessage="Please select an Encounter";ecwAlert($scope.alertMessage,"ECW Alert")}};$scope.closeKIDMEDModal=function(){$("#km3KidMed").modal('hide')};function openPrintDialog(modelFlag,html){var windowContent="";if(html&&html!="")windowContent+=html;else windowContent+=$('#previewContent').html();$('<iframe id="myFrame" name="myFrame">').appendTo('body');var doc=$("#myFrame")[0].contentWindow.document;doc.open();doc.write(windowContent);doc.close();onReadyState2();if(modelFlag==1)$('#previewContent').html("")}var timeOut=0;function onReadyState2(){try{$timeout(function(){if($('#myFrame').contents().find("body").html()){timeOut=0;printWitoutDomain("myFrame")}else{timeOut++;if(timeOut>150){timeOut=0;ecwAlert("Could Not Load the Requested page,try again!","ECW Alert");return false}onReadyState2()}},200)}catch(e){}}$scope.redirectAction=function(action){$scope.divFlag=action};$scope.viewOrders=function(){if($scope.validateSingleEncSelection()){if(/true/i.test(accessOrders)){$templateCache.remove($scope.PNOptionsPopUpURL);$ocLazyLoad.load({name:'ptOrdersApp',files:['/mobiledoc/jsp/webemr/scheduling/patientorders/patientOrdersController.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/scheduling/patientorders/patientOrders.jsp?PatientId="+$scope.selectedEncouterObj.patientId+"&EncounterId="+$scope.selectedEncouterObj.encounterId);$scope.PNOptionsPopUpURL=url},function(e){console.log(e)})}else{ecwAlert("Permission denied.","ECW Alert")}}};$scope.viewPtPanel=function(){if($scope.validateSingleEncSelection()){var popupUrl=makeURL("/mobiledoc/jsp/ptpanel/ptPanelContainer.jsp?providerId="+$scope.encounterObj.ProviderId+"&patientId="+$scope.encounterObj.patientId+"&ptname="+$scope.encounterObj.name+"&age=0 &ageFlag=&gender="+$scope.encounterObj.sex+"&isWebEMR=yes");$ocLazyLoad.load({name:"ptPanelApp",files:['/mobiledoc/jsp/ptpanel/ptPanelContainerCntrl.js'],cache:true}).then(function(){var customStructModalInstance=$modal.open({templateUrl:popupUrl,controller:'ptPanelController',windowClass:'app-modal-window bluetheme',backdrop:"static",size:"modal-lg"})},function(e){console.log(e)})}};$scope.showBillingData=function(){if($scope.validateSingleEncSelection()){if($scope.selectedEncouterObj.encLock=='1'){ecwAlert("Selected Encounter is locked. Any changes to Billing data will not be saved.","ECW Alert",function(){PSACService.checkBothStaffAndChartPermissionWithoutPNSec($scope.selectedEncouterObj.patientId,$scope.encounterObj.encounterId,"","",showBillingDataAfterCheck,"")},"","","",false)}else{PSACService.checkBothStaffAndChartPermissionWithoutPNSec($scope.selectedEncouterObj.patientId,$scope.encounterObj.encounterId,"","",showBillingDataAfterCheck,"")}}};$scope.resetPNModalPopUp=function(){$templateCache.remove($scope.PNOptionsPopUpURL);$scope.PNOptionsPopUpURL=""};var showBillingDataAfterCheck=function(){var params={TrUserId:trUserId,encounterId:$scope.selectedEncouterObj.encounterId,patientId:$scope.selectedEncouterObj.patientId,ms:(new Date).getTime()};params=$.param(params);$templateCache.remove($scope.PNOptionsPopUpURL);$scope.linkurl='';$ocLazyLoad.load({name:'pnModalApp',files:['/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/pnModalController.js']}).then(function(){$scope.popupurl={value:''};$scope.PNOptionsPopUpURL='/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/pnModal.jsp?source=officeVisitController&'+params;$ocLazyLoad.load({name:'billing',serie:true,files:['/mobiledoc/jsp/webemr/progressnotes/billing/assessmentNotes-tpl.js','/mobiledoc/jsp/webemr/templates/cpt-tpl.js','/mobiledoc/jsp/webemr/templates/icd-tpl.js','/mobiledoc/jsp/webemr/progressnotes/billing/billingController.js']}).then(function(){$scope.popupurl={value:''};$scope.pn_popup_height=578;$scope.pn_popup_title="Billing";EncDetailsService.getEncDetailsByEncId($scope.selectedEncouterObj.encounterId);$scope.titleCaption=EncDetailsService.getCaption($scope.selectedEncouterObj.patientId,$scope.selectedEncouterObj.encounterId);$scope.popupurl.value="/mobiledoc/jsp/webemr/progressnotes/billing/billing.jsp?isOV=true&"+params},function(e){ecwAlert(e,"ECW Alert")})},function(e){ecwAlert(e,"ECW Alert")})};$scope.openTranscribe=function(){if($scope.validateSingleEncSelection()){var params={encounterId:$scope.selectedEncouterObj.encounterId,patientId:$scope.selectedEncouterObj.patientId,transcriptionsWindow:1,trUserId:trUserId};params=$.param(params);$ocLazyLoad.load({name:'recordVoicePopUpApp',files:['/mobiledoc/jsp/webemr/jellybean/transcriptions/js/recordVoicePopupController.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/WAMI/js/swfobject.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/WAMI/js/WAMIrecorder.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/js/recordHelper.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/js/audio.min.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/js/jquery.timer.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/js/xmlHelper.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/js/ajaxHelper.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/js/recorder.js','/mobiledoc/jsp/webemr/jellybean/transcriptions/js/recorderWorker.js']}).then(function(){var url='/mobiledoc/jsp/webemr/jellybean/transcriptions/NJellyBeanRecording.jsp?'+params;$scope.PNOptionsPopUpURL=url},function(e){})}};$scope.changeProvider=function(){var enctrId=$scope.encounterObj.encounterId;var providerId=$scope.changedPrvdr.provider.Id;var resourceId=$scope.resource.id;var data={EncId:enctrId,ProviderId:providerId,ResourceId:resourceId};officeVisitService.updateEncProvider(data).success(function(result){prepareParam();$scope.changedPrvdr.provider={}})};$scope.exportData=function(exportMode){var viewRprtCnfgVal="cwReports.txt";if(exportMode==="Excel"){viewRprtCnfgVal="cwReports.xls"}else{viewRprtCnfgVal="cwReports.txt"}if($scope.filteredOfficeVisitList.length>0){var objList=[];angular.forEach($scope.filteredOfficeVisitList,function(ov,index){var encObj={};encObj["Visit Type"]=ov.visitType;if($scope.isEnableUTCScheduling){encObj["Appt Time"]=$scope.convert24HourToAMPM(ov.time)+' '+ov.facilityTimeZone}else{encObj["Appt Time"]=$scope.convert24HourToAMPM(ov.time)}encObj["Patient Name"]=ov.name;if(isItemKeyEnabled("showInsuranceInOfficeVisit")){encObj["Insurance"]=ov.insName}encObj["P/R"]=ov.providercode;encObj["Reason"]=ov.reason;encObj["Sex"]=ov.sex;encObj["Age"]=ov.age;encObj["Visit Sts"]=ov.status;if($scope.isHealowInsightsHCCEnabled()&&$scope.HealowInsightsOVSummaryViewConfig.column==='1'){encObj["HCC Un-Reviewed"]=ov.unreviewed}if($scope.isHealowInsightsQMEnabled()&&$scope.HealowInsightsOVSummaryViewConfig.column==='1'){encObj["QM (O/W)"]=ov.qmList===''?'-':ov.qmList}if(ov.arrivedTime==='00:00:00'){encObj["Arr Time"]="-"}else{encObj["Arr Time"]=getTimeInFacilityTZ(ov.arrivedTime,ov.factz_arrTime,ov.facilityTimeZone)}encObj["Duration"]=$scope.timeDuration(ov,getTimeInUTC(ov.arrivedTime,ov.UTCArrTime));encObj["Room"]=ov.room;encObj["Status"]=ov.stsAfterChkIn;encObj["Notes Sts"]=ov.notesStatus;objList.push(encObj)});var fileType="text";var fileName="ovEnctrs.txt";if(viewRprtCnfgVal==="cwReports.xls"){fileType="excel";fileName="ovEnctrs.xls"}$("#exportDataId").val(JSON.stringify(objList));$("#fileNameId").val(fileName);$("#fileTypeId").val(fileType);$("#exportDataFrm").submit()}else{ecwAlert("There are no encounters for export.","ECW Alert")}$("#ovExportBtn").removeClass("open")};$scope.openCreateGroupDoc=function(groupEncId,userId){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs($scope,$ocLazyLoad).groupNewAppt(groupEncId,userId)},function(e){console.log(e)})};$scope.getvisitTab=function(tabId){$scope.setActiveTabId(tabId);if(tabId===1){document.getElementById("officeVisitTabId").style.display="block";document.getElementById("groupVisitTabId").style.display="none";document.getElementById("prePostOpTabId").style.display="none"}else if(tabId===2){$('#dvLoading').css('display','block');document.getElementById("groupVisitTabId").style.display="block";document.getElementById("officeVisitTabId").style.display="none";document.getElementById("prePostOpTabId").style.display="none";$ocLazyLoad.load({name:'groupAppointmentLandingView',files:['/mobiledoc/jsp/webemr/ccmr/groupdocumentation/css/groupAppointmentLanding.css','/mobiledoc/jsp/webemr/ccmr/groupdocumentation/css/perfect-scrollbar.min.css','/mobiledoc/jsp/webemr/ccmr/groupdocumentation/js/sharedGroupScheduleDataService.js','/mobiledoc/jsp/webemr/ccmr/groupdocumentation/js/groupScheduleService.js','/mobiledoc/jsp/webemr/ccmr/groupdocumentation/js/groupAppointmentLandingService.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/EncDetailsService.js','/mobiledoc/jsp/webemr/ccmr/groupdocumentation/js/groupAppointmentLandingController.js']}).then(function(){var url='/mobiledoc/jsp/webemr/ccmr/groupdocumentation/groupAppointmentLanding.jsp';$scope.groupApptUrl=makeURL(url)},function(e){ecwAlert(e,"ECW Alert")})}else if(tabId===3){document.getElementById("prePostOpTabId").style.display="block";document.getElementById("officeVisitTabId").style.display="none";document.getElementById("groupVisitTabId").style.display="none";$scope.loadPrePostOp()}};$scope.dsbldProvider=false;$scope.getEncountersForTab=function(tabId){IntialiseSearchText();$scope.selectedTab=tabId;if(tabId===1){$scope.dsbldProvider=true;$scope.hidefor_tab_all=true;$scope.TabFlag_Session="1"}else{$scope.TabFlag_Session="0";$scope.dsbldProvider=false;$scope.hidefor_tab_all=false}if(tabId===2){$scope.loadResources();document.getElementById("resourceLkup").style.display="block";try{$scope.selResourceFilter="Resource";if(uiDefaults.selResourceFilter){$scope.selResourceFilter=uiDefaults.selResourceFilter}}catch(err){$scope.selResourceFilter="Resource"}}$scope.currentPage=1;$scope.patientIdlist=[];$scope.closeDetailData();$scope.hideSidePanel();$scope.filterData()};$scope.refreshData=function(refreshFrom){if($scope.selectedChkShowASCvisits==true){$scope.showASCvisits()}else{prepareParam()}if(refreshFrom==='button'){$scope.selectAll=false;$scope.selectedEncounters=[];$scope.selectedEncouterObj=undefined;$scope.encounterObj=undefined}};$scope.getSelectedEnc=function(){return{'encounters':$scope.selectedEncounters}};function IntialiseSearchText(){}function prepareParam(){if($scope.viewType=="5"||isItemKeyEnabled('showUnlockedEnc')&&$scope.viewType==="4"){var diff=new Date($scope.selectedToDate).getTime()-new Date($scope.selectedDate).getTime();if(diff<0){if($scope.dateChangeFrom==='FromDate'){ecwAlert("From Date should not be later than To Date.","eClinicalWorks");return false}else{ecwAlert("To Date should not be earlier than From Date.","eClinicalWorks");return false}}diff=getDateDiffInDay($scope.selectedDate,$scope.selectedToDate);if(diff&&diff>=31){commonWarningPopup({screenName:'Office Visits',screenTitle:'Date Range',buttons:[{label:"OK",cssClass:'btn-blue',callbackEvent:function(){}}],message:'Date Range cannot exceed limit of 31 days',isErrorPopup:true,screenSpecificClass:'officeVisitDateRangeError',isKeyboardClose:false},$ocLazyLoad,$modal);return false}}if($scope.selectedTab==1){$scope.doctorId=0}else if($scope.selectedTab==2){var doctorIds="";if($scope.resourceFilter!=="0"){doctorIds=$scope.resourceFilter}else{if($scope.selResourceFilter==='Resource'){angular.forEach($scope.resourceList,function(resource,$index){doctorIds+=resource.id;if($index!==$scope.resourceList.length-1)doctorIds+=", "})}else{angular.forEach($scope.staffList,function(resource,$index){doctorIds+=resource.id;if($index!==$scope.staffList.length-1)doctorIds+=", "})}}$scope.doctorId=doctorIds}else if($scope.selectedTab==3){if(multiPVDSel){var doctorIds="";if(!$scope.providerForFilter.providerList||$scope.providerForFilter.providerList.length===0){$scope.doctorId="0"}angular.forEach($scope.providerForFilter.providerList,function(provider,$index){doctorIds+=provider.Id;if($index!==$scope.providerForFilter.providerList.length-1){doctorIds+=", "}$scope.doctorId=doctorIds})}else{if($scope.providerForFilter.provider){var provider=$scope.providerForFilter.provider;$scope.doctorId=provider.Id}}}var doctorId=$scope.doctorId===undefined?$scope.trUserId:$scope.doctorId;var facIds="";if($scope.facilityForFilter.facility.Id==undefined){facIds="0"}else{facIds=$scope.facilityForFilter.facility.Id}var facilityId=facIds;var facilityGrpId="0";facilityGrpId=$scope.facilityGrpForFilter===undefined?0:$scope.facilityGrpForFilter.facilitygroup.GroupId===undefined?0:$scope.facilityGrpForFilter.facilitygroup.GroupId;var deptId="0";deptId=$scope.departmentForFilter===undefined?0:$scope.departmentForFilter.department.DeptId===undefined?0:$scope.departmentForFilter.department.DeptId;var currentPageNo=$scope.currentPage===undefined?1:$scope.currentPage;setAutoItemsPerPageReturnsPromise($scope.autoPaginationWrapperId,$scope.rowsPerPageDropdownId,$scope.rowOption.value,$scope.currentPage).then(function(results){$scope.rowOption.value=results;var nCounterValue=currentPageNo*$scope.rowOption.value-$scope.rowOption.value;if($scope.selFacVal=="Facility"){deptId="0";facilityGrpId="0"}else if($scope.selFacVal=="FacilityGroup"){deptId="0";facilityId="0"}else if($scope.selFacVal=="Departments"){facilityId="0";facilityGrpId="0"}var varAll='false';var data;var strToDate="";if($scope.showDateRange){strToDate=$scope.formatSelectedToDate}data={eDate:$scope.foramtSelectedDate,doctorId:doctorId,sortBy:$scope.sortType,facilityId:facilityId,apptTime:$scope.apptTime,checkinstatus:$scope.viewType,FacilityGrpId:facilityGrpId,maxCount:$scope.rowOption.value,nCounter:nCounterValue,DeptId:deptId,fromWeb:"yes",fromAfterCare:"officeVisit",tabId:$scope.selectedTab,toDate:strToDate,selectedChkShowASCvisits:$scope.selectedChkShowASCvisits};if($scope.selectedPatientFilter&&$scope.selectedPatientFilter.id){data.ptFilter=$scope.selectedPatientFilter.requestParam;data.ptFilterText=$scope.ptFilterText}if(isHealowInsightsEnabled()&&$scope.HealowInsightsOVSummaryViewConfig.column==='1'){data.showHealowInsightsColumns="true"}if(isHealowInsightsEnabled()&&$scope.HealowInsightsOVSummaryViewConfig.bridgeIcon==='1'){data.showHealowInsightsSummary="true"}getDoctorScheduledList(data)})}$scope.paginate=function(){if($scope.selectedChkShowASCvisits){$scope.showASCvisits()}else{prepareParam()}};$scope.rowOptionChangeEvent=function(){$scope.currentPage=1;setAutoItemsPerPageReturnsPromise($scope.autoPaginationWrapperId,$scope.rowsPerPageDropdownId,$scope.rowOption.value,$scope.currentPage).then(function(results){$scope.rowOption.value=results;officeVisitService.saveUserProfile(generateSaveUserProfileXML("DefaultOfficevisitMaxCount",$scope.rowOption.value),$scope.trUserId).success(function(){if($scope.selectedChkShowASCvisits){$scope.showASCvisits()}else{prepareParam()}})})};var generateSaveUserProfileXML=function(tagName,favouriteValue){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('UserProfile');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,tagName,favouriteValue,'xsi:type','xsd:string');xw.writeEndElement();endSoapPacket(xw);return xw.flush()};$scope.setCheckInTime=function(enctrId){var autoCheckIn=getItemKeyValue("AutoCheckInForOV");if(autoCheckIn.toLowerCase()==="yes"){var currTime=new Date;var strTime=currTime.format("HH:MM:ss");var strDate=currTime.format("yyyy-mm-dd");try{var param={encId:enctrId,timeIn:strTime,dateIn:strDate};officeVisitService.setCheckInTime(param)}catch(e){ecwAlert(e.message,"ECW Alert")}}};$scope.viewWorksheet=function(){if($scope.validateSingleEncSelection()){var officeVisit=$scope.selectedEncouterObj;$scope.PNOptionsPopUpURL="";$ocLazyLoad.load({name:"worksheet",cache:false,files:['/mobiledoc/jsp/webemr/worksheet/worksheetController.js']}).then(function(){var url="/mobiledoc/jsp/webemr/worksheet/worksheetContainer.jsp?encounterId="+officeVisit.encounterId+"&patientId="+officeVisit.patientId;$scope.PNOptionsPopUpURL=makeURL(url)},function(e){console.log(e)})}};$scope.viewProgressNote=function(){if($scope.validateSingleEncSelection()){updatePatientSearchHistory($scope.selectedEncouterObj.patientId,$scope.selectedEncouterObj.name);$scope.setCheckInTime($scope.selectedEncouterObj.encounterId);if(nuclearTestVisitFlg){$scope.viewWorksheet()}else{doChecksForPNWithData($scope.encounterObj.encounterId,$scope.encounterObj.patientId,$http,'ovLoader',EncDetailsService.getEncDetailsByEncId($scope.encounterObj.encounterId))}}};$scope.openProgressNote=function(officeVisit){var encntrData={encounterId:officeVisit.encounterId,addPtDetails:true};officeVisitService.getValuesForEnctrId(encntrData).success(function(result){var x2js=new X2JS;var jsonData=x2js.xml_str2json(result);$scope.encounterObj=jsonData.Envelope.Body["return"].encounter;encObj=$scope.encounterObj;updatePatientSearchHistory(officeVisit.patientId,officeVisit.name);$scope.setCheckInTime(officeVisit.encounterId);if($scope.encounterObj.dentalVisitFlag==="1"){viewDentalChart(officeVisit.encounterId,officeVisit.patientId)}EncDetailsService.setEncDetails(result);doChecksForPNWithData(officeVisit.encounterId,officeVisit.patientId,$http,'ovLoader',EncDetailsService.getEncDetailsByEncId(officeVisit.encounterId))})};function doChecksForPNWithData(encId,ptId,$http,loaderId,encounterObj){processSecurityCheck(encounterObj,encId,ptId,$http,loaderId)}function viewDentalChart(encId,patientId){var appPath=getItemKeyValue("DentalEMRAppPath");if(!appPath){ecwAlert("The Dental application path has not been configured. Please contact your administrator.","ECW Alert")}}function setPFLSettings(){$scope.previewList={'print':[],'fax':[],'lock':[]};var stylesArray=getPFLSettings();strPrintDefaultStyle=defineDefaultStyle(stylesArray['print'].strMyDefaultId);strLockDefaultStyle=defineDefaultStyle(stylesArray['lock'].strMyDefaultId);strFaxDefaultStyle=defineDefaultStyle(stylesArray['fax'].strMyDefaultId);for(var key in stylesArray){$scope.previewList[key]=getAllowedList(stylesArray[key])}}$scope.lockProgressNotes=function(lockStyle){var futureEncList=[];var completeUnLockEncList=[];var cptEncList=[];var lockEncList=[];var lockEncDataList=[];var checkedEncCounter=0;var strLockEncList="";var bhTimerRunningEncList=[];if($scope.filteredOfficeVisitList.length>0){if(!lockStyle||lockStyle===''){lockStyle=strLockDefaultStyle}if(!chartLock){ecwAlert("Permission denied.","ECW Alert");return}for(var offIndex in $scope.filteredOfficeVisitList){var vstObj=$scope.filteredOfficeVisitList[offIndex];if(vstObj.offVisitRowChecked){checkedEncCounter++;var date=vstObj.encDate.split("-");var encDate=date[1]+"/"+date[2]+"/"+date[0];var encounterTime=$scope.convert24HourToAMPM(vstObj.time);var encMoment=moment(encDate+""+vstObj.time,"MM/DD/YYYY hh:mm:ss");var nowMoment=moment();var daysDiff=encMoment.diff(nowMoment,'days');var isFutureEnc=false;if(daysDiff>0){isFutureEnc=true}else if(daysDiff==0){var mintsDiff=encMoment.diff(nowMoment,'minutes');if(mintsDiff>0){isFutureEnc=true}}if(isFutureEnc){var time=encounterTime.split(':');var ndate=encDate.split('/');var encDateNew=new Date(ndate[2],ndate[0]-1,ndate[1],time[0],time[1],time[2],0);var futureEncData={"encounterId":vstObj.encounterId,"encDateTime":encDate+" "+encounterTime+" "};futureEncList.push(futureEncData)}if(vstObj.notesStatus!="2"){var cmpltUnlockData={"encounterId":vstObj.encounterId,"encDateTime":encDate+" "+encounterTime+" "};completeUnLockEncList.push(cmpltUnlockData)}if(!checkCptAndEndM(vstObj.encounterId)){var cptEMData={"encounterId":vstObj.encounterId,"encDateTime":encDate+" "+encounterTime+" "};cptEncList.push(cptEMData)}if(vstObj.encLock!="1"){var encData={"patientName":vstObj.name,"encounterId":vstObj.encounterId,"encDateTime":encDate+" "+encounterTime+" "};lockEncDataList.push(encData);lockEncList.push(vstObj.encounterId)}if(vstObj.isBhTimerRunning==="true"){bhTimerRunningEncList.push(vstObj)}}}if(checkedEncCounter==0){ecwAlert("Please select an Encounter","ECW Alert");return}if(bhTimerRunningEncList.length>0){let patientNames="";bhTimerRunningEncList.forEach(function(bhEncItem){patientNames+=bhEncItem.name+"<br>";let index=lockEncList.indexOf(bhEncItem.encounterId);if(index>-1){lockEncList.splice(index,1)}lockEncDataList=lockEncDataList.filter(function(element){return element.encounterId!==bhEncItem.encounterId});completeUnLockEncList=completeUnLockEncList.filter(function(element){return element.encounterId!==bhEncItem.encounterId})});$scope.bh_TimerPopupMessage="Time tracker timer is still running for the following patient(s),"+patientNames+" Please stop the timer before locking the progress note.";$("#bhStopTimePopup").show()}$scope.filterGroupApptFromEncounterList(lockEncList,lockEncDataList).then(function(){var isConcurEnabled=getItemKeyValue("EnableConcurLock").toLowerCase();if(isConcurEnabled==="yes"){strLockEncList=lockEncList.join(",");officeVisitService.getEncountersLockAcquired(strLockEncList).success(function(data){validateConcurLock(data,lockEncList,lockEncDataList);if(lockEncList.length>0){$scope.lockProgressNotes1(lockStyle,futureEncList,lockEncList,completeUnLockEncList,cptEncList)}})}else{$scope.lockProgressNotes1(lockStyle,futureEncList,lockEncList,completeUnLockEncList,cptEncList)}})}var validateConcurLock=function(data,lockEncList,lockEncDataList){var concurLockedEncList=[];var alertList=[];if(data){data=data.trim()}var x2js=new X2JS;var jsonData=x2js.xml_str2json(data);if(jsonData&&jsonData.Envelope&&jsonData.Envelope.Body&&jsonData.Envelope.Body["return"]&&jsonData.Envelope.Body["return"].status==='success'){if(jsonData.Envelope.Body["return"].EncountersLockAcquired){var str=jsonData.Envelope.Body["return"].EncountersLockAcquired;concurLockedEncList=str.split(",")}}if(concurLockedEncList.length>0){for(var index in concurLockedEncList){var encId=concurLockedEncList[index];var indexOfLockEnc=lockEncList.indexOf(encId);if(indexOfLockEnc>-1){var enc=lockEncDataList[indexOfLockEnc];alertList.push('"'+enc.patientName+", "+enc.encDateTime+'"');lockEncList.splice(indexOfLockEnc,1);lockEncDataList.splice(indexOfLockEnc,1)}}var alertEncDTList=alertList.join(",");ecwAlert("The Encounter(s) "+alertEncDTList+" are currently being accessed by other user(s) and will not be locked.")}}};$scope.lockProgressNotes1=function(lockStyle,futureEncList,lockEncList,completeUnLockEncList,cptEncList){if(futureEncList&&futureEncList.length>0){var alertList=[];var ftrEncList=[];for(var index in futureEncList){if(futureEncList[index].encDateTime)alertList.push(futureEncList[index].encDateTime);if(futureEncList[index].encounterId)ftrEncList.push(futureEncList[index].encounterId)}var alertEncDTList=alertList.join(",");ecwConfirm("There are some Encounter(s) scheduled on future date: "+alertEncDTList+". Are"+" you sure you want to lock it?","eClinicalWorks",function(){lockProgressNote2(completeUnLockEncList,lockEncList,cptEncList,lockStyle)},function(){lockEncList=lockEncList.filter(function(enc){return ftrEncList.indexOf(enc)===-1});lockProgressNote2(completeUnLockEncList,lockEncList,cptEncList,lockStyle)})}else{lockProgressNote2(completeUnLockEncList,lockEncList,cptEncList,lockStyle)}};function lockProgressNote2(completeUnLockEncList,lockEncList,cptEncList,lockStyle){var cmplEncList=[];var selectedEnc=$scope.selectedEncounters.length;if(completeUnLockEncList&&completeUnLockEncList.length>0){var alertList=[];for(var index in completeUnLockEncList){if(completeUnLockEncList[index].encDateTime&&lockEncList.indexOf(completeUnLockEncList[index].encounterId)>-1)alertList.push(completeUnLockEncList[index].encDateTime);if(completeUnLockEncList[index].encounterId&&lockEncList.indexOf(completeUnLockEncList[index].encounterId)>-1)cmplEncList.push(completeUnLockEncList[index].encounterId)}if(cmplEncList.length>0){var alertEncDTList=alertList.join(",");ecwAlert("The Encounter(s) "+alertEncDTList+" are not 'completed' and will not be locked.","ECW Alert",function(){$scope.emCodeCheck(lockEncList,selectedEnc,lockStyle,cptEncList,cmplEncList)})}}else{$scope.emCodeCheck(lockEncList,selectedEnc,lockStyle,cptEncList,cmplEncList)}}$scope.emCodeCheck=function(lockEncList,selectedEncCnt,lockStyle,cptEncList,cmplEncList){var emCodeCheckPermission=getItemKeyValue("EnableEMCodeRequiredForPNLock");if(emCodeCheckPermission&&emCodeCheckPermission.toLowerCase()==='yes'&&lockEncList&&lockEncList.length>0){var emcodeJson=addEmcodeOnLockPNService.checkEncountersListCPTExists(lockEncList,"officeVisits");if(emcodeJson!==null&&emcodeJson!==undefined&&!emcodeJson.empty){if(emcodeJson.notAdded.length>0){ecwAlert(emcodeJson.notAdded.length+" out of "+selectedEncCnt+" encounters do not have an E&M code that is required to lock the Progress Notes. Add an E&M code in Billing to lock the Progress Notes","ECW Alert")}if(emcodeJson.added.length>0){if(cmplEncList.length>0){emcodeJson.added=emcodeJson.added.filter(function(enc){return cmplEncList.indexOf(enc)===-1})}filterEncounter(emcodeJson.added,lockStyle)}return}}else{if(cmplEncList.length>0){lockEncList=lockEncList.filter(function(enc){return cmplEncList.indexOf(enc)===-1})}if(cptEncList&&cptEncList.length>0){var alertList=[];var cptAlertEncList=[];for(var index in cptEncList){if(cptEncList[index].encDateTime&&lockEncList.indexOf(cptEncList[index].encounterId)>-1)alertList.push(cptEncList[index].encDateTime);if(cptEncList[index].encounterId&&lockEncList.indexOf(cptEncList[index].encounterId)>-1)cptAlertEncList.push(cptEncList[index].encounterId)}if(cptAlertEncList.length>0){var alertEncDTList=alertList.join(",");ecwConfirm("The Encounter(s) "+alertEncDTList+" are not having CPT or E&M codes associated with it. Are you sure you want to lock it?","eClinicalWorks",function(){filterEncounter(lockEncList,lockStyle)},function(){lockEncList=lockEncList.filter(function(enc){return cptAlertEncList.indexOf(enc)===-1});filterEncounter(lockEncList,lockStyle)})}}else{filterEncounter(lockEncList,lockStyle)}}};function filterEncounter(lockEncList,lockStyle){if(!lockEncList||lockEncList.length<=0){return}if(lockStyle==='LockAndAssign'&&getItemKeyValue("EnableBatchCoSign").toLowerCase()==="yes"){$scope.lockAssignProgressNotes(lockEncList)}for(var index in lockEncList){doLockProcessing(lockEncList[index],lockStyle==='LockAndAssign'?'ModernI':lockStyle)}}var doLockProcessing=function(encounterId,lockStyle){lockEncounter(encounterId,lockStyle,trUserId,$http).success(function(result){if(result)result=result.trim();var x2js=new X2JS;var jsonData=x2js.xml_str2json(result);if(jsonData&&jsonData.Envelope&&jsonData.Envelope.Body&&jsonData.Envelope.Body["return"]&&jsonData.Envelope.Body["return"].status==='success'){if(jsonData.Envelope.Body["return"].LockAcquired==='yes'){ecwAlert('There are section(s) that are currently being accessed by other user(s). Please wait for sometime.')}else{$scope.refreshData()}}else if(jsonData&&jsonData.Envelope&&jsonData.Envelope.Body&&jsonData.Envelope.Body["return"]&&jsonData.Envelope.Body["return"].status){ecwAlert(getLockEncounterValidationMessage(jsonData.Envelope.Body["return"].status))}else{ecwAlert('An error occurred while locking the encounter.')}})};var checkCptAndEndM=function(encId){var val=getItemKeyValue("CPTCheckForLockPN");var result=false;if(val.toLowerCase()==="yes"||val==="1"){var serverUrl='/mobiledoc/jsp/catalog/xml/getEncAddtlBillingData.jsp?Id='+encId;var cptXML=urlGet(serverUrl);var jsonData=x2js.xml_str2json(cptXML);var returnData=[];if(jsonData!=null&&jsonData.Envelope.Body['return'].encounter.billingdata){returnData=jsonData.Envelope.Body['return'].encounter.billingdata.item}if(returnData&&returnData.length>0){result=true}return result}else{return true}};$scope.filterData=function(){if(!$scope.autoRefresh){$scope.currentPage=1;$scope.saveUIDefaultData()}if($scope.selectedChkShowASCvisits==true){$scope.showASCvisits()}else{prepareParam()}};if(fromPageLoad){if(displayDate){$scope.selectedDate=displayDate}$scope.foramtSelectedDate=$.datepicker.formatDate('yy-mm-dd',new Date($scope.selectedDate));if(viewType==="5"){if(displayToDate){$scope.selectedToDate=displayToDate;$scope.formatSelectedToDate=$.datepicker.formatDate('yy-mm-dd',new Date($scope.selectedToDate))}}if($scope.chkShowASCvisits===1){$scope.showASCvisits()}else{if(officeVisitStrXML.length>0)parseXML(officeVisitStrXML)}}$("#providerTab").removeClass("active");$("#allTab").removeClass("active");$("#resourceTab").removeClass("active");if(tabId==="1"){$("#allTab").addClass("active");$scope.dsbldProvider=true}else if(tabId==="2"){$("#resourceTab").addClass("active");$scope.setFacility();$scope.selectedTab=tabId;document.getElementById("resourceLkup").style.display="block";try{$scope.selResourceFilter="Resource";if(uiDefaults.selResourceFilter){$scope.selResourceFilter=uiDefaults.selResourceFilter}}catch(err){$scope.selResourceFilter="Resource"}}else{$("#providerTab").addClass("active")}function parseXML(strXML){var date=new Date;$scope.todaysDate=date.format("yyyy-mm-dd");if($scope.todaysDate===$scope.foramtSelectedDate){$scope.isToday=true}else{$scope.isToday=false}if(!$scope.autoRefresh&&$scope.isEncounterFormOpened!==true){$scope.selectedEncouterObj=undefined}if(!$scope.autoRefresh){$scope.encounterObj=undefined;$scope.selectedEncounters=[];$scope.encounterCheckBox=false;$scope.selectAll=false;$scope.staffPermission=[]}var x2js=new X2JS;var jsonData=x2js.xml_str2json(strXML);$scope.officeVisitList=[];try{$scope.officeVisitList=validateResultArray(jsonData.Envelope.Body["return"].encounters.encounter);$scope.ECW_CHECKIN=getEcwVisitStatusCodeMapping(ECW_VISITSTATUSCODE_MAPPING_CHECKIN);$scope.ECW_CHKOUT=getEcwVisitStatusCodeMapping(ECW_VISITSTATUSCODE_MAPPING_CHKOUT);$scope.ECW_PEN=getEcwVisitStatusCodeMapping(ECW_VISITSTATUSCODE_MAPPING_PENDING);for(var listIndex in $scope.officeVisitList){$scope.officeVisitList[listIndex].offVisitRowChecked=false;if($scope.selectedEncounters&&$scope.selectedEncounters.indexOf($scope.officeVisitList[listIndex].encounterId)>-1){$scope.officeVisitList[listIndex].offVisitRowChecked=true}$scope.officeVisitList[listIndex].viewApptTime=$scope.convert24HourToAMPM($scope.officeVisitList[listIndex].time);$scope.officeVisitList[listIndex].reasonWordBreak=$scope.isWordBreakRequired($scope.officeVisitList[listIndex].reason);if($scope.officeVisitList[listIndex].sex.toLowerCase()=='male'){$scope.officeVisitList[listIndex].viewGender="M"}else if($scope.officeVisitList[listIndex].sex.toLowerCase()=='female'){$scope.officeVisitList[listIndex].viewGender="F"}else if($scope.officeVisitList[listIndex].sex.toLowerCase()=='unknown'){$scope.officeVisitList[listIndex].viewGender="U"}else{$scope.officeVisitList[listIndex].viewGender="-"}if($scope.todaysDate===$scope.foramtSelectedDate){if($scope.officeVisitList[listIndex].arrivedTime==='00:00:00'){$scope.officeVisitList[listIndex].viewArrivalTime="-"}else{$scope.officeVisitList[listIndex].viewArrivalTime=getTimeInFacilityTZ($scope.officeVisitList[listIndex].arrivedTime,$scope.officeVisitList[listIndex].factz_arrTime,$scope.officeVisitList[listIndex].facilityTimeZone)}if($scope.officeVisitList[listIndex].status===$scope.ECW_CHECKIN||$scope.officeVisitList[listIndex].status===$scope.ECW_CHKOUT){$scope.officeVisitList[listIndex].viewDuration=$scope.timeDuration($scope.officeVisitList[listIndex],getTimeInUTC($scope.officeVisitList[listIndex].arrivedTime,$scope.officeVisitList[listIndex].UTCArrTime))}else if($scope.officeVisitList[listIndex].status===$scope.ECW_PEN){$scope.officeVisitList[listIndex].viewDuration=""}else{$scope.officeVisitList[listIndex].viewDuration=""}if($scope.officeVisitList[listIndex].status!=='CHK'&&$scope.officeVisitList[listIndex].stsAfterArr!=='OUT'){$scope.officeVisitList[listIndex].viewRoomNumber=true}else{$scope.officeVisitList[listIndex].viewRoomNumber=false}$scope.officeVisitList[listIndex].viewStatusAftArrCol=true;if($scope.officeVisitList[listIndex].stsAfterArr!='OUT'){if($scope.officeVisitList[listIndex].stsAfterChkIn){$scope.officeVisitList[listIndex].viewStatusAftArr=$scope.officeVisitList[listIndex].stsAfterChkIn}else{$scope.officeVisitList[listIndex].viewStatusAftArr=$scope.officeVisitList[listIndex].stsAfterArr}}if($scope.officeVisitList[listIndex].stsAfterArr=='OUT'&&($scope.officeVisitList[listIndex].status=='PEN'||$scope.officeVisitList[listIndex].status=='ARR')){$scope.officeVisitList[listIndex].viewStatusAftArr="OUT"}if($scope.officeVisitList[listIndex].status=='CHK'){$scope.officeVisitList[listIndex].viewStatusAftArr=""}if($scope.officeVisitList[listIndex].status===$scope.ECW_CHECKIN){$scope.officeVisitList[listIndex].viewCycleTime=$scope.officeVisitList[listIndex].statusLogTime?$scope.timeDuration($scope.officeVisitList[listIndex],getTimeInUTC($scope.officeVisitList[listIndex].statusLogTime,$scope.officeVisitList[listIndex].UTClogDate)):''}else if($scope.officeVisitList[listIndex].status===$scope.ECW_PEN){$scope.officeVisitList[listIndex].viewCycleTime=""}}else{$scope.officeVisitList[listIndex].viewArrivalTime="-";$scope.officeVisitList[listIndex].viewDuration="-";$scope.officeVisitList[listIndex].viewRoomNumber=false;$scope.officeVisitList[listIndex].viewStatusAftArr="-";$scope.officeVisitList[listIndex].viewStatusAftArrCol=false;$scope.officeVisitList[listIndex].viewCycleTime="-"}if($scope.officeVisitList[listIndex].notesStatus=="1"){$scope.officeVisitList[listIndex].viewNotesUrl="/mobiledoc/jsp/webemr/img/vital.gif"}else if($scope.officeVisitList[listIndex].notesStatus=="2"){$scope.officeVisitList[listIndex].viewNotesUrl="/mobiledoc/jsp/webemr/img/done.gif"}else{$scope.officeVisitList[listIndex].viewNotesUrl=" "}$scope.officeVisitList[listIndex]['ID']=$scope.officeVisitList[listIndex]['patientId']}$scope.filteredOfficeVisitList=$scope.officeVisitList;$scope.totalEncounter=jsonData.Envelope.Body["return"].RecordCount;$scope.autoRefresh=false}catch(e){console.log(e);$scope.filteredOfficeVisitList=[];$scope.totalEncounter=0;$scope.autoRefresh=false}}function getDoctorScheduledList(data){officeVisitService.getDoctorsScheduleList(data).success(function(result){parseXML(result);$('#this-tableOV').floatThead('reflow')})}$scope.resetOfficeVisieRowSelection=function(){$scope.selectedEncounters=[];for(var offIndex in $scope.filteredOfficeVisitList){$scope.filteredOfficeVisitList[offIndex].offVisitRowChecked=false}};$scope.OfficeVisieRowAllSelection=function(){for(var offIndex in $scope.filteredOfficeVisitList){$scope.selectedEncounters.push($scope.filteredOfficeVisitList[offIndex].encounterId);$scope.filteredOfficeVisitList[offIndex].offVisitRowChecked=true;$scope.patientIdlist.push($scope.filteredOfficeVisitList[offIndex].patientId)}};$scope.hideSidePanel=function(){var El=angular.element('.sidePanel');var elButton=angular.element('.toogle-btn .icon-collapse-right-panel');var width='-'+El.width()+'px';El.animate({right:width},800);elButton.css({transform:"rotate(180deg)"})};$(document).ready(function(){$('.main-wrap').on("click",fnHideSidePanel)});function fnHideSidePanel(e){var $target=$(e.target);if(!$target.closest('.sidePanel').length&&!$target.closest('.patientprofile').length&&$(".sidePanel[style*='right: 0px;']").length>0){$scope.closeDetailData();$scope.hideSidePanel()}}$scope.selectUnSelectAll=function(){$scope.resetOfficeVisieRowSelection();$scope.patientIdlist=[];$scope.hideSidePanel();if($scope.selectAll){$scope.selectAll=false;$scope.encounterObj=undefined;$scope.selectedEncouterObj=undefined}else{$scope.selectAll=true;$scope.OfficeVisieRowAllSelection()}};$scope.selectOfficeVisitRow=function(visitObj){var encounterId=visitObj.encounterId;var sChkStForOffVisScreen=$('#'+encounterId).is(':checked');if(sChkStForOffVisScreen){$('#'+encounterId).prop('checked',false)}else{$('#'+encounterId).prop('checked',true)}$scope.selectEncounter(visitObj)};$scope.copyTVCode=function(code,encid,name,age,encdate,enctime){name=name.replace(/-/g,',');var m=moment.utc(encdate,'YYYY-MM-DD');encdate=m.format('LL');var healowurl=getItemKeyValue("healowserverprotocol")+getItemKeyValue("healowservername");let isTvGenerationLinkEnabled=getItemKeyValue("tvgeneratelinkonappt").toUpperCase()==="YES";var content='healowTV link for '+name+','+age+' for appointment on '+encdate+' at '+enctime+" - ";var copiedContent="";if(isTvGenerationLinkEnabled){copiedContent=content+healowurl+'/apps/tv/custom/'+code}else{copiedContent=content+healowurl+'/apps/tv/'+code}const el=document.createElement('textarea');el.value=copiedContent;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);var elem='showcopycode_'+encid;$('#'+elem).delay(10).fadeIn(400);$('#'+elem).delay(1500).fadeOut(400)};$scope.sendTVCode=function(code,encid,patientId,name,age,encdate,enctime){name=name.replace(/-/g,',');var m=moment.utc(encdate,'YYYY-MM-DD');encdate=m.format('LL');var healowurl=getItemKeyValue("healowserverprotocol")+getItemKeyValue("healowservername");let isTvGenerationLinkEnabled=getItemKeyValue("tvgeneratelinkonappt").toUpperCase()==="YES";var content='healowTV link for '+name+','+age+' for appointment on '+encdate+' at '+enctime+" - ";var copiedContent="";if(isTvGenerationLinkEnabled){copiedContent=content+healowurl+'/apps/tv/custom/'+code}else{copiedContent=content+healowurl+'/apps/tv/'+code}const el=document.createElement('textarea');el.value=copiedContent;document.body.appendChild(el);var url=makeURL("/mobiledoc/jsp/webemr/singlesend/sendTelevisitCode.jsp");var data=$.param({'encounterId':encid,'textmessage':copiedContent});el.select();document.execCommand('copy');document.body.removeChild(el);$scope.sendTelevisitCode(encid,patientId,copiedContent)};$scope.sendTelevisitCode=function(encid,patientId,textmessage){$scope.confirmTeleVisitMessageSend(encid,patientId).then(function(response){if(response){var defaultErroMessage="Fail to send Televisit Invite. Please try again or contact eClinicalWorks support.";var promise=officeVisitService.sendTelevisitMessage(encid,textmessage);promise.success(function(parsedData){if(parsedData){if(parsedData.Status==="1"){ecwAlert("Televisit Invite sent.","eClinicalWorks");var elem='showcopyandsendcode_'+encid;$('#'+elem).delay(10).fadeIn(400);$('#'+elem).delay(1500).fadeOut(400)}else{ecwAlert(parsedData.Message,"eClinicalWorks");var elem='showfailtosendcode_'+encid;$('#'+elem).delay(10).fadeIn(400);$('#'+elem).delay(1500).fadeOut(400)}}else{ecwAlert(defaultErroMessage,"eClinicalWorks")}}).error(function(error){ecwAlert(defaultErroMessage,"eClinicalWorks")})}},function(err){ecwAlert(err,"eClinicalWorks")})};$scope.isPatientTextEnable=function(patientId){return $.Deferred(function(dfd){if(patientId){officeVisitService.getPatientCommunicationSettings(patientId).success(function(data){if(data&&data.length>4){try{var contactType="";if(data[2].textenabled!=='1'){var contactInfo=data[3];if(contactInfo.umobileno.length>9){contactType='cell'}else if(contactInfo.upphone.length>9){contactType='home'}else if(data[2].employerphone.length>9){contactType='work'}}if(data[2].textenabled!=='1'&&contactType==""){dfd.reject("Sorry, no phone number found on patient record. Message cannot be sent.")}dfd.resolve({voiceenabled:data[2].voiceenabled,textenabled:data[2].textenabled==='1',contactType:contactType})}catch(e){dfd.reject("Fail to fetch patient communication details. Please try again or conctact eClinicalWorks support.")}}else{dfd.reject("Fail to fetch patient communication details. Please try again or conctact eClinicalWorks support.")}}).error(function(err){dfd.reject("Fail to fetch patient communication details. Please try again or conctact eClinicalWorks support.")})}else{dfd.reject("Fail to fetch patient communication details. Invalid patient details.")}})};$scope.confirmTeleVisitMessageSend=function(encounterId,patientId){return $.Deferred(function(dfd){$scope.isPatientTextEnable(patientId).then(function(data){if(data.textenabled){dfd.resolve(true)}else{ecwConfirm("Would you like to enable this patient and send the message?","Patient Not Enabled For Text",function(){officeVisitService.setPatientTextEnable(patientId,data.contactType,data.voiceenabled).success(function(parsedData){if(parsedData){if(parsedData.trim().toLowerCase()==="success"){dfd.resolve(true)}else{dfd.reject("Error while enabling patient for text/sms. Please try again or contact eClinicalWorks support.")}}else{dfd.reject("Error while enabling patient for text/sms. Please try again or contact eClinicalWorks support.")}}).error(function(error){dfd.reject("Error while enabling patient for text/sms. Please try again or contact eClinicalWorks support.")})},function(){dfd.resolve(false)})}},function(err){dfd.reject(err)})})};$scope.hideHealowCodeBox=function(){$("span[id^='healowCodePopup_']").hide()};$scope.getTVCode=function(visitObj){var encounterId=visitObj.encounterId;var tvPtId=visitObj.patientId;$scope.hideHealowCodeBox();var TVCode="";var straction='getTVCode';var param={action:straction,encId:encounterId};officeVisitService.getTVCode(param).success(function(result){TVCode=result.trim();var codeDisp=TVCode.substr(0,3)+"-"+TVCode.substr(3,3)+"-"+TVCode.substr(6,3)+"-"+TVCode.substr(9);var name=visitObj.name.replace(/,/g,'-');var data="<span style='font-family: sans-serif;'>healowTV Code : </span> <span style='font-size: 15px;font-family:sans-serif;'>"+codeDisp+"</span><span id=\"showcopycode_"+encounterId+"\" class=\" ml5 label label-warning\" style=\"display:none;\">Copied</span>";data=data+"</span><span id=\"showcopyandsendcode_"+encounterId+"\" class=\" ml5 label label-warning\" style=\"display:none;\">Sent</span>";data=data+"</span><span id=\"showfailtosendcode_"+encounterId+"\" class=\" ml5 label label-warning\" style=\"display:none;\">Failed</span>";var htmltag="<ul  class='dropdown-menu pull-left gray-tiped show' style='width:385px;height:40px;margin-top:7px'>"+"<li>"+data+"<i id='televisit-copycode' class='glyphicon glyphicon-remove-circle pull-right ml5' ng-click='hideHealowCodeBox();'></i>"+"<i id='televisit-copycode' title='SMS healowTV visit code to the patient' class='icon chatic glyphicon-file pull-right ml5' ng-click=\"sendTVCode('"+codeDisp+"',"+encounterId+",'"+tvPtId+"','"+name+"','"+visitObj.age+"','"+visitObj.encDate+"','"+visitObj.viewApptTime+"');\"></i>"+"<i id='televisit-copycode' title='Click to copy healowTV visit code' class='glyphicon glyphicon-file pull-right' ng-click=\"copyTVCode('"+codeDisp+"',"+encounterId+",'"+name+"','"+visitObj.age+"','"+visitObj.encDate+"','"+visitObj.viewApptTime+"');\"></i>"+"</li>"+"</ul>";var compiledHtmlTag=$compile(htmltag)($scope);$('#'+'healowCodePopup_'+encounterId).toggle();$('#'+'healowCodePopup_'+encounterId).html(compiledHtmlTag)})};$scope.selectEncounter=function(visitObj){var encounterId=visitObj.encounterId;$scope.hideSidePanel();if(visitObj.offVisitRowChecked){visitObj.offVisitRowChecked=false;var index=$scope.selectedEncounters.indexOf(encounterId);if(index>-1){$scope.selectAll=false;$scope.selectedEncounters.splice(index,1);var indexOfItem=$scope.patientIdlist.indexOf(visitObj.patientId);if(indexOfItem>-1){$scope.patientIdlist.splice(indexOfItem,1)}}$scope.encounterObj=undefined;$scope.selectedEncouterObj=undefined}else{visitObj.offVisitRowChecked=true;$scope.selectedEncounters.push(encounterId);$scope.patientIdlist.push(visitObj.patientId);if(!$scope.encounterObj||$scope.encounterObj.encounterId!==encounterId){initializeEncounterObject(encounterId)}$scope.selectedEncouterObj=visitObj}};var initializeEncounterObject=function(encounterId){var encntrData={encounterId:encounterId,addPtDetails:true};officeVisitService.getValuesForEnctrId(encntrData).success(function(result){try{var x2js=new X2JS;var jsonData=x2js.xml_str2json(result.trim());$scope.encounterObj=jsonData.Envelope.Body["return"].encounter;EncDetailsService.setEncDetails(result);encObj=EncDetailsService.getEncDetailsByEncId(encounterId);if($scope.encounterObj.NuclearTestVisitFlag==="1"&&$("#"+$scope.encounterObj.encounterId).is(":checked")){nuclearTestVisitFlg=true;$scope.viewPNName="View Worksheet"}else{nuclearTestVisitFlg=false;$scope.viewPNName="View Progress Notes"}}catch(e){ecwAlert(e.message,"ECW Alert");$scope.encounterObj={}}})};$scope.lockAssignProgressNotes=function(encounterId){$scope.PNOptionsPopUpURL="";try{var x2js=new X2JS;var popup={};popup.name='assignpn';popup.files=['/mobiledoc/jsp/webemr/jellybean/sbeen/lockAndAssignController.js'];popup.url='/mobiledoc/jsp/webemr/jellybean/sbeen/lockAndAssign.jsp?encounterId='+encounterId;$ocLazyLoad.load({name:popup.name,files:popup.files}).then(function(){$scope.frmOfficeVisit=true;url=makeURL(popup.url);$scope.PNOptionsPopUpURL=url},function(e){console.log(e)})}catch(e){ecwAlert(e.name+": lockAssignProgressNotes : An error occurred at server while getting the encounters list.","ECW Alert")}};$scope.openChangeAssignPN=function(obj){$scope.PNOptionsPopUpURL="";var encntrData={encounterId:obj.encounterId};officeVisitService.getValuesForEnctrId(encntrData).success(function(result){try{var x2js=new X2JS;var jsonData=x2js.xml_str2json(result);$scope.encounterObj=jsonData.Envelope.Body["return"].encounter;EncDetailsService.setEncDetails(result);encObj=EncDetailsService.getEncDetailsByEncId(obj.encounterId);var popup={};var EnableReview4ConvenientCare=getItemKeyValue("EnableReview4ConvenientCare");if(EnableReview4ConvenientCare&&EnableReview4ConvenientCare.toLowerCase()==='yes'){popup.name='assignPNCCMdl';popup.files=['/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/assignPNCCController.js'];popup.url='/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/assignPNCC.jsp?encounterId='+obj.encounterId}else{popup.name='assignpn';popup.files=['/mobiledoc/jsp/webemr/jellybean/sbeen/assignPNController.js'];popup.url='/mobiledoc/jsp/webemr/jellybean/sbeen/assignPN.jsp?encounterId='+obj.encounterId}$ocLazyLoad.load({name:popup.name,files:popup.files}).then(function(){$scope.frmOfficeVisit=true;url=makeURL(popup.url);$scope.PNOptionsPopUpURL=url},function(e){console.log(e)})}catch(e){ecwAlert(e.name+": An error occurred at server while getting the encounters list.","ECW Alert")}})};$scope.patientIdentifiers=undefined;$scope.checkInOutEncounter=function(){$scope.localTimeZone=$scope.getLocalTimeZoneId();$scope.checkInFlag=false;$scope.checkOutFlag=false;$scope.isEncounterFormOpened=true;if($scope.validateSingleEncSelection()){$scope.patientIdentifiers=$scope.selectedEncouterObj.patientId;$scope.name=$scope.selectedEncouterObj.name;$scope.sex=$scope.selectedEncouterObj.sex;$scope.dob=$scope.selectedEncouterObj.dob;$scope.age=$scope.selectedEncouterObj.age;$scope.arrivedTime=$scope.selectedEncouterObj.arrivedTime;$scope.reason=$scope.selectedEncouterObj.reason;$scope.timeIn=$scope.selectedEncouterObj.timeIn==="00:00:00"?"":$scope.convert24HourToAMPM($scope.selectedEncouterObj.timeIn);$scope.timeOut=$scope.selectedEncouterObj.timeOut==="00:00:00"?"":$scope.convert24HourToAMPM($scope.selectedEncouterObj.timeOut);$scope.roomNo=$scope.selectedEncouterObj.room;$scope.status=$scope.selectedEncouterObj.stsAfterChkIn;$scope.appointmentTime=$scope.convert24HourToAMPM($scope.selectedEncouterObj.time);$scope.appointmentFacilityTimeZone=$scope.selectedEncouterObj.facilityTimeZone;$scope.timeInWF=$scope.selectedEncouterObj.timeIn;$scope.timeOutWF=$scope.selectedEncouterObj.timeOut;if($scope.selectedEncouterObj.stsAfterArr==='IN'){document.getElementById("checkIn").checked=true}else if($scope.selectedEncouterObj.stsAfterArr==='OUT'){document.getElementById("checkOut").checked=true}$scope.checkInFlag=$('#checkIn').is(':checked');$scope.checkOutFlag=$('#checkOut').is(':checked');$("#checkInOutModal").modal({backdrop:"static",keyboard:false});$scope.totalTimeAfterArrival=$scope.totalTimeAfterArrivalAPI($scope.selectedEncouterObj);$scope.totalTimeAfterCheckIn=$scope.totalTimeAfterCheckInAPI($scope.selectedEncouterObj);$scope.dirtyCloseFlag=false}};$scope.totalTimeIn='';$scope.startTimeCalculation=function(inTime,outTime){var currentDate=new Date;if(outTime==="00:00:00"){outTime=currentDate.format("HH:MM:ss")}var timeIn=inTime.split(":");var date=$scope.foramtSelectedDate.split("-");var timeStart=new Date(date[0],date[1]-1,date[2],timeIn[0],timeIn[1],0);return timeStart.getTime()};$scope.totalTimeAfterArrivalAPI=function(ovObj){var totalTimeIn="";if(!ovObj)return totalTimeIn;if(ovObj.arrivedTime!=="00:00:00"){var inTime=getTimeInUTC(ovObj.arrivedTime,ovObj.UTCArrTime);var outTime="";if(ovObj.timeOut!=="00:00:00"){outTime=getTimeInUTC(ovObj.timeOut,ovObj.UTCTimeOut)}else if(ovObj.depTime!=="00:00:00"){outTime=getTimeInUTC(ovObj.depTime,ovObj.UTCDepTime)}else{outTime=moment($scope.getCurrentDate()).utc().format("HH:mm:ss")}totalTimeIn=timeInCalculation(inTime,outTime)}return totalTimeIn};$scope.totalTimeAfterCheckInAPI=function(ovObj){var totalTimeIn="";if(!ovObj)return totalTimeIn;if(ovObj.timeIn!=="00:00:00"){var inTime=getTimeInUTC(ovObj.timeIn,ovObj.UTCTimeIn);var outTime="";if(ovObj.timeOut!=="00:00:00"){outTime=getTimeInUTC(ovObj.timeOut,ovObj.UTCTimeOut)}else if(ovObj.depTime!=="00:00:00"){outTime=getTimeInUTC(ovObj.depTime,ovObj.UTCDepTime)}else{outTime=moment($scope.getCurrentDate()).utc().format("HH:mm:ss")}totalTimeIn=timeInCalculation(inTime,outTime)}return totalTimeIn};function timeInCalculation(inTime,outTime){var currDate=$scope.getCurrentDate();if(inTime===''||inTime===undefined){inTime=currDate.format("HH:MM:ss")}else if(inTime==="00:00:00"){return totalTimeIn=""}if(outTime===''||outTime==="00:00:00"||outTime===undefined){outTime=currDate.format("HH:MM:ss")}var startTime=inTime.split(":");var stopTime=outTime.split(":");var date=$scope.foramtSelectedDate.split("-");var timeStart=new Date(date[0],date[1]-1,date[2],startTime[0],startTime[1],0);var timeEnd=new Date(date[0],date[1]-1,date[2],stopTime[0],stopTime[1],0);var diff=timeEnd.getTime()-timeStart.getTime();if(diff<0)return totalTimeIn="";var hours=Math.floor(diff/1e3/60/60);diff-=hours*1e3*60*60;var minutes=Math.floor(diff/1e3/60);var totalTimeIn=(hours>0?(hours<9?"0":"")+hours+" h, ":"")+((minutes<9?"0":"")+minutes+' m');return totalTimeIn}$scope.createCheckInOutTime=function(checkInType){if(checkInType==='checkIn'){if($scope.checkInFlag){$scope.checkInFlag=false}else{$scope.checkInFlag=true}}else if(checkInType==='checkOut'){if($scope.checkOutFlag){$scope.checkOutFlag=false}else{$scope.checkOutFlag=true}}if($scope.checkInFlag||$scope.checkOutFlag){var currentDate=$scope.getCurrentDate();var hour=currentDate.getHours();var minute=currentDate.getMinutes();var amPm=hour>=12?'PM':'AM';hour=hour>12?hour-12:hour;hour=hour===0?'12':hour;hour=hour<9?'0'+hour:hour;minute=minute<9?'0'+minute:minute;if(checkInType==='checkIn'){if(!$scope.timeIn)$scope.timeIn=hour+":"+minute+" "+amPm;$scope.timeOut='';$scope.checkOutFlag=false}else{$scope.checkInFlag=false;if(!$scope.timeOut)$scope.timeOut=hour+":"+minute+" "+amPm}}};function validateRoom(encounterId){var screenName="web_OVCheckIn";var parentId="web_checkin";if(encounterId){parentId="web_checkin_grid"+encounterId}return dataTruncUtilityService.getTextFieldWidthsFromTable(screenName,parentId,"bluetheme")}$scope.saveCheckInOutStatus=function(){$scope.timeInUTC="";$scope.timeOutUTC="";if(validateCheckInCheckOutTime($scope.timeIn,$scope.timeOut)&&validateRoom()){var notesLoginId=$scope.trUserId;var logDate=$scope.getCurrentDate();logDate=logDate.getFullYear()+"-"+(logDate.getMonth()+1).toString()+"-"+logDate.getDate()+" "+logDate.getHours()+":"+logDate.getMinutes()+":"+logDate.getSeconds();var userId=$scope.trUserId;var checkOutArray=[];$scope.timeInUTC=$scope.timeIn===""?"":moment($scope.foramtSelectedDate+" "+$scope.timeIn).utc().format('YYYY-MM-DD HH:mm:ss');$scope.timeOutUTC=$scope.timeOut===""?"":moment($scope.foramtSelectedDate+" "+$scope.timeOut).utc().format('YYYY-MM-DD HH:mm:ss');checkOutArray.push(new prepareCheckInCheckOut($scope.roomNo,$scope.timeIn,$scope.timeOut,$scope.foramtSelectedDate,notesLoginId,$scope.status,$scope.statusName,logDate,userId));var formData=setCheckInCheckOutValue(checkOutArray);var chkOutFlg=$('#checkOut').is(':checked');var chkInFlg=$('#checkIn').is(':checked');var checkInStatus=chkOutFlg===true?'CheckOut':chkInFlg===true?'CheckIn':'';var data={FormData:formData,status:checkInStatus};officeVisitService.updateEncData(data,$scope.selectedEncouterObj.encounterId).success(function(result){var doctorIds="";angular.forEach($scope.providerForFilter.providerList,function(provider,$index){doctorIds+=provider.Id;if($index!==$scope.providerForFilter.providerList.length-1)doctorIds+=", "});$scope.doctorId=$scope.selectedTab===1?0:doctorIds===""?$scope.trUserId:doctorIds;prepareParam()});if(chkOutFlg){$scope.selectedEncouterObj.timeOut=convertAMPMto24Hour($scope.timeOut);$scope.selectedEncouterObj.stsAfterArr='OUT'}else if(chkInFlg){$scope.selectedEncouterObj.timeIn=convertAMPMto24Hour($scope.timeIn);$scope.selectedEncouterObj.room=$scope.roomNo;$scope.selectedEncouterObj.stsAfterChkIn=$scope.status;$scope.selectedEncouterObj.stsAfterArr='IN'}$scope.isEncounterFormOpened=false;$("#checkInOutModal").modal('hide');$scope.checkOutFlag=false;$scope.checkInFlag=false}};$scope.cancelCheckInOutStatus=function(){$scope.isEncounterFormOpened=false;$scope.checkOutFlag=false;$scope.checkInFlag=false;$("#checkInOutModal").modal('hide')};$('#checkInOutModal').on('change','input',function(){$scope.$apply(function(){$scope.dirtyCloseFlag=true})});function preFormatCheckInCheckOutTime(inOutTime){try{var inoutTimeArray=inOutTime.split(" ");inoutTimeArray[1]=inoutTimeArray[1].toUpperCase();var inoutFirstHalfArray=inoutTimeArray[0].split(":");if(inoutFirstHalfArray[0].length==1){inoutFirstHalfArray[0]="0"+inoutFirstHalfArray[0]}if(inoutFirstHalfArray[1].length==1){inoutFirstHalfArray[1]="0"+inoutFirstHalfArray[1]}inoutTimeArray[0]=inoutFirstHalfArray.join(":");inOutTime=inoutTimeArray.join(" ")}catch(Err){}return inOutTime}function validateCheckInCheckOutTime(checkIn,checkOut){checkIn=preFormatCheckInCheckOutTime(checkIn);checkOut=preFormatCheckInCheckOutTime(checkOut);let validHoursClock=12;let checkInHours;let checkOutHours;$scope.timeIn=checkIn;$scope.timeOut=checkOut;var isValidTime=false;var timeInOutPattern=/[0-9]{2}:[0-9]{2} (AM|PM)/;if(checkIn){checkInHours=parseInt(checkIn.substring(0,2),10);if(checkInHours>validHoursClock){ecwAlert("Please enter valid check-in time.","ECW Alert");return false}}if(checkOut){checkOutHours=parseInt(checkOut.substring(0,2),10);if(checkOutHours>validHoursClock){ecwAlert("Please enter valid check-out time.","ECW Alert");return false}}if(checkIn&&!timeInOutPattern.test(checkIn)){$scope.timeIn=checkIn='';ecwAlert("Please enter valid check-in time.","ECW Alert");return false}if(checkOut&&!timeInOutPattern.test(checkOut)){$scope.timeOut=checkOut='';ecwAlert("Please enter valid check-out time.","ECW Alert");return false}if(checkIn&&checkOut){if(checkIn!=='00:00'){var date=$scope.foramtSelectedDate.split("-");var timeIn=convertAMPMto24Hour(checkIn).split(":");var timeOut=convertAMPMto24Hour(checkOut).split(":");var timeInDate=new Date(date[0],date[1],date[2],timeIn[0],timeIn[1],timeIn[2],0);var timeOutDate=new Date(date[0],date[1],date[2],timeOut[0],timeOut[1],timeOut[2],0);if(timeOutDate.getTime()>timeInDate.getTime())isValidTime=true;else isValidTime=false}}else{if(!(checkIn||checkOut)){isValidTime=false;ecwAlert("Please enter valid time.","ECW Alert")}else{isValidTime=true}}if(!isValidTime){$scope.alertMessage='check out time should greater than check in time.';if($scope.timeIn||$scope.timeOut){ecwAlert($scope.alertMessage,"ECW Alert")}}return isValidTime}$scope.stsModalOpenFrm='';$scope.getStatusCodes=function(stsModalOpenFrm){$scope.stsModalOpenFrm=stsModalOpenFrm;var data={};officeVisitService.getStatusCodes(data).success(function(result){var x2js=new X2JS;var jsonData=x2js.xml_str2json(result);try{var obj=jsonData.Envelope.Body["return"].resultset.data.row;$scope.statusCodeList=validateResultArray(obj)}catch(e){ecwAlert(e.message,"ECW Alert");$scope.statusCodeList=[]}});$("#statusCodeModel").modal({backdrop:"static",keyboard:false})};$scope.setStatusCode=function(){$scope.selectedStatusCode=this.statusCode;$scope.status=$scope.selectedStatusCode.code;$scope.statusName=$scope.selectedStatusCode.name;if($scope.stsModalOpenFrm==='frmOV')$scope.saveEncStatus();$("#statusCodeModel").modal('hide')};$scope.statusCodeView=function(showStatusCodeList,isUpdated){$scope.showStatusBreadCrumb=showStatusCodeList;highlightStatusCodeBreadCrumb();if(isUpdated){$scope.getStatusCodes()}};var highlightStatusCodeBreadCrumb=function(showStatusCodeList){if(!$scope.showStatusBreadCrumb){$("#statusCodeAddUpdateBreadCrumb").removeClass("breadactive");$("#ovStatusCodeBreadCrumb").addClass("breadactive")}else{$("#ovStatusCodeBreadCrumb").removeClass("breadactive");$("#statusCodeAddUpdateBreadCrumb").addClass("breadactive")}};$scope.addOrEditStatusCode=function(statusCode){if(!statusCode){statusCode={codeId:'0',code:'',name:'',duration:''}}$scope.currentStatusCode=statusCode;$scope.showStatusBreadCrumb=true;highlightStatusCodeBreadCrumb();$ocLazyLoad.load({name:"statusCodeSetup",files:['/mobiledoc/jsp/webemr/jellybean/officevisit/statuscode/updateStatusCodeController.js']}).then(function(){$scope.include.url=makeURL('/mobiledoc/jsp/webemr/jellybean/officevisit/statuscode/updateStatusCode.html')},function(e){})};$scope.closeStatusCode=function(){if($scope.showStatusBreadCrumb){$scope.statusCodeView(false)}else{$("#statusCodeModel").modal("hide")}};$scope.saveStatusCode=function(){angular.element("#ModifyStatusCodes").scope().saveStsCode()};$scope.deleteStatusCode=function(stsCode){var data={codeId:stsCode.codeId,timestamp:(new Date).getTime()};officeVisitService.deleteStatusCode(data).success(function(result){$scope.getStatusCodes()})};function setCheckInCheckOutValue(checkInCheckOutArray){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);var arrayLength=checkInCheckOutArray.length;xw.writeStartElement('encounter');xw.writeAttributeString('xsi:type','xsd:string');for(var i=0;i<arrayLength;i++){addElement(xw,'roomNo',''+escapeXml(checkInCheckOutArray[i].roomNo),'xsi:type','xsd:string');addElement(xw,'timeIn',''+checkInCheckOutArray[i].timeIn,'xsi:type','xsd:string');addElement(xw,'timeOut',''+checkInCheckOutArray[i].timeOut,'xsi:type','xsd:string');addElement(xw,'arriveTime',''+checkInCheckOutArray[i].timeIn,'xsi:type','xsd:string');addElement(xw,'arriveTimeInUTC',''+$scope.timeInUTC==undefined?"":$scope.timeInUTC,'xsi:type','xsd:string');addElement(xw,'timeOutInUTC',''+$scope.timeOutUTC==undefined?"":$scope.timeOutUTC,'xsi:type','xsd:string');addElement(xw,'dateIn',''+checkInCheckOutArray[i].dateIn,'xsi:type','xsd:string');addElement(xw,'notesLoginId',''+checkInCheckOutArray[i].notesLoginId,'xsi:type','xsd:string');addElement(xw,'status',''+escapeXml(checkInCheckOutArray[i].status),'xsi:type','xsd:string');if(checkInCheckOutArray[i].statusName){addElement(xw,'statusName',''+escapeXml(checkInCheckOutArray[i].statusName),'xsi:type','xsd:string')}else{addElement(xw,'statusName','','xsi:type','xsd:string')}addElement(xw,'logDate',''+checkInCheckOutArray[i].logDate,'xsi:type','xsd:string');addElement(xw,'userId',''+checkInCheckOutArray[i].userId,'xsi:type','xsd:int');addElement(xw,'encCycleTimeLoggedDate',''+moment().format("YYYY-MM-DD")+" "+moment().format("HH:mm:ss"),'xsi:type','xsd:string');xw.writeEndElement()}endSoapPacket(xw);return xw.flush()}function prepareCheckInCheckOut(roomNo,timeIn,timeOut,dateIn,notesLoginId,status,statusName,logDate,userId){this.roomNo=roomNo;this.timeIn=timeIn===''?'00:00:00':convertAMPMto24Hour(timeIn);this.timeOut=timeOut===''?'00:00:00':convertAMPMto24Hour(timeOut);this.dateIn=dateIn;this.notesLoginId=notesLoginId;this.status=status;this.statusName=statusName;this.logDate=logDate;this.userId=userId}function convertAMPMto24Hour(time){var hours=Number(time.match(/^(\d+)/)[1]);var minutes=Number(time.match(/:(\d+)/)[1]);var AMPM=time.match(/\s(.*)$/)[1];if(AMPM==="PM"&&hours<12)hours=hours+12;if(AMPM==="AM"&&hours===12)hours=hours-12;var sHours=hours.toString();var sMinutes=minutes.toString();var sSeconds="00";if(hours<10)sHours="0"+sHours;if(minutes<10)sMinutes="0"+sMinutes;var convertedTime=sHours+":"+sMinutes+":"+sSeconds;return convertedTime}$scope.openSendMessage=function(arrEncIds,arrPtIds,bFlag){if(bFlag){$scope.loandSendMessage(arrEncIds,arrPtIds,true)}else{BootstrapDialog.show({title:"eClinicalWorks",message:"<small>One or more patients are not enabled with Messenger feature.\r\n "+"1.Please click ok if you want to send a message to only the patients with Voice/Text enabled.\r\n"+"2.Please click cancel if you do not want to send a message.</small>",buttons:[{label:'Ok',cssClass:'btn-lgrey btn-xs',action:function(dialog){dialog.close();$scope.loandSendMessage(arrEncIds,arrPtIds,true)}},{label:'Cancel',cssClass:'btn-lgrey btn-xs',action:function(dialog){dialog.close();return}}]})}};$scope.openSingleSendMessage=function(){if(!$scope.isAnyEncounterSelected()){$scope.alertMessage="Please select an Encounter";ecwAlert($scope.alertMessage,"ECW Alert");return}var arrEncIds=[];var arrPtIds=[];let bFlag=true;for(var ovIndex in $scope.filteredOfficeVisitList){if($scope.filteredOfficeVisitList[ovIndex].offVisitRowChecked){arrEncIds.push($scope.filteredOfficeVisitList[ovIndex].encounterId);arrPtIds.push($scope.filteredOfficeVisitList[ovIndex].patientId)}}if(arrPtIds.length===1){$scope.openSendMessage(arrEncIds,arrPtIds,bFlag)}else{let promise=$http({method:'POST',url:"/mobiledoc/emr/messenger/common/getPatientMessengerInfo",data:arrPtIds,headers:{'Content-Type':'application/json'}});promise.success(function(response){if(response.statusCode===1){bFlag=response.result.voiceenabled==='enabled'&&response.result.textenabled==='enabled'?true:false;$scope.openSendMessage(arrEncIds,arrPtIds,bFlag)}else{ecwAlert(response.message)}}).error(function(error){ecwAlert(error)})}};$scope.loandSendMessage=function(arrEncIds,arrPtIds,bFlag){if(arrEncIds.length>0){$templateCache.remove($scope.PNOptionsPopUpURL);$ocLazyLoad.load({name:'sendMessageModule',files:getDependencies('sendMessage')}).then(function(){var param="TrUserId="+global.TrUserId;param+="&EncIds="+arrEncIds.toString();param+="&patientIds="+arrPtIds.toString();param+="&Flag="+(bFlag==true?"VoiceEnabledOnly":"all");param+="&msgSource="+$("#hdMsgSource_OV").val();param+="&enabledMessenger="+($scope.enblVoice?"yes":"no");param+="&enabledWebPortal="+nWebportal;var url=makeURL('/mobiledoc/jsp/webemr/singlesend/sendMessage.jsp?'+param);$scope.PNOptionsPopUpURL=url},function(e){console.log(e)})}else{console.log("FAILD to get selected encounter.....")}};$scope.disableInk=true;$scope.EnableOrDisableContextSensitiveButton=function(keyName,toottipmsg,butid,isMedicalDevice){var data=getDeviceCompatibilityCheckValue(keyName,"",toottipmsg,isMedicalDevice);if(data!=""&&!angular.isUndefined(data)){var res=data.split(",");switch(keyName){case"eclinicforms":if(res[0]=="true")$scope.disableInk=false;else $scope.disableInk=true;break}if(res[0]=="false"){$("#"+butid).attr("title",res[1])}}};$scope.loadPluginOptions=function(tabsel){if($scope.validateSingleEncSelection()){switch(tabsel){case"eCliniForms":try{if($scope.eCliniFormsWebOnly()){$ocLazyLoad.load({name:'eCliniFormModule',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/eCliniForm/eCliniFormController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/eCliniForm/eCliniFormScrn.jsp?patientId='+$scope.selectedEncouterObj.patientId+'&patientName='+$scope.selectedEncouterObj.name+'&enc_id='+$scope.selectedEncouterObj.encounterId+'&nd='+(new Date).getTime());$scope.ecliniformWebURL=url},function(e){console.log(e)})}else{launchPlugin('id=ECLINICFORMS|patientId='+$scope.selectedEncouterObj.patientId+'|enc_id='+$scope.selectedEncouterObj.encounterId)}}catch(err){console.log(err)}break}}};$scope.eCliniFormsWebOnly=function(){var data=getDeviceCompatibilityCheckValue("eclinicforms","","","");if(data!=""&&!angular.isUndefined(data)){var res=data.split(",");if(res[0]=="true")return false;else return true}};$scope.openDepartmentLookup=function(){$scope.paramDepartmentPath=makeURL("/mobiledoc/jsp/webemr/webpm/getDepartments.jsp")};$scope.clearDept=function(){$scope.departmentForFilter={};$scope.departmentForFilter.department={};$scope.departmentForFilter.department.DeptName="";$scope.departmentForFilter.department.DeptId="0"};$scope.sendDepartmentToClaimController=function(deptObj){$scope.clearDept();if(deptObj!=undefined){$scope.departmentForFilter.department.DeptName=deptObj.DeptName;$scope.departmentForFilter.department.DeptId=deptObj.DeptId}};$scope.openChangeApptProviderPopup=function(){var selectedEncList=[];for(var rIndex in $scope.filteredOfficeVisitList){if($scope.filteredOfficeVisitList[rIndex].offVisitRowChecked){if($scope.filteredOfficeVisitList[rIndex].encLock=='1'){$scope.alertMessage="One or more selected encounters are locked. System can not change the appointment provider for locked notes. Please unselect the locked encounters and try again.";ecwAlert($scope.alertMessage,"ECW Alert");return}var encObj=EncDetailsService.getEncDetailsByEncId($scope.filteredOfficeVisitList[rIndex].encounterId);$scope.filteredOfficeVisitList[rIndex].resourceType=encObj.resourceType;$scope.filteredOfficeVisitList[rIndex].encFacilityId=encObj.facilityId;selectedEncList.push($scope.filteredOfficeVisitList[rIndex])}}var initCustomData={selectedEncList:selectedEncList,changeMultipleApptProvider:true};var popupUrl="/mobiledoc/jsp/webemr/templates/change-appt-provider.jsp";$ocLazyLoad.load({name:"ChangeApptProvider",files:['/mobiledoc/jsp/webemr/templates/change-appt-provider.js'],cache:true}).then(function(){var customStructModalInstance=$modal.open({templateUrl:popupUrl,controller:'ChangeApptProviderController',windowClass:'app-modal-window bluetheme',backdrop:"static",size:"mid",resolve:{initCustomData:function(){return initCustomData}}});customStructModalInstance.result.then(function(responseObj){},function(responseObj){console.log(responseObj);if(responseObj){$scope.refreshData('button')}})},function(e){console.log(e)})};$scope.openPNModal=function(tempId,patientId){var selectedEncList=[];for(var rIndex in $scope.filteredOfficeVisitList){if($scope.filteredOfficeVisitList[rIndex].offVisitRowChecked){var enc={};enc.encounterId=$scope.filteredOfficeVisitList[rIndex].encounterId;enc.checked=true;enc.patientId=$scope.filteredOfficeVisitList[rIndex].patientId;enc.patientName=$scope.filteredOfficeVisitList[rIndex].name;selectedEncList.push(enc)}}var initCustomData={selectedEncList:selectedEncList};var structCustomUrl="/mobiledoc/jsp/webemr/templates/pnpopup-tpl.jsp?encId="+tempId+"&patientId="+patientId+"&style="+getProgressNoteStyle();$ocLazyLoad.load({name:"pnPopupContainer",files:['/mobiledoc/jsp/webemr/templates/pnpopup-tpl.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/EncDetailsService.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/pnController.js'],cache:true}).then(function(){var customStructModalInstance=$modal.open({templateUrl:makeURL(structCustomUrl),controller:'pnPopupController',windowClass:'app-modal-window bluetheme',backdrop:"static",size:"lg",resolve:{initCustomData:function(){return initCustomData}}});customStructModalInstance.result.then(function(responseObj){},function(responseObj){})},function(e){console.log(e)})};$scope.isAnyEncounterSelected=function(){for(var rIndex in $scope.filteredOfficeVisitList){if($scope.filteredOfficeVisitList[rIndex].offVisitRowChecked){return true}}return false};$scope.openTemplateModal=function(){$("#viewPNOptions").removeClass("open");$scope.PNOptionsPopUpURL="";var params={TrUserId:trUserId,ms:(new Date).getTime()};params=$.param(params);$ocLazyLoad.load({name:'templateList',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/templates/browseCommon-tpl.js','/mobiledoc/jsp/webemr/templates/keywords-tpl.js','/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/templateListController.js']}).then(function(){$scope.frmOfficeVisit=true;var url="/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/templateList.jsp?"+params;$scope.PNOptionsPopUpURL=url},function(e){})};$scope.openPrintPreview=function(){var encounterIds="";angular.forEach($scope.selectedEncounters,function(encounterId,$index){encounterIds+=encounterId;if($index<$scope.selectedEncounters.length-1)encounterIds+=","});var docURL='/mobiledoc/jsp/catalog/xml/printMultipleChartOptions.jsp?FormData=default&isHtml=true&style='+strPrintDefaultStyle+'&encounterId='+encounterIds;docURL=makeURL(docURL);$scope.isOpProcedures=false;if($scope.isOpProcedures){docURL=docURL+"&OpProcedures=yes"}PSACService.callMultiplePrintChartOptions(docURL,encounterIds,function(data){openPrintDialog(1,data)},function(){$scope.alertMessage="Selected patient information is classified. Please contact administrator.";ecwAlert($scope.alertMessage,"ECW Alert")})};$scope.openFaxPreview=function(){if(!validateSelectedEncounterForPrintFax()){return}isEncContainsMultiPageDoc($scope.selectedEncounters,function(strMsg){if(strMsg==="yes"||strMsg==="no")$scope.openFaxPreview1()})};$scope.openFaxPreview1=function(){$scope.PNOptionsPopUpURL="";var faxPreviewObj={docId:0,url:'',doctorId:0,patientId:0,encId:0,faxType:'4',Id:0,toName:'',toFaxPrefix:'',toFax:'',toCompany:'',fromName:'',fromProvName:'',fromVoiceNo:'',controlledMed:'',facilityId:0,html:false,subject:'',faxPNStyle:'',fileName:'',filePath:'',rxId:'',description:'',docType:'',faxLogId:0,trnId:'',coverPage:0};var docURL="";var encounterIds="";angular.forEach($scope.selectedEncounters,function(encounterId,$index){encounterIds+=encounterId;if($index<$scope.selectedEncounters.length-1)encounterIds+=","});docURL='/mobiledoc/jsp/catalog/xml/printMultipleChartOptions.jsp?FormData=default&isHtml=true&fax=yes&style='+strFaxDefaultStyle+'&encounterId='+encounterIds;$scope.isOpProcedures=false;if($scope.isOpProcedures){docURL=docURL+"&OpProcedures=yes"}if($scope.selectedEncounters.length>1){faxPreviewObj.patientId=-1}else{faxPreviewObj.patientId=$scope.getPatientIdByEncId(encounterIds)}docURL=makeURL(docURL);$scope.docURL=docURL;faxPreviewObj.url=$scope.docURL;faxPreviewObj.faxType=faxType.faxTypeProgressNotes;faxPreviewObj.toName='';faxPreviewObj.fromCompany='';faxPreviewObj.facilityId=0;faxPreviewObj.subject='Faxing Multiple Encounters ';faxPreviewObj.docType='html';var jsonStr=JSON.stringify(faxPreviewObj);$ocLazyLoad.load({name:'faxModule',files:['/mobiledoc/jsp/webemr/jellybean/fax/fax.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/jellybean/fax/fax.jsp?callingFrom=officeVisit&faxJSONData="+escape(jsonStr)+"&nd="+(new Date).getTime());$scope.FaxPNPopUpURL=url;$("#faxPNPopUp").modal({backdrop:"static",keyboard:false})},function(e){console.log(e)})};var validateEncSelection=function(){if(!$scope.isAnyEncounterSelected()){$scope.alertMessage="Please select an Encounter";ecwAlert($scope.alertMessage,"ECW Alert");return false}return true};var validateSelectedEncounterForPrintFax=function(isPrint){if(!validateEncSelection()){return false}var maxEncFaxValue=getItemKeyValue("MaxEncPrintFax");maxEncFaxValue=maxEncFaxValue?maxEncFaxValue:20;var screenTitle=isPrint?'Print Progress Notes':'Fax Progress Notes';var action=isPrint?'printing':'faxing';if($scope.selectedEncounters.length>maxEncFaxValue){commonWarningPopup({screenName:'Office Visits',screenTitle:screenTitle,buttons:[{label:"OK",cssClass:'btn-blue w55',callbackEvent:function(){}}],message:' The number of Progress Notes selected for '+action+' <b>cannot</b> exceed the limit of '+maxEncFaxValue+'.<br/><br/>Please go back and select up to <b>20 Progress Notes</b> at a time.',isErrorPopup:true,screenSpecificClass:'width580px',isKeyboardClose:false},$ocLazyLoad,$modal);return false}return true};$scope.openMultiplePNOptionModal=function(option){$("#viewPNOptions").removeClass("open");if(!validateEncSelection()){return}if(option==='printSelectedPN'){$scope.openPrintPreview()}else if(option==='faxSelectedPN'){$scope.openFaxPreview()}else if(option==='chartGroupVisit'){$scope.openTemplateModal()}else if(option==='changeApptProviderForMultipleEnc'){$scope.openChangeApptProviderPopup()}};$scope.selectResourceFilter=function(filterType){$scope.selResourceFilter=filterType;$scope.resourceFilter="0"};if(isItemKeyEnabled('OfficeVisitPtFilterViewAppt')){$scope.appointmentPopup={};$scope.patientFilters=[];$scope.patientFilters.push({'id':'1','filter':'Name','requestParam':'name'});$scope.patientFilters.push({'id':'2','filter':'SSN','requestParam':'ssn'});$scope.patientFilters.push({'id':'3','filter':'DOB','requestParam':'dob'});$scope.patientFilters.push({'id':'4','filter':'Account No','requestParam':'accno'});$scope.patientFilters.push({'id':'5','filter':'Phone No','requestParam':'phone'});$scope.patientFilters.push({'id':'6','filter':'Subscriber No','requestParam':'subscriberno'});$scope.patientFilters.push({'id':'7','filter':'Previous Name','requestParam':'previousname'});$scope.patientFilters.push({'id':'8','filter':'Home/Work/Cell Phone','requestParam':'allphone'});$scope.patientFilters.push({'id':'9','filter':'Medical Record No','requestParam':'medicalrecord'});$scope.selectedPatientFilter=$scope.patientFilters[0]}$scope.selectPatientFilter=function(patientFilter){$scope.selectedPatientFilter=patientFilter;$("#ptFilterDropDown").removeClass("open")};$scope.viewAppointment=function(){if($scope.validateSingleEncSelection()){$templateCache.remove($scope.appointmentPopup.url);$scope.appointmentPopup.url="";var popupData={};popupData.modulename="Appointment";popupData.dependencies=["/mobiledoc/jsp/webemr/scheduling/js/newAppointment.js","/mobiledoc/jsp/webemr/scheduling/css/appointment.css"];popupData.url=makeURL("/mobiledoc/jsp/webemr/scheduling/newAppointment.jsp?encounterId="+$scope.selectedEncouterObj.encounterId+"&parentScreen=officevisit");$ocLazyLoad.load({name:popupData.modulename,files:popupData.dependencies,cache:true}).then(function(){$scope.appointmentPopup.url=popupData.url},function(e){console.log(e)})}};$scope.onCloseAppt=function(){$scope.appointmentPopup.url="";$templateCache.remove($scope.appointmentPopup.url)};$scope.customStructModalInstance;$scope.selectProviders=function(){$scope.selectProviderURL="";$ocLazyLoad.load({name:'ovSelectProvider',files:['/mobiledoc/jsp/webemr/jellybean/officevisit/ovSelectProvider.js']}).then(function(){$scope.customStructModalInstance=$modal.open({templateUrl:makeURL("/mobiledoc/jsp/webemr/jellybean/officevisit/ovSelectProvider.jsp"),controller:'ovtSelectProviderController',windowClass:'app-modal-window bluetheme',backdrop:"static",size:"mid"});$scope.customStructModalInstance.result.then(function(responseObj){},function(responseObj){$scope.setSelectedProviders(responseObj)})},function(e){ecwAlert(e,"ECW Alert")})};$scope.setSelectedProviders=function(selectedProviders){if(selectedProviders&&selectedProviders.id){var selProviderIds=selectedProviders.id.split(",");var selProviderName=selectedProviders.name.split(";");if(selProviderIds.length>0){$scope.providerForFilter.providerList=[];for(var index in selProviderIds){var provider={};provider.Id=selProviderIds[index];provider.Name=selProviderName[index];$scope.providerForFilter.providerList.push(provider)}}}};$scope.getPatientIdByEncId=function(encId){for(var ovIndex in $scope.filteredOfficeVisitList){if($scope.filteredOfficeVisitList[ovIndex].encounterId==encId){return $scope.filteredOfficeVisitList[ovIndex].patientId}}};$scope.printSelectedPN=function(){if(getItemKeyValue("allowMultiPrintFromOV").toLowerCase()==='no'){if($scope.selectedEncounters.length===1){isEncContainsMultiPageDoc($scope.selectedEncounters[0],function(strMsg){if(strMsg==="yes"||strMsg==="no")$scope.printSelectedPN1()})}else{$scope.printSelectedPN1()}}else{$scope.multiPrintPN()}};$scope.multiPrintPN=function(){if(!validateEncSelection()||!validateSelectedEncounterForPrintFax(true)){return}isEncContainsMultiPageDoc($scope.selectedEncounters,function(strMsg){if(strMsg==="yes"||strMsg==="no")$scope.openPrintPreview()})};$scope.printSelectedPN1=function(){if(false&&isPluginEnabled()){var encounterIds="";angular.forEach($scope.selectedEncounters,function(encounterId,$index){encounterIds+=encounterId;if($index<$scope.selectedEncounters.length-1)encounterIds+=","});var varUrl='/mobiledoc/jsp/catalog/xml/printMultipleChartOptions.jsp?FormData=default&isHtml=true&style='+strPrintDefaultStyle+'&encounterId='+encounterIds+'&fimg=y&pluginPrint=yes&logpnprint=yes';varUrl=makeURL(varUrl);PSACService.callMultiplePrintChartOptions(varUrl,encounterIds,function(){var SessionId=cookie.substring(11);var data={Flag:1,SessionId:SessionId,DateCreated:(new Date).getTime(),User:trUserName,Type:'PN',Parameters:encodeURIComponent(varUrl)};$.ajax({type:"POST",url:"/mobiledoc/jsp/webemr/singlesend/insertRecorderParameters.jsp",data:$.param(data),success:function(response){var RecordId=response.trim(),URL;if(RecordId!=undefined&&RecordId.length>0){launchPlugin('id=PN|RecordId='+RecordId+'|url='+varUrl+'|ptid='+$scope.patientId)}}})},function(){$scope.ovPrintNoCallback()},'1')}else{if($scope.validateSingleEncSelection()){var selectedEncId=$scope.selectedEncounters[0];var selectedPatientId=$scope.getPatientIdByEncId(selectedEncId);var FormData="Default";var varUrl='/mobiledoc/jsp/catalog/xml/printChartOptions.jsp?FormData=Default&isHtml=true&style='+strPrintDefaultStyle+'&encounterID='+selectedEncId+'&logpnprint=yes';var encObj=EncDetailsService.getEncDetailsByEncId(selectedEncId);if(encObj.opProcFlag){varUrl=varUrl+"&OpProcedures=yes"}varUrl=makeURL(varUrl);PSACService.callPrintChartOptions(varUrl,selectedEncId,'','',selectedPatientId,function(data){$scope.ovPrintYesCallback(data,false)},function(){$scope.ovPrintNoCallback()},'1')}}};$scope.ovPrintYesCallback=function(response,ismodal){$('#previewContent').html("");if(ismodal){$('#previewContent').html(removeScriptTags(response));$("#previewDialogApp").modal('show');$(".modal-backdrop").css('position','relative');var api=$("#previewContent").jScrollPane({autoReinitialise:true}).data('jsp');api.reinitialise()}else{$('#previewContent').html(response);openPrintDialog(1)}};$scope.ovPrintNoCallback=function(){};$scope.loadPrePostOp=function(){$ocLazyLoad.load({name:'CCMRModule',files:['/mobiledoc/jsp/webemr/ccmr/js/10eCCMR.js']}).then(function(){var urlSurgery=makeURL('/mobiledoc/jsp/webemr/ccmr/ccmrOrthoNav.jsp');$scope.prePostOpUrl=urlSurgery;$timeout(function(){$scope.setPrePostOpHeight()},1e3)},function(e){console.log(e)})};$scope.setPrePostOpHeight=function(){var isValidTab=document.getElementById("prePostOpTabId")!=null&&document.getElementById("prePostOpTabId").style!=null;var isValidFrm=document.getElementById("iframeCCMR")!=null&&document.getElementById("iframeCCMR").style!=null;if(isValidTab&&isValidFrm){var frmSurHeight=document.getElementById("prePostOpTabId").style.height;if(frmSurHeight!=null&&frmSurHeight!=""&&frmSurHeight.indexOf("px")>-1){frmSurHeight=frmSurHeight.replace("px","");if(!isNaN(frmSurHeight)){document.getElementById("iframeCCMR").style.height=parseInt(frmSurHeight)-30+"px"}}}};$scope.validateSingleEncSelection=function(){if($scope.selectedEncounters.length==0||$scope.selectedEncounters.length>1){ecwAlert("Please select one Encounter.","ECW Alert");return false}var selEncounterId=$scope.selectedEncounters[0];$scope.changeSelectedEncObj(selEncounterId);if(!$scope.encounterObj||$scope.encounterObj.encounterId!==selEncounterId){initializeEncounterObject(selEncounterId)}return true};$scope.changeSelectedEncObj=function(encId){for(var ovIndex in $scope.filteredOfficeVisitList){if($scope.filteredOfficeVisitList[ovIndex].encounterId==encId){$scope.selectedEncouterObj=$scope.filteredOfficeVisitList[ovIndex]}}};function callToOpenPN(){nuclearTestVisitFlg=false;$("#btnViewPN").click()}function getyyyymmddFormattedDate(dtObj){var dd=dtObj.getDate();if(dd<10){dd="0"+dd}var mm=dtObj.getMonth()+1;if(mm<10){mm="0"+mm}var yyyy=dtObj.getFullYear();dtObj=yyyy+"-"+mm+"-"+dd;return dtObj}function getmmddyyyyFormattedDate(dtObj){var dd=dtObj.getDate();if(dd<10){dd="0"+dd}var mm=dtObj.getMonth()+1;if(mm<10){mm="0"+mm}var yyyy=dtObj.getFullYear();dtObj=mm+"/"+dd+"/"+yyyy;return dtObj}$scope.closePager=function(){$('.pgrdrpup').removeClass('open')};$scope.chkActvTab=function(){if(!$scope.allowSendingPageToPatient&&!$scope.allowSendingPageToProviders){$(".pagenowbtn").hide();$("#initpagerbtn").hide();$scope.cancelPagingBtn=false}if($scope.allowSendingPageToPatient&&$scope.patientPagingTabActive.attr){$(".pagenowbtn").show();$("#initpagerbtn").show();if($scope.isPagerInitialised===true){$scope.cancelPagingBtn=true}}else if(!$scope.allowSendingPageToPatient&&$scope.patientPagingTabActive.attr){$(".pagenowbtn").hide();$("#initpagerbtn").hide();$scope.cancelPagingBtn=false}if($scope.allowSendingPageToProviders&&!$scope.patientPagingTabActive.attr){$(".pagenowbtn").show();$("#initpagerbtn").hide();$scope.cancelPagingBtn=false}else if(!$scope.allowSendingPageToProviders&&!$scope.patientPagingTabActive.attr){$(".pagenowbtn").hide();$("#initpagerbtn").hide();$scope.cancelPagingBtn=false}};$scope.adjustGridHeight=function(){$('#filter').on('shown.bs.collapse',function(){if($scope.isGroupDocEnabled){$(".dash-height").css('height',$(".dash-height").height()-30+'px')}});$('#filter').on('hidden.bs.collapse',function(){if($scope.isGroupDocEnabled){$(".dash-height").css('height',$(".dash-height").height()-30+'px')}});if($scope.isGroupDocEnabled){$(".dash-height").css('height',$(".dash-height").height()-30+'px')}};$scope.setActiveTabId=function(tabId){$scope.activeTabId=tabId};$scope.getActiveTabId=function(){return $scope.activeTabId};$scope.openReasonModal=function(selectedEncouterObj){$scope.currentReason=selectedEncouterObj.reason;if($scope.currentReason){$scope.patientIdentifiers=selectedEncouterObj.patientId;$("#reasonModal").modal({backdrop:"static",keyboard:false})}};$scope.closeDetailData=function(){for(var i=0;i<$scope.officeVisitList.length;i++){if(!$('#'+$scope.officeVisitList[i].encounterId+"_icon").hasClass('collapsed')){$('#'+$scope.officeVisitList[i].encounterId+"_icon").addClass('collapsed')}if($('#'+$scope.officeVisitList[i].encounterId+'_detail').hasClass('in')){$('#'+$scope.officeVisitList[i].encounterId+'_detail').removeClass('in')}$("#"+$scope.officeVisitList[i].encounterId+"_list").empty()}};$scope.openDetailData=function(id){$scope.trackingBoardShowHideId=id;var length=0;$("#headerTr").find("th").each(function(){var colspan=$(this).attr("colspan");if(typeof colspan!=="undefined"&&colspan>0){length+=parseInt(colspan)}else{length+=1}});$scope.colspanValue=length;if(!$('#'+id+"_icon").hasClass('collapsed')){$('#'+id+"_icon").addClass('collapsed');$('#'+id+'_detail').removeClass('in');$('#'+id+"_icon").prop('title','Open Dashboard Tiles')}else{$scope.closeDetailData();$('#'+id+"_icon").removeClass('collapsed');$('#'+id+'_detail').addClass('in');$('#'+id+"_icon").prop('title','Close Dashboard Tiles')}};$scope.showData=function(index,patientId,encounterId){$scope.indexid=index;if($.trim($("#"+encounterId+"_list").html()).length==0){let elem=$compile(" <healow-plus-tile-view-dir index-id=\""+index+"\" patient-id=\""+patientId+"\" encounter-id=\""+encounterId+"\" screen-name='\""+$scope.screenName+"\"'></healow-plus-tile-view-dir>")($scope);$("#"+encounterId+"_list").html(elem)}else{$("#"+encounterId+"_list").empty()}};$scope.openActivity=function(){$("#activityToggleBtn").click()};$scope.bh_hideStopTimerPopup=function(){$('#bhStopTimePopup').hide()};$scope.openPatientEnteredData=function(officevisit){$scope.Telelinkurl="";let appointmentId=officevisit.appointmentId;var patientId=officevisit.patientId;var demoGraphicsId=0;$ocLazyLoad.load({name:'PreviewPatientEnteredDataInfo',files:['/mobiledoc/jsp/webemr/jellybean/patiententereddata/js/previewPatientEnteredDataInfo.js','/mobiledoc/jsp/resources/jslib/perfect-scrollbar/css/perfect-scrollbar.css','/mobiledoc/jsp/resources/jslib/perfect-scrollbar/dist/perfect-scrollbar.min.js','/mobiledoc/jsp/resources/jslib/angular-perfect-scrollbar/src/angular-perfect-scrollbar.min.js']}).then(function(){var url="/mobiledoc/jsp/webemr/jellybean/patiententereddata/previewPatientEnteredDataInfo.jsp?"+"TrUserId="+global.TrUserId+"&patientId="+patientId+"&demoGraphicsId="+demoGraphicsId+"&encounterId="+appointmentId;url=makeURL(url);$scope.Telelinkurl=url},function(e){console.log(e)})};let groupBtnClickHandler;$scope.filterGroupApptFromEncounterList=function(lockEncList,lockEncDataList){return new Promise((resolve,reject)=>{if(getItemKeyValue("EnableCCMR").toLowerCase()==="yes"&&getItemKeyValue("GroupDocumentation").toLowerCase()==="yes"){$scope.groupVisitList=[];var param={'encId':lockEncList.join(),'action':"checkMultipleGroupEncounter"};officeVisitService.getGroupEncounterInfo(param).success(function(data){if(data.success==='true'){$scope.groupVisitList=data.groupEncIds;for(let index in $scope.groupVisitList){var groupEncId=$scope.groupVisitList[index].encId;if(groupEncId>0){let indexOfLockEnc=lockEncList.indexOf(groupEncId);if(indexOfLockEnc>-1){lockEncList.splice(indexOfLockEnc,1);lockEncDataList.splice(indexOfLockEnc,1)}}}if($scope.groupVisitList.length>0){$scope.groupApptInfoModelUrl="/mobiledoc/jsp/webemr/ccmr/groupdocumentation/showGroupEncounterListView.html?currTime="+Date.now();groupBtnClickHandler=function(){resolve()};let timer=$timeout(function(){$("#btnOkGroupVisit,#btnGroupApptModalClose").on('click',groupBtnClickHandler);$timeout.cancel(timer)},100)}}else{resolve()}}).error(function(){reject();ecwAlert("An error occurred while verifying group note(s). Please try again or contact eClinicalWorks support.","eClinicalWorks")})}else{resolve()}})};$scope.healowInsightsOutlookLoad=function(){$ocLazyLoad.load({name:'healowInsightsOutlookApp',files:['/mobiledoc/jsp/webemr/analytics/ihubanalytics/css/healow-insights-outlook.css','/mobiledoc/jsp/webemr/analytics/ihubanalytics/js/healow-insights-outlook-controller.js']}).then(function(){$scope.healowInsightsOutlook='/mobiledoc/jsp/webemr/analytics/ihubanalytics/healow-insights-outlook.html'},function(){ecwAlert("Failed to load page, Please try again.","eClinicalWorks",null,"","orangetheme")})};$scope.healowInsightsOutlookLoad()}]);angular.module('officeVisit.services',[]).service('officeVisitService',function($http){var URL="/mobiledoc/jsp/catalog/xml/";return{getResources:function(){var url='/mobiledoc/jsp/catalog/xml/getResources.jsp';url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getVisitStsCodes:function(){var url='/mobiledoc/jsp/catalog/xml/getVisitStsCodes.jsp';url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},setCheckInTime:function(data){var param=$.param(data);var url="/mobiledoc/jsp/catalog/xml/setCheckInTime.jsp?"+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getDoctorsScheduleList:function(data){var param=$.param(data);var url='/mobiledoc/jsp/catalog/xml/getDoctorsScheduleList.jsp';url=makeURL(url);return $http({method:'POST',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'},data:param})},updateEncData:function(bodyData,encId){var url=URL+'UpdateEncData.jsp?encounterId='+encId;url=makeURL(url);bodyData=$.param(bodyData);return $http({headers:{'Content-Type':'application/x-www-form-urlencoded'},method:'POST',url:url,data:bodyData})},deleteStatusCode:function(bodyData){var url=URL+'deleteStatusCode.jsp';url=makeURL(url)+"&operation=AllowStatusCode";bodyData=$.param(bodyData);return $http({method:'POST',url:url,data:bodyData,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getStatusCodes:function(param){param=$.param(param);var url=URL+'getStatusCodes.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getProviderData:function(param){param=$.param(param);var url=URL+'getProviderData.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getValuesForEnctrId:function(param){param=$.param(param);var url=URL+'getValuesForEnctrId.jsp?'+param;url=makeURL(url);return $.ajax({"async":false,method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},updateEncProvider:function(param){var url=URL+'UpdateEncProvider.jsp';url=makeURL(url);param=$.param(param);return $http({method:'POST',url:url,data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},saveEncRoomNo:function(param){param=$.param(param);var url=URL+'setEncRoomNo.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getTVCode:function(param){param=$.param(param);var url='/mobiledoc/jsp/telemed/telemedResponse.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},saveEncStatus:function(param){param=$.param(param);var url=URL+'setEncStatus.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},IsFPStringMandatory:function(param){param=$.param(param);var url='/mobiledoc/jsp/catalog/xml/edi/IsFPStringMandatory.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},FPStringExists:function(param){param=$.param(param);var url='/mobiledoc/jsp/catalog/xml/edi/chkTMHPFPString.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},generateHL7Msg:function(param){param=$.param(param);var url='/mobiledoc/jsp/catalog/xml/GenerateHl7Msg.jsp?'+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getEncountersLockAcquired:function(encounterIds){var url="/mobiledoc/jsp/catalog/xml/edi/getEncLockAcquiredList.jsp";url=makeURL(url);var xsrf=$.param({encIds:encounterIds});return $http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,data:xsrf})},saveUserProfile:function(strXml,userId){var url="/mobiledoc/jsp/catalog/xml/SaveUserProfile.jsp?UserId="+userId;url=makeURL(url);var xsrf=$.param({FormData:strXml});return $http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,data:xsrf})},sendTelevisitMessage:function(encounterId,textmessage){var url=makeURL("/mobiledoc/jsp/webemr/singlesend/sendTelevisitCode.jsp");var data=$.param({'encounterId':encounterId,'textmessage':textmessage});return $http.post(url,data)},setPatientTextEnable:function(patientId,contactType,voiceenabled){var requestJsonObj={"textconfig":{"language":"En","contacttype":contactType,"appointments":"1","labs":"1","healthmaintenance":"1","generalnotification":"1","rx":"1","uid":patientId},"patient":{"textenabled":"1","voiceenabled":voiceenabled,"id":patientId,"lognotes":"Automatic Enable fot TeleVisit Invite"}};var url=makeURL("/mobiledoc/jsp/webemr/toppanel/voice/savePtCommunications.jsp");var data="record="+encodeURIComponent(JSON.stringify(requestJsonObj));return $http.post(url,data)},getPatientCommunicationSettings:function(patientId){var url=makeURL("/mobiledoc/jsp/webemr/toppanel/voice/fetchpatientcommunicationdata.jsp");var data=$.param({uid:patientId});return $http.post(url,data)},getGroupEncounterInfo:function(data){var param=$.param(data);var url="/mobiledoc/jsp/ccmr/webPortal/groupDocumentation/getGroupEncounterInfo.jsp?"+param;url=makeURL(url);return $http({method:'GET',url:url,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getVisitQueueDashboardSetting:function(){var url="/mobiledoc/emr/visitqueue/getVisitQueueDashboardSetting";url=makeURL(url);return $http({method:'POST',url:url})}}});
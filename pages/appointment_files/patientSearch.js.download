angular.module('PatientSearch',['oc.lazyLoad','facilitylookup','ecw.service.PSAC','ecw.service.duplicatePatientService',getPerfectScrollbarDependencyFiles(),'ecw.dir.alertmessage',getToasterDependencyFiles(),getEhxCommonFuncsJsDependency(true)]).controller('patientSearchController',function($scope,$http,$ocLazyLoad,patientSearchService,$compile,$timeout,PSACService,$filter,duplicatePatientService,$q,toaster,$modal){$scope.patientList=[];$scope.primaryServiceLocationName="";$scope.url={urlLink:""};$scope.patientSearchCriteria={};$scope.patientSearch={};$scope.patient={};$scope.patient.patient={};$scope.medicscanparent='';$scope.actionName='';$scope.isGuarantor=false;$scope.isDefault=0;$scope.guarantorSearchCriteria={};$scope.guarantorSearch={};$scope.guarantor={};$scope.isOpenInfo=false;$scope.guarantor.guarantor={};$scope.guarantorSearchCriteria.secondSearchBy="0";$scope.searchByOptions=[{name:"Name",id:"0"},{name:"SSN",id:"1"},{name:"DOB",id:"2"},{name:"Account No",id:"3"},{name:"Phone No",id:"4"}];$scope.patientSearchCriteria.showGlobalAlerts=getItemKeyValue("ShowGlobalAlertsInPatientLookup").toLowerCase()==="yes";$scope.patientSearchCriteria.enableFacilityAccess=getItemKeyValue("enableFacilityAccess").toLowerCase()==="yes";$scope.patientSearchCriteria.enableWebPortal=$.trim(getItemKeyValue("EnableWebPortal",true))==="1";$scope.patientSearchCriteria.enableSearchForPatients=$.trim(getItemKeyValue("GuarantorLookupDisableSearchForPatients",false))==="1";$scope.patientSearchCriteria.defaultSearchBy=getItemKeyValue("GuarantorLookupDefaultSearchBy",false);$scope.patientSearchCriteria.defaultSortBy=getItemKeyValue("GuarantorLookupDefaultSortBy",false);$scope.patientSearchCriteria.defaultSortOrder=getItemKeyValue("GuarantorLookupDefaultSortOrder",false);$scope.patientSearchCriteria.minimumCharGuarantorLookup=getItemKeyValue("MinimumCharGuarantorLookup",true);$scope.patientSearchCriteria.enableVoiceInterface=getItemKeyValue("EnableVoiceInterface").toLowerCase()==='yes';$scope.patientSearchCriteria.enableQRFLookup=getItemKeyValue("EnableQRFLookup").toLowerCase()==='yes';$scope.patientSearchCriteria.enableEhxColumn=getEmrItemKeyValue('EnableEMPI');$scope.patientSearchCriteria.miniCharLimit=getItemKeyValue("MinimumCharPatientLookup",true);$scope.patientSearchCriteria.populateOnLoadGrLookup=getItemKeyValue("PopulateOnLoadGrLookup").toLowerCase()==='yes';$scope.isQuickRegEnabled=isItemKeyEnabled("EnableQuickRegistration");var phoneNoMinLength=parseInt(getItemKeyValue("PhoneNoMinimumCharPatientLookup",true));$scope.patientSearchCriteria.phoneNoPtLookupMinChar=isNaN(parseInt(phoneNoMinLength))?$scope.patientSearchCriteria.miniCharLimit:parseInt(phoneNoMinLength);var dobMinLength=parseInt(getItemKeyValue("DOBMinimumCharPatientLookup",true));$scope.patientSearchCriteria.dobPtLookupMinChar=isNaN(parseInt(dobMinLength))?$scope.patientSearchCriteria.miniCharLimit:parseInt(dobMinLength);$scope.enableQuickRegistrationAndAppointment=getItemKeyValue("EnableQuickRegistrationAndAppointment")==="1";$scope.calculateMaskedMinCharForDob=function(dobMinLen){if(dobMinLen>4){return dobMinLen+2}else if(dobMinLen>2&&dobMinLen<=4){return dobMinLen+1}else{return dobMinLen}};$scope.calculateMaskedMinCharForPhone=function(phoneNoMinLen){if(phoneNoMinLen>6){return phoneNoMinLen+2}else if(phoneNoMinLen>3&&phoneNoMinLen<=6){return phoneNoMinLen+1}else{return phoneNoMinLen}};$scope.patientSearchCriteria.phoneNoPtLookupMinCharWithMasking=$scope.calculateMaskedMinCharForPhone($scope.patientSearchCriteria.phoneNoPtLookupMinChar);$scope.patientSearchCriteria.dobPtLookupMinCharWithMasking=$scope.calculateMaskedMinCharForPhone($scope.patientSearchCriteria.dobPtLookupMinChar);$scope.patientSearchCriteria.searchText="";$scope.patientSearchCriteria.secondSearchValue="";$scope.patientSearchCriteria.lastName="";$scope.patientSearchCriteria.firstName="";$scope.patientSearchCriteria.dob="";$scope.patientSearchCriteria.controlNo="";$scope.patientSearchCriteria.PhoneNo="";$scope.patientSearchCriteria.PreviousName="";$scope.patientSearchCriteria.MRN="";$scope.patientSearchCriteria.facilityid="-1";$scope.patientSearchCriteria.allFacilities=false;$scope.showToasterMessage=true;$scope.b3rdPartyPortal=getItemKeyValue("Empi3rdPartyPortal");$scope.patientSearchCriteria.facilityOptionsList=[{"name":"","value":0},{"name":"My Facilities","value":1}];$scope.nonReloadConfigColumnIds=["SSN","AllPhones","MedicalRecNo","PreviousName"];$scope.customTooltipConfigColumnIds=["AllPhones","GrPhone","InsuranceName","SubscriberNo"];$scope.templateNameSearchText={};$scope.patientSearchMaxRecordList=[10,15,20];$scope.patientSearchMaxRecord=$scope.patientSearchMaxRecordList[1];$scope.patientSearchCriteria.counter=1;$scope.patientSearchCriteria.limitStart=0;$scope.patientSearchCriteria.limitRange=$scope.patientSearchMaxRecord;$scope.patientSearchCriteria.searchByCount=0;$scope.patientSearchCriteria.NYCIDNo="";$scope.patientSearchCriteria.BookAndCaseNo="";$scope.config={SIDLabel:getItemKeyValue("Corrections_SIDLabel"),BnCLabel:getItemKeyValue("Corrections_BCLabel")};$scope.patientSearch.encCount=0;$scope.patientSearch.left=false;$scope.randomnumber=Math.floor(Math.random()*999999);$scope.patientSearch.selectedPatient={};$scope.patientSearch.selectedIndex=0;$scope.facilityName=[];$scope.facilityName.facility=[];$scope.facilityName.facility.Name="";$scope.facilityName.facility.Id=0;$scope.showNewDeleteButtons=false;$scope.ehxPatientsCount=0;$scope.ehxPatientsList=[];$scope.ehxPatientsListFull=[];$scope.ehxPatientsResultForString='';$scope.ehxPatientsStartCount=0;$scope.ehxPatientsPageNo=0;$scope.ehxPatientsMaxCount=4;$scope.ehxPatientsMaxRecordsPerSearch=100;$scope.ehxPatientsAppendSearchDone=true;$scope.ehxPatientsAppendSearch=false;$scope.ehxDisablePrev=false;$scope.ehxDisableNext=false;$scope.ehxHasData=false;$scope.emrNextClick=false;$scope.emrPrevClick=false;$scope.ehxConsentOpen="";$scope.disableMediscanNewBtn=true;$scope.ehxPatientsNotFoundDivShow=false;$scope.nhxPtDetailsJSON=patientSearch_nhxPtDetailsJSON;$scope.duplicatePatientURL="";var permissionKeyList=getPermissionForKeyArray(["DeletePatient"],global.TrUserId);$scope.deletePatientPermission=permissionKeyList&&permissionKeyList.Values.length>0&&permissionKeyList.Values[0]["DeletePatient"]===1;var timer="";var deletePatientTimer="";var searchTextTimeout=null;var medicScanTimeout=null;var medicScanPhotoTimeout=null;var isLoading=false;var canceler;$(document).ready(function(){$(".modal-header").css('cursor','move');$(".modal-dialog").draggable({handle:".modal-header"})},false);$scope.searchByOptions=[];$scope.statusOptions=[];$scope.userTypeOptions=[];$scope.patientLookupConst={loadingErrorMessage:"NOTE: Error occurred during loading the data.",saveErrorMessage:"NOTE: Error occurred during saving the data.",deleteErrorMessage:"NOTE: Error occurred while deleting the patient."};$scope.patientcopyurl="";$scope.patientQuickRegUrl="";$scope.patientSearchCriteria.enableCorrectionalFeatures='yes'===getItemKeyValue("EnableCorrectionalFeatures").toLowerCase();if($scope.patientSearchCriteria.enableCorrectionalFeatures){$("#rule-table2"+$scope.patientScreenUId).css("background-color","yellow")}$scope.setScreenId=function(){let lastPatientUId=getLatestPatientUId();$scope.patientScreenUId=lastPatientUId};function getLatestPatientUId(){var valueArray=[];for(var k in patientGlobalObj){if(k.indexOf('patientScreenUId')>=0){if(typeof patientGlobalObj[k]!=='undefined'&&patientGlobalObj[k]){valueArray.push(patientGlobalObj[k])}}}return valueArray.length===0?"":valueArray[valueArray.length-1]}$scope.initPatientSearchVariables=function(strIsMatchPatient,strIsReturnPtObject,context,patientName,showTopButtons,action,primaryServiceLocationId,isVoiceEnabledForPtLookup,isVBClient){$scope.isMatchPatient=$.trim(strIsMatchPatient)==="true";$scope.isReturnPtObject=$.trim(strIsReturnPtObject)==="true";$scope.context=context;$scope.patientName=patientName;$scope.showTopButtons=$.trim(showTopButtons);$scope.actionName=action;$scope.primaryServiceLocationId=$.trim(primaryServiceLocationId);$scope.isVoiceEnabledForPtLookup=isVoiceEnabledForPtLookup;$scope.isVBClient=isVBClient;$scope.isGuarantor=angular.equals(action,"Guarantor");if(!$scope.isGuarantor){$scope.facilityList=getFacilityList();if($scope.facilityList){for(var i=0;i<$scope.facilityList.length;i++){if($scope.facilityList[i]&&$scope.facilityList[i].Id===$scope.primaryServiceLocationId){$scope.primaryServiceLocationName=$scope.facilityList[i].Name;break}}}$scope.ptSearchObj.allFacilityPermission=isAllFacilityPermitted().toString()==='true';if($scope.ptSearchObj.allFacilityPermission){$scope.patientSearchCriteria.facilityOptionsList.push({"name":"All Facilities","value":2})}}var responseObj=patientSearchService.getInitDataForPtLookup($scope.actionName);if(!responseObj||Object.keys(responseObj).length===0||responseObj.status==="failed"){showAlertMessage("<div class='text-left mt-20'>Error occurred while getting template related Information.</div>","","ErrorMsg");return}$scope.templateList=responseObj.templateList;$scope.statusOptions=responseObj.patientStatus;$scope.userTypeOptions=responseObj.patientUserType;$scope.searchByOptions=responseObj.columnDetails;$scope.searchByOptionsForName=$scope.searchByOptions.filter(function(obj){return obj.id==="Name"})[0];$scope.searchByOptionsForDateOfBirth=$scope.searchByOptions.filter(function(obj){return obj.id==="DateOfBirth"})[0];$scope.currentTemplateObj=responseObj.defaultTemplateObj;$scope.ptLookUpSSNItemkey=responseObj.ptLookUpSSNItemkey;$scope.defaultTemplateId=$scope.currentTemplateObj.templateId;$scope.applyReceivedTemplate();if($scope.context.toLowerCase()==="patientnamedlookup"&&$scope.patientName.length>0){$scope.patientSearchCriteria.searchBy="Name";$scope.patientSearchCriteria.secondSearchBy="DateOfBirth";$scope.setMinCharForFilter(false)}if($scope.patientSearchData_patientLookup!==undefined&&$scope.context!=='CircleOfCare'){$scope.patientSearchCriteria=$scope.patientSearchData_patientLookup;$scope.patientSearchData_patientLookup={}}if(!$scope.isGuarantor&&($scope.patientSearchCriteria.miniCharLimit==="0"||$scope.patientSearchCriteria.searchText.length>=$scope.patientSearchCriteria.miniCharLimit)||$scope.isGuarantor&&$scope.patientSearchCriteria.populateOnLoadGrLookup){$scope.loadPatientList()}if($scope.currentTemplateObj.defaultTemplateNotAvailable){showAlertMessage("<div class='text-left mt-20'> <div class='mb10'><b>Default Template Deleted</b></div>"+$scope.currentTemplateObj.defaultTemplateNotAvailable+"</div>","","InfoMsg")}if($scope.patientSearchCriteria.enableFacilityAccess===true){var facilityObj=getMyFacilities();if(facilityObj.length===0){facilityObj=0}else{facilityObj=getMyFacilities().split(",").length}$scope.patientSearchCriteria.facilityOptionsList[1].name="My Facilities ("+facilityObj+")";if($scope.ptSearchObj.allFacilityPermission){var allFacilityObj=getAllFacility();$scope.patientSearchCriteria.facilityOptionsList[2].name="All Facilities ("+allFacilityObj.records+")"}}if(!patientSearchService.isOpen()){patientSearchService.setOpen(true)}else{$('.modal-backdrop.fade.in:last').remove()}$('#patient-lookup-screen'+$scope.patientScreenUId).modal()};function updateCorrectionsParam(colName){if($scope.patientSearchCriteria.enableCorrectionalFeatures){if("State ID"===colName){return getItemKeyValue("Corrections_SIDLabel")}else if("Book and case"===colName){return getItemKeyValue("Corrections_BCLabel")}}return colName}var toasterTimer;$scope.onStructDataSelection=function(isStructCol){if(!isStructCol){$scope.enableSearchIcon=false;return}$scope.enableSearchIcon=true;$("#custom-toaster-wrapper"+$scope.patientScreenUId).show();$("#custom-toaster-wrapper .toast-alert-box"+$scope.patientScreenUId).removeClass('active').show().addClass('active');if(toasterTimer&&toasterTimer!==''){$timeout.cancel(toasterTimer)}toasterTimer=$timeout(function(){$scope.closeCustomToaster()},8e3)};$scope.closeCustomToaster=function(){$("#custom-toaster-wrapper .toast-alert-box"+$scope.patientScreenUId).fadeOut().removeClass('active');$("#custom-toaster-wrapper"+$scope.patientScreenUId).hide()};$scope.applyReceivedTemplate=function(){$scope.patientSearchCriteria.searchBy=$scope.currentTemplateObj.primaryFilter.id;$scope.patientSearchCriteria.searchByColId=$scope.currentTemplateObj.primaryFilter.colId;$scope.patientSearchCriteria.searchByName=updateCorrectionsParam($scope.currentTemplateObj.primaryFilter.name);$scope.patientSearchCriteria.searchByPlaceHolder=$scope.currentTemplateObj.primaryFilter.placeholder;$scope.patientSearchCriteria.searchByStructCol=$scope.currentTemplateObj.primaryFilter.isStructCol;$scope.patientSearchCriteria.secondSearchBy=$scope.currentTemplateObj.secondaryFilter.id;$scope.patientSearchCriteria.secondSearchByColId=$scope.currentTemplateObj.secondaryFilter.colId;$scope.patientSearchCriteria.secondSearchByName=updateCorrectionsParam($scope.currentTemplateObj.secondaryFilter.name);$scope.patientSearchCriteria.secondSearchByPlaceHolder=$scope.currentTemplateObj.secondaryFilter.placeholder;$scope.patientSearchCriteria.status=$scope.currentTemplateObj.patientStatusName;if($scope.isGuarantor){if($scope.patientSearchCriteria.enableSearchForPatients){$scope.patientSearchCriteria.userType="Guarantors"}else if($scope.currentTemplateObj.templateName==="System Default Template for Guarantor"){$scope.patientSearchCriteria.userType=$scope.patientSearchCriteria.defaultSearchBy}else{$scope.patientSearchCriteria.userType=$scope.currentTemplateObj.patientUserTypeName}}if(!$scope.isGuarantor){$scope.patientSearchCriteria.includeApptFacility=$scope.currentTemplateObj.isAppointFacility;$scope.patientSearchCriteria.defaultFacilityOption=$scope.currentTemplateObj.myOrAllFacility;if($scope.patientSearchCriteria.enableFacilityAccess){$scope.patientSearchCriteria.myOrAllFacs=$scope.patientSearchCriteria.facilityOptionsList[$scope.patientSearchCriteria.defaultFacilityOption];if($scope.patientSearchCriteria.myOrAllFacs===undefined){$scope.patientSearchCriteria.myOrAllFacs=$scope.patientSearchCriteria.facilityOptionsList[1]}else if($scope.patientSearchCriteria.myOrAllFacs.value===0&&$scope.currentTemplateObj.facilityList.length===0){$scope.patientSearchCriteria.myOrAllFacs=$scope.ptSearchObj.allFacilityPermission?$scope.patientSearchCriteria.facilityOptionsList[2]:$scope.patientSearchCriteria.facilityOptionsList[1];$scope.ptSearchObj.disableFacilityLookup=true}}else{$scope.patientSearchCriteria.myOrAllFacs=$scope.patientSearchCriteria.facilityOptionsList[0]}if($scope.currentTemplateObj.facilityList.length>0&&$scope.currentTemplateObj.facilityList[0].facilityId>0&&$scope.currentTemplateObj.facilityList[0].facilityName){if(checkIfGivenFacilityIsAccessibleOrNot()){$scope.patientSearchCriteria.facilityid=$.trim($scope.currentTemplateObj.facilityList[0].facilityId);$scope.patientSearchCriteria.facilityName=$scope.currentTemplateObj.facilityList[0].facilityName}else{if($scope.patientSearchCriteria.enableFacilityAccess){$scope.patientSearchCriteria.myOrAllFacs=$scope.ptSearchObj.allFacilityPermission?$scope.patientSearchCriteria.facilityOptionsList[2]:$scope.patientSearchCriteria.facilityOptionsList[1];$scope.ptSearchObj.disableFacilityLookup=true}else{$scope.patientSearchCriteria.facilityName="All";$scope.patientSearchCriteria.facilityid="0"}}}else if(!$scope.patientSearchCriteria.enableFacilityAccess){$scope.patientSearchCriteria.facilityName="All";$scope.patientSearchCriteria.facilityid="0"}else{$scope.patientSearchCriteria.facilityName="";$scope.patientSearchCriteria.facilityid="0"}}$scope.column1Obj=$scope.currentTemplateObj.column1;$scope.column1Obj.name=updateCorrectionsParam($scope.column1Obj.name);$scope.column2Obj=$scope.currentTemplateObj.column2;$scope.column2Obj.name=updateCorrectionsParam($scope.column2Obj.name);$scope.column3Obj=$scope.currentTemplateObj.column3;$scope.column3Obj.name=updateCorrectionsParam($scope.column3Obj.name);$scope.setMinCharForFilter(true);$scope.setMinCharForFilter(false);if($scope.patientSearchCriteria.searchByStructCol||$scope.patientSearchCriteria.secondSearchByStructCol){$scope.enableSearchIcon=true;$scope.onStructDataSelection(true)}else{$scope.enableSearchIcon=false}};function checkIfGivenFacilityIsAccessibleOrNot(){let facilities=[];if($scope.patientSearchCriteria.enableFacilityAccess){facilities=getMyFacilities().split(',');for(let i=0;i<facilities.length;i++){if(parseInt(facilities[i],10)===$scope.currentTemplateObj.facilityList[0].facilityId){return true}}}else{facilities=getAllFacility();for(let i=0;i<facilities.rows.length;i++){if(parseInt(facilities.rows[i].Id,10)===$scope.currentTemplateObj.facilityList[0].facilityId){return true}}}return false}$scope.setPtLkpColumn=function(columnNo,selectedColumnObj){switch(columnNo){case 1:$scope.column1Obj={id:selectedColumnObj.id,name:selectedColumnObj.name,colId:selectedColumnObj.colId};break;case 2:$scope.column2Obj={id:selectedColumnObj.id,name:selectedColumnObj.name,colId:selectedColumnObj.colId};break;case 3:$scope.column3Obj={id:selectedColumnObj.id,name:selectedColumnObj.name,colId:selectedColumnObj.colId};break}if(!$scope.nonReloadConfigColumnIds.includes(selectedColumnObj.id)){$scope.loadPatientList('searchBtn')}};$scope.mpilookupurl="";$scope.ptSearchObj={};$scope.ptSearchObj.disableFacilityLookup=false;$scope.ptSearchObj.allFacilityPermission=false;$scope.ptSearchObj.myFacilities='';$scope.initPatientSearch=function(){if(typeof $scope.isVoiceEnabledForPtLookup!='undefined'&&$scope.isVoiceEnabledForPtLookup!==null&&$scope.isVoiceEnabledForPtLookup!==''){$scope.patientSearchCriteria.isVoiceEnabledForPtLookup=$scope.isVoiceEnabledForPtLookup}else{$scope.patientSearchCriteria.isVoiceEnabledForPtLookup=false}if(!$scope.isGuarantor){$scope.updateFacilityFilterValues()}$scope.patientSearchCriteria.VMsgIcon=true;if($scope.showTopButtons==='1'){$scope.showNewDeleteButtons=true}else{$scope.showNewDeleteButons=false}if($scope.context.toLowerCase()==="patientnamedlookup"&&$scope.patientName.length>0){$scope.callPatientNamedSearch($scope.patientName)}if($scope.isReturnPtObject){$scope.patientSearchTitle='Click here to select patient '}else{$scope.patientSearchTitle='Click here to launch patient hub for '}$scope.patientSearchCriteria.isModernPtMergeEnable=getItemKeyValue("ModernPatientMerge").toLowerCase()==='yes'};$scope.updateFacilityFilterValues=function(){if($scope.patientSearchCriteria.enableFacilityAccess&&$scope.patientSearchCriteria.defaultFacilityOption&&($scope.patientSearchCriteria.defaultFacilityOption===1||$scope.ptSearchObj.allFacilityPermission&&$scope.patientSearchCriteria.defaultFacilityOption===2)){$scope.ptSearchObj.disableFacilityLookup=true}else{$scope.ptSearchObj.disableFacilityLookup=false}if($scope.patientSearchCriteria.enableFacilityAccess&&$scope.ptSearchObj.allFacilityPermission&&$scope.patientSearchCriteria.defaultFacilityOption===2){$scope.patientSearchCriteria.allFacilities=true}else{$scope.patientSearchCriteria.allFacilities=false}if($scope.patientSearchCriteria.enableFacilityAccess&&$scope.patientSearchCriteria.myOrAllFacs.value===0&&(!$scope.patientSearchCriteria.facilityid||!$scope.patientSearchCriteria.facilityName||$scope.patientSearchCriteria.facilityid==="0"||$scope.patientSearchCriteria.facilityid==="-1"||$scope.patientSearchCriteria.facilityName===""||$scope.patientSearchCriteria.facilityName==="All")){$scope.patientSearchCriteria.facilityName=$scope.primaryServiceLocationName;$scope.patientSearchCriteria.facilityid=$scope.primaryServiceLocationId}if($scope.patientSearchCriteria.enableFacilityAccess){if($scope.ptSearchObj.allFacilityPermission===false&&$scope.patientSearchCriteria.myOrAllFacs.value===2){$scope.patientSearchCriteria.myOrAllFacs=$scope.patientSearchCriteria.facilityOptionsList[1]}if($scope.patientSearchCriteria.myOrAllFacs.value>0){$scope.ptSearchObj.disableFacilityLookup=true}}var checkDefFacForProv=$scope.checkAndSetDefaultFacForProv();if(checkDefFacForProv===0){searchTextTimeout=setTimeout(function(){$('#searchText'+$scope.patientScreenUId).focus()},200)}};$scope.checkAndSetDefaultFacForProv=function(){if(!$scope.isGuarantor){if($scope.patientSearchCriteria.facilityid===0){$scope.patientSearchCriteria.facilityid=$scope.patientSearchCriteria.facilityid.toString()}$scope.facilityName.facility.Name=$scope.patientSearchCriteria.facilityName;$scope.facilityName.facility.Id=$scope.patientSearchCriteria.facilityid;if($scope.patientSearchCriteria.myOrAllFacs.value===0&&(!$scope.patientSearchCriteria.facilityid||$scope.patientSearchCriteria.facilityid==="-1"||!$scope.patientSearchCriteria.facilityName||$scope.patientSearchCriteria.facilityName==="")){showMessageDialog("Please select facility.","eClinicalWorks");return-1}if($scope.ptSearchObj.allFacilityPermission&&$scope.patientSearchCriteria.enableFacilityAccess){return 0}if(!$scope.ptSearchObj.allFacilityPermission&&$scope.patientSearchCriteria.enableFacilityAccess&&$scope.patientSearchCriteria.myOrAllFacs.value!==1&&(!$scope.patientSearchCriteria.facilityid||$scope.patientSearchCriteria.facilityid==="-1"||$scope.patientSearchCriteria.facilityid==="0"||!$scope.patientSearchCriteria.facilityName||$scope.patientSearchCriteria.facilityName===""||$scope.patientSearchCriteria.facilityName==="All")){showMessageDialog("Please select facility.","eClinicalWorks");return-1}else{return 0}}};$scope.callPatientNamedSearch=function(name){$scope.patientSearchCriteria.searchText=decodeForHTML(name);$scope.patientSearchCriteria.searchBy="Name";$scope.patientSearchCriteria.secondSearchBy="DateOfBirth";$scope.setColumnMetadataForPtLkp();$scope.setSearchText()};$scope.CallEhxPatientSearchService=function(){var searchMiniCharLimit=$scope.patientSearchCriteria.miniCharLimit;if(searchMiniCharLimit<3)searchMiniCharLimit=3;if(!($scope.patientSearchCriteria.searchBy==='Name'&&$.trim($scope.patientSearchCriteria.searchText).length>=searchMiniCharLimit||$scope.patientSearchCriteria.secondSearchBy==='DateOfBirth'&&$.trim($scope.patientSearchCriteria.secondSearchValue).length==10||$scope.patientSearchCriteria.searchBy==='DateOfBirth'&&$.trim($scope.patientSearchCriteria.searchText).length==10||$scope.patientSearchCriteria.secondSearchBy==='Name'&&$.trim($scope.patientSearchCriteria.secondSearchValue).length>=searchMiniCharLimit)){$scope.ehxPatientsCount=0;$('#ehxPatientsCountDiv'+$scope.patientScreenUId).removeClass('show').addClass('hide');$('#leftpane'+$scope.patientScreenUId).removeClass('wdt50 pull-left');$('.org-div').removeClass('wdt50 pull-right');$('.org-div').addClass('hide');$scope.ehxHasData=false;return true}$scope.ehxPatientsList=[];$scope.ehxPatientsAppendSearchDone=false;var ehxPatientsStartPos;if(!$scope.ehxPatientsAppendSearch){$scope.ehxPatientsListFull=[];$scope.ehxPatientsCount=0;$scope.ehxPatientsResultForString='';$scope.ehxPatientsStartCount=0;$scope.ehxPatientsPageNo=0;$scope.emrNextClick=false;$scope.emrPrevClick=false;$scope.ehxPatientsNotFoundDivShow=false;ehxPatientsStartPos=$scope.ehxPatientsStartCount}else{ehxPatientsStartPos=$scope.ehxPatientsListFull.length}$scope.ehxPatientsNotFoundDivShow=false;$('#ehxPatientsNotFoundDiv'+$scope.patientScreenUId).removeClass('show').addClass('hide');if(canceler){canceler.promise.status=499;canceler.resolve()}canceler=$q.defer();patientSearchService.callPatientSearchEhx($scope.patientSearchCriteria.searchBy,$scope.patientSearchCriteria.searchText,$scope.patientSearchCriteria.secondSearchBy,$scope.patientSearchCriteria.secondSearchValue,ehxPatientsStartPos,$scope.ehxPatientsMaxRecordsPerSearch,1,'yes',canceler,searchMiniCharLimit).then(function(data,status,headers,config){var x2js=new X2JS;var jsonData=x2js.xml_str2json(data.data);if(jsonData){if(undefined!=jsonData.Envelope.Body['return'].PtList){var value=jsonData.Envelope.Body['return'].PtList.patient;if(!$scope.ehxPatientsAppendSearch){if($scope.ehxPatientsListFull.length>0&&value.length>$scope.ehxPatientsListFull.length){return false}}$scope.ehxPatientsList=[];if(!$scope.ehxPatientsAppendSearch){$scope.ehxPatientsCount=0;$scope.ehxPatientsResultForString='';$scope.ehxPatientsListFull=[];$scope.ehxPatientsStartCount=0;$scope.ehxPatientsPageNo=0;if(value.length===undefined){$scope.ehxPatientsCount=1;$scope.ehxPatientsListFull.push(value)}else{$scope.ehxPatientsCount=value.length;$scope.ehxPatientsListFull=value}}else{if(value.length!==undefined){$scope.ehxPatientsCount+=value.length;$scope.ehxPatientsListFull=$scope.ehxPatientsListFull.concat(value)}}var total=$scope.ehxPatientsStartCount+$scope.ehxPatientsMaxCount;if(total>$scope.ehxPatientsCount){total=$scope.ehxPatientsCount}$scope.ehxPatientsList=[];for(var i=$scope.ehxPatientsStartCount;i<total;i++){$scope.ehxPatientsList.push($scope.ehxPatientsListFull[i])}if(!$scope.ehxPatientsAppendSearch){$scope.ehxPatientsResultForString='Results for "'+$scope.patientSearchCriteria.searchText+'"';if(null!=$scope.patientSearchCriteria.secondSearchValue&&$scope.patientSearchCriteria.secondSearchValue!==''){$scope.ehxPatientsResultForString+=','+$scope.patientSearchCriteria.secondSearchValue}$scope.ehxPatientsResultForString+=' on eEHX';$scope.ehxPatientsStartCount=$scope.ehxPatientsStartCount+$scope.ehxPatientsMaxCount;$scope.ehxPatientsPageNo=1;$scope.ehxEnableDisableNextPrev()}}else{if(!$scope.ehxPatientsAppendSearch){$scope.ehxPatientsCount=0;$scope.ehxPatientsResultForString='';$scope.ehxPatientsList=[];$scope.ehxPatientsListFull=[];$scope.ehxPatientsStartCount=0;$scope.ehxPatientsPageNo=0;if(undefined!==jsonData.Envelope.Body['return'].status&&jsonData.Envelope.Body['return'].status==="failed"){if($scope.ehxPatientsNotFoundDivShow===false){$('#ehxPatientsNotFoundDiv'+$scope.patientScreenUId).removeClass('hide').addClass('show');$scope.ehxPatientsNotFoundDivShow=true}}}else{$scope.ehxPatientsAppendSearchDone=true}}if(!$scope.ehxPatientsAppendSearch){if($scope.ehxPatientsCount==0){$('#ehxPatientsCountDiv'+$scope.patientScreenUId).removeClass('show').addClass('hide');$('#leftpane'+$scope.patientScreenUId).removeClass('wdt50 pull-left');$('.org-div').removeClass('wdt50 pull-right');$('.org-div').addClass('hide');$scope.ehxHasData=false}if($scope.ehxPatientsCount>0&&$scope.ehxHasData==false){$('#ehxPatientsCountDiv'+$scope.patientScreenUId).removeClass('hide').addClass('show');$('#leftpane'+$scope.patientScreenUId).removeClass('wdt50 pull-left');$('.org-div').removeClass('wdt50 pull-right');$('.org-div').addClass('hide')}}}else{if(!$scope.ehxPatientsAppendSearch){$scope.ehxHasData=false}}if($scope.ehxPatientsAppendSearch){$scope.ehxPatientListNextPage()}},function errorCallback(error){var statusCode=error.status;if(error.config.timeout){statusCode=error.config.timeout.status}if(statusCode!==499){$scope.showMessage("Error while loading Patient List")}})};$scope.ehxShowData=function(){$scope.ehxHasData=true};$scope.selectEhxPatient=function(index){document.getElementById('ehxSelectedPatient'+index+$scope.patientScreenUId).checked=true};$scope.setColumnMetadataForPtLkp=function(){if("Name"===$scope.patientSearchCriteria.searchBy&&"DateOfBirth"===$scope.patientSearchCriteria.secondSearchBy){$scope.patientSearchCriteria.searchBy=$scope.searchByOptionsForName.id;$scope.patientSearchCriteria.searchByColId=$scope.searchByOptionsForName.colId;$scope.patientSearchCriteria.searchByName=$scope.searchByOptionsForName.name;$scope.patientSearchCriteria.searchByPlaceHolder=$scope.searchByOptionsForName.placeholder;$scope.patientSearchCriteria.secondSearchBy=$scope.searchByOptionsForDateOfBirth.id;$scope.patientSearchCriteria.secondSearchByColId=$scope.searchByOptionsForDateOfBirth.colId;$scope.patientSearchCriteria.secondSearchByName=$scope.searchByOptionsForDateOfBirth.name;$scope.patientSearchCriteria.secondSearchByPlaceHolder=$scope.searchByOptionsForDateOfBirth.placeholder;$scope.setMinCharForFilter(false)}};$scope.loadPatientList=function(context){if(!$scope.patientSearchCriteria.searchByStructCol&&!$scope.patientSearchCriteria.secondSearchByStructCol){$scope.enableSearchIcon=false}else{$scope.enableSearchIcon=true;if('searchBtn'!==context&&'pagination'!==context){return}}$scope.setColumnMetadataForPtLkp();$scope.dirtyCheck=false;if(timer&&timer!==''){$timeout.cancel(timer)}if(!isLoading){$scope.patientList=[];if(Object.keys($scope.patientSearch.selectedPatient).length===0){$scope.patientSearch.selectedIndex=0;$scope.patientSearch.selectedPatient={}}$("#patient-search-loader-block"+$scope.patientScreenUId).show();timer=$timeout(function(){isLoading=true;var searchByStructData=$scope.patientSearchCriteria.searchBy.startsWith("StructData");var url="/mobiledoc/jsp/catalog/xml/getPatients.jsp";var data={counter:$scope.patientSearchCriteria.counter,firstName:$scope.patientSearchCriteria.firstName,lastName:$scope.patientSearchCriteria.lastName,DOB:$scope.patientSearchCriteria.dob,SSN:$scope.patientSearchCriteria.SSN,AccountNo:$scope.patientSearchCriteria.controlNo,PhoneNo:$scope.patientSearchCriteria.PhoneNo,PreviousName:$scope.patientSearchCriteria.PreviousName,MedicalRecNo:$scope.patientSearchCriteria.MRN,StatusSearch:$scope.patientSearchCriteria.status,enc:$scope.patientSearchCriteria.includeApptFacility,limitstart:$scope.patientSearchCriteria.limitStart,limitrange:$scope.patientSearchCriteria.limitRange,SubscriberNo:$scope.patientSearchCriteria.SubscriberNo,AddlSearchBy:$scope.patientSearchCriteria.secondSearchBy,AddlSearchVal:$scope.patientSearchCriteria.secondSearchValue,MAXCOUNT:$scope.patientSearchMaxRecord,column1:$scope.column1Obj.id,column2:$scope.column2Obj.id,column3:$scope.column3Obj.id,primarySearchValue:$scope.patientSearchCriteria.searchText,device:"webemr",callFromScreen:'PatientSearch',userType:$scope.patientSearchCriteria.userType,action:$scope.actionName};if(searchByStructData){data.StructData=$scope.patientSearchCriteria.searchText;data.StructName=$scope.patientSearchCriteria.searchByName;if(data.StructName.includes("...")){data.StructId=$scope.patientSearchCriteria.searchBy.substring("StructData_".length)}data.SearchBy="StructData"}if(!$scope.isGuarantor&&$scope.patientSearchCriteria.facilityid!=="0"&&$scope.patientSearchCriteria.myOrAllFacs.value!==2){if($scope.patientSearchCriteria.myOrAllFacs.value===1){if(!$scope.ptSearchObj.myFacilities||$scope.ptSearchObj.myFacilities===''){$scope.ptSearchObj.myFacilities=getMyFacilities()}data.FacilityID=$scope.ptSearchObj.myFacilities}else{data.FacilityID=$scope.patientSearchCriteria.facilityid}if(!searchByStructData){data.SearchBy=$scope.patientSearchCriteria.searchBy+"_FacilityID"}}else{if(!searchByStructData){data.SearchBy=$scope.patientSearchCriteria.searchBy;data.orderBy=$scope.patientSearchCriteria.orderBy}}if(!$scope.isGuarantor&&$scope.patientSearchCriteria.enableFacilityAccess){if($scope.patientSearchCriteria.myOrAllFacs.value===2||$scope.patientSearchCriteria.myOrAllFacs.value===0){data.MyOrAllFacs=$scope.patientSearchCriteria.myOrAllFacs.value-1}else{data.myFacility=true}}if($scope.patientSearchCriteria.enableCorrectionalFeatures){data.NYCIDNo=$scope.patientSearchCriteria.sidNum;data.BookAndCaseNo=$scope.patientSearchCriteria.bcNum}patientSearchService.callPatientSearch(url,data).then(function(data,status,headers,config){var x2js=new X2JS;var jsonData=x2js.xml_str2json($.trim(data.data));if(jsonData&&!(jsonData.Envelope.Body["return"].hasOwnProperty("status")&&jsonData.Envelope.Body["return"].status==="failed")){var value=jsonData.Envelope.Body['return'].patient;if(value){if(value.length>0){$scope.patientList=[];$scope.patientList=value}else{$scope.patientList=[];$scope.patientList.push(value)}setSsnvalue();if($scope.patientSearchCriteria.enableCorrectionalFeatures){angular.forEach($scope.patientList,function(obj,index){obj.tooltipVal=obj.PastBooknCaseList?obj.name+"\n"+$scope.config.SIDLabel+": "+obj.NYCIDNo+"\nPast "+$scope.config.BnCLabel+": "+obj.PastBooknCaseList.replace(/, /g,"\n"):obj.name+"\n"+$scope.config.SIDLabel+": "+obj.NYCIDNo})}if(context&&context==="ptInfo"&&$scope.patientSearch.selectedIndex){if(!($scope.patientList.length>$scope.patientSearch.selectedIndex)){$scope.patientSearch.selectedIndex=0}$scope.setSelectedPatient($scope.patientList[$scope.patientSearch.selectedIndex],$scope.patientSearch.selectedIndex)}else if(context&&context==='ptSearch'&&$scope.patientSearch.selectedIndex){$scope.setSelectedPatient($scope.patientList[$scope.patientSearch.selectedIndex],$scope.patientSearch.selectedIndex)}else{$scope.setSelectedPatient($scope.patientList[0],0)}}else{$scope.patientList=[];$scope.patientSearch.selectedPatient={}}if($scope.patientSearchCriteria.enableEhxColumn===true){$scope.getEhxIconColors($.trim(data.data))}}else{$scope.showMessage($scope.patientLookupConst.loadingErrorMessage)}$("#patient-search-loader-block"+$scope.patientScreenUId).hide();$('.lookuptablescroll').scrollTop(0).perfectScrollbar('update')},function(){$("#patient-search-loader-block"+$scope.patientScreenUId).hide();$scope.showMessage("Error while loading Patient List")});if($scope.patientSearchCriteria.enableEhxColumn===true&&$scope.b3rdPartyPortal.toLowerCase()!=='yes'){if($scope.ehxHasData&&($scope.emrNextClick||$scope.emrPrevClick)){$('#leftpane'+$scope.patientScreenUId).addClass('wdt50 pull-left');var ehxLinkButton=$('#ehxLinkButton'+$scope.patientScreenUId);ehxLinkButton.removeClass('hide');ehxLinkButton.addClass('mr5');$('#commentButton'+$scope.patientScreenUId).removeClass('mr5');$('#ehxPatientsCountDiv'+$scope.patientScreenUId).removeClass('show').addClass('hide');var orgDiv=$('.org-div');orgDiv.addClass('wdt50 pull-right');orgDiv.removeClass('hide');$scope.emrNextClick=false;$scope.emrPrevClick=false}else{$scope.ehxPatientsAppendSearch=false;$scope.CallEhxPatientSearchService()}}isLoading=false},500)}};function setSsnvalue(){if("Hide Entire SSN"===$scope.ptLookUpSSNItemkey){angular.forEach($scope.patientList,function(obj,index){if(obj.SSN!=="")obj.SSN=obj.SSN.replace(/[\d]/g,"*")})}else if("Show Last 4 Digits Only"===$scope.ptLookUpSSNItemkey){angular.forEach($scope.patientList,function(obj,index){if(obj.SSN!=="")obj.SSN="***-**"+obj.SSN.substring(6,20)})}}$scope.getEhxIconColors=function(strXML){if($scope.patientList.length>0){var url="/mobiledoc/jsp/webemr/empi/patientSearch/getEhxIconColor.jsp";var data={'strXML':escapeXml(strXML)};var promise=ehxCommonFuncsGetPromiseForAjax(url,data);promise.then(function(response){response=$.trim(response);response=JSON.parse(response);$.each($scope.patientList,function(k,v){v.ehxIconColor=response[v.id];if(response[v.id]==='icon icon-link-green'){v.ehxIconTitle='Patient has consented to share Demographic and Clinical Data via eHX'}else if(response[v.id]==='icon icon-link-orange'){v.ehxIconTitle='Patient consent to share data will expire within one month via eHX'}else if(response[v.id]==='icon icon-link-broken-red'){v.ehxIconTitle='Patient has not consented to share any data via eHX'}else if(response[v.id]==='icon icon-link-orangeexp'){v.ehxIconTitle='Patient consent to share data via eHX is expired'}else if(response[v.id]==='icon icon-link-blue'){v.ehxIconTitle='Patient has consented to share only Demographic Data via eHX'}else if(response[v.id]==='icon icon-link-emergency'){v.ehxIconTitle='Emergency Access is needed for Patient via eHX'}else if(response[v.id]==='icon icon-link-verify'){v.ehxIconTitle='Patient has not decided whether to consent to share data via eHX'}});if($scope.$$phase!='$apply'&&$scope.$$phase!='$digest'){$scope.$apply()}},function(errorMsg){showMessage("Error connecting EHX server, Please try again later.")})}};$scope.importPatientFromEhx=function(empi,name){var promisePtDataObj=patientSearchService.importPatientFromEhx(empi);promisePtDataObj.then(function(result){if(result!=='Notconfirmed'){$scope.patientSearch.selectedPatient={};$scope.patientSearch.selectedPatient.id=result;$scope.patientSearch.selectedPatient.name=name;$scope.openPatientInformation();$scope.ehxPatientsAppendSearch=false;$scope.CallEhxPatientSearchService();var tmpName=name.replace(' ','');var arrName=tmpName.split(',');$scope.patientSearchCriteria.searchText=name;$scope.patientSearchCriteria.firstName=arrName[1];$scope.patientSearchCriteria.lastName=arrName[0];$scope.loadPatientList()}},function(errorMsg){console.log("importPatientFromEhx promise req while getting data from server, rejected from importPatientFromEhx service")})};$scope.linkEhxEmrPatient=function(){var permission=hasPermission("eHXImportedDemo");if(permission===false||permission===""){$scope.showMessage("You don't have the permission to Link patients. Please contact your administrator for permission.");return false}var ecwEmpi=$('input[name=ehxSelectedPatient'+$scope.patientScreenUId+']:checked').val();var pid=$scope.patientSearch.selectedPatient.id;var linkPtPromise=getPromiseForPtEhxData(pid,global.TrUserId,'empiColor',"documentView");linkPtPromise.then(function(respPatientConsent){if(respPatientConsent===''){if(ecwEmpi!=undefined&&ecwEmpi!=null&&ecwEmpi!=''&&pid!=undefined&&pid!=null&&pid!=''){BootstrapDialog.confirm("Do you want to link the local patient with the patient at eHX that you have selected?",function(result){if(result===true){var strPracticeCode=getThisPracticeCode();var exportPromise=linkPtDemoDataWebE(pid,ecwEmpi);exportPromise.then(function(responseMessage){$scope.showMessage(responseMessage)},function(errorMsg){$scope.showMessage(errorMsg)});resetPromiseForPtEhxData();$scope.ehxPatientsAppendSearch=false;$scope.CallEhxPatientSearchService();$scope.patientSearchCriteria.searchText=$scope.patientSearch.selectedPatient.name;$scope.patientSearchCriteria.firstName=$scope.patientSearch.selectedPatient.fname;$scope.patientSearchCriteria.lastName=$scope.patientSearch.selectedPatient.lname;$scope.loadPatientList()}})}}else{$scope.showMessage("The patient is already linked to eEHX.")}},function(errorMsg){$scope.showMessage("Error connecting EHX server, while getting Patient Consent.")})};$scope.viewPatientInfoFromEhx=function(empi){var permission=hasPermission("eHXImportedDemo");if(permission===false||permission===""){$scope.showMessage("You don't have the permission to view eHX patient demographics. Please contact your administrator for permission.");return false}var myDocumentURL="/mobiledoc/jsp/webemr/empi/viewPtInfoFromEhx.jsp?empi="+empi;var url=makeURL(myDocumentURL);$scope.linkPtInfoFromEhx=url};$scope.ehxPatientListNextClick=function(){if($scope.ehxPatientsStartCount>0&&!$scope.ehxPatientsAppendSearchDone&&$scope.ehxPatientsListFull.length-$scope.ehxPatientsStartCount<=$scope.ehxPatientsMaxCount&&$scope.ehxPatientsListFull.length%($scope.ehxPatientsMaxRecordsPerSearch+1)==0){$scope.ehxPatientsAppendSearch=true;$scope.CallEhxPatientSearchService()}else{$scope.ehxPatientListNextPage()}};$scope.ehxPatientListNextPage=function(){if($scope.ehxPatientsStartCount<=$scope.ehxPatientsListFull.length){$('input[name=ehxSelectedPatient'+$scope.patientScreenUId+']:checked').attr('checked',false);var total=$scope.ehxPatientsStartCount+$scope.ehxPatientsMaxCount;if(total>$scope.ehxPatientsListFull.length){total=$scope.ehxPatientsListFull.length}$scope.ehxPatientsList=[];for(var i=$scope.ehxPatientsStartCount;i<total;i++){$scope.ehxPatientsList.push($scope.ehxPatientsListFull[i])}$scope.ehxPatientsStartCount=$scope.ehxPatientsStartCount+$scope.ehxPatientsMaxCount;if($scope.ehxPatientsStartCount>$scope.ehxPatientsListFull.length){$scope.ehxPatientsStartCount=$scope.ehxPatientsListFull.length}$scope.ehxPatientsPageNo=$scope.ehxPatientsPageNo+1;$('#ehxLinkButton'+$scope.patientScreenUId).attr('disabled','disabled')}$scope.ehxEnableDisableNextPrev()};$scope.ehxPatientListPrevClick=function(){var reminder=0;if($scope.ehxPatientsStartCount%$scope.ehxPatientsMaxCount>0){reminder=$scope.ehxPatientsStartCount%$scope.ehxPatientsMaxCount}if($scope.ehxPatientsStartCount>=$scope.ehxPatientsMaxCount){$('input[name=ehxSelectedPatient'+$scope.patientScreenUId+']:checked').attr('checked',false);var start=0;if(reminder>0)start=$scope.ehxPatientsStartCount-$scope.ehxPatientsMaxCount-reminder;else start=$scope.ehxPatientsStartCount-$scope.ehxPatientsMaxCount*2;var total=start+$scope.ehxPatientsMaxCount;$scope.ehxPatientsList=[];for(var i=start;i<total;i++){$scope.ehxPatientsList.push($scope.ehxPatientsListFull[i])}$scope.ehxPatientsStartCount=total;$scope.ehxPatientsPageNo=$scope.ehxPatientsPageNo-1;$('#ehxLinkButton'+$scope.patientScreenUId).attr('disabled','disabled')}$scope.ehxEnableDisableNextPrev()};$scope.ehxEnableDisableNextPrev=function(){if($scope.ehxPatientsStartCount>=$scope.ehxPatientsListFull.length){$scope.ehxDisableNext=true}else{$scope.ehxDisableNext=false}if($scope.ehxPatientsStartCount<=$scope.ehxPatientsMaxCount){$scope.ehxDisablePrev=true}else{$scope.ehxDisablePrev=false}};$scope.closeSettingDialogue=function(){$('#ptsetting'+$scope.patientScreenUId).removeClass("open")};$scope.reLoadPatientList=function(context){$scope.patientSearchCriteria.counter=1;$scope.patientSearchCriteria.limitStart=0;$scope.patientSearchCriteria.limitRange=$scope.patientSearchMaxRecord;$scope.loadPatientList(context)};$scope.getGlobalAlertStyle=function(patient){var colorCode=patient.GlobalAlertStatusColorCode;colorCode=decimalColorToHTMLcolor(colorCode);return{"background-color":colorCode}};$scope.openPtTemplateListPopup=function(){$scope.selectedTemplateToApply=0;$scope.userTemplateName="";$scope.templateNameSearchText.templateName="";$("#ptLkptemplateListPopup"+$scope.patientScreenUId).removeClass('hidden');$('#savePtLkptemplatePopup'+$scope.patientScreenUId).addClass('hidden')};$scope.closePtTemplateListPopup=function(){$scope.selectedTemplateToApply=0;$scope.templateNameSearchText.templateName="";$('#ptLkptemplateListPopup'+$scope.patientScreenUId).addClass('hidden')};$scope.openSaveAsPtTemplatePopup=function(){$scope.selectedTemplateToApply=0;$scope.userTemplateName="";$scope.templateNameSearchText.templateName="";$("#savePtLkptemplatePopup"+$scope.patientScreenUId).removeClass('hidden');$('#ptLkptemplateListPopup'+$scope.patientScreenUId).addClass('hidden')};$scope.closeSaveAsPtTemplatePopup=function(){$scope.userTemplateName="";$('#savePtLkptemplatePopup'+$scope.patientScreenUId).addClass('hidden')};$scope.saveUserPtTemplate=function(){var templateData={templateName:$scope.userTemplateName,primaryFilter:$scope.patientSearchCriteria.searchByColId,secondaryFilter:$scope.patientSearchCriteria.secondSearchByColId,column1:$scope.column1Obj.colId,column2:$scope.column2Obj.colId,column3:$scope.column3Obj.colId,patientStatus:$scope.patientSearchCriteria.status,userType:$scope.patientSearchCriteria.userType,isGuarantor:$scope.isGuarantor,isDefault:$scope.isDefault};if(!$scope.isGuarantor){templateData.isAppointFacility=$scope.patientSearchCriteria.includeApptFacility;templateData.myOrAllFacility=$scope.patientSearchCriteria.myOrAllFacs.value;templateData.facilityIds=$scope.patientSearchCriteria.facilityid}patientSearchService.saveUserPtTemplate(templateData).then(function(data){if(data&&data.data&&data.data.status==="success"&&data.data.result>0){const templateType=templateData.isGuarantor?4:1;const templateTypeText=templateData.isGuarantor?"G":"U";$scope.templateList.push({templateId:data.data.result,templateName:templateData.templateName,templateType:templateType,templateTypeText:templateTypeText});toaster.pop("success",data.data.message?data.data.message:"Patient Lookup Template Saved Successfully.","",2e3);$('#savePtLkptemplatePopup'+$scope.patientScreenUId).addClass('hidden');$scope.userTemplateName="";if(templateData.isDefault===1){$scope.defaultTemplateId=data.data.result}}else{if(data.data.status==="Duplicate"){showAlertMessage("<div class='text-left mt-20'><div class='mb10'><b>Duplicate Template Name</b></div>A template has already been created with the name <b>["+$scope.userTemplateName+"]</b>. Please use a different name.</div>","savetemplateinput","ErrorMsg")}else{showAlertMessage("<div class='text-left mt-20'>Error occurred while saving template.</div>","","ErrorMsg")}}},function(){showAlertMessage("<div class='text-left mt-20'>Error occurred while saving template.</div>","","ErrorMsg")})};$scope.selectPtLkpTemplateToApply=function(templateId){$scope.selectedTemplateToApply=templateId};$scope.applySelectedPtLkpTemplate=function(){if($scope.selectedTemplateToApply>0){$(".ptlkp-disable").addClass("active");patientSearchService.getTemplateDetails({templateId:$scope.selectedTemplateToApply}).then(function(data){$(".ptlkp-disable").removeClass("active");if(data&&data.data&&data.data.status==="success"&&data.data.result){$scope.patientSearchCriteria.searchText="";$scope.patientSearchCriteria.secondSearchValue="";$scope.currentTemplateObj=data.data.result;$scope.applyReceivedTemplate();$scope.updateFacilityFilterValues();$scope.reLoadPatientList()}else{showAlertMessage("<div class='text-left mt-20'>Error occurred while getting template details.</div>","","ErrorMsg")}},function(){$(".ptlkp-disable").removeClass("active");showAlertMessage("<div class='text-left mt-20'>Error occurred while getting template details.</div>","","ErrorMsg")})}else{showAlertMessage("<div class='text-left mt-20'>Invalid template data received.</div>","","ErrorMsg")}$scope.selectedTemplateToApply=0;$scope.templateNameSearchText.templateName="";$('#ptLkptemplateListPopup'+$scope.patientScreenUId).addClass('hidden')};$scope.deletePtLkpTemplate=function(template){if(template&&(template.templateType===1||template.templateType===4)&&template.templateId>0){$scope.ptLkpTemplateToDelete=template;showAlertMessage("<div class='text-left mt-20'>Are you sure to delete <b>"+template.templateName+"</b> template?</div>",'','ConfirmMsg','confirmDeletePtLkpTemplate','patient-lookup-screen'+$scope.patientScreenUId)}else{showAlertMessage("<div class='text-left mt-20'>Invalid template data received.</div>","","ErrorMsg")}};$scope.confirmDeletePtLkpTemplate=function(data){if(data==="yes"){patientSearchService.deletePtLkpTemplate({templateId:$scope.ptLkpTemplateToDelete.templateId,isGuarantor:$scope.isGuarantor}).then(function(data){if(data&&data.data&&data.data.status==="success"){for(var i=0;i<$scope.templateList.length;i++){if($scope.templateList[i].templateId&&$scope.templateList[i].templateId===$scope.ptLkpTemplateToDelete.templateId){$scope.templateList.splice(i,1);break}}toaster.pop("success",data.data.message?data.data.message:$scope.isGuarantor?"Guarantor":"Patient"+" Lookup Template Deleted Successfully.","",2e3)}else{showAlertMessage("<div class='text-left mt-20'>Error occurred while deleting template.</div>","","ErrorMsg")}},function(){showAlertMessage("<div class='text-left mt-20'>Error occurred while deleting template.</div>","","ErrorMsg")})}};$scope.setDefaultPtLkpTemplate=function(template){if(template&&template.templateId>0){$scope.ptLkpTemplateToSetAsDefault=template;showAlertMessage("<div class='text-left mt-20'>Are you sure to select <b>"+template.templateName+"</b> as your default template?</div>",'','ConfirmMsg','confirmSetDefaultPtLkpTemplate','patient-lookup-screen'+$scope.patientScreenUId)}else{showAlertMessage("<div class='text-left mt-20'>Invalid template data received.</div>","","ErrorMsg")}};$scope.confirmSetDefaultPtLkpTemplate=function(userAction){if(userAction==="yes"){patientSearchService.setDefaultPtLkpTemplate({templateId:$scope.ptLkpTemplateToSetAsDefault.templateId,templateType:$scope.ptLkpTemplateToSetAsDefault.templateType}).then(function(data){if(data&&data.data&&data.data.status==="success"){$scope.defaultTemplateId=$scope.ptLkpTemplateToSetAsDefault.templateId;toaster.pop("success",data.data.message?data.data.message:"Default Template Saved Successfully.","",2e3)}else{showAlertMessage("<div class='text-left mt-20'>Error occurred while setting default template.</div>","","ErrorMsg")}},function(){showAlertMessage("<div class='text-left mt-20'>Error occurred while setting default template.</div>","","ErrorMsg")})}};$scope.setSecondSearchBy=function(secondSearchOption){$scope.patientSearchCriteria.secondSearchBy=secondSearchOption.id;$scope.patientSearchCriteria.secondSearchByColId=secondSearchOption.colId;$scope.patientSearchCriteria.secondSearchByName=secondSearchOption.name;$scope.patientSearchCriteria.secondSearchByPlaceHolder=secondSearchOption.placeholder;$scope.patientSearchCriteria.secondSearchByStructCol=secondSearchOption.isStructCol;$scope.patientSearchCriteria.secondSearchValue="";$scope.patientList=[];$scope.patientSearch.selectedPatient={};$scope.setSearchText();$scope.setMinCharForFilter(false)};$scope.setSearchBy=function(searchOption){$scope.patientSearchCriteria.searchBy=searchOption.id;$scope.patientSearchCriteria.searchByColId=searchOption.colId;$scope.patientSearchCriteria.searchByName=searchOption.name;$scope.patientSearchCriteria.searchByPlaceHolder=searchOption.placeholder;$scope.patientSearchCriteria.searchByStructCol=searchOption.isStructCol;$scope.patientSearchCriteria.searchText="";$scope.patientList=[];$scope.patientSearch.selectedPatient={};$scope.setSearchText();$scope.setMinCharForFilter(true)};$scope.setMinCharForFilter=function(isPrimary){if(isPrimary){$scope.patientSearchCriteria.priMinCharLenWithMasking=0;$scope.patientSearchCriteria.priMinCharLen=0;if($scope.patientSearchCriteria.searchBy==='AllPhones'||$scope.patientSearchCriteria.searchBy==='GrPhone'){$scope.patientSearchCriteria.priMinCharLenWithMasking=$scope.patientSearchCriteria.phoneNoPtLookupMinCharWithMasking;$scope.patientSearchCriteria.priMinCharLen=$scope.patientSearchCriteria.phoneNoPtLookupMinChar}else if($scope.patientSearchCriteria.searchBy==='DateOfBirth'){$scope.patientSearchCriteria.priMinCharLenWithMasking=$scope.patientSearchCriteria.dobPtLookupMinCharWithMasking;$scope.patientSearchCriteria.priMinCharLen=$scope.patientSearchCriteria.dobPtLookupMinChar}}else{$scope.patientSearchCriteria.secMinCharLenWithMasking=0;$scope.patientSearchCriteria.secMinCharLen=0;if($scope.patientSearchCriteria.secondSearchBy==='AllPhones'||$scope.patientSearchCriteria.secondSearchBy==='GrPhone'){$scope.patientSearchCriteria.secMinCharLenWithMasking=$scope.patientSearchCriteria.phoneNoPtLookupMinCharWithMasking;$scope.patientSearchCriteria.secMinCharLen=$scope.patientSearchCriteria.phoneNoPtLookupMinChar}else if($scope.patientSearchCriteria.secondSearchBy==='DateOfBirth'){$scope.patientSearchCriteria.secMinCharLenWithMasking=$scope.patientSearchCriteria.dobPtLookupMinCharWithMasking;$scope.patientSearchCriteria.secMinCharLen=$scope.patientSearchCriteria.dobPtLookupMinChar}}};$scope.setSearchText=function(){var name="";$scope.patientSearchCriteria.dob="";$scope.patientSearchCriteria.PhoneNo="";$scope.patientSearchCriteria.controlNo="";$scope.patientSearchCriteria.SubscriberNo="";$scope.patientSearchCriteria.MRN="";$scope.patientSearchCriteria.SSN="";$scope.patientSearchCriteria.PreviousName="";$scope.patientSearchCriteria.GrName="";$scope.patientSearchCriteria.firstName="";$scope.patientSearchCriteria.lastName="";$scope.patientSearchCriteria.StructName="";$scope.patientSearchCriteria.sidNum="";$scope.patientSearchCriteria.bcNum="";if($scope.patientSearchCriteria.searchText&&($scope.patientSearchCriteria.searchBy==="AllPhones"||$scope.patientSearchCriteria.searchBy==="GrPhone"||$scope.patientSearchCriteria.searchBy==='DateOfBirth')&&$scope.patientSearchCriteria.searchText.length<$scope.patientSearchCriteria.priMinCharLenWithMasking||$scope.patientSearchCriteria.secondSearchValue&&($scope.patientSearchCriteria.secondSearchBy==="AllPhones"||$scope.patientSearchCriteria.secondSearchBy==="GrPhone"||$scope.patientSearchCriteria.secondSearchBy==='DateOfBirth')&&$scope.patientSearchCriteria.secondSearchValue.length<$scope.patientSearchCriteria.secMinCharLenWithMasking){return}if(!$scope.isGuarantor&&($scope.patientSearchCriteria.searchText.length>=$scope.patientSearchCriteria.miniCharLimit||$scope.patientSearchCriteria.secondSearchValue.length>=$scope.patientSearchCriteria.miniCharLimit)||$scope.isGuarantor&&($scope.patientSearchCriteria.searchText.length>=$scope.patientSearchCriteria.minimumCharGuarantorLookup||$scope.patientSearchCriteria.secondSearchValue.length>=$scope.patientSearchCriteria.minimumCharGuarantorLookup)){if($scope.patientSearchCriteria.searchBy==='Name'||$scope.patientSearchCriteria.searchBy==='GrName'){if($scope.patientSearchCriteria.searchText){name=$scope.patientSearchCriteria.searchText.split(",")}if(name.length>1){$scope.patientSearchCriteria.firstName=name[1].trim();$scope.patientSearchCriteria.lastName=name[0].trim()}else if(name.length===1){$scope.patientSearchCriteria.firstName="";$scope.patientSearchCriteria.lastName=name[0].trim()}else{$scope.patientSearchCriteria.firstName="";$scope.patientSearchCriteria.lastName=""}}else if($scope.patientSearchCriteria.searchBy==='DateOfBirth'){$scope.patientSearchCriteria.dob=$scope.patientSearchCriteria.searchText}else if($scope.patientSearchCriteria.searchBy==='PhoneNo'||$scope.patientSearchCriteria.searchBy==='AllPhones'){$scope.patientSearchCriteria.PhoneNo=$scope.patientSearchCriteria.searchText}else if($scope.patientSearchCriteria.searchBy==='AccountNo'){$scope.patientSearchCriteria.controlNo=$scope.patientSearchCriteria.searchText}else if($scope.patientSearchCriteria.searchBy==='SubscriberNo'){$scope.patientSearchCriteria.SubscriberNo=$scope.patientSearchCriteria.searchText}else if($scope.patientSearchCriteria.searchBy==='MedicalRecNo'){$scope.patientSearchCriteria.MRN=$scope.patientSearchCriteria.searchText}else if($scope.patientSearchCriteria.searchBy==='SSN'){$scope.patientSearchCriteria.SSN=$scope.patientSearchCriteria.searchText}else if($scope.patientSearchCriteria.searchBy==='PreviousName'){$scope.patientSearchCriteria.PreviousName=$scope.patientSearchCriteria.searchText}else if($scope.patientSearchCriteria.searchBy.startsWith("StructData")){$scope.patientSearchCriteria.StructName=$scope.patientSearchCriteria.searchByName;$scope.patientSearchCriteria.StructId=$scope.patientSearchCriteria.searchBy}if($scope.patientSearchCriteria.enableCorrectionalFeatures){if($scope.patientSearchCriteria.searchBy==='NYCIDNo'){$scope.patientSearchCriteria.sidNum=$scope.patientSearchCriteria.searchText}else if($scope.patientSearchCriteria.searchBy==='BookAndCaseNo'){$scope.patientSearchCriteria.bcNum=$scope.patientSearchCriteria.searchText}}$scope.patientSearch.selectedIndex=0;$scope.patientSearch.selectedPatient={};$scope.reLoadPatientList()}};$scope.hidePatientModal=function(){patientGlobalObj=null;$timeout.cancel(timer);$timeout.cancel(deletePatientTimer);$scope.closeCustomToaster();$timeout.cancel(toasterTimer);clearTimeout(searchTextTimeout);clearTimeout(medicScanTimeout);clearTimeout(medicScanPhotoTimeout);$('#rule-table1 tbody tr'+$scope.patientScreenUId).off('click');$('#rule-table2 tbody tr'+$scope.patientScreenUId).off('click');$('#pt-lookup-modal-dialog'+$scope.patientScreenUId).off('keydown');$('#viewmore'+$scope.patientScreenUId).off('click');var patientLookupScreenDiv=$('#patient-lookup-screen'+$scope.patientScreenUId);patientLookupScreenDiv.find('.modal-dialog').draggable('destroy');patientLookupScreenDiv.removeClass('fade');patientLookupScreenDiv.modal('hide');patientLookupScreenDiv.remove();patientSearchService.setOpen(false);$scope.showToasterMessage=false};$scope.removePatientSearchController=function(context){if(context==="JELLY_BEAN_PANEL"){angular.element("[ng-controller=patientSearchController]").remove()}};$scope.removeBackdrop=function(){$('.modal-backdrop.fade').last().remove();if($('.modal.in:visible').length==0){$('.modal-backdrop.fade').remove()}};function getXmlToJsonData(data){var x2js=new X2JS;return x2js.xml_str2json($.trim(data))}$scope.formatDate=function(date){if(date==''){return''}else{return yyyymmddTommddyyyy(date)}};$scope.deletePatientClicked=function(patient){if(deletePatientTimer&&deletePatientTimer!==""){$timeout.cancel(deletePatientTimer)}if(!$scope.deletePatientPermission){deletePatientTimer=$timeout(function(){showAlertMessage("<div class='text-left mt-20'><b>Access Denied</b><br><br>To gain access to this feature your administrator must enable the Security Attribute:<br><b>Delete Patient</b></div>","","ErrorMsg")},150);return false}if(patient&&patient.name){$scope.patientSearch.deletedPatient=patient;showAlertMessage("<div class='text-left mt-20'><b>Confirm Delete Patient</b><br><br>Are you sure you want to delete the patient:<br>"+$scope.patientSearch.deletedPatient.name+"?<br><br></div>",'','ConfirmMsg','callBackToDeletePatient','patientSearchController')}else{showAlertMessage("<div class='text-left mt-20'>Please select a patient and try again !</div>","","AlertMsg")}};$scope.changePatientSearchMaxRecordSize=function(size){if(size===$scope.patientSearchMaxRecord){return}$scope.patientSearchMaxRecord=size;$scope.patientSearchCriteria.counter=1;$scope.patientSearchCriteria.limitStart=0;$scope.patientSearchCriteria.limitRange=$scope.patientSearchMaxRecord;$scope.loadPatientList('pagination')};$scope.prevClick=function(){$scope.patientSearchCriteria.counter-=$scope.patientSearchMaxRecord;$scope.patientSearchCriteria.limitStart-=$scope.patientSearchMaxRecord;$scope.patientSearchCriteria.limitRange-=$scope.patientSearchMaxRecord;$scope.emrPrevClick=true;$scope.patientSearch.selectedIndex=0;$scope.patientSearch.selectedPatient={};$scope.loadPatientList('pagination')};$scope.nextClick=function(){$scope.patientSearchCriteria.counter+=$scope.patientSearchMaxRecord;$scope.patientSearchCriteria.limitStart+=$scope.patientSearchMaxRecord;$scope.patientSearchCriteria.limitRange+=$scope.patientSearchMaxRecord;$scope.emrNextClick=true;$scope.patientSearch.selectedIndex=0;$scope.patientSearch.selectedPatient={};$scope.loadPatientList('pagination')};$scope.closeDialogue=function(){$scope.patientSearch.encCount=0;$('.option-dialog').hide()};$scope.facilityClick=function(){$scope.patientSearchCriteria.facilityName=$scope.facilityName.facility.Name;$scope.patientSearchCriteria.facilityid=$.trim($scope.facilityName.facility.Id);if($scope.facilityName.facility.Id==='0'||$scope.facilityName.facility.Name===''||$scope.facilityName.facility.Name==='All'){$scope.patientSearchCriteria.allFacilities=true;$scope.patientSearchCriteria.includeApptFacility=0}else{$scope.patientSearchCriteria.allFacilities=false}$scope.dirtyCheck=true;$scope.reLoadPatientList()};$scope.clearFacilityData=function(){$scope.facilityName.facility.Name="";$scope.facilityName.facility.Id=0;$scope.dirtyCheck=true;$scope.reLoadPatientList()};$scope.setSelectedPatient=function(patient,index){$('#rule-table2'+$scope.patientScreenUId+' tbody tr').on('click',function(){$(this).addClass('highlight').siblings().removeClass('highlight')});$scope.patientSearch.selectedPatient=patient;if(index){$scope.patientSearch.selectedIndex=index}$scope.patientSearch.selectedPatient.email=patient.Email;$scope.patientSearch.selectedPatient.dob=patient.dob;$scope.patientSearch.selectedPatient.sex=patient.sex;$scope.patientSearch.selectedPatient.fname=patient.fname;$scope.patientSearch.selectedPatient.lname=patient.lname;$scope.patientSearch.selectedPatient.zipcode=patient.zipcode;$scope.patientSearch.selectedPatient.upPhone=patient.upPhone;$scope.patientSearch.selectedPatient.userType=patient.UserType;$scope.patientSearch.selectedPatient.UserType=patient.UserType};$scope.setSelectedPt=function(){$timeout(function(){if($scope.patientSearch.selectedIndex>-1){$("#patientSearchTr"+$scope.patientSearch.selectedIndex+$scope.patientScreenUId).addClass('highlight').siblings().removeClass('highlight')}},100)};$scope.myOrAllFacsClicked=function(){if($scope.patientSearchCriteria.myOrAllFacs.value===1||$scope.patientSearchCriteria.myOrAllFacs.value===2){$scope.ptSearchObj.disableFacilityLookup=true;if($scope.patientSearchCriteria.myOrAllFacs.value===2){$scope.patientSearchCriteria.includeApptFacility=0}$scope.patientSearchCriteria.facilityName="";$scope.patientSearchCriteria.facilityid="0"}else{$scope.ptSearchObj.disableFacilityLookup=false}if($scope.patientSearchCriteria.myOrAllFacs.value===2){$scope.patientSearchCriteria.allFacilities=true}else{$scope.patientSearchCriteria.allFacilities=false}$scope.dirtyCheck=true;$scope.reLoadPatientList()};$scope.showMessage=function(message,elementIdToFocus){BootstrapDialog.show({title:"eClinicalWorks",message:message,buttons:[{label:'OK',cssClass:'btn-lgrey btn-xs',action:function(dialog){dialog.close();if(elementIdToFocus!=""){$("#"+elementIdToFocus).focus()}return false}}]})};function showMessage(message,title,action){var bootDialog=bootbox.dialog({message:message,title:title,size:'small',className:action==='Guarantor'?"orangetheme":"bluetheme",buttons:{confirm:{label:"Yes",callback:function(){if(action==="Guarantor"){$scope.callBackToDeleteGuarantor()}else{$scope.callBackToDeletePatient()}}},cancel:{label:"No",callback:function(){}}}}).css("z-index","31000").css('padding-top','10%')}function showMessageDialog(message,title,action){var bootDialog=bootbox.dialog({message:message,title:title,size:'small',className:action==='Guarantor'?"orangetheme":"bluetheme",buttons:{cancel:{label:"OK",cssClass:'btn-lgrey btn-xs',callback:function(){}}}}).css("z-index","31000").css('padding-top','10%')}$scope.callBackToDeleteGuarantor=function(){var param="patientId="+$scope.patientSearch.selectedPatient.id;var url="/mobiledoc/jsp/catalog/xml/getEncCount.jsp?"+param;$http.get(makeURL(url)).success(function(data){console.log(parseInt(data));if(parseInt(data)>0){showMessageDialog("This guarantor has "+parseInt(data)+" encounters.You cannot delete this guarantor.","eClinicalWorks")}else{param="uid="+$scope.patientSearch.deleted.id;url="/mobiledoc/jsp/uadmin/deleteGuarantor.jsp?"+param;data=patientSearchService.grAjaxcall(url);if(data!==undefined&&data!==""){var x2js=new X2JS;var jsonData=x2js.xml_str2json(data);if(jsonData){var status=jsonData.Envelope.Body['return'].status;if(status!==undefined&&status!==""&&status.toLowerCase()!=="success"){ecwAlert(status,"eClinicalWorks","","","orangetheme")}}}$scope.closeDialogue();$scope.reLoadPatientList()}})};$scope.callBackToDeletePatient=function(userAction){if(userAction!=="yes"){return false}$scope.patientSearch.encCount=0;var param="patientId="+$scope.patientSearch.deletedPatient.id+"&sRequestFrom=patientSearchScreen&sRequestType=getPatientEncounterDoc";var url="/mobiledoc/jsp/webemr/toppanel/patientSearch/patientSearchRequestHandler.jsp";var data=patientSearchService.ajaxcall(url,param);$scope.patientSearch.encCount=0;if(data&&data.EncCount){$scope.patientSearch.encCount=data.EncCount}if($scope.patientSearch.encCount>0){showMessageDialog("This patient has "+$scope.patientSearch.encCount+" encounters.You cannot delete this patient.","eClinicalWorks")}else if(data&&data.DocCount&&data.DocCount>0){showMessageDialog("There are "+data.DocCount+" document(s) attached to this patient.You cannot delete this patient.","eClinicalWorks")}else if(data&&data.BumpCount&&data.BumpCount>0){showMessageDialog("This patient has "+data.BumpCount+" encounter(s) in Bump List.You cannot delete this patient.","eClinicalWorks")}else if(data&&data.BufferCount&&data.BufferCount>0){showMessageDialog("This patient has "+data.BufferCount+" encounter(s) in Clipboard for CUT/COPY operation.You cannot delete this patient.<br/> Please Visit: Practice -> Resource Schedule -> Paste Appointment","eClinicalWorks")}else if(data&&data.ImmunizationCount&&data.ImmunizationCount>0){showMessageDialog("This patient has "+data.ImmunizationCount+" associated Immunization/Vaccination. You cannot delete this patient.","eClinicalWorks")}else if(data&&data.ReferralCount&&data.ReferralCount>0){showMessageDialog("There are "+data.ReferralCount+" referral(s) associated to this patient. You cannot delete this patient.")}else if(data&&data.PaymentCount&&data.PaymentCount>0){showMessageDialog("There are "+data.PaymentCount+" payment(s) associated to this patient. You cannot delete this patient.","eClinicalWorks")}else if(data&&data.RefundCount&&data.RefundCount>0){showMessageDialog("There are "+data.RefundCount+" refund(s) associated to this patient. You cannot delete this patient.","eClinicalWorks")}else if(data&&data.ActionCount&&data.ActionCount>0){showMessageDialog("This patient has "+data.ActionCount+" action(s). You cannot delete this patient.","eClinicalWorks")}else{var facilityId=$.trim(getUserProfile("FacilityId"));if(!facilityId||facilityId==="0"){facilityId=getPrimaryFacilityId()}param="patientId="+$scope.patientSearch.deletedPatient.id+"&defaultUserFacilityId="+facilityId+"&sRequestFrom=patientSearchScreen&sRequestType=deletePatient";url="/mobiledoc/jsp/webemr/toppanel/patientSearch/patientSearchRequestHandler.jsp";data=patientSearchService.ajaxcall(url,param);if(data.status!=="success"){$scope.showMessage($scope.patientLookupConst.deleteErrorMessage)}$scope.closeDialogue();$scope.reLoadPatientList();deletePatientSearchHistory($scope.patientSearch.deletedPatient.id)}};$scope.IsEMPIEnabled=function(){var sItemKeyValue="";var EMPIEnabled=false;sItemKeyValue=getItemKeyValue("EnableEMPI",sItemKeyValue);if(sItemKeyValue.trim()=="yes"){return true}else{return false}sItemKeyValue="";sItemKeyValue=getItemKeyValue("EnableEMPI",sItemKeyValue);if(sItemKeyValue.toUpperCase()=="NO")return false;sItemKeyValue="";var bItemKeyPresent=getItemKeyValue("EmpiFacilityBased",sItemKeyValue);if(bItemKeyPresent)if(sItemKeyValue=="YES"){var facilityid=0;facilityid=global.facilityId;if(facilityid<=0)if(getUserProfile("FacilityId")!="");facilityid=getUserProfile("FacilityId");if(facilityid<=0){var strurl=makeURL("/mobiledoc/jsp/catalog/xml/getProviderData.jsp?providerId="+global.TrUserId);var responsePromise=$http.post(strurl);responsePromise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data);defFacid=jsonobj.Envelope.Body['return'].provider.PrimaryServiceLocation})}if(facilityid<=0)return false;strUrl=makeURL("/mobiledoc/jsp/empi/practice/isFacilityEmpiEnabled.jsp?facId="+defFacid);var responsePromise=$http.post(strurl);responsePromise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data);if(jsonobj.Envelope.Body['return']=="1")return true;else return false})}else return false};$scope.launchPatientHub=function(patient){if(patient==null){patient=$scope.patientSearch.selectedPatient}$scope.continueLaunchPatientHub=function(result){if("no"===result){return}$scope.isPatientNotExported=false;if($scope.IsEMPIEnabled()&&patient&&patient.id){var sItemKeyEmpiDemo=getItemKeyValue("empi_DemograhicsExportMandatory",false);var sItemKeyEmpiDemoSupress=getItemKeyValue("empi_supressDemographicsLookupExport",false);if(sItemKeyEmpiDemo.toUpperCase()=="YES"&&sItemKeyEmpiDemoSupress.toUpperCase()=="NO"){var strurl=makeURL('/mobiledoc/jsp/empi/isPatientExportedToEhx.jsp?PatientId='+patient.id);sItemKeyValue="";getItemKeyValue("EmpiMultiMasters",sItemKeyValue);if(sItemKeyValue.toUpperCase()=="YES")strurl=strurl+"&facIdForMultiMasters="+defFacid;var responsePromise=$http.post(strurl);responsePromise.success(function(data,status,headers,config){var showPtHub=false;if(data==true||data=='true'){$scope.openHub(patient)}else{var strMsg="The patient has to be exported or linked to eEHX."+"Do you want to export or link this patient ?";var bootEhxDialog=bootbox.dialog({message:strMsg,title:'eClinicalWorks',size:'small',className:"bluetheme",buttons:{confirm:{label:"Yes",callback:function(){$scope.confirmOptin()}},cancel:{label:"No",callback:function(){}}}}).css("z-index","31000").css('padding-top','10%');bootEhxDialog.removeClass("bluetheme")}})}else{$scope.openHub(patient)}}else{$scope.openHub(patient)}};if(patient&&$scope.patientSearchCriteria.isModernPtMergeEnable&&patient.isPartiallyMerged==='1'){showAlertMessage("<div class='bold mb10 text-left mt-15'><b>Partially Merged Data</b></div><div class='text-left'><span class='redtxt'>Warning</span> This patient has partially merged data. Are you sure you want to proceed?</div><br/>"+"<div class='text-left'>By selecting <b>YES</b> you acknowledge that you may be viewing an incomplete medical record. Refer to Patient Merge Logs for "+"the list of data that failed to merge. <br/> <br/>  To resolve this issue please contact your administrator or eCW Support </div>",'','ConfirmMsg','continueLaunchPatientHub','patientSearchController')}else{$scope.continueLaunchPatientHub()}};$scope.openHub=function(patient){if(patient!==null){$scope.patientSearch.selectedPatient=patient;if($scope.actionName==="patientinquirydetail"){$scope.openPatientAccountDetailPage(patient)}else{$scope.confirmPatientHub(patient)}}else{patient=$scope.patientSearch.selectedPatient;$scope.confirmPatientHub(patient)}};$scope.confirmOptin=function(){var pid=$scope.patientSearch.selectedPatient.id;$ocLazyLoad.load({name:'ehxConsent',files:['/mobiledoc/jsp/webemr/empi/consent/js/PatientConsentCtrl.js','/mobiledoc/jsp/catalog/xml/keywords/js/ecw-keywords.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/empi/consent/ptConsentDecision.jsp?pid="+pid+"&userId="+global.TrUserId+"&empi_DemograhicsExportMandatory=true&calledFrom=ptSearch&consentType=0&nd="+(new Date).getTime()+'&isEhxServerAliveCheck=true&screenName=DemographicsExportMandatory');$scope.ehxConsentOpen="";$scope.ehxConsentOpen=makeURL(url);if($scope.$$phase!='$apply'&&$scope.$$phase!='$digest'){$scope.$apply()}},function(e){alert("Error "+e);console.log(e)})};$scope.openPatientAccountDetailPage=function(patient){let param={patientId:patient.id,contextFrom:'patientlookup'};loadAccountsInquiry($ocLazyLoad,$modal,param)};$scope.confirmDuplicatePatient=function(modalResponse){PSACService.checkCommonStaffPermission($scope.patientSearch.selectedPatient.id,function(){$scope.openPatientHub()},null)};$scope.confirmPatientHub=function(patient){var counter=0;var url="/mobiledoc/jsp/catalog/xml/checkUserName.jsp";url=makeURL(url);$.ajax({method:"POST",url:url,data:"lName="+encodeURIComponent(patient.lname)+"&fName="+encodeURIComponent(patient.fname)+"&mName="+encodeURIComponent(patient.mname)+"&option=3"+"&status="+$scope.patientSearchCriteria.status+"&DOB="+patient.dob,"async":false}).success(function(data){var duplicatePatientList=JSON.parse(data);if(!jQuery.isEmptyObject(duplicatePatientList)&&duplicatePatientList.length>1){duplicatePatientService.openDuplicatePtWarningModal(data,"patientnamedlookup",$scope)}else{PSACService.checkCommonStaffPermission($scope.patientSearch.selectedPatient.id,function(data){$scope.openPatientHub()},null)}}).error(function(jqXHR,textStatus,errorThrown){})};$scope.openPtHubOnEnter=function(e){var keyCode=e.keyCode;if(keyCode===13){$scope.launchPatientHub(null)}};$scope.openPatientInformation=function(openPtLookup){if(!$scope.patientSearch.selectedPatient||!$scope.patientSearch.selectedPatient.name){showMessageDialog("Please select a patient and try again !","eClinicalWorks");return}var patientId=$scope.patientSearch.selectedPatient.id;$ocLazyLoad.load({name:'NewInfo',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/ptInfoController.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/patientMatchController.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/miscController.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/commanP2PService.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/recordPopupController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientInfo/patient-demographics.jsp?patientId='+patientId+'&context=ptSearch');$scope.patientinfourl="";$scope.patientinfourl=url},function(e){console.log(e)})};$scope.loadDemographics=function(iscontextmedicscan){var newPtPermission=getPermission("NewPatient",global.TrUserId);if(newPtPermission){$ocLazyLoad.load({name:'NewInfo',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/ptInfoController.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/patientMatchController.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/miscController.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/commanP2PService.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/recordPopupController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientInfo/patient-demographics.jsp?iscontextmedicscan='+iscontextmedicscan+'&NewExist=New&currentPatientLookup=true&randomnumber='+$scope.randomnumber);$scope.hubinfourl=url},function(e){console.log(e)})}else{ecwAlert("You do not have access to create New Patient. Please contact your administrator.","Security Access")}};$scope.newCopy=function(){var newPtPermission=getPermission("NewPatient",global.TrUserId);if(newPtPermission){if($scope.patientSearch.selectedPatient.id==undefined||$scope.patientSearch.selectedPatient.id==0){showMessageDialog("Please select a patient and try again !","eClinicalWorks")}else{$ocLazyLoad.load({name:'copyNewPatient',files:['/mobiledoc/jsp/webemr/toppanel/patientSearch/js/copyNewPatient.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/recordPopupController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientSearch/copyNewPatient.jsp?patientId='+$scope.patientSearch.selectedPatient.id+'&patientLastName='+encodeURIComponent($scope.patientSearch.selectedPatient.lname));$scope.patientcopyurl="";$scope.patientcopyurl=url},function(e){console.log(e)})}}else{ecwAlert("You do not have access to create New Patient. Please contact your administrator.","Security Access")}};$scope.openPatientQuickRegPopup=function(){var newPtPermission=getPermission("NewPatient",global.TrUserId);if(!newPtPermission){ecwAlert("You do not have access to create New Patient. Please contact your administrator.","Security Access");return}$ocLazyLoad.load({name:'PatientQuickReg',files:['/mobiledoc/jsp/webemr/toppanel/patientQuickReg/patientQuickReg.js']}).then(function(){$scope.patientQuickRegUrl=makeURL('/mobiledoc/jsp/webemr/toppanel/patientQuickReg/patientQuickReg.jsp')},function(){ecwAlert("Error occurred while loading Quick Registration screen.")})};$scope.openQuickRegAndAppt=function(){$scope.patientQuickRegUrl="";$ocLazyLoad.load({name:"WalkInAppointmentApp",files:['/mobiledoc/jsp/webemr/scheduling/js/walkInAppointment.js'],cache:true}).then(function(){var urlToLoad="/mobiledoc/jsp/webemr/scheduling/walkInAppointment.jsp?parentScreen=patientSearch";$scope.patientQuickRegUrl=makeURL(urlToLoad)},function(e){console.log(e)})};$scope.setShortcutPatientInfo=function(index){$scope.patientSearch.selectedPatient={};$scope.patientSearch.selectedPatient.id=$scope.patientList[index].id;$scope.patientSearch.selectedPatient.name=$scope.patientList[index].name;var patient=$scope.patientList[index];$scope.confirmPatientHub(patient)};$scope.openPatientHub=function(){if($scope.patientSearch.selectedPatient.id==undefined||$scope.patientSearch.selectedPatient.id==0){showMessageDialog("Please select a patient and try again !","eClinicalWorks")}else{if($scope.isMatchPatient&&$scope.context.toLowerCase()=="p2p"){$scope.setP2PPatientDetails()}else if($scope.isMatchPatient&&$scope.context.toLowerCase()=="healow"){$scope.sethealowPatientDetails()}else if($scope.isReturnPtObject){$scope.setPatientToParentScreen()}else if($scope.actionName==='Guarantor'&&$scope.context!=="JELLY_BEAN_PANEL"&&!$scope.isOpenInfo){$scope.selectGuarantorRow()}else{$scope.openPatientHubScreen()}}};$scope.setPatientToParentScreen=function(){$scope.$parent.setPatientRecord($scope.patientSearch.selectedPatient);$scope.hidePatientModal();$scope.patientSearch.selectedPatient={}};$scope.openPatientHubScreen=function(){updatePatientSearchHistory($scope.patientSearch.selectedPatient.id,$scope.patientSearch.selectedPatient.name);if($scope.patientSearch.selectedPatient.id!=undefined){$ocLazyLoad.load({name:'NewHub',files:['/mobiledoc/jsp/webemr/toppanel/patientHub/patienthubController.js'],cache:true}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientHub/patient-hub.jsp?patientId='+$scope.patientSearch.selectedPatient.id+'&nd='+(new Date).getTime());if($scope.context==='patientlookupmenu'){angular.element(document.getElementById('JellyBeanCountCntrl')).scope().huburlforpatientlookup="";angular.element(document.getElementById('JellyBeanCountCntrl')).scope().huburlforpatientlookup=url}else{$scope.hubinfourl="";$scope.hubinfourl=url}$scope.hidePatientModal();$scope.patientSearch.selectedPatient={}},function(e){console.log(e)})}};$scope.setP2PPatientDetails=function(patientObj){if($scope.context.toLowerCase()=="referral"){if(patientObj){var ptObj={id:patientObj.patientid,name:patientObj.fullname};$scope.$parent.setPatientRecord(ptObj)}else{$scope.$parent.setPatientRecord($scope.patientSearch.selectedPatient)}}else{if(patientObj){var ptObj={patientId:patientObj.patientid,patientName:patientObj.fullname};$scope.$parent.setRecordPatientData(ptObj)}else{var ptObj={patientId:$scope.patientSearch.selectedPatient.id,patientName:$scope.patientSearch.selectedPatient.name};$scope.$parent.setRecordPatientData(ptObj)}}$scope.hidePatientModal();$scope.patientSearch.selectedPatient={}};$scope.sethealowPatientDetails=function(ptObj){if(!ptObj){$scope.$parent.patientDtls.patient.id=$scope.patientSearch.selectedPatient.id;$scope.$parent.patientDtls.patient.name=$scope.patientSearch.selectedPatient.name;$scope.$parent.patientDtls.patient.dob=$scope.patientSearch.selectedPatient.dob;$scope.$parent.patientDtls.patient.upPhone=$scope.patientSearch.selectedPatient.upPhone;$scope.$parent.patientDtls.patient.Email=$scope.patientSearch.selectedPatient.Email;$scope.$parent.patientDtls.patient.sex=$scope.patientSearch.selectedPatient.sex;$scope.$parent.patientDtls.patient.WebEnabled=$scope.patientSearch.selectedPatient.WebEnabled;$scope.$parent.patientDtls.patient.address="";$scope.$parent.patientDtls.patient.context="healow";$scope.$parent.setAppointmentReason(JSON.parse($scope.nhxPtDetailsJSON).reason);$scope.$parent.setGeneralNotes(JSON.parse($scope.nhxPtDetailsJSON).notes);$scope.$parent.reasonChange()}$scope.$parent.mySelectPatient1();$scope.hidePatientModal();$scope.patientSearch.selectedPatient={}};$scope.voiceSettings=function(){if($scope.patientSearch.selectedPatient.id==undefined||$scope.patientSearch.selectedPatient.id==0){$scope.showMessage("Please select a patient and try again.")}else{$ocLazyLoad.load({name:'PtCommSettings',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/voice/ptcommsettings.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/voice/ptcommunicationsettings.jsp?uid='+$scope.patientSearch.selectedPatient.id+'&nd='+(new Date).getTime());$scope.voiceurl=url},function(e){console.log(e)})}};$scope.refreshhub=function(){};$scope.CheckDriverLicenseNewCompatibility=function(){$scope.tooltipmsgval="This machine is not compatible with Medicscan driver license. Please perform compatibility check at login page or visit Product Activation(Admin-> Product Activation ->Device Activation) or contact your administrator.";var data=getDeviceCompatibilityCheckValue("driverlicense","",$scope.tooltipmsgval,true);if(data!=""&&!angular.isUndefined(data)){var res=data.split(",");if(res[0]=="true"){$scope.disableMediscanNewBtn="false";$scope.tooltipmsgval=""}else{$('#mediscan1'+$scope.patientScreenUId).attr('title',res[1]);$('#mediscanphoto1'+$scope.patientScreenUId).attr('title',res[1]);$scope.tooltipmsgval=res[1];$scope.disableMediscanNewBtn="true"}}};$scope.medicscan_new=function(){var TrUserId=global.TrUserId;var patientxmlenc="";var inputparam="";var token=encodeURIComponent(csrfToken);var ServerURL=encodeURIComponent(window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]);$scope.loadDemographics("yes");medicScanTimeout=setTimeout(function(){var ptInfoscope=$('[ng-controller="ptInfoController"]').scope();$scope.medicscanparent='ptlookup';inputparam="<xml><patientId>0</patientId><usrlogid>"+global.TrUserId+"</usrlogid><DriverLicenseCardxml></DriverLicenseCardxml><randomnumber>"+$scope.randomnumber+"</randomnumber><SetCookie></SetCookie><server>"+ServerURL+"</server><userId>"+global.TrUserId+"</userId></xml>";try{launchPlugin('id=medicscanwithphoto|patientId=0|randomnumber='+$scope.randomnumber+'|usrlogid='+global.TrUserId+'|userId='+global.TrUserId+'|DriverLicenseCardxml=|inputparam='+inputparam)}catch(err){console.log(err)}},1e3);return true};$scope.medicscan_photo_new=function(){var TrUserId=global.TrUserId;var patientxmlenc="";var inputparam="";var ServerURL=encodeURIComponent(window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]);$scope.loadDemographics("yes");var token=encodeURIComponent(csrfToken);if(global.ecw_native_app_agent){inputparam="<xml><patientId>0</patientId><usrlogid>"+TrUserId+"</usrlogid><DriverLicenseCardxml>"+patientxmlenc+"</DriverLicenseCardxml><randomnumber>"+$scope.randomnumber+"</randomnumber><SetCookie>"+cookie+"</SetCookie><server>"+ServerURL+"</server><userId>"+global.TrUserId+"</userId></xml>";window.external.InvokeMedicScanWithPhoto(patientxmlenc,'0')}else{medicScanPhotoTimeout=setTimeout(function(){var ptInfoscope=$('[ng-controller="ptInfoController"]').scope();if(!angular.isUndefined(ptInfoscope)){ptInfoscope.medicscanparent='ptlookup'}inputparam="<xml><patientId>0</patientId><usrlogid>"+global.TrUserId+"</usrlogid><DriverLicenseCardxml></DriverLicenseCardxml><randomnumber>"+$scope.randomnumber+"</randomnumber><SetCookie>"+cookie+"</SetCookie><server>"+ServerURL+"</server><userId>"+global.TrUserId+"</userId></xml>";try{launchPlugin('id=medicscanwithphoto|patientId=0|randomnumber='+$scope.randomnumber+'|usrlogid='+global.TrUserId+'|userId='+global.TrUserId+'|DriverLicenseCardxml=|inputparam='+inputparam)}catch(err){console.log(err)}},1e3)}return true};$scope.loadMPILookup=function(){var patientInfo={"lname":$scope.patientSearchCriteria.searchText,"searchTxt":$scope.patientSearchCriteria.searchBy,"LastName2":$scope.patientSearchCriteria.secondSearchValue,"searchTxt2":$scope.patientSearchCriteria.secondSearchBy};patientInfo=JSON.stringify(patientInfo);$ocLazyLoad.load({name:'MPILookupModule',files:['/mobiledoc/jsp/webemr/lookup/MPIController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/lookup/MPILookupWeb.jsp?patientInfo='+encodeURIComponent(patientInfo));$scope.mpilookupurl=url},function(e){console.log(e)})};$scope.loadPatientInfoScreen=function(patientId){$ocLazyLoad.load({name:'NewInfo',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/ptInfoController.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/patientMatchController.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/miscController.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/commanP2PService.js','/mobiledoc/jsp/webemr/jellybean/patientrecord/recordPopupController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientInfo/patient-demographics.jsp?patientId='+patientId);$scope.patientinfourl=url},function(e){console.log(e)})};$scope.maskPrimarySearchInputText=function(e){maskSearchInputText(e,"searchText",$scope.patientSearchCriteria.searchBy)};$scope.maskSecondarySearchInputText=function(e){maskSearchInputText(e,"secondSearchValue",$scope.patientSearchCriteria.secondSearchBy)};$scope.ellipsisText=function(text){var ellipsisTxt=text;if(text.length>20){ellipsisTxt=ellipsisTxt.substr(0,20)+"..."}return ellipsisTxt};var maskSearchInputText=function(e,searchKeyName,searchBy){if(searchBy==='DateOfBirth'){addDateSeparator(e,e.target,"mm/dd/yyyy");setSeparatorForSearch($scope.patientSearchCriteria,searchKeyName,e.target.value,"/")}else if(searchBy==='PhoneNo'||searchBy==='AllPhones'||searchBy==='GrPhone'){addSeparator(e,e.target,"xxx-xxx-xxxx");setSeparatorForSearch($scope.patientSearchCriteria,searchKeyName,e.target.value,"-")}else if(searchBy==='SSN'){addSeparator(e,e.target,"xxx-xx-xxx");setSeparatorForSearch($scope.patientSearchCriteria,searchKeyName,e.target.value,"-")}};var setSeparatorForSearch=function(searchTextObj,searchKeyName,updatedSearchText,separator){if(searchTextObj&&searchKeyName&&updatedSearchText&&separator&&updatedSearchText.length>0&&updatedSearchText.charAt(updatedSearchText.length-1)===separator){searchTextObj[searchKeyName]=updatedSearchText}};$scope.launchGuarantorInfo=function(guarantor){$scope.patientSearch.selectedPatient={};$scope.patientSearch.selectedPatient=guarantor;$scope.patientSearch.selectedPatient.id=guarantor.id;$scope.patientSearch.selectedPatient.name=guarantor.name;$scope.patientSearch.selectedPatient.usertype=guarantor.UserType==='Patient'?3:4;$scope.patientSearch.selectedPatient.userType=guarantor.userType;if($scope.actionName==='Guarantor'&&$scope.context!=="JELLY_BEAN_PANEL"&&!$scope.isOpenInfo){$scope.selectGuarantorRow()}else{$scope.openGuarantorInfo()}};$scope.openGuarantorInfo=function(isNew){if(($scope.patientSearch.selectedPatient.id==undefined||$scope.patientSearch.selectedPatient.id==0)&&isNew==false){showMessageDialog("Please select a guarantor and try again !","eClinicalWorks")}else{if(isNew){$scope.grId=0;$scope.isMain=true;$scope.patientSearch.selectedPatient.usertype=4}else{$scope.grId=$scope.patientSearch.selectedPatient.id;$scope.isMain=true}if($scope.patientSearch.selectedPatient.usertype==4&&($scope.guarantorSearchCriteria.secondSearchBy=='0'||$scope.guarantorSearchCriteria.secondSearchBy=='2')){$scope.patid=$scope.$parent.patid;$ocLazyLoad.load({name:'editGuarantor',files:['/mobiledoc/jsp/webemr/menu/file/guarantor/js/guarantor.js','/mobiledoc/jsp/webemr/menu/file/guarantor/js/guarantorAuditLogs.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/menu/file/guarantor/editGuarantor.jsp');$scope.GuarantorInfo=url},function(e){console.log(e)})}else{$ocLazyLoad.load({name:"NewInfo",files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/ptInfoController.js','/mobiledoc/jsp/webemr/webpm/payments/patientAddress/js/validateAddressController.js','/mobiledoc/jsp/webemr/toppanel/patientInfo/miscController.js'],cache:true}).then(function(){if(isNew)$scope.GuarantorInfo=makeURL('/mobiledoc/jsp/webemr/toppanel/patientInfo/patient-demographics.jsp?NewExist=New&currentPatientLookup=true&randomnumber='+$scope.randomnumber);else $scope.GuarantorInfo=makeURL("/mobiledoc/jsp/webemr/toppanel/patientInfo/patient-demographics.jsp?patientId="+$scope.grId)},function(e){console.log(e)})}}};$scope.openGuarantorAccount=function(patient){if(patient==null){patient=$scope.patientSearch.selectedPatient}$scope.grId=$scope.patientSearch.selectedPatient.id;$scope.name=$scope.patientSearch.selectedPatient.name;$scope.usertype=4;if(getPermission("Accounts LookUp",global.TrUserId)){$ocLazyLoad.load({name:'guarantorAccountApp',files:['/mobiledoc/jsp/webemr/webpm/js/guarantorAccount.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/webpm/guarantorAccount.jsp?patientId="+$scope.grId+"&userType="+$scope.usertype+"&parentScreen=searchGuarantor&theme=orangetheme");$scope.GuarantorInfo=url},function(e){console.log(e)})}else{var msg="The feature is controlled through the following security key.  If you need";msg+="</br>permission, please contact your practice Administrator/Co Administrator(s)";msg+="</br> for permission for the following security key.";msg+="</br></br>You can view your practice Administrator/Co Administrator(s) from the";msg+="</br>application main menu 'File->Settings->eClinicalWorks Administrator'.";msg+="</br></br>For the new permissions to be effective, you may have to close and login";msg+="</br>again into eClinicalWorks after Administrator gives you permission.</br></br>";msg+="<table><tr><td><strong>Security Key</strong></td><td><input class='form-control input-sm' type='text' value='Accounts LookUp' readonly/></td></tr></table>";ecwAlert(msg,"Security Information","","Close");return false}};$scope.selectGuarantorRow=function(){try{if($scope.patientSearch.selectedPatient.id&&$scope.patientSearch.selectedPatient.id>0){$scope.$parent.setSearchGuaIns($scope.patientSearch.selectedPatient.id,$scope.patientSearch.selectedPatient.name,$scope.patientSearch.selectedPatient.usertype);if(angular.isFunction($scope.$parent.$parent.$parent.setSelectedGuarantorData)){$scope.$parent.$parent.$parent.setSelectedGuarantorData()}}else{ecwAlert("Please select Guarantor.","eClinicalWorks","","","bluetheme");return false}}catch(e){}closeModal();$scope.hidePatientModal()};$scope.selectGuarantorInfo=function(patient){$scope.isOpenInfo=true;if(patient==null){patient=$scope.patientSearch.selectedPatient}$scope.launchGuarantorInfo(patient);$scope.isOpenInfo=false};$scope.setSearchGuaIns=function(uid,name,userType){$scope.patientSearch.selectedPatient.id=uid;$scope.patientSearch.selectedPatient.name=name;$scope.patientSearch.selectedPatient.usertype=userType};$scope.deleteGuarantorClicked=function(){if($scope.patientSearch.selectedPatient&&$scope.patientSearch.selectedPatient.name){$scope.patientSearch.deleted=$scope.patientSearch.selectedPatient;showMessage("Are you sure you want to delete "+$scope.patientSearch.deleted.name+"?","eClinicalWorks","Guarantor")}else{showMessageDialog("Please select a guarantor and try again !","eClinicalWorks","Guarantor")}};$scope.openAuditLogs=function(e){var url='/mobiledoc/jsp/webemr/menu/file/guarantor/guarantorAuditLogs.jsp';$ocLazyLoad.load({name:'guarantorAuditLogs',files:['/mobiledoc/jsp/webemr/menu/file/guarantor/js/guarantorAuditLogs.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL(url),keyboard:false})})}}).service('patientSearchService',function($http){return{callPatientSearch:function(url,data){url=makeURL(url);return $http({method:'POST',url:url,data:$.param(data),headers:{'Content-Type':'application/x-www-form-urlencoded'}})},ajaxcall:function(url,param){var returnData={};url=makeURL(url);$.ajax({url:url,type:"POST",data:param,cache:false,"async":false,dataType:"json",headers:{'Content-Type':'application/x-www-form-urlencoded'},success:function(data){returnData=data}});return returnData},grAjaxcall:function(url){var returnData={};url=makeURL(url);$.ajax({url:url,type:"POST",cache:false,"async":false,headers:{'Content-Type':'application/x-www-form-urlencoded'},success:function(data){returnData=data}});return returnData},callPatientSearchEhx:function(searchby,searchVal,addlsearchby,addlsearchval,limitstart,maxcount,nPrimaryServiceLocationId,bEhxSSOEnabled,canceler,searchMiniCharLimit){if(searchby==='DateOfBirth')searchby='DOB';if(addlsearchby==='DateOfBirth')addlsearchby='DOB';fetchFromURL="/mobiledoc/jsp/empi/master/executeUrlToMaster.jsp";var url="/mobiledoc/jsp/empi/xml/getPatientHubPtsList.jsp?searchBy1="+searchby+"&search1Value="+searchVal+"&searchBy2="+addlsearchby+"&search2Value="+addlsearchval+"&startPos="+limitstart+"&Maxcount="+maxcount+"&primaryServiceLocation="+nPrimaryServiceLocationId+"&bypassconsentexpire="+isItemKeyEnabled("isByPassExpiredConsent")+"&searchMiniCharLimit="+searchMiniCharLimit;var strUnamePwd="";var formRequestData="";if(bEhxSSOEnabled=="no"){strUnamePwd=getUnamePwd();if(strUnamePwd==null||strUnamePwd===""||strUnamePwd.length===0){ecwAlert("No eHX portal username and password are found, please enter your eHX portal username and password")}}else{var strSSOTOken=getSSOToken();if(strSSOTOken==null||strSSOTOken===""||strSSOTOken.length===0){ecwAlert("Error while generation SSO Token for Ehx")}else{formRequestData="ehxSSO=yes&ssoStamp="+strSSOTOken}}if(formRequestData.length>0){formRequestData=formRequestData+"&"}formRequestData=formRequestData+"unamepwd="+strUnamePwd;var dataParam="masterUrl="+encodeURIComponent(url)+"&FormData="+encodeURIComponent(formRequestData);return $http({method:'POST',url:fetchFromURL,data:dataParam,cache:false,headers:{'Content-Type':'application/x-www-form-urlencoded'},timeout:canceler.promise})},viewPatientInfoFromEhx:function(bEhxSSOEnabled,empi){fetchFromURL="/mobiledoc/jsp/empi/master/executeUrlToMaster.jsp";var url="/mobiledoc/jsp/empi/xml/displayPtDemoFromPCP.jsp?ecwmpi="+empi;var strUnamePwd="";if(bEhxSSOEnabled=="no"){strUnamePwd=getUnamePwd();if(strUnamePwd==null||strUnamePwd==""||strUnamePwd.length==0){alert("No eHX portal username and password are found, please enter your eHX portal username and password")}}else{var strSSOTOken=getSSOToken();if(strSSOTOken==null||strSSOTOken==""||strSSOTOken.length==0){alert("Error while generation SSO Token for Ehx")}else{url=url+"&ehxSSO=yes&ssoStamp="+strSSOTOken}}url=url+"&unamepwd="+strUnamePwd;var dataParam="masterUrl="+encodeURIComponent(url);return $http({method:'POST',url:fetchFromURL,data:dataParam,cache:false,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},importPatientFromEhx:function(empi){var deferred;try{deferred=$.Deferred();BootstrapDialog.confirm("Do you want to import the selected patient from eEHX to your local database?",function(confirmImport){if(confirmImport===true){var nPrimaryServiceLocationId=getPrimaryServiceLocationId();var permission=hasPermission("eHXImportedDemo");if(permission==false||permission==""){showMessage("You don't have the permission to Import patient demographics. Please contact your administrator for permission.");return false}else{var empiPhyId="";$.ajax({type:"POST",url:"/mobiledoc/jsp/empi/getEmpiPhyIdFromEmrId.jsp","async":true,cache:false,success:function(responseGetEmpiPhyIdFromEmrId){empiPhyId=$.trim(responseGetEmpiPhyIdFromEmrId);var strXmlDoc="";strXmlDoc=ehxCommonFuncs_CreateXml();strXmlDoc+=ehxCommonFuncs_CreateXmlBody();strXmlDoc+="<m:NOOP xmlns:m='NOOP'>";strXmlDoc+=ehxCommonFuncsCreateXmlNode('patient','string','',true);strXmlDoc+=ehxCommonFuncsCreateXmlNode('ecwmpi','string',empi,false);strXmlDoc+=ehxCommonFuncsCreateXmlNode('empiPhyId','string',empiPhyId,false);strXmlDoc+=ehxCommonFuncs_CreateXmlClosingNode('patient');strXmlDoc+="</m:NOOP>";strXmlDoc+=ehxCommonFuncsCreateXmlCloseBody();strXmlDoc+=ehxCommonFuncs_CreateCloseXml();$.ajax({type:"POST",url:"/mobiledoc/jsp/empi/master/executeUrlToMaster.jsp",data:{masterUrl:"/mobiledoc/jsp/empi/xml/getPtDemoDataFromPCP.jsp",FormData:strXmlDoc},"async":true,cache:false,success:function(responseExecuteUrlToMaster){responseExecuteUrlToMaster=$.trim(responseExecuteUrlToMaster);if(responseExecuteUrlToMaster.length>0){if(ehxCommonFuncsIsSuccessXmlResult(responseExecuteUrlToMaster)==true){$.ajax({type:"POST",url:"/mobiledoc/jsp/empi/SavePtData.jsp",data:{action:'insert',providerPSL:nPrimaryServiceLocationId,FormData:responseExecuteUrlToMaster,device:'webemr'},"async":true,cache:false,success:function(responseSavePtData){responseSavePtData=$.trim(responseSavePtData);if(ehxCommonFuncsIsSuccessXmlResult(responseSavePtData)==true){var xmlDoc=$.parseXML(responseSavePtData);var pid=$(xmlDoc).find("pid").text();deferred.resolve(pid);$.ajax({type:"POST",url:"/mobiledoc/jsp/empi/consent/updateLinkedPractices.jsp",data:{ecwmpi:empi,pid:pid},"async":true,cache:false,success:function(responseUpdateLinkedPractices){showMessage("Successfully imported patient demographics data.");return false},error:function(xhr,ajaxOptions,thrownError){showMessage("Error update linked practices.")}})}else{var x2js=new X2JS;var jsonData=x2js.xml_str2json(responseSavePtData);if(patientSearch_isDataValidationStatusFind(jsonData)){return false}showMessage("An error occurred while importing the patient demographics data.")}return false},error:function(xhr,ajaxOptions,thrownError){showMessage("Error Importing patient demographics data.")}})}else{var errorMsg=ehxCommonFuncs_failedStatusMsgXmlResult(responseExecuteUrlToMaster);if(errorMsg)showMessage(errorMsg);else showMessage("An error occurred while getting the patient demographics data from eHX.")}}else{showMessage("Patient data from EHX is empty or null.")}return false},error:function(xhr,ajaxOptions,thrownError){showMessage("Error getting patient data from EHX.")}})},error:function(xhr,ajaxOptions,thrownError){showMessage("You don't have a valid eHX account or account mapping.")}})}}else{deferred.reject('Notconfirmed')}})}catch(err){console.log(err)}return deferred.promise()},getInitDataForPtLookup:function(action){return this.ajaxcall("/mobiledoc/patientsearch/user/init/"+action)},saveUserPtTemplate:function(data){return $http({method:"POST",url:makeURL('/mobiledoc/patientsearch/user/saveUserTemplate'),data:data})},deletePtLkpTemplate:function(data){return $http({method:'POST',url:makeURL("/mobiledoc/patientsearch/user/deleteTemplate"),data:data})},setDefaultPtLkpTemplate:function(data){return $http({method:'POST',url:makeURL("/mobiledoc/patientsearch/user/markTemplateDefault"),data:data})},getTemplateDetails:function(data){return $http({method:'POST',url:makeURL("/mobiledoc/patientsearch/user/getTemplateDetails"),data:data})},setOpen:function(isOpen){this.modalOpen=isOpen},isOpen:function(){return this.modalOpen}}});function patientSearch_isDataValidationStatusFind(jsonData){var isFind=false;if(jsonData&&jsonData.Envelope&&jsonData.Envelope.Body&&jsonData.Envelope.Body["return"]&&jsonData.Envelope.Body["return"].status&&jsonData.Envelope.Body["return"].status==="DataValidationError"){isFind=true;var maxlengthArray=[];var minlengthArray=[];var splcharArray=[];var maxValueArray=[];var minValueArray=[];var errMsg="";try{errMsg=JSON.parse(jsonData.Envelope.Body["return"].errormsg)}catch(e){ecwAlert(jsonData.Envelope.Body["return"].errormsg);return isFind}if(errMsg.maxlengthArray){maxlengthArray=errMsg.maxlengthArray}if(errMsg.minlengthArray){minlengthArray=errMsg.minlengthArray}if(errMsg.splcharArray){for(var i=0;i<errMsg.splcharArray.length;i++){errMsg.splcharArray[i].validCharacters=errMsg.splcharArray[i].validCharacters;errMsg.splcharArray[i].enteredCharacters=decodeURIComponent(errMsg.splcharArray[i].enteredCharacters)}splcharArray=errMsg.splcharArray}if(errMsg.maxValueArray){maxValueArray=errMsg.maxValueArray}if(errMsg.minValueArray){minValueArray=errMsg.minValueArray}ecwAlert(patientSearch_generateValidationMsgHTMLSnippet(maxlengthArray,minlengthArray,splcharArray,maxValueArray,minValueArray,''))}return isFind}function patientSearch_generateValidationMsgHTMLSnippet(maxlengthArray,minlengthArray,splcharArray,maxValueArray,minValueArray,businessDataTypeArray){var strHTML="";var index="";strHTML="<b><center>Please correct the fields before saving.</center></b>";if(maxlengthArray.length>0){strHTML+="<table><thead><tr> <th style='border:0;'> The data entered <b> cannot be saved </b> because [ "+maxlengthArray.length+" ] of the fields <b> exceed their maximum allowed length. </b></th> </tr></thead> </table>";strHTML+="<table border=1 class='dataTruncationMsgTbl'><thead>";strHTML+="<tr>";strHTML+="<th width='5%' ><b> # </b></th>";strHTML+="<th width='45%' ><b> Field Label </b></th>";strHTML+="<th width='25%'><b>Entered Length </b></th>";strHTML+="<th width='25%'><b>Maximum Length </b></th>";strHTML+="</tr></thead>";for(var i=0;i<maxlengthArray.length;i++){index=i+1;strHTML+="<tr>";strHTML+="<td width='5%'>"+index+"</td>";strHTML+="<td width='45%' title='"+htmlEncode(maxlengthArray[i].fieldLabelName)+"'> "+htmlEncode(maxlengthArray[i].fieldLabelName)+"</td>";strHTML+="<td width='25%' title='"+htmlEncode(String(maxlengthArray[i].enteredFieldLength))+"'>"+htmlEncode(maxlengthArray[i].enteredFieldLength)+"</td>";strHTML+="<td width='25%' title='"+htmlEncode(String(maxlengthArray[i].supportedFieldLength))+"'>"+htmlEncode(maxlengthArray[i].supportedFieldLength)+"</td>";strHTML+="</tr>"}strHTML+="</table>";strHTML+="<br>"}if(businessDataTypeArray.length>0){strHTML+="<table><thead><tr> <th style='border:0;'> <b> "+businessDataTypeArray.length+" of the fields you are trying to save <u> exceed their maximum allowed length.</u></b> </th> </tr></thead> </table>";strHTML+="<table border=1 class='dataTruncationMsgTbl'><thead>";strHTML+="<tr>";strHTML+="<th width='5%' ><b> # </b></th>";strHTML+="<th width='25%' ><b> Field Label </b></th>";strHTML+="<th width='25%'><b>Entered Value </b></th>";strHTML+="<th width='45%'><b>Message </b></th>";strHTML+="</tr></thead>";for(var i=0;i<businessDataTypeArray.length;i++){index=i+1;strHTML+="<tr>";strHTML+="<td width='5%'>"+index+"</td>";strHTML+="<td width='25%' title='"+htmlEncode(businessDataTypeArray[i].fieldName)+"'> "+htmlEncode(businessDataTypeArray[i].fieldName)+"</td>";strHTML+="<td width='25%' title='"+htmlEncode(String(businessDataTypeArray[i].enteredValue))+"'>"+htmlEncode(businessDataTypeArray[i].enteredValue)+"</td>";strHTML+="<td width='45%' title='"+htmlEncode(String(businessDataTypeArray[i].message))+"'>"+htmlEncode(businessDataTypeArray[i].message)+"</td>";strHTML+="</tr>"}strHTML+="</table>";strHTML+="<br>"}if(minlengthArray.length>0){strHTML+="<table><thead><tr> <th style='border:0;'> The data entered <b> cannot be saved </b> because [ "+minlengthArray.length+" ] of the fields <b> do not meet their required minimum length. </b> </th> </tr> </thead> </table>";strHTML+="<table border='1' class='dataTruncationMsgTbl'><thead>";strHTML+="<tr>";strHTML+="<th width='5%'><b> # </b></th>";strHTML+="<th width='45%'><b> Field Label </b></th>";strHTML+="<th width='25%'><b>Entered Length </b></th>";strHTML+="<th width='25%'><b>Minimum Length </b></th>";strHTML+="</tr></thead>";for(var j=0;j<minlengthArray.length;j++){index=maxlengthArray.length+j+1;strHTML+="<tr>";strHTML+="<td width='5%'>"+index+"</td>";strHTML+="<td width='45%' title='"+htmlEncode(minlengthArray[j].fieldLabelName)+"'>"+htmlEncode(minlengthArray[j].fieldLabelName)+"</td>";strHTML+="<td width='25%' titel='"+htmlEncode(String(minlengthArray[j].enteredMinFieldLength))+"'>"+htmlEncode(minlengthArray[j].enteredMinFieldLength)+"</td>";strHTML+="<td width='25%' title='"+htmlEncode(String(minlengthArray[j].supportedMinFieldLength))+"'>"+htmlEncode(minlengthArray[j].supportedMinFieldLength)+"</td>";strHTML+="</tr>"}strHTML+="</table>";strHTML+="<br>"}if(maxValueArray.length>0){strHTML+="<table><thead><tr><th>The data entered <b> cannot be saved </b> because [ "+maxValueArray.length+" ] of the fields <b> exceed their required maximum value. </b></th></tr></thead></table>";strHTML+="<table border=1 class='dataTruncationMsgTbl'><thead>";strHTML+="<tr>";strHTML+="<th width='5%'><b> # </b></th>";strHTML+="<th width='45%'><b> Field Label </b></th>";strHTML+="<th width='25%'><b>Entered Value</b></th>";strHTML+="<th width='25%'><b>Maximum Value</b></th>";strHTML+="</tr></thead>";for(var k=0;k<maxValueArray.length;k++){index=maxlengthArray.length+minlengthArray.length+k+1;strHTML+="<tr>";strHTML+="<td width='5%'>"+index+"</td>";strHTML+="<td width='30%' title='"+htmlEncode(maxValueArray[k].fieldLabelName)+"'>"+htmlEncode(maxValueArray[k].fieldLabelName)+"</td>";strHTML+="<td width='30%' title='"+htmlEncode(String(maxValueArray[k].enteredvalue))+"'>"+htmlEncode(maxValueArray[k].enteredvalue)+"</td>";strHTML+="<td width='50%' title='"+htmlEncode(String(maxValueArray[k].validvalue))+"'>"+htmlEncode(maxValueArray[k].validvalue)+"</td>";strHTML+="</tr>"}strHTML+="</table>";strHTML+="<br>"}if(minValueArray.length>0){strHTML+="<table><thead><tr><th>The data entered <b> cannot be saved </b> because [ "+minValueArray.length+" ] of the fields <b> doesn't meet their required minimum value. </b></th></tr></thead></table>";strHTML+="<table border=1 class='dataTruncationMsgTbl'><thead>";strHTML+="<tr>";strHTML+="<th width='5%'><b> # </b></th>";strHTML+="<th width='45%'><b> Field Label </b></th>";strHTML+="<th width='25%'><b>Entered Value</b></th>";strHTML+="<th width='25%'><b>Minimum Value</b></th>";strHTML+="</tr></thead>";for(var k=0;k<minValueArray.length;k++){index=maxlengthArray.length+minlengthArray.length+maxValueArray.length+k+1;strHTML+="<tr>";strHTML+="<td width='5%'>"+index+"</td>";strHTML+="<td width='30%' title='"+htmlEncode(minValueArray[k].fieldLabelName)+"'>"+htmlEncode(minValueArray[k].fieldLabelName)+"</td>";strHTML+="<td width='30%' title='"+htmlEncode(String(minValueArray[k].enteredvalue))+"'>"+htmlEncode(String(minValueArray[k].enteredvalue))+"</td>";strHTML+="<td width='50%' title='"+htmlEncode(String(minValueArray[k].validvalue))+"'>"+htmlEncode(minValueArray[k].validvalue)+"</td>";strHTML+="</tr>"}strHTML+="</table>";strHTML+="<br>"}if(splcharArray.length>0){strHTML+="<table><thead><tr> <th style='border:0;'> The data entered <b> cannot be saved </b> because [ "+splcharArray.length+" ] of the fields includes <b> characters that are not allowed. </b> </th> </tr> </thead> </table>";strHTML+="<table border='1' class='dataTruncationMsgTbl'><thead>";strHTML+="<tr>";strHTML+="<th width='5%'><b> # </b></th>";strHTML+="<th width='30%'><b> Field Label </b></th>";strHTML+="<th width='35%'><b>Characters Entered</b></th>";strHTML+="<th width='50%'><b>Characters Allowed</b></th>";strHTML+="</tr></thead>";for(var k=0;k<splcharArray.length;k++){index=maxlengthArray.length+minlengthArray.length+maxValueArray.length+minValueArray.length+k+1;strHTML+="<tr>";strHTML+="<td>"+index+"</td>";strHTML+="<td title='"+htmlEncode(splcharArray[k].fieldLabelName)+"'>"+htmlEncode(splcharArray[k].fieldLabelName)+"</td>";strHTML+="<td title='"+htmlEncode(String(splcharArray[k].enteredCharacters))+"'>"+htmlEncode(splcharArray[k].enteredCharacters)+"</td>";strHTML+="<td title='"+htmlEncode(String(splcharArray[k].validCharacters))+"'>"+htmlEncode(splcharArray[k].validCharacters)+"</td>";strHTML+="</tr>"}strHTML+="</table>";strHTML+="<br>"}return strHTML}function setPatientSearchHistory(patientSearchHistory){var storageKey="ECW_PAT_SEARCHHISTORY";if(!containsKey(storageKey)){put(storageKey,JSON.stringify(patientSearchHistory))}else{remove(storageKey);put(storageKey,JSON.stringify(patientSearchHistory))}}function getPatientSearchHistory(){var storageKey="ECW_PAT_SEARCHHISTORY";var patientSearchHistory=[];if(!containsKey(storageKey)){patientSearchHistory=[]}else{patientSearchHistory=JSON.parse(get(storageKey))}return patientSearchHistory}function MedicscanPhotoNew(){var TrUserId=global.TrUserId;var patientxmlenc="";var inputparam="";var token=encodeURIComponent(csrfToken);var ptSearchScope=$('[ng-controller="patientSearchController"]').scope();var ServerURL=encodeURIComponent(window.location.href.split("/")[0]+"//"+window.location.href.split("/")[2]);ptSearchScope.loadDemographics("yes");if(global.ecw_native_app_agent){inputparam="<xml><patientId>0</patientId><usrlogid>"+TrUserId+"</usrlogid><DriverLicenseCardxml>"+patientxmlenc+"</DriverLicenseCardxml><randomnumber>"+$scope.randomnumber+"</randomnumber><SetCookie>"+cookie+"</SetCookie><server>"+ServerURL+"</server><userId>"+global.TrUserId+"</userId></xml>";window.external.InvokeMedicScanWithPhoto(patientxmlenc,'0')}else{setTimeout(function(){var ptInfoscope=$('[ng-controller="ptInfoController"]').scope();ptInfoscope.RefreshDemographicsButton=true;ptInfoscope.medicscanparent='ptlookup';$("#RefreshDemographicsButton").removeClass('hide');$("#RefreshDemographicsCustom-text").text("Please wait until data is being fetched...");$(".refresh-hold").removeClass('hide');$("#RefreshDemographicsCustom-text").css("color","#FFF");$("#RefreshDemographicsCustom-text").text("Click here to get latest driver license info");$(".refr-div").addClass('show');inputparam="<xml><patientId>0</patientId><usrlogid>"+global.TrUserId+"</usrlogid><DriverLicenseCardxml></DriverLicenseCardxml><randomnumber>"+$scope.randomnumber+"</randomnumber><SetCookie>"+cookie+"</SetCookie><server>"+ServerURL+"</server><userId>"+global.TrUserId+"</userId></xml>";try{launchPlugin('id=medicscanwithphoto|patientId=0|randomnumber='+$scope.randomnumber+'|usrlogid='+global.TrUserId+'|userId='+global.TrUserId+'|DriverLicenseCardxml=|inputparam='+inputparam)}catch(err){console.log(err)}},500)}return true}openImportSuccessPopup=function(result){if(result){}};function getMyFacilities(){var url="/mobiledoc/jsp/catalog/xml/edi/getFacilityList.jsp?MAXCOUNT=10000&counter=0&FacilityType=1&TrUserId="+global.TrUserId;url=makeURL(url);var facilities='',strMyFacilityIds='';facilities=searchData(url,'jsonData.Envelope.Body["return"].facilities.facility');if(facilities){for(var i=0;i<facilities.length;i++){strMyFacilityIds+=facilities[i].Id+","}}if(strMyFacilityIds.length>1){strMyFacilityIds=strMyFacilityIds.substring(0,strMyFacilityIds.length-1).trim()}return strMyFacilityIds}function deletePatientSearchHistory(patientId){var patientSearchHistory=getPatientSearchHistory();var updatedPtSearchHistory=[];var hasdeletedPtSearchHistory=false;for(var i=0;i<patientSearchHistory.length;i++){if(patientSearchHistory[i].id!==patientId){updatedPtSearchHistory.push(patientSearchHistory[i])}else{hasdeletedPtSearchHistory=true}}if(hasdeletedPtSearchHistory){put("ECW_PAT_SEARCHHISTORY",JSON.stringify(updatedPtSearchHistory))}}
(function(){var telemedServiceModule=angular.module("ecw.telemed.service");if(!telemedServiceModule){return}telemedServiceModule.service("telemedInviteService",["$http","telemedLoggingService","opentokService","mySharedService","dataTruncUtilityService","SessionService",function($http,telemedLoggingService,opentokService,mySharedService,dataTruncUtilityService,SessionService){let isHealowPlusUser=getItemKeyValue("isHealowPlusEnabled").toUpperCase()==='YES';var televisitWrapperDIV=isHealowPlusUser?".healow-connect #containerDIV ":"#televisitWrapper ";let inviteeUtils={participantList:{},staffList:{},invitedStaffId:'',invitedStaffName:'',participantDetail:{},PATIENT_ID_INVITEE:'0',AUDIO:'1',VIDEO:'2',eventTimer:null,currentTime:'',contactsConnectionReferences:{},contactsStreams:{},MAXIMUM_PARTICIPANT:2,isClosedCaptionEnabled:false,jWTToken:null,setHeightInviteeWrapper:function(){$(".linkedcontact-body").css('height',$(".userchat").height()-100)},initiateInviteStaff:function(){inviteeListeners.btnStaffFn()},invokeStaffAssignmentService:function(param){try{return $http({method:"POST",url:makeURL("/mobiledoc/jsp/telemed/telemedResponse.jsp"),data:$.param(param),headers:{'Content-Type':'application/x-www-form-urlencoded'}})}catch(err){ecwAlert('Issue while trying to staff assignment')}},displayConfirmationToolTip:function(event,remoteData){if(remoteData.data.relation&&remoteData.data.relation.toUpperCase()!=="STAFF"&&remoteData.data.relation.toUpperCase()!=="PROVIDER"){inviteeUtils.contactsConnectionReferences[remoteData.data.inviteid]=event.connection}if(Object.keys(inviteeUtils.contactsConnectionReferences).length<=inviteeUtils.MAXIMUM_PARTICIPANT){let contactPermissionContent=$('<div class="contactDIV open dropup mainDiv'+remoteData.data.inviteid+'">'+'<ul id="contactMenu" class="dropdown-menu pull-right yellow-tiped uiElement" style="width:100%">'+'<li class="fontContact text-center">'+remoteData.data.username+' ('+remoteData.data.relation+'), invited by '+remoteData.data.inviteby+' is requesting to join the TeleVisit in progress</li>'+'<li align="center" class="mt10">'+'<button id="teleEndCallPopup-tplBtn1C" class="btnFont admitBtn mr2" class="btn btn btn-lblue btn-lgrey btn-xs btn-default"  userid="'+remoteData.data.userid+'"inviteid="'+remoteData.data.inviteid+'" >Admit</button>'+'<button id="teleEndCallPopup-tplBtn2C" class="btn btn btn-lgrey btn-xs btn-default declineBtn" userid="'+remoteData.data.userid+'" inviteid="'+remoteData.data.inviteid+'" >Decline</button>'+'</li>'+'</ul>'+'</div>');$("#contactPermissionDiv").append(contactPermissionContent);if(isHealowPlusUser){SessionService.callInviteeJoinedTV()}}else{inviteeUtils.allowContactToJoin(false,true,remoteData.data.inviteid)}},displayTvUserConfirmation:function(event,remoteData){let tvUserPermissionContent=$('<div class="providerDIV open dropup mainDiv'+remoteData.data.userid+'">'+'<ul id="cproviderMenu" class="dropdown-menu pull-right yellow-tiped uiElement" style="width:100%">'+'<li class="fontContact text-center">'+remoteData.data.username+' is requesting to join the TeleVisit in progress</li>'+'<li align="center" class="mt10">'+'<button id="teleEndCallPopup-tplBtn1C" class="btnFont tvUserAdmitBtn mr2" class="btn btn btn-lblue btn-lgrey btn-xs btn-default" userid="'+remoteData.data.userid+'">Admit</button>'+'<button id="teleEndCallPopup-tplBtn2C" class="btn btn btn-lgrey btn-xs btn-default tvUserDeclineBtn" userid="'+remoteData.data.userid+'">Decline</button>'+'</li>'+'</ul>'+'</div>');$("#contactPermissionDiv").append(tvUserPermissionContent);if(isHealowPlusUser){SessionService.callInviteeJoinedTV()}},displayRevokeInviteContent:function(event,remoteData){let revokeInviteContent=$('<div class="providerDIV open dropup mainDiv'+remoteData.data.userid+'" style="padding: 0px;">'+'<ul id="cproviderMenu" class="dropdown-menu pull-right uiElement" style="padding: 4px;margin: -5px;">'+'<li class="fontContact">'+remoteData.data.username+' is requesting to join the TeleVisit in progress</li>'+'<li class="fontContact">In order to accept the join request, please cancel an invitation by clicking on remove button from the invitee list</li>'+'<li align="center" class="mt10">'+'<button id="teleEndCallPopup-tplBtn1C" style="margin: 5px;" class="btn btn-warning btn-xs tvUserAdmitBtn" class="btn btn btn-lblue btn-lgrey btn-xs btn-default" userid="'+remoteData.data.userid+'" disabled >Admit</button>'+'<button id="teleEndCallPopup-tplBtn2C" style="margin: 5px;" class="btn btn btn-lgrey btn-xs btn-default tvUserDeclineBtn" userid="'+remoteData.data.userid+'">Decline</button>'+'</li>'+'</ul>'+'</div>');$("#reovkeInviteDiv").append(revokeInviteContent);$(televisitWrapperDIV+'#staticBackdrop '+'.inviteConfirmModalClose').hide();$(televisitWrapperDIV+'#staticBackdrop '+'.inviteConfirmFormHeader').hide();$(televisitWrapperDIV+'#staticBackdrop '+'.inviteStaffStaticNote').hide();$(televisitWrapperDIV+'#staticBackdrop '+'.inviteConfirmFooter').hide();$(televisitWrapperDIV+'#staticBackdrop '+'#inviteUserListDiv').css('padding-top','10%');$(televisitWrapperDIV+'#staticBackdrop').modal({backdrop:'static',keyboard:false},'show');$("#reovkeInviteDiv").attr('isRevokeDisplay',true)},parseJSONUtility:function(data){var connectionData;try{connectionData=$.parseJSON(data)}catch(e){return null}return connectionData},clearEventTimer:function(){if(inviteeUtils.eventTimer){clearTimeout(inviteeUtils.eventTimer);inviteeUtils.eventTimer=null}},bindMask:function(){inviteeUtils.clearEventTimer();inviteeUtils.eventTimer=setTimeout(function(){$(televisitWrapperDIV+'.inviteMobileNo, '+televisitWrapperDIV+'#otherMobileNo').inputmask(inviteeListeners.CONSTANT.maskMobileFormat);$(televisitWrapperDIV+".btn-send-invite").addClass('disabled');inviteeUtils.clearEventTimer()},2e3)},clearContactStream:function(event){var data=inviteeUtils.parseJSONUtility(event.stream.connection.data);if(data.data&&data.data.usertype&&data.data.usertype==="contact"){delete inviteeUtils.contactsStreams[data.data.inviteid]}},hasElement:function(prop,value,data){return data.some(function(obj){return prop in obj&&obj[prop]===value})},allowContactToJoin:function(value,isFull,inviteId,userId){if(userId==undefined){userId=0}if(value===true){inviteeUtils.getAuth_Token(userId)}if(!value){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/getInviteById"),data:{inviteId:inviteId},type:"POST","async":false,success:function(data){let staffList=data.inviteDetails;for(var i=0;i<staffList.length;i++){var item=staffList[i];if(item.inviteId==inviteId){$("#"+item.inviteeId).prop("checked",false);$("#"+item.inviteeId).prop("disabled",false);$("#lastLabel"+item.inviteeId).hide();$("#lastMessage"+item.inviteeId).hide()}}}});if(userId&&userId>0){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/cancelInvite"),data:{staffId:userId,encounterId:mySharedService.encounterId},type:"POST","async":false,success:function(){},error:function(e){console.log("decline Staff Invite ERROR :"+e.message)}})}}else{$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/updateInvite"),data:{inviteId:inviteId,status:1},type:"POST","async":false,success:function(){},error:function(e){console.log("decline Staff Invite ERROR :"+e.message)}})}$(".mainDiv"+inviteId).remove();opentokService.getSession().signal({type:"permissionForConnect",data:{to:mySharedService.patientId,from:mySharedService.providerID,encId:mySharedService.encounterId,loginUID:global.TrUserId,isAllow:value,reachedMaximumCapacity:isFull,inviteId:inviteId,userId:userId,auth_token:inviteeUtils.getAuth_Token(userId),aiEndPoint:getItemKeyValue("SunohEndPoint")}},function(error){if(error){ecwAlert("Unable to perform operation.")}})},getAuth_Token:function(userId){$.ajax({url:makeURL("/mobiledoc/modules/webemr/sunoh/get/jwttoken?TrUserId="+userId),type:"GET","async":false,success:function(data){inviteeUtils.jWTToken=data}});return inviteeUtils.jWTToken},allowTvUserToJoin:function(value,isFull,userId){$(".mainDiv"+userId).remove();let isRevokeDisplay=$("#reovkeInviteDiv").attr('isRevokeDisplay');if(isRevokeDisplay){$("#reovkeInviteDiv").attr('isRevokeDisplay',false);$(televisitWrapperDIV+'#staticBackdrop').hide();$(televisitWrapperDIV+'#staticBackdrop '+'.inviteConfirmModalClose').show();$(televisitWrapperDIV+'#staticBackdrop '+'.inviteConfirmFormHeader').show();$(televisitWrapperDIV+'#staticBackdrop '+'.inviteStaffStaticNote').show();$(televisitWrapperDIV+'#staticBackdrop '+'.inviteConfirmFooter').show();$(televisitWrapperDIV+'#staticBackdrop '+'#inviteUserListDiv').css('padding-top','')}opentokService.getSession().signal({type:"permissionForTvUser",data:{encid:mySharedService.encounterId,userid:userId,isallow:value,ismaxcapacityreached:isFull}},function(error){if(error){ecwAlert("Unable to perform operation.")}})},processForPSAC:function(userId,name,currentTime){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/psac"),data:{patientId:mySharedService.patientId,userId:userId},type:"POST",success:function(data){if(data&&data.isAuthorize===false){let psacEnableBreakGlass=getItemKeyValue("EnablePSACBreakGlass");if(psacEnableBreakGlass===''||psacEnableBreakGlass.toString().toLowerCase()==='no'||psacEnableBreakGlass.toString()==='0'){if($("#lastLabel"+userId).length){$("#"+userId).prop('checked',false);$("#"+userId).attr('disabled','disabled');$("#lastLabel"+userId).html("Restricted to invite due to PSAC");$("#lastLabel"+userId).css('color','red');$("#lastLabel"+userId).show();$("#lastMessage"+userId).show()}else{inviteeListeners.displayInviteErrorMsg(name+" restricted to invite due to PSAC");$(".linkedcontact-body").animate({scrollTop:0},"slow")}return false}else{let userInfo=[];userInfo.push(userId);userInfo.push(name);$("#lastLabel"+userId).show();$("#lastMessage"+userId).show();$("#"+userId).prop('checked',true);$("#"+userId).attr('disabled','disabled');inviteeUtils.inviteStaff(userInfo,currentTime)}}else{let userInfo=[];userInfo.push(userId);userInfo.push(name);$("#lastLabel"+userId).show();$("#lastMessage"+userId).show();$("#"+userId).prop('checked',true);$("#"+userId).attr('disabled','disabled');inviteeUtils.inviteStaff(userInfo,currentTime)}},error:function(e){return false}})},inviteStaff:function(userInfo,currentTime){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/inviteStaff"),data:{staffName:userInfo[1],userId:userInfo[0],encId:mySharedService.encounterId},type:"POST",success:function(data){let list=[{id:userInfo[0],name:userInfo[1],currentTime:currentTime}];$("#staff-lookup_staff_Ipt1").val("");let inviteDetail={"userInfo":userInfo,"inviterUserId":global.TrUserId,"patientId":mySharedService.patientId,"encounterID":mySharedService.encounterId,"providerID":mySharedService.providerID};opentokService.getGeneralSession().signal({type:"inviteStaff",data:inviteDetail},function(error){if(error){ecwAlert("Unable to perform operation.")}})},error:function(e){}})},isExistContact:function(participantList){for(var key in participantList){if(key>0){return true}}return false},getRequestObject:function(callReason,inviteid,scope,LOG_REASONS){let requestData={};for(var keys in inviteeUtils.participantDetail){inviteeUtils.participantDetail[keys].trUserId=global.TrUserId;inviteeUtils.participantDetail[keys].providerId=mySharedService.providerID;inviteeUtils.participantDetail[keys].encID=mySharedService.encounterId;inviteeUtils.participantDetail[keys].patientID=mySharedService.patientId;inviteeUtils.participantDetail[keys].patientName=scope.users[mySharedService.encounterId].fullName;inviteeUtils.participantDetail[keys].providerSourceCall="10E";inviteeUtils.participantDetail[keys].callReason=callReason;inviteeUtils.participantDetail[keys].providerStreamID=callingInfo["providerStreamID"];if(!multipleVideoReferences[mySharedService.encounterId]){inviteeUtils.participantDetail[keys].startTime=(new Date).getTime();inviteeUtils.participantDetail[keys].endTime=inviteeUtils.participantDetail[keys].startTime}else{inviteeUtils.participantDetail[keys].endTime=(new Date).getTime()}}var callEndCases=[LOG_REASONS.REASON_PROVIDER_DISCONNECTED_CALL,LOG_REASONS.REASON_PROVIDER_INTERRUPTED_CALL,LOG_REASONS.REASON_PROVIDER_CHECKEDOUT_CALL,LOG_REASONS.REASON_PATIENT_ENDED_CALL,LOG_REASONS.CALL_IS_ON_HOLD];if(inviteid===0&&callEndCases.includes(callReason)){requestData=inviteeUtils.participantDetail;inviteeUtils.participantDetail={}}else{requestData[inviteid]=inviteeUtils.participantDetail[inviteid];delete inviteeUtils.participantDetail[inviteid]}requestData["is3WayCall"]="1";return requestData},getTelemedInviteMsg:function(msgData){switch(msgData){case"InvitationSuccessfullySent":return"Invitation has been sent successfully";case"At":return"At";case"InvitationCouldNotSent":return"Invitation Could not sent.";case"LastInvitedBy":return"Last invited at";case"MaximumInvitationLimitReached":return"You have reached the maximum number of invitations sent (ten). Please wait ";case"WaitForIntvite":return"minutes before sending additional invitations.";case"Minutes":return"Minutes";case"InviteContactFirstNameValidation":return"Please enter valid first name";case"InviteContactLastNameValidation":return"Please enter valid last name";case"InviteContactEmailMobileValidation":return"Either Mobile Number or EmailID should be filled to send invitation";case"InviteContact":return"Invite Contact";case"Other":return"Other";case"InviteOtherContact":return"Invite Other Contact";case"InviteStaff":return"Invite Staff";case"PleaseEnterValidEmailAddress":return"Error: Please enter a valid email address. Example: john@gmail.com";case"InviteeRejectMsg":return"Unable to join the visit at this time."}}};var inviteeListeners={logIntervalObj:null,alreadyBind:false,CONSTANT:{},initConstant:function(){inviteeListeners.CONSTANT={maskMobileFormat:'999-999-9999',lastNameObj:$(televisitWrapperDIV+'#otherContactLastName'),firstNameObj:$(televisitWrapperDIV+'#otherContactFirstName'),staffLastNameObj:$(televisitWrapperDIV+'#staffLastName'),staffFirstNameObj:$(televisitWrapperDIV+'#staffFirstName')}},inviteDetail:{},closePopupFn:function(e){e.stopImmediatePropagation();var elPopup=$('.custom-popup');if(elPopup.is(':visible'))elPopup.hide()},onChangeCheckBoxFn:function(e){var _this=$(e.target);var elParent=_this.parents('.listblock');elParent.addClass('active');if((elParent.find('.selective_mobile_checkbox').is(":checked")||elParent.find('.selective_email_checkbox').is(":checked"))&&$(televisitWrapperDIV+"#inviteErrMsg").is(':empty')){elParent.find('.btn-send-invite').removeClass('disabled')}else{elParent.find('.btn-send-invite').addClass('disabled')}},emailOnKeyUpFn:function(e){var _this=$(e.target);var elParent=_this.parents('.phone-number-dd');var email=_this.val();if($.trim(email)!==""&&$.trim(email).length>0){var filter=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;elParent.find('[type="checkbox"]').prop('checked',filter.test(email));elParent.find('[type="checkbox"]').change()}},mobileOnKeyUpFn:function(e){var _this=$(e.target);var elParent=_this.parents('.phone-number-dd');var mobileNo=_this.val().replace(/[-_]/g,'');elParent.find('[type="checkbox"]').prop('checked',$.trim(mobileNo)!==""&&$.trim(mobileNo).length>0&&$.trim(mobileNo).length===10);elParent.find('[type="checkbox"]').change()},btnOtherContactFn:function(e){e.stopImmediatePropagation();$(televisitWrapperDIV+'.inviteHeader').text("Up to 2 contacts may join.");$(televisitWrapperDIV+'.custom-popup.invite-popup .popup-header .captiontxt').text(inviteeUtils.getTelemedInviteMsg("InviteStaff"));$(televisitWrapperDIV+'.lbl-upto-contact').removeClass('ml-95').addClass('ml-135');$(televisitWrapperDIV+'.list-contact.linked-contact-list,.btn-invite-contact, .invited-contact').show();$(televisitWrapperDIV+'.btn-footer-send-invite, .stafflookup, .other-contact-wrapper,.btn-footer-send-invite, .staff-wrapper').hide();$(televisitWrapperDIV+'#contactBtn').hide();$(televisitWrapperDIV+'#staffBtn').hide();$(".col-sm-12.nopadding.popup-body.hgt250.linkedcontact-body").css("height: 72% !important;")},btnContactFn:function(e){e.stopImmediatePropagation();inviteeListeners.CONSTANT.firstNameObj.val("");inviteeListeners.CONSTANT.lastNameObj.val("");$(televisitWrapperDIV+'#otherMobileNo').val("");$(televisitWrapperDIV+'#otherEmail').val("");$(televisitWrapperDIV+'.custom-popup.invite-popup .popup-header .captiontxt').text(inviteeUtils.getTelemedInviteMsg("InviteOtherContact"));$(televisitWrapperDIV+'.lbl-upto-contact').removeClass('ml-95').addClass('ml-135');$(televisitWrapperDIV+'.list-contact.linked-contact-list,.invited-contact,.stafflookup, .btn-invite-contact,.staff-wrapper').hide();$(televisitWrapperDIV+'.other-contact-wrapper,.btn-prev-state, .btn-footer-send-invite, .btn-blue-fill').show();$(televisitWrapperDIV+'.check-invite-name').prop('checked',false);$(televisitWrapperDIV+'#contactBtn').show();$(televisitWrapperDIV+'#staffBtn').hide();$(televisitWrapperDIV+'.btn-footer-send-invite').show();$(".col-sm-12.nopadding.popup-body.hgt250.linkedcontact-body").css("height: 72% !important;")},btnStaffFn:function(e){$(televisitWrapperDIV+'.inviteHeader').text("Up to 2 staff/provider may join.");$(televisitWrapperDIV+'#staffMobileNo').val("");$(televisitWrapperDIV+'#staffEmail').val("");$(televisitWrapperDIV+".orange-filter").hide();$(televisitWrapperDIV+"#staff-lookup_staff_Ul2").remove();$(televisitWrapperDIV+".patient-lookup").css("width","240px !important");$(televisitWrapperDIV+"#staff-lookup_staff_Ul1").css("width","240px !important");$(televisitWrapperDIV+"#staff-lookup_staff_Btn2").remove();$(televisitWrapperDIV+"#listAllStaff_staff").remove();$(televisitWrapperDIV+"#staff-lookup_staff_Btn1").remove();$(televisitWrapperDIV+'.custom-popup.invite-popup .popup-header .captiontxt').text(inviteeUtils.getTelemedInviteMsg("InviteStaff"));$(televisitWrapperDIV+'.lbl-upto-contact').removeClass('ml-95').addClass('ml-135');$(televisitWrapperDIV+'.list-contact.linked-contact-list,.invited-contact,.icon-left-arrow-blue,.btn-invite-contact,.other-contact-wrapper').hide();$(televisitWrapperDIV+'.staff-wrapper, .stafflookup,.btn-blue-fill').show();$(".col-sm-12.nopadding.popup-body.hgt250.linkedcontact-body").css("height: 60% !important;");$("#staff-lookup_staff_Ipt1").val("");$(televisitWrapperDIV+'#contactBtn').hide();$(televisitWrapperDIV+'#staffBtn').show()},popupStateFn:function(e){$(televisitWrapperDIV+'.custom-popup.invite-popup .popup-header .captiontxt').text(inviteeUtils.getTelemedInviteMsg("InviteContact"));$(televisitWrapperDIV+'.list-contact.linked-contact-list,.btn-invite-contact').show();$(televisitWrapperDIV+'.other-contact-wrapper,.btn-prev-state').hide();$(televisitWrapperDIV+'.lbl-upto-contact').removeClass('ml-135').addClass('ml-95');$(televisitWrapperDIV+'.btn-footer-send-invite').hide();$(televisitWrapperDIV+'#contactBtn').hide()},processInviteStaff:function(id,name){let currentDate=new Date;let date=new Date(currentDate.getTime()+currentDate.getTimezoneOffset()*6e4);let currentTime=date.getFullYear()+'-'+inviteeListeners.padTo2Digits(date.getMonth()+1)+'-'+inviteeListeners.padTo2Digits(date.getDate())+' '+inviteeListeners.padTo2Digits(date.getHours())+':'+inviteeListeners.padTo2Digits(date.getMinutes())+':'+inviteeListeners.padTo2Digits(date.getSeconds());$("#sentLast"+id).attr('sentTime',currentTime);inviteeUtils.processForPSAC(id,name,currentTime)},btnFooterFn:function(e){if($('.staff-wrapper').is(':visible')){}else{var userId=0;var _this=$(this),elParent=_this.parents('.listblock');var selectedOptn=elParent.find('[name="list_name"]');var parentForm=elParent.find('.form-section');if(elParent.length>0){userId=parseInt(selectedOptn.attr("contact_id"),10)||0}inviteeListeners.inviteDetail["userId"]=userId;var contactName="",mobileNo="",email="",isMobile=false,isEmail=false,sendType=1;if(selectedOptn.length>0&&userId>0){contactName=selectedOptn.attr("contact_name")+"("+selectedOptn.attr("relation")+")";mobileNo=elParent.find('.inviteMobileNo').val();email=elParent.find('.inviteEmail').val();if(parentForm.find('[name="phone_number_checkbox"]').is(":checked")){isMobile=true}if(parentForm.find('[name="email_number_checkbox"]').is(":checked")){isEmail=true}inviteeListeners.inviteDetail["contactLastName"]=selectedOptn.attr("contact_name").split(",")[0];inviteeListeners.inviteDetail["contactFirstName"]=selectedOptn.attr("contact_name").split(",")[1];inviteeListeners.inviteDetail["relation"]=selectedOptn.attr("relation")}else{contactName=inviteeListeners.CONSTANT.lastNameObj.val()+", "+inviteeListeners.CONSTANT.firstNameObj.val()+" ("+inviteeUtils.getTelemedInviteMsg("Other")+") ";mobileNo=$(televisitWrapperDIV+'#otherMobileNo').val();email=$(televisitWrapperDIV+'#otherEmail').val();if(mobileNo!==""){isMobile=true}if(email!==""){isEmail=true}inviteeListeners.inviteDetail["contactLastName"]=inviteeListeners.CONSTANT.lastNameObj.val();inviteeListeners.inviteDetail["contactFirstName"]=inviteeListeners.CONSTANT.firstNameObj.val();inviteeListeners.inviteDetail["relation"]="Other"}inviteeListeners.inviteDetail["contactName"]=contactName;inviteeListeners.inviteDetail["mobileNo"]=mobileNo;inviteeListeners.inviteDetail["email"]=email;inviteeListeners.inviteDetail["isMobile"]=isMobile;inviteeListeners.inviteDetail["isEmail"]=isEmail;$(televisitWrapperDIV+"#textResponse").empty();$(televisitWrapperDIV+"#emailResponse").empty();if(inviteeListeners.validate(userId,mobileNo,email,inviteeListeners.CONSTANT.lastNameObj.val(),inviteeListeners.CONSTANT.firstNameObj.val(),isMobile,isEmail)){$(televisitWrapperDIV+"#confirmName").html(contactName);$(televisitWrapperDIV+"#confirmMobile").html("");$(televisitWrapperDIV+"#confirmEmail").html("");if(mobileNo.length>0&&isMobile){$(televisitWrapperDIV+"#confirmMobileDiv").show();$(televisitWrapperDIV+"#confirmMobile").html(mobileNo)}else{$(televisitWrapperDIV+"#confirmMobileDiv").hide()}if(email.length>0&&isEmail){$(televisitWrapperDIV+"#confirmEmailDiv").show();$(televisitWrapperDIV+"#confirmEmail").html(email)}else{$(televisitWrapperDIV+"#confirmEmailDiv").hide()}$(televisitWrapperDIV+'#reviewInviteModal').modal('show');$(televisitWrapperDIV+'.custom-popup').hide()}$(televisitWrapperDIV+'.invite-send-btn').show();$(televisitWrapperDIV+'#inviteReviewCloseBtn').hide()}},btnSendFn:function(e){var _this=$(this);$(televisitWrapperDIV+'.custom-popup.invite-popup .popup-header .captiontxt').text(inviteeUtils.getTelemedInviteMsg("InviteContact"));$(televisitWrapperDIV+'.list-contact.linked-contact-list,.btn-invite-contact').show();$(televisitWrapperDIV+'.other-contact-wrapper,.btn-prev-state').hide();$(televisitWrapperDIV+'.btn-footer-send-invite').hide();_this.hide();inviteeListeners.inviteContact()},displayInviteErrorMsg:function(errMsg){$(televisitWrapperDIV+"#inviteErrorstatus").show();$(televisitWrapperDIV+"#inviteErrMsg").html(errMsg)},hideInviteErrMsg:function(){$(televisitWrapperDIV+"#inviteErrorstatus").hide();$(televisitWrapperDIV+"#inviteErrMsg").empty()},startInviteTimer:function(duration,display){var timer=duration,minutes,seconds;var intervalObj=setInterval(function(){minutes=parseInt(timer/60,10);seconds=parseInt(timer%60,10);minutes=minutes<10?"0"+minutes:minutes;seconds=seconds<10?"0"+seconds:seconds;display.text(minutes+":"+seconds);if(--timer<0){display.text("");inviteeListeners.hideInviteErrMsg();clearInterval(intervalObj);$(televisitWrapperDIV+'.btn-send-invite').removeClass('disabled');$(televisitWrapperDIV+".btn-footer-send-invite").removeClass('disabled')}},1e3)},inviteContact:function(){var userId=inviteeListeners.inviteDetail["userId"],relation=inviteeListeners.inviteDetail["relation"],mobileNo="",email="",contactFirstName=inviteeListeners.inviteDetail["contactFirstName"],contactLastName=inviteeListeners.inviteDetail["contactLastName"];var isEmail=inviteeListeners.inviteDetail["isEmail"],isMobile=inviteeListeners.inviteDetail["isMobile"];if(isMobile){mobileNo=inviteeListeners.inviteDetail["mobileNo"];$("#textResponse").html('<img src="'+makeURL("/mobiledoc/jsp/webemr/telemed/img/animate-loader.gif")+'" class="animate-loader" alt="" style="height: 10px;">')}if(isEmail){email=inviteeListeners.inviteDetail["email"];$("#emailResponse").html('<img src="'+makeURL("/mobiledoc/jsp/webemr/telemed/img/animate-loader.gif")+'" class="animate-loader" alt="" style="height: 10px;">')}$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/inviteTVContact"),data:{contactFirstName:contactFirstName.trim(),contactLastName:contactLastName.trim(),uId:userId,relation:relation.trim(),mobileNo:encodeURIComponent(mobileNo),email:encodeURIComponent(email.trim()),encId:$("#encId").val()},type:"POST",success:function(data){try{var emailStatus=0,textStatus=0;var dateStringWithTime=moment().utc().format('YYYY-MM-DD HH:mm:ss');var lastSentTimeDiff=data.lastSentTimeDiff;var invitedCount=data.inviteCount;var content="";if(isEmail){emailStatus=data.emailStatus;if(emailStatus===1){content+=email+" ";$(televisitWrapperDIV+"#emailResponse").html('<span class="icon green-tick" data-toggle="tooltip" data-toggle="tooltip" data-placement="bottom" title="'+inviteeUtils.getTelemedInviteMsg("InvitationSuccessfullySent")+'"></span>')}else{$(televisitWrapperDIV+"#emailResponse").html('<span class="icon red-exclaim" data-toggle="tooltip" data-placement="bottom" title="'+inviteeUtils.getTelemedInviteMsg("InvitationCouldNotSent")+'"></span>')}}else{emailStatus=1}if(isMobile){textStatus=data.textStatus;if(textStatus===1){content+=mobileNo+" ";$(televisitWrapperDIV+"#textResponse").html('<span class="icon green-tick" data-toggle="tooltip" data-toggle="tooltip" data-placement="bottom" title="'+inviteeUtils.getTelemedInviteMsg("InvitationSuccessfullySent")+'"></span>')}else{$(televisitWrapperDIV+"#textResponse").html('<span class="icon red-exclaim" data-toggle="tooltip" data-placement="bottom" title="'+inviteeUtils.getTelemedInviteMsg("InvitationCouldNotSent")+'"></span>')}}else{textStatus=1}if((isMobile&&textStatus===1||isEmail&&emailStatus===1)&&invitedCount!==0&&invitedCount%10===0&&lastSentTimeDiff<300&&lastSentTimeDiff>0){var waitingTime=300-lastSentTimeDiff;inviteeListeners.displayInviteErrorMsg(inviteeUtils.getTelemedInviteMsg("MaximumInvitationLimitReached")+'<span id="inviteTime"></span>'+' '+inviteeUtils.getTelemedInviteMsg("WaitForIntvite"));inviteeListeners.startInviteTimer(waitingTime,$('#inviteTime'));$(televisitWrapperDIV+"#inviteErrMsgClose").hide();$(televisitWrapperDIV+".btn-send-invite").addClass('disabled');$(televisitWrapperDIV+".btn-footer-send-invite").addClass('disabled')}else{inviteeListeners.hideInviteErrMsg();$(televisitWrapperDIV+"#inviteErrMsgClose").show()}$(televisitWrapperDIV+'.lbl-upto-contact').removeClass('ml-135').addClass('ml-95');$(televisitWrapperDIV+'#inviteReviewCloseBtn').show()}catch(e){$(televisitWrapperDIV+'#inviteReviewCloseBtn').show()}},error:function(e){$(televisitWrapperDIV+'#inviteReviewCloseBtn').show()}})},validate:function(userId,mobileNo,email,contactLastName,contactFirstName,isMobile,isEmail){inviteeListeners.hideInviteErrMsg();if(userId===0){var alphabetFilter=/^[a-zA-Z ]*$/;if($.trim(contactFirstName)===""||!alphabetFilter.test(contactFirstName)){inviteeListeners.displayInviteErrorMsg(inviteeUtils.getTelemedInviteMsg("InviteContactFirstNameValidation"));inviteeListeners.CONSTANT.firstNameObj.focus();return false}if($.trim(contactLastName)===""||!alphabetFilter.test(contactLastName)){inviteeListeners.displayInviteErrorMsg(inviteeUtils.getTelemedInviteMsg("InviteContactLastNameValidation"));inviteeListeners.CONSTANT.lastNameObj.focus();return false}}if($.trim(mobileNo)===""&&$.trim(email)===""||!isMobile&&!isEmail){inviteeListeners.displayInviteErrorMsg(inviteeUtils.getTelemedInviteMsg("InviteContactEmailMobileValidation"));return false}if($.trim(email)!==""&&$.trim(email).length>0){var filter=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(!filter.test(email)){inviteeListeners.displayInviteErrorMsg(inviteeUtils.getTelemedInviteMsg("PleaseEnterValidEmailAddress"));return false}}if(isEmail&&$.trim(email)===""){inviteeListeners.displayInviteErrorMsg("You must enter a valid email address.");return false}if(isMobile&&$.trim(mobileNo)===""){inviteeListeners.displayInviteErrorMsg("You must enter a valid mobile number.");return false}var isValidData;if(inviteeListeners.inviteDetail["relation"]==='Other'){isValidData=dataTruncUtilityService.getTextFieldWidthsFromTable("web_telemed_invitee_screen","new_contact_list","orangetheme")}else{isValidData=dataTruncUtilityService.getTextFieldWidthsFromTable("web_telemed_invitee_screen","telemedInviteeLinkedContacts","orangetheme")}if(!isValidData){return false}return true},padTo2Digits:function(num){return num.toString().padStart(2,'0')},formatDate:function(id,currentDate){let date=new Date(currentDate.getTime()+currentDate.getTimezoneOffset()*6e4);let currentTime=date.getFullYear()+'-'+inviteeListeners.padTo2Digits(date.getMonth()+1)+'-'+inviteeListeners.padTo2Digits(date.getDate())+' '+inviteeListeners.padTo2Digits(date.getHours())+':'+inviteeListeners.padTo2Digits(date.getMinutes())+':'+inviteeListeners.padTo2Digits(date.getSeconds());$("#sentLast"+id).attr('sentTime',currentTime)},lastInvitationLog:function(){var currentDate=new Date;var startTimeMillisUTC=new Date(currentDate.getTime()+currentDate.getTimezoneOffset()*6e4);var currentTime=startTimeMillisUTC.getTime();$(".lastInviteLog").each(function(index){var sentTime=$(this).attr("sentTime");var lastInviteDate=new Date(sentTime);var lastInviteTime=lastInviteDate.getTime();var timeDiff=currentTime-lastInviteTime;var lastInviteText=inviteeListeners.getLastInviteText(timeDiff);$(this).html(" "+lastInviteText)});$(".lastStaffInviteLog").each(function(index){var sentTime=$(this).attr("sentTime");var lastInviteDate=new Date(sentTime);var lastInviteTime=lastInviteDate.getTime();var timeDiff=currentTime-lastInviteTime;var lastInviteText=inviteeListeners.getLastStaffInviteText(timeDiff);$(this).html(" "+lastInviteText)})},getLastStaffInviteText:function(timeDiff){var secs=Math.floor(timeDiff/1e3);if(secs<60)return"Last invited few seconds ago";if(secs<3600)return"Last invited "+Math.floor(secs/60)+" minutes ago";if(secs<86400)return"Last invited "+Math.floor(secs/3600)+" hours ago";if(secs<2592001)return"Last invited "+Math.floor(secs/86400)+" days ago"},getLastInviteText:function(timeDiff){var secs=Math.floor(timeDiff/1e3);if(secs<60)return" few seconds ago";if(secs<3600)return Math.floor(secs/60)+" minutes ago";if(secs<86400)return Math.floor(secs/3600)+" hours ago";if(secs<2592001)return Math.floor(secs/86400)+" days ago"},bindListeners:function(){try{if(inviteeListeners.alreadyBind){return}inviteeListeners.alreadyBind=true;inviteeListeners.initConstant();$(document).on('click',televisitWrapperDIV+'.close-popup',inviteeListeners.closePopupFn);$(document).on('change',televisitWrapperDIV+'.selective_mobile_checkbox, '+televisitWrapperDIV+'.selective_email_checkbox',inviteeListeners.onChangeCheckBoxFn);$(document).on('keyup',televisitWrapperDIV+".inviteEmail",inviteeListeners.emailOnKeyUpFn);$(document).on('keyup',televisitWrapperDIV+".inviteMobileNo",inviteeListeners.mobileOnKeyUpFn);$(document).on('click',televisitWrapperDIV+'.btn-invite-contact',inviteeListeners.btnContactFn);$(document).on('click',televisitWrapperDIV+'.btn-invite-staff',inviteeListeners.btnStaffFn);$(document).on('click',televisitWrapperDIV+'.btn-other-contact',inviteeListeners.btnOtherContactFn);$(document).on('click',televisitWrapperDIV+'.custom-popup.invite-popup .btn-prev-state',inviteeListeners.popupStateFn);$(document).on('click',televisitWrapperDIV+'.btn-send-invite, '+televisitWrapperDIV+'.btn-footer-send-invite',inviteeListeners.btnFooterFn);$(document).on('click',televisitWrapperDIV+'.invite-send-btn',inviteeListeners.btnSendFn);$(document).on('click',televisitWrapperDIV+'#inviteErrMsgClose',inviteeListeners.hideInviteErrMsg);$(document).on('click',televisitWrapperDIV+'.admitBtn',function(){inviteeUtils.allowContactToJoin(true,false,$(this).attr('inviteid'),$(this).attr('userid'))});$(document).on('click',televisitWrapperDIV+'.declineBtn',function(){inviteeUtils.allowContactToJoin(false,false,$(this).attr('inviteid'),$(this).attr('userid'))});$(document).on('click','.tvUserAdmitBtn',function(){inviteeUtils.allowTvUserToJoin(true,false,$(this).attr('userid'))});$(document).on('click','.tvUserDeclineBtn',function(){inviteeUtils.allowTvUserToJoin(false,false,$(this).attr('userid'))});inviteeListeners.logIntervalObj=setInterval(inviteeListeners.lastInvitationLog,5e3);var lastSentTimeDiff=$('#lastSentTimeDiff').val();var inviteCount=parseInt($('#inviteCount').val(),10)||0;if(inviteCount!==0&&inviteCount%10===0&&lastSentTimeDiff<300&&lastSentTimeDiff>0){var waitingTime=300-lastSentTimeDiff;inviteeListeners.displayInviteErrorMsg(inviteeUtils.getTelemedInviteMsg("MaximumInvitationLimitReached")+'<span id="inviteTime"></span>'+' '+inviteeUtils.getTelemedInviteMsg("WaitForIntvite"));inviteeListeners.startInviteTimer(waitingTime,$('#inviteTime'))}else{inviteeListeners.hideInviteErrMsg()}}catch(e){telemedLoggingService.error(e)}},unbindListeners:function(){try{inviteeListeners.alreadyBind=false;var elementArr=['.close-popup','.btn-invite-contact','.custom-popup.invite-popup .btn-prev-state','.btn-send-invite','.btn-footer-send-invite','.invite-send-btn','#inviteErrMsgClose','.admitBtn','.declineBtn','.tvUserAdmitBtn','.tvUserDeclineBtn'];for(var ele in elementArr){$(document).off('click',televisitWrapperDIV+elementArr[ele])}$(document).off('change',televisitWrapperDIV+'.selective_mobile_checkbox, '+televisitWrapperDIV+'.selective_email_checkbox');$(document).off('change',televisitWrapperDIV+'.inviteEmail, '+televisitWrapperDIV+'.inviteMobileNo');clearInterval(inviteeListeners.logIntervalObj);inviteeListeners.logIntervalObj=null}catch(e){telemedLoggingService.error(e)}}};var postCallService={getContactList:function(patientId){var param={patientId:patientId};param=$.param(param);return $http({method:"POST",url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/getContactList"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getInviteDetail:function(encId){var param={encId:encId};param=$.param(param);return $http({method:"POST",url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/getInviteDetail"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getStaffInviteDetail:function(encId,uId){let param={encId:encId,userId:uId};param=$.param(param);return $http({method:"POST",url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/getEncInviteDetail"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})},getStaffDetail:function(docId){var param={encId:docId};param=$.param(param);return $http({method:"POST",url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/getStaffDetail"),data:param,headers:{'Content-Type':'application/x-www-form-urlencoded'}})}};return{bindListeners:inviteeListeners.bindListeners,unbindEventListeners:inviteeListeners.unbindListeners,postCallService:postCallService,utils:inviteeUtils}}]);var telemedModule=angular.module("ecw.telemed");if(!telemedModule){return}telemedModule.directive('inviteeDirective',function(mySharedService,$compile,opentokService,opentokVideoService,telemedLoggingService,telemedInviteService){return{restrict:'EA',replace:'true',scope:false,templateUrl:'/mobiledoc/jsp/webemr/telemed/invite/tpl/telemed-invitee.jsp',link:function(scope,element,attrs,controller){var commonTimerObj=null;scope.inviteeFeature={contactList:[],contSubscriber:{},showInviteContact:false,isContactConnected:false,isPatientHasInviteeFeature:false,inviteHeight:50,isInviteContactEnable:false,onlinePersonList:[],isBroadCastMessaging:true,searchPerson:"",tvInviteStaffLimit:getItemKeyValue("TVInviteStaffLimit"),assignStaffList:[],invitedStaffList:[],scheduledProvider:[],selectedStaffIds:[],cancelInvitationList:[],currentTime:"",onlineUserIds:new Set,sendMessage:function(id){let message=$("#msgText_"+id).val();$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/saveMessage"),data:{messages:message,receiver:id,encounterId:mySharedService.encounterId},type:"POST",success:function(data){let messageDetail={"patientId":mySharedService.patientId,"inviterUserId":global.TrUserId,"receiver":id,"messages":message,"encounterID":mySharedService.encounterId};opentokService.getGeneralSession().signal({type:"sendMsg",data:messageDetail},function(error){if(error){ecwAlert("Unable to send message.")}});scope.inviteeFeature.messageWindowHide(id)},error:function(e){console.log("save Message ERROR :"+e.message)}})},showMessage:function(id){if($("#message_"+id).is(':visible')){scope.inviteeFeature.messageWindowHide(id)}else{$("#message_"+id).show()}},messageWindowHide:function(id){$("#message_"+id).hide();$("#msgText_"+id).val("");$('#sendMsg_'+id).css('pointer-events','none');$('#limitMsg_'+id).html("0&nbsp;")},validateLimit:function(id){let msgTextLen=$("#msgText_"+id).val().length;if(msgTextLen>0){$('#sendMsg_'+id).css('pointer-events','')}else{$('#sendMsg_'+id).css('pointer-events','none')}$('#limitMsg_'+id).html(msgTextLen+"&nbsp;")},checkConfirmInviteStaff:function(){let countOfCheck=0;let countOfRemove=0;let countOfOnCall=0;$('#staticBackdrop .formcheckinput').each(function(){if(this.checked){countOfCheck++}});$('#staticBackdrop .removeButton').each(function(){if($("#"+this.id).is(':visible')){countOfRemove++}});$('#staticBackdrop .disableOnCall').each(function(){countOfOnCall++});if(countOfRemove+countOfOnCall>=scope.inviteeFeature.tvInviteStaffLimit||countOfCheck>scope.inviteeFeature.tvInviteStaffLimit||countOfRemove+countOfOnCall+countOfCheck>scope.inviteeFeature.tvInviteStaffLimit){$("#inviteConfirmButton").removeClass("inviteConfirmFooterEnableButton");if(!$("#inviteConfirmButton").hasClass("inviteConfirmFooterButton")){$("#inviteConfirmButton").addClass("inviteConfirmFooterButton")}}else if(countOfRemove+countOfOnCall+countOfCheck<=scope.inviteeFeature.tvInviteStaffLimit){if(!$("#inviteConfirmButton").hasClass("inviteConfirmFooterEnableButton")){$("#inviteConfirmButton").addClass("inviteConfirmFooterEnableButton")}$("#inviteConfirmButton").removeClass("inviteConfirmFooterButton")}},removeInviteStaff:function(staffId){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/cancelInvite"),data:{staffId:staffId,encounterId:mySharedService.encounterId},type:"POST",success:function(data){if(data.result){$("#inviteConfirmLastText_"+staffId).hide();$("#label_"+staffId).css("background-color","");$("#remove_"+staffId).hide();$("#lastLabel"+staffId).hide();$("#lastMessage"+staffId).hide();$("#label_"+staffId).removeClass("inviteStaffLabel");$("#"+staffId).prop('checked',false);let staffName='';for(var i=0;i<scope.inviteeFeature.assignStaffList.length;i++){var item=scope.inviteeFeature.assignStaffList[i];if(item.id==staffId){staffName=item.name}}if(staffName.length<=0){for(var i=0;i<scope.inviteeFeature.invitedStaffList.length;i++){var item=scope.inviteeFeature.invitedStaffList[i];if(item.id==staffId){staffName=item.name}}}var checkBoxhtml="<input class=\"formcheckinput ng-scope\" ng-if=\"!staff.status.includes('Last') &amp;&amp; !staff.status.includes('In this')\" name=\"select_"+staffId+"\" value=\"select_"+staffName+"\" id=\"select_"+staffId+"\" type=\"checkbox\" ng-click=\"inviteeFeature.checkConfirmInviteStaff()\" ng-style=\" == 'In this session' ? 'pointer-events: none' : 'display: block'\">";var temp=$compile(checkBoxhtml)(scope);$("#label_"+staffId).before(temp);$("#"+staffId).prop("disabled",false);for(var j=0;j<scope.inviteeFeature.invitedStaffList.length;j++){if(staffId==scope.inviteeFeature.invitedStaffList[j].id){scope.inviteeFeature.invitedStaffList.splice(j,1)}}let cancelStaffInviteData={encounterId:mySharedService.encounterId,staffId:staffId};opentokService.getGeneralSession().signal({type:"cancelStaffInvite",data:cancelStaffInviteData},function(error){if(error){ecwAlert("Unable to perform operation.")}});scope.inviteeFeature.cancelInvitationList=[];scope.inviteeFeature.checkConfirmInviteStaff();let isRevokeDisplay=$("#reovkeInviteDiv").attr('isRevokeDisplay');if(isRevokeDisplay){$("#inputGroup_"+staffId).remove();$('.tvUserAdmitBtn').removeAttr('disabled')}}}})},sentConfirmInviteStaff:function(){let selectStaff=new Map;let staffId;let staffName;$('#staticBackdrop .formcheckinput').each(function(){staffId=this.id.replace('select_','');staffName=this.value.replace('select_','');if(this.checked){selectStaff.set(staffId,staffName)}});let invitedStaffMap=new Set;$('#staticBackdrop .removeButton').each(function(){staffId=this.id.replace('remove_','');if($("#"+this.id).is(':visible')){invitedStaffMap.add(staffId)}});$('#staticBackdrop .disableOnCall').each(function(){staffId=this.id.replace('label_','');invitedStaffMap.add(staffId)});if(selectStaff.size<=scope.inviteeFeature.tvInviteStaffLimit){selectStaff.forEach(function(value,key){scope.inviteeFeature.processInviteStaff(key,value)});scope.inviteeFeature.hideInvitePopUp();$('.staff-wrapper .form-check-input').each(function(){if(selectStaff.has(this.id)||invitedStaffMap.has(this.id)){$("#"+this.id).prop('checked',true)}else{$("#"+this.id).prop('checked',false)}})}telemedInviteService.utils.invitedStaffId=0;telemedInviteService.utils.invitedStaffName=''},sentInviteStaff:function(){if($("#staff-lookup_staff_Ipt1").val().trim().length>0){scope.inviteeFeature.processInviteStaff(telemedInviteService.utils.invitedStaffId,telemedInviteService.utils.invitedStaffName)}$('.staff-wrapper .form-check-input').each(function(){if(!$('#'+this.id).prop('disabled')&&this.checked||this.value!==""&&$("#staff-lookup_staff_Ipt1").val().trim()===this.value.trim()){scope.inviteeFeature.processInviteStaff(this.id,this.value)}});$("#staff-lookup_staff_Ipt1").val("");telemedInviteService.utils.invitedStaffId=0;telemedInviteService.utils.invitedStaffName=''},hideInvitePopUp:function(){let isHealowPlusUser=getItemKeyValue("isHealowPlusEnabled").toUpperCase()==='YES';let televisitWrapperDIV=isHealowPlusUser?".healow-connect #containerDIV ":"#televisitWrapper ";$(televisitWrapperDIV+"#invitePopupWrapper").css("pointer-events","");$(televisitWrapperDIV+'#staticBackdrop').modal('hide');telemedInviteService.utils.invitedStaffId=0;telemedInviteService.utils.invitedStaffName='';$("#inviteConfirmButton").removeClass("inviteConfirmFooterEnableButton");if(!$("#inviteConfirmButton").hasClass("inviteConfirmFooterButton")){$("#inviteConfirmButton").addClass("inviteConfirmFooterButton")}},setInviteStaff:function(){let isHealowPlusUser=getItemKeyValue("isHealowPlusEnabled").toUpperCase()==='YES';let televisitWrapperDIV=isHealowPlusUser?".healow-connect #containerDIV ":"#televisitWrapper ";let staffLookupLength=0;let count=0;if(scope.inviteeFeature.scheduledProvider.length>0&&telemedInviteService.utils.invitedStaffId===""+scope.inviteeFeature.scheduledProvider[0].id){scope.inviteeFeature.displayInviteErrorMsg("Please click on Request to Join button to invite the scheduled provider");$(".linkedcontact-body").animate({scrollTop:0},"slow");$("#staff-lookup_staff_Ipt1").val("");telemedInviteService.utils.invitedStaffId=0;telemedInviteService.utils.invitedStaffName='';return}if(telemedInviteService.utils.invitedStaffId>0){staffLookupLength=1}scope.inviteeFeature.selectedStaffIds=[];if($('.staff-wrapper').is(':visible')){let status;let currentScreenInvited=new Set;$('.staff-wrapper .form-check-input').each(function(){status=undefined;if(this.checked){let sendLastStatus=typeof $("#sentLast"+this.id).html()==='string'?$("#sentLast"+this.id).html().trim():'';let lastLabelStatus=typeof $("#lastLabel"+this.id).html()==='string'?$("#lastLabel"+this.id).html().trim():'';if($("#lastLabel"+this.id).is(":visible")&&lastLabelStatus=='On this call'||sendLastStatus=='On this call'){status='On this call';currentScreenInvited.add(this.id)}else if($("#lastLabel"+this.id).is(":visible")&&lastLabelStatus=='Call interrupted'){status='Call interrupted';currentScreenInvited.add(this.id)}else if($("#lastLabel"+this.id).is(":visible")){status=sendLastStatus;currentScreenInvited.add(this.id)}scope.inviteeFeature.selectedStaffIds[count++]={id:this.id,name:this.value,status:status}}});if(staffLookupLength===1){if(telemedInviteService.utils.invitedStaffId===global.TrUserId||scope.inviteeFeature.onlineUserIds.has(""+telemedInviteService.utils.invitedStaffId)){notification.show('error','Televisit',telemedInviteService.utils.invitedStaffName+" is already on this call",15e3);return}status=undefined;if($("#lastLabel"+telemedInviteService.utils.invitedStaffId).is(":visible")){status=$("#lastLabel"+telemedInviteService.utils.invitedStaffId+" .lastStaffInviteLog").html()}scope.inviteeFeature.selectedStaffIds[count++]={id:telemedInviteService.utils.invitedStaffId,name:telemedInviteService.utils.invitedStaffName,status:status}}if(scope.inviteeFeature.invitedStaffList.length>0){status=undefined;for(var i=0;i<scope.inviteeFeature.invitedStaffList.length;i++){var item=scope.inviteeFeature.invitedStaffList[i];let id=''+item.id;currentScreenInvited.add(''+id);let sendLastStatus=typeof $("#sentLast"+id).html()==='string'?$("#sentLast"+id).html().trim():'';let lastLabelStatus=typeof $("#lastLabel"+id).html()==='string'?$("#lastLabel"+id).html().trim():'';if($("#lastLabel"+id).is(":visible")&&lastLabelStatus=='On this call'||sendLastStatus=='On this call'){status='On this call'}else if($("#lastLabel"+id).is(":visible")&&lastLabelStatus=='Call interrupted'){status='Call interrupted'}else if($("#lastLabel"+id).is(":visible")){status=sendLastStatus}scope.inviteeFeature.selectedStaffIds[count++]={id:id,name:item.name,status:status}}}let currentScreenInvitee=new Map;for(var i=0;i<scope.inviteeFeature.selectedStaffIds.length;i++){currentScreenInvitee.set(scope.inviteeFeature.selectedStaffIds[i].id,item)}$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/inviteEncounterData"),data:{encounterId:mySharedService.encounterId},type:"POST","async":false,success:function(data){let staffList=data.inviteDetails;let i=staffList.length;while(i--){if(telemedInviteService.utils.invitedStaffId===""+staffList[i].inviteeId){notification.show('error','Televisit',telemedInviteService.utils.invitedStaffName+" is already invited",15e3);return}if(currentScreenInvited.has(""+staffList[i].inviteeId)){currentScreenInvited["delete"](""+staffList[i].inviteeId);staffList.splice(i,1)}}if(staffList.length>0){notification.show('error','Televisit','Unable to send invite. Please review the invitee list',15e3);scope.inviteeFeature.getAssignStaff()}else if(scope.inviteeFeature.selectedStaffIds.length>scope.inviteeFeature.tvInviteStaffLimit){let modalHeight=270;let isAnyInvited=false;for(var j=0;j<scope.inviteeFeature.selectedStaffIds.length;j++){if(scope.inviteeFeature.selectedStaffIds[j].status!=undefined){isAnyInvited=true;break}}$(televisitWrapperDIV+"#invitePopupWrapper").css("pointer-events","none");let remainStaffLength=scope.inviteeFeature.invitedStaffList.length+scope.inviteeFeature.selectedStaffIds.length-3;if(!isAnyInvited){modalHeight=190;$(televisitWrapperDIV+".inviteStaffStaticNote").hide()}else{$(televisitWrapperDIV+".inviteStaffStaticNote").show()}if(remainStaffLength>0){modalHeight=modalHeight+remainStaffLength*40}$(televisitWrapperDIV+'#staticBackdrop').modal({backdrop:'static',keyboard:false},'show');$(televisitWrapperDIV+'#inviteStaffModalBody').css("height",modalHeight+"px")}else{scope.inviteeFeature.sentInviteStaff()}$("#staff-lookup_staff_Ipt1").val("")},error:function(e){return false}})}},processInviteStaff:function(id,name){let currentDate=new Date;let date=new Date(currentDate.getTime()+currentDate.getTimezoneOffset()*6e4);let currentTime=date.getFullYear()+'-'+scope.inviteeFeature.padTo2Digits(date.getMonth()+1)+'-'+scope.inviteeFeature.padTo2Digits(date.getDate())+' '+scope.inviteeFeature.padTo2Digits(date.getHours())+':'+scope.inviteeFeature.padTo2Digits(date.getMinutes())+':'+scope.inviteeFeature.padTo2Digits(date.getSeconds());let currentInviteDate=new Date(currentTime);let currentInviteTime=currentInviteDate.getTime();$("#sentLast"+id).attr('sentTime',currentTime);let sentTime=$("#sentLast"+id).attr("sentTime");let lastInviteDate=new Date(sentTime);let lastInviteTime=lastInviteDate.getTime();let timeDiff=currentInviteTime-lastInviteTime;let lastInviteText=scope.inviteeFeature.getLastStaffInviteText(timeDiff);$("#sentLast"+id).html(" "+lastInviteText);scope.inviteeFeature.processForPSAC(id,name,currentTime)},requestToJoin:function(userId,name){let userInfo=[];userInfo.push(userId);userInfo.push(name);let inviteDetail={"userInfo":userInfo,"inviterUserId":global.TrUserId,"patientId":mySharedService.patientId,"encounterID":mySharedService.encounterId,"providerID":mySharedService.providerID};opentokService.getGeneralSession().signal({type:"requestToJoin",data:inviteDetail},function(error){if(error){ecwAlert("Unable to perform operation.")}})},getLastStaffInviteText:function(timeDiff){let secs=Math.floor(timeDiff/1e3);if(secs<60)return"Last invited few seconds ago";if(secs<3600)return"Last invited "+Math.floor(secs/60)+" minutes ago";if(secs<86400)return"Last invited "+Math.floor(secs/3600)+" hours ago";if(secs<2592001)return"Last invited "+Math.floor(secs/86400)+" days ago"},padTo2Digits:function(num){return num.toString().padStart(2,'0')},processForPSAC:function(userId,name,currentTime){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/psac"),data:{patientId:mySharedService.patientId,userId:userId},type:"POST",success:function(data){if(data&&data.isAuthorize===false){let psacEnableBreakGlass=getItemKeyValue("EnablePSACBreakGlass");if(psacEnableBreakGlass===''||psacEnableBreakGlass.toString().toLowerCase()==='no'||psacEnableBreakGlass.toString()==='0'){if($("#lastLabel"+userId).length){$("#"+userId).prop('checked',false);$("#"+userId).attr('disabled','disabled');$("#lastLabel"+userId).html("Restricted to invite due to PSAC");$("#lastLabel"+userId).css('color','red');$("#lastLabel"+userId).show()}else{scope.inviteeFeature.displayInviteErrorMsg(name+" restricted to invite due to PSAC");$(".linkedcontact-body").animate({scrollTop:0},"slow")}return false}else{let userInfo=[];userInfo.push(userId);userInfo.push(name);scope.inviteeFeature.inviteStaff(userInfo,currentTime)}}else{let userInfo=[];userInfo.push(userId);userInfo.push(name);scope.inviteeFeature.inviteStaff(userInfo,currentTime)}},error:function(e){return false}})},inviteStaff:function(userInfo,currentTime){$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/inviteStaff"),data:{senderId:global.TrUserId,staffName:userInfo[1],userId:userInfo[0],encId:mySharedService.encounterId},type:"POST",success:function(data){if(data.error&&data.error.length>0){notification.show('error','Televisit','Unable to send invite. Please review the invitee list',15e3)}else{userInfo.push(data.userType);let isAssignStaff=false;for(var i=0;i<scope.inviteeFeature.assignStaffList.length;i++){if(scope.inviteeFeature.assignStaffList[i].id===userInfo[0]){isAssignStaff=true;scope.inviteeFeature.assignStaffList[i].isExist=true;if(scope.inviteeFeature.assignStaffList[i].status!=2){scope.inviteeFeature.assignStaffList[i].status=0}}}if(!isAssignStaff){let list=[{id:userInfo[0],name:userInfo[1],currentTime:currentTime,status:0}];let isExistInvitedContact=false;for(var i=0;i<scope.inviteeFeature.invitedStaffList.length;i++){if(scope.inviteeFeature.invitedStaffList[i].id===userInfo[0]){isExistInvitedContact=true;item.currentTime=currentTime}}if(scope.inviteeFeature.scheduledProvider.length>0&&scope.inviteeFeature.scheduledProvider[0].id==list[0].id){$("#lastLabel"+userInfo[0]).show();$("#lastMessage"+userInfo[0]).show();for(var i=0;i<scope.inviteeFeature.scheduledProvider.length;i++){var item=scope.inviteeFeature.scheduledProvider[i];item.isExist=true;scope.inviteeFeature.scheduledProvider.splice(0,1);scope.inviteeFeature.scheduledProvider.push(item)}}else if(!isExistInvitedContact){list[0].status=0;list[0].isExist=true;list[0].isLogedInUser=false;list[0].encounterId=mySharedService.encounterId;scope.inviteeFeature.invitedStaffList.push(list[0]);$("#lastLabel"+userInfo[0]).show();$("#lastMessage"+userInfo[0]).show()}}let inviteDetail={"userInfo":userInfo,"inviterUserId":global.TrUserId,"patientId":mySharedService.patientId,"encounterID":mySharedService.encounterId,"providerID":mySharedService.providerID};opentokService.getGeneralSession().signal({type:"inviteStaff",data:inviteDetail},function(error){if(error){ecwAlert("Unable to perform operation.")}})}},error:function(e){}})},displayInviteErrorMsg:function(errMsg){let isHealowPlusUser=getItemKeyValue("isHealowPlusEnabled").toUpperCase()==='YES';var televisitWrapperDIV=isHealowPlusUser?".healow-connect #containerDIV ":"#televisitWrapper ";$(televisitWrapperDIV+"#inviteErrorstatus").show();$(televisitWrapperDIV+"#inviteErrMsg").html(errMsg)},getAssignStaff:function(){$("#otherContactBtn").removeClass("active");if(!$("#providerBtn").hasClass("active")){$("#providerBtn").addClass("active")}let inviteEncounterDataMap=new Map;$.ajax({url:makeURL("/mobiledoc/modules/webemr/telehealth/contact/staff/inviteEncounterData"),data:{encounterId:mySharedService.encounterId},type:"POST","async":false,success:function(data){telemedInviteService.utils.staffList=data.inviteDetails;if(data.provider[0].id!=global.TrUserId){let providerDetails=data.provider[0];providerDetails.encounterId=mySharedService.encounterId;if(scope.inviteeFeature.onlineUserIds.has(""+providerDetails.id)){providerDetails.isExist=true}else{providerDetails.isExist=false}scope.inviteeFeature.scheduledProvider=[];scope.inviteeFeature.scheduledProvider.push(providerDetails)}for(var i=0;i<telemedInviteService.utils.staffList.length;i++){var item=telemedInviteService.utils.staffList[i];inviteEncounterDataMap.set(""+item.inviteeId,item)}},error:function(e){}});let param={action:"getPSACFilterAssignedStaff",docId:mySharedService.providerID,patientId:mySharedService.patientId};scope.inviteeFeature.invitedStaffList=[];telemedInviteService.utils.invokeStaffAssignmentService(param).success(function(data){if(data&&data.status===1&&data.data){let assignStaffList=data.data;scope.inviteeFeature.assignStaffList=[];for(var i=0;i<assignStaffList.length;i++){var item=assignStaffList[i];if(inviteEncounterDataMap.has(item.id)){let invitedStaff=inviteEncounterDataMap.get(item.id);item.currentTime=invitedStaff.sentTime;item.isExist=true;item.encounterId=mySharedService.encounterId;if(item.id==global.TrUserId||scope.inviteeFeature.onlineUserIds.has(""+item.id)){item.status=1;item.isLogedInUser=true}else{item.status=0;item.isLogedInUser=false}scope.inviteeFeature.assignStaffList.push(item);inviteEncounterDataMap["delete"](item.id)}else{if(item.id==global.TrUserId||scope.inviteeFeature.onlineUserIds.has(""+item.id)){item.status=1;item.isExist=true;item.isLogedInUser=true}else{item.status=0;item.isExist=false;item.isLogedInUser=false}item.currentTime='now';item.encounterId=mySharedService.encounterId;scope.inviteeFeature.assignStaffList.push(item)}}}inviteEncounterDataMap.forEach(function(value,key){let invitedStaff=[];invitedStaff.id=value.inviteeId;invitedStaff.name=value.inviteeName;invitedStaff.currentTime=value.sentTime;invitedStaff.isExist=true;invitedStaff.encounterId=mySharedService.encounterId;if(global.TrUserId==invitedStaff.id||scope.inviteeFeature.onlineUserIds.has(""+invitedStaff.id)){invitedStaff.status=1}else{invitedStaff.status=0}scope.inviteeFeature.invitedStaffList.push(invitedStaff)})})},hideInviteLayout:function(){scope.inviteeFeature.showInviteContact=false;if(commonTimerObj){clearTimeout(commonTimerObj);commonTimerObj=null}commonTimerObj=setTimeout(function(){scope.changeViewToFullView();clearTimeout(commonTimerObj);commonTimerObj=null},1e3)},selectPerson:function(index){if(index<0){scope.inviteeFeature.isBroadCastMessaging=true;angular.forEach(scope.inviteeFeature.onlinePersonList,function(patient){patient.isSelected=false});return}scope.inviteeFeature.onlinePersonList[index].isSelected=!(scope.inviteeFeature.onlinePersonList[index].isSelected===true);let isNoPersonSelected=true;for(var i=0;i<scope.inviteeFeature.onlinePersonList.length;i++){if(scope.inviteeFeature.onlinePersonList[i].isSelected===true){isNoPersonSelected=false;break}}scope.inviteeFeature.isBroadCastMessaging=isNoPersonSelected},filterByPersonName:function(){angular.forEach(scope.inviteeFeature.onlinePersonList,function(person){if(scope.inviteeFeature.searchPerson.trim().length===0){person.isHidden=false;return}let personName=person.userName;let indexOf=personName.toLowerCase().indexOf(scope.inviteeFeature.searchPerson.toLowerCase());person.isHidden=indexOf===-1})},bindPopupEvent:function(){$("#televisitWrapper").find('#reviewInviteModal').off('shown.bs.modal').on('shown.bs.modal',scope.inviteeFeature.hideInviteLayout)},viewInviteContactDiv:function(){telemedInviteService.postCallService.getInviteDetail(mySharedService.encounterId).success(function(data){scope.inviteDetailMap=data[0];if($.isEmptyObject(scope.inviteDetailMap)===false){scope.inviteeFeature.bindPopupEvent();$("#televisitWrapper").find('.last-invitedblock').remove();$("#televisitWrapper").find('.other-contact-invite-at').remove();scope.inviteDetail=scope.inviteDetailMap['invitedList'];scope.inviteCount=scope.inviteDetailMap['invitedCount'];scope.lastSentTimeDiff=scope.inviteDetailMap['lastSentTimeDiff']}}).error(function(){ecwAlert('Something went wrong. Please try again.')});telemedInviteService.postCallService.getContactList(mySharedService.patientId).success(function(data){scope.inviteeFeature.contactList=data;scope.inviteeFeature.showInviteContact=!$.isEmptyObject(scope.inviteeFeature.contactList);telemedInviteService.utils.bindMask()}).error(function(){ecwAlert('Something went wrong. Please try again.')});telemedInviteService.utils.initiateInviteStaff();$('.custom-popup').show('slide',{direction:'right'},300);scope.inviteeFeature.getAssignStaff()},cleanupScope:function(){scope.inviteDetail=[];scope.inviteCount=0;scope.lastSentTimeDiff=null;scope.inviteeFeature.contactList=[];scope.inviteeFeature.onlinePersonList=[]},adjustParticipants:function(inviteId,type){try{let hasVideo=inviteId===telemedInviteService.utils.PATIENT_ID_INVITEE?scope.subscriber.hasVideo:scope.inviteeFeature.contSubscriber[inviteId].hasVideo;let hasAudio=inviteId===telemedInviteService.utils.PATIENT_ID_INVITEE?scope.subscriber.hasAudio:scope.inviteeFeature.contSubscriber[inviteId].hasAudio;if(hasVideo===false&&type===telemedInviteService.utils.VIDEO||hasAudio===false&&type===telemedInviteService.utils.AUDIO){return}let data={"type":type,"unMuteAudio":!hasAudio,"unBlockVideo":!hasVideo};opentokVideoService.getSession().signal({type:"setAudioVideo",data:data,to:inviteId!==telemedInviteService.utils.PATIENT_ID_INVITEE?telemedInviteService.utils.participantList[inviteId]["connection"]:telemedInviteService.utils.participantList[telemedInviteService.utils.PATIENT_ID_INVITEE]["connection"]},function(error){if(error){telemedLoggingService.error(error)}})}catch(e){telemedLoggingService.error(e)}},setAudioVideoIcon:function(event){var data=telemedInviteService.utils.parseJSONUtility(event.stream.connection.data);let isPatient=data&&data.data&&data.data.usertype==="patient";var isValid=data.data&&data.data.usertype&&(data.data.usertype==="contact"||data.data.usertype==="patient");if(isValid&&Object.keys(scope.inviteeFeature.contSubscriber).length>0){if(event.changedProperty==="hasAudio"){if(isPatient){scope.subscriber.hasAudio=event.newValue}else{scope.inviteeFeature.contSubscriber[data.data.inviteid]["hasAudio"]=event.newValue}}else if(event.changedProperty==="hasVideo"){if(isPatient){scope.subscriber.hasVideo=event.newValue}else{scope.inviteeFeature.contSubscriber[data.data.inviteid]["hasVideo"]=event.newValue}}}},subscribeToContactStream:function(data,event,id,startCaption){try{if(scope.stickyNoteView||scope.dockView){setTimeout(function(){scope.changeViewToFullView()},2e3)}if(telemedInviteService.utils.isExistContact(telemedInviteService.utils.participantList)&&!scope.inviteeFeature.isContactConnected){scope.inviteeFeature.isContactConnected=true;scope.inviteeFeature.inviteHeight=120}telemedInviteService.utils.contactsStreams[data.data.inviteid]=data.data;scope.inviteeFeature.contSubscriber[data.data.inviteid]=opentokVideoService.getSession().subscribe(event.stream,document.getElementById("C2CallApplet_"+id),{insertMode:"append",showControls:false,width:"100%",height:"100%"},function(error){if(!error){scope.inviteeFeature.setContactNameInSubscriberStream(data.data.inviteid,event.stream,data.data.relation);scope.inviteeFeature.setPatientIdentifier(scope.subscriber);scope.inviteeFeature.contSubscriber[data.data.inviteid].on("videoDisabled",function(event){let uName=telemedInviteService.utils.parseJSONUtility(event.target.stream.connection.data);scope.createAlertDown('#errorstatus',2,'',uName.data.username+' stopped broadcasting.',true,8e3)});var contactSourceCall=" ";if(data.data['device']){contactSourceCall=data.data['device']}callingInfo["streamID"]=event.stream.streamId;callingInfo["providerConnectionID"]=event.target.connection.id;callingInfo["patientConnectionID"]=event.stream.connection.connectionId;callingInfo["masterSessionID"]=document.getElementById("sessionId").value;callingInfo["videoSessionID"]=event.target.id;callingInfo["patientSourceCall"]=" ";callingInfo["contactSourceCall"]=contactSourceCall;callingInfo["startTime"]=(new Date).getTime();callingInfo["userName"]=data.data['username'];if(!telemedInviteService.utils.participantDetail[data.data['inviteid']]){callingInfo["userType"]=data.data['usertype'];telemedInviteService.utils.participantDetail[data.data['inviteid']]={}}$.extend(telemedInviteService.utils.participantDetail[data.data['inviteid']],callingInfo);if(!telemedInviteService.utils.hasElement('id',data.data['inviteid'],scope.inviteeFeature.onlinePersonList)){scope.inviteeFeature.onlinePersonList.push({"userName":data.data['username'],"id":data.data['inviteid']});let id=data.data['userid'];for(var i=0;i<scope.inviteeFeature.assignStaffList.length;i++){if(scope.inviteeFeature.assignStaffList[i].id===id){scope.inviteeFeature.assignStaffList[i].status=1}}for(var i=0;i<scope.inviteeFeature.invitedStaffList.length;i++){if(scope.inviteeFeature.invitedStaffList[i].id===id&&scope.inviteeFeature.invitedStaffList[i].status===2){scope.inviteeFeature.invitedStaffList[i].status=1}}for(var i=0;i<scope.inviteeFeature.scheduledProvider.length;i++){if(scope.inviteeFeature.scheduledProvider[i].id===id&&scope.inviteeFeature.scheduledProvider[i].status===2){scope.inviteeFeature.scheduledProvider[i].status=1}}}if(startCaption&&typeof startCaption==="function"){startCaption(data.data.relation)}}})}catch(e){telemedLoggingService.error(e)}},setContactNameInSubscriberStream:function(inviteId,stream,relation){try{scope.inviteeFeature.contSubscriber[inviteId]['hasAudio']=stream.hasAudio;scope.inviteeFeature.contSubscriber[inviteId]['hasVideo']=stream.hasVideo;let temp=$compile('<div class="OT_bar OT_edge-bar-item OT_mode-on tv_invitee text-center"><span>'+stream.name+'</span>'+'<i class="icon videounmute audioControls" ng-show=inviteeFeature.contSubscriber["'+inviteId+'"].hasVideo  ng-click= inviteeFeature.adjustParticipants("'+inviteId+'","'+telemedInviteService.utils.VIDEO+'")></i>'+'<i class="icon videostart audioControls" ng-show=!inviteeFeature.contSubscriber["'+inviteId+'"].hasVideo ng-click= inviteeFeature.adjustParticipants("'+inviteId+'","'+telemedInviteService.utils.VIDEO+'")></i>'+'<i class="icon name-mic-icon audioControls" ng-show=inviteeFeature.contSubscriber["'+inviteId+'"].hasAudio  ng-click= inviteeFeature.adjustParticipants("'+inviteId+'","'+telemedInviteService.utils.AUDIO+'")></i>'+'<i class="icon name-mic-icon-off audioControls" ng-show=!inviteeFeature.contSubscriber["'+inviteId+'"].hasAudio ng-click= inviteeFeature.adjustParticipants("'+inviteId+'","'+telemedInviteService.utils.AUDIO+'")></i>')(scope);angular.element($("#"+scope.inviteeFeature.contSubscriber[inviteId].id).find(".OT_widget-container")[0]).append(temp)}catch(e){telemedLoggingService.error(e)}},setPatientIdentifier:function(subscriberObj){try{if($("#patientIdentifierTV").length===0){var pt=$(".pat-details").find("h2").text().split(",");var otherName=pt[0].trim()+", "+pt[1].trim()+" "+pt[2].trim()+", "+pt[3].trim();var isNotExist=$("#ptIdentifierTV").length===0;if(otherName&&otherName!==''&&isNotExist){let temp=$compile("<div id='ptIdentifierTV' class='OT_bar OT_edge-bar-item OT_mode-on tv_invitee text-center'><span>"+otherName+" (Patient)</span>"+'<i class="icon videounmute audioControls" ng-show=subscriber.hasVideo  ng-click= inviteeFeature.adjustParticipants("'+telemedInviteService.utils.PATIENT_ID_INVITEE+'","'+telemedInviteService.utils.VIDEO+'")></i>'+'<i class="icon videostart audioControls" ng-show=!subscriber.hasVideo ng-click= inviteeFeature.adjustParticipants("'+telemedInviteService.utils.PATIENT_ID_INVITEE+'","'+telemedInviteService.utils.VIDEO+'")></i>'+'<i class="icon name-mic-icon audioControls" ng-show=subscriber.hasAudio  ng-click= inviteeFeature.adjustParticipants("'+telemedInviteService.utils.PATIENT_ID_INVITEE+'","'+telemedInviteService.utils.AUDIO+'")></i>'+'<i class="icon name-mic-icon-off audioControls" ng-show=!subscriber.hasAudio ng-click= inviteeFeature.adjustParticipants("'+telemedInviteService.utils.PATIENT_ID_INVITEE+'","'+telemedInviteService.utils.AUDIO+'")></i>')(scope);angular.element($("#"+subscriberObj.id).find(".OT_widget-container")[0]).append(temp)}}}catch(e){telemedLoggingService.error(e)}},setInviteStaffPatientIdentifier:function(subscriberObj,username){try{var isNotExist=$("#patientIdentifierTV").length===0;if(isNotExist){var tag='<div id="patientIdentifierTV" class="OT_bar OT_edge-bar-item OT_mode-on tv_identifier text-center tv_invitee">'+'<span>'+username+'(Patient) </span> </div>';$("#"+subscriberObj.id).find(".OT_widget-container").prepend(tag)}}catch(e){telemedLoggingService.error(e)}},setInviteStaffProviderIdentifier:function(subscriberObj,username){try{var tag='<div id="prIdentifierTV" class="OT_bar OT_edge-bar-item OT_mode-on tv_identifier text-center tv_invitee">'+'<span>'+username+'</span> </div>';$("#"+subscriberObj.id).find(".OT_widget-container").prepend(tag)}catch(e){telemedLoggingService.error(e)}},sendChatToSelectedPerson:function(data){angular.forEach(scope.inviteeFeature.onlinePersonList,function(person){if(person.isSelected){data={to:telemedInviteService.utils.participantList[person.id].connection,data:data.data,type:global.loginUserType==1?"textMessageDoctor":"textMessageStaff"};opentokVideoService.getSession().signal(data,function(error){if(error){telemedLoggingService.error(error)}})}});scope.updateChatWindow(data.data)},removeParticipant:function(remoteData){delete telemedInviteService.utils.participantList[remoteData.data.inviteid];scope.inviteeFeature.onlinePersonList=$.grep(scope.inviteeFeature.onlinePersonList,function(data,index){return data.id!==remoteData.data.inviteid});if(!telemedInviteService.utils.isExistContact(telemedInviteService.utils.participantList)){scope.inviteeFeature.isContactConnected=false;scope.inviteeFeature.inviteHeight=50}},setSearchAssignToId:function(){telemedInviteService.utils.invitedStaffId=scope.AssignToStaff.staff.id;telemedInviteService.utils.invitedStaffName=scope.AssignToStaff.staff.name},clearSearchScannedById:function(){telemedInviteService.utils.invitedStaffId=0;telemedInviteService.utils.invitedStaffName=''}}}}})})();
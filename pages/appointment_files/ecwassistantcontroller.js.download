angular.module('loadOnDemand',['oc.lazyLoad']).directive('loadOnDemand',function($timeout,$compile,$ocLazyLoad,$http){return{link:function(scope,element,attr){if(!scope.finishedLoading){var moduleToLoad=attr.loadOnDemand;let allfiles=getHighchartsJS();let evaFiles=modules[moduleToLoad];allfiles.push(...evaFiles);if(moduleToLoad&&moduleToLoad.trim()!=""){$ocLazyLoad.load({name:moduleToLoad,files:allfiles,serie:true}).then(function(){getTemplateURL()},function(e){console.log(e)})}else if(moduleToLoad==''){getTemplateURL()}}function getTemplateURL(){if(attr.template&&attr.template!=""){var url=scope.getTemplateUrl(attr.template);$http.post(url).success(function(data){loadTemplate(data)}).error(function(data){console.log(data)})}else{loadTemplate()}}function loadTemplate(data){scope.finishedLoading=true;if(data){element.html(data)}$compile(element)(scope)}}}});var eVAScope=null;var app=angular.module('ecwAssistant',['evaUsersAutoComplete','evaIcdAutoAuggest','angular.filter','oc.lazyLoad','loadOnDemand','patientlookup','providerlookup','ecw.dir.texteditor','jumpToSubSectionModule','evaFavorite','ecw.dir.ai-disclaimer']);app.controller('ecwAssistantController',ecwAssistantController);app.controller('evaMaximize',['$scope',function($scope){$('#eva-maximize').hide();$scope.evaMaximize=function(){if((isAiEnable&&isEvaFloatingIconRequiredOnLogin||getUserProfile("showFloatingButton")==="1")&&!evaglobal.isEvaMinimized){evaglobal.isEvaMinimized=false;$('#eva-maximize').hide();startstopEVA()}else{evaglobal.isEvaMinimized=false;evaglobal.chatAssistanceWrapField.show();$('#eva-maximize').hide()}window.floatingButton.updateItem("eva",{evaFloatingIndicator:0})};$scope.evaDragClose=function(){startstopEVA()};$(".eva-dragbox").draggable({containment:'window',scroll:false})}]);function queIconCloseClickEva(){$('.source_pop').hide()}function collepseClick(obj,element){var id=element+obj.id;var h=$(id)[0].scrollHeight;if(obj.className.includes("active")){$(id).animate({'height':h})}else{$(id).animate({'height':'230px'})}}function setCurrentTemplateScope(scope){evaglobal.currentscope=scope}function getCurrentTemplateScope(scope){return evaglobal.currentscope}function getCurrentTemplateEvaOverlayNumber(){evaglobal.evaOverlayNumber=evaglobal.evaOverlayNumber+1;return evaglobal.evaOverlayNumber}app.filter('formattime',function(){return function(inputTime){return moment(inputTime,"HH:mm:ss").format("hh:mm A")}});var modules={'flowsheet':['/mobiledoc/jsp/resources/jslib/highcharts/highstock.src.js','/mobiledoc/jsp/catalog/js/exporting.src.js','/mobiledoc/jsp/catalog/js/confTimeline.js','/mobiledoc/jsp/webemr/toppanel/flowsheet/flowsheet.js'],'TJellyDetailView':getDependencies('TJellyDetailView'),'refillrx':['/mobiledoc/jsp/resources/jslib/highcharts/highstock.src.js','/mobiledoc/jsp/catalog/js/exporting.src.js','/mobiledoc/jsp/webemr/assistant/js/labDiProcCommandView.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/js/rxHistoryCtrl.js'].concat(getDependencies('LabDIProcHistoryDetailApp')),'showLabDIProc':['/mobiledoc/jsp/webemr/assistant/js/labDiProcCommandView.js'].concat(getDependencies('LabDIProcHistoryDetailApp')),'action':['/mobiledoc/jsp/webemr/jellybean/telephoneencounter/actionsDetailView.js'],'block':['/mobiledoc/jsp/webemr/scheduling/js/block.js'],'videoProfilingModule':['/mobiledoc/jsp/webemr/assistant/templates/video/js/videoprofiling.js'],'immunizationForecast':getDependencies('ImmInjHxApp'),'sendMessage':['/mobiledoc/jsp/webemr/singlesend/sendMessage.js'],'uscAiResponseViewApp':['/mobiledoc/jsp/webemr/assistant/js/ai/usc/usc-ai-response-view-controller.js'],'eboAiResponseViewApp':['/mobiledoc/jsp/webemr/assistant/js/ai/ebo/ebo-ai-response-view-controller.js'],'drtlaTimeLine':['/mobiledoc/jsp/webemr/assistant/js/labDiProcCommandView.js','/mobiledoc/jsp/webemr/rightpanel/js/rpDRTLMController.js','/mobiledoc/jsp/webemr/toppanel/topPanelNotesCtrl.js'].concat(getDependencies('LabDIProcHistoryDetailApp'))};app.filter('capitalize',function(){return function(input,all){var reg=all?/([^\W_]+[^\s-]*) */g:/([^\W_]+[^\s-]*)/;return!!input?input.replace(reg,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()}):''}});function ecwAssistantController($scope,$ocLazyLoad,$http,$modal,$timeout,$sce,$injector,evaUserPreferencesService,evaFeedbackService,$compile,evaFavoriteService,askEvaService){$scope.ptpic=getUserPic("Pic").trim();$scope.mute=true;$scope.TrUserId=global.TrUserId;if($scope.ptpic.includes("no_pic.jpg")||$scope.ptpic.includes("patient-infoimg.png")){$scope.isPtPic=true}else{$scope.isPtPic=false}$scope.showInitialImage=function(){$scope.isPtPic=true};$scope.userInitial=evaglobal.userInitial;$scope.userName=evaglobal.userName;$scope.userFullName=evaglobal.userFullName;$scope.assistantModalUrl="";$scope.historyObj=[];$scope.listening=false;$scope.thinking=false;$scope.inputMode="text";$scope.assistantData=[];var assistantResponse="";$scope.SpeechText="";$scope.smartPanelEva=false;$scope.rightPlaced=false;$scope.leftPlaced=true;$scope.fullscreen=false;$scope.commands=evaglobal.initStatementArray;$scope.showPtPicInEVA=getItemKeyValue("showPtPicInEVA")==='yes';$scope.imageURL=sessionStorage.getItem('userImage_'+global.TrUserId)||"";$scope.scrollUp=false;$scope._evaglobal=evaglobal;$scope.bindTemplateToScope=null;$scope.init=function(){if(evaUserPreferencesService.loadEvaUserPreferences("assistantmute").toLowerCase()=="yes"){evaService.speak.isEnable=true;$scope.mute=true}else{evaService.speak.isEnable=false;$scope.mute=false}cacheProviderImage().then(function(error){console.log(error);$scope.imageURL="";$scope.showInitialImage()},function(imageURL){$scope.imageURL=imageURL});$scope.initEvaFavoriteCommand();$scope.getEvaFloatingIconRequiredOnLoginValue()};$scope.reloadScope=function(){refreshScope()};$scope.initEvaFavoriteCommand=function(){$scope._evaglobal.userFavorites=evaglobal.userFavorites=evaFavoriteService.getUserFavorites()};$scope.initEva=function(event){evaSpeechService.setScope($scope);evaSpeechService.startButton(event)};$scope.startListening=function(start,event){if(start){$scope.listening=start;refreshScope()}else{evaSpeechService.setScope($scope);evaSpeechService.stopRecognizing();evaglobal.inputField.focus();$scope.listening=false;refreshScope()}};$scope.changeInputMode=function(mode){$scope.inputMode=mode;refreshScope();if(mode==='text'){$scope.startListening(false);evaglobal.inputField.trigger('close.xdsoft')}else if(mode==='voice'){$scope.startListening(true,event)}else if(mode==='init'){$scope.initEva(event)}};$scope.processEnter=function(){processEnterkey();showMicIcon()};$scope.getHttp=function(){return $http};$scope.getTimeoutService=function(){return $timeout};$scope.getOcLazyLoadObj=function(){return $ocLazyLoad};$scope.getModalObj=function(){return $modal};$scope.sanitizeObj=function(){return $sce};$scope.openProgressNoteFromAssistant=function(id){assistantResponse="Opening progress note...";$scope.historyObj.push({searchString:assistantResponse,source:'assistant'});evaService.setTTS(assistantResponse);evaService.speakText();evaService.getPatientEncounterBasedOnFilterAssistant(id).success(function(data){var encounters=getPatientEncountersForTab(data);evaService.openLatestPNForAssistant(encounters,id)})};$scope.launchPatientHubFromAssistant=function(ptId,directCall){if(!directCall){assistantResponse="Opening patient hub...";$scope.historyObj.push({searchString:assistantResponse,source:'assistant'});evaService.setTTS(assistantResponse);evaService.speakText()}$ocLazyLoad.load({name:'NewHub',files:['/mobiledoc/jsp/webemr/templates/topPanel-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientHub/patienthubController.js'],cache:false}).then(function(){$scope.assistantModalUrl=makeURL('/mobiledoc/jsp/webemr/toppanel/patientHub/patient-hub.jsp?patientId='+ptId+'&nd='+(new Date).getTime())},function(e){console.log(e)})};$scope.assistantRequestController=function(ptId,artifact){if(artifact==='progressnote'||artifact==='PN'||artifact==='progressnotes'){$scope.openProgressNoteFromAssistant(ptId)}else if(artifact==='patienthub'||artifact==='appointment'){$scope.launchPatientHubFromAssistant(ptId,false)}else if(artifact==='lab'||artifact==='labs'){$scope.openLastLabResultForAssitant(ptId)}evaService.scrollToBottom()};$scope.openLastLabResultForAssitant=function(id){$ocLazyLoad.load({name:'LabHistoryApp',files:getDependencies('LabHistoryApp')}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/labs/labhistory/LabDIProHistory.jsp?nType=0&patientId="+id+"&userId="+global.TrUserId+"&normalView=1&CorrectionalEnabled=false&nd="+(new Date).getTime());$scope.assistantModalUrl=url},function(e){console.log(e)})};$scope.getLastLabResultForAssitant=function(id){var Obj={"nPatientId":id,"nLabType":0,"nTrUserId":global.TrUserId,"nCategoryId":0,"nLimitCounter":0,"nSortBy":0,"sSortOrder":"DESC","sShowCancelledOrders":"no","sShowCancelledOrdersForProc":"no","sShowCCResults":"no","nLabItemId":0,"nDIItemId":0,"nProcedureItemId":0,"nItemId":0,"sShowCCResultsForProc":"no","sLoadMoreOrders":"yes","nResetPaginationCount":0,"context":"progressnotes","sFilterType":"loadMoreOrders"};var sRequestingScreen="labsHistoryScreen";var sRequestType="getLabHxDetails";var jsonObj=JSON.stringify(Obj);return urlGet('/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?sRequestFrom='+sRequestingScreen+'&sRequestType='+sRequestType+'&labDIProFiltersJsonObj='+jsonObj+"&Rand="+Math.random())};$scope.trustAsHtml=function(data){return $sce.trustAsHtml(data)};$scope.showWelcomeMessage=function(reloadWelcomeImage){$scope.closeFeedBack();$scope.patientChangeData.patientInEva={};$scope.patientChangeData.patientInEmr={};$scope.patientChangeData.showAlert=false;$scope.patientChangeData.showConfirmationMessage=false;$scope.patientChangeData.showDisclaimer=false;$scope.patientIdentifierForOld=null;$scope.patientIdentifierForNew=null;if($scope.historyObj.length>0||reloadWelcomeImage){$scope.historyObj=[];$scope.commandGroup=[];$('.icon-chat-landing').animate({'margin-top':'0px'},500,function(){});$('.welcome-text').animate({'display':'block','opacity':'100'},500,function(){});evaglobal.showWelcomeMsg=true;$('.welcome-text').removeClass('hide');eVAScope=null;evaglobal.currentscope=null;$scope.scrollUp=false;$('.scroll-popupcontent').hide()}};$scope.knowledgeLevel='eva';$scope.turnOffEventListeners=function(){$('.wave-eff-enabled').off('click.mic')};$scope.isEVASplited=false;$scope.bEVAHidden=true;$scope.changeLayout=function(layoutType){if($scope.isEVASplited){$scope.isEVASplited=false;if($scope.rightPlaced){$scope.rightPlaced=false;$scope.leftPlaced=true}else{$scope.rightPlaced=true;$scope.leftPlaced=false}$scope.splitScreen();return}if(layoutType==null){if($scope.rightPlaced){$scope.moveToLeft()}else{$scope.moveToRight()}}};$scope.moveToLeft=function(){$scope.rightPlaced=false;$scope.leftPlaced=true;$('#ecwassistantcontroller').css("right","unset");$('#ecwassistantcontroller').animate({left:'0'},200);evaUserPreferencesService.saveEvaUserPreferences("preferredViewMode","leftPositionedMode");$scope.bindTooltip()};$scope.moveToRight=function(){$scope.rightPlaced=true;$scope.leftPlaced=false;$('#ecwassistantcontroller').css("left","unset");$('#ecwassistantcontroller').animate({right:'0'},200);evaUserPreferencesService.saveEvaUserPreferences("preferredViewMode","rightPositionedMode");$scope.bindTooltip()};$scope.bindTooltip=function(){$timeout(function(){$('[data-toggle="tooltip"]').tooltip()})};$scope.splitScreen=function(){$scope.fullscreen=false;if(!$scope.isEVASplited){$scope.splitMode()}else{$scope.unifiedMode();if($scope.rightPlaced){$scope.moveToRight()}$('#ecwassistantcontroller').css({top:'39px',height:'95vh'})}jQuery(window).resize()};$scope.splitMode=function(){$scope.isEVASplited=true;let preference="splitMode";if($scope.leftPlaced){$('#webemrApp').css({position:'absolute',left:'625px',width:'calc(100% - 625px)'});$('#ecwassistantcontroller').css({position:'fixed',left:0,'border-style':'groove',top:0,height:'100vh'});$scope.adjustModalPositionForSplit('.modal{left:625px;} .foot-control{left: 625px;width:calc(100% - 625px);}');preference="leftSplitMode"}else{$('#webemrApp').css({position:'absolute',left:'0px',width:'calc(100% - 625px)'});$('#ecwassistantcontroller').css({position:'fixed',left:'auto',right:0,'border-style':'groove',top:0,height:'100vh'});$scope.adjustModalPositionForSplit('.modal{left:-625px;} .foot-control{left: 0px;width:calc(100% - 625px);}');preference="rightSplitMode"}evaUserPreferencesService.saveEvaUserPreferences("preferredViewMode",preference)};$scope.adjustModalPositionForSplit=function(dynamicStyle){$scope.removeSplitScreenStyle();$("head").append('<style id="eva-split-modal" type="text/css"></style>');let newStyleElement=$("head").children(':last');newStyleElement.html(dynamicStyle)};$scope.removeSplitScreenStyle=function(){if($("#eva-split-modal").get(0)){$("#eva-split-modal").remove()}};$scope.unifiedMode=function(){$scope.removeSplitScreenStyle();$scope.isEVASplited=false;$('#webemrApp').css({position:'relative',left:'auto',width:'100%'});$('.modal').css({position:'fixed'});$('#ecwassistantcontroller').css({position:'absolute',left:'auto',right:'auto',height:'100vh','border-style':'none'})};$scope.toggleFullscreen=function(){if($scope.fullscreen){$scope.fullscreen=false;evaUserPreferencesService.saveEvaUserPreferences("preferredViewMode",$scope.priorToFullScreenMode);$scope.bindTooltip()}else{$scope.priorToFullScreenMode=evaUserPreferencesService.loadEvaUserPreferences("preferredViewMode");$scope.doFullScreen()}jQuery(window).resize()};$scope.doFullScreen=function(evaOnlyLogin){$('.xdsoft_autocomplete').css({width:'100%'});$scope.fullscreen=true;if(!evaOnlyLogin){evaUserPreferencesService.saveEvaUserPreferences("preferredViewMode","fullScreenMode")}};$scope.triggerCommand=function(clickedCmd){evaService.setScope($scope);evaService.processCommandFromEVA(clickedCmd,"","","")};$scope.openPreferredViewMode=function(){var preferredViewMode=evaUserPreferencesService.loadEvaUserPreferences("preferredViewMode");switch(preferredViewMode){case"leftSplitMode":$scope.rightPlaced=false;$scope.leftPlaced=true;$scope.splitMode();break;case"rightSplitMode":$scope.leftPlaced=false;$scope.rightPlaced=true;$scope.splitMode();break;case"fullScreenMode":$scope.doFullScreen();break;case"rightPositionedMode":$scope.moveToRight();break;case"leftPositionedMode":$scope.moveToLeft();break;default:$scope.moveToLeft()}};$scope.endPoint=getDecItemkeyValueByName("EvaEndPoint");$scope.autoUpgradeKey=getItemKeyValue('AutoUpgradeKey');$scope.feedbackUrl=$sce.trustAsResourceUrl($scope.endPoint+"/libs/html/templates/evaFeedback.html");let evaFeedBackForm=document.getElementById('evaFeedBackForm');if(evaFeedBackForm.innerHTML===''){let url="/mobiledoc/eva/remote/libs/html/templates/evaFeedback.html";evaFeedbackService.loadResource(url).success(function(response){evaFeedBackForm.innerHTML=$scope.trustAsHtml(response);$compile(evaFeedBackForm)($scope)})}$scope.feedback={};$scope.feedback.isLike="";$scope.feedback.comment="";$scope.feedback.errorMessage="";$scope.feedback.responseMessage="";$scope.isSuccess=false;let parentId;let oldParentId;$scope.openFeedBack=function(e,callFor,obj){parentId=e.currentTarget.id;if(parentId===oldParentId&&$('#priority-feedback').hasClass("in")){$scope.closeFeedBack();return}else{$scope.feedback.comment="";$scope.feedback.isLike="";$scope.feedback.errorMessage="";$scope.isSuccess=false;$('#priority-feedback').addClass("in");$("#priority-feedback").focus()}oldParentId=parentId;if(callFor==="evaFeedback"){$scope.commandLevel=false;$('#priority-feedback').position({my:"right+10 top+10",at:"right bottom",of:$('#'+e.currentTarget.id),collision:"none none"})}else{$scope.commandLevel=true;$scope.responseString=obj.responseString;$('#priority-feedback').position({my:"right+20 top+15",at:"right bottom",of:$('#'+e.currentTarget.id),collision:"flipfit flipfit",using:function(position,feedback){if(feedback.vertical==="bottom"){if($(this).children().first().hasClass('give-feedback-up-arrow')){$(this).children().first().removeClass('give-feedback-up-arrow');$(this).children().first().addClass('give-feedback-down-arrow')}}else{if($(this).children().first().hasClass('give-feedback-down-arrow')){$(this).children().first().removeClass('give-feedback-down-arrow');$(this).children().first().addClass('give-feedback-up-arrow')}}$(this).css(position)}})}};$scope.addFeedback=function(){let parameters;parameters={'EndPoint':$scope.endPoint,'comment':$scope.feedback.comment,'rating':$scope.feedback.isLike,'commandLevel':$scope.commandLevel};if($scope.commandLevel){parameters['responseString']=$scope.responseString}evaFeedbackService.addFeedback(parameters).success(function(data){if(data.errorMessage){$scope.isSuccess=false;$scope.feedback.errorMessage=data.errorMessage;return}if(data.responseMessage){$scope.feedback.responseMessage=data.responseMessage;$scope.feedback.errorMessage="";$scope.isSuccess=true}setTimeout(()=>{$scope.closeFeedBack()},2500)},function(error){$scope.feedback.errorMessage="An errorÂ occurred while saving the feedback, could you please try again."})};$scope.closeFeedBack=function(){$('#priority-feedback').removeClass("in");$('#evaPatientDetectionAlert').hide()};$scope.bindScrollEvent=function(){$('.chatscroll').on('jsp-user-scroll-y',function(event,scrollPositionY,isAtTop,isAtBottom){if(isAtTop){$scope.scrollUp=false;$('.scroll-popupcontent').hide()}else{$scope.scrollUp=true}if($scope.$$phase!='$apply'&&$scope.$$phase!='$digest'){$scope.$apply()}})};$scope.scrollToTemplate=function(templateId){try{let searchPanel=$('.chatscroll');let api=searchPanel.data('jsp');api.scrollToElement($('#'+templateId),{stickToTop:true},true)}catch(e){console.log(e)}};$scope.scrollToTop=function(){evaService.scrollToTop()};$scope.reSizeCommandHistory=function(subCommand,id){let jScrollPane=$("#commandHistory").jScrollPane({autoReinitialise:true,animateScroll:true});let api=jScrollPane.data('jsp');let currentHeight=parseInt(api.getContentHeight()/41,10);if($('#sub-navdata'+id).css('display')==='none'){currentHeight=currentHeight+subCommand.length}else{currentHeight=currentHeight-subCommand.length}setHeightOfCommandHistory(currentHeight*41);setPositionOfCommadHistory()};$('#ecwassistantcontroller').mouseup(function(e){var container=$('.scroll-popupcontent');if(!container.is(e.target)&&container.has(e.target).length===0){container.hide()}});$('.scroll-popupcontent').hide();$scope.showRecentCommands=function(){$(".collapse-div-commandHistory").addClass("collapsed");$(".collapse-downarrow-commandHistory").addClass("collapsed");$(".collapse-content-commandHistory").removeClass("in");let historyObj=getEVAScope().historyObj;let totalNumberOfCommand=historyObj.filter(findRecentCommands).length;setHeightOfCommandHistory(totalNumberOfCommand*41);$('.scroll-popupcontent').show().animate({},100,setPositionOfCommadHistory)};$scope.evaMinimize=function(){evaglobal.isEvaMinimized=true;evaglobal.chatAssistanceWrapField.hide();if(getUserProfile("showFloatingButton")==="1"){if(isAiEnable){window.floatingButton.updateItem("eva",{icon:`<span class="eva-ai-icon-minimized"></span>`,evaFloatingIndicator:1})}else{window.floatingButton.updateItem("eva",{icon:`<span  class="eva-icon-minimized"></span>`,evaFloatingIndicator:2})}}else{$('#eva-maximize').show()}};$scope.settingEvaAi=function(event){getEVAScope().getEvaFloatingIconRequiredOnLoginValue();$('#evaSettingConfirmDia').modal({backdrop:'static',keyboard:false})};$scope.executedCommandStarClick=function(index){let favoriteCommand=$scope.getCommandIfFavorite($scope.historyObj[index].commandName);if(favoriteCommand.length>0){$scope.removeFromFavorite(favoriteCommand[0])}else{let commandName=$scope.historyObj[index].commandName;favoriteCommand=$scope.prepareFavoriteObject(commandName);$scope.addToFavorite(favoriteCommand)}};$scope.pickFavoriteCommand=function(favorite){evaglobal.inputField.val(favorite.command);$('.custom-popup.favroite-command-list').hide()};$scope.removeFromFavorite=function(favorite){evaService.setScope($scope);let response=evaFavoriteService.removeFromFavorite(favorite.commandName);$scope.initEvaFavoriteCommand();if(!response){ecwAlert("Unable to remove command from favorite at this time. Please try again later.")}};$scope.addToFavorite=function(favorite){evaService.setScope($scope);let response=evaFavoriteService.addToFavorite(favorite.commandName);if(!response){ecwAlert("Unable to mark command as favorite at this time. Please try again later.")}};$scope.postSuccessAddToFavorite=function(commandName){let favorite=$scope.prepareFavoriteObject(commandName);$scope.addAndUpdateFavoriteList(favorite);let markFavorite=true;$scope.updateCommandList(favorite,markFavorite);$scope.updateExecutedCommands(favorite,markFavorite);if($scope.bindTemplateToScope){$scope.bindTemplateToScope.container.data.userFavorite=evaglobal.userFavorites}refreshScope()};$scope.postSuccessRemoveFromFavorite=function(commandName){let favorite=$scope.prepareFavoriteObject(commandName);$scope.removeAndUpdateFavoriteList(favorite);let markFavorite=false;$scope.updateCommandList(favorite,markFavorite);$scope.updateExecutedCommands(favorite,markFavorite);if($scope.bindTemplateToScope){$scope.bindTemplateToScope.container.data.userFavorite=evaglobal.userFavorites}refreshScope()};$scope.getCommandIfFavorite=function(commandName){let favoriteCommand=evaglobal.userFavorites.filter(f=>{return f.commandName===commandName});return favoriteCommand};$scope.addCommandMeta=function(commandName,executedCommandObj){executedCommandObj.commandName=commandName};$scope.markExecutedCommandIfFavorite=function(executedCommandObj){let favoriteCommand=$scope.getCommandIfFavorite(executedCommandObj.commandName);if(executedCommandObj.commandName!=="getSuggestions"){executedCommandObj.isFavorite=favoriteCommand.length>0}};$scope.removeAndUpdateFavoriteList=function(favorite){evaglobal.userFavorites=evaglobal.userFavorites.filter(f=>{return f.commandName!==favorite.commandName})};$scope.addAndUpdateFavoriteList=function(favorite){evaglobal.userFavorites.push(favorite)};$scope.updateCommandList=function(favorite,markFavorite){evaglobal.initStatementArray.forEach(statement=>{if(statement[favorite.commandName]){statement[favorite.commandName].isFavorite=markFavorite}});$(`#${favorite.commandName}`).addClass(markFavorite?'fav':'not-fav');$(`#${favorite.commandName}`).removeClass(markFavorite?'not-fav':'fav')};$scope.updateExecutedCommands=function(favorite,markFavorite){let objects=$scope.historyObj.filter(obj=>{return obj.commandName===favorite.commandName});objects.forEach(object=>{object.isFavorite=markFavorite})};$scope.prepareFavoriteObject=function(commandName){let command=evaglobal.initStatementArray.filter(statement=>{return statement[commandName]!=undefined})[0][commandName].command;let favoriteObject={commandName:commandName,command:command,userId:global.TrUserId};return favoriteObject};$scope.closeFavoritesPopup=function(){if(evaglobal.inputField.val().startsWith("/")){$('.custom-popup.favroite-command-list').hide();evaglobal.inputField.val('')}};$scope.filterFavorites=function(favorite){if(evaglobal.inputField!==undefined){return favorite.command.toLowerCase().contains(evaglobal.inputField.val().substring(1).toLowerCase())}};$scope.patientChangeData={showAlert:false,patientInEva:{},patientInEmr:{},alertTimeout:null,showConfirmationMessage:false,showDisclaimer:false};$scope.btnPatientChangeConfirmationYes=false;$scope.btnPatientChangeConfirmationNo=false;$scope.newPatient=null;$scope.oldPatient=null;$scope.patientIdentifierForOld=null;$scope.patientIdentifierForNew=null;$scope.fromEmr=false;$scope.changePatientInEva=function(newPatientId,oldPatientId,fromScreen){if(evaglobal.showWelcomeMsg&&newPatientId!==oldPatientId&&$scope.historyObj.length>0){$('.welcome-text').addClass('hide')}let historyObjLength=0;if($scope.historyObj){historyObjLength=$scope.historyObj.length}if(fromScreen!=='multiplePatient'&&historyObjLength>0&&$scope.historyObj[historyObjLength-1].templateURL==="multiplePatientsView"){return}$scope.fromEmr=fromScreen==="EMR";$scope.newPatient=askEvaService.getPatientData(newPatientId);$scope.patientIdentifierForNew=getIdentifiersForId(newPatientId);if($('#evaHistoryDiv').hasClass("showdisclamertrue")){$('#evaHistoryDiv').removeClass("showdisclamertrue");$('#evaheader').removeClass("showdisclamertrue");$('#micdiv').removeClass("showdisclamertrue")}if(newPatientId!==oldPatientId&&!$scope.patientChangeData.showDisclaimer&&$scope.historyObj.length>0){if($scope.fromEmr){$scope.oldPatient=askEvaService.getPatientData(oldPatientId);if($scope.patientChangeData.patientInEva.uid!==undefined){$scope.patientIdentifierForOld=getIdentifiersForId($scope.patientChangeData.patientInEva.uid)}$scope.patientChangeData.patientInEmr=$scope.newPatient}else{$scope.oldPatient=askEvaService.getPatientData(oldPatientId);if($scope.patientChangeData.patientInEmr.uid!==undefined){$scope.patientIdentifierForOld=getIdentifiersForId($scope.patientChangeData.patientInEmr.uid)}$scope.patientChangeData.patientInEva=$scope.newPatient}}else{if($scope.fromEmr){if($scope.patientChangeData.patientInEva.uid!==undefined){$scope.oldPatient=askEvaService.getPatientData($scope.patientChangeData.patientInEva.uid);$scope.patientIdentifierForOld=getIdentifiersForId($scope.patientChangeData.patientInEva.uid)}else{$scope.oldPatient=askEvaService.getPatientData(newPatientId);$scope.patientIdentifierForOld=getIdentifiersForId(newPatientId)}$scope.patientChangeData.patientInEmr=$scope.newPatient}else{if($scope.patientChangeData.patientInEmr.uid!==undefined){$scope.oldPatient=askEvaService.getPatientData($scope.patientChangeData.patientInEmr.uid);$scope.patientIdentifierForOld=getIdentifiersForId($scope.patientChangeData.patientInEmr.uid)}else{$scope.oldPatient=askEvaService.getPatientData(newPatientId);$scope.patientIdentifierForOld=getIdentifiersForId(newPatientId)}$scope.patientChangeData.patientInEva=$scope.newPatient}}if($scope.patientChangeData.patientInEva.uid!==undefined){if($scope.fromEmr){if(newPatientId!==$scope.patientChangeData.patientInEva.uid.toString()){$scope.patientChangeData.showAlert=true;$('#evaPatientDetectionAlert').show()}else{$scope.patientChangeData.showAlert=false;$scope.patientChangeData.showDisclaimer=false}}else{if(!$scope.patientChangeData.showDisclaimer&&$scope.patientChangeData.patientInEmr.uid!==undefined&&newPatientId.toString()!==$scope.patientChangeData.patientInEmr.uid.toString()){$scope.patientChangeData.showAlert=true;$('#evaPatientDetectionAlert').show()}else{$scope.patientChangeData.showAlert=false;if(!$scope.patientChangeData.showDisclaimer){$scope.patientChangeData.showDisclaimer=false}}}}$scope.patientChangeData.showConfirmationMessage=false;if($scope.patientChangeData.showAlert){$('#evaHistoryDiv').addClass("showdisclamertrue");$('#evaheader').addClass("showdisclamertrue");$('#micdiv').addClass("showdisclamertrue")}};$scope.changePatientConfirmation=function(value){$scope.btnPatientChangeConfirmationYes=value==='YES';$scope.btnPatientChangeConfirmationNo=value==='NO';if($scope.btnPatientChangeConfirmationYes){$scope.updatePatientChangeData();$scope.selectNewPatientInEva();$scope.patientChangeData.showAlert=false;$scope.patientChangeData.showDisclaimer=false;if($scope.patientChangeData.patientInEva.uid!==$scope.patientChangeData.patientInEmr.uid){$scope.patientChangeData.showConfirmationMessage=true}$scope.patientChangeData.alertTimeout=setTimeout(function(){$scope.patientChangeData.showConfirmationMessage=false;refreshScope()},15e3)}else{$scope.resetPatientChangeData();$scope.patientChangeData.showAlert=false;$scope.patientChangeData.showConfirmationMessage=true;$scope.patientChangeData.showDisclaimer=true;$scope.patientChangeData.alertTimeout=setTimeout(function(){$scope.patientChangeData.showConfirmationMessage=false;refreshScope()},15e3)}$('#evaHistoryDiv').removeClass("showdisclamertrue");$('#evaheader').removeClass("showdisclamertrue");$('#micdiv').removeClass("showdisclamertrue");evaService.setScrollHeight(75)};$scope.selectNewPatientInEva=function(){$scope.clearEvaHistory();let template="askeva/askevatemplate.jsp";let contextData={patient:$scope.patientChangeData.patientInEmr,contextData:askEvaService.contextualData};evaService.pushAssistantResponse("Selected "+$scope.patientChangeData.patientInEmr.name);evaService.pushAssistantTemplateResponse(template,contextData);urlPost("/mobiledoc/jsp/webemr/assistant/assistantController.jsp?action=setPatientInSession&selectedPatient="+$scope.patientChangeData.patientInEmr.uid)};$scope.getPatientNameWithControlNo=function(patient){if(patient.name===undefined){return""}else{return patient.name+" (Acc No."+patient.controlNo+")"}};$scope.getCurrentPatientId=function(){return $scope.patientChangeData.patientInEmr.uid};$scope.updatePatientChangeData=function(){$scope.patientChangeData.patientInEva=$scope.oldPatient;if(angular.isDefined($scope.getCurrentPatientId())){$scope.patientChangeData.patientInEva=$scope.patientChangeData.patientInEmr;if($scope.fromEmr){$scope.patientChangeData.patientInEmr=$scope.newPatient}clearTimeout($scope.patientChangeData.alertTimeout)}else{$scope.patientChangeData.patientInEmr=$scope.newPatient}};$scope.okClick=function(){$scope.patientChangeData.showAlert=false;$scope.patientChangeData.showConfirmationMessage=false;evaService.setScrollHeight(75)};$scope.setNewPatientInEva=function(user){$scope.patientChangeData.patientInEva=user};$scope.resetPatientChangeData=function(){$scope.patientChangeData.showAlert=false;$scope.patientChangeData.showConfirmationMessage=false;$scope.btnPatientChangeConfirmationYes=false;$scope.btnPatientChangeConfirmationNo=true;evaService.setScrollHeight(75)};$scope.clearEvaHistory=function(fromIndex){if(fromIndex){$scope.historyObj.splice(fromIndex)}else{$scope.historyObj=[]}$scope.commandGroup=[];setTimeout(function(){$scope.scrollUp=false})};$scope.getEvaFloatingIconRequiredOnLoginValue=function(){if(isEvaFloatingIconRequiredOnLogin===true){document.getElementById("display").checked=true}else{document.getElementById("notDisplay").checked=true}}}function floatingEvamaximize(){var maximizeIcon=document.getElementById("evaMaximizeIconId");maximizeIcon.click()}function findRecentCommands(obj){return obj.isRecentCommand}function setHeightOfCommandHistory(height){if(height>205){$("#commandHistory").css("height",205);$("#commandHistory").jScrollPane({autoReinitialise:true,animateScroll:true})}else{destroyJScrollPane($("#commandHistory"));$("#commandHistory").css("height",height)}}function setPositionOfCommadHistory(){if($('.scrolltop-sec').css('display')==='block'){$('.scroll-popupcontent').position({of:$('.scrolltop-sec'),my:'right bottom',at:'right-50 bottom-2',collision:"flipfit"}).animate({"opacity":1},100)}}function destroyJScrollPane(element){let jScrollPane=element.jScrollPane();let api=jScrollPane.data('jsp');api.destroy()}function showNameInitial(){var scope=getEVAScope();if(scope){scope.showInitialImage()}}function getEVAScope(){if(!eVAScope||eVAScope===null){eVAScope=angular.element(document.getElementById('ecwassistantcontroller')).scope()}return eVAScope}function refreshScope(){try{eVAScope=getEVAScope();if(eVAScope.$$phase!='$apply'&&eVAScope.$$phase!='$digest'){eVAScope.$apply()}}catch(e){}}function activeTimeline(thisArg){$(thisArg).parents().find('.immunizations-wrapper').children().find('div.hidden-sec').show();$(thisArg).parents('.timeline').find('div.hidden-sec').show();$(thisArg).parents('.timeline').find('dd.immun-timeline .events').addClass('timeline-padbtm');$(thisArg).parents('.timeline').find('dd.immun-timeline .events-body.immun-body').addClass('timeline-marbtm');$(thisArg).parents('.timeline').find('dd.immun-timeline-last .events').addClass('nopadbot');$(thisArg).parents('.timeline').find('dd.immun-timeline-last .events .events-body.immun-events-body').addClass('nomarbot')}function inactiveTimeline(thisArg){$(thisArg).parents().find('.immunizations-wrapper').children().find('div.hidden-sec').hide();$(thisArg).parents('.timeline').find('dldiv.hidden-sec').removeClass('hidden-sec');$(thisArg).parents('.timeline').find('dd.immun-timeline .events').removeClass('timeline-padbtm');$(thisArg).parents('.timeline').find('dd.immun-timeline .events-body.immun-body').removeClass('timeline-marbtm');$(thisArg).parents('.timeline').find('dd.immun-timeline-last .events').removeClass('nopadbot');$(thisArg).parents('.timeline').find('dd.immun-timeline-last .events .events-body.immun-events-body').removeClass('nomarbot')}var suggestionInterval;function startstopEVA(pid,pname,context,contextData){var scope=getEVAScope();if(scope.bEVAHidden){scope.bEVAHidden=false}else{scope.bEVAHidden=true}scope.showWelcomeMessage(true);if(scope.isEVASplited){scope.unifiedMode()}if(!scope.bEVAHidden){scope.openPreferredViewMode()}if(evaglobal.chatAssistanceWrapField.hasClass('open')&&evaglobal.isEvaMinimized){evaglobal.isEvaMinimized=false;$('#eva-maximize').hide();if(!scope.bEVAHidden){evaglobal.chatAssistanceWrapField.show()}}if(evaglobal.chatAssistanceWrapField.hasClass('open')){if(pid&&pid!=""){scope.showWelcomeMessage(true)}else{evaglobal.chatAssistanceWrapField.removeClass('open');evaglobal.chatAssistanceWrapField.fadeOut();scope.startListening(false);sessionStorage.setItem("callFromEva",false);urlPost("/mobiledoc/jsp/webemr/assistant/assistantController.jsp?action=resetPatientInSession");$('.chatscroll').off('jsp-user-scroll-y');destroyJScrollPane($("#commandHistory"))}evaglobal.currentscope=null;if(eVAScope!=null){eVAScope.assistantData=[];eVAScope=null}clearInterval(suggestionInterval);suggestionInterval=null;scope.turnOffEventListeners();if(getUserProfile("showFloatingButton")==="1"){if(isAiEnable){window.floatingButton.updateItem("eva",{icon:`<span class="eva-ai-icon"></span>`,evaFloatingIndicator:0})}else{window.floatingButton.updateItem("eva",{icon:`<span  class="eva-icon"></span>`,evaFloatingIndicator:0})}}}else{evaglobal.chatAssistanceWrapField.fadeIn();evaglobal.chatAssistanceWrapField.addClass('open');evaglobal.inputField.focus();scope.inputMode='text';scope.startListening(false);sessionStorage.setItem("callFromEva",true);$('.wave-eff-enabled').on('click.mic',function(){waveEffects()});scope.bindScrollEvent();scope.userName=evaglobal.userName;scope.userFullName=evaglobal.userFullName;if(scope.patientChangeData){scope.patientChangeData={showAlert:false,patientInEva:{},patientInEmr:{},alertTimeout:null,showConfirmationMessage:false}}}$(window).resize();setTimeout(function(){evaglobal.inputField.focus()},500)}function clearStaticVal(){if(!evaglobal.staticVal.match(getPrepositionRegex())){evaglobal.staticVal=""}}function getPrepositionRegex(){return new RegExp("\\s("+evaglobal.prepositions.join('|')+")\\s+","ig")}function getAllPatientWithName(newSource,strSearch,staticVal){let scope=getEVAScope();if(staticVal===evaglobal.prevStaticVal&&!evaglobal.isUserRequired){return}scope.loadingSuggestion=true;refreshScope();var name=strSearch.split(" ");var url="/mobiledoc/jsp/webemr/assistant/assistantController.jsp?action=resolveCmdParam&authToken="+eAuthToken+"&fnameFirst=true&fterm="+name[0];if(name[1]){url+="&lterm="+name[1]}else{url+="&lterm="}url+="&ptIds="+evaglobal.ptIds+"&staticVal="+staticVal;processResponseForAutoComplete(url,newSource,staticVal)}function createPromise(url,data){return new Promise(function(resolve,reject){$.post(makeURL(url),{},function(response){resolve(response)}).fail(function(xhr,textStatus,errorThrown){console.log(xhr.responseText);reject(xhr.responseText)})})}function processResponseForAutoComplete(url,newSource,staticVal){let scope=getEVAScope();createPromise(url).then(function(res){evaglobal.prevStaticVal=staticVal;if(res.trim()==='userNotRequired'){evaglobal.isUserRequired=false;clearSuggestion();return}else{evaglobal.isUserRequired=true}var obj=JSON.parse(res);for(var i=0;i<obj.length;i++){if(newSource.indexOf(staticVal+obj[i].value)===-1){if(!ExistInArray(newSource,staticVal+obj[i].value)){newSource.push(staticVal+obj[i].value)}evaglobal.isLoading=false;evaglobal.inputField.autoComplete('setSource',[newSource])}}clearSuggestion()},function(err){clearSuggestion();console.log(err)});function clearSuggestion(){scope.loadingSuggestion=false;refreshScope()}}function ExistInArray(array,value){for(var i=0;i<array.length;i++){if(array[i]===value)return true}return false}function loadPatientName(newSource,strSearch,staticVal){if(evaglobal.timer&&evaglobal.timer!=''){clearTimeout(evaglobal.timer)}if(!evaglobal.isLoading){evaglobal.timer=setTimeout(function(){evaglobal.isLoading=true;evaglobal.inputField.autoComplete('setSource',[]);getAllPatientWithName(newSource[0],strSearch,staticVal);evaglobal.isLoading=false;evaglobal.inputField.autoComplete('setSource',newSource)},200)}}function initializeEvaView(){let ARROWUP=38,ARROWDOWN=40;$('[data-toggle="tooltip"]').tooltip();$('.wave-eff-enabled').mawbutton({speed:300,scale:6,effect:"ripple"});evaglobal.inputField.keyup(function(e){let favoriteCommandsPopupDiv=$('.custom-popup.favroite-command-list');if(e.which=='13'){if(favoriteCommandsPopupDiv.is(':visible')){$(this).val($(this).val().substring(1))}processEnterkey($(this))}else if(e.which=='8'){clearStaticVal();$(this).trigger('input')}if($(this).val()!=""){let inputText=$(this).val();if(inputText.startsWith("/")){getEVAScope().initEvaFavoriteCommand();evaglobal.inputField.autoComplete('setSource',[]);let keyPressed=e.keyCode;let favoriteListDiv=$('.custom-popup-body ul.list-fav');switch(keyPressed){case ARROWDOWN:case ARROWUP:let activeUserFavorite=favoriteListDiv.find('li.active');let next=keyPressed==ARROWDOWN?'next':'prev';if(activeUserFavorite.length){activeUserFavorite.removeClass("active");if(activeUserFavorite[next]().length){activeUserFavorite[next]().addClass('active');$(this).val("/"+activeUserFavorite[next]()[0].innerText)}}else{favoriteListDiv.children().eq(keyPressed==ARROWDOWN?0:-1).addClass('active');let latestActiveFavorite=favoriteListDiv.find('li.active');$(this).val("/"+latestActiveFavorite[0].innerText)}e.preventDefault();return true}const _this=$(e.target);if(!favoriteCommandsPopupDiv.is(':visible')){favoriteCommandsPopupDiv.show().animate({},100,function(){$(this).position({of:_this,my:'left+10 bottom-2',at:'left top',collision:"flipfit"}).animate({"opacity":1},100)})}refreshScope()}else{favoriteCommandsPopupDiv.hide()}showSendIcon()}else{favoriteCommandsPopupDiv.hide();evaglobal.inputField.autoComplete('setSource',[evaglobal.initStatementArray]);showMicIcon()}e.preventDefault()})}function initializeEvaTriggers(startOnInit){if(startOnInit){setTimeout(function(){startstopEVA();getEVAScope().doFullScreen(true);refreshScope()})}$(window).keydown(function(event){if(event.keyCode==27){if(evaSpeechService.showWelcomeText){$('.welcome-text').animate({'display':'none','opacity':'0'},500,function(){});setTimeout(function(){$('.welcome-text').addClass('hide');evaglobal.inputField.focus()},1e3)}evaSpeechService.stopRecognizing();refreshScope()}});$('.wave-eff-enabled').on('click.mic',function(){waveEffects()});$('.icon-close-white').on('click',function(e){startstopEVA()});$('.icon-label-eva').on('click','.icon-label-eva',function(e){startstopEVA()});evaglobal.inputField.bind('input',function(e){if(getEVAScope().historyObj.length>0){fadeOutWelcomeMessage()}if(e.which==46||e.which==8||e.which==38||e.which==40){clearAutoCompleteTemporaryData()}var newSource=[evaglobal.initStatementArray];if(sessionStorage.assistantData){evaglobal.ptIds=JSON.parse(sessionStorage.assistantData).patients.join()}let strSearch;let value;switch(checkForPrepositions()){case 0:clearAutoCompleteTemporaryData();evaglobal.inputField.autoComplete('setSource',[evaglobal.initStatementArray]);break;case 1:newSource[0]=[];evaglobal.inputField.autoComplete('setSource',[]);value=$(this).val();strSearch=evaglobal.searchString?evaglobal.searchString:"";$("#hdnPatientName").val(strSearch);if(evaglobal.ptIds!=""){evaglobal.staticVal=value.substr(0,value.lastIndexOf(strSearch));getAllPatientWithName(newSource[0],strSearch,evaglobal.staticVal);evaglobal.inputField.autoComplete('setSource',newSource)}break;case 2:newSource[0]=[];value=$(this).val();strSearch=evaglobal.searchString?evaglobal.searchString:"";$("#hdnPatientName").val(strSearch);evaglobal.staticVal=value.substr(0,value.lastIndexOf(strSearch));loadPatientName(newSource,strSearch,evaglobal.staticVal);break;case 3:var strSpecialCommands=evaglobal.specialCommands.join("|");newSource[0]=[];if(evaglobal.inputField.val().match(new RegExp('^('+strSpecialCommands+')[a-z]{3}','ig'))){evaglobal.staticVal=evaglobal.inputField.val().match(new RegExp('^('+strSpecialCommands+')','ig'))[0];var ptStartIndex=evaglobal.staticVal.length;strSearch=$(this).val().substr(ptStartIndex);loadPatientName(newSource,strSearch,evaglobal.staticVal)}else{evaglobal.inputField.autoComplete('setSource',[])}break}$('.suggestion-star-icon').each(function(index){$(this).on('click',function(event){ecwAlert(event)})})});$(document).on('click','.show-link',function(){$(this).toggleClass('active');if($(this).hasClass('active')){$(this).parents('.assistant_expandable').find('.hidden-sec').show();$(this).children('span').text('less');if($(this).parents().hasClass('immunizations-wrapper')){activeTimeline($(this));let chartScroll=$(".chatscroll");chartScroll.stop().animate({scrollTop:1395},'800',function(){})}if($(this).parents().hasClass('mediaction-section')){activeTimeline($(this))}}else{$(this).parents('.assistant_expandable').find('.hidden-sec').hide();$(this).children('span').text('more');if($(this).parents().hasClass('immunizations-wrapper')){inactiveTimeline($(this));let chartScroll=$(".chatscroll");chartScroll.stop().animate({scrollTop:749},'800',function(){})}if($(this).parents().hasClass('mediaction-section')){inactiveTimeline($(this))}}});$(document).on('click','.description-box',function(){$('.description-box').removeClass('active');$(this).addClass('active');$('.description-box').find('.epriscrip-pcircle.ecwcheck').addClass('hide');$(this).find('.epriscrip-pcircle.ecwcheck').removeClass('hide')});$(document).on('click','.otherbox',function(){$(this).toggleClass('active');$(this).find('.ecw-greencheck').toggleClass('hide')})}function showSendIcon(){$('#micdiv').css('display','none');$('#mic').hide('scale',100);$('#cmdsenddiv').css('display','block');$('#cmdsend').show('scale',100)}function waveEffects(){$('.welcome-text').animate({'display':'none','opacity':'0'},500,function(){});setTimeout(()=>{$('.welcome-text').addClass('hide');evaglobal.inputField.focus()},1e3);evaSpeechService.showWelcomeText=false}function showMicIcon(){$('#cmdsend').css('display','none');$('#cmdsend').hide('scale',100);$('#micdiv').css('display','block');$('#mic').show('scale',100)}var prevEvaOverlayNumber=0;function processEnterkey(inputField){if(inputField===undefined){inputField=evaglobal.inputField}if(!inputField.val()){return false}if(prevEvaOverlayNumber!==evaglobal.evaOverlayNumber){$("#evaPrevCommandCardOverlay"+evaglobal.evaOverlayNumber).show();prevEvaOverlayNumber=evaglobal.evaOverlayNumber}clearStaticVal();evaService.processCommandFromEVA(inputField.val(),"","","");inputField.val("");inputField.autoComplete('setSource',[evaglobal.initStatementArray])}function initializeEvaWindowResize(){$(window).on('resize',function(){if(!evaglobal.restrictAction)evaService.setScrollHeight(60)}).resize();$(window).resize(function(){var scope=getEVAScope();if(window.innerWidth<1920){if(scope.isEVASplited){scope.splitScreen()}}eVAScope=null})}function initiliazeEvaAutoComplete(){$("#evainput").autoComplete({source:[],visibleLimit:4,dropdownStyle:{'overflow-x':'hidden',top:'-322px !important',bottom:'0px',width:'100%',"z-index":1002,"webkit-scrollbar-track-border-radius":'3px'},itemStyle:{fontSize:'16px',padding:'5px 0px 5px 17px'},closeOnBlur:true,callbackOnStarClick:function(){let eVAScope=getEVAScope();let favoriteCommand=eVAScope.getCommandIfFavorite(event.target.id);if(favoriteCommand.length>0){eVAScope.removeFromFavorite(favoriteCommand[0])}else{let command=event.target.previousSibling.innerText;let commandName=event.target.id;favoriteCommand=eVAScope.prepareFavoriteObject(commandName);eVAScope.addToFavorite(favoriteCommand)}}})}function fadeOutWelcomeMessage(){$('.welcome-text').animate({'display':'none','opacity':'0'},500,function(){});evaglobal.showWelcomeMsg=false;$('.chatscroll').removeClass('hide')}function clearAutoCompleteTemporaryData(){evaglobal.staticVal=""}function checkForPrepositions(){var code=0;var preps=evaglobal.prepositions.join("|");var strSpecialCommands=evaglobal.specialCommands.join("|");var prepRegex=new RegExp("\\b(?:"+preps+")\\s+(?!.*(?:"+preps+"))(.*)","i");var prepWithCharsRegex=new RegExp("\\b(?:"+preps+")\\s+(?!.*(?:"+preps+"))([a-z]{3}.*)","i");if(matchRegex(prepWithCharsRegex)){code=2}else if(matchRegex(prepRegex)){code=1}else if(evaglobal.inputField.val().match(new RegExp('^('+strSpecialCommands+')','i'))){code=3}return code}function matchRegex(regex){var matches=evaglobal.inputField.val().match(regex);if(matches){evaglobal.searchString=matches[1]}return matches}app.service('evaUserPreferencesService',function(){var supportsLocalStorage=isSupportsLocalStorage();var url=makeURL('/mobiledoc/jsp/webemr/assistant/assistantController.jsp');return{saveEvaUserPreferences:function(keyName,preference){if(supportsLocalStorage&&get(keyName)==preference){return}else{$.ajax({url:url+"&action=saveEvaUserPreference&keyName="+keyName+"&preference="+preference,"async":false,success:function(response){if(supportsLocalStorage){put(keyName,preference)}},error:function(response){if(supportsLocalStorage){put(keyName,preference)}}})}},loadEvaUserPreferences:function(keyName){if(supportsLocalStorage&&containsKey(keyName)){return get(keyName)}else{var preference="";$.ajax({url:url+"&action=loadEvaUserPreference&keyName="+keyName,"async":false,success:function(response){response=JSON.parse(response.trim());preference=response.preference.preference||""},error:function(error){console.log(error)}});return preference}}}});app.service('evaFeedbackService',function($http){return{addFeedback:function(parameters){var params={"authToken":eAuthToken,"feedbackData":JSON.stringify(parameters)};return $http({method:'POST',url:"/mobiledoc/jsp/webemr/assistant/assistantController.jsp",data:$.param({"action":"feedback","params":JSON.stringify(params)}),headers:{'Content-Type':'application/x-www-form-urlencoded'}})},loadResource:function(url){return $http({method:'POST',url:url,headers:{'Accept':'application/x-www-form-urlencoded'}})}}});(function($){$.fn.hasJScrollBar=function(){var api=this.data('jsp');return api.getContentHeight()>this.height()}})(jQuery);function cleanUpChathistory(){var eVAScope=getEVAScope();var caping=parseInt(getItemKeyValue("EvaHistoryCap"));if(eVAScope.historyObj.length>caping&&$('.chatscroll').hasJScrollBar()&&!evaglobal.restrictAction){for(var idx=1;idx<eVAScope.historyObj.length;idx++){if(eVAScope.historyObj[idx].source=='me'){eVAScope.historyObj.splice(0,idx);break}}}iterateCommandHistory(eVAScope);let histObjLength=eVAScope.historyObj.length;if(histObjLength-2>=0&&(eVAScope.historyObj[histObjLength-1].templateURL!="patientinfo/patientLookup"||eVAScope.historyObj[histObjLength-1].templateURL!="patientinfo/providerLookup")){evaPatientProviderLookup()}}function iterateCommandHistory(eVAScope){for(let idx=0;idx<eVAScope.historyObj.length;idx++){if(eVAScope.historyObj[idx].source==='me'){for(let fav=0;fav<evaglobal.userFavorites.length;fav++){if(evaglobal.userFavorites[fav].commandName===eVAScope.historyObj[idx].commandName){eVAScope.historyObj[idx].isFavorite=true;break}}}}}function evaPatientProviderLookup(){if(eVAScope.evaPatientLookupRandomNumber!=null&&eVAScope.evaPatientLookupRandomNumber!=undefined){$("#ptlookupOverlay"+eVAScope.evaPatientLookupRandomNumber).show();eVAScope.evaPatientLookupRandomNumber=null}if(eVAScope.evaProviderLookupRandomNumber!=null&&eVAScope.evaProviderLookupRandomNumber!=undefined){$("#providerlookupOverlay"+eVAScope.evaProviderLookupRandomNumber).show();eVAScope.evaProviderLookupRandomNumber=null}}function getIdentifiersForId(patientId){var patientData;var patientInfo="";$.ajax({url:"/mobiledoc/jsp/webemr/util/getIdentifiersForPatient.jsp",global:false,type:"POST",dataType:"JSON",data:{patient:patientId,Device:"webemr"},"async":false,success:function(result){patientData=result;if(typeof patientData=="string"){patientData=JSON.parse(patientData)}var dob=new Date(patientData.dateOfBirth);patientInfo="<span>"+escapeHtml(patientData.lastName)+","+escapeHtml(patientData.firstName)+","+escapeHtml(patientData.middleInitial)+" &#127874; "+formatDob(dob)+" ("+getAgeFromDob(patientData.dateOfBirth)+"  "+formatSex(patientData.sex)+")  &#128193; Acc No. "+escapeHtml(patientData.accountNumber)+"</span>"}});return patientInfo}function formatDob(dob){var month_names=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var day=dob.getDate();var month_index=dob.getMonth();var year=dob.getFullYear();return month_names[month_index]+" "+day+", "+year}function getAgeFromDob(dob){var formattedAge;var DAYS=30;var WEEKS=24;var MONTHS=24;var ageInDays=moment().diff(dob,'days');var ageInWeeks=moment().diff(dob,'weeks');var ageInMonths=moment().diff(dob,'months');if(ageInDays<=DAYS){formattedAge=ageInDays+' do'}else if(ageInWeeks<=WEEKS){formattedAge=ageInWeeks+' wo'}else if(ageInMonths<=MONTHS){formattedAge=ageInMonths+' mo'}else{formattedAge=moment().diff(dob,'years')+' yo'}return formattedAge}function formatSex(sex){switch(sex.toUpperCase()){case'MALE':case'M':return'M';case'FEMALE':case'F':return'F';default:return'Other'}}$(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange',"#howtodiv",function(e){let videoId=e.target.parentElement.parentElement.id;if(!window.screenTop&&!window.screenY){var searchPanel=$('.char-body .chatscroll');var api=searchPanel.data('jsp');api.scrollToElement($('#'+videoId),{stickToTop:true},true)}});function settingEvaAi(){getEVAScope().getEvaFloatingIconRequiredOnLoginValue();$('#evaSettingConfirmDia').modal({backdrop:'static',keyboard:false})}function saveEvaAiSetting(){var radioValue=document.querySelector('input[name="setting_option"]:checked').value;var evaFloatingIconRequiredOnLogin=false;if(radioValue==="display"){evaFloatingIconRequiredOnLogin=true}evaService.saveAiSetting(evaFloatingIconRequiredOnLogin)}
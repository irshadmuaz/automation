angular.module('ecw.dir.savePrompt',[]).constant('SAVE_PROMPT_CONSTANT',{PREFIX:'saveprompt_'}).value('baseURLForSP',{value:''}).factory('savePromptFactory',function(){var savePromptFactoryObj={};savePromptFactoryObj.directiveList=[];savePromptFactoryObj.addDirectiveId=function(directiveId){if(directiveId){if($.inArray(directiveId,this.directiveList)===-1){this.directiveList.push(directiveId);return true}}return false};savePromptFactoryObj.removeDirectiveId=function(directiveId){if(directiveId){if($.inArray(directiveId,this.directiveList)>-1){this.directiveList.splice($.inArray(directiveId,this.directiveList),1);return true}}return false};savePromptFactoryObj.validateDirectives=function(){var directiveList=this.directiveList.slice();for(var nIndex=0;nIndex<directiveList.length;nIndex++){if($("#"+directiveList[nIndex]).length===0||$("#"+directiveList[nIndex]).closest('.modal').css('display')==="none"){this.removeDirectiveId(directiveList[nIndex])}}};savePromptFactoryObj.getLength=function(){return this.directiveList.length};savePromptFactoryObj.getLastDirectiveId=function(){this.validateDirectives();if(this.getLength()>0){return this.directiveList[this.getLength()-1]}};return savePromptFactoryObj}).directive('saveprompt',function($http,$location,$timeout,$route,$window,APP_CONSTANT,SAVE_PROMPT_CONSTANT,baseURLForSP,savePromptFactory){var returnData={restrict:'AE',replace:'true',scope:{dirtyFlag:'=',saveFormData:'&',closeFormData:'&',customeNameForDontSave:'@',customMessage:'@',hideSaveButton:'@',topClass:"@"},link:function(scope){var stopLcs=null;var currentDirectiveId=SAVE_PROMPT_CONSTANT.PREFIX+scope.$id;scope.hideSaveButton=!scope.hideSaveButton?false:scope.hideSaveButton==='true';scope.customMessage=!scope.customMessage?"You have unsaved data. Click Save to retain your changes.":scope.customMessage;scope.customeNameForDontSave=!scope.customeNameForDontSave?"Don't Save":scope.customeNameForDontSave;savePromptFactory.addDirectiveId(currentDirectiveId);if(baseURLForSP.value===''){baseURLForSP.value=getBaseURL()}startWatch();function handle(event,next,current){if(next===baseURLForSP.value){return}if(handleOnBeforeUnloadForSavePromptDirective()===APP_CONSTANT.UNSAVED_DATA_CONFIRM_MESSAGE){if(event&&event.currentScope&&SAVE_PROMPT_CONSTANT.PREFIX+event.currentScope.$id===savePromptFactory.getLastDirectiveId()){if(!$window.confirm(APP_CONSTANT.UNSAVED_DATA_CONFIRM_MESSAGE)){event.preventDefault();stopLcs();scope.tailPassExpected=undefined;$timeout(startWatch,0,false)}return}}if(event&&event.currentScope&&SAVE_PROMPT_CONSTANT.PREFIX+event.currentScope.$id!==savePromptFactory.getLastDirectiveId()){return}if(scope.pass){setTokens(false,undefined);return}if(scope.tailPassExpected){event.preventDefault();if(next===decodeURI(next)){scope.tailPassExpected=undefined}return}if(next===decodeURI(next)){if(scope.dirtyFlag){if(!$window.confirm(APP_CONSTANT.UNSAVED_DATA_CONFIRM_MESSAGE)){event.preventDefault()}else{setTokens(true,undefined)}}else{setTokens(true,undefined)}}else{scope.tailPassExpected=true;if(scope.dirtyFlag){if(!$window.confirm(APP_CONSTANT.UNSAVED_DATA_CONFIRM_MESSAGE)){event.preventDefault();stopLcs();$location.path(current.substr(current.indexOf("#")+1),false);scope.tailPassExpected=undefined;$timeout(startWatch,0,false)}else{setTokens(true,undefined)}}else{setTokens(true,undefined)}}function setTokens(passValue,tailPassExpectedValue){scope.pass=passValue;scope.tailPassExpected=tailPassExpectedValue}}function getBaseURL(){var baseURL='';baseURL=$location.absUrl().replace($location.url(),'');if(baseURL&&baseURL.charAt(baseURL.length-1)==='#'){baseURL=baseURL.substring(0,baseURL.length-1)}return baseURL}function startWatch(){stopLcs=scope.$on("$locationChangeStart",handle)}function safelyDestroySavePrompt(){savePromptFactory.removeDirectiveId(currentDirectiveId);if(stopLcs){stopLcs()}}scope.closeModalWindow=function(){if(scope.dirtyFlag){scope.showSavePrompt=true}else{scope.closeFormData();safelyDestroySavePrompt()}};scope.saveData=function(save){scope.showSavePrompt=false;$('#'+currentDirectiveId).removeClass('show');if(save===1){scope.saveFormData()}else if(save===2){scope.closeFormData()}};scope.$on('$destroy',function(){scope.dirtyFlag=undefined;safelyDestroySavePrompt();removeScopePropertyAndMethod(scope);scope=null;delete scope})}};if($("#save-prompt-tpl-taglib").length!==0){returnData.template=$("#save-prompt-tpl-taglib").html()}else{returnData.templateUrl='/mobiledoc/jsp/webemr/templates/savePrompt-tpl.jsp'}return returnData});
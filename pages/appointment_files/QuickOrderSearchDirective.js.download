var quickOrderSearchApp=angular.module('QuickOrderSearch',['ui.bootstrap','RxHelper','ecw.service.EncDetailsService','ecw.dir.alertmessage','rtbcModule','ecw.patientCentricDosing']);quickOrderSearchApp.directive('myQuickOrder',function($http,$timeout,$filter,$ocLazyLoad,$modal,rxService,EncDetailsService,rtbcService,ePAOrderService){return{restrict:'AE',scope:{topClass:"@",qosResultObj:'=qosResultObj',qosFilterObj:'=qosFilterObj',setSearchResultObj:'&',getItemIdForDuplicateCheck:'&',isRxNameOnly:'&',getEncounterId:'&',quickSearchMedRecDestroy:'=?',isCalledFrom:"@"},templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/common/QuickOrderTemplate.html'),link:function(scope,element,attributes){if(typeof scope.topClass=='undefined'||scope.topClass.length<=0){scope.topClass="MQSD_TopClass"}scope.qosd_parentName=scope.qosFilterObj.parentName;if(scope.isCalledFrom&&(scope.isCalledFrom==='anesthesia'||scope.isCalledFrom==='anesthesia-meds')){scope.qosd_parentName=scope.isCalledFrom}scope.genericPrice={};scope.drugPrice={};scope.hasFormularyCheckDone=false;scope.formularyInfo={};scope.loadFormularyInfo={};scope.m_bShowRxHubFormulary=false;scope.formulary={};scope.searchText={name:""};scope.nLeftArrowEnable=0;scope.nRightArrowEnable=0;scope.encLock=0;if(typeof scope.qosResultObj!='undefined'&&scope.qosResultObj.length>0){scope.qosResultObj={resulSet:""}}var totalFavRxRecords=0;var favStartCount=0;var perPageCount=15;if(typeof scope.qosFilterObj.nRxListCount=='undefined'){scope.qosFilterObj.nRxListCount=10}if(scope.qosFilterObj.hasOwnProperty("encLock")){scope.encLock=scope.qosFilterObj.encLock}scope.dosageResultSet=[];scope.genericEquivalent=[];var timer="";var isLoading=false;let hideMSClinical=scope.isCalledFrom==='RegistryRxTab'||scope.isCalledFrom==='RegistryAllergiesTab';scope.showNDCWarningforNonNDCDrugDoses=false;if(getItemKeyValue("showNDCWarningforNonNDCDrugDoses").toLowerCase()=="yes"){scope.showNDCWarningforNonNDCDrugDoses=true}scope.bDispenseInventoryLinkEnabled=false;if(getItemKeyValue("EnableDispenseAndInventoryLink").toLowerCase()=="yes"){scope.bDispenseInventoryLinkEnabled=true}scope.b_DrugDbEnabled=getItemKeyValue("EnableMSClinical").toLowerCase();if(hideMSClinical){scope.b_DrugDbEnabled='no'}scope.bOrderingRxMultipleTimes=false;scope.enableCorrectionalFeatures=getItemKeyValue('EnableCorrectionalFeatures').toLowerCase()=="yes";scope.enableDOCFormulary=getItemKeyValue('EnableDOCFormulary').toLowerCase()=="yes";scope.DOCFormularyDefaultClassification=getItemKeyValue('DOCFormularyDefaultClassification',true);if(getItemKeyValue("OrderingRxMultipleTimes").toLowerCase()=="yes")scope.bOrderingRxMultipleTimes=true;scope.$watch('qosFilterObj.itemid',function(newvalue,oldvalue){scope.qosFilterObj.itemid=newvalue},true);scope.MedispanId=getItemKeyValue("MedispanRx",true);scope.CustomRxId=getItemKeyValue("CustomRx",true);scope.MultumId=getItemKeyValue("MultumRx",true);scope.compoundRxId=getItemKeyValue("CompoundRx",true);scope.b_ShowMultumDosesFormCustom=false;var multumCustomDrug=getUserProfile("ShowMultumDosesForCustomDrugs");if(multumCustomDrug.length>0&&multumCustomDrug=="1"){scope.b_ShowMultumDosesFormCustom=true}scope.b_MedispanEnabled=getItemKeyValue("EnableMedispan").toLowerCase();scope.m_bAllergyInteraction=true;scope.RxListType=[];scope.RxSearchType=[];scope.RxDefaultSearchTypeId='0';scope.rxSearchTypeText='Starts With';scope.RxDefaultListTypeId={id:0};scope.RxDefaultDosesTypeId=2;scope.showCustomDeletedDrugs=0;scope.showDeletedOption=0;if(scope.isCalledFrom==='Registry'||scope.isCalledFrom==='RegistryRxTab'){scope.showDeletedOption=1}scope.showDiscontinuedDrugs=0;scope.showObsoleteMessage=false;if(scope.isCalledFrom==='renewalRequest'||scope.isCalledFrom==='changeRequest'){scope.showDiscontinuedDrugs=0}else{scope.showDiscontinuedDrugs=getUserProfile("ShowDiscontinuedDrugs",global.TrUserId);if(scope.showDiscontinuedDrugs===1||scope.showDiscontinuedDrugs==="1")scope.showDiscontinuedDrugs=-1;else scope.showDiscontinuedDrugs=0}scope.selectedRxName="";scope.selectedRxItemId="";scope.selectedRxDrugNameId="";scope.selectedRxObject={};scope.selectedIndex=0;scope.OrdersForEnc=[];scope.ShowMessageForPastVisitItemKey=getItemKeyValue("ShowMessageForPastVisit");scope.encdateAddRx="";scope.enctimeAddRx="";scope.encfacilityId="";if(scope.qosFilterObj.parentName=="TelEncounter"){if(scope.qosFilterObj.encounterID>0)EncDetailsService.fetchEncDetails(scope.qosFilterObj.encounterID)}if((scope.qosFilterObj.parentName=="TelEncounter"||scope.qosFilterObj.parentName==="currMed"||scope.qosFilterObj.parentName==="RxHistory"||scope.qosFilterObj.parentName==="ExtRxHistory"||scope.qosFilterObj.parentName==="Unreconcile Meds")&&scope.qosFilterObj.encounterID>0){if(EncDetailsService.getEncDetailsByEncId&&EncDetailsService.getEncDetailsByEncId(scope.qosFilterObj.encounterID).encDate){scope.encdateAddRx=EncDetailsService.getEncDetailsByEncId(scope.qosFilterObj.encounterID).encDate;scope.enctimeAddRx=EncDetailsService.getEncDetailsByEncId(scope.qosFilterObj.encounterID).encTime;scope.encfacilityId=EncDetailsService.getEncDetails().facilityId}}scope.rxPropertiesObj=getRxProperties();scope.strengthId=scope.rxPropertiesObj.Size;scope.formulationId=scope.rxPropertiesObj.Formulation;scope.takeId=scope.rxPropertiesObj.Take;scope.routeId=scope.rxPropertiesObj.Route;scope.frequencyId=scope.rxPropertiesObj.Frequency;scope.durationId=scope.rxPropertiesObj.Duration;scope.dispenseId=scope.rxPropertiesObj.Amount;scope.refillsId=scope.rxPropertiesObj.Refills;scope.m_bFirstRx=true;if(scope.qosFilterObj.parentName==="TelEncounter"){scope.isRtbcServiceEnabled=getItemKeyValue("EnableRtbcService").toLowerCase()==="yes";if(getUserProfile("RtbcSettings")==='1'){scope.showRtbcPopup=true}else{scope.showRtbcPopup=false}scope.rtbcEligibilityFlag=false;if(scope.isRtbcServiceEnabled){$http({method:"POST",url:"/mobiledoc/emr/rtbc/getRtbcResponse",cache:false,params:{PatientId:scope.qosFilterObj.patientId,EncounterId:scope.qosFilterObj.encounterID,Task:'getRtbcEligibility'}}).success(function(response){if(response){if(response.status){if(response.status==='success'){scope.rtbcEligibilityFlag=true;if(response.RtbcVendorName){scope.rtbcVendorName=response.RtbcVendorName}}if(response.RtbcResponse){scope.rtbcEligibilityErrMsg=response.RtbcResponse}}}});$(function(){$('ul.rtbcEligDivQuick li.dropdown').on("mouseenter",function(){$(this).parent('.dropdown').toggleClass('open');$(this).find('.dropdown-menu').stop(true,true).delay(200).fadeIn(500)}).on("mouseleave",function(){$(this).find('.dropdown-menu').stop(true,true).delay(200).fadeOut(500)})})}}scope.isRxEligibilitySuccessful=false;scope.isEpaServiceEnabled=getItemKeyValue("EnableePAService").toLowerCase()==="yes";scope.ePAClicked=function(index){scope.dosageResultSet[index].isCallFromePA=true;scope.selectDosage(index)};scope.openEPAInitializePopup=function(existingRxObject,allergyInteractionsPassed){let rxObject=existingRxObject;if(typeof rxObject==='undefined'){rxObject=angular.copy(scope.selectedRxObject)}if(!rxObject){return}if(!allergyInteractionsPassed){scope.callFromePA=true;scope.CheckAllergyInteraction(rxObject);return}if(rxObject.ItemId){rxObject.ItemId=rxObject.ItemId}else if(rxObject.itemID){rxObject.ItemId=rxObject.itemID}else if(scope.itemIdToSaveRx){rxObject.ItemId=scope.itemIdToSaveRx}else{try{if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"){if(scope.selectedRxObject.hasOwnProperty('itemid')&&scope.selectedRxObject.itemid!==""&&scope.selectedRxObject.itemid.length>0)rxObject.ItemId=scope.selectedRxObject.itemid;else rxObject.ItemId=scope.qosResultObj.resultSet.nItemId}else if(scope.b_DrugDbEnabled==='yes'&&checkUndefinedOrNullOrBlank(scope.selectedRxObject.ItemId,false)===false){rxObject.ItemId=scope.selectedRxObject.ItemId}else{rxObject.ItemId=scope.qosResultObj.resultSet.nItemId}}catch(e){}}if(scope.formularyInfo.FormularyID&&scope.formularyInfo.FormularyID.length>0){rxObject.isFormularyEnabled=true}rxObject.isMedispanEnabled=scope.b_MedispanEnabled==='yes'?true:false;rxObject.selectedRxItemName=scope.qosResultObj.resultSet.sItemName;if(scope.nSelectedAssessmentId==undefined){rxObject.nSelectedAssessmentId='0'}else{rxObject.nSelectedAssessmentId=scope.nSelectedAssessmentId}rxObject.description=rxObject.description;var epaFacilityId=scope.encfacilityId;if(!epaFacilityId){epaFacilityId=EncDetailsService.getEncDetails().facilityId}scope.epaObject={rxObject:rxObject,context:scope.qosFilterObj.parentName,userId:global.TrUserId,patientId:scope.qosFilterObj.patientId,encounterId:scope.qosFilterObj.encounterID,facilityId:epaFacilityId,erxMsgId:0};rxObject.isCallFromePA=false;ePAOrderService.openEPAInitializePopup(scope.epaObject)};scope.qsFilterObj={};scope.qsFilterObj.RxDrugSearchType=getUserProfile('quickSearchRxDrugSearchType')+"";if(scope.qsFilterObj.RxDrugSearchType===''||scope.qsFilterObj.RxDrugSearchType==='0'||scope.qsFilterObj.RxDrugSearchType===0){scope.qsFilterObj.RxDrugSearchType='1'}scope.b_DrugDbEnabled=getItemKeyValue("EnableMSClinical").toLowerCase();if(hideMSClinical){scope.b_DrugDbEnabled='no'}scope.rxDrugSearchTypeList=[{name:'Drug & Route',value:'1',title:'Drug & Route'},{name:'Drug Product Description',value:'2',title:'Drug Name, Strength, Route and Formulation'}];var rxDrugSearchTypeIdWiseMap=[];var rxDrugSearchType;for(var index=0;index<scope.rxDrugSearchTypeList.length;index++){rxDrugSearchType=scope.rxDrugSearchTypeList[index];rxDrugSearchTypeIdWiseMap[rxDrugSearchType.value]=rxDrugSearchType}scope.disableDrugSearch=function(){if(scope.RxDefaultListTypeId.id==="0"||scope.RxDefaultListTypeId.id===0||scope.RxDefaultListTypeId.id===scope.MedispanId){return false}return true};scope.rxTypeChange=function(){if(scope.RxDefaultListTypeId.id===null)return;scope.updateDrugDBDefault(scope.RxDefaultListTypeId.id);scope.rxDrugSearchTypeChange();scope.isMSClinicalDoseWindow=false;if(scope.favRxSelected){$timeout(function(){$('.second-level'+'.'+scope.topClass).removeClass('hide');$('.second-level'+'.'+scope.topClass).addClass('hide');$(".first-levelMedRec").removeClass("hide")});scope.favRxList=[];scope.getFavRx()}};scope.rxDrugSearchTypeChange=function(){if(scope.disableDrugSearch()){scope.qsFilterObj.RxDrugSearchTypeTitle="Select MedispanRx or All Rx from Rx Type";return true}scope.isMSClinicalDoseWindow=false;if(scope.favRxSelected){$timeout(function(){$('.second-level'+'.'+scope.topClass).removeClass('hide');$('.second-level'+'.'+scope.topClass).addClass('hide');$(".first-levelMedRec").removeClass("hide")})}scope.updateRxDrugSearchType(scope.qsFilterObj.RxDrugSearchType);var rxDrugSearchType=rxDrugSearchTypeIdWiseMap[scope.qsFilterObj.RxDrugSearchType];if(rxDrugSearchType){scope.qsFilterObj.RxDrugSearchTypeTitle=rxDrugSearchType.title;scope.updateRxDrugSearchType(rxDrugSearchType.value);return true}return false};scope.setDefaultDrugSearchType=function(newDrugDbLookup){var drugDBLookUp=getUserProfile("DefaultDrugDBLookUp");drugDBLookUp=''+drugDBLookUp;newDrugDbLookup=''+newDrugDbLookup;if(drugDBLookUp!=="0"&&drugDBLookUp!==0&&drugDBLookUp!==''+scope.MedispanId&&(newDrugDbLookup==="0"||newDrugDbLookup===0||newDrugDbLookup===''+scope.MedispanId)){scope.qsFilterObj.RxDrugSearchType='1';scope.updateRxDrugSearchType(scope.qsFilterObj.RxDrugSearchType)}};scope.updateRxDrugSearchType=function(id){var userProfileKeyValPair={};userProfileKeyValPair["quickSearchRxDrugSearchType"]=id;updateUserProfileLocalCache("quickSearchRxDrugSearchType",id);saveUserProfileSettings(userProfileKeyValPair);scope.getSearchResult()};function updateRxDosagesOption(id){var userProfileKeyValPair={};userProfileKeyValPair["RxDosagesOption"]=id;updateUserProfileLocalCache("RxDosagesOption",id)}scope.checkIsCompoundDrug=function(value){if(value==='true'||value===true||value==='1'||value===1){return true}return false};scope.setRxSearchType=function(value){scope.RxDefaultSearchTypeId=value;for(var i=0;i<scope.RxSearchType.length;i++){var rxSearchType=scope.RxSearchType[i];if(rxSearchType.Id===value){scope.rxSearchTypeText=rxSearchType.name;break}}};scope.qosFilterObj.setDefaultForDiscontinuedDrugs=function(){scope.showDiscontinuedDrugs=0};scope.changeDeleteFlag=function(){if(scope.showCustomDeletedDrugs===0){scope.showCustomDeletedDrugs=1}else{scope.showCustomDeletedDrugs=0}};scope.changeDiscontinuedFlag=function(obj){scope.isRxEligibilitySuccessful=false;if(scope.showDiscontinuedDrugs===-1){scope.showDiscontinuedDrugs=0;var userProfileKeyValPair={};userProfileKeyValPair["ShowDiscontinuedDrugs"]=0;updateUserProfileLocalCache("ShowDiscontinuedDrugs",0);saveUserProfileSettings(userProfileKeyValPair)}else{scope.showDiscontinuedDrugs=-1;var userProfileKeyValPair={};userProfileKeyValPair["ShowDiscontinuedDrugs"]=1;updateUserProfileLocalCache("ShowDiscontinuedDrugs",1);saveUserProfileSettings(userProfileKeyValPair)}if(scope.searchText.name.length>0){if(typeof scope.formularyInfo.FormularyID!="undefined"&&scope.formularyInfo.FormularyID!=""){var sSynonymId="";if(scope.b_MedispanEnabled=="no"){sSynonymId=scope.qosResultObj.resultSet.sSupplierId}else{sSynonymId=scope.qosResultObj.resultSet.sDrugNameId}if(sSynonymId>0&&scope.formularyInfo.FormularySourceCode!=""){scope.loadFormularyRxDoses(sSynonymId,scope.qosResultObj.resultSet.nItemId,scope.RxDefaultDosesTypeId)}else{scope.getDosage(scope.qosResultObj.resultSet.sDrugNameId,scope.qosResultObj.resultSet.nItemId,scope.RxDefaultDosesTypeId)}}else{scope.getDosage(scope.qosResultObj.resultSet.sDrugNameId,scope.qosResultObj.resultSet.nItemId,scope.RxDefaultDosesTypeId)}}};scope.setRxDosesType=function(val){scope.isRxEligibilitySuccessful=false;scope.RxDefaultDosesTypeId=val;updateRxDosagesOption(val);if(scope.searchText.name.length>0){if(typeof scope.formularyInfo.FormularyID!="undefined"&&scope.formularyInfo.FormularyID!=""){var sSynonymId="";if(scope.b_MedispanEnabled=="no"){sSynonymId=scope.qosResultObj.resultSet.sSupplierId}else{sSynonymId=scope.qosResultObj.resultSet.sDrugNameId}if(sSynonymId>0&&scope.formularyInfo.FormularySourceCode!=""){scope.loadFormularyRxDoses(sSynonymId,scope.qosResultObj.resultSet.nItemId,2)}else{scope.getDosage(scope.qosResultObj.resultSet.sDrugNameId,scope.qosResultObj.resultSet.nItemId,scope.RxDefaultDosesTypeId)}}else{scope.getDosage(scope.qosResultObj.resultSet.sDrugNameId,scope.qosResultObj.resultSet.nItemId,scope.RxDefaultDosesTypeId)}}};scope.getRxListType=function(){if(scope.RxListType.length>0){}else{var url="/mobiledoc/jsp/catalog/xml/getSubCategories.jsp?keyName=Rx";var promise=$http.get(makeURL(url));promise.then(function(payload){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(payload.data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(scope.RxListType.length==0){scope.RxListType=jsonobj.Envelope.Body['return'].item}else{scope.RxListType.push(jsonobj.Envelope.Body['return'].item)}}scope.RxListType.push({id:"0",name:"All Rx"});for(var i=0;i<scope.RxListType.length;i++){if(scope.RxListType[i].name=="MedispanRx"){scope.MedispanId=scope.RxListType[i].id}}},function(error){})}};scope.RxSearchType.push({Id:"0",name:"Starts With"});scope.RxSearchType.push({Id:"1",name:"Contains"});scope.RxSearchType.push({Id:"2",name:"All Words"});scope.getRxFormulary=function(drugNameID,itemID){if(scope.qosFilterObj.encounterID>0){var url='/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/getRxFormulary.jsp?encid='+scope.qosFilterObj.encounterID;var promise=$http.post(makeURL(url));promise.success(function(data){scope.hasFormularyCheckDone=true;scope.formularyInfo=data.formulary;if(typeof scope.formularyInfo=="object"){if(data.hasOwnProperty("loadFormularyInfo")){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.loadFormularyInfo);if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].status=="success"){scope.loadFormularyInfo=jsonobj.Envelope.Body['return']}else{scope.loadFormularyInfo.message="No Formulary Found for patient"}}}else{scope.loadFormularyInfo.message="No Formulary Found for patient"}}else{scope.loadFormularyInfo.message="No Formulary Found for patient"}})}};scope.patientVitalData={};scope.loadPatientVitals=function(encounterId,patientId){if(scope.qosFilterObj.parentName!=="TelEncounter"&&scope.qosFilterObj.parentName!=="Refill Request"){return}scope.initialPatientId=patientId;var url="/mobiledoc/emr/patientvital/getHeightAndWeightJson?patientId="+patientId;url=makeURL(url);var promise=$http.post(url);promise.success(function(data){scope.patientVitalData=data})};scope.loadPatientVitals(scope.qosFilterObj.encounterID,scope.qosFilterObj.patientId);scope.searchResult=[];scope.isMSClinicalDoseWindow=false;scope.getSearchResult=function(e){scope.isMSClinicalDoseWindow=false;if(!scope.favRxSelected){scope.searchResult=[];$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).addClass('hide');if(scope.searchText.name.length>=3){if(timer&&timer!=''){$timeout.cancel(timer)}if(!isLoading){timer=$timeout(function(){isLoading=true;$('#quick-search'+scope.topClass+'.first-level'+'.'+scope.topClass).removeClass('hide');if(scope.qosFilterObj.parentName==="OBFlowsheet"){var strUrl="/mobiledoc/jsp/webemr/progressnotes/common/QuickSearchResult.jsp?searchType=LabDISearch&searchText="+encodeURIComponent(scope.searchText.name)+"&TrUserId="+global.TrUserId+"&RxTypeID="+scope.RxDefaultListTypeId.id+"&nEncounterId="+scope.qosFilterObj.encounterID+"rxDrugSearchType="+scope.qsFilterObj.RxDrugSearchType;var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data,status,headers,config){scope.searchResult=[];scope.searchResult=data.encData.Items})}else{var strUrl="/mobiledoc/jsp/webemr/progressnotes/common/QuickSearchResult.jsp?searchType="+scope.RxDefaultSearchTypeId+"&calledFrom=MedReconciliation&searchText="+encodeURIComponent(scope.searchText.name)+"&TrUserId="+global.TrUserId+"&RxTypeID="+scope.RxDefaultListTypeId.id+"&nEncounterId="+scope.qosFilterObj.encounterID+"&nLimit=40&rxDrugSearchType="+scope.qsFilterObj.RxDrugSearchType+"&hideMSClinical="+hideMSClinical;if(scope.bDispenseInventoryLinkEnabled&&scope.qosFilterObj.parentName!="currMed"){strUrl=strUrl+"&facilityId="+global.facilityId}strUrl=strUrl+'&bObsolete='+scope.showDiscontinuedDrugs;strUrl=strUrl+'&showDeletedDrug='+scope.showCustomDeletedDrugs;var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data,status,headers,config){scope.filterObj={start:0,end:scope.qosFilterObj.nRxListCount};scope.searchResult=[];scope.searchResult=data.encData.Items;let isDifferentEncounterId=scope.isDifferentEncounter();if(!scope.hasFormularyCheckDone||isDifferentEncounterId){scope.getRxFormulary()}if(scope.searchResult.length>scope.filterObj.end){scope.nRightArrowEnable=1}else{scope.nRightArrowEnable=0}if(scope.filterObj.start>scope.qosFilterObj.nRxListCount){scope.nLeftArrowEnable=1}else{scope.nLeftArrowEnable=0}})}isLoading=false},500)}}}else{scope.favRxSelected=false;scope.favRxList=[];favStartCount=0;totalFavRxRecords=0;scope.showFavRx()}};scope.isDifferentEncounter=function(){try{if(scope.qosFilterObj.hasOwnProperty("parentName")&&scope.qosFilterObj.parentName==="Refill Request"&&scope.qosFilterObj.hasOwnProperty("isDifferentEncounterId")){return scope.qosFilterObj.isDifferentEncounterId}}catch(e){}return false};scope.getDosage=function(drugNameID,itemID,RxType){scope.dosageResultSet=[];if(scope.isRtbcServiceEnabled){scope.isMedMulEquiDrug=rtbcService.checkMedispanMultumEquipmentSupply(scope.selectedRxObject.nParentID)}scope.showLoadingImage();if(getItemKeyValue("EnableMedispan").toLowerCase()=="no"){scope.showObsoleteMessage=false;scope.showDiscontinuedRxIcon=false;var url='/mobiledoc/jsp/catalog/xml/getDosesForRx.jsp?RxType='+RxType+'&rxId='+itemID+'&bObsolete='+scope.showDiscontinuedDrugs;if(scope.selectedRxObject.nParentID!=scope.MultumId&&!scope.b_ShowMultumDosesFormCustom){url=url+"&multumDoses=0"}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDosageCalcCombos()}scope.hideLoadingImage()})}else{if(scope.selectedRxObject.nParentID==scope.MedispanId||drugNameID>0||scope.selectedRxObject.nParentID==scope.compoundRxId){scope.showObsoleteMessage=false;scope.showDiscontinuedRxIcon=false;var url='/mobiledoc/jsp/ecwrx/getDoses.jsp?RxType='+RxType+'&dnid='+drugNameID+'&ItemId='+itemID+'&bObsolete='+scope.showDiscontinuedDrugs;if(scope.enableDOCFormulary&&scope.enableCorrectionalFeatures){url='/mobiledoc/jsp/Corrections/formulary/getDoses.jsp?RxType='+RxType+'&dnid='+drugNameID+'&ItemId='+itemID+'&bObsolete='+scope.showDiscontinuedDrugs}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('status')&&jsonobj.Envelope.Body['return'].status==='failed'){scope.dosageResultSet.errorMessage=jsonobj.Envelope.Body['return'].errormsg;scope.dosageResultSet.status='failed'}if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDosageCalcCombos()}try{if(scope.dosageResultSet.length===0&&jsonobj.Envelope.Body["return"].hasOwnProperty("showObsoleteMessage")){var val=jsonobj.Envelope.Body["return"]['showObsoleteMessage'];scope.showObsoleteMessage=val==="yes"?true:false}}catch(e){}scope.hideLoadingImage()})}else{var url='/mobiledoc/jsp/ecwrx/getCustomDoses.jsp?RxType='+RxType+'&itemid='+itemID+'&dnid='+drugNameID+'&trUserId='+global.TrUserId;var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDosageCalcCombos()}scope.hideLoadingImage()})}}};scope.getPriceFromCloud=function(drugName,facilityState,facilityCity,calledFrom){var url="/mobiledoc/jsp/webemr/progressnotes/ecwrx/currMedWeb/getCloudData.jsp?";var param='{"query":{"bool":{ "must":[ {"match":{"NPPES_PROVIDER_STATE":"'+facilityState.toUpperCase()+'"}}, {"match":{"DRUG_NAME":"'+drugName.toUpperCase()+'"}}, {"match":{"NPPES_PROVIDER_CITY":"'+facilityCity.toUpperCase()+'"}}]}},"aggs" : {"day_supply":{"sum" : { "field" : "TOTAL_DAY_SUPPLY"}},"Total_Cost":{"sum" :{"field" : "TOTAL_DRUG_COST"}}}}';$http.post(url,param).success(function(data){if(calledFrom=='Generic'){scope.genericPrice.totalDays=data.aggregations.day_supply.value;scope.genericPrice.totalCost=data.aggregations.Total_Cost.value;scope.genericPrice.costPerDay=scope.genericPrice.totalCost/scope.genericPrice.totalDays;scope.genericPrice.costPerDay=Math.round(scope.genericPrice.costPerDay*100)/100}else{scope.drugPrice.totalDays=data.aggregations.day_supply.value;scope.drugPrice.totalCost=data.aggregations.Total_Cost.value;scope.drugPrice.costPerDay=scope.drugPrice.totalCost/scope.drugPrice.totalDays;scope.drugPrice.costPerDay=Math.round(scope.drugPrice.costPerDay*100)/100}})};scope.containsInArray=function(obj,array){var isDuplicateOrder=false;for(var i=0;i<array.length;i++){if(obj==array[i]){isDuplicateOrder=true;break}}return isDuplicateOrder};var bSaveAsInventoryProduct=false;var bAlreadyCalledInventory=false;scope.isInventoryProduct=function(rxObject,index){if(bAlreadyCalledInventory)return true;if(rxObject.hasOwnProperty('InvProductId')&&rxObject.InvProductId>0&&scope.qosFilterObj.parentName!='currMed'){bootbox.confirm({buttons:{cancel:{label:'No',className:'btn btn-lblue btn-sm btn-xs pull-right  ml10'},confirm:{label:'Yes',className:'btn btn-lblue btn-sm btn-xs pull-right'}},message:" Select 'Yes' if you would like to prescribe this medication from the inventory otherwise select 'No'. ",title:'Warning',callback:function(result){if(result){bSaveAsInventoryProduct=true;bAlreadyCalledInventory=true;scope.saveRxData(rxObject,index)}else{bSaveAsInventoryProduct=false;bAlreadyCalledInventory=true;scope.saveRxData(rxObject,index)}}})}else{bAlreadyCalledInventory=true;scope.saveRxData(rxObject,index)}};scope.showInventory=function(itemid){var param="";param="itemid="+itemid;var url=makeURL("/mobiledoc/jsp/inventory/rxinventory.jsp?"+param);$("#invCont").attr("src",url);$('#invModal').modal()};scope.CloseInvModal=function(){$('#invModal').modal('hide')};scope.checkDuplicateRxFromMedRec=function(encounterId,selectedRxItemId,obj,event){$.ajax({url:"/mobiledoc/jsp/Orders/checkDuplicateRx.jsp",data:"encounterId="+encounterId+"&itemId="+selectedRxItemId,type:"POST",cache:false,success:function(status){isMedRecRxDuplicate=status.trim()===true||status.trim()==="true";isDuplicateCheck=true;scope.checkBeforeAddingRx(obj,event)},error:function(error){ecwAlert("Something went wrong in same Drug Class check.","","","","bluetheme")}})};var isDuplicateCheck=false;var isMedRecRxDuplicate=false;scope.checkBeforeAddingRx=function(obj,event){var duplicateCheckPassed=false;scope.getItemIdForDuplicateCheck();try{scope.isRxNameOnly()}catch(e){}if(scope.qosFilterObj.rxNameOnly&&typeof scope.qosFilterObj.itemid!='undefined'){var isDuplicateOrder=false;var itemID=[];if(typeof scope.qosFilterObj.itemid!=="number"&&scope.qosFilterObj.itemid.indexOf(",")>0){itemID=scope.qosFilterObj.itemid.split(",")}else{itemID.push(scope.qosFilterObj.itemid)}var itemId="";if(scope.favRxSelected){itemId=obj.itemID;isDuplicateOrder=scope.containsInArray(obj.itemID,itemID)}else{itemId=scope.qosResultObj.resultSet.nItemId;isDuplicateOrder=scope.containsInArray(scope.qosResultObj.resultSet.nItemId,itemID)}var rxParentName=scope.qosFilterObj.parentName;if(rxParentName==="RxHistory"||rxParentName==="ExtRxHistory"||rxParentName==="Unreconcile Meds"){if(!isDuplicateCheck){isDuplicateCheck=true;scope.checkDuplicateRxFromMedRec(scope.qosFilterObj.encounterID,itemId,obj,event);return}else if(!isMedRecRxDuplicate){$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).addClass('hide');if(scope.qosFilterObj.context==="FHIRTreatment"){scope.$parent.meic.FHIRIObjSelectedRxName=scope.qosResultObj.resultSet.sItemName}scope.setSearchResultObj();isDuplicateCheck=false;isMedRecRxDuplicate=false;return true}else{isDuplicateOrder=isMedRecRxDuplicate}}isDuplicateCheck=false;isMedRecRxDuplicate=false;if(isDuplicateOrder){var selectedRxName=scope.favRxSelected?obj.name:scope.qosResultObj.resultSet.sItemName;if(!scope.bOrderingRxMultipleTimes){var message="You cannot add "+selectedRxName+" since it is already added under Current Medications.";ecwAlert(message,"","","","bluetheme");duplicateCheckPassed=false;return}else{BootstrapDialog.show({title:'WARNING',message:escapeHtml(selectedRxName)+" is already in the list. Do you still want to add "+escapeHtml(selectedRxName)+"?",closable:true,draggable:true,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:'Yes',id:'btnDuplicatedDialogYes',action:function(dialog){duplicateCheckPassed=true;if(scope.favRxSelected){obj.bAddMultipleOrders=true;scope.selectDosage(obj)}else{scope.rowClicked(obj,event,true)}dialog.close()}},{label:'No',action:function(dialog){duplicateCheckPassed=false;dialog.close()}}]})}}else{duplicateCheckPassed=true}}else{duplicateCheckPassed=true}return duplicateCheckPassed};scope.doseListRequest={'itemId':0};scope.doseListRequest.encounterId=scope.qosFilterObj.encounterID;scope.doseListRequest.patientId=scope.qosFilterObj.patientId;scope.doseListRequest.context=scope.qosFilterObj.context;scope.drugDbDoseList=false;function generateRefreshId(existingRefreshId){var refreshId=existingRefreshId;while(refreshId===existingRefreshId){refreshId=Math.random()}return refreshId}scope.setDoseListRequest=function(orderItem){scope.isMSClinicalDoseWindow=true;scope.doseListRequest.doseRefreshId=generateRefreshId(scope.doseListRequest.doseRefreshId);scope.doseListRequest.dxId='0';scope.doseListRequest.itemId=orderItem.nItemId;scope.doseListRequest.drugNameId=orderItem.sDrugNameId;scope.doseListRequest.routedDrugId=orderItem.routedDrugId;scope.doseListRequest.dispensableDrugId=orderItem.dispensableDrugId;scope.doseListRequest.parentId=orderItem.nParentID;if(!angular.isUndefined(scope.formularyInfo.FormularyID)&&scope.formularyInfo.FormularyID!=""&&scope.formularyInfo.FormularySourceCode!==""){scope.doseListRequest.isformularyDoses=true;scope.doseListRequest.coverageId=scope.formularyInfo.CoverageId;scope.doseListRequest.formularyID=scope.formularyInfo.FormularyID;scope.doseListRequest.formularySourceCode=scope.formularyInfo.FormularySourceCode;scope.doseListRequest.NLRxBrand_FS=scope.loadFormularyInfo.NLRxBrand_FS;scope.doseListRequest.NLRxGenericOTC_FS=scope.loadFormularyInfo.NLRxGenericOTC_FS;scope.doseListRequest.NLRxGeneric_FS=scope.loadFormularyInfo.NLRxGeneric_FS}else{scope.doseListRequest.isformularyDoses=false}if(scope.RxDefaultDosesTypeId===2||scope.RxDefaultDosesTypeId==='2'){scope.doseListRequest.rxType=0}else{scope.doseListRequest.rxType=scope.RxDefaultDosesTypeId}scope.doseListRequest.encounterId=scope.qosFilterObj.encounterID;scope.doseListRequest.patientId=scope.qosFilterObj.patientId;scope.doseListRequest.itemName=orderItem.sItemName;scope.doseListRequest.showObsoleteDrugs=scope.showDiscontinuedDrugs===-1;scope.doseListRequest.showNoPackDrugs=false;if(scope.encfacilityId){scope.doseListRequest.facilityId=scope.encfacilityId}else{scope.doseListRequest.facilityId=0}if(scope.isRtbcServiceEnabled){scope.isMedMulEquiDrug=rtbcService.checkMedispanMultumEquipmentSupply(orderItem.nParentID)}scope.doseListRequest.isRtbcServiceEnabled=scope.isRtbcServiceEnabled;scope.doseListRequest.isMedMulEquiDrug=scope.isMedMulEquiDrug;scope.doseListRequest.rtbcEligibilityFlag=scope.rtbcEligibilityFlag;scope.doseListRequest.rtbcEligibilityErrMsg=scope.rtbcEligibilityErrMsg;scope.showHideLevel2Div()};scope.drugDbCallback=function(){scope.showHideLevel2Div('show');scope.hideLoadingImage()};scope.selectDoseCallback=function(obj){scope.dosageResultSet[0]=obj;scope.selectedRxName=obj.drugName;scope.selectedRxItemId=obj.ItemId;scope.selectedRxObject.nItemId=obj.ItemId;scope.selectedRxObject.nParentID=scope.qosResultObj.resultSet.nParentID;if(scope.qosFilterObj.parentName==='currMed'){scope.dosageResultSet[0].startDate=scope.dosageResultSet[0].startDateMMDDYYYY;scope.dosageResultSet[0].stopDate=scope.dosageResultSet[0].stopDateMMDDYYYY}if(obj.hasOwnProperty("isRtbcButtonClicked")&&obj.isRtbcButtonClicked===true)scope.selectDosage(0,true);else scope.selectDosage(0)};scope.selectEpaCallback=function(obj){scope.dosageResultSet[0]=obj;scope.selectedRxName=obj.drugName;scope.selectedRxItemId=obj.ItemId;scope.selectedRxObject.nItemId=obj.ItemId;scope.selectedRxObject.nParentID=scope.qosResultObj.resultSet.nParentID;scope.ePAClicked(0)};scope.showHideLevel2Div=function(sRequestType){$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).addClass('hide');$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).removeClass('hide')};scope.dosageResultSet=[];scope.isValidForMSClinical=function(nParentID){if(scope.b_DrugDbEnabled==='yes'&&(parseInt(nParentID,10)===parseInt(scope.MedispanId,10)||parseInt(nParentID,10)===parseInt(scope.CustomRxId,10)))return true;return false};function getItemNameByRoutedOrDispensableDrugId(urlPrefix,routedOrDispensableDrugId,obj,event,bAddMultipleOrders,isFav,item){var url='/mobiledoc/cpoe/medicationItem/'+urlPrefix+'/'+routedOrDispensableDrugId;url=makeURL(url);let promise=$http({method:'GET',url:url,"async":false,headers:{'Content-Type':'application/x-www-form-urlencoded'}});promise.then(function(response){processRowCliked(response.data,obj,event,bAddMultipleOrders,isFav,item)})}scope.rowClicked=function(obj,event,bAddMultipleOrders,isFav,item){if(scope.initialPatientId!==scope.qosFilterObj.patientId){scope.loadPatientVitals(scope.qosFilterObj.encounterID,scope.qosFilterObj.patientId)}var sId=event.target.id;if(typeof sId!='undefined'){if(sId.indexOf('favIcon')!=-1){scope.favClicked(obj,event)}else{if(isFav==undefined){isFav=false}var index=scope.filterObj.start+obj;if(scope.qosFilterObj.parentName=='TelEncounter'||scope.qosFilterObj.parentName==='OrderRxWidget'){if(scope.qosFilterObj.encounterID==0){scope.getEncounterId()}if(scope.qosFilterObj.encounterID>0){scope.getRxandDx(scope.qosFilterObj.encounterID,scope.qosFilterObj.patientId,0,global.TrUserId)}}scope.genericEquivalent=[];scope.genericPrice={};scope.drugPrice={};if(typeof scope.qosResultObj==='undefined'){scope.qosResultObj={resultSet:""}}if(isFav==false){if(index>=0){scope.qosResultObj.resultSet=scope.searchResult[index]}else{scope.qosResultObj.resultSet=obj}}else{scope.qosResultObj.resultSet=item}if(scope.isValidForMSClinical(scope.qosResultObj.resultSet.nParentID)){processForMSClinical(obj,event,bAddMultipleOrders,isFav,item);return}scope.isMSClinicalDoseWindow=false;processRowCliked(null,obj,event,bAddMultipleOrders,isFav,item)}}};function processForMSClinical(obj,event,bAddMultipleOrders,isFav,item){if(scope.qosResultObj&&scope.qosResultObj.resultSet&&checkIsValidForAllergyVerification(scope.qosResultObj.resultSet.sKeyname)&&checkAllergyVerifiedFlag){scope.checkAllergyVerified(scope.qosFilterObj.encounterID,CALLED_FROM_PROCESS_MS_CLINICAL,obj,event,bAddMultipleOrders,isFav,item);return}checkAllergyVerifiedFlag=true;scope.isRxNameOnly();if((scope.qosFilterObj.parentName=='currMed'||scope.qosFilterObj.parentName=='RxHistory'||scope.qosFilterObj.parentName=='ExtRxHistory'||scope.qosFilterObj.parentName=="Unreconcile Meds"||scope.qosFilterObj.parentName==='OrderRxWidgetUpdateRx')&&!bAddMultipleOrders){var duplicateCheck=scope.checkBeforeAddingRx(obj,event);if(!duplicateCheck){return}}if(scope.qosFilterObj.rxNameOnly===true){if(scope.qsFilterObj.RxDrugSearchType==='1'||scope.qsFilterObj.RxDrugSearchType===1){getItemNameByRoutedOrDispensableDrugId("getItemByRoutedDrugId",scope.qosResultObj.resultSet.routedDrugId,obj,event,bAddMultipleOrders,isFav,item)}else if(scope.qsFilterObj.RxDrugSearchType==='2'||scope.qsFilterObj.RxDrugSearchType===2){getItemNameByRoutedOrDispensableDrugId("getItemByDispensableDrugId",scope.qosResultObj.resultSet.dispensableDrugId,obj,event,bAddMultipleOrders,isFav,item)}}else{scope.setDoseListRequest(scope.qosResultObj.resultSet)}}function processRxFlow(itemObj,obj,event,bAddMultipleOrders,isFav,item){scope.isRxEligibilitySuccessful=false;$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).addClass('hide');$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).removeClass('hide');if(getItemKeyValue("EnableRxPricing")=="yes"){try{scope.getPriceFromCloud(scope.qosResultObj.resultSet.sItemName,getItemKeyValue("RxPricingState").toUpperCase(),getItemKeyValue("RxPricingCity").toUpperCase(),"normal drug")}catch(e){}}var sSynonymId="";if(scope.b_MedispanEnabled=="no"){sSynonymId=scope.qosResultObj.resultSet.sSupplierId}else{sSynonymId=scope.qosResultObj.resultSet.sDrugNameId}if(typeof scope.formularyInfo.FormularyID!="undefined"&&scope.formularyInfo.FormularyID!=""){if(sSynonymId>0&&scope.formularyInfo.FormularySourceCode!=""){scope.loadFormularyRxDoses(sSynonymId,scope.qosResultObj.resultSet.nItemId,2)}else{scope.getDosage(scope.qosResultObj.resultSet.sDrugNameId,scope.qosResultObj.resultSet.nItemId,scope.RxDefaultDosesTypeId)}}else{scope.getDosage(scope.qosResultObj.resultSet.sDrugNameId,scope.qosResultObj.resultSet.nItemId,scope.RxDefaultDosesTypeId)}var url='/mobiledoc/jsp/ecwrx/getGenericdrugs.jsp?dnid='+sSynonymId;if(scope.bDispenseInventoryLinkEnabled){url=url+"&facilityID="+global.facilityId}var promise=$http.post(makeURL(url));promise.success(function(data){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('AlternateDrugs')){if(jsonobj.Envelope.Body['return'].AlternateDrugs.length>0){scope.genericEquivalent=jsonobj.Envelope.Body['return'].AlternateDrugs}else{scope.genericEquivalent.push(jsonobj.Envelope.Body['return'].AlternateDrugs)}}if(scope.genericEquivalent[0].drugName.length>0){if(getItemKeyValue("EnableRxPricing")=="yes"){try{scope.getPriceFromCloud(scope.genericEquivalent[0].drugName,getItemKeyValue("RxPricingState").toUpperCase(),getItemKeyValue("RxPricingCity").toUpperCase(),"Generic")}catch(e){}}}}})}function processRowCliked(itemObj,obj,event,bAddMultipleOrders,isFav,item){if(scope.qosResultObj&&scope.qosResultObj.resultSet&&checkIsValidForAllergyVerification(scope.qosResultObj.resultSet.sKeyname)&&checkAllergyVerifiedFlag){scope.checkAllergyVerified(scope.qosFilterObj.encounterID,CALLED_FROM_PROCESS_RX_FLOW,obj,event,bAddMultipleOrders,isFav,item);return}checkAllergyVerifiedFlag=true;if(itemObj!==null&&angular.isDefined(itemObj)){scope.selectedRxItemId=itemObj.itemId;scope.qosResultObj.resultSet.nItemId=itemObj.itemId;scope.selectedRxName=itemObj.itemName;scope.qosResultObj.resultSet.sItemName=itemObj.itemName;scope.selectedRxDrugNameId=itemObj.drugNameId;scope.qosResultObj.resultSet.sDrugNameId=itemObj.drugNameId;scope.qosResultObj.resultSet.dispensableDrugId=0;scope.qosResultObj.resultSet.routedDrugId=0}else{scope.selectedRxDrugNameId=scope.qosResultObj.resultSet.sDrugNameId;scope.selectedRxItemId=scope.qosResultObj.resultSet.nItemId;scope.selectedRxName=scope.qosResultObj.resultSet.sItemName}scope.selectedRxObject=scope.qosResultObj.resultSet;if((scope.qosFilterObj.parentName=='currMed'||scope.qosFilterObj.parentName=='RxHistory'||scope.qosFilterObj.parentName=='ExtRxHistory'||scope.qosFilterObj.parentName=="Unreconcile Meds"||scope.qosFilterObj.parentName==='OrderRxWidgetUpdateRx')&&!bAddMultipleOrders){var duplicateCheck=scope.checkBeforeAddingRx(obj,event);if(!duplicateCheck){return}}if(scope.qosFilterObj.parentName=='currMed'||scope.qosFilterObj.parentName=='RxHistory'||scope.qosFilterObj.parentName=='ExtRxHistory'||scope.qosFilterObj.parentName=="Unreconcile Meds"||scope.qosFilterObj.parentName==='RegistryRxTab'){scope.isRxNameOnly();if(scope.qosFilterObj.rxNameOnly){$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).addClass('hide');scope.setSearchResultObjWrapperCall();return true}}if(scope.qosFilterObj.parentName=='RxHistory'||scope.qosFilterObj.parentName=='ExtRxHistory'||scope.qosFilterObj.parentName=="Unreconcile Meds"){scope.isRxNameOnly();if(scope.qosFilterObj.rxNameOnly){scope.dosageResultSet=[{strength:"",formulation:"",route:"",take:"",freq:"",duration:"",dispense:"",refills:"",ndc:"",controlledCode:"",controlled:"",IsRxSupplies:"",favorite:"",awup:"",MMDCode:""}];scope.selectDosage(0);return true}}$("#searchBox"+scope.topClass).trigger("select");if(scope.qosResultObj.resultSet.sKeyname.toUpperCase()==='RXMEDISPAN'||scope.qosResultObj.resultSet.sKeyname.toUpperCase()==='RX'){processRxFlow(itemObj,obj,event,bAddMultipleOrders,isFav,item)}else if(scope.qosResultObj.resultSet.sKeyname.toUpperCase()==='LABREPORTS'){scope.saveLabsImaging(scope.qosResultObj.resultSet)}else if(scope.qosResultObj.resultSet.sKeyname.toUpperCase()==='XRAYS'){scope.saveLabsImaging(scope.qosResultObj.resultSet)}else if(scope.qosResultObj.resultSet.sKeyname.toUpperCase()==='PROCEDURES'){}}var checkAllergyVerifiedFlag=true;var isAllergyVerified=false;var CALLED_FROM_SELECT_DOSAGE='SelectDosage';var CALLED_FROM_PROCESS_RX_FLOW='processRxFlow';var CALLED_FROM_PROCESS_MS_CLINICAL='processForMSClinical';scope.checkAllergyVerified=function(encId,calledFrom,obj,event,bAddMultipleOrders,isFav,item){if(isAllergyVerified){callBackForAllergyVerification(calledFrom,obj,event,bAddMultipleOrders,isFav,item);return}var url='/mobiledoc/emr/medication/checkAllergyStatus?encounterId='+encId;url=makeURL(url);$http({method:'POST',url:url,headers:{'Content-Type':'application/json'},data:{}}).then(function(data){if(checkUndefinedOrNullOrBlank(data.data.AllergiesFlag,true)||data.data.AllergiesFlag.toUpperCase()!=='Y'){if(!checkUndefinedOrNullOrBlank(data.data.isASC,true)&&data.data.isASC.toLowerCase()==='true'){showIPMessage("<div class='text-left mt-24'><br/><b>Ordering Medications - Verify Allergies</b></br></br>Allergies have not been verified. Allergies must be verified prior to ordering medications.</div>",'','ErrorMsg','','','true')}else{showAlertMessage("<div class='text-left mt-24'><b>Ordering Medications - Verify Allergies</b><br/></br>Allergies have not been verified. Allergies must be verified prior to ordering medications.</div>",'','ErrorMsg')}return}isAllergyVerified=true;callBackForAllergyVerification(calledFrom,obj,event,bAddMultipleOrders,isFav,item)})};function checkIsValidForAllergyVerification(keyName){if(checkUndefinedOrNullOrBlank(keyName,true)){return false}if(keyName.toLowerCase()!=='rx'&&keyName.toLowerCase()!=='rxmedispan'){return false}if((scope.qosFilterObj.context&&(scope.qosFilterObj.context==='ascDischarge'||scope.qosFilterObj.context==='anesthesia-io')||scope.isCalledFrom&&scope.isCalledFrom==='anesthesia-meds')&&getItemKeyValue("EnablePriorAllergyVerificationASC").toUpperCase()==="YES"){return true}return false}function callBackForAllergyVerification(calledFrom,obj,event,bAddMultipleOrders,isFav,item){checkAllergyVerifiedFlag=false;if(calledFrom===CALLED_FROM_SELECT_DOSAGE){scope.selectDosage(obj)}if(calledFrom===CALLED_FROM_PROCESS_RX_FLOW){scope.rowClicked(obj,event,bAddMultipleOrders,isFav,item)}if(calledFrom===CALLED_FROM_PROCESS_MS_CLINICAL){processForMSClinical(obj,event,bAddMultipleOrders,isFav,item)}}scope.favClicked=function(obj,event){var index=scope.filterObj.start+obj;var sId=event.target.id;if(typeof sId!='undefined'){if(sId.indexOf('favIcon')!=-1){scope.updateFavoriteStatusForItem(index)}}};scope.updateFavoriteStatusForItem=function(index){var sId="favIcon-"+scope.searchResult[index].nItemId;var className=$('#'+sId).attr("class");if(className.indexOf("active")>-1){scope.searchResult[index].nFavoriteFlag=0}else{scope.searchResult[index].nFavoriteFlag=1}scope.searchResult[index].nTrUserId=global.TrUserId;var sRequestType="setFavoriteFlag";var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?ItemJsonObj="+encodeURIComponent(JSON.stringify(scope.searchResult[index]))+"&sRequestFrom=qsDirective"+"&sRequestType="+sRequestType+"&rnd2="+Math.random();if(scope.bDispenseInventoryLinkEnabled&&scope.qosFilterObj.parentName!="currMed"){strUrl=strUrl+"&facilityID="+scope.encfacilityId}var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data,status,headers,config){})};scope.saveLabsImaging=function(orderItems){var sRequestFrom="webEMRQuickOrder";orderItems.nEncounterId=scope.qosFilterObj.encounterID;orderItems.nTrUserId=global.TrUserId;orderItems.nPatientId=scope.qosFilterObj.patientID;orderItems.sDxCode=0;orderItems.nDxId=0;if(scope.qosFilterObj.labConfig==='yes'){scope.$parent.getLabsDIName(orderItems)}else{var strUrl="/mobiledoc/jsp/Orders/SaveQuickOrders.jsp?orderDetailsObject="+JSON.stringify(orderItems)+"&requestFrom="+sRequestFrom+"&rnd2="+Math.random();var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data,status,headers,config){var oRetObj={};var x2js=new X2JS;var jsonData=x2js.xml_str2json(data.trim());if(jsonData!=null&&jsonData!=undefined&&jsonData.Envelope.Body['return'].status!=undefined){var sStatus="";var disMessage="";oRetObj=returnDataArray(jsonData.Envelope.Body['return']);oRetObj=oRetObj[0];sStatus=angular.lowercase(trimContent(oRetObj.status));if(sStatus=='success'||sStatus=='failed'){if(sStatus=='success'){if(orderItems.sKeyname=='labreports'||orderItems.sKeyname=='xrays'||orderItems.sKeyname=='procedures'){if(typeof oRetObj.LabDIExits!='undefined'&&"yes"==oRetObj.LabDIExits){disMessage="Order: "+orderItems.sItemName+" - already exists.";scope.$parent.showSaveMessage(disMessage)}else{disMessage="Order: "+orderItems.sItemName+" - saved successfully.";scope.$parent.showSaveMessage(disMessage);scope.$parent.loadLabsDIData('editMode');scope.$parent.loadModernLabData('editMode')}}}else if(sStatus=='failed'){disMessage="Order failed.";scope.$parent.showSaveMessage(disMessage)}}}})}};scope.adjustRxFilterPosition=function(){let classNameForRxFilter=scope.qosFilterObj.parentName==='currMed'?"pull-left":"pull-right";if(scope.qosFilterObj.parentName==='TelEncounter'&&screen.availHeight<=728){classNameForRxFilter+=" leftAlignRxFilter"}return classNameForRxFilter};scope.rxEditClicked=function(index){var rxObj=scope.dosageResultSet[index];if(scope.b_MedispanEnabled==="no"&&!angular.equals(scope.formularyInfo,{})&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&rxObj.itemid!==undefined)rxObj.ItemId=rxObj.itemid;else rxObj.ItemId=scope.qosResultObj.resultSet.nItemId;if(scope.b_MedispanEnabled=="no"){rxObj.DrugNameId=scope.qosResultObj.resultSet.sSupplierId}else{rxObj.DrugNameId=scope.qosResultObj.resultSet.sDrugNameId}rxObj.assessId=0;if(scope.b_MedispanEnabled==="no"&&!angular.equals(scope.formularyInfo,{})&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&rxObj.brand_description!==undefined&&rxObj.brand_description.length>0)rxObj.sItemName=rxObj.brand_description;else rxObj.sItemName=scope.qosResultObj.resultSet.sItemName;if(typeof scope.qosResultObj.resultSet.isCompound!=='undefined'&&scope.qosResultObj.resultSet.isCompound==='true'){rxObj.CompoundIngredients=scope.qosResultObj.resultSet.CompoundIngredients}rxObj.telEncDate='';if(scope.qosFilterObj.parentName==="TelEncounter"&&scope.encdateAddRx){rxObj.telEncDate=scope.encdateAddRx}if(scope.qosFilterObj.parentName==="TelEncounter"){rxObj.isTelephonicEncounter=true}rxObj.isRTBCFeatureEnabled=scope.rtbcEligibilityFlag&&scope.isMedMulEquiDrug;rxObj.context=scope.qosFilterObj.context;if(getItemKeyValue("EnableNewRxEditScreen").toLowerCase()==="yes"||getItemKeyValue("EnableMSClinical").toLowerCase()==="yes"){rxObj.formularyInfo=scope.formularyInfo;rxObj.encFacilityId=scope.encfacilityId;rxObj.dosageResultSet=scope.dosageResultSet;$ocLazyLoad.load({name:'RxEditModule',files:['/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js','/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEdit/js/RxEditController.js','/mobiledoc/jsp/resources/jslib/angular-perfect-scrollbar/src/angular-perfect-scrollbar.min.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEdit/rx-editmodal.html'),controller:'RxEditCtrl',windowClass:'rxeditscreen bluetheme rx-topmargin',backdrop:"static",keyboard:false,resolve:{patientID:function(){return scope.qosFilterObj.patientId},encounterID:function(){return scope.qosFilterObj.encounterID},RxEditObject:function(){return rxObj},loginuserid:function(){return global.TrUserId},parentName:function(){if(scope.qosFilterObj.parentName==="OrderRxWidget")return"OrderRxWidgetSend";else if(scope.qosFilterObj.parentName!="TelEncounter"&&scope.qosFilterObj.parentName!="Refill Request")return"currMed";else if(scope.qosFilterObj.parentName=="Refill Request")return"RxQuickSearchRefillRequest";else return"RxQuickSearch"}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){rxObj.formularyInfo={};rxObj.encFacilityId="";rxObj.dosageResultSet=[];if(modalInstanceResponse!=="close"&&typeof modalInstanceResponse==='object'){$("#searchBox"+scope.topClass).trigger("select");if(scope.qosFilterObj.parentName==="TelEncounter"||scope.qosFilterObj.parentName==="RxHistory"||scope.qosFilterObj.parentName==="ExtRxHistory"||scope.qosFilterObj.parentName==="Unreconcile Meds"||scope.qosFilterObj.parentName==="currMed"){scope.dosageResultSet[index].dispense=modalInstanceResponse.dispense;scope.dosageResultSet[index].duration=modalInstanceResponse.duration;scope.dosageResultSet[index].formulation=modalInstanceResponse.formulation;scope.dosageResultSet[index].freq=modalInstanceResponse.freq;scope.dosageResultSet[index].ndc=modalInstanceResponse.ndc;scope.dosageResultSet[index].refills=modalInstanceResponse.refills;scope.dosageResultSet[index].route=modalInstanceResponse.route;scope.dosageResultSet[index].strength=modalInstanceResponse.strength;scope.dosageResultSet[index].take=modalInstanceResponse.take;scope.dosageResultSet[index].RxEditNotesValue=modalInstanceResponse.RxEditNotesValue;scope.dosageResultSet[index].RxSource=modalInstanceResponse.RxSource;scope.dosageResultSet[index].RxSourceID=modalInstanceResponse.RxSourceID;scope.dosageResultSet[index].isStopDateBlankFromRxEdit=true;if(scope.qosFilterObj.parentName==="currMed"){scope.dosageResultSet[index].startDate=modalInstanceResponse.startDateMMDDYYYY;scope.dosageResultSet[index].stopDate=modalInstanceResponse.stopDateMMDDYYYY}else{scope.dosageResultSet[index].startDate=modalInstanceResponse.startDate;scope.dosageResultSet[index].stopDate=modalInstanceResponse.stopDate;if(modalInstanceResponse.stopDate){scope.dosageResultSet[index].isStopDateBlankFromRxEdit=false}}scope.dosageResultSet[index].daw=modalInstanceResponse.daw;scope.dosageResultSet[index].AddInstructions=modalInstanceResponse.AddInstructions;scope.dosageResultSet[index].RxAdditionalNotes=modalInstanceResponse.RxAdditionalNotes;scope.dosageResultSet[index].PharmacyNCPDPId=modalInstanceResponse.PharmacyNCPDPId;scope.dosageResultSet[index].pharmacyId=modalInstanceResponse.pharmacyId;scope.dosageResultSet[index].assessId=modalInstanceResponse.assessId;scope.nSelectedAssessmentId=modalInstanceResponse.assessId;scope.dosageResultSet[index].isSplitPharmacy=modalInstanceResponse.isSplitPharmacy;if(modalInstanceResponse.isSplitPharmacy){scope.dosageResultSet[index].splitRx=modalInstanceResponse.splitRx}if(modalInstanceResponse.ePARequestFromRxEdit){scope.dosageResultSet[index].ePARequestFromRxEdit=modalInstanceResponse.ePARequestFromRxEdit;scope.dosageResultSet[index].ePARxName=modalInstanceResponse.ePARxName;scope.dosageResultSet[index].ItemId=modalInstanceResponse.ItemId;scope.dosageResultSet[index].awup=modalInstanceResponse.awup;scope.dosageResultSet[index].description=modalInstanceResponse.description;scope.dosageResultSet[index].BrandDesc=modalInstanceResponse.BrandDesc;scope.dosageResultSet[index].brand_description=modalInstanceResponse.brand_description;scope.dosageResultSet[index].drugName=modalInstanceResponse.drugName;scope.dosageResultSet[index].dxArray=modalInstanceResponse.dxArray;scope.ePAClicked(index);return}else{scope.selectDosage(index);scope.setDosageCalcCombos()}}else{scope.qosResultObj.resultSet.strength=modalInstanceResponse.strength;scope.qosResultObj.resultSet.formulation=modalInstanceResponse.formulation;scope.qosResultObj.resultSet.take=modalInstanceResponse.take;scope.qosResultObj.resultSet.route=modalInstanceResponse.route;scope.qosResultObj.resultSet.freq=modalInstanceResponse.freq;scope.qosResultObj.resultSet.duration=modalInstanceResponse.duration;scope.qosResultObj.resultSet.dispense=modalInstanceResponse.dispense;scope.qosResultObj.resultSet.refills=modalInstanceResponse.refills;scope.qosResultObj.resultSet.ndc=modalInstanceResponse.ndc;scope.qosResultObj.resultSet.controlledCode=scope.dosageResultSet[index].controlledCode;scope.qosResultObj.resultSet.controlled=scope.dosageResultSet[index].controlled;scope.qosResultObj.resultSet.IsRxSupplies=scope.dosageResultSet[index].IsRxSupplies;scope.qosResultObj.resultSet.favorite=scope.dosageResultSet[index].favorite;scope.qosResultObj.resultSet.awup=scope.dosageResultSet[index].awup;scope.qosResultObj.resultSet.rxSource=modalInstanceResponse.RxSource;scope.qosResultObj.resultSet.rxSourceID=modalInstanceResponse.RxSourceID;scope.qosResultObj.resultSet.NotesValue=modalInstanceResponse.RxAdditionalNotes;scope.qosResultObj.resultSet.startDate=modalInstanceResponse.startDate;scope.qosResultObj.resultSet.stopDate=modalInstanceResponse.stopDate;scope.qosResultObj.resultSet.daw=modalInstanceResponse.daw;scope.qosResultObj.resultSet.AddInstructions=modalInstanceResponse.AddInstructions;scope.qosResultObj.resultSet.RxAdditionalNotes=modalInstanceResponse.RxAdditionalNotes;scope.qosResultObj.resultSet.PharmacyNCPDPId=modalInstanceResponse.PharmacyNCPDPId;scope.qosResultObj.resultSet.pharmacyId=modalInstanceResponse.pharmacyId;if(scope.b_MedispanEnabled==="yes")scope.qosResultObj.resultSet.MMDCode=scope.dosageResultSet[index].MMDCode;$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).addClass('hide');$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).addClass('hide');if(scope.qosFilterObj.parentName==="Refill Request"){scope.qosResultObj.resultSet.drugName=modalInstanceResponse.drugName;scope.qosResultObj.resultSet.ItemId=modalInstanceResponse.ItemId;scope.CheckAllergyInteraction(scope.qosResultObj.resultSet)}else{if(scope.qosFilterObj.context==="FHIRTreatment"){scope.$parent.meic.FHIRIObjSelectedRxName=scope.qosResultObj.resultSet.sItemName}scope.setSearchResultObjWrapperCall()}}}})})}else{$ocLazyLoad.load({name:'RxEditModule',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEditHelper.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/RxEdit.jsp'),controller:'RxEditCtrl',windowClass:'app-modal-window1',backdrop:"static",keyboard:false,resolve:{patientID:function(){return scope.qosFilterObj.patientId},encounterID:function(){return scope.qosFilterObj.encounterID},RxEditObject:function(){return rxObj},loginuserid:function(){return global.TrUserId},parentName:function(){if(scope.qosFilterObj.parentName!=="TelEncounter"&&scope.qosFilterObj.parentName!=="Refill Request")return"currMed";else if(scope.qosFilterObj.parentName==="Refill Request")return"RxQuickSearchRefillRequest";else return"RxQuickSearch"}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){if(modalInstanceResponse!=="close"){$("#searchBox"+scope.topClass).trigger("select");if(scope.qosFilterObj.parentName==="TelEncounter"||scope.qosFilterObj.parentName==="RxHistory"||scope.qosFilterObj.parentName==="ExtRxHistory"||scope.qosFilterObj.parentName==="Unreconcile Meds"||scope.qosFilterObj.parentName==="currMed"){var fromTelEnc=scope.qosFilterObj.parentName==="TelEncounter";scope.dosageResultSet[index].dispense=fromTelEnc?modalInstanceResponse.dispense:modalInstanceResponse.DispenseValue;scope.dosageResultSet[index].duration=fromTelEnc?modalInstanceResponse.duration:modalInstanceResponse.DurationValue;scope.dosageResultSet[index].formulation=fromTelEnc?modalInstanceResponse.formulation:modalInstanceResponse.FormulationValue;scope.dosageResultSet[index].freq=fromTelEnc?modalInstanceResponse.freq:modalInstanceResponse.FrequencyValue;scope.dosageResultSet[index].ndc=fromTelEnc?modalInstanceResponse.ndc:modalInstanceResponse.ndcCode;scope.dosageResultSet[index].refills=fromTelEnc?modalInstanceResponse.refills:modalInstanceResponse.RefillsValue;scope.dosageResultSet[index].route=fromTelEnc?modalInstanceResponse.route:modalInstanceResponse.RouteValue;scope.dosageResultSet[index].strength=fromTelEnc?modalInstanceResponse.strength:modalInstanceResponse.StrengthValue;scope.dosageResultSet[index].take=fromTelEnc?modalInstanceResponse.take:modalInstanceResponse.TakeValue;scope.dosageResultSet[index].RxEditNotesValue=fromTelEnc?modalInstanceResponse.RxEditNotesValue:modalInstanceResponse.NotesValue;scope.dosageResultSet[index].RxSource=fromTelEnc?modalInstanceResponse.RxSource:modalInstanceResponse.RxSource;scope.dosageResultSet[index].RxSourceID=fromTelEnc?modalInstanceResponse.RxSourceID:modalInstanceResponse.RxSourceID;scope.dosageResultSet[index].startDate=fromTelEnc?modalInstanceResponse.startDate:modalInstanceResponse.StartDate;scope.dosageResultSet[index].stopDate=fromTelEnc?modalInstanceResponse.stopDate:modalInstanceResponse.StopDate;scope.selectDosage(index);scope.setDosageCalcCombos()}else{scope.qosResultObj.resultSet.strength=modalInstanceResponse.StrengthValue;scope.qosResultObj.resultSet.formulation=modalInstanceResponse.FormulationValue;scope.qosResultObj.resultSet.route=modalInstanceResponse.RouteValue;scope.qosResultObj.resultSet.take=modalInstanceResponse.TakeValue;scope.qosResultObj.resultSet.freq=modalInstanceResponse.FrequencyValue;scope.qosResultObj.resultSet.duration=modalInstanceResponse.DurationValue;scope.qosResultObj.resultSet.dispense=modalInstanceResponse.DispenseValue;scope.qosResultObj.resultSet.refills=modalInstanceResponse.RefillsValue;scope.qosResultObj.resultSet.ndc=modalInstanceResponse.ndcCode;scope.qosResultObj.resultSet.controlledCode=scope.dosageResultSet[index].controlledCode;scope.qosResultObj.resultSet.controlled=scope.dosageResultSet[index].controlled;scope.qosResultObj.resultSet.IsRxSupplies=scope.dosageResultSet[index].IsRxSupplies;scope.qosResultObj.resultSet.favorite=scope.dosageResultSet[index].favorite;scope.qosResultObj.resultSet.awup=scope.dosageResultSet[index].awup;scope.qosResultObj.resultSet.rxSource=modalInstanceResponse.RxSource;scope.qosResultObj.resultSet.rxSourceID=modalInstanceResponse.RxSourceID;scope.qosResultObj.resultSet.NotesValue=modalInstanceResponse.NotesValue;scope.qosResultObj.resultSet.startDate=modalInstanceResponse.StartDate;scope.qosResultObj.resultSet.stopDate=modalInstanceResponse.StopDate;scope.qosResultObj.resultSet.isStopDateBlankFromRxEdit=true;if(modalInstanceResponse.StopDate){scope.qosResultObj.resultSet.isStopDateBlankFromRxEdit=false}if(scope.b_MedispanEnabled==="yes")scope.qosResultObj.resultSet.MMDCode=scope.dosageResultSet[index].MMDCode;$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).addClass('hide');$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).addClass('hide');if(scope.qosFilterObj.parentName==="Refill Request"){scope.qosResultObj.resultSet.drugName=scope.dosageResultSet[index].drugName;scope.qosResultObj.resultSet.ItemId=scope.dosageResultSet[index].ItemId;scope.CheckAllergyInteraction(scope.qosResultObj.resultSet)}else{if(scope.qosFilterObj.context==="FHIRTreatment"){scope.$parent.meic.FHIRIObjSelectedRxName=scope.qosResultObj.resultSet.sItemName}scope.setSearchResultObjWrapperCall()}}}else{$('.quick-menu-MedRec > div').removeClass('hide')}})})}};scope.showLoadingImage=function(){document.getElementById("divDrugDosageLoading").style.display=""};scope.hideLoadingImage=function(){document.getElementById("divDrugDosageLoading").style.display="none";$(window).trigger("resize")};scope.selectGeneric=function($event,item){var sSynonymId="";scope.qosResultObj.resultSet.sDrugNameId=item.DrugId;scope.qosResultObj.resultSet.sSupplierId=item.DrugId;scope.qosResultObj.resultSet.nItemId=item.ItemId;if(scope.b_MedispanEnabled==="no")scope.qosResultObj.resultSet.sItemName=item.drugName;else scope.qosResultObj.resultSet.sItemName=item.itemName;scope.rowClicked(scope.qosResultObj.resultSet,$event);$('#searchBox'+scope.topClass).val(scope.qosResultObj.resultSet.sItemName);scope.genericEquivalent=[];$event.stopPropagation()};var bAlreadyCalled=false;scope.IsMedOrderingForPastVist=function(obj){var bIsMedOrderingForPastVist=false;var encounterDateofPN;var todayDate;try{if(scope.qosFilterObj&&trimContent(scope.qosFilterObj.encDateTime)!==''){encounterDateofPN=new Date(scope.qosFilterObj.encDateTime)}else{encounterDateofPN=new Date(validateAndConvertDate(scope.encdateAddRx));if(scope.enctimeAddRx!==undefined&&scope.enctimeAddRx!==""){var timeUnits=[];timeUnits=scope.enctimeAddRx.split(":");encounterDateofPN.setHours(timeUnits[0]);encounterDateofPN.setMinutes(timeUnits[1]);encounterDateofPN.setSeconds(timeUnits[2])}}todayDate=new Date;todayDate.setHours(0);todayDate.setMinutes(0);todayDate.setSeconds(0)}catch(e){encounterDateofPN=new Date(scope.encdateAddRx);encounterDateofPN=encounterDateofPN.toUTCString();todayDate=new Date;todayDate=todayDate.toUTCString()}if(scope.ShowMessageForPastVisitItemKey.toLowerCase()=="yes"&&!scope.selectedRxObject.isCallFromePA){if(todayDate>encounterDateofPN){if(bAlreadyCalled)return true;var angularComponentID="searchBoxMQSD_TopClass";if(scope.qosFilterObj.parentName==="currMed"||scope.qosFilterObj.parentName==="RxHistory"||scope.qosFilterObj.parentName==="ExtRxHistory"||scope.qosFilterObj.parentName==="Unreconcile Meds")angularComponentID="searchBoxcurrMed_MQSD_TopClass";var warningMsg="<b>Warning  Adding Medications to Past Encounter</b></br></br>Medications added to past encounters may not reflect in the active medication list or the ICW (Right Chart Panel) and may need to be reconciled in subsequent encounters. Interaction checks will only consider medications from this encounter and Medications as of Today on the ICW. Would you like to proceed with ordering this medication?";showAlertMessage(warningMsg,'','ConfirmMsg','showMsgForPastVisitConfirm',angularComponentID);scope.showMsgForPastVisitConfirm=function(btnAction){if(!angular.isUndefined(btnAction)&&btnAction!==null&&btnAction.toLowerCase()==='yes'){bAlreadyCalled=true;scope.selectDosage(obj);bIsMedOrderingForPastVist=true}}}else{bIsMedOrderingForPastVist=true}}else{bIsMedOrderingForPastVist=true}return bIsMedOrderingForPastVist};scope.getRxandDx=function(encid,ptId,DxId,trUserId,obj){scope.OrdersForEnc=[];var promisegetRxandDx=rxService.getRxandDxinRxService(encid,ptId,trUserId);promisegetRxandDx.then(function(payload){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(payload.data.trim());if(typeof jsonobj!="undefined"&&jsonobj!=null&&jsonobj.Envelope.Body['return'].hasOwnProperty("Dx")){if(jsonobj.Envelope.Body['return'].Dx.length>0){scope.OrdersForEnc=jsonobj.Envelope.Body['return'].Dx}else{scope.OrdersForEnc.push(jsonobj.Envelope.Body['return'].Dx);if(typeof scope.OrdersForEnc[0].Rx=="object"){}}}try{if(typeof scope.OrdersForEnc!="undefined"&&scope.OrdersForEnc!=null){for(var i=0;i<scope.OrdersForEnc.length;i++){if(scope.OrdersForEnc[i].hasOwnProperty("Rx")){scope.m_bFirstRx=false;break}}}}catch(e){}if(scope.favRxSelected){if(obj!=undefined){obj.rxRefreshed=true;scope.selectDosage(obj)}}},function(error){})};scope.$on('saveRxNow',function(e,obj){if((obj.bSaveSelectedRx===true||obj.bSaveSelectedRx==="true")&&scope.qosFilterObj.hasOwnProperty("parentName")&&obj.parentName===scope.qosFilterObj.parentName){if(obj.ePAFlag){scope.openEPAInitializePopup()}else{scope.saveRxFromQuickSearch()}}else{scope.selectedRxObject={}}if(scope.selectedRxObject){scope.selectedRxObject.isCallFromePA=false;scope.selectedRxObject.ePARequestFromRxEdit=false}});scope.formObjectForFavourateRx=function(obj){scope.dosageResultSet=[];scope.dosageResultSet.push(new Object);if(scope.b_MedispanEnabled.toUpperCase()=="NO"){scope.dosageResultSet[0].sSupplierId=obj.supplierID}else{scope.dosageResultSet[0].DrugNameId=obj.supplierID}scope.dosageResultSet[0].IsRxSupplies=obj.IsRxSupplies;scope.dosageResultSet[0].ItemId=obj.itemID;scope.dosageResultSet[0].MMDCode=obj.MMDCode;scope.dosageResultSet[0].ObsoleteDate=obj.ObsoleteDate;scope.dosageResultSet[0].awup=obj.awup;scope.dosageResultSet[0].controlled=obj.controlled;scope.dosageResultSet[0].controlledCode=obj.controlledCode;scope.dosageResultSet[0].description=obj.medicationDescription;scope.dosageResultSet[0].dispense=obj.dispense;scope.dosageResultSet[0].doseunit=obj.doseunit;scope.dosageResultSet[0].drugNameType=obj.drugNameType;scope.dosageResultSet[0].drugOTC=obj.drugOTC;scope.dosageResultSet[0].duration=obj.duration;scope.dosageResultSet[0].favorite=obj.favorite;scope.dosageResultSet[0].formulation=obj.formulation;scope.dosageResultSet[0].freq=obj.freq;scope.dosageResultSet[0].ndc=obj.ndc;scope.dosageResultSet[0].refills=obj.refills;scope.dosageResultSet[0].route=obj.route;scope.dosageResultSet[0].strength=obj.strength;scope.dosageResultSet[0].take=obj.take;scope.selectedRxObject=scope.dosageResultSet[0];scope.qosResultObj.resultSet=scope.dosageResultSet[0];scope.qosResultObj.resultSet.nItemId=obj.itemID;scope.selectedRxName=obj.name;scope.selectedRxItemId=obj.itemID;scope.selectedIndex=0;return scope.rxCheckesToPerformForFavourateRx(obj)};scope.rxCheckesToPerformForFavourateRx=function(obj){if((scope.qosFilterObj.parentName=="TelEncounter"||scope.qosFilterObj.parentName=="currMed")&&!obj.bAddMultipleOrders&&!bAlreadyCalled){var duplicateCheck=scope.checkBeforeAddingRx(obj);if(!duplicateCheck){return false}}scope.selectedRxName=obj.name;scope.selectedRxItemId=obj.itemID;if(!obj.rxRefreshed||obj.rxRefreshed===undefined){scope.getRxandDx(scope.qosFilterObj.encounterID,scope.qosFilterObj.patientId,0,global.TrUserId,obj);return false}};scope.isRtbcButtonClicked=false;var ndcFlag=false;scope.selectDosage=function(obj,onRtbcBtnClick){if(onRtbcBtnClick)scope.isRtbcButtonClicked=true;else scope.isRtbcButtonClicked=false;if(checkIsValidForAllergyVerification(obj.sKeyname)&&checkAllergyVerifiedFlag){scope.checkAllergyVerified(scope.qosFilterObj.encounterID,CALLED_FROM_SELECT_DOSAGE,obj,null,null,null,null);return}checkAllergyVerifiedFlag=true;if(document.querySelector('[id=SendRxWidgetBtn2]')&&angular.element(document.querySelector('[id=SendRxWidgetBtn2]'))){var parentScope=angular.element(document.querySelector('[id=SendRxWidgetBtn2]')).scope();if(parentScope&&(typeof scope.qosFilterObj.encounterID==='undefined'||scope.qosFilterObj.encounterID===""||scope.qosFilterObj.encounterID===0)){parentScope.createTelEnc()}}if(scope.favRxSelected&&typeof obj==="object"){var exitCheck=scope.formObjectForFavourateRx(obj);if(exitCheck!=undefined&&!exitCheck){return}}else{scope.selectedRxObject=scope.dosageResultSet[obj];scope.selectedIndex=obj}try{if(scope.selectedRxObject.DrugNameId==0||typeof scope.selectedRxObject.DrugNameId==undefined||typeof scope.selectedRxObject.DrugNameId==="undefined")scope.selectedRxObject.DrugNameId=scope.selectedRxDrugNameId;if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&scope.selectedRxObject.brand_description!==undefined&&scope.selectedRxObject.brand_description.length>0){scope.selectedRxName=scope.selectedRxObject.brand_description}}catch(e){}scope.saveRxObject="";if(scope.enableDOCFormulary&&scope.enableCorrectionalFeatures){if($('#TJellyDetailViewd #formularyApporvalForm').length){$('#formularyApporvalForm').insertAfter($("#TJellyDetailViewd"))}var obj2=scope.selectedRxObject;obj2.formularystatus=parseInt(obj2.formularystatus,10);var TEMPLATE_USER=8663;if(parseInt(scope.qosFilterObj.patientId,10)!==TEMPLATE_USER&&(obj2.formularystatus===2||obj2.formularystatus===4)){var selectedDiagnosis="";try{selectedDiagnosis=$('#DivDxOrders').find('input[type="checkbox"]:checked').next().next().html()}catch(err){}try{if(obj2.formularystatus===4){ecwAlert(scope.qosResultObj.resultSet.sItemName+" "+obj2.strength+" is a Non-formulary drug. In order for this drug to be given an approval must be attained. Please click OK button to fill and print the approval form.","",function(){setRxApprovalFormDataByEncId(scope.qosResultObj.resultSet.sItemName,obj2.strength,obj2.take,obj2.route,obj2.freq,obj2.formularystatus,scope.qosFilterObj.encounterID,selectedDiagnosis);$('#formularyApporvalForm').modal()},"","","",false)}else if(obj2.formularystatus===2){ecwAlert(scope.qosResultObj.resultSet.sItemName+" "+obj2.strength+" is a Restricted drug. <br> The drug restriction is follows: "+obj2.formularystatusreason+". If you do not meet the restriction criteria, then approval must be attained. Please click OK button to fill and print the approval form.","",function(){setRxApprovalFormDataByEncId(scope.qosResultObj.resultSet.sItemName,obj2.strength,obj2.take,obj2.route,obj2.freq,obj2.formularystatus,scope.qosFilterObj.encounterID,selectedDiagnosis);$('#formularyApporvalForm').modal()},"","","",false)}else{setRxApprovalFormDataByEncId(scope.qosResultObj.resultSet.sItemName,obj2.strength,obj2.take,obj2.route,obj2.freq,obj2.formularystatus,scope.qosFilterObj.encounterID,selectedDiagnosis);$('#formularyApporvalForm').modal()}}catch(err){ecwAlert("Not able to show Restricted/Non-Formulary Approval Form")}}}if((scope.selectedRxObject.ndc==''||scope.selectedRxObject.ndc==undefined)&&!ndcFlag&&scope.showNDCWarningforNonNDCDrugDoses&&scope.qosResultObj.resultSet.isCompound!=='true'&&!scope.selectedRxObject.isCallFromePA){var selectedRx=scope.selectedRxName+" "+(scope.selectedRxObject.strength?scope.selectedRxObject.strength:"")+" "+(scope.selectedRxObject.formulation?scope.selectedRxObject.formulation:"");var msg="'"+escapeHtml(selectedRx)+"' does not have valid NDC code.\nPharmacy may not be able to dispense this medication as "+"written.\nYou will not be able to send this medication to a pharmacy as electronic prescription as it will "+"drop to fax.\n\nYou may want to choose an equivalent medication which are generally available in the market "+"in order to send it as electronic prescription.\n\nClick 'Yes' to continue without NDC.Otherwise click 'No'.";BootstrapDialog.show({title:"eClinicalWorks",message:msg,buttons:[{label:'Yes',cssClass:'btn-lgrey btn-xs',action:function(dialog){ndcFlag=true;scope.selectDosage(obj);dialog.close()}},{label:'No',cssClass:'btn-lgrey btn-xs',action:function(dialog){ndcFlag=false;obj.rxRefreshed=false;dialog.close();$("#searchBox"+scope.topClass).trigger("select");return}}]})}else{ndcFlag=true}if(ndcFlag){if(scope.qosFilterObj.parentName==="TelEncounter"||scope.qosFilterObj.parentName==="currMed"||scope.qosFilterObj.parentName==="RxHistory"||scope.qosFilterObj.parentName==="ExtRxHistory"||scope.qosFilterObj.parentName==="Unreconcile Meds"||scope.qosFilterObj.parentName==='OrderRxWidget'||scope.qosFilterObj.parentName==='OrderRxWidgetUpdateRx'){if(scope.IsMedOrderingForPastVist(obj)||bAlreadyCalled){bAlreadyCalled=false;if(scope.qosFilterObj.parentName==="currMed"||scope.qosFilterObj.parentName==='OrderRxWidgetUpdateRx'){scope.saveRxObject=rxService.RxChecksTobePerfomedBeforeSaving(scope.OrdersForEnc,scope.selectedRxObject,0,scope.qosFilterObj.parentName,scope.selectedRxName,scope.selectedRxItemId,0,scope.bOrderingRxMultipleTimes)}else{scope.saveRxObject=rxService.RxChecksTobePerfomedBeforeSaving(scope.OrdersForEnc,scope.selectedRxObject,0,scope.qosFilterObj.parentName,scope.selectedRxName,scope.selectedRxItemId,scope.qosFilterObj.encounterID,scope.bOrderingRxMultipleTimes)}ndcFlag=false;obj.rxRefreshed=false}}else{scope.saveRxFromQuickSearch();ndcFlag=false;obj.rxRefreshed=false}}obj.bAddMultipleOrders=false};scope.rxForDuplicateCheck={};scope.rxForDuplicateCheck.DxItemId=0;scope.rxForDuplicateCheck.Rx=[];scope.qosFilterObj.setRxForDuplicateCheck=function(){if(scope.qosFilterObj.parentName==="currMed"||scope.qosFilterObj.parentName==='OrderRxWidgetUpdateRx'){scope.rxForDuplicateCheck.Rx=scope.qosFilterObj.rxForDuplicateCheck.Rx;scope.OrdersForEnc=[];scope.OrdersForEnc.push(scope.rxForDuplicateCheck)}else{scope.OrdersForEnc=[]}};scope.pushRxForDuplicateCheck=function(index){if(scope.qosFilterObj.parentName==="currMed"||scope.qosFilterObj.parentName==="RxHistory"||scope.qosFilterObj.parentName==="ExtRxHistory"||scope.qosFilterObj.parentName==="Unreconcile Meds"){var tempRxObj={};tempRxObj.RxSourceId="";tempRxObj.RxItemId=scope.qosResultObj.resultSet.nItemId;tempRxObj.RxName=scope.selectedRxName;tempRxObj.NDC=scope.dosageResultSet[index].ndc;scope.rxForDuplicateCheck.Rx.push(tempRxObj)}};function checkUndefinedOrNullOrBlank(value,shouldTrim){if(angular.isUndefined(value)){return true}if(value===null){return true}if(value===""){return true}if(shouldTrim&&value.trim()===""){return true}return false}scope.saveRxFromQuickSearch=function(){var index=scope.selectedIndex;if(index==-1)return;try{if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"){if(scope.selectedRxObject.hasOwnProperty('itemid')&&scope.selectedRxObject.itemid!==""&&scope.selectedRxObject.itemid.length>0)scope.itemIdToSaveRx=scope.selectedRxObject.itemid;else scope.itemIdToSaveRx=scope.qosResultObj.resultSet.nItemId}else if(scope.b_DrugDbEnabled==='yes'&&checkUndefinedOrNullOrBlank(scope.selectedRxObject.ItemId,false)===false){scope.itemIdToSaveRx=scope.selectedRxObject.ItemId}else{scope.itemIdToSaveRx=scope.qosResultObj.resultSet.nItemId}if(angular.isUndefined(scope.itemIdToSaveRx)||scope.itemIdToSaveRx==null||scope.itemIdToSaveRx===""){alert("An error occured while adding medication, please try again later.");return}}catch(err){alert("An error occured while adding medication, please try again later.");return}$("#searchBox"+scope.topClass).trigger("select");if(scope.qosFilterObj.parentName=="TelEncounter"&&scope.rtbcEligibilityFlag&&scope.isMedMulEquiDrug&&scope.dosageResultSet[index].rxFormulary!=='Y'&&scope.dosageResultSet[index].ndc!==''&&scope.dosageResultSet[index].ndc!==undefined&&scope.showRtbcPopup&&scope.isValidDurationDispense(scope.dosageResultSet[index].duration)&&scope.isValidDurationDispense(scope.dosageResultSet[index].dispense)||scope.qosFilterObj.parentName=="TelEncounter"&&scope.rtbcEligibilityFlag&&scope.isMedMulEquiDrug&&scope.dosageResultSet[index].rxFormulary!=='Y'&&scope.dosageResultSet[index].ndc!==''&&scope.dosageResultSet[index].ndc!==undefined&&!scope.showRtbcPopup&&scope.isRtbcButtonClicked&&scope.isValidDurationDispense(scope.dosageResultSet[index].duration)&&scope.isValidDurationDispense(scope.dosageResultSet[index].dispense)){scope.selectedEmrRxObject={};angular.copy(scope.dosageResultSet[index],scope.selectedEmrRxObject);scope.selectedEmrRxObject.nSelectedAssessmentId=scope.nSelectedAssessmentId;scope.selectedEmrRxObject.showRtbcPopup=scope.showRtbcPopup;scope.selectedEmrRxObject.isRtbcButtonClicked=scope.isRtbcButtonClicked;scope.selectedEmrRxObject.facilityId=scope.encfacilityId;rtbcService.openRtbcModalWindow(global.TrUserId,scope.qosFilterObj.patientId,scope.qosFilterObj.encounterID,scope.selectedEmrRxObject,'TelephoneEnc');return}scope.saveRxData(scope.dosageResultSet[index],index)};scope.isValidDurationDispense=function(value){return rtbcService.isValidDurationDispense(value)};scope.favRxClicked=function(obj){$("#searchBox"+scope.topClass).trigger("select");if(scope.qosFilterObj.parentName=="TelEncounter"||scope.qosFilterObj.parentName=="RxHistory"||scope.qosFilterObj.parentName=="ExtRxHistory"){var xw=new XMLWriter;startSoapPacket(xw);xw.writeStartElement('return');xw.writeStartElement('items');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('item');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,"id",obj.itemID,'xsi:type','xsd:int');addElement(xw,"doctorFlag",'1','xsi:type','xsd:int');addElement(xw,"AssessId",0,'xsi:type','xsd:int');xw.writeStartElement('properties');xw.writeStartElement('property');addElement(xw,"id",scope.strengthId,'xsi:type','xsd:int');addElement(xw,"value",obj.strength,'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.formulationId,'xsi:type','xsd:int');addElement(xw,"value",obj.formulation,'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.takeId,'xsi:type','xsd:int');addElement(xw,"value",obj.take,'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.routeId,'xsi:type','xsd:int');addElement(xw,"value",obj.route,'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.frequencyId,'xsi:type','xsd:int');addElement(xw,"value",obj.freq,'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.durationId,'xsi:type','xsd:int');addElement(xw,"value",obj.duration,'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.dispenseId,'xsi:type','xsd:int');addElement(xw,"value",obj.dispense,'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.refillsId,'xsi:type','xsd:int');addElement(xw,"value",obj.refills,'xsi:type','xsd:string');xw.writeEndElement();xw.writeEndElement();addElement(xw,"GBO","U",'xsi:type','xsd:string');addElement(xw,"FormularyStatus","",'xsi:type','xsd:string');if(scope.b_MedispanEnabled=="no"){addElement(xw,"MMDCode","",'xsi:type','xsd:string')}else{addElement(xw,"MMDCode",obj.MMDCode,'xsi:type','xsd:string')}addElement(xw,"NDCCode",obj.ndc,'xsi:type','xsd:string');if(bSaveAsInventoryProduct&&scope.bDispenseInventoryLinkEnabled){addElement(xw,"InvProductId",obj.InvProductId,'xsi:type','xsd:string');bSaveAsInventoryProduct=false}addElement(xw,"FormularyId","",'xsi:type','xsd:string');addElement(xw,"PayerSourceName","",'xsi:type','xsd:string');addElement(xw,"BrandCode","",'xsi:type','xsd:string');addElement(xw,"SymID","",'xsi:type','xsd:string');addElement(xw,"StartDate",$filter('date')(new Date,'yyyy/MM/dd'),'xsi:type','xsd:string');var sStopDt="";try{sStopDt=rxService.calculateStopDate(obj.itemID,$filter('date')(new Date,'yyyy/MM/dd'),obj.duration,obj.refills,"yyyy-mm-dd")}catch(e){}addElement(xw,"StopDate",sStopDt,'xsi:type','xsd:string');addElement(xw,"PreparedBy","",'xsi:type','xsd:string');addElement(xw,"rxNotes","",'xsi:type','xsd:string');addElement(xw,"RxOrderNo","",'xsi:type','xsd:string');addElement(xw,"rxKOP","",'xsi:type','xsd:string');addElement(xw,"rxDrugSource","",'xsi:type','xsd:string');addElement(xw,"awp","",'xsi:type','xsd:string');addElement(xw,"awup","",'xsi:type','xsd:string');addElement(xw,"OldRxMainId","",'xsi:type','xsd:string');addElement(xw,"rxSource","",'xsi:type','xsd:string');addElement(xw,"rxSourceId",global.TrUserId,'xsi:type','xsd:int');xw.writeEndElement();xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();var param="";if(scope.qosFilterObj.parentName=="TelEncounter"){param="EncounterId="+scope.qosFilterObj.encounterID+"&AsmtId=0&type=ModernRx&FormData="+encodeURIComponent(xml)}else{param="EncounterId="+scope.qosFilterObj.encounterID+"&type=ModernRx&FormData="+encodeURIComponent(xml)}$.ajax({type:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/rx/saveRx.jsp"),data:param,success:function(msg){if(msg.length>0&&msg.indexOf("failed")<0){}else{alert("Sorry, order did not get added")}if(scope.qosFilterObj.context==="FHIRTreatment"){scope.$parent.meic.FHIRIObjSelectedRxName=scope.qosResultObj.resultSet.sItemName}scope.setSearchResultObjWrapperCall()},error:function(xhr){console.log("An error occured: "+xhr.status+" "+xhr.statusText)}})}else{scope.qosResultObj.resultSet={};scope.qosResultObj.resultSet.sItemName=obj.name;if(scope.b_MedispanEnabled=="yes"){scope.qosResultObj.resultSet.sDrugNameId=obj.supplierID}else{scope.qosResultObj.resultSet.sSupplierId=obj.supplierID}scope.qosResultObj.resultSet.ItemId=obj.itemID;scope.qosResultObj.resultSet.nItemId=obj.itemID;scope.qosResultObj.resultSet.strength=obj.strength;scope.qosResultObj.resultSet.formulation=obj.formulation;scope.qosResultObj.resultSet.route=obj.route;scope.qosResultObj.resultSet.take=obj.take;scope.qosResultObj.resultSet.freq=obj.freq;scope.qosResultObj.resultSet.duration=obj.duration;scope.qosResultObj.resultSet.dispense=obj.dispense;scope.qosResultObj.resultSet.refills=obj.refills;scope.qosResultObj.resultSet.ndc=obj.ndc;scope.qosResultObj.resultSet.controlledCode="";scope.qosResultObj.resultSet.controlled="";scope.qosResultObj.resultSet.IsRxSupplies="";scope.qosResultObj.resultSet.favorite="";scope.qosResultObj.resultSet.awup=obj.awup;if(scope.qosFilterObj.context==="FHIRTreatment"){scope.$parent.meic.FHIRIObjSelectedRxName=scope.qosResultObj.resultSet.sItemName}scope.setSearchResultObjWrapperCall(scope.qosResultObj.resultSet.ItemId,scope.qosResultObj.resultSet.ndc,scope.qosResultObj.resultSet.strength,scope.qosResultObj.resultSet.formulation)}};scope.loadFormularyRxDoses=function(nSynonymId,itemID,RxType){if(scope.isEpaServiceEnabled){scope.isRxEligibilitySuccessful=true}scope.dosageResultSet=[];if(scope.b_MedispanEnabled==="no"){scope.showObsoleteMessage=false;scope.showDiscontinuedRxIcon=false;var url='/mobiledoc/jsp/catalog/xml/RxHub/getFormularyDosesForRx.jsp?RxType='+RxType+'&synonymId='+nSynonymId+'&itemid='+itemID+"&DrugName="+scope.qosResultObj.resultSet.sItemName;if(scope.selectedRxObject.nParentID!=scope.MultumId&&!scope.b_ShowMultumDosesFormCustom){url=url+"&multumDoses=0"}if(scope.bDispenseInventoryLinkEnabled&&scope.qosFilterObj.parentName!="currMed"){url=url+"&facilityId="+global.facilityId}url=url+"&calledFrom=10eWEB&trUserId="+global.TrUserId;var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDataForFormulary();scope.setDosageCalcCombos()}})}else{if(scope.selectedRxObject.nParentID==scope.MedispanId||nSynonymId>0){scope.showObsoleteMessage=false;scope.showDiscontinuedRxIcon=false;var url='/mobiledoc/jsp/ecwrx/getDoses.jsp?RxType='+RxType+'&dnid='+nSynonymId+'&ItemId='+itemID+"&facilityID="+global.facilityId+'&bObsolete='+scope.showDiscontinuedDrugs;if(scope.bDispenseInventoryLinkEnabled&&scope.qosFilterObj.parentName!="currMed"){url=url+"&facilityId="+global.facilityId}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDataForFormulary();scope.setDosageCalcCombos();try{if(scope.dosageResultSet.length===0&&jsonobj.Envelope.Body["return"].hasOwnProperty("showObsoleteMessage")){var val=jsonobj.Envelope.Body["return"]['showObsoleteMessage'];scope.showObsoleteMessage=val==="yes"?true:false}}catch(e){}}})}else{var url='/mobiledoc/jsp/ecwrx/getCustomDoses.jsp?RxType='+RxType+'&itemid='+itemID+'&dnid='+nSynonymId+'&trUserId='+global.TrUserId;if(scope.bDispenseInventoryLinkEnabled&&scope.qosFilterObj.parentName!="currMed"){url=url+"&facilityId="+global.facilityId}var promise=$http.post(makeURL(url));promise.success(function(data,status,headers,config){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'])>0){if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose')&&jsonobj.Envelope.Body['return'].dose.length>0)scope.dosageResultSet=jsonobj.Envelope.Body['return'].dose;else if(jsonobj.Envelope.Body['return'].hasOwnProperty('dose'))scope.dosageResultSet.push(jsonobj.Envelope.Body['return'].dose);scope.setDosageCalcCombos()}})}}if(scope.isRtbcServiceEnabled){scope.isMedMulEquiDrug=rtbcService.checkMedispanMultumEquipmentSupply(scope.selectedRxObject.nParentID)}};function doseCheckEnabled(){if(getItemKeyValue("ShowAllergicAlerts").toUpperCase()!=="YES"){return false}if(getItemKeyValue("EnableMedispan").toUpperCase()!=="YES"){return false}if(getItemKeyValue("EnableMSClinical").toUpperCase()!=="YES"){return false}return true}function isDoseAlertMessageExist(xmlObj){if(!doseCheckEnabled()){return false}if(!xmlObj.Envelope.Body["return"].hasOwnProperty("DoseCheckResponse")){return false}var doseCheckRes=xmlObj.Envelope.Body["return"].DoseCheckResponse;if(doseCheckRes.doseCheckStatus==='200'&&angular.isDefined(doseCheckRes.doseCheckAlerts)){return true}return false}function setDoseCheckData(rxObj,doseCheckData){doseCheckData.itemId=rxObj.ItemId;doseCheckData.ndcCode=rxObj.ndc;doseCheckData.requestId=0;if(scope.qosFilterObj.encounterID===0||scope.qosFilterObj.encounterID==='0'){doseCheckData.requestId=scope.qosFilterObj.doseCheckReqId;doseCheckData.saveWhileAccept=true}}scope.CheckAllergyInteraction=function(rxObject,rxObjIndex){var doseCheckData={saveWhileAccept:false};if(getItemKeyValue("ShowAllergicAlerts").toUpperCase()=="YES"){var sSynonymId="";if(scope.b_MedispanEnabled.toUpperCase()=="NO"){sSynonymId=scope.selectedRxObject.sSupplierId}else{sSynonymId=scope.selectedRxObject.DrugNameId}var rxItemId="";if(rxObject.isRtbcRxObject){if(rxObject.ItemId){rxItemId=rxObject.ItemId}else if(rxObject.itemID){rxItemId=rxObject.itemID}}else{rxItemId=scope.selectedRxItemId}if(checkUndefinedOrNullOrBlank(rxObject.ndc,true)){rxObject.ndc=""}var url="/mobiledoc/jsp/ecwrx/CheckAllergyInteraction.jsp?encid="+scope.qosFilterObj.encounterID+"&eDate="+scope.encdateAddRx+"&patientId="+scope.qosFilterObj.patientId+"&RxId="+rxItemId+"&ndc="+rxObject.ndc+"&SynonymId="+sSynonymId;url+="&strength="+encodeURIComponent(rxObject.strength)+"&formulation="+encodeURIComponent(rxObject.formulation);if(doseCheckEnabled()){setDoseCheckData(rxObject,doseCheckData);var doseCheckDataParam="&drugName="+encodeURIComponent(rxObject.drugName)+"&take="+encodeURIComponent(rxObject.take)+"&route="+encodeURIComponent(rxObject.route)+"&freq="+encodeURIComponent(rxObject.freq)+"&duration="+encodeURIComponent(rxObject.duration)+"&calledFrom=web";url=url+doseCheckDataParam}var promise=$http.get(makeURL(url));promise.then(function(xml){var x2js=new X2JS;var ptAllergyObj=x2js.xml_str2json(xml.data.trim());if(typeof ptAllergyObj!="undefined"&&ptAllergyObj!=null&&(ptAllergyObj.Envelope.Body["return"].hasOwnProperty("DDAllergy")||ptAllergyObj.Envelope.Body["return"].hasOwnProperty("allergy")||isDoseAlertMessageExist(ptAllergyObj))){continueSaveRx=false;$ocLazyLoad.load({name:'AllergyInteraction',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/js/allergyInteractionController.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/allergy/allergyInteraction.jsp'),controller:'AllergyInteractionController',windowClass:'bluetheme',backdrop:"static",size:'lg',resolve:{patientID:function(){return scope.qosFilterObj.patientId},encid:function(){return scope.qosFilterObj.encounterID},parentName:function(){return scope.qosFilterObj.parentName},itemName:function(){return ptAllergyObj.Envelope.Body["return"].itemName},doseCheckResponse:function(){return ptAllergyObj.Envelope.Body["return"].DoseCheckResponse},doseCheckData:function(){return doseCheckData},ptAllergy:function(){if(scope.b_MedispanEnabled.toUpperCase()=="NO"){var tempArr=[];tempArr=returnDataArray(ptAllergyObj.Envelope.Body["return"].allergy);for(var i=0;i<tempArr.length;i++){if(tempArr[i].hasOwnProperty("drug")){tempArr[i]["patientallergy"]=tempArr[i]["drug"];delete tempArr[i]["drug"]}if(tempArr[i].hasOwnProperty("catDescr")){tempArr[i]["allergyclass"]=tempArr[i]["catDescr"];delete tempArr[i]["catDescr"]}if(tempArr[i].hasOwnProperty("allergyDesc")){tempArr[i]["allergytype"]=tempArr[i]["allergyDesc"];delete tempArr[i]["allergyDesc"]}if(tempArr[i].hasOwnProperty("classDescr")){tempArr[i]["description"]=tempArr[i]["classDescr"];delete tempArr[i]["classDescr"]}}return tempArr}else{return returnDataArray(ptAllergyObj.Envelope.Body["return"].DDAllergy)}}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){if(modalInstanceResponse=="Continue"){if(!scope.callFromePA){scope.m_bAllergyInteraction=false;if(doseCheckEnabled()&&isDoseAlertMessageExist(ptAllergyObj)){setDoseCheckData(rxObject,doseCheckData);rxObject.doseCheckData=doseCheckData}scope.saveRxData(rxObject,rxObjIndex)}else{scope.callFromePA=false;scope.openEPAInitializePopup(rxObject,true)}return}scope.callFromePA=false;if(doseCheckEnabled()&&modalInstanceResponse!="Continue"&&isDoseAlertMessageExist(ptAllergyObj)){setDoseCheckData(rxObject,doseCheckData);scope.saveDoseCheckLog(doseCheckData)}})})}else{if(!scope.callFromePA){scope.m_bAllergyInteraction=false;scope.saveRxData(rxObject,rxObjIndex)}else{scope.callFromePA=false;scope.openEPAInitializePopup(rxObject,true)}}})}else{if(!scope.callFromePA){scope.m_bAllergyInteraction=false;scope.saveRxData(rxObject,rxObjIndex)}else{scope.callFromePA=false;scope.openEPAInitializePopup(rxObject,true)}}};scope.saveDoseCheckLog=function(doseCheckData){var url='/mobiledoc/cpoe/doseCheckLog/saveDoseCheckLog';url=makeURL(url);$http({method:'POST',url:url,headers:{'Content-Type':'application/json'},data:doseCheckData}).then(function(data){})};scope.setDataForFormulary=function(){if(scope.b_MedispanEnabled=="no"){for(var i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].synonymid==scope.dosageResultSet[i].brand_code||scope.dosageResultSet[i].brand_code==""){}else{}if(scope.dosageResultSet[i].gbo=="N"||scope.dosageResultSet[i].gbo=="U"){scope.dosageResultSet[i].gbo="B"}if(scope.dosageResultSet[i].gbo==""){scope.dosageResultSet[i].gbo="U"}if(scope.dosageResultSet[i].otc=="T"){scope.dosageResultSet[i].otc="O"}else if(scope.dosageResultSet[i].otc=="F"){scope.dosageResultSet[i].otc="P"}}scope.appendAdditionalDataForFavorites()}else{for(var i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].drugOTC=="O"||scope.dosageResultSet[i].drugOTC=="2"||scope.dosageResultSet[i].drugOTC=="3"){scope.dosageResultSet[i].OTC="O"}else if(scope.dosageResultSet[i].drugOTC=="R"||scope.dosageResultSet[i].drugOTC=="1"){scope.dosageResultSet[i].OTC="P"}else if(scope.dosageResultSet[i].drugOTC==""){scope.dosageResultSet[i].OTC="U"}if(scope.dosageResultSet[i].drugNameType=="N"||scope.dosageResultSet[i].drugNameType=="B"||scope.dosageResultSet[i].drugNameType=="2"||scope.dosageResultSet[i].drugNameType=="1"){scope.dosageResultSet[i].GBO="B"}else if(scope.dosageResultSet[i].drugNameType=="T"||scope.dosageResultSet[i].drugNameType=="3"||scope.dosageResultSet[i].drugNameType=="G"){scope.dosageResultSet[i].GBO="G"}scope.dosageResultSet[i].BrandDesc=scope.dosageResultSet[i].description}scope.appendAdditionalDataForFavorites()}scope.checkFormularyForDrug()};scope.appendAdditionalDataForFavorites=function(){try{var favorite=[];for(var i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].favorite==="1"){favorite.push(scope.dosageResultSet[i]);scope.dosageResultSet.splice(i,1);i=i-1}}if(scope.b_MedispanEnabled=="no"){scope.appendAdditionalDataForMultumFavorite(favorite)}else{scope.appendAdditionalDataForMedispanFavorite(favorite)}}catch(e){}};scope.appendAdditionalDataForMultumFavorite=function(favorite){try{if(favorite.length>0){for(var j=0;j<favorite.length;j++){for(var i=0;i<scope.dosageResultSet.length;i++){if(angular.lowercase(favorite[j].brand_description)===angular.lowercase(scope.dosageResultSet[i].brand_description)&&angular.lowercase(favorite[j].formulation)===angular.lowercase(scope.dosageResultSet[i].formulation)&&angular.lowercase(favorite[j].route)===angular.lowercase(scope.dosageResultSet[i].route)&&angular.lowercase(favorite[j].strength)===angular.lowercase(scope.dosageResultSet[i].strength)){favorite[j].gbo=scope.dosageResultSet[i].gbo;favorite[j].otc=scope.dosageResultSet[i].otc;favorite[j].main_multum_drug_code=scope.dosageResultSet[i].main_multum_drug_code;favorite[j].brand_code=scope.dosageResultSet[i].brand_code;scope.dosageResultSet.push(favorite[j]);break}}}}}catch(e){}};scope.appendAdditionalDataForMedispanFavorite=function(favorite){try{if(favorite.length>0){for(var j=0;j<favorite.length;j++){for(var i=0;i<scope.dosageResultSet.length;i++){if(angular.lowercase(favorite[j].ndc)===angular.lowercase(scope.dosageResultSet[i].ndc)&&angular.lowercase(favorite[j].formulation)===angular.lowercase(scope.dosageResultSet[i].formulation)&&angular.lowercase(favorite[j].route)===angular.lowercase(scope.dosageResultSet[i].route)&&angular.lowercase(favorite[j].strength)===angular.lowercase(scope.dosageResultSet[i].strength)){favorite[j].GBO=scope.dosageResultSet[i].GBO;favorite[j].OTC=scope.dosageResultSet[i].OTC;scope.dosageResultSet.push(favorite[j]);break}}}}}catch(e){}};scope.checkFormularyForDrug=function(){var xml="";if(scope.b_MedispanEnabled=="no"){var xw=new XMLWriter;scope.medispanAPI='no';startSoapPacket(xw);xw.writeStartElement('Info');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('RxList');xw.writeAttributeString('xsi:type','xsd:string');for(var i=0;i<scope.dosageResultSet.length;i++){xw.writeStartElement('Row');xw.writeAttributeString('xsi:type','xsd:string');if(scope.dosageResultSet[i].synonymid==""){scope.dosageResultSet[i].synonymid=0}addElement(xw,"synonymId",scope.dosageResultSet[i].synonymid,'xsi:type','xsd:string');if(scope.dosageResultSet[i].main_multum_drug_code==""){scope.dosageResultSet[i].main_multum_drug_code=0}addElement(xw,"mmdcode",scope.dosageResultSet[i].main_multum_drug_code,'xsi:type','xsd:string');if(scope.dosageResultSet[i].gbo=="B"){scope.dosageResultSet[i].gbo="N"}scope.dosageResultSet[i].GBO=scope.dosageResultSet[i].gbo;scope.dosageResultSet[i].OTC=scope.dosageResultSet[i].otc;addElement(xw,"GBO",scope.dosageResultSet[i].gbo,'xsi:type','xsd:string');if(scope.dosageResultSet[i].brand_code==""){scope.dosageResultSet[i].brand_code=0}addElement(xw,"BrandCode",scope.dosageResultSet[i].brand_code,'xsi:type','xsd:string');xw.writeEndElement()}xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);xml=xw.flush()}else{var xw=new XMLWriter;scope.medispanAPI='yes';startSoapPacket(xw);xw.writeStartElement('Info');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('RxList');xw.writeAttributeString('xsi:type','xsd:string');for(var i=0;i<scope.dosageResultSet.length;i++){xw.writeStartElement('Row');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,"NDCCode",scope.dosageResultSet[i].ndc,'xsi:type','xsd:string');xw.writeEndElement()}xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);xml=xw.flush()}scope.formularyDataForDrug=[];scope.dosageResultSetGreenDrugs=[];scope.dosageResultSetOrangeDrugs=[];scope.dosageResultSetYellowDrugs=[];scope.dosageResultSetRedDrugs=[];scope.dosageResultSetBlackDrugs=[];if(scope.formularyInfo.CoverageId===null||typeof scope.formularyInfo.CoverageId===null||scope.formularyInfo.CoverageId==="null")scope.formularyInfo.CoverageId="";var strUrl="/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/checkFormularyForDrug.jsp?FormularyId="+scope.formularyInfo.FormularyID+"&FormSourceId="+scope.formularyInfo.FormularySourceCode+"&CoverageId="+scope.formularyInfo.CoverageId+"&MedispanAPI="+scope.medispanAPI;var params="strData="+xml;var responsePromise=scope.LoadURL(strUrl,params);responsePromise.success(function(data){if(data.trim().length>0){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'].resultset.data.rows)>0){if(jsonobj.Envelope.Body['return'].resultset.data.rows.length>0){scope.formularyDataForDrug=jsonobj.Envelope.Body['return'].resultset.data.rows}else{scope.formularyDataForDrug.push(jsonobj.Envelope.Body['return'].resultset.data.rows)}scope.calculateFormulary();scope.sortDrugsByFormulary()}}})};scope.dosageResultSetGreenDrugs=[];scope.dosageResultSetOrangeDrugs=[];scope.dosageResultSetYellowDrugs=[];scope.dosageResultSetRedDrugs=[];scope.dosageResultSetBlackDrugs=[];scope.calculateFormulary=function(){for(var i=0;i<scope.dosageResultSet.length;i++){for(var j=i;j<scope.formularyDataForDrug.length;j++){if(scope.b_MedispanEnabled=="yes"){if(scope.formularyDataForDrug[j].NDC_Code==scope.dosageResultSet[i].ndc){if(scope.formularyDataForDrug[j].FormularyStatus=="01"){scope.dosageResultSet[i].FormularyStatus="1"}else if(scope.formularyDataForDrug[j].FormularyStatus=="02"){scope.dosageResultSet[i].FormularyStatus="2"}else if(scope.formularyDataForDrug[j].FormularyStatus=="03"){scope.dosageResultSet[i].FormularyStatus="3"}else if(scope.formularyDataForDrug[j].FormularyStatus=="00"){scope.dosageResultSet[i].FormularyStatus="0"}else{scope.dosageResultSet[i].FormularyStatus=scope.formularyDataForDrug[j].FormularyStatus}scope.dosageResultSet[i].PARequired=false;if(scope.formularyDataForDrug[j]&&scope.formularyDataForDrug[j].PARequired){if(scope.formularyDataForDrug[j].PARequired.toLowerCase()==='yes'){scope.dosageResultSet[i].PARequired=true}}break}}else{if(scope.formularyDataForDrug[j].mmdcode==scope.dosageResultSet[i].main_multum_drug_code){if(scope.formularyDataForDrug[j].FormularyStatus=="01"){scope.dosageResultSet[i].FormularyStatus="1"}else if(scope.formularyDataForDrug[j].FormularyStatus=="02"){scope.dosageResultSet[i].FormularyStatus="2"}else if(scope.formularyDataForDrug[j].FormularyStatus=="03"){scope.dosageResultSet[i].FormularyStatus="3"}else if(scope.formularyDataForDrug[j].FormularyStatus=="00"){scope.dosageResultSet[i].FormularyStatus="0"}else{scope.dosageResultSet[i].FormularyStatus=scope.formularyDataForDrug[j].FormularyStatus}scope.dosageResultSet[i].ndc=scope.formularyDataForDrug[j].NDC_Code;scope.dosageResultSet[i].PARequired=false;if(scope.formularyDataForDrug[j]&&scope.formularyDataForDrug[j].PARequired){if(scope.formularyDataForDrug[j].PARequired.toLowerCase()==='yes'){scope.dosageResultSet[i].PARequired=true}}break}}}}try{if(scope.RxDefaultDosesTypeId===0||scope.RxDefaultDosesTypeId==="0"||scope.RxDefaultDosesTypeId==""){for(var i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].favorite==="1"){scope.dosageResultSet.splice(i,1);i=i-1}}}else if(scope.RxDefaultDosesTypeId===1||scope.RxDefaultDosesTypeId==="1"){var favorite=[];for(var i=0;i<scope.dosageResultSet.length;i++){if(scope.dosageResultSet[i].favorite==="1"){favorite.push(scope.dosageResultSet[i]);scope.dosageResultSet.splice(i,1);i=i-1}}scope.dosageResultSet=favorite}}catch(e){}for(var i=0;i<scope.dosageResultSet.length;i++){var strFormularyStatus=scope.dosageResultSet[i].FormularyStatus;if(strFormularyStatus===""){if(scope.dosageResultSet[i].GBO==="B"&&scope.dosageResultSet[i].OTC==="O"){if(trimContent(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])==="Unknown"){scope.dosageResultSet[i].FormularyStatus="U"}else if(trimContent(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])===""){scope.dosageResultSet[i].FormularyStatus=""}else if(trimContent(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])==="Not Reimbursable"){scope.dosageResultSet[i].FormularyStatus="0"}else if(trimContent(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])==="Non Formulary"){scope.dosageResultSet[i].FormularyStatus="1"}else if(trimContent(scope.loadFormularyInfo.NLRxBrandOTC_FS.split(":")[1])==="On Formulary(Not Preferred)"){scope.dosageResultSet[i].FormularyStatus="2"}else{if(scope.loadFormularyInfo.NLRxBrandOTC_FS!==""){if(scope.isNumeric(scope.Right(scope.loadFormularyInfo.NLRxBrandOTC_FS.trim(),2))){var nPrefLevel=scope.Right(scope.loadFormularyInfo.NLRxBrandOTC_FS.trim(),2)+2;scope.dosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(scope.dosageResultSet[i].GBO==="B"&&scope.dosageResultSet[i].OTC==="P"){if(trimContent(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])==="Unknown"){scope.dosageResultSet[i].FormularyStatus="U"}else if(trimContent(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])===""){scope.dosageResultSet[i].FormularyStatus=""}else if(trimContent(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])==="Not Reimbursable"){scope.dosageResultSet[i].FormularyStatus="0"}else if(trimContent(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])==="Non Formulary"){scope.dosageResultSet[i].FormularyStatus="1"}else if(trimContent(scope.loadFormularyInfo.NLRxBrand_FS.split(":")[1])==="On Formulary(Not Preferred)"){scope.dosageResultSet[i].FormularyStatus="2"}else{if(scope.loadFormularyInfo.NLRxBrand_FS!==""){if(scope.isNumeric(scope.Right(scope.loadFormularyInfo.NLRxBrand_FS.trim(),2))){var nPrefLevel=scope.Right(scope.loadFormularyInfo.NLRxBrand_FS.trim(),2)+2;scope.dosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(scope.dosageResultSet[i].GBO==="G"&&scope.dosageResultSet[i].OTC==="O"){if(trimContent(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])=="Unknown"){scope.dosageResultSet[i].FormularyStatus="U"}else if(trimContent(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])===""){scope.dosageResultSet[i].FormularyStatus=""}else if(trimContent(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])==="Not Reimbursable"){scope.dosageResultSet[i].FormularyStatus="0"}else if(trimContent(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])==="Non Formulary"){scope.dosageResultSet[i].FormularyStatus="1"}else if(trimContent(scope.loadFormularyInfo.NLRxGenericOTC_FS.split(":")[1])==="On Formulary(Not Preferred)"){scope.dosageResultSet[i].FormularyStatus="2"}else{if(scope.loadFormularyInfo.NLRxGenericOTC_FS!==""){if(scope.isNumeric(scope.Right(scope.loadFormularyInfo.NLRxGenericOTC_FS.trim(),2))){var nPrefLevel=scope.Right(scope.loadFormularyInfo.NLRxGenericOTC_FS.trim(),2)+2;scope.dosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(scope.dosageResultSet[i].GBO==="G"&&scope.dosageResultSet[i].OTC==="P"){if(trimContent(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])==="Unknown"){scope.dosageResultSet[i].FormularyStatus="U"}else if(trimContent(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])===""){scope.dosageResultSet[i].FormularyStatus=""}else if(trimContent(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])==="Not Reimbursable"){scope.dosageResultSet[i].FormularyStatus="0"}else if(trimContent(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])==="Non Formulary"){scope.dosageResultSet[i].FormularyStatus="1"}else if(trimContent(scope.loadFormularyInfo.NLRxGeneric_FS.split(":")[1])==="On Formulary(Not Preferred)"){scope.dosageResultSet[i].FormularyStatus="2"}else{if(scope.loadFormularyInfo.NLRxGeneric_FS!==""){if(scope.isNumeric(scope.Right(scope.loadFormularyInfo.NLRxGeneric_FS.trim(),2))){var nPrefLevel=scope.Right(scope.loadFormularyInfo.NLRxGeneric_FS.trim(),2)+2;scope.dosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}}if(typeof scope.dosageResultSet[i].FormularyStatus==undefined){scope.dosageResultSet[i].FormularyStatus="U"}if(scope.dosageResultSet[i].FormularyStatus==""){scope.dosageResultSet[i].FormularyStatus="U"}var nColorCode=scope.getProductStatusColorCode(scope.dosageResultSet[i].FormularyStatus);switch(nColorCode){case"white":scope.dosageResultSet[i].formularypic="icon-black-question";scope.dosageResultSet[i].formularypictooltip="Formulary Status - Unknown";scope.dosageResultSetBlackDrugs.push(scope.dosageResultSet[i]);break;case"red":scope.dosageResultSet[i].formularypic="icon-red-face";scope.dosageResultSet[i].formularypictooltip="Formulary Status - Not Covered";scope.dosageResultSetRedDrugs.push(scope.dosageResultSet[i]);break;case"orange":scope.dosageResultSet[i].formularypic="icon-orange-face";scope.dosageResultSet[i].formularypictooltip="Formulary Status - Non Formulary";scope.dosageResultSetOrangeDrugs.push(scope.dosageResultSet[i]);break;case"yellow":scope.dosageResultSet[i].formularypic="icon-yellow-face";scope.dosageResultSet[i].formularypictooltip="Formulary Status - On Formulary";scope.dosageResultSetYellowDrugs.push(scope.dosageResultSet[i]);break;default:scope.dosageResultSet[i].formularypic="icon-green-face";scope.dosageResultSet[i].formularypictooltip="Formulary Status - Preferred Drugs";scope.dosageResultSetGreenDrugs.push(scope.dosageResultSet[i]);break}}};scope.sortDrugsByFormulary=function(){scope.dosageResultSet=[];scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetGreenDrugs);scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetYellowDrugs);scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetOrangeDrugs);scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetRedDrugs);scope.dosageResultSet=scope.dosageResultSet.concat(scope.dosageResultSetBlackDrugs)};scope.getProductStatusColorCode=function(strProductStatusCode){switch(strProductStatusCode){case"U":return"white";break;case"0":return"red";case"00":return"red";break;case"1":return"orange";break;case"01":return"orange";break;case"2":return"yellow";break;case"02":return"yellow";break;case"":return"white";break;default:return"green";break}};scope.LoadURL=function(strUrl,data){return $http({method:'POST',url:makeURL(strUrl),data:data,"async":true,headers:{'Content-Type':'application/x-www-form-urlencoded'}})};scope.isNumeric=function(obj){return!Array.isArray(obj)&&obj-parseFloat(obj)+1>=0};scope.Right=function(str,nextCharlength){return str.substring(str.length-2,str.length)};scope.setDosageCalcCombos=function(dosageResultSet){scope.RxEditStrengthObject=[];scope.RxEditFrequencyObject=[];scope.RxEditDurationObject=[];for(var i=0;i<=scope.dosageResultSet.length;i++){try{if(scope.RxEditStrengthObject.indexOf(scope.dosageResultSet[i].strength)<0){scope.RxEditStrengthObject.push(scope.dosageResultSet[i].strength)}if(scope.RxEditFrequencyObject.indexOf(scope.dosageResultSet[i].freq)<0){scope.RxEditFrequencyObject.push(scope.dosageResultSet[i].freq)}if(scope.RxEditDurationObject.indexOf(scope.dosageResultSet[i].duration)<0){scope.RxEditDurationObject.push(scope.dosageResultSet[i].duration)}}catch(e){}}};scope.rxDoseCalcClicked=function(index){scope.patientIdentifiers={};if(scope.qosFilterObj.patientIndentifierObj!==undefined&&scope.qosFilterObj.patientIndentifierObj!==null){scope.patientIdentifiers=scope.qosFilterObj.patientIndentifierObj}var rxObj=scope.dosageResultSet[index];if(scope.checkIsCompoundDrug(rxObj.isCompound)){ecwAlert("Dosage Calculator is disabled for Compound Medications. Please perform all necessary manual dose calculations prior to prescribing.");return}if(scope.b_MedispanEnabled==="no"&&scope.formularyInfo!=="No Formulary ID is set for this encounter"&&rxObj.brand_description!==undefined)rxObj.description=rxObj.brand_description;else rxObj.description=scope.qosResultObj.resultSet.sItemName;if(angular.isUndefined(rxObj.ItemId)||rxObj.ItemId==null||rxObj.ItemId===""||rxObj.ItemId==='0'){rxObj.ItemId=scope.selectedRxItemId}if(typeof rxObj.strength!=='undefined'&&rxObj.strength!=null){var bCheckIsDosageCalcEnabled=rxService.IsDosageCalcEnabled(rxObj.ItemId,rxObj.strength);if(bCheckIsDosageCalcEnabled==="false"){ecwAlert("The Dosage Calculator is disabled for this medication; since the medication has more than one ingredient the dosage may not be calculated correctly.");return}}if(rxObj.hasOwnProperty("strength")&&rxObj.strength!==""&&rxObj.strength!==null&&rxObj.strength.length>0&&rxObj.strength.indexOf("(")>-1&&rxObj.strength.indexOf(")")>-1){let msg='<b>Dosage Calculator - Cannot Calculate Dose</b><br/><br/>The dosage calculator is disabled because the selected medication\'s strength is provided by the drug database in a format that cannot be safely used for calculation.';showAlertMessage(msg,'','ErrorMsg','','QuickOrderSearch');return}$ocLazyLoad.load({name:'DosageCalculator',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/DosageCalculatorController.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/DosageCalculator.jsp?'+"encounterId="+scope.qosFilterObj.encounterID),controller:'DosageCalculatorController',size:'sm',windowClass:'app-modal-window1 bluetheme',backdrop:"static",keyboard:false,resolve:{loginuserid:function(){return global.TrUserId},parentName:function(){return scope.qosFilterObj.parentName},RxInfo:function(){return{RxEditDurationObject:scope.RxEditDurationObject,RxEditStrengthObject:scope.RxEditStrengthObject,RxEditFrequencyObject:scope.RxEditFrequencyObject,RxEditDefaultRxNameValue:rxObj.description,RxEditDefaultStrengthValue:rxObj.strength,RxEditDefaultFormulationValue:rxObj.formulation,RxEditDefaultTakeValue:rxObj.take,RxEditDefaultRouteValue:rxObj.route,RxEditDefaultDurationValue:rxObj.duration,RxEditDefaultDispenseValue:rxObj.dispense,RxEditDefaultFrequencyValue:rxObj.freq,RxEditItemIdValue:rxObj.ItemId,RxEditDrugNameIdValue:rxObj.DrugNameId}},encounterId:function(){return scope.qosFilterObj.encounterID},patientIdentifiers:function(){return scope.patientIdentifiers}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){if(modalInstanceResponse!=null){try{rxObj.strength=modalInstanceResponse.RxEditDefaultStrengthValue;rxObj.formulation=modalInstanceResponse.RxEditDefaultFormulationValue;rxObj.take=modalInstanceResponse.RxEditDefaultTakeValue;rxObj.route=modalInstanceResponse.RxEditDefaultRouteValue;rxObj.freq=modalInstanceResponse.RxEditDefaultFrequencyValue;rxObj.duration=modalInstanceResponse.RxEditDefaultDurationValue;rxObj.dispense=modalInstanceResponse.RxEditDefaultDispenseValue;scope.selectDosage(index)}catch(e){console.log("Error while aplying Dosage")}}})})};scope.favRxSelected=false;scope.showFavRx=function(){scope.nLeftArrowEnable=0;scope.nRightArrowEnable=0;favStartCount=0;totalFavRxRecords=0;if(scope.favRxSelected){scope.favRxSelected=false;scope.getSearchResult()}else{$('.second-level'+'.'+scope.topClass).addClass("hide");scope.favRxSelected=true;$("#quick-search"+scope.topClass).addClass("open");$(".first-levelMedRec").removeClass("hide");scope.favRxList=[];scope.getFavRx()}};scope.backButtonHandler=function(e){$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).removeClass('hide');$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).addClass('hide')};$(document).on('click','.second-level .icon-back',scope.backButtonHandler);scope.updateDrugDBDefault=function(id){var userProfileKeyValPair={};userProfileKeyValPair["DefaultDrugDBLookUp"]=id;updateUserProfileLocalCache("DefaultDrugDBLookUp",id);saveUserProfileSettings(userProfileKeyValPair)};scope.RxDefaultListTypeId.id=getUserProfile("DefaultDrugDBLookUp");if(getUserProfile("RxDosagesOption")!==''){scope.RxDefaultDosesTypeId=getUserProfile("RxDosagesOption");if(scope.RxDefaultDosesTypeId==='3'||scope.RxDefaultDosesTypeId===3){scope.RxDefaultDosesTypeId=2}}scope.favRxList=[];perPageCount=scope.qosFilterObj.nRxListCount;scope.getFavRx=function(){var url="";if(scope.b_MedispanEnabled=="yes"){if(typeof scope.qosFilterObj.AsmtID!="undefined"){url="/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/getFavRxJsonList.jsp?id="+scope.RxDefaultListTypeId.id+"&xmlRoot=Rx&itemName="+scope.searchText.name+"&rootNode=1&counter="+(favStartCount+1)+"&MAXCOUNT="+perPageCount+"&obsolete=-1&encid="+scope.qosFilterObj.encounterID+"&searchtype="+scope.rxSearchTypeText+"&multumDoses=0&assessId="+scope.qosFilterObj.AsmtID+"&g_MedispanEnabled=true&calledFrom=QuickSearch&SearchType="+scope.qsFilterObj.RxDrugSearchType}else{url="/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/getFavRxJsonList.jsp?id="+scope.RxDefaultListTypeId.id+"&xmlRoot=Rx&itemName="+scope.searchText.name+"&rootNode=1&counter="+(favStartCount+1)+"&MAXCOUNT="+perPageCount+"&obsolete=-1&encid="+scope.qosFilterObj.encounterID+"&searchtype="+scope.rxSearchTypeText+"&multumDoses=0&assessId=-1&g_MedispanEnabled=true&calledFrom=QuickSearch&SearchType="+scope.qsFilterObj.RxDrugSearchType}}else{if(typeof scope.qosFilterObj.AsmtID!="undefined"){url="/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/getFavRxJsonList.jsp?keyName=Rx&xmlRoot=Rx&itemName="+scope.searchText.name+"&rootNode=1&counter="+(favStartCount+1)+"&MAXCOUNT="+perPageCount+"&obsolete=-1&encid="+scope.qosFilterObj.encounterID+"&searchtype="+scope.rxSearchTypeText+"&assessId="+scope.qosFilterObj.AsmtID+"&gMedispanEnabled=false"}else{url="/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/getFavRxJsonList.jsp?keyName=Rx&xmlRoot=Rx&itemName="+scope.searchText.name+"&rootNode=1&counter="+(favStartCount+1)+"&MAXCOUNT="+perPageCount+"&obsolete=-1&encid="+scope.qosFilterObj.encounterID+"&searchtype="+scope.rxSearchTypeText+"&assessId=-1&gMedispanEnabled=false"}}url=makeURL(url+"&RxType=1&loggedInUserName="+global.TrUserName);var promise=$http.get(url);promise.then(function(payload){if(payload.data.rxTotalDoses){totalFavRxRecords=parseInt(payload.data.rxTotalDoses,10);scope.favRxList=payload.data.rxDoseArray;setFavLeftAndRight()}},function(e){console.log(e)})};function setFavLeftAndRight(){if(!scope.favRxSelected){return}scope.nLeftArrowEnable=0;scope.nRightArrowEnable=0;if(totalFavRxRecords<0){return}if(favStartCount>0){scope.nLeftArrowEnable=1}if(favStartCount+perPageCount<totalFavRxRecords){scope.nRightArrowEnable=1}}function handleFavLeftRightClick(navigateType){if(navigateType==='right'){if(favStartCount+perPageCount<totalFavRxRecords){favStartCount+=perPageCount;scope.getFavRx()}return}if(navigateType==='left'){if(favStartCount>0){favStartCount-=perPageCount;scope.getFavRx()}return}}scope.addWithoutSig=function(){var obj={};obj.name=scope.qosResultObj.resultSet.sItemName;if(scope.b_MedispanEnabled=="no"){obj.supplierID=scope.qosResultObj.resultSet.sSupplierId}else{obj.supplierID=scope.qosResultObj.resultSet.sDrugNameId}obj.DrugNameId=obj.supplierID;obj.itemID=scope.qosResultObj.resultSet.nItemId;obj.strength="";obj.formulation="";obj.route="";obj.take="";obj.freq="";obj.duration="";if(scope.checkIsCompoundDrug(scope.qosResultObj.resultSet.isCompound)){obj.dispense=scope.dosageResultSet[0].dispense}else{obj.dispense=""}obj.refills="";obj.ndc="";obj.controlledCode="";obj.controlled="";obj.IsRxSupplies="";obj.favorite="";obj.awup="";obj.MMDCode="";scope.dosageResultSet.push(obj);scope.selectDosage(scope.dosageResultSet.length-1)};scope.filterObj={start:0,end:scope.qosFilterObj.nRxListCount};scope.makeRange=function(){if(scope.favRxSelected){return}var resultSet=[];if(scope.searchResult.length>scope.filterObj.end){scope.nRightArrowEnable=1}else{scope.nRightArrowEnable=0}if(scope.filterObj.start>=scope.qosFilterObj.nRxListCount){scope.nLeftArrowEnable=1}else{scope.nLeftArrowEnable=0}if(typeof scope.searchResult!='undefined'&&scope.searchResult.length>0){for(var i=scope.filterObj.start;i<scope.searchResult.length&&i<scope.filterObj.end;i++){resultSet.push(scope.searchResult[i])}}return resultSet};scope.navigateQuickOrderResults=function(buttonType){if(scope.favRxSelected){handleFavLeftRightClick(buttonType);return}if(buttonType=='left'){scope.filterObj.start=scope.filterObj.start-scope.qosFilterObj.nRxListCount;scope.filterObj.end=scope.filterObj.end-scope.qosFilterObj.nRxListCount}if(buttonType=='right'){scope.filterObj.start=scope.filterObj.start+scope.qosFilterObj.nRxListCount;scope.filterObj.end=scope.filterObj.end+scope.qosFilterObj.nRxListCount}$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).addClass('hide');$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).removeClass('hide')};scope.$on('$destroy',function(){try{$(document).off('click','.second-level .icon-back',scope.backButtonHandler);$(document).off('click','.peach-header .icon-blackreferal',scope.switchToReferalSearch);$(document).off('click','.second-level .icon-back',scope.backButtonHandler);$(document).off('keyup','#quick-search'+scope.topClass+' > input[type="text"]',scope.OnKeyUpQuickSearch);$(document).off('click','.third-level .icon-back',scope.enableThirdLevel);$(document).off('click','.quick-menu-MedRec',scope.documentClickOnQuickMenuMedRec);$(document).off('click',scope.documentOnClick);$(document).off('click','.second-level'+'.'+scope.topClass,scope.documentClickSecondLevel);isLoading=null;clearTimeout(timer);$('ul.rtbcEligDivQuick li.dropdown').off("mouseenter");$('ul.rtbcEligDivQuick li.dropdown').off("mouseleave");removeScopePropertyAndMethod(scope)}catch(e){}});$("#pn-chief").modal();scope.switchToReferalSearch=function(){if($(this).hasClass('active')){$('#quick-search'+scope.topClass).removeClass('active');$('#referal-search').addClass('active')}else{$('#quick-search'+scope.topClass).addClass('active');$('#referal-search').removeClass('active')}};$(document).on('click','.peach-header .icon-blackreferal',scope.switchToReferalSearch);scope.OnKeyUpQuickSearch=function(e){$('.first-level'+'.'+scope.topClass).removeClass('hide');if($(this).val()==''&&!$('#favStar').hasClass('active')){$(this).parent().removeClass('open')}else{$(this).parent().addClass('open')}};$(document).on('keyup','#quick-search'+scope.topClass+' > input[type="text"]',scope.OnKeyUpQuickSearch);scope.enableThirdLevel=function(e){$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).removeClass('hide');$('#quick-search'+scope.topClass+' .third-level'+'.'+scope.topClass).addClass('hide')};$(document).on('click','.third-level .icon-back',scope.enableThirdLevel);scope.documentOnClick=function(e){if(e.target.id!='right-nag-button'&&e.target.id!='left-nag-button'&&e.target.id!='right-nag-div'&&e.target.id!='left-nag-div'&&e.target.id!='btnDuplicatedDialogYes'&&e.target.id!='searchBox'+scope.topClass){$('#right-nag-button').addClass('disabled');$('#right-nag-div').addClass('disabled');$('#left-nag-button').addClass('disabled');$('#left-nag-div').addClass('disabled');$('.quick-menu-MedRec > div').addClass('hide')}};$(document).on('click',scope.documentOnClick);scope.documentClickOnQuickMenuMedRec=function(e){e.stopPropagation()};$(document).on('click','.quick-menu-MedRec',scope.documentClickOnQuickMenuMedRec);scope.documentClickSecondLevel=function(e){e.stopPropagation()};$(document).on('click','.second-level'+'.'+scope.topClass,scope.documentClickSecondLevel);scope.quickSearchMedRecDestroy=function(){scope.$destroy()};scope.$on('saveToTelEncFromRtbc',function(e,obj){if(scope.isRtbcServiceEnabled){scope.saveRxData(obj)}});scope.saveRxData=function(rxObject,rxObjIndex){if(!bAlreadyCalledInventory&&scope.bDispenseInventoryLinkEnabled){scope.isInventoryProduct(rxObject,rxObjIndex);return}if(scope.m_bAllergyInteraction){scope.CheckAllergyInteraction(rxObject,rxObjIndex);return}else{scope.m_bAllergyInteraction=true}bAlreadyCalledInventory=false;if(scope.qosFilterObj.parentName==="TelEncounter"){var telScope=angular.element(document.querySelector('[id=TJellyDetailViewid]')).scope();if(telScope&&!telScope.isTelLockMine()){scope.setSearchResultObjWrapperCall();return}}if(scope.qosFilterObj.parentName==="TelEncounter"||scope.qosFilterObj.parentName==="RxHistory"||scope.qosFilterObj.parentName==="ExtRxHistory"||scope.qosFilterObj.parentName==="Unreconcile Meds"||scope.qosFilterObj.context==="FHIRTreatment"){var xw=new XMLWriter;startSoapPacket(xw);xw.writeStartElement('return');xw.writeStartElement('items');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('item');xw.writeAttributeString('xsi:type','xsd:string');if(rxObject.isRtbcRxObject){if(rxObject.ItemId){addElement(xw,"id",rxObject.ItemId,'xsi:type','xsd:int')}else if(rxObject.itemID){addElement(xw,"id",rxObject.itemID,'xsi:type','xsd:int')}}else{addElement(xw,"id",scope.itemIdToSaveRx,'xsi:type','xsd:int')}if(scope.qosFilterObj.context==="FHIRTreatment"&&scope.qosFilterObj.hasOwnProperty("doctorsFlagFromFHIR")){addElement(xw,"doctorFlag",scope.qosFilterObj.doctorsFlagFromFHIR,'xsi:type','xsd:int')}else{addElement(xw,"doctorFlag",'1','xsi:type','xsd:int')}addElement(xw,"AssessId",0,'xsi:type','xsd:int');xw.writeStartElement('properties');xw.writeStartElement('property');addElement(xw,"id",scope.strengthId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.strength+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.formulationId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.formulation+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.takeId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.take+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.routeId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.route+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.frequencyId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.freq+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.durationId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.duration+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.dispenseId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.dispense+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeStartElement('property');addElement(xw,"id",scope.refillsId,'xsi:type','xsd:int');addElement(xw,"value","<![CDATA["+rxObject.refills+"]]>",'xsi:type','xsd:string');xw.writeEndElement();xw.writeEndElement();addElement(xw,"GBO","U",'xsi:type','xsd:string');addElement(xw,"FormularyStatus","",'xsi:type','xsd:string');if(scope.b_MedispanEnabled==="no"){addElement(xw,"MMDCode","",'xsi:type','xsd:string')}else{addElement(xw,"MMDCode",rxObject.MMDCode,'xsi:type','xsd:string')}if(rxObject.hasOwnProperty("ndc"))addElement(xw,"NDCCode",rxObject.ndc,'xsi:type','xsd:string');else addElement(xw,"NDCCode",'','xsi:type','xsd:string');if(bSaveAsInventoryProduct&&scope.bDispenseInventoryLinkEnabled){addElement(xw,"InvProductId",rxObject.InvProductId,'xsi:type','xsd:string');bSaveAsInventoryProduct=false}addElement(xw,"FormularyId","",'xsi:type','xsd:string');addElement(xw,"PayerSourceName","",'xsi:type','xsd:string');addElement(xw,"BrandCode","",'xsi:type','xsd:string');addElement(xw,"SymID","",'xsi:type','xsd:string');try{if(angular.isUndefined(rxObject.startDate)||rxObject.startDate==='')addElement(xw,"StartDate",$filter('date')(new Date,'yyyy/MM/dd'),'xsi:type','xsd:string');else addElement(xw,"StartDate",rxObject.startDate,'xsi:type','xsd:string')}catch(e){}var sStopDt="";try{if(rxObject.stopDate===undefined||rxObject.stopDate===''||rxObject.stopDate===null||rxObject.stopDate==='null'){if(rxObject.isRtbcRxObject){if(rxObject.ItemId){sStopDt=rxService.calculateStopDate(rxObject.ItemId,$filter('date')(new Date,'yyyy/MM/dd'),rxObject.duration,rxObject.refills,"yyyy-mm-dd")}else if(rxObject.itemID){sStopDt=rxService.calculateStopDate(rxObject.itemID,$filter('date')(new Date,'yyyy/MM/dd'),rxObject.duration,rxObject.refills,"yyyy-mm-dd")}}else{sStopDt=rxService.calculateRxStopDateWithBlank(rxObject,scope.qosResultObj.resultSet.nItemId)}}else{sStopDt=rxObject.stopDate}}catch(e){}addElement(xw,"StopDate",sStopDt,'xsi:type','xsd:string');var preparedBy=global.TrUserName+" "+$filter('date')(new Date,'yyyy/MM/dd');addElement(xw,"PreparedBy","<![CDATA["+preparedBy+"]]>",'xsi:type','xsd:string');addElement(xw,"RxOrderNo","",'xsi:type','xsd:string');if(trimContent(rxObject.isRxKOP)===""){rxObject.isRxKOP='No'}addElement(xw,"rxKOP",rxObject.isRxKOP,'xsi:type','xsd:string');addElement(xw,"rxDrugSource","",'xsi:type','xsd:string');addElement(xw,"awp","",'xsi:type','xsd:string');addElement(xw,"awup","",'xsi:type','xsd:string');addElement(xw,"OldRxMainId","",'xsi:type','xsd:string');try{if(angular.isUndefined(rxObject.RxSource)){addElement(xw,"rxSource","<![CDATA["+global.TrUserName+"]]>",'xsi:type','xsd:string')}else{addElement(xw,"rxSource","<![CDATA["+rxObject.RxSource+"]]>",'xsi:type','xsd:string')}if(angular.isUndefined(rxObject.RxSourceID)){addElement(xw,"rxSourceId",global.TrUserId,'xsi:type','xsd:int')}else{addElement(xw,"rxSourceId",rxObject.RxSourceID,'xsi:type','xsd:int')}if(angular.isUndefined(rxObject.RxEditNotesValue)){addElement(xw,"rxNotes","",'xsi:type','xsd:string')}else{addElement(xw,"rxNotes","<![CDATA["+rxObject.RxEditNotesValue+"]]>",'xsi:type','xsd:string')}}catch(e){}addElement(xw,"RxAdditionalNotes","<![CDATA["+trimContent(rxObject.RxAdditionalNotes)+"]]>",'xsi:type','xsd:string');addElement(xw,"AdditionalInstructions","<![CDATA["+trimContent(rxObject.AddInstructions)+"]]>",'xsi:type','xsd:string');addElement(xw,"daw",trimContent(rxObject.daw)==='1'?1:0,'xsi:type','xsd:int');if(angular.isUndefined(rxObject.PharmacyNCPDPId)){addElement(xw,"PharmacyNCPDPId",trimContent(rxObject.pharmacyNCPDPId),'xsi:type','xsd:int')}else{addElement(xw,"PharmacyNCPDPId",trimContent(rxObject.PharmacyNCPDPId),'xsi:type','xsd:int')}addElement(xw,"pharmacyId",trimContent(rxObject.pharmacyId),'xsi:type','xsd:int');addElement(xw,"encounterId",trimContent(scope.qosFilterObj.encounterID),'xsi:type','xsd:string');if(rxObject.isRtbcRxObject){addElement(xw,"rtbcRxFlag","<![CDATA["+rxObject.isRtbcRxObject+"]]>",'xsi:type','xsd:string');if(rxObject.description){addElement(xw,"rtbcDrugName","<![CDATA["+rxObject.description+"]]>",'xsi:type','xsd:string')}if(rxObject.pharmacyNCPDPId){addElement(xw,"rtbcPharmNCPDP","<![CDATA["+rxObject.pharmacyNCPDPId+"]]>",'xsi:type','xsd:string')}if(rxObject.drugInteractionMsg){addElement(xw,"rtbcDrugIntMsg","<![CDATA["+rxObject.drugInteractionMsg+"]]>",'xsi:type','xsd:string')}addElement(xw,"rtbcDuration","<![CDATA["+rxObject.duration+"]]>",'xsi:type','xsd:string');addElement(xw,"rtbcDispense","<![CDATA["+rxObject.dispense+"]]>",'xsi:type','xsd:string');if(rxObject.patientPayAmt){addElement(xw,"rtbcPayAmt","<![CDATA["+rxObject.patientPayAmt+"]]>",'xsi:type','xsd:string')}if(rxObject.ePAFlag){addElement(xw,"rtbcEPAFlag","<![CDATA["+rxObject.ePAFlag+"]]>",'xsi:type','xsd:string')}if(rxObject.serviceCodeDUR){addElement(xw,"rtbcServiceCodeDUR","<![CDATA["+rxObject.serviceCodeDUR+"]]>",'xsi:type','xsd:string')}if(rxObject.pharmacyName){addElement(xw,"rtbcPharmacyName","<![CDATA["+rxObject.pharmacyName+"]]>",'xsi:type','xsd:string')}if(rxObject.isAlternatePharmacy){addElement(xw,"rtbcAlternatePharmacyFlag","<![CDATA["+rxObject.isAlternatePharmacy+"]]>",'xsi:type','xsd:string')}if(rxObject.isAlternateMedication){addElement(xw,"rtbcAlternateMedicationFlag","<![CDATA["+rxObject.isAlternateMedication+"]]>",'xsi:type','xsd:string')}}if(doseCheckEnabled()&&rxObject.doseCheckData){rxObject.doseCheckData.itemId=rxObject.ItemId;rxObject.doseCheckData.ndcCode=rxObject.ndc;var doseCheckData=JSON.stringify(rxObject.doseCheckData);addElement(xw,"doseCheckData","<![CDATA["+doseCheckData+"]]>",'xsi:type','xsd:string')}xw.writeEndElement();xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);var xml=xw.flush();var param="";if(scope.qosFilterObj.parentName=="TelEncounter"){param="EncounterId="+scope.qosFilterObj.encounterID+"&AsmtId=0&type=ModernRx&FormData="+encodeURIComponent(xml)}else{param="EncounterId="+scope.qosFilterObj.encounterID+"&type=ModernRx&FormData="+encodeURIComponent(xml)}if(scope.dosageResultSet[scope.selectedIndex].isSplitPharmacy){rxService.saveSplitPrescription(scope.qosFilterObj.encounterID,scope.dosageResultSet[scope.selectedIndex].splitRx.assessId,scope.dosageResultSet[scope.selectedIndex].splitRx)}$.ajax({type:"POST",url:makeURL("/mobiledoc/jsp/catalog/xml/rx/saveRx.jsp"),data:param,success:function(msg){if(msg.length>0&&msg.indexOf("failed")<0){$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).addClass('hide');$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).addClass('hide');$("#searchBox"+scope.topClass).trigger("focus")}else{ecwAlert("Sorry, order did not get added")}scope.selectedIndex=-1;if(scope.qosFilterObj.context==="FHIRTreatment"){scope.$parent.meic.FHIRIObjSelectedRxName=scope.qosResultObj.resultSet.sItemName}scope.setSearchResultObjWrapperCall();if(rxObjIndex){scope.pushRxForDuplicateCheck(rxObjIndex)}},error:function(xhr){console.log("An error occured: "+xhr.status+" "+xhr.statusText)}})}else{if(typeof scope.qosResultObj.resultSet!='undefined'){scope.qosResultObj.resultSet.sItemName=scope.selectedRxName;if(scope.b_DrugDbEnabled==='yes'){scope.qosResultObj.resultSet.nItemId=scope.selectedRxItemId}scope.qosResultObj.resultSet.AddInstructions=rxObject.AddInstructions;scope.qosResultObj.resultSet.DAW=rxObject.daw;scope.qosResultObj.resultSet.ItemId=scope.qosResultObj.resultSet.nItemId;scope.qosResultObj.resultSet.nItemId=scope.qosResultObj.resultSet.nItemId;scope.qosResultObj.resultSet.strength=rxObject.strength;scope.qosResultObj.resultSet.formulation=rxObject.formulation;scope.qosResultObj.resultSet.route=rxObject.route;scope.qosResultObj.resultSet.take=rxObject.take;scope.qosResultObj.resultSet.freq=rxObject.freq;scope.qosResultObj.resultSet.daw=rxObject.daw;if('currMed'===scope.qosFilterObj.parentName){scope.qosResultObj.resultSet.NotesValue=rxObject.RxEditNotesValue;scope.qosResultObj.resultSet.rxSource=rxObject.RxSource;scope.qosResultObj.resultSet.rxSourceID=rxObject.RxSourceID;scope.qosResultObj.resultSet.startDate=rxObject.startDate;scope.qosResultObj.resultSet.stopDate=rxObject.stopDate}if('currMed'===scope.qosFilterObj.parentName||'OrderRxWidgetUpdateRx'===scope.qosFilterObj.parentName){if(getItemKeyValue('hideDDRinRxEditForMedRec').toLowerCase()==='no'){scope.qosResultObj.resultSet.duration=rxObject.duration;scope.qosResultObj.resultSet.dispense=rxObject.dispense;scope.qosResultObj.resultSet.refills=rxObject.refills}else{scope.qosResultObj.resultSet.duration="";if(scope.checkIsCompoundDrug(scope.qosResultObj.resultSet.isCompound)){scope.qosResultObj.resultSet.dispense=rxObject.dispense}else{scope.qosResultObj.resultSet.dispense=""}scope.qosResultObj.resultSet.refills=""}}else{scope.qosResultObj.resultSet.duration=rxObject.duration;scope.qosResultObj.resultSet.dispense=rxObject.dispense;scope.qosResultObj.resultSet.refills=rxObject.refills}scope.qosResultObj.resultSet.ndc=rxObject.ndc;scope.qosResultObj.resultSet.controlledCode=rxObject.controlledCode;scope.qosResultObj.resultSet.controlled=rxObject.controlled;scope.qosResultObj.resultSet.IsRxSupplies=rxObject.IsRxSupplies;scope.qosResultObj.resultSet.favorite=rxObject.favorite;scope.qosResultObj.resultSet.awup=rxObject.awup;if(scope.b_MedispanEnabled=="no"){scope.qosResultObj.resultSet.MMDCode=""}else{scope.qosResultObj.resultSet.MMDCode=rxObject.MMDCode}if(doseCheckEnabled()){scope.qosResultObj.resultSet.doseCheckData=rxObject.doseCheckData}scope.pushRxForDuplicateCheck(rxObjIndex)}$('#quick-search'+scope.topClass+' .first-level'+'.'+scope.topClass).addClass('hide');$('#quick-search'+scope.topClass+' .second-level'+'.'+scope.topClass).addClass('hide');$("#searchBox"+scope.topClass).trigger("focus");scope.setSearchResultObjWrapperCall(scope.qosResultObj.resultSet.ItemId,scope.qosResultObj.resultSet.ndc,scope.qosResultObj.resultSet.strength,scope.qosResultObj.resultSet.formulation)}};function trimContent(text){if(!angular.isDefined(text)){return""}if(null===text){return""}return String.prototype.trim.call(text)}scope.setSearchResultObjWrapperCall=function(itemId,ndcCode,strength,formulation){if((scope.isCalledFrom==='renewalRequest'||scope.isCalledFrom==='changeRequest')&&!checkUndefinedOrNullOrBlank(itemId,false)){var url='/mobiledoc/emr/medication/populateCustomRxNDCAndItemId?itemId='+itemId+"&ndcCode="+trimContent(ndcCode)+"&strength="+trimContent(strength)+"&formulation="+trimContent(formulation);url=makeURL(url);$http({method:'POST',url:url,headers:{'Content-Type':'application/json'},data:{}}).then(function(data){if(!checkUndefinedOrNullOrBlank(data.data)){scope.qosResultObj.resultSet.ItemId=data.data.itemId;scope.qosResultObj.resultSet.nItemId=data.data.itemId;scope.qosResultObj.resultSet.ndc=data.data.ndcCode}scope.setSearchResultObj()})}else{scope.setSearchResultObj()}};scope.showIconForDiscontinuedRx=function(dose,selectedObject){try{if(scope.showDiscontinuedDrugs===0){scope.showDiscontinuedRxIcon=false;dose.showIcon=false;return false}else{if(dose.hasOwnProperty('ObsoleteDate')){if(dose.ObsoleteDate!==''){if(dose.hasOwnProperty("IsRxSupplies")&&angular.$$lowercase(dose.IsRxSupplies)==='no'){scope.showDiscontinuedRxIcon=true;dose.showIcon=true;return true}else{dose.showIcon=false;return true}}else{dose.showIcon=false;return false}}if(scope.b_MedispanEnabled==="no"){if(scope.formularyInfo.hasOwnProperty("FormularySourceCode")&&scope.formularyInfo.FormularySourceCode!==""){if(dose.hasOwnProperty("brand_code")&&dose.hasOwnProperty("synonymid")&&dose.brand_code===dose.synonymid){if(selectedObject.hasOwnProperty('isObsolete')&&selectedObject.isObsolete==='T'){scope.showDiscontinuedRxIcon=true;dose.showIcon=true;return true}else{dose.showIcon=false;return false}}dose.showIcon=false;return false}else{if(selectedObject.hasOwnProperty('isObsolete')&&selectedObject.isObsolete==='T'){scope.showDiscontinuedRxIcon=true;dose.showIcon=true;return true}dose.showIcon=false;return false}}}}catch(e){}};scope.setIconForFavRx=function(index){try{return!!(scope.showDiscontinuedDrugs===-1&&(scope.favRxList[index].hasOwnProperty('ObsoleteDate')&&scope.favRxList[index].ObsoleteDate!==''))}catch(e){}}}};function getKeyLength(object){var count=0;for(var property in object){if(object.hasOwnProperty(property)){count++;break}}return count}});
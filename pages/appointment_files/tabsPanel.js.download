var tabsModule=angular.module('tabModule',['oc.lazyLoad','ecw.service.EncDetailsService','StandingOrdersDirective','QuickSearchDirective','oc.lazyLoad','evaFavorite','RxHelper','patientQuickEnrollmentDirective','ecw.service.PSAC']);tabsModule.controller('tabspanelController',function($rootScope,$scope,$http,$window,EncDetailsService,$ocLazyLoad,$timeout,$attrs,evaFavoriteService,$modal,rxService,editPastPNFactory,PSACService,PNService){$scope.$on("$destroy",function(){try{$(".main-cont").unbind();$('ul#encDropDownList').unbind('scroll')}catch(err){}});var encounterId="";var patientId="";var userId="";var tabAction="";var accessOBLogFlag="";var currentPage="";var pregid="";var isPatientPSAC=-1;let loadedPagesTabs=[];let detailsTabs={noOfRecords:0,totalPages:0,rowsPerPage:20,currentPage:0,currentIndex:0};let encObj_tab={};var tabsAttrJson=$attrs.tabsAttrJson;if(tabsAttrJson){var tabsAttrJsonObj=JSON.parse(tabsAttrJson);encounterId=tabsAttrJsonObj.encounterId?tabsAttrJsonObj.encounterId:"";patientId=tabsAttrJsonObj.patientId?tabsAttrJsonObj.patientId:"";$scope.quickEnrollPatientId=parseInt(patientId,10);userId=tabsAttrJsonObj.userId?tabsAttrJsonObj.userId:"";tabAction=tabsAttrJsonObj.tabAction?tabsAttrJsonObj.tabAction:"";pregid=tabsAttrJsonObj.pregid?tabsAttrJsonObj.pregid:"";accessOBLogFlag=tabsAttrJsonObj.accessOBLogFlag?tabsAttrJsonObj.accessOBLogFlag:"";currentPage=tabsAttrJsonObj.currentPage?tabsAttrJsonObj.currentPage:""}$scope.enableWVIndicator=getItemKeyValue("EnableWVIndicator").toLowerCase()==="yes";$scope.isScribeHaveUnsavedNotes=function(){if($scope.tabSelected&&$scope.tabSelected.scribe===false){setTimeout(function(){$.ajax({url:'/mobiledoc/jsp/catalog/xml/unsavedScribeNotesExist.jsp?encounterId='+encounterId+'&TrUserId='+userId,type:'GET',"async":false,success:function(response){if(response.trim()==="1"){$scope.unsavedScribeNotes=true}else{$scope.unsavedScribeNotes=false}},error:function(){$scope.unsavedScribeNotes=false}})})}};$scope.loadAllEncounters=function(){if(isSupportsLocalStorage()){let key='loadAllEncPtList_'+$scope.patientId;if(!containsKey(key)){put(key,'')}}loadPatientEncounterListInAsyncManner(true)};function fetchPatientEncounterList(isMyFacilityOnly,isLoadAll){let action=isLoadAll?'optimizedpnencdropdownAll':'optimizedpnencdropdown';let url='/mobiledoc/jsp/catalog/xml/getPtEncounters.jsp?PatientId='+$scope.patientId+'&selEncId='+$scope.encounterId+'&callingfor='+action+'&WebPortalEnabled='+getWebEnableFlag();if(isMyFacilityOnly){url=url+'&isMyFac=1'}return $http.post(makeURL(url))}let previousScroll=0;function parseAndDisplayEncounterList(data){let dataValue=loadPatientEncounterList(data,$scope.encounterId);$scope.encLoaded.top=false;$scope.encLoaded.bottom=false;$scope.patientEncounters=dataValue.encounters;$scope.patientEncDropDownList=dataValue.firstListEnc;editPastPNFactory.data=[...$scope.patientEncounters];$scope.currentEnc.encounterId=dataValue.encounterId;$scope.currentEnc.val=dataValue.currVal;$scope.currentEnc.imgVal=dataValue.currImgSrc;$scope.currentEnc.index=detailsTabs.currentIndex;$scope.addPreviousElements();$scope.addNextElements();$scope.encLoaded.dropDown=true;if($scope.patientEncounters.length<=0){$scope.pnEncListCaption="No Encounters";$scope.hasData=false}if(detailsTabs.noOfRecords>detailsTabs.rowsPerPage){$timeout(function(){$('ul#encDropDownList').unbind('scroll');$('ul#encDropDownList').bind('scroll',function(){let currentScroll=$(this).scrollTop();if(currentScroll>previousScroll){$timeout(function(){$scope.$apply(function(){$scope.addNextElements()})},0)}else{$timeout(function(){$scope.$apply(function(){$scope.addPreviousElements()})},0)}previousScroll=currentScroll})},0)}}function isLoadAllEnc(patientId){let key='loadAllEncPtList_'+patientId;if(isSupportsLocalStorage()&&containsKey(key)){return true}return false}function renderPatientEncounterList(isMyFacilityOnly,isForcedLoadAll){let isLoadAll=isForcedLoadAll||isLoadAllEnc($scope.patientId);fetchPatientEncounterList(isMyFacilityOnly,isLoadAll).success(function(data){$scope.isAllEncLoad=isLoadAll;parseAndDisplayEncounterList(data)}).error(function(data){ecwAlert("Sorry! We were not able to load the encounter list for this patient.")})}function getWebEnableFlag(){return parseIntVal(parseIntVal(getItemKeyValue('EnableWebPortal',true)))}function loadPatientEncounterListInAsyncManner(isLoadAll){$scope.encLoaded.dropDown=false;let allowFacilityBasedFilter=getUserProfile('EnableFacilityBasedFilter');if(isSupportsLocalStorage()&&parseIntVal(allowFacilityBasedFilter)===1&&parseIntVal($scope.patientId)!==parseIntVal(getItemKeyValue('TemplatePatientId',true))){$scope.allowFacilityBasedFilter=true;if(!containsKey('loggedInInfo')){let info=getLoggedInInfo();put("loggedInInfo",JSON.stringify(info))}let info=JSON.parse(get('loggedInInfo'));if(info.facilityFilter==="All"){$scope.filter.type="My";$scope.filter.desc="Click here to show only Encounter(s) that belong to your Facility"}else{renderPatientEncounterList(true,isLoadAll);return}}renderPatientEncounterList(false,isLoadAll)}$scope.init=function(){$scope.showaddendum=false;$scope.currEncLock=false;$scope.encLoaded={top:false,bottom:false,dropDown:false};$scope.currentEnc={val:'',imgVal:'',index:0,encounterId:0};$scope.encounterId=encounterId;$scope.patientId=patientId;$scope.tabAction=tabAction;$scope.smartFormList=[];$scope.tabsDisable=true;$scope.pnEncListCaption="";$scope.hasMoreEncForPt=false;$scope.isAllEncLoad=false;$scope.hasData=true;$scope.unsavedScribeNotes=false;$scope.popupurl={value:''};$scope.allowFacilityBasedFilter=false;$scope.isEncounterConfidential=false;$scope.isPSACEnabled=isItemKeyEnabled('EnablePSAC');$scope.encounterConfidentialityTitle="Manage Encounter Confidentiality. \nThis encounter is NOT confidential.";$scope.filter={type:'All',desc:'Click here to show all Encounter(s). Currently only Encounter(s) that belong to your facility are listed here'};loadedPagesTabs=[];detailsTabs={noOfRecords:0,totalPages:0,rowsPerPage:20,currentPage:0,currentIndex:0};loadPatientEncounterListInAsyncManner();if($scope.tabAction=="progressNote"){PNService.setIsPNTab(true)}encObj_tab=EncDetailsService.getEncDetailsByEncId($scope.encounterId);var encTypeTabs=EncDetailsService.getEncounterType();var encLockTabs=EncDetailsService.getEncounterLock();if(encObj_tab.addendum)$scope.showaddendum=true;$scope.currEncLock=encObj_tab.encLock;$scope.isScribeHaveUnsavedNotes();$scope.currentEncVals={encLock:encLockTabs,encType:encTypeTabs};if(isPNTabView(encLockTabs,encTypeTabs)){$scope.tabsDisable=false}var nTrUserIdForQSDInPN=0;var nTrUserIdForQSDInPNFromJSVar=0;var nTrUserIdForQSD=0;try{nTrUserIdForQSDInPNFromJSVar=userId;nTrUserIdForQSD=userId;nTrUserIdForQSDInPN=$('#nTrUserIdForQSD').val();if(nTrUserIdForQSDInPNFromJSVar!=undefined&&nTrUserIdForQSDInPNFromJSVar>0){nTrUserIdForQSD=nTrUserIdForQSDInPNFromJSVar}else if(nTrUserIdForQSDInPN!=undefined&&nTrUserIdForQSDInPN>0){nTrUserIdForQSD=nTrUserIdForQSDInPN}}catch(e){console.log("------------------------------------------------------------------------------");console.log("Error loading QS Directive in PN : Get TrUserId ");console.log(e);console.log("------------------------------------------------------------------------------")}$scope.encDtForTreatmentScreen={nPatientId:$scope.patientId,nTrUserId:nTrUserIdForQSD,nEncounterId:$scope.encounterId,nDoctorId:EncDetailsService.getProviderId()};$scope.PNQSDetailsReqObj=$scope.encDtForTreatmentScreen;$scope.PNQSDetailsReqObj.sContext="PNscreen";$scope.PNQSDetailsReqObj.nDxItemId=0;$scope.PNQSDetailsReqObj.sActionType="";$scope.PNQSDetailsResponseObj=[];$scope.PNQSDetailsResponseObj.obj=[];$scope.setPNQSDetailsObj=[];$scope.angVisitType=encObj_tab.pregnancyVisitFlag;$scope.physicaltherapyVisitType=getItemKeyValue("EnablePhysicalTherapyVisit").toLowerCase()==="yes"&&encObj_tab.physicalTherapyVisitFlag;$scope.setPNQSDetailsFromPn=function(pNQSDetailsResponseObj){$scope.PNQSDetailsResponseObj=pNQSDetailsResponseObj;$scope.setPNQSDetails()};$scope.setPNQSDetails=function(){var sRequestType=$scope.PNQSDetailsResponseObj.obj.sRequestType;if(sRequestType=='neworder'){if($scope.tabAction=="progressNote"){$scope.pdmpEnable=getItemKeyValue('EnablePDMP').toLowerCase()=="yes";$scope.pdmpActive=getItemKeyValue('IsPDMPActive').toLowerCase()=="yes";$scope.pdmpEnableForBottomPanel=getItemKeyValue('EnablePDMPForBottomPanel').toLowerCase()=="yes";if($scope.pdmpEnable===true&&$scope.pdmpActive===true&&$scope.pdmpEnableForBottomPanel===true){var bottomScope=angular.element(document.getElementById('bottomPanelApp')).scope();if(bottomScope&&bottomScope!=null){bottomScope.checkPdmpColorAlertStatus($scope.encounterId)}}if($scope.PNQSDetailsResponseObj&&$scope.PNQSDetailsResponseObj.obj&&$scope.PNQSDetailsResponseObj.obj.selectedOrderItemKeyName){if($scope.PNQSDetailsResponseObj.obj.selectedOrderItemKeyName.toLowerCase()==='rx'||$scope.PNQSDetailsResponseObj.obj.selectedOrderItemKeyName.toLowerCase()==='rxmedispan'||$scope.tabSelected&&$scope.tabSelected.orders&&$scope.PNQSDetailsResponseObj.obj.selectedOrderItemKeyName.toLowerCase()==='cptcodes'&&$scope.PNQSDetailsResponseObj.obj.selectedOrderItemType.toLowerCase()==='injections'){$scope.loadRxInteractionSeverity();$scope.PNQSDetailsResponseObj.obj.selectedOrderItemKeyName=''}}else{$scope.loadRxInteractionSeverity()}refreshDashboard($scope.encounterId,$scope.patientId,$scope.tabAction,"")}else if($scope.tabAction=="order"){refreshOrderTab('onNewRx')}}};$scope.rxInteractionSeverity=0;$scope.nAllergyPopupLevel=0;$scope.m_bInteractionsProactive=false;$scope.initAllergyInteractionDefaultValues=function(){try{var InteractionsProactive=getUserProfile("EnableProactiveDrugInteraction");if(InteractionsProactive.length>0&&InteractionsProactive==="1"){$scope.m_bInteractionsProactive=true}$scope.nAllergyPopupLevel=getUserProfile("AllergyPopupLevel");$scope.nAllergyPopupLevel=parseInt($scope.nAllergyPopupLevel)}catch(e){ecwAlert("An error occurred while checking drug interaction, please try again later")}};$scope.initAllergyInteractionDefaultValues();$scope.isValidSeverityAndAllergyPopupLevel=function(){return $scope.rxInteractionSeverity===3||$scope.rxInteractionSeverity===2&&$scope.nAllergyPopupLevel<3||$scope.rxInteractionSeverity===1&&$scope.nAllergyPopupLevel<2};$scope.isAllowedDrugInteraction=function(){$scope.nAllergyPopupLevel=getUserProfile("AllergyPopupLevel");return $scope.m_bInteractionsProactive&&$scope.nAllergyPopupLevel>0&&$scope.isValidSeverityAndAllergyPopupLevel()};$scope.loadRxInteractionSeverity=function(){var severitycode=rxService.getDrugInteractionSeverity($scope.encounterId);severitycode.success(function(data){try{var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(!angular.isUndefined(jsonobj)&&jsonobj!==null){if(jsonobj.Envelope.Body['return'].hasOwnProperty("severity")){$scope.rxInteractionSeverity=jsonobj.Envelope.Body['return'].severity.severitycode;$scope.rxInteractionSeverity=parseInt($scope.rxInteractionSeverity);if($scope.isAllowedDrugInteraction()){$scope.drugInteraction()}}}}catch(e){ecwAlert("An error occurred while checking drug interaction, please try again later")}})};$scope.drugInteraction=function(){$ocLazyLoad.load({name:'drugInteraction',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/drugInteraction/drugInteractionController.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/drugInteraction/drugInteraction.jsp'),controller:'drugInteractionController',windowClass:'app-modal-window1 bluetheme',keyboard:false,backdrop:"static",resolve:{patientID:function(){return $scope.patientId},encounterID:function(){return $scope.encounterId},loginuserid:function(){return global.TrUserId},parentName:function(){return"Treatment"},itemIDNDCObj:function(){return{itemid:"",NDCCode:"",doctorsFlag:""}}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){if(modalInstanceResponse==="success"){if(document.querySelector('[id=orderTab]')&&angular.element(document.querySelector('[id=orderTab]'))){var parentScope=angular.element(document.querySelector('[id=orderTab]')).scope();if(parentScope&&parentScope.loadRxInteractionSeverity){parentScope.loadRxInteractionSeverity()}}}})})};$scope.bCCMREnabled=false;var ccmrItemKey={};getItemKeyValuePair("EnableCCMR",ccmrItemKey);if(ccmrItemKey.isExists&&ccmrItemKey.keyValue.toLowerCase()=="yes"){$scope.bCCMREnabled=true;$scope.showCCMRCurrApptBtn=encObj_tab.CCMRVisitFlag;$scope.cbCCMRFunc=function(encDetails){if(encDetails.action==="refreshDashboard")refreshDashboard($scope.encounterId,$scope.patientId,"progressNote","");else refreshFullDashboard($scope.encounterId,$scope.patientId,"progressNote",encDetails.lockStatus,encObj_tab.encType)};$scope.checkVisitForFutureEncounter=function(action){var encDate='';var encTime='';if(EncDetailsService.getEncDetails&&EncDetailsService.getEncDetails().encDate){encDate=EncDetailsService.getEncDetails().encDate;encTime=EncDetailsService.getEncDetails().encTime}encDate=convertDateInToFormat(encDate,"yyyy-mm-dd","mm-dd-yyyy");var diff=checkForFutureEncounter(encDate,encTime,'-');if(diff>0&&getUserConfiguration("ID_102")){let confirmMessage='The encounter is scheduled on future date: '+escapeHtml(encDate.replace(/-/g,"/"))+'. Are you sure you want to continue?';confirmMessage="<b>Progress Notes - Future Encounter Documentation</b></br></br>"+confirmMessage+"</br></br>Note: If the <b>encounter</b> is subsequently marked as a <b>no show, cancelled,</b> or <b>rescheduled,</b> any <b>Problem List, Diagnoses,</b> and <b>Orders</b> added in this encounter will <b>remain</b> in the <b>patientâ€™s medical record.</b>";$scope.callBackForFutureEncounter=function(promptResponse){if(promptResponse&&promptResponse.toLowerCase()==='yes'){$scope.progNoteCpBtn(action)}};showAlertMessage(confirmMessage,"","ConfirmMsg","callBackForFutureEncounter","tabspanelController","700px","Continue","Cancel")}else{$scope.progNoteCpBtn(action)}};$scope.progNoteCpBtn=function(action){if(action=="CCMRHub"){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs($scope,$ocLazyLoad).hubFromPN($scope.patientId,$scope.encounterId)},function(e){console.log(e)})}else if(action=="CreateVirtualVisit"){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs($scope,$ocLazyLoad).createVirtualVisitFromPN($scope.patientId)},function(e){console.log(e)})}else if(action=="CurrentAppointment"){$ocLazyLoad.load({name:'CcmrFuncs',files:['/mobiledoc/jsp/webemr/ccmr/js/ccmrFuncs.js']}).then(function(){CCMRFuncs($scope,$ocLazyLoad).currentAppointment($scope.patientId,$scope.encounterId)},function(e){console.log(e)})}}}$timeout(function(){adjustPNHeight();$(".main-cont").on("webkitTransitionEnd transitionend oTransitionEnd",function(event){if(event.originalEvent&&event.originalEvent.propertyName&&event.originalEvent.propertyName=="margin-left"){adjustPNHeight()}})},0)};$scope.addPreviousElements=function(){if(!$scope.encLoaded.top){var pageIndextop=getPrevPageToBeLoadedTabs();if(pageIndextop!==''){detailsTabs.currentPage=pageIndextop;loadedPagesTabs[detailsTabs.currentPage]={loaded:true};var startIndex=getStartIndex();var endIndex=getEndIndex();var encsPrev=getSplittedArray(startIndex,endIndex,$scope.patientEncounters);$scope.currentEnc.index=$scope.currentEnc.index+encsPrev.length;$scope.patientEncDropDownList=encsPrev.concat($scope.patientEncDropDownList)}else if(pageIndextop===''){$scope.encLoaded.top=true}}};$scope.addNextElements=function(){if(!$scope.encLoaded.bottom){var pageIndex=getNextPageToBeLoadedTabs();if(pageIndex!==''){detailsTabs.currentPage=pageIndex;loadedPagesTabs[detailsTabs.currentPage]={loaded:true};var startIndex=getStartIndex();var endIndex=getEndIndex();var encsNext=getSplittedArray(startIndex,endIndex,$scope.patientEncounters);$scope.patientEncDropDownList=$scope.patientEncDropDownList.concat(encsNext)}else if(pageIndex===''){$scope.encLoaded.bottom=true}}};$scope.scrollToLi=function(){if($scope.currentEnc.index!==0){$timeout(function(){let list=document.getElementById("encDropDownList"),targetLi=document.getElementById("encList_"+$scope.currentEnc.encounterId);list.scrollTop=targetLi.offsetTop-50},0)}};$scope.changeTab=function(tabName){setTabLoading(true);pnTabChanged=true;showHideTopAndRightPanelViewBasedOnUPS(tabName);var data='';var dashBoardControllerElement=$("#pnDashboard");var dashBoardControllerScope=angular.element(dashBoardControllerElement).scope();if($("#txtEdit").length>0){var scribepanelControllerScope=angular.element("#scribePanelController").scope();scribepanelControllerScope.saveProviderNote()}var topPnHgt=Math.floor($("#topMenuBoundary").outerHeight())-Math.floor($("#emr-tabs").outerHeight());unloadPNPanel();if(tabName==='PN'){data='showScribeDefault=0&TrUserId='+userId+'&pnencid='+encounterId+'&ptId='+patientId+'&style=Bulleted';$scope.tabSelected={scribe:false,progressnote:true,orders:false,prisma:false};if(dashBoardControllerScope.visitCodeFlag!==6){dashBoardControllerScope.setTabTemplateUrlForPN()}else{$scope.changeEncouunter(encounterId)}angular.element("#prisma-h-insight-tab-"+patientId).removeClass('disableEl');dashBoardControllerScope.showTodoPanel=true;PNService.setIsPNTab(true);let sunohScribeACIModule=$(".sunoh-controller-data").closest('#sunohScribeACIModule');if(sunohScribeACIModule.length>0){$rootScope.$broadcast('refreshSunohAsmntList')}}else if(tabName==='Scribe'){data='showScribeDefault=1&TrUserId='+userId+'&pnencid='+encounterId+'&ptId='+patientId+'&style=Bulleted';$scope.tabSelected={scribe:true,progressnote:false,orders:false,prisma:false};$scope.unsavedScribeNotes=false;dashBoardControllerScope.setTabTemplateForScribe();angular.element("#prisma-h-insight-tab-"+patientId).removeClass('disableEl');dashBoardControllerScope.showTodoPanel=false;PNService.setIsPNTab(false)}else if(tabName==='Orders'){data='showScribeDefault=2&TrUserId='+userId+'&pnencid='+encounterId+'&ptId='+patientId+'&style=Bulleted';$scope.tabSelected={scribe:false,progressnote:false,orders:true,prisma:false};dashBoardControllerScope.setTabTemplateUrlForOrder();angular.element("#prisma-h-insight-tab-"+patientId).removeClass('disableEl');dashBoardControllerScope.showTodoPanel=false;PNService.setIsPNTab(false)}else if(tabName==='Prisma'){var screenWidth=$window.innerWidth;if(screenWidth<1680){ecwAlert("The required minimum screen resolution is 1680 x 1050 to launch healow Insights within the Progress Note screen. NOTE: healow Insights can be launched in full screen mode from the 'healow Insights' button on the Interactive Chart Wizard regardless of screen resolution size.");$scope.isTabLoading=false;return false}data='TrUserId='+userId+'&pnencid='+encounterId+'&ptId='+patientId+'&style=Bulleted';$scope.tabSelected={scribe:false,progressnote:false,orders:false,prisma:true};dashBoardControllerScope.setTabTemplateUrlForPrisma(topPnHgt);dashBoardControllerScope.showTodoPanel=false;PNService.setIsPNTab(false)}var allowFacBasedFilter=getUserProfile('EnableFacilityBasedFilter');if(isSupportsLocalStorage()&&allowFacBasedFilter=='1'){if(!containsKey('loggedInInfo')){put("loggedInInfo",JSON.stringify(info))}}$scope.isScribeHaveUnsavedNotes();scribeSaveNotesAPICall($http,data)};function unloadPNPanel(){var pnDomEle=$("#pnPanelTab");if(pnDomEle.length>0){let pnControllerScope=angular.element($("#pnController")).scope();if(pnControllerScope){pnControllerScope.$destroy()}pnDomEle.html('');pnDomEle.remove()}}var openTab=function(data,url){scribeSaveNotesAPICall($http,data).success(function(data){$window.location=url}).error(function(){alert("Internal Error occured while saving scribe default setting, Please try after some time");$window.location=url})};$scope.changeEncouunter=function(encId){encounterChanged=true;var encLockVal='';var encTypeVal='';let newEncIndex='';let oldEncIndex='';for(var i in $scope.patientEncounters){if($scope.patientEncounters[i].encounterID===encId){encLockVal=$scope.patientEncounters[i].encLock;encTypeVal=$scope.patientEncounters[i].encType;newEncIndex=i}if($scope.patientEncounters[i].encounterID===$scope.encounterId){oldEncIndex=i}if(newEncIndex!==''&&oldEncIndex!==''){break}}if(document.getElementById("divPNScreenLoader")!=null){document.getElementById("divPNScreenLoader").style.display=""}if(currentPage=='obFlowsheet'){doChecksForPN(encId,$scope.patientId,$http)}else{doChecksForPN(encId,$scope.patientId,$http,'divPNScreenLoader',undefined,resetEncObjToPreviousEncounter)}if(parseInt(newEncIndex,10)>parseInt(oldEncIndex,10)){evaFavoriteService.showEvaFavorite("Do you know you can quickly check previous Progress Notes via EVA.<br>"+"Command : list Progress Notes for (Patient_Name) <br>"+"Would you like to add this command to your favorites?","listprogressnotes")}};var resetEncObjToPreviousEncounter=function(){EncDetailsService.getEncDetailsByEncId($scope.encounterId)};$scope.switchToPN=function(){if($scope.angVisitType){$scope.switchOBtoPN()}else if($scope.physicaltherapyVisitType){$scope.switchEXtoPN()}if(currentGlobalContext){currentGlobalContext="PN_DASHBOARD"}};$scope.switchOBtoPN=function(){try{doChecksForPN($scope.encounterId,$scope.patientId,$http,'PNFROMOB')}catch(e){}};$scope.switchPNtoOB=function(){try{if(document.getElementById("divPNScreenLoader")!=null){document.getElementById("divPNScreenLoader").style.display=""}var parameters={encounterId:encounterId,patientId:patientId,viewType:''};var obParams=getPerep(JSON.stringify(parameters));var url='#/mobiledoc/jsp/webemr/obFlowsheet/obFlowsheet_main.jsp/'+obParams;window.location=url}catch(e){alert(e.message)}};$scope.switchEXtoPN=function(){try{doChecksForPN($scope.encounterId,$scope.patientId,$http,'PNFROMEX')}catch(e){}};$scope.switchPNtoEX=function(){try{if(document.getElementById("divPNScreenLoader")!=null){document.getElementById("divPNScreenLoader").style.display=""}var parameters={encounterId:encounterId,patientId:patientId,viewType:''};var ptParams=getPerep(JSON.stringify(parameters));var url='#/mobiledoc/jsp/webemr/physicalTherapy/physicaltherapy_main.jsp/'+ptParams;window.location=url}catch(e){alert(e.message)}};$scope.showOBSummary=function(){$scope.obPanelPrint="";$ocLazyLoad.load({name:'pregnancysummary',cache:false,files:['/mobiledoc/jsp/webemr/obFlowsheet/obSummary/obSummaryController.js']}).then(function(){$scope.obPanelPrint="/mobiledoc/jsp/webemr/obFlowsheet/obSummary/OB-Summary.jsp?encounterId="+$scope.encounterId+"&patientId="+$scope.patientId+"&pregId="+pregid},function(e){console.log(e)})};$scope.showOBLog=function(){if(accessOBLogFlag!=0){$scope.obPanelPrint="";$ocLazyLoad.load({name:'obLogModule',cache:false,files:['/mobiledoc/jsp/webemr/obFlowsheet/obAccesslog/ObAccesslogController.js']}).then(function(){$scope.obPanelPrint=makeURL("/mobiledoc/jsp/webemr/obFlowsheet/obAccesslog/ObAccesslogContainer.jsp?encounterId="+$scope.encounterId+"&patientId="+$scope.patientId+"&pregId="+pregid)},function(e){console.log(e)})}else{var message="You do not have permission to access OB log.";showAlertMessage(message,'','AlertMsg','','tabspanelController')}};function popupData(modulename,dependencies,url){this.modulename=modulename;this.dependencies=dependencies;this.url=url}$scope.ocLazyLoadPopup=function(popupData){$ocLazyLoad.load({name:popupData.modulename,files:popupData.dependencies,cache:false}).then(function(){if($scope.popupurl&&$scope.popupurl.value){$templateCache.remove($scope.popupurl.value)}$scope.popupurl.value=popupData.url+"&timestamp="+(new Date).getTime()},function(e){alert(e);console.log(e)})};$scope.loadRx=function(pnSectionName){$scope.userId=userId;$scope.Rxattribute=pnSectionName;$scope.obScope=angular.element(document.getElementById('obpnController')).scope();$scope.obScope.loadPNModal(pnSectionName)};$scope.getPopupData=function(pnSectionName,categoryId,notes,propId,propName,className){var encDate='';if(encObj_tab.encDate){encDate=encObj_tab.encDate}var data=new popupData;var url="";var module="";switch(pnSectionName){case"Treatments:":case"Treatment:":case GetCaptionForSoapItem("Treatment")+":":module="TreatmentApp";url="/mobiledoc/jsp/webemr/progressnotes/treatment/treatment.jsp?encounterId="+$scope.encounterId+"&patientId="+$scope.patientId+"&userId="+userId+"&normalView=1&CorrectionalEnabled=false&nd="+(new Date).getTime();var files=['/mobiledoc/jsp/resources/jslib/angular-ui-bootstrap/dist/ui-bootstrap-tpls.js','/mobiledoc/jsp/webemr/js/alertprompt/ordersAlertPrompt.css','/mobiledoc/jsp/webemr/js/alertprompt/ordersAlertPrompt.js','/mobiledoc/jsp/pama/js/aucDirective.js','/mobiledoc/jsp/webemr/progressnotes/treatment/js/treatment.js','/mobiledoc/jsp/webemr/progressnotes/treatment/css/treatment.css','/mobiledoc/jsp/webemr/templates/browseCommon-tpl.js','/mobiledoc/jsp/webemr/templates/keywords-tpl.js','/mobiledoc/jsp/webemr/templates/category-tpl.js','/mobiledoc/jsp/webemr/labs/util/LabUtilities.js','/mobiledoc/jsp/webemr/labs/report/css/lab-report.css','/mobiledoc/jsp/webemr/css/ng-grid.css','/mobiledoc/jsp/webemr/labs/util/LabUtilities.js','/mobiledoc/jsp/webemr/js/magicsuggest.js','/mobiledoc/jsp/webemr/css/magicsuggest.css','/mobiledoc/jsp/webemr/js/clearbutton/clearUndoButton.js','/mobiledoc/jsp/webemr/templates/notes-tpl.js','/mobiledoc/jsp/webemr/templates/prevDx-tpl.js','/mobiledoc/jsp/webemr/templates/icd-tpl.js'].concat(getDependencies('pama'));data.url=url;data.dependencies=files;data.modulename=module;$scope.pn_popup_width=960;$scope.pn_popup_height=632;break}return data};$scope.openSmartForm=function(objSmartForm){if(objSmartForm){$ocLazyLoad.load({name:'smartFormModule',files:['/mobiledoc/jsp/webemr/specialtyforms/scripts/smartFormController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/specialtyforms/smart-form-tpl.jsp?encid='+encounterId+'&pid='+patientId+'&frmid='+objSmartForm.id);$scope.sfPopupurl=url},function(e){console.log('call funtiion :: '+e)});openSmartFormModal($scope,encounterId,patientId,objSmartForm.id,$scope.refreshDashboard)}};$scope.refreshDashboard=function(){refreshDashboard($scope.encounterId,$scope.patientId,"","")};$scope.openPatientHub=function(sibling){if(sibling.userType!=='3'){return false}$ocLazyLoad.load({name:'NewHub',files:['/mobiledoc/jsp/webemr/templates/topPanel-tpl.js','/mobiledoc/jsp/webemr/toppanel/patientHub/patienthubController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/toppanel/patientHub/patient-hub.jsp?patientId='+sibling.RelPtId+'&patientAge=&nd='+(new Date).getTime());$scope.linkurl=url},function(e){console.log(e)})};$scope.nextEnc=function(encId){var newLoadedEnc=encId;var index;for(var i=0;i<$scope.patientEncounters.length;i++){if($scope.patientEncounters[i].encounterID==encId){index=i;break}}if(index===0){return}if(index>=1&&index<=$scope.patientEncounters.length-1){newLoadedEnc=$scope.patientEncounters[index-1].encounterID}if(index===undefined){if($scope.patientEncounters.length>0){if($scope.patientEncounters[0]&&$scope.patientEncounters[0].encounterID){newLoadedEnc=$scope.patientEncounters[0].encounterID}else{return}}}$scope.changeEncouunter(newLoadedEnc)};$scope.prevEnc=function(encId){var newLoadedEnc=encId;var index;for(var i=0;i<$scope.patientEncounters.length;i++){if($scope.patientEncounters[i].encounterID==encId){index=i;break}}if(index===$scope.patientEncounters.length-1){if($scope.hasMoreEncForPt){$('#encDropDown #encDropDownItem').trigger('click');$timeout(function(){let list=document.getElementById("encDropDownList"),targetLi=document.getElementById("pnRecentEncEnd");list.scrollTop=targetLi.offsetTop-50},0)}return}if(index>=0&&index<$scope.patientEncounters.length-1){newLoadedEnc=$scope.patientEncounters[index+1].encounterID}if(index===undefined){if($scope.patientEncounters.length>0){if($scope.patientEncounters[0]&&$scope.patientEncounters[0].encounterID){newLoadedEnc=$scope.patientEncounters[0].encounterID}else{return}}}$scope.changeEncouunter(newLoadedEnc)};$scope.changeEncountersList=function(){var type=$scope.filter.type;var allowFacBasedFilter=getUserProfile('EnableFacilityBasedFilter');if(isSupportsLocalStorage()&&allowFacBasedFilter=='1'){if(containsKey('loggedInInfo')){var info=JSON.parse(get('loggedInInfo'));info.facilityFilter=type;put("loggedInInfo",JSON.stringify(info))}else{var info=getLoggedInInfo();info.facilityFilter=type;put("loggedInInfo",JSON.stringify(info))}refreshFullDashboard($scope.encounterId,$scope.patientId,$scope.tabAction,$scope.currentEncVals.encLock,$scope.currentEncVals.encType)}};$scope.showSiblingList=function(){if(!$scope.siblingList){var param=$.param({ptid:$scope.patientId,action:'patientRelations'});$.ajax({url:'/mobiledoc/jsp/catalog/xml/LoadLDDARTokens.jsp',type:'GET',"async":false,data:param,success:function(siblingsXml){var x2js=new X2JS;if(typeof siblingsXml!==undefined){var jsonData=x2js.xml_str2json(siblingsXml);$scope.siblingList=returnDataArray(jsonData.Envelope.Body['return'].siblings.sibling)}},error:function(){ecwAlert("Error while fetching patient relations")}})}if($scope.siblingList){$("#sibling_div").toggleClass("open")}};$scope.showSmartFormList=function(){if(!$scope.smartFormList.length){$.ajax({url:'/mobiledoc/jsp/catalog/xml/specialityforms/GetSmartForms.jsp',type:'GET',"async":false,data:'encounterId='+$scope.encounterId,success:function(smartFormXml){var smartFormStatus,jsonData;var x2js=new X2JS;if(typeof smartFormXml!==undefined){jsonData=x2js.xml_str2json(smartFormXml);smartFormStatus=jsonData.Envelope.Body['return'].status.errorno}if(smartFormStatus==='0'){$scope.smartFormList=returnDataArray(jsonData.Envelope.Body['return'].resultset.data.row)}},error:function(){ecwAlert("Error while fetching smartForms")}})}if($scope.smartFormList.length){$("#sf_div").toggleClass("open")}};function loadPatientEncounterList(patientEncountersXML,encId){let dataVal={encounters:[],currVal:'',currImgSrc:'',index:0,firstListEnc:[],encounterId:0};let pnInitials=getUserProfile("ProgressNotesInitials");if(pnInitials!=='1')pnInitials='0';let strDate='';let split='';let encounters=getPatientEncountersForTab(patientEncountersXML);$scope.hasMoreEncForPt=false;if(!$scope.isAllEncLoad){let maxRecentEncInPnDropDown=getItemKeyValue("MaxRecentEncInPnDropDown");let maxEncFromSetting=maxRecentEncInPnDropDown===''||maxRecentEncInPnDropDown==='0'?50:parseInt(maxRecentEncInPnDropDown,10);$scope.hasMoreEncForPt=encounters.length>maxEncFromSetting;if($scope.hasMoreEncForPt){encounters.pop()}}let codesArray=getCancelledCodesCommon();for(var i=0;i<encounters.length;i++){if(!(encounters[i].ProgDisplay==="0"||encounters[i].ProgDisplay===""||encounters[i].encounterID===encId)||(checkCancelledStatus(encounters[i].status,codesArray)&&encounters[i].visitType!=='TEL'||!validEncType(encounters[i].encType))){encounters.splice(i,1);i=i-1}else{strDate=encounters[i].date;split=strDate.split('-');encounters[i].date=""+split[1]+"/"+split[2]+"/"+split[0];var providerInitials='';var listValue='';if(pnInitials==='1'){if(encounters[i].doctorID&&encounters[i].doctorID.length>0)providerInitials=getProviderInitials(encounters[i].doctorID);listValue=encounters[i].date+' '+providerInitials+' '+encounters[i].reason}else{listValue=encounters[i].date+' '+encounters[i].reason}encounters[i].listValue=listValue;encounters[i]["imgSrc"]='';if(encounters[i].encType===encTypeCommonCodes.encOV||encounters[i].encType===encTypeCommonCodes.encTEL||encounters[i].encType===encTypeCommonCodes.encWEB||encounters[i].encType===encTypeCommonCodes.encCPVirtual){encounters[i]["imgSrc"]=getImageSrc(encounters[i])}if(encounters[i].encounterID==encId){dataVal.currVal=encounters[i].listValue;dataVal.encounterId=encounters[i].encounterID;dataVal.currImgSrc=encounters[i]["imgSrc"];dataVal.index=i+1}}}dataVal.encounters=encounters;detailsTabs={noOfRecords:0,totalPages:0,rowsPerPage:20,currentPage:0,currentIndex:0};loadedPagesTabs=[];detailsTabs.noOfRecords=dataVal.encounters.length;detailsTabs.totalPages=Math.ceil(detailsTabs.noOfRecords/detailsTabs.rowsPerPage);detailsTabs.currentPage=parseInt((dataVal.index-1)/detailsTabs.rowsPerPage)+1;detailsTabs.currentIndex=parseInt((dataVal.index-1)%detailsTabs.rowsPerPage)+1;loadedPagesTabs[detailsTabs.currentPage]={loaded:true};var startIndex=getStartIndex();var endIndex=getEndIndex();dataVal.firstListEnc=getSplittedArray(startIndex,endIndex,dataVal.encounters);return dataVal}function getSplittedArray(startIndex,endIndex,encounters){var newArray=[];for(var index=startIndex;index<endIndex;index++){newArray.push(encounters[index])}return newArray}function getStartIndex(){var startIndex=0;if(detailsTabs.currentPage!==0){startIndex=(detailsTabs.currentPage-1)*detailsTabs.rowsPerPage}return startIndex}function getEndIndex(){var endIndex=detailsTabs.noOfRecords;var endValue=(detailsTabs.currentPage-1)*detailsTabs.rowsPerPage+detailsTabs.rowsPerPage;if(endValue<endIndex){endIndex=endValue}return endIndex}function definedImgs(){this.img_1='icon icon-reg-progressnote';this.img_2='icon icon-telencounter';this.img_3='icon icon-physical-visit-progressnote';this.img_4='icon icon-web-encounter';this.img_5='';this.img_6='';this.img_7='icon icon-surgery-visit';this.img_8='icon icon-locked-surgery-visit';this.img_9='icon icon-locked-physical-visit-progressnote';this.img_10='icon icon-locked-telencounter';this.img_11='icon icon-locked-reg-progressnote';this.img_12='icon icon-locked-web-encounter';this.img_13='icon icon-healow-encounter';this.img_14='icon icon-nimbus-visit';this.img_15='icon icon-locked-nimbus-visit';this.img_16='icon icon-careplan-office-visit';this.img_17='icon icon-locked-careplan-office-visit';this.img_18='icon icon-careplan-tele-visit';this.img_19='icon icon-locked-careplan-tele-visit';this.img_20='icon icon-addendum-ov';this.img_21='icon icon-addendum-tele';this.img_22='icon icon-addendum-phy';this.img_23='icon icon-addendum-web';this.img_24='icon icon-addendum-op';this.img_26='icon icon-addendum-ccmr';this.img_27='icon icon-addendum-cpvWeb';this.img_28='icon icon-addendum-numbus';this.img_29='icon icon-bh-visit';this.img_30='icon icon-locked-bh-visit';this.img_31='icon icon-addendum-bh-visit';this.img_32='icon icon-group-visit';this.img_33='icon icon-group-visit-locked';this.img_34='icon icon-addendum-group-visit-locked'}function getImageSrc(encDetails){var imgDef=new definedImgs;var imgVal='';var addendumFlag=false;if(encDetails.addendumId!==""){addendumFlag=true}var isGroupVisit=encDetails.isGroupEncounter;if(encDetails.encType===encTypeCommonCodes.encOV){if(encDetails.encLock==='1'){imgVal=imgDef.img_11;if(addendumFlag)imgVal=imgDef.img_20}else{imgVal=imgDef.img_1}var officeVisitType=encDetails.officeVisitType;if(officeVisitType&&officeVisitType.toString().length>0&&IsNumericData(officeVisitType.toString())){if(officeVisitType=='1'){if(encDetails.encLock==='1'){imgVal=imgDef.img_9;if(addendumFlag)imgVal=imgDef.img_22}else{imgVal=imgDef.img_3}}else if(officeVisitType=='2'){if(encDetails.encLock==='1'){imgVal=imgDef.img_8;if(addendumFlag)imgVal=imgDef.img_24}else{imgVal=imgDef.img_7}}else if(officeVisitType==='6'){if(encDetails.encLock==='1'){imgVal=imgDef.img_30;if(addendumFlag)imgVal=imgDef.img_31}else{imgVal=imgDef.img_29}}}var isCCMR=encDetails.ccmrvisit;if(isCCMR&&isCCMR==='1'&&isGroupVisit==='false'){if(encDetails.encLock==='1'){imgVal=imgDef.img_17;if(addendumFlag)imgVal=imgDef.img_26}else{imgVal=imgDef.img_16}}else if(isCCMR&&isCCMR==='1'&&isGroupVisit==='true'){if(encDetails.encLock==='1'){imgVal=imgDef.img_33;if(addendumFlag)imgVal=imgDef.img_34}else{imgVal=imgDef.img_32}}}else if(encDetails.encType===encTypeCommonCodes.encWEB){if(encDetails.encLock==='1'){imgVal=imgDef.img_12;if(addendumFlag)imgVal=imgDef.img_23}else{imgVal=imgDef.img_4}}else if(encDetails.encType===encTypeCommonCodes.encCPVirtual){if(encDetails.encLock==='1'){imgVal=imgDef.img_19;if(addendumFlag)imgVal=imgDef.img_27}else{imgVal=imgDef.img_18}}else{var reason=encDetails.reason;if(reason&&reason.indexOf('Nimbus Encounter')>=0){if(encDetails.encLock==='1'){imgVal=imgDef.img_15;if(addendumFlag)imgVal=imgDef.img_28}else{imgVal=imgDef.img_14}}else if(encDetails.encLock==='1'){imgVal=imgDef.img_10;if(addendumFlag)imgVal=imgDef.img_21}else{imgVal=imgDef.img_2}var inPatientFlag=getItemKeyValue("EnableInPatientVisitFlag");if(inPatientFlag!==''&&inPatientFlag.toString().toLowerCase()==='yes'){var inPtFlag=encDetails.inPatientFlag;var n=0;if(inPtFlag&&inPtFlag.toString().length>0&&IsNumericData(inPtFlag.toString())){n=1}else{n=0}if(n===1){imgVal=imgDef.img_13}}}return imgVal}var getPrevPageToBeLoadedTabs=function(){for(var i=detailsTabs.currentPage-1;i>0;i--){if(loadedPagesTabs[i]){}else{return i}}return''};var getNextPageToBeLoadedTabs=function(){for(var i=detailsTabs.currentPage+1;i<=detailsTabs.totalPages;i++){if(loadedPagesTabs[i]){}else{return i}}return''};$scope.showPrismaUnauthorizedAlert=function(){ecwAlert('You are not given access to view this page. This can be changed from security settings. Security attribute: Allow Access to healow Insights')};$scope.encounterConfidential=function(){if(isItemKeyEnabled('EnablePSAC')){PSACService.encounterConfidentialCheck($scope.encounterId).then(function(response){if(response.data){$scope.isEncounterConfidential=true;$scope.encounterConfidentialityTitle="Manage Encounter Confidentiality. \nThis encounter is confidential."}else{$scope.isEncounterConfidential=false;$scope.encounterConfidentialityTitle="Manage Encounter Confidentiality. \nThis encounter is NOT confidential."}},function(){ecwAlert("Error while checking encounter confidential service.")})}};$scope.loadPSAC=function(){if(!IsPatientPSAC()){if(!getPermission("PatientCategories",global.TrUserId)){ecwAlert("Permission denied to view or set patient categories.Please contact Administrator.")}else{$ocLazyLoad.load({name:'psacModule',files:['/mobiledoc/jsp/webemr/progressnotes/billing/setPsac.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/billing/setPsac.jsp?TrUserId='+global.TrUserId+'&ptId='+$scope.patientId+'&encId='+$scope.encounterId),controller:'psacController',windowClass:'app-modal-window modal fade bluetheme modal-width small-Modal',backdrop:"static",keyboard:false,resolve:{}});modalInstance.result.then(function(){},function(result){if(result){$scope.encounterConfidential()}})})}}else{alert("All medical information for this patient is confidential, therefore, it is not necessary to mark this Progress Note as a Confidential Note.")}};function IsPatientPSAC(){if(isPatientPSAC===-1){var result=urlGet('/mobiledoc/jsp/catalog/xml/edi/isPatientPSAC.jsp?PatientId='+$scope.patientId);if(result){var isconf=$(result).find("IsPatientPSAC").text();isPatientPSAC=isconf==="1"}}return isPatientPSAC}});tabsModule.factory('editPastPNFactory',function(){let sharedServiceFromTabsPanel={};sharedServiceFromTabsPanel.data=[];return sharedServiceFromTabsPanel});$(document).on('click','#topMenuBoundary',function(e){hideQSDirectiveDivs(e)});
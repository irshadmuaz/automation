(function(){function cptDropService($ocLazyLoad,$modal){return{loadICDCPTPopup:loadICDCPTPopup};function loadICDCPTPopup(obj,item,encounterId,isPAMAActionRequired,callback){var labData=[];var assessmentIds=[];var loadAssmtData=[];var isAssessmentPresent='1';var tempObj={itemid:''};item.dirtyFlag=true;tempObj.itemid=obj.id;labData.push(tempObj);$.ajax({url:makeURL("/mobiledoc/emr/labs.ecw/getAssessmentListForEncounter"),type:"POST",cache:false,data:{"encounterId":encounterId},"async":true,success:function(response){if(response.status==="success"){loadAssmtData=returnDataArray(response.Assessment);angular.forEach(loadAssmtData,function(value){value.isAssmtChecked='0';assessmentIds.push(value.AsmtId.toString())});if(assessmentIds.length>0){isAssessmentPresent='0'}addIntoAssessentArray(obj.AsstIDNameAndValue,loadAssmtData,assessmentIds);var data={labData:labData,Obj:obj,item:item,encounterId:encounterId,loadAssmtData:loadAssmtData,isPAMAActionRequired:isPAMAActionRequired,isAssessmentPresent:isAssessmentPresent};openICDCPTAssociation(data,callback)}},error:function(){ecwAlert("Error while fetching assessment List.")}})}function addIntoAssessentArray(Obj,loadAssmtData,assessmentIds){if(Obj){$.each(Obj,function(key,value){if($.inArray(value.AsmtId.toString(),assessmentIds)!==-1){value.isAssmtChecked='1';var assmtId=getDefaultValueForString(value.AsmtId);assmtId=parseInt(assmtId,10);$.each(loadAssmtData,function(key,assmt){if(assmt.AsmtId===assmtId){assmt.isAssmtChecked='1'}})}})}}function getDefaultValueForString(str){return str===undefined||str===null||str.toString().length<=0?"":str}function openICDCPTAssociation(data,callback){let userProfile={singleAssessment:data.isAssessmentPresent};let mngOrderAssociationICDCPT=[];$ocLazyLoad.load({name:'setLabAssociateCptApp',files:['/mobiledoc/jsp/webemr/progressnotes/laborders/js/setLabAssociateCptController.js']}).then(function(){var modalInstance=$modal.open({templateUrl:'/mobiledoc/jsp/webemr/progressnotes/laborders/setLabAssociateCpt.html',controller:'setLabAssociateCptController',windowClass:'bluetheme modal-width',backdrop:"static",resolve:{labAssociateCptObj:function(){return data.labData},encounterId:function(){return data.encounterId},assesmentData:function(){return data.loadAssmtData},association:function(){return mngOrderAssociationICDCPT},icdCptAssociationDetail:function(){return{isPamaActionRequired:data.isPAMAActionRequired,isDIOrder:data.Obj.sKeyname=='xrays'}},userProfile:function(){return userProfile}}});modalInstance.result.then(function(){},function(){var assmtId="";var addDxTitle="";var assessmentsValue=[];var assmtIdList=[];if(data.item.assmtIds){assmtId=data.item.assmtIds}if(assmtId!==""){assmtIdList=assmtId.split(",")}angular.forEach(data.loadAssmtData,function(Obj){if(Obj.isAssmtChecked==="1"&&$.inArray(Obj.AsmtId.toString(),assmtIdList)===-1){data.Obj.displayImage++;if(assmtId===""){assmtId=Obj.AsmtId}else{assmtId+=","+Obj.AsmtId}addDxTitle+=Obj.Code+" - "+Obj.Name+"\r\n";assessmentsValue.push(Obj)}});data.Obj.asmtIds=assmtId;data.Obj.DxTitle+=addDxTitle;data.Obj.AsstIDNameAndValue=assessmentsValue;angular.forEach(mngOrderAssociationICDCPT,function(icdCPT){if(icdCPT.itemId===data.item.id){icdCPT.icdData=[];if(data.item.AsstIDNameAndValue){icdCPT.icdData=data.item.AsstIDNameAndValue}}});data.Obj.mngOrderAssociationICDCPT=mngOrderAssociationICDCPT;if(callback){callback(data.Obj)}})})}}angular.module("ecw.service.cptDropService",['oc.lazyLoad','ui.bootstrap']).service('cptDropService',cptDropService)})();
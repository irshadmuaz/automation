var prismaWebApp=angular.module('prismaWebApp',['oc.lazyLoad','prismaAppServiceModule','ecw.service.EncDetailsService','prismaAppModalModule','ecw.datatruncUtilityModule','ecw.dir.patientidentifier']);if(getItemKeyValue('prismaEnabled').toLowerCase()==='yes'){prismaWebApp.requires.push('mainPrismaApp')}prismaWebApp.controller('prismaWebController',function($scope,$ocLazyLoad,PrismaAppService,$modal,PSACService,EncDetailsService,$timeout,$observableService){let vm=this;vm.patientId=0;vm.prismaUrl="";vm.encounterId=0;vm.userId=0;vm.isPrismaEnabled=false;vm.hasPrismaSecurityAccess=false;vm.totalCount=0;vm.countExternalRecords=0;vm.countInternalRecords=0;vm.healowInsightBtnClicked=false;vm.callingFrom="";vm.existedInstanceMessage=undefined;vm.openPtExternalVisitModal=function(){showPrismaScreenLoader();if("hinsights"===PrismaAppService.getCallingFrom()){PrismaAppService.setPrismaContext('progressnotes')}if(PrismaAppService.isPrismaPopupInstanceOpen()){hidePrismaScreenLoader();ecwAlert("One instance of healow Insights is already open.  You cannot open another instance.","eClinicalWorks",null,"","bluetheme");return}PrismaAppService.checkPatientAvailability(vm.patientId).then(function(data){if(undefined!==data&&undefined!==data.isPrismaUsableAfterTruncate&&typeof data.isPrismaUsableAfterTruncate==="boolean"&&!data.isPrismaUsableAfterTruncate){hidePrismaScreenLoader();PrismaAppService.showPrismaUnusableError();$observableService.publish('showPrismaUnusableError')}else if(undefined!==data&&undefined!==data.isPatientAvailable&&typeof data.isPatientAvailable==="boolean"&&data.isPatientAvailable){loadFilesAndOpenPrismaModal()}else{hidePrismaScreenLoader();ecwAlert("healow Insights will shortly be available once the patient's records are refreshed on the search server. Please try again in a few seconds.")}});if(angular.element("#topMenuBoundary").length>0){PrismaAppService.topPanelOffset=$("#topMenuBoundary").offset().top}};function loadFilesAndOpenPrismaModal(){PrismaAppService.setADTModule(vm.isADTModule);let module;if(PrismaAppService.isPaidModelEnabled===true){module='ci-si'}else{module='default'}$ocLazyLoad.load({name:'',files:PrismaAppService.getDependencyFiles(module),serie:true,cache:true}).then(function(){if(PrismaAppService.getCallingFrom()==="hinsights"){angular.element("#prisma-h-insight-tab-"+vm.patientId).addClass('disableEl')}verifyPSAC()})}function verifyPSAC(){PrismaAppService.setBreakGlassReasonNo(false);if("yes"!==PrismaAppService.getPrismaPSACSetting().toLowerCase()&&PrismaAppService.getPossiblePSACEnc()&&"yes"===getItemKeyValue("EnablePSACBreakGlass").toLowerCase()){PSACService.callMultiplePrintChartOptions("",PrismaAppService.getPossiblePSACEnc(),function(){openDisclaimerModal()},function(){PrismaAppService.setBreakGlassReasonNo(true);openDisclaimerModal()},'PRISMA')}else{openDisclaimerModal()}}vm.init=function(patientId,encounterId,showSearchPage,callingFrom,showExternalFilterSelected){if(callingFrom==='prisma-standalone'){if($(".modal.introMODAL")!==undefined)$(".modal.introMODAL").remove();if($("#healowPlusJellyBeanCountCntrl")!==undefined)$("#healowPlusJellyBeanCountCntrl").remove();if($("#JellyBeanCountCntrl")!==undefined)$("#JellyBeanCountCntrl").remove();if($("#leftnavApp")!==undefined)$("#leftnavApp").remove();let addEventListener=window.addEventListener;addEventListener("beforeunload",function(e){$observableService.publish("onUnloadPrismaStandalone")})}let isValid=validatePrismaStandalone(patientId,callingFrom);if(!isValid)return;if(isNaN(parseInt(patientId,10))===false&&parseInt(patientId,10)<=0){hidePrismaScreenLoader();ecwAlert("Something went wrong, Please try again later","eClinicalWorks",null,"","bluetheme");return}if(callingFrom==="floatingToolbar"){vm.isADTModule=true}vm.patientId=patientId;vm.encounterId=encounterId;vm.userId=global.TrUserId;vm.encData=undefined;if(callingFrom&&callingFrom!=="null"){vm.callingFrom=callingFrom.toLowerCase();PrismaAppService.setCallingFrom(callingFrom)}PrismaAppService.isFromExe=false;if(vm.encounterId&&vm.encounterId!=="0"){vm.encData=EncDetailsService.getEncDetailsByEncId(vm.encounterId)}if(showExternalFilterSelected!=="null"&&showExternalFilterSelected==="true"){PrismaAppService.showExternalFilterSelected=true}PrismaAppService.setShowSearchPage(showSearchPage&&parseInt(showSearchPage)===1);PrismaAppService.getPrismaEnableCheckPromise(vm.patientId).then(function(data){if(undefined!==data&&undefined!==data.isPrismaEnable&&typeof data.isPrismaEnable==="boolean"&&data.isPrismaEnable){if(data.documentsCount){PrismaAppService.setPossiblePSACEnc(data.documentsCount.possiblePSACEncs)}PrismaAppService.setPrismaPSACSetting(data.prismaPSACSetting);PrismaAppService.setPaidModelEnabled(data.isPaidModelEnabled);vm.openPtExternalVisitModal()}else{ecwAlert("healow Insights is not enabled.")}})};function openDisclaimerModal(){hidePrismaScreenLoader();let params={patientId:vm.patientId};var modalScope=$scope.$new();modalScope.modalInstance=$modal.open({templateUrl:'/mobiledoc/jsp/webemr/toppanel/prisma/template/prisma-disclaimer-on-startup.html',windowClass:'fade bluetheme medium-width prismaDisclaimermodal',controller:'PrismaDisclaimerController',controllerAs:'prismaDisclaimerCtrl',backdrop:'static',keyboard:false,size:'sm',scope:modalScope,resolve:{requestParam:function(){return params}}});modalScope.modalInstance.result.then(function(){openPrismaModal()},function(){openPrismaModal()})}function openPrismaModal(){vm.prismaUrl='/mobiledoc/jsp/webemr/toppanel/prisma/template/prisma-modal-container.html'}function hidePrismaScreenLoader(){angular.element('#prisma-screen-loading').hide()}function showPrismaScreenLoader(){angular.element('#prisma-screen-loading').show()}function adjustPrismaRecordAndSummaryViewHeight(){$scope.topPanelOvalTimeout=$timeout(function(){var prismaHgt=angular.element(".prismaview").outerHeight();var hgt=prismaHgt+PrismaAppService.topPanelOffset-angular.element("#pnDashboard  #topMenuBoundary").offset().top;angular.element(".prismaview").css('height',hgt+"px");PrismaAppService.recordsLeftViewHgt=Math.floor(PrismaAppService.recordsLeftViewHgt+PrismaAppService.topPanelOffset-angular.element("#pnDashboard  #topMenuBoundary").offset().top);PrismaAppService.prismaLeftViewHgt=PrismaAppService.prismaLeftViewHgt+PrismaAppService.topPanelOffset-angular.element("#pnDashboard  #topMenuBoundary").offset().top;angular.element(".prismaview .rt-record-view").css('height',PrismaAppService.recordsLeftViewHgt+"px");angular.element(".prismaview .pt-record-view").css('height',PrismaAppService.prismaLeftViewHgt+"px");PrismaAppService.summaryViewHeight=PrismaAppService.summaryViewHeight+PrismaAppService.topPanelOffset-angular.element("#pnDashboard  #topMenuBoundary").offset().top;angular.element(".prismaview .rt-summary-view").css('height',PrismaAppService.summaryViewHeight+"px");angular.element(".prismaview .pt-summary-view").css('height',PrismaAppService.summaryViewHeight+"px");angular.element("#prismaPdfDocument").contents().find("#pdfViewer iframe").contents().find('#DocumentViewer').css("height",PrismaAppService.summaryViewHeight+"px");PrismaAppService.topPanelOffset=angular.element("#pnDashboard  #topMenuBoundary").offset().top},500)}function validatePrismaStandalone(patientId,callingFrom){let isValid=true;if(isNaN(parseInt(patientId,10))===false&&parseInt(patientId,10)<=0){isValid=false;ecwAlert("Please select a patient.");console.log("Incorrect configuration found for using healow Insights - Invalid patient Id.")}if(!callingFrom||callingFrom.trim()===""){isValid=false;ecwAlert("Incorrect configuration found for using healow Insights.");console.log("Incorrect configuration found for using healow Insights- Pass callingFrom param with value as prisma-standalone.")}hidePrismaScreenLoader();return isValid}angular.element("#top-panel-olive-icon").bind("click",adjustPrismaRecordAndSummaryViewHeight);$scope.$on('$destroy',function(){$timeout.cancel($scope.topPanelOvalTimeout);angular.element("#top-panel-olive-icon").unbind('click',adjustPrismaRecordAndSummaryViewHeight)})});
angular.module('ecw.rpm.startStopTimerApp',['ecw.datatruncUtilityModule','rpm.userService']).directive('rpmStartStopTimer',function($http,$modal,$ocLazyLoad,rpmUserService){return{restrict:'AE',replace:'true',scope:{patientId:'=',ptacoId:'=',timerStatus:'=',timerStartTime:'=',primaryContact:'=',action:'=',callbackFunction:'&',module:'=',source:'='},link:function(scope,element,attrs,ngModelCtrl){element.click(function(){$('.action-hub-modal').remove();if($('.rpm-draggable-timer-modal').length>0){return}$ocLazyLoad.load({name:'rpm.startStopTimer',files:['/mobiledoc/jsp/webemr/ccmr/rpm/timer/js/rpmStartStopTimerController.js','/mobiledoc/jsp/webemr/ccmr/rpm/timer/css/rpm-timer-modal.css','/mobiledoc/jsp/webemr/ccmr/rpm/timer/css/rpm-start-stop-timer.css','/mobiledoc/jsp/webemr/templates/keywords-tpl.js','/mobiledoc/jsp/webemr/js/ecw.dir.patientidentifier.js','/mobiledoc/jsp/webemr/ccmr/rpm/js/service/rpmUserServices.js','/mobiledoc/jsp/webemr/ccmr/rpm/timer/js/jquery.draggable.js','/mobiledoc/jsp/webemr/ccmr/rpm/timer/directive/rpmViewFullNotes-tpl.js']}).then(function(){scope.rpmTimerData={patientId:scope.patientId,ptacoId:scope.ptacoId,timerStatus:scope.timerStatus,timerStartTime:scope.timerStartTime,primaryContact:scope.primaryContact,action:scope.action,callbackFunction:scope.callbackFunction,module:scope.module,source:scope.source};var className='expanded-and-small';if(scope.action==='stop'){className='expanded-and-big'}function getModal(){$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/ccmr/rpm/timer/rpmStartStopTimer.html?'),controller:'rpmStartStopTimerController',controllerAs:'rpmStrtStpTmrCtrl',animation:true,keyboard:false,backdrop:false,windowClass:'bluetheme rpm-timer-modal rpm-draggable-timer-modal rpm-timer-modal-overflow-hidden '+className,resolve:{rpmTimerData:function(){return scope.rpmTimerData}}})}scope.moduleRestrictionKey=scope.module&&scope.module.toLowerCase()==='ccm'?'CCMAddTimeRestriction':'RPMAddTimeRestriction';var module=scope.module&&scope.module.toLowerCase()==='ccm'?'CCM':'RPM';if(!getPermission(scope.moduleRestrictionKey,global.TrUserId)){ecwAlert('User does not have rights to add the time. Please contact your administrator to give the permission for security item '+module+'-Permission to add the time.','')}else if($('.rpm-draggable-timer-modal').length>0){ecwAlert('There is already one RPM Start/Stop timer popup open.','')}else{if(!scope.module||scope.module==='RPM'){var param={patientId:scope.patientId,filters:{month:Number(moment().format('MM')),year:Number(moment().format('YYYY')),isReadingAvailable:true},userId:global.TrUserId};rpmUserService.postRequestForRpmData('/mobiledoc/phm/rpmDeviceMonitoring/getDeviceReadingsForPatient',param).then(function(response){response=response.data;if(response&&response.result[0]&&response.result[0].totalReadings>0){getModal()}else if(response&&!(response.result[0]&&response.result[0].totalReadings>0)){ecwConfirm("No readings have been received from a device, do you still want to add time?","Start/Add Time",function(){getModal()},function(){},'bluetheme',false)}else if(response.status==='failure'){ecwAlert('Exception occured while checking Device Readings','')}},function(e){ecwAlert('Error occured while checking Device Readings','')})}else{getModal()}}})})}}});
var app=angular.module('evaIcdAutoAuggest',[]);app.directive('icdAutoSuggest',function(){return{restrict:'EA',scope:{onItemSelect:'&',defaultSearch:'@'},templateUrl:'/mobiledoc/jsp/webemr/assistant/templates/ICDAutoSuggest-tpl.html',link:function(scope){var x2js=new X2JS;scope.isSmartSearchSetToDefault={value:false};scope.useICD10=true;scope.searchBy="name";scope.ICDType="ICD10";if(scope.defaultSearch===undefined){scope.defaultSearch=""}scope.searchTerm="";scope.ICDs=[];scope.selectedICD={};scope.IMOEnabled=false;scope.doNotAllowUserToChangeAutoMapICD10Option=getItemKeyValue("DonotAllowUserToChangeAutoMapICD10Option").toLowerCase()=='yes';scope.icd10MapArr=[];scope.searchICD=function(){var minCharForSearch=getItemKeyValue("MinimumCharICD9Lookup",true);if(minCharForSearch==0){minCharForSearch=3}var url=makeURL("/mobiledoc/jsp/catalog/xml/edi/LookupDiagnosisCodes.jsp?parentId=0");var formData='FormData='+createXMLForICD(scope.searchBy);if(scope.searchTerm.length>=minCharForSearch){$.ajax({url:url,type:'POST',data:formData,"async":false,success:function(res){if(res.indexOf("success")>-1){var jsonRes=x2js.xml_str2json(res);scope.ICDs=x2js.asArray(jsonRes.Envelope.Body["return"].ICDCodes.icd);scope.icd10MapArr=[]}else{console.log(res)}},error:function(error){console.log(error)}})}};scope.txtBlur=function(clearIcd10MapArr){scope.ICDs=[];if(clearIcd10MapArr){scope.icd10MapArr=[]}scope.searchTerm=""};scope.setICD=function(icd){if(icd.icd.icdversion==10){scope.selectedICD=icd;scope.selectedICD.icd.description=icd.icd.name;scope.selectedICD.icd.itemid=icd.icd.itemId;scope.selectedICD=formatSelectedICD(scope.selectedICD);scope.txtBlur(true);scope.onItemSelect({'item':scope.selectedICD})}else if(icd.icd.icdversion==9){if(scope.useICD10){callICDConversionService(icd.icd.code,icd.icd.name)}else{scope.selectedICD=icd;scope.selectedICD.icd.description=icd.icd.name;scope.selectedICD.icd.itemid=icd.icd.itemId;scope.selectedICD=formatSelectedICD(scope.selectedICD);scope.onItemSelect({'item':scope.selectedICD})}scope.txtBlur(false)}};if(scope.defaultSearch.length>0){scope.searchTerm=scope.defaultSearch;scope.searchICD();scope.defaultSearch=""}function callICDConversionService(code,desc){var url=makeURL("/mobiledoc/jsp/catalog/xml/edi/icd9icd10gems/icdConversionService.jsp?action=convertToICD10GEM&icd9="+code+"&requestSource=WebClient&webemr=yes&icd9Desc="+desc);url=encodeURI(url);$.ajax({url:url,type:'POST',"async":false,success:function(res){if(res.indexOf("SUCCESS")>-1){if(res.indexOf("RequireUserAction")>-1){handle1ToManyMapping(res)}else{var jsonRes=x2js.xml_str2json(res);var icd10gem=jsonRes.Envelope.Body["return"].icd10gem;var numberOfTargets=icd10gem.numberOfTargets;var returnedICD10="";if(numberOfTargets==1){returnedICD10=icd10gem.targets.target;var convertedICD={'icd':returnedICD10};convertedICD.icd.itemid=getItemIdForICD(returnedICD10.value,returnedICD10.shortDesc,returnedICD10.longDesc);convertedICD.icd.code=convertedICD.icd.value;convertedICD.icd.description=convertedICD.icd.longDesc;convertedICD.icd.icdversion=10;scope.selectedICD=convertedICD;scope.selectedICD=formatSelectedICD(scope.selectedICD);scope.onItemSelect({'item':scope.selectedICD})}else{let returnedICD=icd10gem.targets.target;angular.forEach(returnedICD,function(value,key){value.itemId=getItemIdForICD(value.code,value.description,value.description);value.icdversion=10;value.description=value.longDesc;value.name=value.longDesc;value.code=value.value});scope.icd10MapArr=returnedICD}}}else{console.log(res)}},error:function(error){console.log(error)}})}function handle1ToManyMapping(res){var jsonRes=x2js.xml_str2json(res).Envelope.Body["return"];var icd9=jsonRes.icd9;var icd9Desc=jsonRes.icd9Desc;var id=jsonRes.icd10gem.refId;var url=makeURL("/mobiledoc/jsp/catalog/xml/edi/icd9icd10gems/convertToICD10GEMXML.jsp?action=convertToICD10GEM&icd9="+icd9+"&icd9Desc="+icd9Desc+"&requestSource=WebClient&id="+id);url=encodeURI(url);$.ajax({url:url,type:'POST',"async":false,success:function(res){if(res.indexOf("success")>-1){jsonRes=x2js.xml_str2json(res);var localIcd10MapArr=x2js.asArray(jsonRes["return"].scenario.set);var localIcd10MapArr1=[];if(localIcd10MapArr.length===undefined){localIcd10MapArr=[localIcd10MappArr]}$.each(localIcd10MapArr,function(index,value){if(value.icd10.length===undefined){value=[value.icd10]}else{value=value.icd10}$.each(value,function(index,subvalue){subvalue.itemId=getItemIdForICD(subvalue.code,subvalue.description,subvalue.description);subvalue.icdversion=10;subvalue.name=subvalue.description;localIcd10MapArr1.push(subvalue)})});scope.icd10MapArr=localIcd10MapArr1}else{console.log(res)}},error:function(error){console.log(error)}})}function formatSelectedICD(selectedICD){Object.keys(selectedICD.icd).forEach(function(itm){if(itm!="code"&&itm!="description"&&itm!="itemid"&&itm!="icdversion")delete selectedICD.icd[itm]});return selectedICD}function getItemIdForICD(code,shortDesc,longDesc){var url=makeURL("/mobiledoc/jsp/catalog/xml/edi/icd9icd10gems/getItemIdforICDCode.jsp?ICD10Code="+code+"&ICD10LongDesc="+longDesc+"&ICD10ShortDesc="+shortDesc);url=encodeURI(url);var itemid=0;$.ajax({url:url,type:'POST',"async":false,success:function(res){var jsonRes=x2js.xml_str2json(res);itemid=jsonRes.Envelope.Body["return"].ICD10ItemId},error:function(error){console.log(error)}});return itemid}function createXMLForICD(searchBy){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('lookup');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'searchBy',searchBy,'xsi:type','xsd:string');if(searchBy==='code')addElement(xw,'code',scope.searchTerm,'xsi:type','xsd:string');else if(searchBy==='name')addElement(xw,'name',scope.searchTerm,'xsi:type','xsd:string');addElement(xw,'keyName','Assessments','xsi:type','xsd:string');addElement(xw,'ShowCodes','1','xsi:type','xsd:string');addElement(xw,'ValidDate','','xsi:type','xsd:string');addElement(xw,'counter','1','xsi:type','xsd:string');addElement(xw,'maxcount','8','xsi:type','xsd:string');addElement(xw,'StartWith','Contains','xsi:type','xsd:string');addElement(xw,'ICDType',scope.ICDType,'xsi:type','xsd:string');xw.writeEndElement();endSoapPacket(xw);return xw.flush()}}}});
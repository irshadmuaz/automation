var mainPrismaApp=angular.module('mainPrismaApp',['oc.lazyLoad','prismaAppServiceModule']).directive('prisma',function(PrismaAppService,$observableService,$timeout,PRISMA_CONSTANT){return{restrict:'EA',scope:{patientId:'=',userId:'=',encounterId:'=?',contextPn:'=?',parentClass:'=',isPrismaEnabled:'=',adtModuleMode:'=?',miniMode:'=?',showSearchPage:'=?',loadInHtml:'=?',openPrismaCallback:'&callback',callingFrom:'=?',label:'=?'},template:'<div id="prisma-screen-loading{{patientId}}" class="prisma-screen-loader"><div class="prisma-screen-loading-img"></div></div>'+'<div class="{{parentClass}} prismaTotalCountParent" ng-if="isPrismaEnabled">'+'<div class="btn-group pad5" ng-if="!loadInHtml">'+'   <div ng-if="hasPrismaSecurityAccess" class="prismaTotalDocCount{{patientId}}" ng-mouseenter="togglePrismaDocsCountPopup($event,true);" ng-mouseleave="togglePrismaDocsCountPopup($event,false);">'+'       <button type="button" class="btn prisma-btn-default btn-xs "  id="externalVisitBtn{{patientId}}" ng-click="openPtExternalVisitModal(); togglePrismaDocsCountPopup($event,false);">'+'           <i class="icon prisma-button nomargin"></i>'+'<span ng-if="!miniMode">healow Insights </span>'+'<span ng-class="{\'prisma-count-green\' : true === isAnyIhubRecordExisted, \'prisma-count\': false === isAnyIhubRecordExisted, \'mr7\': false === miniMode}" ng-bind="totalCount"></span>'+'       </button>'+'   </div>'+'   <div ng-if="!hasPrismaSecurityAccess" class="prismaTotalDocCount{{patientId}}" ng-mouseenter="togglePrismaDocsCountPopup($event,true);" ng-mouseleave="togglePrismaDocsCountPopup($event,false)">'+'       <button type="button" class="btn prisma-btn-default btn-xs " id="externalVisitBtn{{patientId}}" ng-click="openPermissionDeniedModal(); togglePrismaDocsCountPopup($event,false); ">'+'           <i class="icon prisma-button nomargin"></i>'+'           <span ng-if="!miniMode">healow Insights </span>'+'<span ng-class="{\'prisma-count-green\' : true === isAnyIhubRecordExisted, \'prisma-count\': false === isAnyIhubRecordExisted, \'mr7\': false === miniMode}" ng-bind="totalCount"></span>'+'       </button>'+'   </div>'+'</div>'+'\x3c!-- HTML Content loader - Started --\x3e'+'<div ng-if="loadInHtml" class="prismaTotalDocCount{{patientId}}" ng-click="htmlPrismaCallback();">'+'    <div ng-if="callingFrom === \'floatingToolbar\'">'+'        <a href="#" id="externalVisitBtn{{patientId}}" title="PRISMA">'+'            <span ng-show="countExternalRecords > 0" class="notification-circle"></span>'+'            <i class="icon icon-nav-prisma"></i>'+'            <label class="ft-label" ng-bind="label"></label>'+'        </a>'+'    </div>'+'    <div ng-if="callingFrom === \'enc\'" id="prisma-external-rec">'+'        <a class="cursor fnt12" data-toggle="tab" data-target="#enc-external-rec" aria-expanded="true" title="healow Insights - External Encounters">'+'            <i class="icon prisma-button"></i>'+'            <label class="ft-label ml2" ng-bind="label"></label> <span ng-show="countExternalRecords > 0" class="enc-notification-circle"></span>'+'        </a>'+'    </div>'+'    <div ng-if="callingFrom === \'LabsModal\'" id="prisma-external-labs">'+'        <a id="hInsightsTabLink10" class="cursor" data-toggle="tab" data-target="#hInsightsGrid">'+'            <i class="icon prisma-button" style="height: 14px; margin-right: 2px;"></i>'+'            {{label}}'+'        </a>'+'        <span ng-if="isAnyExternalLab" class="ng-binding external-lab"></span>'+'    </div>'+'<div ng-if="contextPn === \'LabsModal\' || contextPn === \'externalTimeline\'" id="prisma-external-labs">'+'      <a  id="externalVisitBtn{{patientId}}" class="cursor" data-toggle="tab" data-target="#hInsightsGrid" title="View more details within healow Insights - PRISMA" ng-click="openPtExternalVisitModal();">'+'            View More '+'     </a>'+'   </div>'+'</div>'+'\x3c!-- HTML Content loader - Ended --\x3e'+'<div ng-if="!healowInsightBtnClicked" class="option-prompt" id="prismaDocCountPopup{{patientId}}">'+'    <div class="prompt-arrow">'+'        <div class="mb6 brdrbtm">'+'             <div class="mb5">Total records : <span ng-class="(totalCount > 0)?\'fw900\':\'\'">{{totalCount}}</span></div>'+'        </div>'+'        <ul class="pl15 nomarbot">'+'            <li>External records: <span ng-class="(countExternalRecords > 0)?\'fw900\':\'\'">{{countExternalRecords}}</span></li>'+'            <li>Internal records: <span ng-class="(countInternalRecords > 0)?\'fw900\':\'\'">{{countInternalRecords}}</span></li>'+'        </ul>'+'    </div>'+'</div>'+'</div>'+' <div  id="popover_content_wrapper" style="display: none"> '+'   <span class="glyphicon glyphicon-info-sign popover-heading" style="color: white"></span><span class="ml5" style="font-size: 14px;">External Records available in healow Insights!</span>'+'                <div class="source-content">'+'                     <div  ng-repeat="value  in listOfIhubSource track by $index"  style="white-space: normal;">'+'   <div ng-if="$index < 3" >'+'                    <div class="pull-left facility-icon">&nbsp;</div><div class="pull-left w300">{{value}} </div> <span class="clearfix"></span>'+'   </div></div>  '+'                     <div  ng-if="listOfIhubSource.length > 3 "><span class="pl20"> and more ... </span></div>  '+'                   </div> '+'<br/>'+'<div class="mb7">'+'<span>To turn off this notification. Go to: healow Insights > Settings </span>'+'</div>'+'                 </div>',controller:function($scope,$ocLazyLoad,$modal,PSACService){$scope.isPrismaEnabled=false;$scope.hasPrismaSecurityAccess=false;$scope.totalCount=0;$scope.countExternalRecords=0;$scope.isAnyExternalLab=true;$scope.countInternalRecords=0;$scope.healowInsightBtnClicked=false;$scope.isADTModule=$scope.adtModuleMode&&$scope.adtModuleMode===true?true:false;$scope.miniMode=$scope.miniMode&&$scope.miniMode===true?true:false;$scope.encounterId=$scope.encounterId?$scope.encounterId:0;$scope.listOfIhubSource=[];$scope.isAnyIhubRecordExisted=false;if($scope.patientId&&$scope.patientId>0){PrismaAppService.getPrismaEnableCheckPromise($scope.patientId,$scope.callingFrom==='LabsModal').then(function(data){if(undefined!==data&&undefined!==data.isPrismaEnable&&typeof data.isPrismaEnable==="boolean"&&data.isPrismaEnable){$scope.isPrismaEnabled=true;if(undefined!==data.documentsCount&&data.documentsCount["isAnyIhubRecordExisted"]){$scope.isAnyIhubRecordExisted=true}if(undefined!==data.documentsCount&&data.documentsCount["listOfIhubSource"]){$scope.listOfIhubSource=data.documentsCount.listOfIhubSource;displayIhubSourcePopOver()}if(undefined!==data.hasPrismaSecurityAccess&&typeof data.hasPrismaSecurityAccess==="boolean"){$scope.hasPrismaSecurityAccess=data.hasPrismaSecurityAccess}if(undefined!==data.documentsCount.externalRecordCount&&(typeof data.documentsCount.externalRecordCount==="number"||data.documentsCount.externalRecordCount==="N/A")){$scope.countExternalRecords=data.documentsCount.externalRecordCount}if(undefined!==data.documentsCount.internalRecordCount&&(typeof data.documentsCount.internalRecordCount==="number"||data.documentsCount.internalRecordCount==="N/A")){$scope.countInternalRecords=data.documentsCount.internalRecordCount}if(undefined!==data.documentsCount.totalDocumentCount&&typeof data.documentsCount.totalDocumentCount==="number"){$scope.totalCount=data.documentsCount.totalDocumentCount}if(undefined!==data.externalLabCount&&typeof data.externalLabCount==="number"){$scope.isAnyExternalLab=data.externalLabCount>0}PrismaAppService.setPossiblePSACEnc(data.documentsCount.possiblePSACEncs);PrismaAppService.setPrismaPSACSetting(data.prismaPSACSetting);PrismaAppService.setPaidModelEnabled(data.isPaidModelEnabled)}})}$scope.setParamAndOpenPtExternalVisitModal=function(patientId,encounterId,userId){$scope.patientId=patientId;$scope.encounterId=encounterId;$scope.userId=userId;$scope.openPtExternalVisitModal()};$scope.openPtExternalVisitModal=function(){if(!$scope.hasPrismaSecurityAccess){openPermissionDeniedModal();return}showPrismaScreenLoader();PrismaAppService.setPrismaContext($scope.$parent.context);if(PrismaAppService.isPrismaPopupInstanceOpen()){addDisabledPrismaButton();hidePrismaScreenLoader();ecwAlert("One instance of healow Insights is already open.  You cannot open another instance.","eClinicalWorks",null,"","bluetheme");$scope.removeDisableBtnTimer=$timeout(function(){removeDisabledPrismaButton()},PRISMA_CONSTANT.DIGIT.HUNDREAD);return}PrismaAppService.checkPatientAvailability($scope.patientId).then(function(data){if(undefined!==data&&undefined!==data.isPrismaUsableAfterTruncate&&typeof data.isPrismaUsableAfterTruncate==="boolean"&&!data.isPrismaUsableAfterTruncate){addDisabledPrismaButton();hidePrismaScreenLoader();PrismaAppService.showPrismaUnusableError();$scope.removeDisableBtnTimer=$timeout(function(){removeDisabledPrismaButton()},PRISMA_CONSTANT.DIGIT.HUNDREAD)}else if(undefined!==data&&undefined!==data.isPatientAvailable&&typeof data.isPatientAvailable==="boolean"&&data.isPatientAvailable){loadFilesAndOpenPrismaModal()}else{addDisabledPrismaButton();hidePrismaScreenLoader();ecwAlert("healow Insights will shortly be available once the patient's records are refreshed on the search server. Please try again in a few seconds.");$scope.removeDisableBtnTimer=$timeout(function(){removeDisabledPrismaButton()},PRISMA_CONSTANT.DIGIT.HUNDREAD)}})};function loadFilesAndOpenPrismaModal(){PrismaAppService.setADTModule($scope.isADTModule);PrismaAppService.setShowSearchPage($scope.showSearchPage&&parseInt($scope.showSearchPage)===1);let module;if(PrismaAppService.isPaidModelEnabled===true){module='ci-si'}else{module='default'}$ocLazyLoad.load({name:'',files:PrismaAppService.getDependencyFiles(module),serie:true,cache:true}).then(function(){verifyPSAC()},function(){hidePrismaScreenLoader()})}function verifyPSAC(){PrismaAppService.setBreakGlassReasonNo(false);if("yes"!==PrismaAppService.getPrismaPSACSetting().toLowerCase()&&PrismaAppService.getPossiblePSACEnc()&&"yes"===getItemKeyValue("EnablePSACBreakGlass").toLowerCase()){PSACService.callMultiplePrintChartOptions("",PrismaAppService.getPossiblePSACEnc(),function(){openDisclaimerModal()},function(){PrismaAppService.setBreakGlassReasonNo(true);openDisclaimerModal()},'PRISMA')}else{openDisclaimerModal()}}function openDisclaimerModal(){PrismaAppService.isContext($scope.contextPn);hidePrismaScreenLoader();let params={patientId:$scope.patientId};var modalScope=$scope.$new();modalScope.modalInstance=$modal.open({templateUrl:'/mobiledoc/jsp/webemr/toppanel/prisma/template/prisma-disclaimer-on-startup.html',windowClass:'fade bluetheme medium-width prismaDisclaimermodal',controller:'PrismaDisclaimerController',controllerAs:'prismaDisclaimerCtrl',backdrop:'static',keyboard:false,size:'sm',scope:modalScope,resolve:{requestParam:function(){return params}}});modalScope.modalInstance.result.then(function(){openPrismaModal()},function(){openPrismaModal()})}function openPrismaModal(){hidePrismaScreenLoader();var modalScope=$scope.$new();modalScope.modalInstance=$modal.open({templateUrl:'/mobiledoc/jsp/webemr/toppanel/prisma/template/prisma-modal-container.html',windowClass:'fade modalProp prismaview prisma-vtwo full-width',controller:'PrismaModalController',controllerAs:'prismaCtrl',backdrop:'static',keyboard:false,size:'lg',scope:modalScope})}$scope.openPermissionDeniedModal=function(){addDisabledPrismaButton();ecwAlert('You are not given access to view this page. This can be changed from security settings. Security attribute: Allow Access to healow Insights');$scope.removeDisableBtnTimer=$timeout(function(){removeDisabledPrismaButton()},PRISMA_CONSTANT.DIGIT.HUNDREAD)};$scope.htmlPrismaCallback=function(){if(PrismaAppService.getCallingFrom()!==$scope.callingFrom){if(!$scope.hasPrismaSecurityAccess){ecwAlert('You are not given access to view this page. This can be changed from security settings. Security attribute: Allow Access to healow Insights');$scope.openPrismaCallback({hasPrismaAccess:false});return}if(PrismaAppService.isPrismaPopupInstanceOpen()){ecwAlert("One instance of healow Insights is already open.  You cannot open another instance.","eClinicalWorks",null,"","bluetheme");$scope.openPrismaCallback({hasPrismaAccess:false});return}PrismaAppService.checkPatientAvailability($scope.patientId).then(function(data){if(undefined!==data&&undefined!==data.isPrismaUsableAfterTruncate&&typeof data.isPrismaUsableAfterTruncate==="boolean"&&!data.isPrismaUsableAfterTruncate){PrismaAppService.showPrismaUnusableError();$scope.openPrismaCallback({hasPrismaAccess:false})}else if(undefined!==data&&undefined!==data.isPatientAvailable&&typeof data.isPatientAvailable==="boolean"&&data.isPatientAvailable){$scope.openPrismaCallback({hasPrismaAccess:true})}else{ecwAlert("healow Insights will shortly be available once the patient's records are refreshed on the search server. Please try again in a few seconds.");$scope.openPrismaCallback({hasPrismaAccess:false})}})}else{$scope.openPrismaCallback({hasPrismaAccess:true})}};$scope.togglePrismaDocsCountPopup=function(event,toggleDisplay){var _that=angular.element(event.target).closest('.prismaTotalCountParent').find('.prismaTotalDocCount'+$scope.patientId);angular.element(event.target).closest('.prismaTotalCountParent').find('#prismaDocCountPopup'+$scope.patientId).toggle(toggleDisplay).animate({},PRISMA_CONSTANT.DIGIT.HUNDREAD,function(){angular.element(this).position({of:_that,my:'right+175 top+10',at:'left bottom'}).animate({"opacity":1},PRISMA_CONSTANT.DIGIT.HUNDREAD)});event.stopPropagation()};const init=()=>{$observableService.subscribe('prismaModalClosed',function(){$scope.healowInsightBtnClicked=false});$observableService.subscribe('prismaModalOpened',function(){$scope.healowInsightBtnClicked=true;$('.action-hub-modal').remove()})};init();function displayIhubSourcePopOver(){if($scope.contextPn==='progressnotes'&&$scope.listOfIhubSource&&$scope.listOfIhubSource.length>0){$scope.showPopOver=$timeout(function(){angular.element(".prismaTotalCountParent").popover({placement:'bottom',title:'<span class="pull-right close-popover" id="closePopover"></span>',html:true,content:function(){return angular.element('#popover_content_wrapper').html()}}).popover('show');angular.element('#closePopover').on('click',function(e){angular.element(".prismaTotalCountParent").popover('hide')})},PRISMA_CONSTANT.DIGIT.HUNDREAD);$scope.popoverTimeout=$timeout(function(){angular.element(".prismaTotalCountParent").popover('hide')},PRISMA_CONSTANT.DIGIT.SEVEN_THOUSAND);PrismaAppService.updateViewedToasterDate($scope.patientId)}}function addDisabledPrismaButton(){angular.element('#externalVisitBtn'+$scope.patientId).addClass('disableEl')}function removeDisabledPrismaButton(){angular.element('#externalVisitBtn'+$scope.patientId).removeClass('disableEl')}function hidePrismaScreenLoader(){angular.element('#prisma-screen-loading'+$scope.patientId).hide()}function showPrismaScreenLoader(){angular.element('#prisma-screen-loading'+$scope.patientId).show()}},link:function(scope,element){scope.$on('$destroy',function(){$timeout.cancel(scope.popoverTimeout);$timeout.cancel(scope.showPopOver);$timeout.cancel(scope.removeDisableBtnTimer);angular.element('#closePopover').off('click',function(e){angular.element(".prismaTotalCountParent").popover('hide')});$observableService.unsubscribe('prismaModalClosed');$observableService.unsubscribe('prismaModalOpened')})}}});
(function(){let doseListApp=angular.module('ecw.patientCentricDosing',['ecw.recommendedDosing','ecw.favorites','ecw.emarRx','ecw.customRx']);doseListApp.component('patientCentricDosing',{bindings:{doseRefreshId:'<',requestParam:'=',topClass:'=',context:'=',contextClass:'@',showHideLevel2:'&',updateStyle:'&',selectCallBack:'&',epaSelectCallBack:'&',successCallback:'&',customRxCallback:'&'},controller:['$http','$timeout',patientCentricDosingController],controllerAs:'vm',templateUrl:"/mobiledoc/jsp/webemr/progressnotes/ecwrx/patientCentricDosing/html/patientCentricDoseList-tpl.html",transclude:true});function patientCentricDosingController($http,$timeout){let vm=this;vm.bEnabledFormulary=getItemKeyValue("isFormularyEnabled").toLowerCase()=="yes";vm.MedispanId=getItemKeyValue("MedispanRx",true);vm.customRxId=getItemKeyValue("CustomRx",true);vm.clickBackHandler=function(){vm.showHideLevel2({arg0:'hide'})};vm.isCustomRx=false;vm.isTemplatePatient=false;function initialize(){vm.isCustomRx=false;vm.isRecommendedRx=false;vm.drugNameItem={};vm.favorites=[];vm.emarRxs=[];vm.customRxs=[]}vm.recommendedDosingCallback=function(isNoDosingEnabled,drugNameItem){vm.isRecommendedRx=isNoDosingEnabled;vm.drugNameItem=drugNameItem;vm.loadFavorites(false);if(vm.successCallback){vm.successCallback()}};function patientCentricDosingTab(e){e.preventDefault()}function trimInt(val){var retValue=0;try{retValue=angular.isUndefined(val)||val===null||val===''||val==='null'?0:parseInt(val,10)}catch(e){retValue=0}return retValue}function checkNullAndUndefined(val){return angular.isUndefined(val)||val===null||val===''||val==='null'||val==='undefined'?true:false}vm.$onChanges=function(changes){if(trimInt(getItemKeyValue("TemplatePatientId",true))===trimInt(vm.requestParam.patientId)){vm.isTemplatePatient=true}if(!vm.isTemplatePatient&&vm.context!=='ImmTherapeuticInjections'&&vm.context!=='anesthesia'&&vm.context!=='frmOSAdmin'){vm.loadPatientProfile();vm.loadDiagnosis()}if(changes.doseRefreshId.currentValue>0){initialize();vm.setRefreshId();$timeout(function(){$('#patientCentricDoseTab a#drugDbRecommendedDosing').tab('show')});if(vm.requestParam.parentId==vm.customRxId){vm.isCustomRx=true;vm.loadCustomRxs()}}vm.updateStyle()};vm.updateStyleForRecommandedDose=function(){$timeout(function(){if(vm.updateStyle){vm.updateStyle()}})};vm.setRefreshId=function(){vm.requestParam.refreshId=vm.doseRefreshId};vm.selectDoseCallback=function(obj){vm.selectCallBack({arg0:obj})};vm.selectEpaCallback=function(obj){vm.epaSelectCallBack({arg0:obj})};vm.favRefreshCallback=function(){vm.loadFavorites(true)};vm.patientProfile={};vm.loadPatientProfile=function(){let requestData={encounterId:vm.requestParam.encounterId,patientId:vm.requestParam.patientId};let promise=$http({method:'GET',url:'/mobiledoc/cpoe/patientprofile/get',params:requestData,headers:{}});promise.then(function(data){vm.patientProfile=data.data})};vm.diagnosis=[];vm.loadDiagnosis=function(){let requestData={encounterId:vm.requestParam.encounterId,patientId:vm.requestParam.patientId};let promise=$http({method:'GET',url:'/mobiledoc/cpoe/assessments/get',params:requestData,headers:{}});promise.then(function(data){vm.diagnosis=data.data;vm.updateStyleForRecommandedDose()})};vm.isDiagnosisExist=function(){if(checkNullAndUndefined(vm.diagnosis)){return false}if(vm.checkICD9CodesExist()===false&&vm.checkICD10CodesExist()===false){return false}return true};vm.checkICD9CodesExist=function(){if(checkNullAndUndefined(vm.diagnosis.icd9Codes)||vm.diagnosis.icd9Codes.length===0){return false}return true};vm.checkICD10CodesExist=function(){if(checkNullAndUndefined(vm.diagnosis.icd10Codes)||vm.diagnosis.icd10Codes.length===0){return false}return true};vm.favorites=[];vm.formularyInfo={};vm.loadFavorites=function(isRefreshCall){let requestData={drugNameId:vm.drugNameItem.drugNameId,userId:global.TrUserId};let promise=$http({method:'GET',url:'/mobiledoc/cpoe/favoriterx',params:requestData,headers:{}});promise.then(function(data){vm.favorites=data.data;if(!angular.isUndefined(vm.favorites)&&vm.favorites!=null&&vm.favorites.length>0){if(vm.requestParam.isformularyDoses&&vm.drugNameItem&&vm.drugNameItem.drugNameId>0){vm.formularyInfo={CoverageId:vm.requestParam.coverageId,FormularyID:vm.requestParam.formularyID,FormularySourceCode:vm.requestParam.formularySourceCode,CopayId:vm.requestParam.CopayId,AlternativeId:vm.requestParam.AlternativeId};vm.loadFormularyFavRxDoses()}}if(!isRefreshCall){$timeout(function(){if(vm.requestParam.rxType===1||vm.requestParam.rxType==='1'){$('#patientCentricDoseTab a#drugDbFavorites').tab('show');vm.isRecommendedRx=false}else if(!vm.isCustomRx&&vm.isRecommendedRx&&vm.favorites.length>0){$('#patientCentricDoseTab a#drugDbFavorites').tab('show');vm.isRecommendedRx=false}else if(!vm.isCustomRx){vm.isRecommendedRx=false;$('#patientCentricDoseTab a#drugDbRecommendedDosing').tab('show')}if(vm.bEnabledFormulary){vm.loadEmarRxs()}})}})};vm.loadFormularyFavRxDoses=function(){vm.formularyFavDosageResultSet=[];vm.showObsoleteMessage=false;vm.showDiscontinuedRxIcon=false;if(!angular.isUndefined(vm.favorites)&&vm.favorites!=null&&vm.favorites.length>0){vm.formularyFavDosageResultSet=vm.favorites;vm.setDataForFavRxFormulary()}};vm.setDataForFavRxFormulary=function(){for(var i=0;i<vm.formularyFavDosageResultSet.length;i++){if(vm.formularyFavDosageResultSet[i].drugOTC==="O"||vm.formularyFavDosageResultSet[i].drugOTC==="2"||vm.formularyFavDosageResultSet[i].drugOTC==="3"){vm.formularyFavDosageResultSet[i].OTC="O"}else if(vm.formularyFavDosageResultSet[i].drugOTC==="R"||vm.formularyFavDosageResultSet[i].drugOTC==="1"){vm.formularyFavDosageResultSet[i].OTC="P"}else if(vm.formularyFavDosageResultSet[i].drugOTC===""){vm.formularyFavDosageResultSet[i].OTC="U"}if(vm.formularyFavDosageResultSet[i].drugNameType==="N"||vm.formularyFavDosageResultSet[i].drugNameType==="B"||vm.formularyFavDosageResultSet[i].drugNameType==="2"||vm.formularyFavDosageResultSet[i].drugNameType==="1"){vm.formularyFavDosageResultSet[i].GBO="B"}else if(vm.formularyFavDosageResultSet[i].drugNameType==="T"||vm.formularyFavDosageResultSet[i].drugNameType==="3"||vm.formularyFavDosageResultSet[i].drugNameType==="G"){vm.formularyFavDosageResultSet[i].GBO="G"}}vm.checkFormularyForFavDrug()};vm.checkFormularyForFavDrug=function(){var xml="";var xw=new XMLWriter;startSoapPacket(xw);xw.writeStartElement('Info');xw.writeAttributeString('xsi:type','xsd:string');xw.writeStartElement('RxList');xw.writeAttributeString('xsi:type','xsd:string');for(var i=0;i<vm.formularyFavDosageResultSet.length;i++){xw.writeStartElement('Row');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,"NDCCode",vm.formularyFavDosageResultSet[i].ndc,'xsi:type','xsd:string');xw.writeEndElement()}xw.writeEndElement();xw.writeEndElement();endSoapPacket(xw);xml=xw.flush();vm.formularyDataForFavDrug=[];vm.dosageResultSetGreenDrugs=[];vm.dosageResultSetOrangeDrugs=[];vm.dosageResultSetYellowDrugs=[];vm.dosageResultSetRedDrugs=[];vm.dosageResultSetBlackDrugs=[];if(vm.requestParam.coverageId===null||typeof vm.requestParam.coverageId===null||vm.requestParam.coverageId==="null")vm.requestParam.coverageId="";var strUrl="/mobiledoc/jsp/webemr/progressnotes/ecwrx/RxHelper/checkFormularyForDrug.jsp?FormularyId="+vm.requestParam.formularyID+"&FormSourceId="+vm.requestParam.formularySourceCode+"&CoverageId="+vm.requestParam.coverageId;var params="strData="+xml;var responsePromise=vm.LoadURL(strUrl,params);responsePromise.success(function(data){if(data.trim().length>0){var x2js=new X2JS;var jsonobj=x2js.xml_str2json(data.trim());if(typeof jsonobj!="undefined"&&getKeyLength(jsonobj.Envelope.Body['return'].resultset.data.rows)>0){if(jsonobj.Envelope.Body['return'].resultset.data.rows.length>0){vm.formularyDataForFavDrug=jsonobj.Envelope.Body['return'].resultset.data.rows}else{vm.formularyDataForFavDrug.push(jsonobj.Envelope.Body['return'].resultset.data.rows)}vm.calculateFavRaxFormulary();vm.sortFavDrugsByFormulary()}}})};vm.LoadURL=function(strUrl,data){return $http({method:'POST',url:makeURL(strUrl),data:data,"async":true,headers:{'Content-Type':'application/x-www-form-urlencoded'}})};vm.calculateFavRaxFormulary=function(){for(var i=0;i<vm.formularyFavDosageResultSet.length;i++){for(var j=i;j<vm.formularyDataForFavDrug.length;j++){if(vm.formularyDataForFavDrug[j].NDC_Code===vm.formularyFavDosageResultSet[i].ndc){if(vm.formularyDataForFavDrug[j].FormularyStatus==="01"){vm.formularyFavDosageResultSet[i].FormularyStatus="1"}else if(vm.formularyDataForFavDrug[j].FormularyStatus==="02"){vm.formularyFavDosageResultSet[i].FormularyStatus="2"}else if(vm.formularyDataForFavDrug[j].FormularyStatus==="03"){vm.formularyFavDosageResultSet[i].FormularyStatus="3"}else if(vm.formularyDataForFavDrug[j].FormularyStatus==="00"){vm.formularyFavDosageResultSet[i].FormularyStatus="0"}else{vm.formularyFavDosageResultSet[i].FormularyStatus=vm.formularyDataForFavDrug[j].FormularyStatus}if(vm.formularyDataForFavDrug[j].PARequired==="Yes"){vm.formularyFavDosageResultSet[i].PARequired=true}else{vm.formularyFavDosageResultSet[i].PARequired=false}break}}}for(var i=0;i<vm.formularyFavDosageResultSet.length;i++){var strFormularyStatus=vm.formularyFavDosageResultSet[i].FormularyStatus;if(strFormularyStatus===""){if(vm.formularyFavDosageResultSet[i].GBO==="B"&&vm.formularyFavDosageResultSet[i].OTC==="O"){if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()==="Unknown"){vm.formularyFavDosageResultSet[i].FormularyStatus="U"}else if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()===""){vm.formularyFavDosageResultSet[i].FormularyStatus=""}else if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()==="Not Reimbursable"){vm.formularyFavDosageResultSet[i].FormularyStatus="0"}else if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()==="Non Formulary"){vm.formularyFavDosageResultSet[i].FormularyStatus="1"}else if(vm.requestParam.NLRxBrandOTC_FS.split(":")[1].trim()==="On Formulary(Not Preferred)"){vm.formularyFavDosageResultSet[i].FormularyStatus="2"}else{if(vm.requestParam.NLRxBrandOTC_FS!==""){if(vm.isNumeric(vm.Right(vm.requestParam.NLRxBrandOTC_FS.trim(),2))){var nPrefLevel=vm.Right(vm.requestParam.NLRxBrandOTC_FS.trim(),2)+2;vm.formularyFavDosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(vm.formularyFavDosageResultSet[i].GBO==="B"&&vm.formularyFavDosageResultSet[i].OTC==="P"){if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()==="Unknown"){vm.formularyFavDosageResultSet[i].FormularyStatus="U"}else if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()===""){vm.formularyFavDosageResultSet[i].FormularyStatus=""}else if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()==="Not Reimbursable"){vm.formularyFavDosageResultSet[i].FormularyStatus="0"}else if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()==="Non Formulary"){vm.formularyFavDosageResultSet[i].FormularyStatus="1"}else if(vm.requestParam.NLRxBrand_FS.split(":")[1].trim()==="On Formulary(Not Preferred)"){vm.formularyFavDosageResultSet[i].FormularyStatus="2"}else{if(vm.requestParam.NLRxBrand_FS!==""){if(vm.isNumeric(vm.Right(vm.requestParam.NLRxBrand_FS.trim(),2))){var nPrefLevel=vm.Right(vm.requestParam.NLRxBrand_FS.trim(),2)+2;vm.formularyFavDosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(vm.formularyFavDosageResultSet[i].GBO==="G"&&vm.formularyFavDosageResultSet[i].OTC==="O"){if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()==="Unknown"){vm.formularyFavDosageResultSet[i].FormularyStatus="U"}else if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()===""){vm.formularyFavDosageResultSet[i].FormularyStatus=""}else if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()==="Not Reimbursable"){vm.formularyFavDosageResultSet[i].FormularyStatus="0"}else if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()==="Non Formulary"){vm.formularyFavDosageResultSet[i].FormularyStatus="1"}else if(vm.requestParam.NLRxGenericOTC_FS.split(":")[1].trim()==="On Formulary(Not Preferred)"){vm.formularyFavDosageResultSet[i].FormularyStatus="2"}else{if(vm.requestParam.NLRxGenericOTC_FS!==""){if(vm.isNumeric(vm.Right(vm.requestParam.NLRxGenericOTC_FS.trim(),2))){var nPrefLevel=vm.Right(vm.requestParam.NLRxGenericOTC_FS.trim(),2)+2;vm.formularyFavDosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}else if(vm.formularyFavDosageResultSet[i].GBO==="G"&&vm.formularyFavDosageResultSet[i].OTC==="P"){if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()==="Unknown"){vm.formularyFavDosageResultSet[i].FormularyStatus="U"}else if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()===""){vm.formularyFavDosageResultSet[i].FormularyStatus=""}else if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()==="Not Reimbursable"){vm.formularyFavDosageResultSet[i].FormularyStatus="0"}else if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()==="Non Formulary"){vm.formularyFavDosageResultSet[i].FormularyStatus="1"}else if(vm.requestParam.NLRxGeneric_FS.split(":")[1].trim()==="On Formulary(Not Preferred)"){vm.formularyFavDosageResultSet[i].FormularyStatus="2"}else{if(vm.requestParam.NLRxGeneric_FS!==""){if(vm.isNumeric(vm.Right(vm.requestParam.NLRxGeneric_FS.trim(),2))){var nPrefLevel=vm.Right(vm.requestParam.NLRxGeneric_FS.trim(),2)+2;vm.formularyFavDosageResultSet[i].FormularyStatus=nPrefLevel.trim().toString()}}}}}if(typeof vm.formularyFavDosageResultSet[i].FormularyStatus==undefined){vm.formularyFavDosageResultSet[i].FormularyStatus="U"}if(vm.formularyFavDosageResultSet[i].FormularyStatus===""){vm.formularyFavDosageResultSet[i].FormularyStatus="U"}var nColorCode=vm.getProductStatusColorCode(vm.formularyFavDosageResultSet[i].FormularyStatus);switch(nColorCode){case"white":vm.favorites[i].formularypic="icon-black-question";vm.favorites[i].formularypictooltip="Formulary Status - Unknown";vm.dosageResultSetBlackDrugs.push(vm.favorites[i]);break;case"red":vm.favorites[i].formularypic="icon-red-face";vm.favorites[i].formularypictooltip="Formulary Status - Not Covered";vm.dosageResultSetRedDrugs.push(vm.favorites[i]);break;case"orange":vm.favorites[i].formularypic="icon-orange-face";vm.favorites[i].formularypictooltip="Formulary Status - Non Formulary";vm.dosageResultSetOrangeDrugs.push(vm.favorites[i]);break;case"yellow":vm.favorites[i].formularypic="icon-yellow-face";vm.favorites[i].formularypictooltip="Formulary Status - On Formulary";vm.dosageResultSetYellowDrugs.push(vm.favorites[i]);break;default:vm.favorites[i].formularypic="icon-green-face";vm.favorites[i].formularypictooltip="Formulary Status - Preferred Drugs";vm.dosageResultSetGreenDrugs.push(vm.favorites[i]);break}}};vm.isNumeric=function(obj){return!Array.isArray(obj)&&obj-parseFloat(obj)+1>=0};vm.Right=function(str,nextCharlength){return str.substring(str.length-2,str.length)};vm.getProductStatusColorCode=function(strProductStatusCode){switch(strProductStatusCode){case"U":return"white";break;case"0":return"red";case"00":return"red";break;case"1":return"orange";break;case"01":return"orange";break;case"2":return"yellow";break;case"02":return"yellow";break;case"":return"white";break;default:return"green";break}};vm.sortFavDrugsByFormulary=function(){vm.favorites=[];vm.favorites=vm.favorites.concat(vm.dosageResultSetGreenDrugs);vm.favorites=vm.favorites.concat(vm.dosageResultSetYellowDrugs);vm.favorites=vm.favorites.concat(vm.dosageResultSetOrangeDrugs);vm.favorites=vm.favorites.concat(vm.dosageResultSetRedDrugs);vm.favorites=vm.favorites.concat(vm.dosageResultSetBlackDrugs)};vm.emarRxs=[];vm.loadEmarRxs=function(){if(vm.context!=='treatmentscreen'&&vm.context!=='PNscreen'&&vm.context!=='addRx'){return}let requestData={drugNameId:vm.drugNameItem.drugNameId,facilityId:vm.requestParam.facilityId};let promise=$http({method:'GET',url:'/mobiledoc/cpoe/emarrx',params:requestData,headers:{}});promise.then(function(data){vm.emarRxs=data.data;if((vm.requestParam.nIsFormularyFilter==='1'||vm.requestParam.nIsFormularyFilter===1)&&vm.emarRxs&&vm.emarRxs.length>0){$timeout(function(){$('#patientCentricDoseTab a#drugDbEmarRx').tab('show')})}})};vm.customRxs=[];function convertToResponseObj(doseObj){var newObj={};newObj.AdministerFlag="0";newObj.DispenseFlag="0";newObj.DrugNameId=doseObj.drugNameId;newObj.IVHydration="0";newObj.IsRxSupplies=doseObj.rxSupplies||"NO";newObj.ItemId=doseObj.itemId;newObj.RxItemId=doseObj.itemId;newObj.drugName=doseObj.description;newObj.sItemName=doseObj.description;newObj.MMDCode=doseObj.mmdcode||"";newObj.ObsoleteDate=doseObj.obsoleteDate||"";newObj.awup="";newObj.controlled=doseObj.controlled||"";newObj.controlledCode=doseObj.controlledSubstanceCode||"";newObj.description=doseObj.description;newObj.dispense=doseObj.dispense||"";newObj.doseunit="";newObj.drugNameType=doseObj.drugNameType||"";newObj.drugOTC=doseObj.drugOTC||"";newObj.duration=doseObj.duration;newObj.favorite="0";newObj.formulation=doseObj.formulation;newObj.freq=doseObj.frequency;newObj.isCompound="0";if(doseObj.ndc==null){newObj.ndc='';newObj.NDC=''}else{newObj.ndc=doseObj.ndc;newObj.NDC=doseObj.ndc}newObj.refills=doseObj.refills||"";newObj.route=doseObj.route;newObj.rxFormulary="";newObj.rxFormularyId="";newObj.strength=doseObj.strength;newObj.take=doseObj.take;newObj.AddInstructions="";if(vm.requestParam.dxId){newObj.assessId=vm.requestParam.dxId}else{newObj.assessId="0"}return newObj}vm.loadCustomRxs=function(){let requestData={itemId:vm.requestParam.itemId};let promise=$http({method:'GET',url:'/mobiledoc/cpoe/customrx',params:requestData,headers:{}});promise.then(function(data){if(data.data&&data.data.description!==''){vm.customRxs=[];vm.customRxs.push(data.data)}if(vm.customRxCallback){var customRxsArray=null;if(vm.customRxs.length>0){customRxsArray=convertToResponseObj(vm.customRxs[0])}vm.customRxCallback({arg0:customRxsArray})}$timeout(function(){$('#patientCentricDoseTab a#drugDbCustomRx').tab('show')})})}}})();
(function(){var telemedBandwidth=angular.module("ecw.telemed.service");if(!telemedBandwidth){return}telemedBandwidth.service("telemedCallBandwidthService",["telemedLoggingService","telemedAPIService",function(telemedLoggingService,telemedAPIService){let bandwidthInterval=null;let assessmentWindow=0;let minBitRateinkbps=350;let minPacketLossInPercentage=.5;let listOfStreamObject={};let isTVFullView=true;var url='/mobiledoc/jsp/telemed/telemedResponse.jsp';var data={"action":"getTblPortalMiscItemKeyValue","itemKey":"telemedVideoSignalAssessmentWindow"};telemedAPIService.invokePost(url,data).success(function(res){try{assessmentWindow=parseInt(res!=null&&res.trim()!==""?res:"0",10|0)}catch(e){assessmentWindow=0}}).error(function(error){telemedLoggingService.error("Error while getting bandwidth assessment window details")});function setTVView(isFullView){isTVFullView=isFullView}function calculateDeltas(type,currStat,userObject){let prevStat=userObject.streamPrevStats;let statType=userObject.streamType;let bitrates={};if(currStat[type]&&prevStat[type]){let bytesIncreased=0;let packetsReceived=0;if("subscriber"===statType){bytesIncreased=currStat[type].bytesReceived?currStat[type].bytesReceived-prevStat[type].bytesReceived:0;packetsReceived=currStat[type].packetsReceived-prevStat[type].packetsReceived}else if("publisher"===statType){bytesIncreased=currStat[type].bytesSent?currStat[type].bytesSent-prevStat[type].bytesSent:0;packetsReceived=currStat[type].packetsSent-prevStat[type].packetsSent}const bitsIncreased=bytesIncreased*8;const kilobitsIncreased=bitsIncreased/1e3;const msIncreased=currStat.timestamp-prevStat.timestamp;const secondsElapsed=msIncreased/1e3;const bandwidthKbps=kilobitsIncreased/secondsElapsed;const frameRate=currStat[type].frameRate;const packetsLost=currStat[type].packetsLost-prevStat[type].packetsLost;let videoPacketLossRatio=0;if(packetsLost>0&&packetsReceived>0){videoPacketLossRatio=packetsLost/(packetsLost+packetsReceived)}bitrates={"bitrateskbps":bandwidthKbps,"videoPacketLossRatio":videoPacketLossRatio,"frameRate":frameRate}}return bitrates}function getTelemedCallBandwidth(streamObject,userId){if(assessmentWindow>0){let isPublisher=streamObject.element.className.search("OT_publisher")!==-1;let isSubscriber=streamObject.element.className.search("OT_subscriber")!==-1;let streamObjectDiv=$("#"+streamObject.id);let subscriberVideoSignalDiv='<div id="VideoSignalDiv" class="VideoSignalDiv">';if(isPublisher){subscriberVideoSignalDiv+='<div id="VideoSignalStrength" class= "top-right" >'+'<div class= "publishertooltip">'+'<i id="VideoSignalStrengthIcon" class="icon icon-video-signal-strength-green"></i>'+'<div id="tooltiptext" class="publishertooltiptext">'}else if(isSubscriber){subscriberVideoSignalDiv+='<div id="VideoSignalStrength" class="bottom-right">'+'<div class= "subscribertooltip" >'+'<i id="VideoSignalStrengthIcon" class="icon icon-video-signal-strength-green"></i>'+'<div id= "tooltiptext" class="subscribertooltiptext">'}subscriberVideoSignalDiv+='<span class="col-sm-5 titleColumn">Connection</span>'+'<span class="col-xs-1 titleColumn">:</span>'+'<span class="col-sm-6 valueColumn" id="connectionStrength">Checking...</span>'+'<span class="col-sm-5 titleColumn">BitRate</span>'+'<span class="col-xs-1 titleColumn">:</span>'+'<span class="col-sm-6 valueColumn" id="connectionBitRate">Checking...</span>'+'<span class="col-sm-5 titleColumn">PacketLoss</span>'+'<span class="col-xs-1 titleColumn">:</span>'+'<span class="col-sm-6 valueColumn" id="connectionPLRatio">Checking...</span>'+'</div></div>'+'</div></div>';if(streamObjectDiv.find("#VideoSignalDiv").length==0){angular.element(streamObjectDiv.find(".OT_widget-container")[0]).append(subscriberVideoSignalDiv)}if(isPublisher){streamObjectDiv.css('overflow','visible');streamObjectDiv.find(".OT_widget-container").css('overflow','visible')}if(streamObject.stream&&streamObject.stream.hasVideo||isPublisher){streamObjectDiv.find(".VideoSignalDiv").css({"display":"contents"})}if(!listOfStreamObject[userId]){listOfStreamObject[userId]={"streamObject":streamObject,"streamType":isPublisher?"publisher":"subscriber","streamPrevStats":null,"videoRedSignalCount":0,"overallPL":0,"overallBR":0,"totalInterval":0,"overallFR":0}}else{listOfStreamObject[userId].streamObject=streamObject;listOfStreamObject[userId].streamPrevStats=null}setTelemedCallBandwidthValue(userId);if(bandwidthInterval==null){bandwidthInterval=setInterval(function(){$.each(listOfStreamObject,function(key){if(isTVFullView){setTelemedCallBandwidthValue(key)}})},assessmentWindow)}}}function setTelemedCallBandwidthValue(key){let userObject=listOfStreamObject[key];let videoStreamObject=userObject.streamObject;let videoStreamObjectDiv=$("#"+videoStreamObject.id);if(videoStreamObject.stream&&videoStreamObject.stream.hasVideo){videoStreamObjectDiv.find(".VideoSignalDiv").css({"display":"contents"});videoStreamObject.getStats(function(error,stats){if(error){telemedLoggingService.debug('Error getting stats. ',error.message);return}let stat=userObject.streamType==="publisher"?stats[0].stats:stats;if(stat&&userObject.streamPrevStats){let calculatedDates=calculateDeltas('video',stat,userObject);let videoPacketLossRatio=calculatedDates.videoPacketLossRatio;let videoBitRateKb=calculatedDates.bitrateskbps;let frameRate=calculatedDates.frameRate;userObject.overallPL=userObject.overallPL+videoPacketLossRatio;userObject.overallBR=userObject.overallBR+videoBitRateKb;userObject.overallFR=userObject.overallFR+frameRate;userObject.totalInterval=userObject.totalInterval+1;if(videoBitRateKb>minBitRateinkbps&&videoPacketLossRatio<minPacketLossInPercentage){videoStreamObjectDiv.find("#VideoSignalStrengthIcon").addClass("icon-video-signal-strength-green").removeClass("icon-video-signal-strength-red");videoStreamObjectDiv.find("#VideoSignalStrength").find("#tooltiptext").find("#connectionStrength").html("Good");videoStreamObjectDiv.find("#VideoSignalStrength").find("#tooltiptext").find("#connectionBitRate").html(videoBitRateKb.toFixed(0)+"Kbps");videoStreamObjectDiv.find("#VideoSignalStrength").find("#tooltiptext").find("#connectionPLRatio").html(videoPacketLossRatio.toFixed(2)+"%")}else if(videoBitRateKb<=minBitRateinkbps||videoPacketLossRatio>=minPacketLossInPercentage){videoStreamObjectDiv.find("#VideoSignalStrengthIcon").removeClass("icon-video-signal-strength-green").addClass("icon-video-signal-strength-red");videoStreamObjectDiv.find("#VideoSignalStrength").find("#tooltiptext").find("#connectionStrength").html("Poor");videoStreamObjectDiv.find("#VideoSignalStrength").find("#tooltiptext").find("#connectionBitRate").html(videoBitRateKb.toFixed(0)+"Kbps");videoStreamObjectDiv.find("#VideoSignalStrength").find("#tooltiptext").find("#connectionPLRatio").html(videoPacketLossRatio.toFixed(2)+"%");telemedLoggingService.debug(userObject.streamType);telemedLoggingService.debug('There is a problem in Video Signal Strength.');telemedLoggingService.debug(' bitrateskbps : '+videoBitRateKb);telemedLoggingService.debug(' videoPacketLossRatio : '+videoPacketLossRatio);userObject.videoRedSignalCount=userObject.videoRedSignalCount+1}if(userObject.videoRedSignalCount===5){userObject.videoRedSignalCount=0}}userObject.streamPrevStats=stat})}else{userObject.streamPrevStats=null;videoStreamObjectDiv.find(".VideoSignalDiv").css({"display":"none"});videoStreamObjectDiv.find("#VideoSignalStrength").addClass("icon-video-signal-strength-green").removeClass("icon-video-signal-strength-red")}}function hideBandwidthDiv(streamObject){if(assessmentWindow>0){$("#"+streamObject.id).find(".VideoSignalDiv").css({"display":"none"})}}function showBandwidthDiv(streamObject){if(assessmentWindow>0){$("#"+streamObject.id).find(".VideoSignalDiv").css({"display":"contents"})}}function clearAllBandwidthStream(){if(assessmentWindow>0){if(bandwidthInterval){clearInterval(bandwidthInterval);bandwidthInterval=null}$.each(listOfStreamObject,function(key){let videoStreamObject=listOfStreamObject[key].streamObject;if(videoStreamObject&&$("#"+videoStreamObject.id)){$("#"+videoStreamObject.id).find(".VideoSignalDiv").remove()}delete listOfStreamObject[key]})}}function clearBandwidthStream(userId){if(assessmentWindow>0){let object=listOfStreamObject[userId];if(object.streamObject&&$("#"+object.streamObject.id)){$("#"+object.streamObject.id).find(".VideoSignalDiv").remove()}}}function resetBandwidthDiv(userId){if(assessmentWindow>0){let streamObjectDiv=$("#"+listOfStreamObject[userId].streamObject.id);listOfStreamObject[userId].videoRedSignalCount=0;listOfStreamObject[userId].streamPrevStats=null;streamObjectDiv.find("#VideoSignalStrengthIcon").addClass("icon-video-signal-strength-green").removeClass("icon-video-signal-strength-red");streamObjectDiv.find("#VideoSignalStrength").find("#publishertooltiptext").find("#connectionStrength").html("Checking...");streamObjectDiv.find("#VideoSignalStrength").find("#publishertooltiptext").find("#connectionBitRate").html("Checking...");streamObjectDiv.find("#VideoSignalStrength").find("#publishertooltiptext").find("#connectionPLRatio").html("Checking...")}}function calculateOverollCallDeltas(key){let bitrates={};if(listOfStreamObject[key]){let videoPacketLossRatio=0;let connectionQuality="";let bandwidthKbps=0;let frameRate=0;videoPacketLossRatio=listOfStreamObject[key].overallPL/listOfStreamObject[key].totalInterval;bandwidthKbps=listOfStreamObject[key].overallBR/listOfStreamObject[key].totalInterval;frameRate=listOfStreamObject[key].overallFR/listOfStreamObject[key].totalInterval;if(bandwidthKbps>minBitRateinkbps&&videoPacketLossRatio<minPacketLossInPercentage){connectionQuality="Good"}else{connectionQuality="Poor"}bitrates={"connectionQuality":connectionQuality,"bitrateskbps":bandwidthKbps,"videoPacketLossRatio":videoPacketLossRatio,"frameRate":frameRate}}return bitrates}function logCallBandwidthDetails(){try{if(!listOfStreamObject){return}let result={};$.each(listOfStreamObject,function(key){let videoStreamObject=listOfStreamObject[key];if(listOfStreamObject[key].totalInterval>0){let calculateOverollCallDetails=calculateOverollCallDeltas(key);result[videoStreamObject.streamType==="publisher"?"providerBandwidthDetails":"patientBandwidthDetails"]={userType:videoStreamObject.streamType,connectionQuality:calculateOverollCallDetails.connectionQuality,bitrateskbps:calculateOverollCallDetails.bitrateskbps.toFixed(0),videoPacketLossRatio:calculateOverollCallDetails.videoPacketLossRatio.toFixed(2),videoFrameRate:calculateOverollCallDetails.frameRate.toFixed(0)}}else{result[videoStreamObject.streamType==="publisher"?"providerBandwidthDetails":"patientBandwidthDetails"]={userType:videoStreamObject.streamType,connectionQuality:"",bitrateskbps:0,videoPacketLossRatio:0,videoFrameRate:0}}delete listOfStreamObject[key]});clearAllBandwidthStream();return result}catch(err){telemedLoggingService.error("Error while getting Bandwidth Details")}}return{getTelemedCallBandwidth:getTelemedCallBandwidth,clearAllBandwidthStream:clearAllBandwidthStream,clearBandwidthStream:clearBandwidthStream,hideBandwidthDiv:hideBandwidthDiv,showBandwidthDiv:showBandwidthDiv,resetBandwidthDiv:resetBandwidthDiv,logCallBandwidthDetails:logCallBandwidthDetails,setTVView:setTVView}}])})();
(function(f){var visitSubTypeLookup=f.module('visitSubTypeLookup',[]);visitSubTypeLookup.directive('visitSubTypeDropDown',function($timeout){var returnData={restrict:'AE',replace:'true',scope:{visitSubType:"=visitSubType",disableVisitSubTypeLookup:"=disableVisitSubTypeLookup",visitTypeId:"=?visitTypeId",visitTypeName:"=?visitTypeName",clearVisitSubType:"&",visitSubTypeClick:"&",topclass:"@",familyAppointmentVisitsubtype:"@",placeHolder:'@',listWidth:"@",hasSubType:"=hasSubType",isExistingRecord:"=isExistingRecord",showColorboxOnLeft:"@showColorboxOnLeft",showLookupButton:"@showLookupButton"},link:function(scope,element,attributes){scope.visitSubTypeName="";scope.bShowLookup=false;scope.dropdownToggler=false;scope.visitSubTypeFilter="";scope.topclass=!scope.topclass?"visitSubTypeLookup"+(""+Math.random()).substring(2,6):scope.topclass;scope.listWidth=scope.listWidth&&scope.listWidth!==""?scope.listWidth:"100%";scope.enableVisitSubType=getItemKeyValue("EnableVisitSubType").toLowerCase()==="yes";scope.visitSubTypes;if(!scope.visitSubType){scope.visitSubType={}}scope.hasSubType="false";scope.isVisitTypeLookupFocused=false;scope.initializeVisitSubTypeLookup=function(visitTypeChanged){scope.visitSubTypes=[];if(scope.visitTypeId&&scope.visitTypeId>0){scope.visitSubTypes=getMappedVisitSubTypesToVisitType(scope.visitTypeId)}else if(scope.visitTypeId&&scope.visitTypeId===-1){scope.visitSubTypes=getAllMappedVisitSubTypes()}scope.hasSubType=scope.visitSubTypes&&scope.visitSubTypes.subTypes&&scope.visitSubTypes.subTypes.length>0?"true":"false";if(visitTypeChanged&&scope.visitTypeId&&scope.visitTypeId!==0){scope.setValidVisitSubType(visitTypeChanged)}if(scope.hasSubType=='false'&&(!scope.visitTypeId||scope.visitTypeId===0)){scope.visitSubTypeName="";scope.visitSubType.color="#FFFFFF"}};scope.setValidVisitSubType=function(visitTypeChanged){if(scope.visitSubType&&scope.visitSubType.hasOwnProperty('id')){if(visitTypeChanged||!scope.visitSubType.hasOwnProperty('code')&&!scope.visitSubType.hasOwnProperty('name')&&!scope.visitSubType.hasOwnProperty('color')){var validVisitSubType=angular.copy(scope.getVisitSubType(scope.visitSubType.id));scope.setVisitSubType(validVisitSubType,false,visitTypeChanged)}}else{scope.initializeToFirstPosition(visitTypeChanged)}};if(scope.familyAppointmentVisitsubtype==='true'){scope.showColorboxOnLeft='false'}scope.initializeToFirstPosition=function(visitTypeChanged){if(visitTypeChanged){scope.visitSubTypeName="";scope.visitSubTypeFilter=""}scope.visitSubType={};setScrollPositionAt($(element).find(".custom-lookup-dropdown"),0);scope.unselectAll()};scope.getVisitSubType=function(id){var visitSubType={};if(scope.visitSubTypes&&scope.visitSubTypes.subTypes){for(var i=0;i<scope.visitSubTypes.subTypes.length;i++){if(scope.visitSubTypes.subTypes[i].id==id){visitSubType=scope.visitSubTypes.subTypes[i];break}}}return visitSubType};scope.openVisitSubTypeLookup=function(event){scope.visitSubTypeFilter="";if(scope.visitSubTypes&&scope.visitSubTypes.subTypes&&scope.visitSubTypes.subTypes.length>0){scope.bShowLookup=true;if(scope.visitSubType&&scope.visitSubType.name&&scope.visitSubType.name!==""){$timeout(function(){scope.setVisitSubTypeSelection(scope.visitSubType.name)},0)}else{scope.initializeToFirstPosition()}}if(scope.familyAppointmentVisitsubtype==='true'){setTimeout(function(){var _that=event.target;var dropList=$(_that).closest('.family-sub-type').find('.family-sub-type-ul');dropList.show().animate({},100,function(){angular.element(this).position({of:angular.element(_that).parents('.family-sub-type'),my:'left top+24',at:'left top',collision:"flipfit"})})},100)}};scope.hideVisitSubTypeLookup=function(){if(!scope.dropdownToggler){scope.bShowLookup=false}else{scope.dropdownToggler=false}};scope.checkForClear=function(){scope.bShowLookup=true;if(scope.visitSubTypeName===""){setScrollPositionAt($(element).find(".custom-lookup-dropdown"),0);scope.clearVisitSubType()}if(scope.visitSubType&&scope.visitSubType.hasOwnProperty('code')){scope.unselectVisitSubType(scope.visitSubType.code);scope.visitSubType={}}scope.visitSubTypeFilter=scope.visitSubTypeName};scope.setFocusOnVisitSubType=function(){element.find(".lookup-box").focus()};scope.unselectAll=function(){if(scope.visitSubTypes&&scope.visitSubTypes.subTypes){angular.forEach(scope.visitSubTypes.subTypes,function(value,key){value.selected=false})}};scope.setVisitSubTypeSelection=function(name){scope.unselectAll();var index=scope.getVisitSubTypeIndex(name);if(index>=0&&index<scope.visitSubTypes.subTypes.length){scope.visitSubTypes.subTypes[index].selected=true;scope.visitSubTypeName=scope.getCombinedVisitSubTypeNameAndDescription(scope.visitSubTypes.subTypes[index]);setScrollPositionByElementText(element,scope.visitSubTypeName,index)}};scope.unselectVisitSubType=function(name){var index=scope.getVisitSubTypeIndex(name);if(index>=0&&index<scope.visitSubTypes.subTypes.length){scope.visitSubTypes.subTypes[index].selected=false}};scope.isValidVisitSubTypeSelected=function(){return scope.visitSubType&&scope.visitSubType.hasOwnProperty('code')};scope.getVisitSubTypeIndexContains=function(visitSubTypeName){var index=0;for(var i=0;i<scope.visitSubTypes.subTypes.length;i++){if((scope.visitSubTypes.subTypes[i].code.toLowerCase()+scope.visitSubTypes.subTypes[i].name).indexOf(visitSubTypeName.toLowerCase())!==-1){index=i;break}}return index};scope.getCombinedVisitSubTypeNameAndDescription=function(visitSubType){if(visitSubType&&visitSubType.code){var name=visitSubType.name?visitSubType.name:"";return visitSubType.code+" ("+name+")"}else{return""}};scope.getVisitSubTypeIndex=function(code){var index=-1;if(scope.visitSubTypes&&scope.visitSubTypes.subTypes){for(var i=0;i<scope.visitSubTypes.subTypes.length;i++){if(scope.visitSubTypes.subTypes[i].code==code){index=i;break}}}return index};scope.setNextOrPreviousVisitSubType=function(next){scope.visitSubTypeFilter="";var index=-1;if(scope.isValidVisitSubTypeSelected()){index=scope.getVisitSubTypeIndex(scope.visitSubType.code);if(next){index++}else{index--}}else{index=scope.getVisitSubTypeIndexContains(scope.visitSubTypeName)}if(index>=0&&index<scope.visitSubTypes.subTypes.length){scope.setVisitSubType(scope.visitSubTypes.subTypes[index],false)}};scope.setVisitSubType=function(visitSubType,bClicked,bVisitTypeChanged){if(visitSubType&&visitSubType.code&&visitSubType.code!=""){scope.visitSubType=angular.copy(visitSubType);scope.hideSpecificVisitSubType();scope.setVisitSubTypeSelection(scope.visitSubType.code);if(bClicked){scope.dropdownToggler=true;scope.bShowLookup=false}$timeout(function(){scope.visitSubTypeClick()},0)}else if(scope.isExistingRecord===true&&scope.isVisitTypeLookupFocused===false){scope.setVisitSubTypeForExistingRecord()}else{scope.visitSubType={};if(bVisitTypeChanged){scope.visitSubTypeName=""}}};scope.$on('onVisitTypeLookupFocusDirective',function(event,result){scope.isVisitTypeLookupFocused=true});scope.getHTMLColor=function(color){if(color&&color.length>0){return"#"+color}else{return"#0000FF"}};scope.getHTMLColorForVisitSubType=function(visitSubType){if(visitSubType&&visitSubType.name){return scope.getHTMLColor(visitSubType.color)}else{return"#FFFFFF"}};scope.keyboardNavigation=function(e){if(e.which==40){scope.setNextOrPreviousVisitSubType(true);return false}else if(e.which==38){scope.setNextOrPreviousVisitSubType(false);return false}else if(e.which==13){scope.bShowLookup=false;return false}};scope.hideSpecificVisitSubType=function(){scope.bShowSpecifyVisitSubTypeBox=false;scope.mSpecifyVisitSubType=""};scope.matchVisitSubType=function(searchCriteria){return function(visitSubTypeObj){var description=scope.getCombinedVisitSubTypeNameAndDescription(visitSubTypeObj).toLowerCase();return description.indexOf(searchCriteria.toLowerCase())>=0}};scope.noSubTypesMappedOption=function(){return{id:"-1",subTypeId:"",subTypes:[{code:"",color:"",name:"No Sub-Types Mapped",id:"-1"}],visitTypeId:"-1",vtname:""}};scope.setVisitSubTypeForExistingRecord=function(){if(scope.enableVisitSubType){var allSubTypes=getAllVisitSubTypes();if(allSubTypes&&allSubTypes.status&&scope.visitSubType.id){for(var i=0;i<allSubTypes.status.length;i++){var subTypeMapping=allSubTypes.status[i];if(parseInt(subTypeMapping.id,10)===parseInt(scope.visitSubType.id,10)){var subType=subTypeMapping;if(typeof scope.visitSubTypes==='undefined'||typeof scope.visitSubTypes.subTypes==='undefined'||scope.visitSubTypes.subTypes.length===0){scope.visitSubTypes=scope.prepareSubTypesByVisitTypeName(scope.visitSubTypes,scope.visitTypeName)}if(subType.name){scope.hasSubType="true";scope.addSubTypeIfNotPresent(scope.visitSubTypes,subType);scope.sortSubTypesByCode(scope.visitSubTypes);scope.setVisitSubType(subType,false,false)}break}}}}};scope.prepareSubTypesByVisitTypeName=function(visitSubTypes,visitTypeName){var selectedVisitTypeId=scope.getVisitTypeIdByName(visitTypeName);if(typeof selectedVisitTypeId!=='undefined'&&selectedVisitTypeId.trim().length>0){visitSubTypes=getMappedVisitSubTypesToVisitType(selectedVisitTypeId)}if(typeof visitSubTypes==='undefined'||typeof visitSubTypes.subTypes==='undefined'){visitSubTypes={subTypes:[]}}return visitSubTypes};scope.addSubTypeIfNotPresent=function(visitSubTypes,subType){var subTypeIndex=-1;for(var i=0;i<visitSubTypes.subTypes.length;i++){if(visitSubTypes.subTypes[i].id===subType.id){subTypeIndex=i}}if(subTypeIndex===-1){visitSubTypes.subTypes.push(subType)}};scope.sortSubTypesByCode=function(visitSubTypes){visitSubTypes.subTypes.sort(function(a,b){return a.code.localeCompare(b.code)})};scope.getVisitTypeIdByName=function(visitTypeName){var visitTypeId;var visitTypes=getVisitTypes();if(visitTypes&&visitTypes.length>0){for(var i=0;i<visitTypes.length;i++){var visitType=visitTypes[i];if(visitType.Name===visitTypeName){visitTypeId=visitType.CodeId;break}}}return visitTypeId};scope.$watch('visitTypeId',function(newValue,oldValue){if(scope.enableVisitSubType){if(scope.isExistingRecord===true&&(typeof scope.visitTypeId==='undefined'||scope.visitTypeId.trim().length===0||scope.visitTypeId<=0)){scope.setVisitSubTypeForExistingRecord()}else{scope.initializeVisitSubTypeLookup(true,newValue!==oldValue)}}});scope.$on("$destroy",function(event){scope.visitSubTypeName=null;scope.bShowLookup=null;scope.dropdownToggler=null;scope.visitSubTypeFilter=null;scope.topclass=null;scope.listWidth=null;scope.visitSubTypes=null})}};if($("#visit-sub-type-lookup-taglib").length!==0){returnData.template=$("#visit-sub-type-lookup-taglib").html()}else{returnData.templateUrl='/mobiledoc/jsp/webemr/lookup/visit-sub-type-lookup.jsp'}return returnData})})(angular);
angular.module('ecw.rpm.addTimeApp',['ecw.datatruncUtilityModule','rpm.userService']).directive('rpmAddTime',function($http,$modal,$ocLazyLoad,rpmUserService){return{restrict:'AE',replace:'true',scope:{patientId:'=',ptacoid:'=',primaryContact:'=',hasPermission:'=',callbackFunction:'&',module:'='},link:function(scope,element,attrs,ngModelCtrl){element.click(function(){$('.action-hub-modal').remove();$ocLazyLoad.load({name:'rpmAddTime',files:['/mobiledoc/jsp/webemr/ccmr/rpm/timer/js/rpmAddTimeController.js','/mobiledoc/jsp/webemr/ccmr/rpm/timer/css/rpm-timer-modal.css','/mobiledoc/jsp/webemr/ccmr/rpm/js/vendorjs/datetime-picker.min.js','/mobiledoc/jsp/webemr/js/jquery-ui-timepicker-addon.js','/mobiledoc/jsp/webemr/ccmr/rpm/js/service/rpmUserServices.js','/mobiledoc/jsp/webemr/ccmr/rpm/timer/directive/rpmViewFullNotes-tpl.js','/mobiledoc/jsp/webemr/templates/keywords-tpl.js','/mobiledoc/jsp/webemr/js/ecw.dir.patientidentifier.js']}).then(function(){scope.rpmAddTimeData={patientId:scope.patientId,ptacoid:scope.ptacoid,primaryContact:scope.primaryContact,hasPermission:scope.hasPermission,callbackFunction:scope.callbackFunction,module:scope.module};function getModal(){$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/ccmr/rpm/timer/rpmAddTimeModal.html?'),controller:'rpmAddTimeController',controllerAs:'rpmAddTimeCtrl',keyboard:false,backdrop:'static',windowClass:'bluetheme add-manually-model rpm-timer-modal',animation:true,resolve:{rpmAddTimeData:function(){return scope.rpmAddTimeData}}})}scope.moduleRestrictionKey=scope.module&&scope.module.toLowerCase()==='ccm'?'CCMAddTimeRestriction':'RPMAddTimeRestriction';var module=scope.module&&scope.module.toLowerCase()==='ccm'?'CCM':'RPM';if(!getPermission(scope.moduleRestrictionKey,global.TrUserId)){ecwAlert('User does not have rights to add the time. Please contact your administrator to give the permission for security item '+module+'-Permission to add the time.','')}else{var param={patientId:scope.patientId,filters:{month:Number(moment().format('MM')),year:Number(moment().format('YYYY')),isReadingAvailable:true},userId:global.TrUserId};if(!scope.module||scope.module==='RPM'){rpmUserService.postRequestForRpmData('/mobiledoc/phm/rpmDeviceMonitoring/getDeviceReadingsForPatient',param).then(function(response){response=response.data;if(response&&response.result[0]&&response.result[0].totalReadings>0){getModal()}else if(response&&!(response.result[0]&&response.result[0].totalReadings>0)){ecwConfirm("No readings have been received from a device, do you still want to add time?","Start/Add Time",function(){getModal()},function(){},'bluetheme',false)}else if(response.status==='failure'){ecwAlert('Exception occured while checking Device Readings','')}},function(e){ecwAlert('Error occured while checking Device Readings','')})}else{getModal()}}})})}}});
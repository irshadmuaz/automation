function rpCCMController($scope,$http,$ocLazyLoad,$sce,$templateCache,$modal,$interval){$scope.ccm={};var jsonCCM=$scope.overviewjson.ccm;var x2js=new X2JS;$scope.ccm.TimerStatus=0;$scope.ccm.StartTimer="00:00:00";$scope.ccm.action="start";$scope.ccm.timerBtnLabel="Start";$scope.ccm.primaryContact="";$scope.ccm.module='CCM';$scope.ccm.timestamp=(new Date).getTime();$(document).on("mouseenter.showDisenrollPopup",".redtext",function(){var _that=this;$('.disenroll-popup').toggle().animate({},100,function(){$(this).position({of:_that,my:'left-10 top+35',at:'left top'}).animate({"opacity":1},100)})});$(document).on("mouseleave.hideDisenrollPopup",".redtext",function(){$('.disenroll-popup').hide()});$(document).on("click.hideCancelBtn",".cancelpopup",function(){$('.icd-details-chronic-count-edit, .icd-details-chronic-count').hide()});$(document).on("click.hideUpdateBtn",".updatedbtn",function(){$('.icd-details-chronic-count-edit, .icd-details-chronic-count').hide()});$(document).on("click.showChronicCntPopup",".chronic-count, .chronic-count>.icons-arrow",function(){var _that=this;$('.icd-details-chronic-count-edit').hide();$('.icd-details-chronic-count').show().animate({},100,function(){$(this).position({of:_that,my:'right+5 top+25',at:'right top'}).animate({"opacity":1},100)})});$(document).on("click.showEditCntPopup",".editcount, .editcount>.icons-editable",function(){var _that=this;$('.icd-details-chronic-count').hide();$('.icd-details-chronic-count-edit').show().animate({},100,function(){$(this).position({of:_that,my:'right+5 top+20',at:'right top'}).animate({"opacity":1},100)})});if(jsonCCM){$scope.isUserIconHovered=false;$scope.ccm.enable=jsonCCM.enable;$scope.ccm.billingDate=moment().format('01-MMM-YYYY');$scope.ccm.userId=global.TrUserId;if($scope.ccm.enable=='true'){$scope.ccm.data=x2js.xml_str2json(jsonCCM.data).Envelope.Body['return'].ccmRightPanel;if($scope.ccm.data.ccmIcdCode===undefined){$scope.ccm.data.ccmIcdCode=[]}else if(!Array.isArray($scope.ccm.data.ccmIcdCode)){var tempCCMIcdCode=$scope.ccm.data.ccmIcdCode;$scope.ccm.data.ccmIcdCode=[];$scope.ccm.data.ccmIcdCode.push(tempCCMIcdCode)}$scope.ccm.data.enrollmentDetail=x2js.xml_str2json(jsonCCM.data).Envelope.Body['return'].ccmRightPanel;$scope.ccm.userStickyValue=jsonCCM.userStickyValue;$scope.ccm.ui={timerRunning:false,overTime:false,timer:'00:00:00',timerClass:'icon-clock',secondIncremented:0};if($scope.ccm.data===undefined||$scope.ccm.data==null){return}$scope.setCCMUIVariable=function(){$scope.ccm.enableRCM=false;if($scope.ccm.data.disEnrollDetail!==undefined){$scope.ccm.data.disEnrollDetail.disEnrollmentDate=moment($scope.ccm.data.disEnrollDetail.disEnrollmentDate).format('MM/DD/YYYY')}var item={itemId:0,keyValue:'',isExists:false};getItemKeyValuePair("RCMClient",item);if(item.isExists&&item.keyValue.toLowerCase()=="yes"){$scope.ccm.enableRCM=true}getItemKeyValuePair("EnableOutboundDFTOOV",item);if(item.isExists&&(item.keyValue.toLowerCase()=="yes"||item.keyValue.toLowerCase()=="locked")){$scope.ccm.enableRCM=true}$scope.ccm.enableMemMgmt=false;getItemKeyValuePair("EnableMemberManagement",item);if(item.isExists&&item.keyValue.toLowerCase()=="yes"){$scope.ccm.enableMemMgmt=true}$scope.ccm.ui.showReason=false;if($scope.ccm.data.MatchType=='NewToCCM'){if($scope.ccm.data.notEligible&&$scope.ccm.data.notEligible.length>0){$scope.ccm.ui.showReason=true}}else if($scope.ccm.data.MatchType=='EnrolledToCCM'){$scope.ccm.data.PtEnrolledDetails.noOfCC=parseInt($scope.ccm.data.PtEnrolledDetails.noOfCC,10);$scope.ccm.ui.showCreateClaimToolTip=$.trim($scope.ccm.data.PtEnrolledDetails.ClaimFailureReason)!='';$scope.ccm.primaryContact=$scope.ccm.data.PtEnrolledDetails.primaryContactName}};$scope.setCCMUIVariable();$scope.doChronicViewChange=function(type){if(type==='one'){$scope.ccm.data.oneCheck=true;$scope.ccm.data.allCheck=false;$scope.ccm.data.chronicOption='one';$scope.ccm.data.selectedIcdCode=$scope.ccm.data.ccmIcdCode[0].icdCode;$scope.ccm.data.selectedItemId=$scope.ccm.data.ccmIcdCode[0].itemId}else if(type==='all'){$scope.ccm.data.oneCheck=false;$scope.ccm.data.allCheck=true;$scope.ccm.data.chronicOption='all'}};$scope.changeSelectedIcdCode=function(icdCode,itemId){$scope.ccm.data.selectedIcdCode=icdCode;$scope.ccm.data.selectedItemId=itemId};$scope.reloadCcmBand=function(){if($scope.ccm.enable=='true'){var serverUrl='/mobiledoc/jsp/webemr/rightpanel/getOverviewData.jsp?patientId='+$scope.patientid+'&TrUserId='+global.TrUserId+'&context='+$scope.context+'&encounterId='+$scope.encounterid+'&trigger=ccmdata';var jsonCCM=JSON.parse(urlGet(serverUrl));$scope.ccm.data=x2js.xml_str2json(jsonCCM.ccm.data).Envelope.Body['return'].ccmRightPanel;if($scope.ccm.data.ccmIcdCode===undefined){$scope.ccm.data.ccmIcdCode=[]}else if(!Array.isArray($scope.ccm.data.ccmIcdCode)){var tempCCMIcdCode=$scope.ccm.data.ccmIcdCode;$scope.ccm.data.ccmIcdCode=[];$scope.ccm.data.ccmIcdCode.push(tempCCMIcdCode)}if(!($scope.ccm.data===undefined||$scope.ccm.data==null)){$scope.setCCMUIVariable();$scope.clearTimer();$scope.initCcmRightBand()}}};try{$scope.$parent.$parent.$parent.refreshRCPCCMBand=$scope.reloadCcmBand}catch(e){}$scope.initCcmRightBand=function(){if($scope.ccm.data.MatchType=='EnrolledToCCM'){if($scope.ccm.data.PtEnrolledDetails.TimerStatus=='1'){$scope.initTimer($scope.ccm.data.PtEnrolledDetails.StartTimer)}else{$scope.ccm.timerBtnLabel="Start";$scope.ccm.ui.timerRunning=false;$scope.ccm.ui.overTime=false}$scope.collpaseExpandCCMBand()}var selectedProgram=Number($scope.ccm.data.programInfo.selectedProgram)===2&&(Number($scope.ccm.data.programInfo.programItemId)===1||Number($scope.ccm.data.programInfo.programItemId)===3)?'all':'one';$scope.ccm.data.ccmIcdCode1=$scope.ccm.data.ccmIcdCode.filter(function(value,index,self){return index===self.findIndex(function(t){return t.icdCode===value.icdCode})});let itemEnableCCM={itemId:0,keyValue:'',isExists:false};getItemKeyValuePair("EnableCCM",itemEnableCCM);if(selectedProgram==='all'&&$scope.ccm.data.ccmIcdCode1.length===1&&parseInt(itemEnableCCM.itemId,10)>=2){selectedProgram='one'}if(parseInt(itemEnableCCM.itemId,10)===1){selectedProgram='all'}else if(parseInt(itemEnableCCM.itemId,10)===2){selectedProgram='one'}$scope.doChronicViewChange(selectedProgram);$scope.ccm.data.chronicCountEdit=false};$scope.collpaseExpandCCMBand=function(){if($scope.ccm.data.MatchType==='EnrolledToCCM'&&$scope.ccm.userStickyValue==='1'){$scope.expandCCMSection()}};$scope.createCcmClaim=function(){var consentStatus=0;if($scope.ccm.data.PtEnrolledDetails.consentStatus=='NA'){consentStatus=0}else if($scope.ccm.data.PtEnrolledDetails.consentStatus=='Yes'){consentStatus=1}else if($scope.ccm.data.PtEnrolledDetails.consentStatus=='No'){consentStatus=2}if(parseInt(consentStatus)==0||parseInt(consentStatus)==2){var message="Patient consent is either marked as pending or no. Do you still wish to create a claim?";bootbox.confirm({message:message,title:'eClinicalWorks',className:'bluetheme',buttons:{'confirm':{label:'Yes',className:'btn btn-blue btn-xs mr5'},'cancel':{label:'No',className:'btn btn-lgrey btn-xs pull-right'}},callback:function(result){if(result===true){$scope.createClaimForCCM(consentStatus,"CreateClaim")}else{$scope.ccm.ui.showCreateClaimToolTip=true}}})}else{$scope.createClaimForCCM(consentStatus,"CreateClaim")}};$scope.createClaimForCCM=function(consentStatus,claimCreationStatus){var divRightPanel=$('#rightPanelCtrl');var httpCreateClaim={method:'POST',url:'/mobiledoc/jsp/ccmr/webPortal/dashBoard/ccm/addTime.jsp',headers:{'Content-Type':'application/x-www-form-urlencoded'},data:$.param({action:'invokeClaimManually',enrollId:$scope.ccm.data.PtEnrolledDetails.id,patientId:$scope.patientid,diseaseId:$scope.ccm.data.PtEnrolledDetails.DeseCodes,icdCode:$scope.ccm.data.PtEnrolledDetails.ICDCodes,userId:global.TrUserId,consentStatus:consentStatus,billingDate:moment().format('01-MMM-YYYY'),claimCreationStatus:claimCreationStatus})};$http(httpCreateClaim).success(function(msg){$scope.reloadCcmBand();if($.trim(msg)==''){$scope.ccm.ui.showCreateClaimToolTip=false}else{bootbox.confirm({message:msg,title:'eClinicalWorks',className:'bluetheme',buttons:{'confirm':{label:'OK',className:'btn btn-blue btn-xs mr5'},'cancel':{label:'No',className:'btn btn-lgrey btn-xs pull-right hide'}},callback:function(result){}})}})};$scope.addCcmTime=function(){$(".modal-backdrop").last().remove();$ocLazyLoad.load({name:'CcmModule',files:['/mobiledoc/jsp/webemr/ccmr/ccm/js/ccmAddTimeController.js']}).then(function(){var paramSend=['ProgramId','ICDCodes','DeseCodes','id','insSeqNo','insDeleteFlag','insEnrollstatus','insStartDate','insEndDate','consentStatus'];var params={patientId:$scope.patientid};for(var key in $scope.ccm.data.PtEnrolledDetails){if($.inArray(key,paramSend)!=-1){var value=$scope.ccm.data.PtEnrolledDetails[key];params[key]=value}}$scope.linkUrlForCCMR=makeURL('/mobiledoc/jsp/webemr/ccmr/ccm/addTime.jsp?'+$.param(params))},function(e){console.log(e)})};var stopInterval=null;$scope.initTimer=function(strStartTimer){if(strStartTimer!=undefined){$scope.ccm.ui.timer=$scope.getTimeDifference(strStartTimer)}$scope.ccm.ui.timerRunning=true;$scope.ccm.ui.timerClass='icon-clockred';$scope.ccm.timerBtnLabel="Stop";stopInterval=$interval(function(){$scope.ccm.ui.timer=$scope.getTimeDifference(strStartTimer);$scope.ccm.ui.secondIncremented+=1},1e3)};$scope.clearTimer=function(){$scope.ccm.ui.timerRunning=false;$scope.ccm.ui.overTime=false;$scope.ccm.ui.timerClass='icon-clock';$interval.cancel(stopInterval);$scope.ccm.ui.timer='00:00:00'};$scope.startCcmTimer=function(){if(!getPermission("CCMAddTimeRestriction",global.TrUserId)){alert("User does not have rights to add the time. Please contact your administrator to give the permission for security item '<b>CCM-Permission to add the time</b>'.");return}$scope.updateTimer(1,function(respText){if($.trim(respText)==1){showMessage("Timer is already started for this patient.")}else{$scope.reloadCcmBand()}})};$scope.stopCcmTimer=function(){$(".modal-backdrop").last().remove();$ocLazyLoad.load({name:'CcmModule',files:['/mobiledoc/jsp/webemr/ccmr/ccm/js/addTimerDetailController.js']}).then(function(){var timeToSeconds=moment.duration($scope.ccm.ui.timer,'hh:mm:ss').asSeconds();var momentEndTime=moment($scope.ccm.data.PtEnrolledDetails.StartTimer,"MM-DD-YYYY hh:mm:ss A");momentEndTime.add(timeToSeconds,'seconds');var paramSend=['ProgramId','PtName','PtDob','PtGender','id','ICDCodes','DeseCodes','StartTimer','insSeqNo','insDeleteFlag','insEnrollstatus','insStartDate','insEndDate','consentStatus'];var params={patientId:$scope.patientid,endTime:moment(momentEndTime).format("MM/DD/YYYY hh:mm:ss A"),totalDuration:$scope.ccm.ui.timer};for(var key in $scope.ccm.data.PtEnrolledDetails){if($.inArray(key,paramSend)!=-1){var value=$scope.ccm.data.PtEnrolledDetails[key];params[key]=value}}var momentStartTimer=moment(params['StartTimer'],"MM-DD-YYYY hh:mm:ss a");params['StartTimer']=moment(momentStartTimer).format("MM/DD/YYYY hh:mm:ss A");$scope.linkUrlForCCMR=makeURL('/mobiledoc/jsp/webemr/ccmr/ccm/addTimerDetail.jsp?'+$.param(params))},function(e){console.log(e)})};$scope.resetCcmTimer=function(){if(!getPermission("CCMAddTimeRestriction",global.TrUserId)){alert("User does not have rights to add the time. Please contact your administrator to give the permission for security item '<b>CCM-Permission to add the time</b>'.");return}$scope.updateTimer(2,function(respText){$scope.ccm.timerBtnLabel="Start";$scope.clearTimer()})};$scope.updateTimer=function(status,cbFunc){var httpStartTimer={method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},url:'/mobiledoc/jsp/ccmr/webPortal/dashBoard/ccm/updateTimerStatus.jsp',data:$.param({enrollId:$scope.ccm.data.PtEnrolledDetails.id,status:status,patientId:$scope.patientid,currentClientTime:$scope.getClientTimeFromRtPanel(),userId:global.TrUserId})};$http(httpStartTimer).success(function(respText){if(typeof cbFunc==="function"){cbFunc()}})};$scope.getClientTimeFromRtPanel=function(){var now=new Date;return now.getFullYear()+"-"+(now.getMonth()+1)+"-"+now.getDate()+" "+now.getHours()+":"+now.getMinutes()+":"+now.getSeconds()};$scope.getTimeDifference=function(startTime){var startHour=new Date(startTime).getHours();var startMins=new Date(startTime).getMinutes();var startSecs=new Date(startTime).getSeconds();var endHour=(new Date).getHours();var endMins=(new Date).getMinutes();var endSecs=(new Date).getSeconds();var secDiff=endSecs-startSecs;var minDiff=endMins-startMins;var hrDiff=endHour-startHour;var diffInSeconds=((new Date).getTime()-new Date(startTime).getTime())/1e3;var difference=new Date-new Date(startTime);if(diffInSeconds/60>=480){$scope.ccm.ui.overTime=true}else{$scope.ccm.ui.overTime=false}return $scope.msToTime(difference)};$scope.msToTime=function(duration){var milliseconds=parseInt(duration%1e3/100),seconds=parseInt(duration/1e3%60),minutes=parseInt(duration/(1e3*60)%60),hours=parseInt(duration/(1e3*60*60)%24),hoursToDisplay=parseInt(duration/(1e3*60*60),10);hours=hours<10?"0"+hours:hours;hoursToDisplay=hoursToDisplay<10?"0"+hoursToDisplay:hoursToDisplay;minutes=minutes<10?"0"+minutes:minutes;seconds=seconds<10?"0"+seconds:seconds;return hoursToDisplay+":"+minutes+":"+seconds};$scope.expandMoreResults=function(){var divRightPanel=$("#rightPanelCtrl");divRightPanel.find('.lis1').toggleClass('hide');if(divRightPanel.find('.lis1').hasClass('hide')){divRightPanel.find('#spanShowMore').text("Show More")}else{divRightPanel.find('#spanShowMore').text("Show Less")}};$scope.enrollProgram=function(){$ocLazyLoad.load({name:'CcmModule',files:['/mobiledoc/jsp/webemr/ccmr/carePlanning/js/enrollmentController.js']}).then(function(){var params={patientId:$scope.patientid,programAction:"EnrollNow",programMode:"add",userMode:"single",programTypeId:"1"};$scope.linkUrlForCCMR=makeURL('/mobiledoc/jsp/webemr/ccmr/carePlanning/enrollProgram.jsp?'+$.param(params))},function(e){console.log(e)})};$scope.editEnrolledProgram=function(){$ocLazyLoad.load({name:'CcmModule',files:['/mobiledoc/jsp/webemr/ccmr/carePlanning/js/enrollmentController.js']}).then(function(){var params={patientId:$scope.patientid,ptId:$scope.patientid,programMode:"edit",userMode:"single",programTypeId:"1",programId:$scope.ccm.data.PtEnrolledDetails.ProgramId,enrollmentRequestId:$scope.ccm.data.PtEnrolledDetails.id};$scope.linkUrlForCCMR=makeURL('/mobiledoc/jsp/webemr/ccmr/carePlanning/enrollProgram.jsp?'+$.param(params))},function(e){console.log(e)})};$scope.expandCCMSection=function(){setTimeout(function(){$('.rpCCMBandTitle').addClass('active');$('.ccmRightPannelOverviewTab').addClass('in').css('height','auto')},50)}}}$scope.$on('$destroy',function(){if(stopInterval){$interval.cancel(stopInterval)}$(document).off('mouseenter.showDisenrollPopup');$(document).off('mouseleave.hideDisenrollPopup');$(document).off('click.hideCancelBtn');$(document).off('click.hideUpdateBtn');$(document).off('click.showChronicCntPopup');$(document).off('click.showEditCntPopup')})}
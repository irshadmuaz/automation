angular.module('ihubConsentModule',[]).directive('ihubConsentDir',function($ocLazyLoad){return{restrict:'EA',scope:{patientId:'=',onloadShowDialog:'=',showButton:'=?',context:'=?',lazyLoading:'=',cwupdate:'='},templateUrl:'/mobiledoc/jsp/webemr/empi/consent/pt_ihub_consent.html',controllerAs:'ihubConsentCtrl',controller:function($scope){var ihubConsentCtrl=this;ihubConsentCtrl.patientId=$scope.patientId;ihubConsentCtrl.onloadShowDialog=$scope.onloadShowDialog;ihubConsentCtrl.lazyLoading=$scope.lazyLoading;ihubConsentCtrl.TrUserId=global.TrUserId;ihubConsentCtrl.commonwellUrl="";if($scope.showButton===undefined){$scope.showButton=false}if($scope.context===undefined){$scope.context=''}ihubConsentCtrl.context=$scope.context;ihubConsentCtrl.showButton=$scope.showButton;ihubConsentCtrl.iHubConsentCheck=false;ihubConsentCtrl.IsEMPIEnabled="YES"===getItemKeyValue("EnableEMPI").toUpperCase();ihubConsentCtrl.bEnableCommonWell="YES"===getItemKeyValue("EnableCommonwell").toUpperCase()||"YES"===getItemKeyValue("EnableCommonWell").toUpperCase();var lockObj={formName:"frmPatientIHubConsent",uniqueKey:"frmPatientIHubConsent"+ihubConsentCtrl.patientId,g_cancel:false,strKey:"",isOpenform:false};if("yes"===getItemKeyValue("commToInteropHub").toLowerCase()||"yes"===getItemKeyValue("enableExternalRegistries").toLowerCase()){ihubConsentCtrl.iHubConsentCheck=true}ihubConsentCtrl.init=function(){if(ihubConsentCtrl.lazyLoading===true){return}ihubConsentCtrl.loadConsentQuestion(true)};ihubConsentCtrl.showOnloadDialog=function(){if(ihubConsentCtrl.onloadShowDialog&&ihubConsentCtrl.interopConsent_showConsentQue){ihubConsentCtrl.showModal()}};ihubConsentCtrl.acquireLock=function(){acquireFormLock(lockObj,function(){if(lockObj.g_cancel){$("#ihubConsentModal"+ihubConsentCtrl.showButton+ihubConsentCtrl.context).modal('hide');ihubConsentCtrl.isRemoveCommonwellUrl=true;ihubConsentCtrl.commonwellUrl="";return}})};ihubConsentCtrl.releaseLock=function(){releaseFormLock(lockObj)};ihubConsentCtrl.showModal=function(){ihubConsentCtrl.acquireLock();ihubConsentCtrl.loadConsentQuestion(false);$('#ihubConsentModal'+ihubConsentCtrl.showButton+ihubConsentCtrl.context).modal('show');$(".modal-dialog").draggable({handle:".modal-header",revert:false});$('.ihub_consent_btn-blue').attr('disabled',true);$('#btnToolTip'+ihubConsentCtrl.showButton+ihubConsentCtrl.context).attr("title","Change consent selection to save.")};ihubConsentCtrl.hideModal=function(){$('#ihubConsentModal'+ihubConsentCtrl.showButton+ihubConsentCtrl.context).modal('hide');ihubConsentCtrl.isRemoveCommonwellUrl=true;ihubConsentCtrl.commonwellUrl="";ihubConsentCtrl.releaseLock()};ihubConsentCtrl.onConsentClick=function(){ihubConsentCtrl.showModal()};ihubConsentCtrl.onCancelClick=function(){ihubConsentCtrl.hideModal()};ihubConsentCtrl.radioBtnClicked=function(){if(ihubConsentCtrl.ihubConsentValueOld!==ihubConsentCtrl.ihubConsentValue){$('.ihub_consent_btn-blue').attr('disabled',false);$('#btnToolTip'+ihubConsentCtrl.showButton+ihubConsentCtrl.context).removeAttr("title")}else{$('.ihub_consent_btn-blue').attr('disabled',true);$('#btnToolTip'+ihubConsentCtrl.showButton+ihubConsentCtrl.context).attr("title","Change consent selection to save.")}};ihubConsentCtrl.saveConsentQueestion=function(){if(ihubConsentCtrl.iHubConsentCheck&&!ihubConsentCtrl.IsEMPIEnabled){if($scope.patientId===0){ecwAlert("Unable to save patient's data exchange consent status.");return}let valueId="";let value="";if(ihubConsentCtrl.ihubConsentValue===1){valueId+=ihubConsentCtrl.interopConsent_sendLocalId+",";value+=ihubConsentCtrl.interopConsent_sendName+",";valueId+=ihubConsentCtrl.interopConsent_receiveLocalId+",";value+=ihubConsentCtrl.interopConsent_receiveName+","}if(ihubConsentCtrl.ihubConsentValue===2){valueId+=ihubConsentCtrl.interopConsent_sendLocalId+",";value+=ihubConsentCtrl.interopConsent_sendName+","}if(ihubConsentCtrl.ihubConsentValue===3){valueId+=ihubConsentCtrl.interopConsent_receiveLocalId+",";value+=ihubConsentCtrl.interopConsent_receiveName+","}if(ihubConsentCtrl.ihubConsentValue===4){valueId+=ihubConsentCtrl.interopConsent_optoutLocalId+",";value+=ihubConsentCtrl.interopConsent_optoutName+","}valueId=valueId.replace(/,\s*$/,"");value=value.replace(/,\s*$/,"");var soapData="<S:Envelope xmlns:S='http://schemas.xmlsoap.org/soap/envelope/' xmlns:SOAP-ENC='http://schemas.xmlsoap.org/soap/encoding/' S:encodingStyle='http://schemas.xmlsoap.org/soap/encoding/' xmlns:xsd='http://www.w3.org/1999/XMLSchema' xmlns:xsi='http://www.w3.org/1999/XMLSchema-instance'>";soapData+="<S:Body><m:NOOP xmlns:m='NOOP'>";soapData+="<item xsi:type='xsd:string'><detailId xsi:type='xsd:string'>"+ihubConsentCtrl.interopConsent_localQueId+"</detailId><value xsi:type='xsd:string'>"+value+"</value>";soapData+="<notes xsi:type='xsd:string'></notes><valueId xsi:type='xsd:string'>"+valueId+"</valueId><fromScreen xsi:type='xsd:string'>2</fromScreen></item>";soapData+="</m:NOOP></S:Body></S:Envelope>";$.ajax({type:"POST",url:"/mobiledoc/jsp/catalog/xml/setStructData.jsp",data:"encId="+$scope.patientId+"&catId=0&itemId=0&table=structDemographics&sessionDID=0&TrUserId="+global.TrUserId+"&FormData="+soapData,"async":false,cache:false,success:function(response){ihubConsentCtrl.responseData=$.trim(response)},error:function(xhr,ajaxOptions,thrownError){ecwAlert("Unable to save patient's data exchange consent status.")}})}ihubConsentCtrl.hideModal();ihubConsentCtrl.loadConsentQuestion(false)};ihubConsentCtrl.setConsentValue=function(){if(ihubConsentCtrl.interopConsent_consentStyle.toLowerCase()==='optin'){ihubConsentCtrl.checkIfOptin()}else{ihubConsentCtrl.checkIfOptout()}};ihubConsentCtrl.checkIfOptin=function(){if(ihubConsentCtrl.interopConsent_optoutAnswer||ihubConsentCtrl.isEmptyAnswer()){ihubConsentCtrl.ihubConsentValue=4;ihubConsentCtrl.ihubConsentValueOld=4;ihubConsentCtrl.colorClass=ihubConsentCtrl.interopConsent_optoutName;ihubConsentCtrl.consentName=ihubConsentCtrl.interopConsent_optoutName}else if(ihubConsentCtrl.isSendAndReceive()){ihubConsentCtrl.ihubConsentValue=1;ihubConsentCtrl.ihubConsentValueOld=1;ihubConsentCtrl.colorClass=" Opted In: Send and Receive Documents";ihubConsentCtrl.consentName=" Opted In: Send..."}else{ihubConsentCtrl.setSendOrReceive()}};ihubConsentCtrl.checkIfOptout=function(){if(ihubConsentCtrl.interopConsent_optoutAnswer){ihubConsentCtrl.ihubConsentValue=4;ihubConsentCtrl.ihubConsentValueOld=4;ihubConsentCtrl.colorClass=ihubConsentCtrl.interopConsent_optoutName;ihubConsentCtrl.consentName=ihubConsentCtrl.interopConsent_optoutName}else if(ihubConsentCtrl.isSendAndReceive()||ihubConsentCtrl.isEmptyAnswer()){ihubConsentCtrl.ihubConsentValue=1;ihubConsentCtrl.ihubConsentValueOld=1;ihubConsentCtrl.colorClass=" Opted In: Send and Receive Documents";ihubConsentCtrl.consentName=" Opted In: Send..."}else{ihubConsentCtrl.setSendOrReceive()}};ihubConsentCtrl.setSendOrReceive=function(){if(ihubConsentCtrl.isSendOption()){ihubConsentCtrl.ihubConsentValue=2;ihubConsentCtrl.ihubConsentValueOld=2;ihubConsentCtrl.colorClass=ihubConsentCtrl.interopConsent_sendName;ihubConsentCtrl.consentName=" Opted In: Send..."}else if(ihubConsentCtrl.isReceiveOption()){ihubConsentCtrl.ihubConsentValue=3;ihubConsentCtrl.ihubConsentValueOld=3;ihubConsentCtrl.colorClass=ihubConsentCtrl.interopConsent_receiveName;ihubConsentCtrl.consentName=" Opted In: Receive..."}};ihubConsentCtrl.isSendOption=function(){return ihubConsentCtrl.interopConsent_sendAnswer&&!ihubConsentCtrl.interopConsent_receiveAnswer};ihubConsentCtrl.isReceiveOption=function(){return!ihubConsentCtrl.interopConsent_sendAnswer&&ihubConsentCtrl.interopConsent_receiveAnswer};ihubConsentCtrl.isEmptyAnswer=function(){return!ihubConsentCtrl.interopConsent_sendAnswer&&!ihubConsentCtrl.interopConsent_receiveAnswer&&!ihubConsentCtrl.interopConsent_optoutAnswer};ihubConsentCtrl.isSendAndReceive=function(){return ihubConsentCtrl.interopConsent_sendAnswer&&ihubConsentCtrl.interopConsent_receiveAnswer};ihubConsentCtrl.launchCommonwell=function(patientId){ihubConsentCtrl.commonwellUrl="";$ocLazyLoad.load({name:'commonWellApp',files:['/mobiledoc/jsp/webemr/css/common-welllink.css','/mobiledoc/jsp/webemr/interfaces/js/commonWell.js']}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/interfaces/commonWell.jsp?pid="+patientId+"&TrUserId="+global.TrUserId);ihubConsentCtrl.commonwellUrl=url},function(e){});setTimeout(function(){ihubConsentCtrl.loadConsentQuestion(false)},500)};ihubConsentCtrl.statusReviewed=function(nPid,userId){var url="/mobiledoc/jsp/interfaces/commonWellController.jsp?action=reviwed&TrUserId="+userId+"&pid="+nPid;$.post(url)};ihubConsentCtrl.loadConsentQuestion=function(isInit){if(ihubConsentCtrl.iHubConsentCheck&&!ihubConsentCtrl.IsEMPIEnabled){$.ajax({type:"GET",url:"/mobiledoc/jsp/interop/consent/iHubConsentCheck.jsp",data:{patientId:ihubConsentCtrl.patientId},"async":false,success:function(response){response=$.trim(response);if(response){var jsonObj=JSON.parse(response);ihubConsentCtrl.interopConsent_showConsentQue=jsonObj.showConsentQue;ihubConsentCtrl.interopConsent_consentCommId=jsonObj.consentCommId;ihubConsentCtrl.interopConsent_localQueId=jsonObj.localQueId;ihubConsentCtrl.interopConsent_consentStyle=jsonObj.consentStyle;ihubConsentCtrl.interopConsent_options=jsonObj.options;ihubConsentCtrl.interopConsent_sendCommId=ihubConsentCtrl.interopConsent_options.send.commId;ihubConsentCtrl.interopConsent_sendLocalId=ihubConsentCtrl.interopConsent_options.send.localId;ihubConsentCtrl.interopConsent_sendName=ihubConsentCtrl.interopConsent_options.send.name;ihubConsentCtrl.interopConsent_sendAnswer=ihubConsentCtrl.interopConsent_options.send.answer;ihubConsentCtrl.interopConsent_receiveCommId=ihubConsentCtrl.interopConsent_options.receive.commId;ihubConsentCtrl.interopConsent_receiveLocalId=ihubConsentCtrl.interopConsent_options.receive.localId;ihubConsentCtrl.interopConsent_receiveName=ihubConsentCtrl.interopConsent_options.receive.name;ihubConsentCtrl.interopConsent_receiveAnswer=ihubConsentCtrl.interopConsent_options.receive.answer;ihubConsentCtrl.interopConsent_optoutCommId=ihubConsentCtrl.interopConsent_options.optout.commId;ihubConsentCtrl.interopConsent_optoutLocalId=ihubConsentCtrl.interopConsent_options.optout.localId;ihubConsentCtrl.interopConsent_optoutName=ihubConsentCtrl.interopConsent_options.optout.name;ihubConsentCtrl.interopConsent_optoutAnswer=ihubConsentCtrl.interopConsent_options.optout.answer;ihubConsentCtrl.isCwUpdates=jsonObj.isCwUpdates;ihubConsentCtrl.isRemoveCommonwellUrl=false;if(isInit){ihubConsentCtrl.showOnloadDialog()}ihubConsentCtrl.setConsentValue()}},error:function(xhr,ajaxOptions,thrownError){ecwAlert("Unable to load patient's data exchange consent status.")}})}}}}});
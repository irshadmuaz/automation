angular.module("InjectionDrugInteraction",[]).constant("drugInteractionSeverityType",{FOOD:0,MINOR:1,MODERATE:2,MAJOR:3}).constant("drugInteractionSeverityTitle",{DEFAULT:"Interaction",FOOD:"Food Interaction",MINOR:"Minor Interaction",MODERATE:"Moderate Interaction",MAJOR:"Major Interaction"}).constant("styleClasses",{DEFAULT:"btn-lgrey",MAJOR:"btn-danger",MODERATE:"btn-warning",MINOR:"bg-yellow",FOOD:"btn-primary",TEXT_DARK:"text-dark",TEXT_WHITE:"text-white"}).constant("userProfiles",{ENABLE_PROACTIVE_DRUG_INTERACTION:"EnableProactiveDrugInteraction",ALLERGY_POPUP_LEVEL:"AllergyPopupLevel",ALLERGY_POPUP_LEVEL_ADMINISTERING_DRUG:"AllergyPopupLevelAdministeringDrug"}).constant("itemKeys",{ENABLE_MEDISPAN:"EnableMedispan",SHOW_ALLERGIC_ALERTS:"ShowAllergicAlerts"}).service("injectionDrugInteractionService",['$http','$modal','$ocLazyLoad','$timeout','drugInteractionSeverityType','drugInteractionSeverityTitle','styleClasses','userProfiles','itemKeys',injectionDrugInteractionService]).directive("allergyButton",['injectionDrugInteractionService',allergyButton]).directive("drugInteractionButton",['injectionDrugInteractionService','drugInteractionSeverityTitle','styleClasses',drugInteractionButton]);function injectionDrugInteractionService($http,$modal,$ocLazyLoad,$timeout,drugInteractionSeverityType,drugInteractionSeverityTitle,styleClasses,userProfiles,itemKeys){var injectionDrugInteractionService=this;var isMedispanEnable=getItemKeyValue(itemKeys.ENABLE_MEDISPAN).toLowerCase()==="yes"?true:false;var interactionsProactive=getUserProfile(userProfiles.ENABLE_PROACTIVE_DRUG_INTERACTION);var patientAllergyArray=[];injectionDrugInteractionService.allergyButtonColor=styleClasses.DEFAULT;injectionDrugInteractionService.allergyButtonTitle="";injectionDrugInteractionService.patientHasAllergy=false;injectionDrugInteractionService.isAllergyUncoded=false;injectionDrugInteractionService.getPatientAllergies=function(patientId,encounterId,strEncounterDate,strAllergiesStatus){return $http({headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"/mobiledoc/jsp/catalog/xml/getAllergiesForEncounter.jsp",method:"POST",data:$.param({"patientId":patientId,"encounterId":encounterId,"eDate":strEncounterDate,"status":strAllergiesStatus})}).then(function(response){return response.data},function(response){ecwAlert("Error occurred while getting the patient allergies.","Error")})};injectionDrugInteractionService.getAndCheckAllergyInteraction=function(encounterId,encDate,patientId,medicationItemId,medicationNDC){var aPromise=$http({method:'POST',data:$.param({"encid":encounterId,"eDate":encDate,"patientId":patientId,"RxId":medicationItemId,"ndc":medicationNDC}),url:"/mobiledoc/jsp/ecwrx/CheckAllergyInteraction.jsp"});return aPromise};injectionDrugInteractionService.getDrugInteractionSeverity=function(encounterId,userId){var drugInteractionUrl="/mobiledoc/jsp/catalog/xml/multum/DrugInteractionCheck.jsp";if(isMedispanEnable){drugInteractionUrl="/mobiledoc/jsp/ecwrx/getDrugInteractionSeverity.jsp"}return $http({headers:{"Content-Type":"application/x-www-form-urlencoded"},url:drugInteractionUrl,method:"POST",cache:false,data:$.param({"encid":encounterId,"TrUserId":userId})}).then(function(response){return response.data},function(response){ecwAlert("Error occured while checking for drug interactions.","Error")})};injectionDrugInteractionService.getDrugInteractionSeverityForNDC=function(patientId,encounterId,userId,medicationItemId,strNDCCode,isAssessmentsAvailable,assessmentsDetails){var drugInteractionUrl="/mobiledoc/jsp/catalog/xml/multum/DrugInteractionCheckByItemID.jsp";if(isMedispanEnable){drugInteractionUrl="/mobiledoc/jsp/ecwrx/getDrugInteractionSeverityByItemIDNDCCode.jsp"}return $http({headers:{"Content-Type":"application/x-www-form-urlencoded"},url:drugInteractionUrl,method:"POST",cache:false,data:setParametersBasedOnEncounterId(patientId,encounterId,userId,medicationItemId,strNDCCode,isAssessmentsAvailable,assessmentsDetails)}).then(function(response){return response.data},function(response){ecwAlert("Error occured while checking for drug interactions.","Error")})};function setParametersBasedOnEncounterId(patientId,encounterId,userId,medicationItemId,strNDCCode,isAssessmentsAvailable,assessmentsDetails){var parameters={};parameters.encid=encounterId;parameters.TrUserId=userId;parameters.PatientId=patientId;parameters.itemID=medicationItemId;parameters.NDCCode=strNDCCode;parameters.doctorsFlag="1";if(typeof isAssessmentsAvailable==='boolean'){parameters.isInjectionAssessmentAvailable=isAssessmentsAvailable}if(isAssessmentsAvailable&&assessmentsDetails&&assessmentsDetails.list){parameters.injectionSelectedAssessments=assessmentsDetails.list.toString()}else if(isAssessmentsAvailable===false&&assessmentsDetails&&assessmentsDetails.itemId){parameters.injectionItemId=assessmentsDetails.itemId}if(encounterId===0){parameters.ValidOfficeVisitOnly="";parameters.hasEncID="false"}return $.param(parameters)}injectionDrugInteractionService.loadDrugInteractionSeverity=function(encounterId,userId){injectionDrugInteractionService.getDrugInteractionSeverity(encounterId,userId).then(function(responseXMLData){var interactionObj=(new X2JS).xml_str2json($.trim(responseXMLData));var drugInteractionSeverity="-1";if(interactionObj&&interactionObj.Envelope.Body["return"]&&interactionObj.Envelope.Body["return"].severity&&interactionObj.Envelope.Body["return"].severity.severitycode){drugInteractionSeverity=interactionObj.Envelope.Body["return"].severity.severitycode}drugInteractionSeverity=parseIntWithBase10(drugInteractionSeverity);setInteractionButtonColorAndLabel(drugInteractionSeverity)})};function setInteractionButtonColorAndLabel(drugInteractionSeverity){if(drugInteractionSeverity===drugInteractionSeverityType.MAJOR){injectionDrugInteractionService.interactionButtonColor=styleClasses.MAJOR;injectionDrugInteractionService.interactionButtonTextColor=styleClasses.TEXT_WHITE;injectionDrugInteractionService.interactionButtonCaption=drugInteractionSeverityTitle.MAJOR}else if(drugInteractionSeverity===drugInteractionSeverityType.MODERATE){injectionDrugInteractionService.interactionButtonColor=styleClasses.MODERATE;injectionDrugInteractionService.interactionButtonTextColor=styleClasses.TEXT_WHITE;injectionDrugInteractionService.interactionButtonCaption=drugInteractionSeverityTitle.MODERATE}else if(drugInteractionSeverity===drugInteractionSeverityType.MINOR){injectionDrugInteractionService.interactionButtonColor=styleClasses.MINOR;injectionDrugInteractionService.interactionButtonTextColor=styleClasses.TEXT_DARK;injectionDrugInteractionService.interactionButtonCaption=drugInteractionSeverityTitle.MINOR}else if(drugInteractionSeverity===drugInteractionSeverityType.FOOD){injectionDrugInteractionService.interactionButtonColor=styleClasses.FOOD;injectionDrugInteractionService.interactionButtonTextColor=styleClasses.TEXT_WHITE;injectionDrugInteractionService.interactionButtonCaption=drugInteractionSeverityTitle.FOOD}else{injectionDrugInteractionService.interactionButtonColor=styleClasses.DEFAULT;injectionDrugInteractionService.interactionButtonTextColor=styleClasses.TEXT_DARK;injectionDrugInteractionService.interactionButtonCaption=drugInteractionSeverityTitle.DEFAULT}}injectionDrugInteractionService.checkDrugInteractionSeverityForNDCCode=function(patientId,encounterId,userId,medicationItemId,strNDCCode,drugInteractionByNDC,openInteractionPopup,isEditInjectionStatusPending,isAssessmentsAvailable,assessmentsDetails){showInjectionLoader();injectionDrugInteractionService.getDrugInteractionSeverityForNDC(patientId,encounterId,userId,medicationItemId,strNDCCode,isAssessmentsAvailable,assessmentsDetails).then(function(responseXMLData){hideInjectionLoader();var interactionObj=(new X2JS).xml_str2json($.trim(responseXMLData));var drugInteractionSeverity="-1";let allergyPopupLevel=getUserProfile(userProfiles.ALLERGY_POPUP_LEVEL);if(isEditInjectionStatusPending){allergyPopupLevel=getUserProfile(userProfiles.ALLERGY_POPUP_LEVEL_ADMINISTERING_DRUG)}if(interactionObj&&interactionObj.Envelope.Body["return"]&&interactionObj.Envelope.Body["return"].severity&&interactionObj.Envelope.Body["return"].severity.severitycode){drugInteractionSeverity=interactionObj.Envelope.Body["return"].severity.severitycode}drugInteractionSeverity=parseIntWithBase10(drugInteractionSeverity);if(drugInteractionByNDC){setInteractionButtonColorAndLabel(drugInteractionSeverity)}if((!drugInteractionByNDC||openInteractionPopup)&&interactionsProactive==="1"&&allergyPopupLevel>0&&(drugInteractionSeverity===drugInteractionSeverityType.MAJOR||drugInteractionSeverity===drugInteractionSeverityType.MODERATE&&allergyPopupLevel<3||drugInteractionSeverity===drugInteractionSeverityType.MINOR&&allergyPopupLevel<2)){injectionDrugInteractionService.showDrugInteractionScreen(patientId,encounterId,userId,medicationItemId,strNDCCode,isAssessmentsAvailable,assessmentsDetails)}})};injectionDrugInteractionService.showDrugInteractionScreen=function(patientId,encounterId,userId,medicationItemId,strNDCCode,isAssessmentsAvailable,assessmentsDetails){var strParentName="New Therapeutic Injection";if(!medicationItemId){medicationItemId=""}if(!strNDCCode){strNDCCode=""}if(typeof isAssessmentsAvailable==='string'&&isAssessmentsAvailable.length>0){isAssessmentsAvailable=isAssessmentsAvailable==='true'}if(typeof assessmentsDetails==='string'&&assessmentsDetails.length>0){assessmentsDetails=JSON.parse(assessmentsDetails)}$ocLazyLoad.load({name:"drugInteraction",files:getDependencies("drugInteraction")}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL("/mobiledoc/jsp/webemr/progressnotes/ecwrx/drugInteraction/drugInteraction.jsp"),controller:"drugInteractionController",windowClass:"app-modal-window1 bluetheme",keyboard:false,backdrop:"static",resolve:{patientID:function(){return patientId},encounterID:function(){return encounterId?encounterId:0},loginuserid:function(){return userId},parentName:function(){return strParentName},itemIDNDCObj:function(){return setItemIdNDCObjBasedOnEncounterId(encounterId,medicationItemId,strNDCCode,isAssessmentsAvailable,assessmentsDetails)}}});modalInstance.result.then(function(){},function(modalInstanceResponse){if(modalInstanceResponse==="success"){if(medicationItemId&&parseInt(medicationItemId,10)!==0){injectionDrugInteractionService.checkDrugInteractionSeverityForNDCCode(patientId,encounterId,userId,medicationItemId,strNDCCode,true,false,false,isAssessmentsAvailable,assessmentsDetails)}else{injectionDrugInteractionService.loadDrugInteractionSeverity(encounterId,userId)}}})})};function setItemIdNDCObjBasedOnEncounterId(encounterId,medicationItemId,strNDCCode,isAssessmentsAvailable,assessmentsDetails){var itemIdNDCObj={};itemIdNDCObj.itemid=medicationItemId;itemIdNDCObj.NDCCode=strNDCCode;itemIdNDCObj.doctorsFlag='1';encounterId=encounterId?encounterId:0;if(typeof isAssessmentsAvailable==='boolean'){itemIdNDCObj.isInjectionAssessmentAvailable=isAssessmentsAvailable}if(isAssessmentsAvailable&&assessmentsDetails&&assessmentsDetails.list){itemIdNDCObj.injectionSelectedAssessments=assessmentsDetails.list}else if(isAssessmentsAvailable===false&&assessmentsDetails&&assessmentsDetails.itemId){itemIdNDCObj.injectionItemId=assessmentsDetails.itemId}if(encounterId===0){itemIdNDCObj.hasEncID='false';itemIdNDCObj.aptDocID='0'}return itemIdNDCObj}injectionDrugInteractionService.loadPatientAllergies=function(patientId,encounterId,userId,strEncounterDate){injectionDrugInteractionService.getPatientAllergies(patientId,encounterId,strEncounterDate,"All").then(function(responseXMLData){var allergyObj=(new X2JS).xml_str2json($.trim(responseXMLData));if(allergyObj&&allergyObj.Envelope.Body["return"]){if(allergyObj.Envelope.Body["return"].allergys&&allergyObj.Envelope.Body["return"].allergys.hasOwnProperty("allergy")){injectionDrugInteractionService.patientHasAllergy=true;injectionDrugInteractionService.allergyButtonColor=styleClasses.MAJOR;if(allergyObj.Envelope.Body["return"].allergys.allergy.length>0){patientAllergyArray=allergyObj.Envelope.Body["return"].allergys.allergy}else{patientAllergyArray.push(allergyObj.Envelope.Body["return"].allergys.allergy)}}else{injectionDrugInteractionService.allergyButtonTitle="Patient does not have any allergies"}if($.trim(allergyObj.Envelope.Body["return"].uncoded)==="true"){injectionDrugInteractionService.patientHasAllergy=true;injectionDrugInteractionService.isAllergyUncoded=allergyObj.Envelope.Body["return"].uncoded;injectionDrugInteractionService.allergyButtonTitle="One or more allergies in this list are uncoded/unstructured. Uncoded allergies will not be considered for drug-allergy warnings.\n Please remove and re-enter them in structured/coded format"}}})};injectionDrugInteractionService.showPatientAllergyScreen=function(patientId,encounterId){$ocLazyLoad.load({name:"AllergyListModule",files:getDependencies("AllergyListModule")}).then(function(){$modal.open({templateUrl:makeURL("/mobiledoc/jsp/webemr/progressnotes/ecwrx/rx/showActiveAllergy.jsp"),controller:"AllergyListCtrl",windowClass:"bluetheme",backdrop:"static",resolve:{patientID:function(){return patientId},filterInfo:function(){return{multiSelect:"false",canDelete:"false",needBreadCrum:"false"}},ptAllergyArray:function(){return patientAllergyArray},hasPtAllergy:function(){return injectionDrugInteractionService.patientHasAllergy},encid:function(){return encounterId}}})})};injectionDrugInteractionService.checkAllergyInteraction=function(medicationItemId,medicationNDC,patientId,encounterId,encDate,allergyInteractionCallback){if(getItemKeyValue(itemKeys.SHOW_ALLERGIC_ALERTS).toUpperCase()==="YES"){if(!medicationItemId){medicationItemId=0}showInjectionLoader();var promise=injectionDrugInteractionService.getAndCheckAllergyInteraction(encounterId,encDate,patientId,medicationItemId,medicationNDC);promise.then(function(responseXMLData){hideInjectionLoader();var x2js=new X2JS;var ptAllergyObj=x2js.xml_str2json($.trim(responseXMLData.data));if(ptAllergyObj&&ptAllergyObj.Envelope&&ptAllergyObj.Envelope.Body&&ptAllergyObj.Envelope.Body["return"]&&(ptAllergyObj.Envelope.Body["return"].hasOwnProperty("DDAllergy")||ptAllergyObj.Envelope.Body["return"].hasOwnProperty("allergy"))){$ocLazyLoad.load({name:'AllergyInteraction',files:getDependencies("allergyInteraction")}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/allergy/allergyInteraction.jsp'),controller:'AllergyInteractionController',windowClass:'bluetheme',backdrop:"static",size:'lg',resolve:{patientID:function(){return patientId},encid:function(){return encounterId},parentName:function(){return""},itemName:function(){return ptAllergyObj.Envelope.Body["return"].itemName},doseCheckResponse:function(){return{}},doseCheckData:function(){return{}},ptAllergy:function(){return isMedispanEnable?returnDataArray(ptAllergyObj.Envelope.Body["return"].DDAllergy):getFormatedAllergyArray(ptAllergyObj)}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){allergyInteractionCallback(modalInstanceResponse==="Continue")})})}else{allergyInteractionCallback(true)}})}else{allergyInteractionCallback(true)}};function getFormatedAllergyArray(ptAllergyObj){var allergiesArray=[];allergiesArray=returnDataArray(ptAllergyObj.Envelope.Body["return"].allergy);for(var index=0;index<allergiesArray.length;index++){if(allergiesArray[index].hasOwnProperty("drug")){allergiesArray[index]["patientallergy"]=allergiesArray[index]["drug"];delete allergiesArray[index]["drug"]}if(allergiesArray[index].hasOwnProperty("allergyDesc")){allergiesArray[index]["allergyclass"]=allergiesArray[index]["allergyDesc"];delete allergiesArray[index]["allergyDesc"]}if(allergiesArray[index].hasOwnProperty("catDescr")){allergiesArray[index]["allergytype"]=allergiesArray[index]["catDescr"];delete allergiesArray[index]["catDescr"]}if(allergiesArray[index].hasOwnProperty("classDescr")){allergiesArray[index]["description"]=allergiesArray[index]["classDescr"];delete allergiesArray[index]["classDescr"]}}return allergiesArray}return injectionDrugInteractionService}function allergyButton(injectionDrugInteractionService){return{restrict:'E',replace:'true',templateUrl:'/mobiledoc/jsp/webemr/labs/immunizations/allergyButton-tpl.html',scope:{uniqueId:'@',patientId:'=',encounterId:'=',encounterDate:'@'},link:function(scope){scope.uniqueId='injection-allergy-'+(!scope.uniqueId?getRandomStringForId():scope.uniqueId);scope.encounterDate=!scope.encounterDate?encObj.encDate:scope.encounterDate;scope.injectionDrugInteractionService=injectionDrugInteractionService;injectionDrugInteractionService.loadPatientAllergies(scope.patientId,scope.encounterId,global.TrUserId,scope.encounterDate)}}}function drugInteractionButton(injectionDrugInteractionService,drugInteractionSeverityTitle,styleClasses){return{restrict:'E',replace:'true',templateUrl:'/mobiledoc/jsp/webemr/labs/immunizations/drugInteractionButton-tpl.html',scope:{uniqueId:'@',patientId:'=',encounterId:'=',drugInteractionByNdc:'@',medicationItemId:'@',medicationNdcCode:'@',isAssessmentsAvailable:'@',assessmentsDetails:'@'},link:function(scope){scope.uniqueId='injection-drug-interaction-'+(!scope.uniqueId?getRandomStringForId():scope.uniqueId);scope.userId=global.TrUserId;injectionDrugInteractionService.interactionButtonCaption=drugInteractionSeverityTitle.DEFAULT;injectionDrugInteractionService.interactionButtonColor=styleClasses.DEFAULT;injectionDrugInteractionService.interactionButtonTextColor=styleClasses.TEXT_DARK;scope.injectionDrugInteractionService=injectionDrugInteractionService;scope.medicationItemId=scope.medicationItemId?scope.medicationItemId:"";scope.medicationNdcCode=scope.medicationNdcCode?scope.medicationNdcCode:"";scope.encounterId=scope.encounterId?scope.encounterId:0;if(scope.isAssessmentsAvailable){scope.isAssessmentsAvailable=scope.isAssessmentsAvailable==='true'}if(scope.assessmentsDetails){scope.assessmentsDetails=JSON.parse(scope.assessmentsDetails)}if((!scope.drugInteractionByNdc||scope.drugInteractionByNdc==='false')&&(!scope.medicationItemId||scope.medicationItemId!=="")){injectionDrugInteractionService.loadDrugInteractionSeverity(scope.encounterId,scope.userId)}}}}function getRandomStringForId(){return(Date.now().toString(36)+Math.random().toString(36).substr(2,5)).toUpperCase()}function showInjectionLoader(){$('body').append('<div id="injection-loader-block"></div>')}function hideInjectionLoader(){if($('#injection-loader-block')){$('#injection-loader-block').remove()}}
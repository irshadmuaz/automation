(function(){angular.module('sunohEditLabDiProcOrder',{files:['/mobiledoc/jsp/webemr/sunoh/orders/sunoh-edit-lab-di-proc-imm-ref-order-popup.js'],serie:true});angular.module('dxListPopup',{files:['/mobiledoc/jsp/webemr/sunoh/dxdirective/dx-list-popup.js','/mobiledoc/jsp/webemr/sunoh/css/dx-list-popup.css'],serie:true});var sunohConversationModule=angular.module('sunohConversationModule',['ecw.service.EncDetailsService','angular-click-outside','QuickSearchDirective','ecw.telemed.service','ngSanitize','ecw.common.alert']);sunohConversationModule.controller('sunohConversationController',function($rootScope,$scope,$q,$document,$compile,$modal,$ocLazyLoad,$http,EncDetailsService,myScribePanelSharedService,PNService,SunohService,sharedServiceSunoh,mySharedService,SunohGlobalService,rxService,dataTruncUtilityService,modernAlertFactory){sunohGlobal.scope=$scope;$scope.isRecordingStart=false;$scope.isRecordingPaused=false;$scope.conversationData=[];$scope.isEnglishLang=false;$scope.audioFile="";$scope.sessionLanguage="";$scope.preferLang="";$scope.sunohLangError=false;$scope.isSecondaryLangExists=false;$scope.isReconnecting=false;$scope.preferLangJSON={};$scope.preferLangRegion="";$scope.preferLangCode="";$scope.preferLangSelected=false;$scope.providerDefaultLang="";$scope.sunohSecondaryLanguage="";$scope.hasStData=false;$scope.providerDefaultLangCode="";$scope.localLang=[];$scope.existingData={};$scope.importedSFList={};$scope.selectedLanguage="";$scope.selectedLocalLang={};$scope.isLangSelected=false;$scope.isSaveBtnVisible=false;$scope.isDirtyLangSelection=false;$scope.isPreferedSelectionExist=false;$scope.isPNTab=PNService.getIsPNTab();$scope.isStDataLoading=0;$scope.isLanguageVisible=true;$scope.languageRegion="";let onSelectSummaryTimeout;let onSelectSummayTimeoutSendEHR;$scope.isTaggingDone=false;$scope.isGenerateNoteCall=false;$scope.isOutSidePN=false;$scope.isOutSideTVPN=false;$scope.gptAnalysis={};$scope.masterDiagnosisArr=[];$scope.displayStFormContent=false;$scope.sectionList=[];$scope.structList=[];$scope.structuredSummary=[];$scope.stDataTitle='Loading Screenings & Structured Data';$scope.sunohAssessmentList=[];$scope.hpiSummary='';$scope.examSummary='';$scope.tabAction='progressNote';$scope.familyHxSummary='';$scope.medicalHxSummary='';$scope.socialHxSummary='';$scope.treatmentNoteSummary='';$scope.surgicalHxSummary='';$scope.vitalsSummary='';$scope.isFeedbackSumitted=false;$scope.conversationTemp='';$scope.hospitalizationSummary='';$scope.followupSummary='';$scope.isSignatureRegistered=false;$scope.signatureData="";$scope.aciAzure=null;$scope.hpiSunoh=false;$scope.isInputChanges=false;$scope.examSunoh=false;$scope.medicalHxSunoh=false;$scope.socialHxSunoh=false;$scope.vitalsSunoh=false;$scope.treatmentNoteSunoh=false;$scope.familyHxSunoh=false;$scope.surgicalHxSunoh=false;$scope.hospitalizationSunoh=false;$scope.followupSunoh=false;$scope.hpiQuickCheck=false;$scope.treamentNoteQuickCheck=false;$scope.examQuickCheck=false;$scope.medicalQuickCheck=false;$scope.socialHxQuickCheck=false;$scope.familyHxQuickCheck=false;$scope.surgicalHxQuickCheck=false;$scope.vitalsQuickCheck=false;$scope.hospitalizationQuickCheck=false;$scope.followupQuickCheck=false;$scope.currMedSunoh=false;$scope.currMedQuickCheck=false;$scope.assessmentSunoh=false;$scope.assessmentQuickCheck=false;$scope.allergiesSunoh=false;$scope.allergiesQuickCheck=false;$scope.medicationSunoh=false;$scope.medicationQuickCheck=false;$scope.labsSunoh=false;$scope.labsQuickCheck=false;$scope.diProcSunoh=false;$scope.diProcQuickCheck=false;$scope.immunizationsSunoh=false;$scope.immunizationsQuickCheck=false;$scope.referralSunoh=false;$scope.referralQuickCheck=false;$scope.convSummarySunoh=false;$scope.convSummaryQuickCheck=false;$scope.currentSelectedDx='';$scope.isDxSummaryLoading=false;$scope.transactions=[];$scope.currentTransaction={};$scope.isTVTransaction=0;$scope.showUserNavigationMsg=false;$scope.isScribeActive=false;$scope.isEncLocked=false;$scope.generateNotesAllow=false;$scope.scribeDisableMsg='';$scope.sunohOrders=false;$scope.sunohAssessments=false;$scope.retainSunoh=false;$scope.retainQuickCheck=false;$scope.sunohRecordId=0;$scope.transactions=[];$scope.encDxList=[];$scope.currentTransaction={};$scope.showUserNavigationMsg=false;$scope.isScribeActive=false;$scope.isEncLocked=false;$scope.generateNotesAllow=false;$scope.scribeDisableMsg='';$scope.sunohAssistantDisableMsg='';$scope.isHPICategoryClicked=false;$scope.isExamCategoryClicked=false;$scope.isImportEnabled=true;$scope.isHPIImported=false;$scope.isExamImported=false;$scope.isTreatmentNoteImported=false;$scope.isMedHxImported=false;$scope.isSocialHxImported=false;$scope.isFamilyHxImported=false;$scope.isSurgicalHxImported=false;$scope.isVitalsImported=false;$scope.isHospitalizationImported=false;$scope.tvConversationId='';$scope.selectedConv='';$scope.tvConversation={};$scope.importData={};$scope.stDataimportLog={};$scope.gptAnalysisDone=false;$scope.hpiDefaultValue=0;$scope.hpiSelectedValue=0;$scope.examDefaultValue=0;$scope.examSelectedValue=0;$scope.hpiList={};$scope.examList={};$scope.isUnsavedHPIData=false;$scope.isUnsavedMedHxData=false;$scope.isUnsavedSocialHxData=false;$scope.isHPIConfigVisible=false;$scope.isSummaryAvailable=false;$scope.isPhrasesAvailable=false;$scope.isTVEncounter=false;$scope.isTVSummary=false;$scope.isHpiHidden=false;$scope.isPreventiveMedHidden=false;$scope.isVitalHidden=false;$scope.isExamHidden=false;$scope.isHpiDefaultSet=false;$scope.isExamDefaultSet=false;$scope.isMedHxHidden=false;$scope.isSocialHxHidden=false;$scope.isTreatmentNoteHidden=false;$scope.isVitalsHidden=false;$scope.iFamilyHxHidden=false;$scope.iHospitalizationHidden=false;$scope.iBillingHidden=false;$scope.sunohSummaryId='';$scope.patientId='';$scope.userId='';$scope.encounterId='';$scope.encObj='';$scope.patientFullName='';$scope.type="widget";$scope.PNQSDetailsReqObj={};$scope.savedAssessments=[];$scope.treatmentNotesDataArr=[];$scope.isTreatmentDataDisplay=false;$scope.isExitFromPlay=false;$scope.orderConfigAssmtMandatory;$scope.selectSingleAssessment;$scope.dateObjForSinglePicker={openSingleDatePicker:false,readOnly:{inputField:false,calenderIcon:false}};$scope.immMinDate;$scope.showSettingPopover=false;$scope.defaultSettingsObject={};$scope.labDIOrderPlaced=false;$scope.showSummaryTab=true;$scope.showStructureTab=false;var structureDataChange=new Set;let labDIProcImmRefDirtyFlag=false;let futureOrderDateTypeSettingMapping={'SunohInHouseLabDefaultSetting':'SunohInHouseLabFutureDateDefaultSetting','SunohSendOutLabDefaultSetting':'SunohSendOutLabFutureDateDefaultSetting','SunohInHouseDIDefaultSetting':'SunohInHouseDIFutureDateDefaultSetting','SunohSendOutDIDefaultSetting':'SunohSendOutDIFutureDateDefaultSetting','SunohInHouseProcedureDefaultSetting':'SunohInHouseProcedureFutureDateDefaultSetting','SunohSendOutProcedureDefaultSetting':'SunohSendOutProcedureFutureDateDefaultSetting'};$('.page-scroll').on('scroll',function(){$('.dx-popup,.dx-popover').hide()});$scope.landingPageScope;const NOTE_TYPE_GENERAL=0;const NOTE_TYPE_VISION=1;const noteTypeMap=new Map;noteTypeMap.set(NOTE_TYPE_GENERAL,'');noteTypeMap.set(NOTE_TYPE_VISION,'vision');var isProviderSignatureRegistered=false;var providerSignatureData="";var encryptedProviderId="";$scope.userTypeByIds=new Map;$scope.txnUserId="";$scope.isSpeechEnabled=false;$document.on('click',function(event){const quickSectionMenuDiv=$(templateId+' #quickSectionMenuDiv')[0];const allCheckButton=$(templateId+' #allCheckButton')[0];var container=$('.dx-popover');if(!container.is(event.target)&&container.has(event.target).length===0&&!$(event.target).hasClass("update-dx-btn")&&!$(event.target).hasClass("link-dx-btn")){$('.dx-popover').hide()}if($(templateId+' .quickSectionMenu').css('display')!=='none'&&allCheckButton&&!allCheckButton.contains(event.target)&&quickSectionMenuDiv&&!quickSectionMenuDiv.contains(event.target)){quickSectionMenuDiv.style.display='none';$scope.$apply()}});$scope.$on('$routeChangeStart',function(event){if($scope.type==='summary'){$scope.closeSunohSummaryPopup();if(structureDataChange.size>0||labDIProcImmRefDirtyFlag||$scope.isInputChanges||checkForDataChangeInTreatmentPlan()){$("#divPNScreenLoader").css('display','none');event.preventDefault()}}});$scope.isSummaryPermission=false;let templateId="";let templateIndex;$scope.sunohLanguages;$scope.visionVisitFlag=false;$scope.isSunohStructDataEnabled='no';let sunohStructDataEnableFn=function(){if(!$scope.isSunohStandalone&&getItemKeyValue("SunohCommunitySupport").toLowerCase()=='yes'){$scope.isSunohStructDataEnabled='yes'}};$scope.reconnectingAudio=new Audio("data:audio/x-wav;base64, "+localStorage.getItem('sunohReconnectAudio'));$scope.reconnectingAudio.addEventListener('ended',function(){$scope.reconnectingAudio.currentTime=0;$scope.reconnectingAudio.play()},false);$scope.init=function(params){$scope.sunohLanguages=sunohGlobal.sunohLanguages;$('.notification-toast-wrapper .notification-theme-sunoh-info-msg .notification-iconclose').click();templateIndex=sunohGlobal.instanceCounter[params.encId+params.type].counter;let key=params.encId+params.type+templateIndex;sunohGlobal.templateScope[key]=$scope;$scope.patientId=params.patientId;$scope.encounterId=params.encId;$scope.userId=params.userId;$scope.type=params.type;templateId="#sunohInstance_"+params.encId+"_"+params.type+'_'+sunohGlobal.instanceCounter[params.encId+params.type].counter;$scope.encObj=EncDetailsService.getEncDetailsByEncId(params.encId);if($scope.encObj.visionVisitFlag&&getItemKeyValue('visionUSEnable').toLowerCase()==='yes'){$scope.visionVisitFlag=true;$scope.integratedNoteType=NOTE_TYPE_VISION}else{$scope.integratedNoteType=NOTE_TYPE_GENERAL}$scope.eRxLogsURLFromSunohRx="";sunohGlobal.instanceCounter[$scope.encounterId+$scope.type]['status']=-1;introJs().exit();$scope.isSummaryPermission=sharedServiceSunoh.isSummaryPermission;if(!sunohGlobal.isSessionActive){localStorage.removeItem("sunohSession")}let sunohSession=localStorage.getItem("sunohSession");if(sunohSession&&JSON.parse(sunohSession).sessionEncid!==$scope.encounterId&&$scope.type==="widget"){showCustomErrorDialog("Sunoh - Concurrent Recordings","A Sunoh recording session is currently active for "+JSON.parse(sunohSession).sessionPatientFullName+". To avoid any conflicts, please complete the current session before starting a new one. </br></br>"+"If there is an issue log out and log back in.")}else if($scope.type==='widget'&&$scope.isTaggingDone&&sunohSession&&JSON.parse(sunohSession).sessionEncid===$scope.encounterId){$("#playSection,#summaryGenerated,.sunoh-ps-alert").addClass("highlight");setTimeout(function(){$("#playSection,#summaryGenerated,.sunoh-ps-alert").removeClass("highlight")},2e3)}else{if($(templateId+' #viewSummary:visible').length>0){$scope.closeSummary()}if($(templateId+' .search-transcript-modal:visible').length>0){$scope.closeSunohSummaryPopup();return}SunohService.userOutOfPN=function(){};SunohService.setUserOutPNFn=function(){SunohService.userOutOfPN=setUserOutOfPN};SunohService.setUserOutPNFn();$scope.type=SunohService.type;$scope.patientFullName=$scope.encObj.name;$scope.isTVEncounter=$scope.encounterId+''===mySharedService.encounterId||$scope.encObj['isTelemed']+''==='true';setTimeout(function(){$scope.gptAnalysis.ptId=$scope.patientId;$scope.gptAnalysis.providerName=getProviderFullNameWithSuffixInProperFormate();$scope.setSunohPtIdentifier();$scope.loadOlderConversation(true,$scope.isTVEncounter);$scope.setSunohPtIdentifier()});$scope.encDtForTreatmentScreen={nPatientId:$scope.patientId,nTrUserId:$scope.userId,nEncounterId:$scope.encounterId,nDoctorId:EncDetailsService.getProviderId()};$scope.PNQSDetailsReqObj=_.clone($scope.encDtForTreatmentScreen);var screenObj={screenName:"SunohQuickOrders"};$scope.PNQSDetailsReqObj.sContext=screenObj.screenName;$scope.PNQSDetailsReqObj.nDxItemId=0;$scope.PNQSDetailsReqObj.sActionType="";$scope.PNQSDetailsResponseObj=[];$scope.PNQSDetailsResponseObj.obj=[]}sunohStructDataEnableFn()};$scope.renderComplete=function(){if($scope.structuredSummary.length>0){$scope.isStDataLoading=2;$(".stDataTab").removeClass("disableStDataTab");$(".stDataTab").parent().removeClass("disableStDataLi");$(".stDataTab").parent().addClass("stDataLi");$(".stDataTab").find("img").attr("src","/mobiledoc/jsp/webemr/sunoh/img/StructureData/Screenings-Enabled.svg")}else{$scope.isStDataLoading=2;$(".stDataTab").addClass("disableStDataTab");$(".stDataTab").parent().addClass("disableStDataLi");$(".stDataTab").parent().removeClass("stDataLi");$(".stDataTab").find("img").attr("src","/mobiledoc/jsp/webemr/sunoh/img/StructureData/Screenings-Disabled.svg");$scope.stDataTitle="No content for your configured Screenings & Structured Data was detected. \n"+"Available Screenings & Structured Data can be managed in Sunoh Settings."}setTimeout(function(){$.each($scope.importedSFList,function(index,sfList){let propId=sfList.propId;$.each($scope.structList,function(index,value){if(String(propId)==String(value.propId)){value.isDisplay=true}});$('.checkmark-circle[propId="'+propId+'"]').hide();$('.greenTickIcon'+propId).show();let formName=$('.greenTickIcon'+propId).siblings('span').text();$('.greenTickIcon'+propId).attr('title',formName+' merged by '+sfList.ulname+", "+sfList.ufname+' on '+sfList.actionDateTime);$('.struct-data-div'+propId).addClass('struct-apply-border');$(".respText"+propId).attr('style','cursor: context-menu !important;color:grey');$('.structuredata-title[propId="'+propId+'"]').addClass('smart-form-link');$('.respText'+propId).find('.sunoh-error').hide()});$scope.disableSection();$scope.$apply()},100)};$scope.renderStDataHTML=function(response){$.each(response,function(index,value){let qid=value.qId;let answer=value.answer;let displayLbl=$(".sunohDataList"+qid);if(answer.length>0){let answerArr=answer.split(";");let optionFound=false;let displayContent="";displayLbl.text("");$.each(answerArr,function(index,anserArrValue){let type=String($("[customid='"+qid+"']").attr("fieldtype"));if(type===String("1")||type===String("2")||type===String("4")||type===String("5")){$("#structInput"+qid).val(anserArrValue);displayContent=anserArrValue;optionFound=true}else{$("#structSelect"+qid+" option").each(function(){if($(this).text()===anserArrValue){$(this).attr('selected','selected');if(displayContent!==''){displayContent=displayContent+", "}displayContent=displayContent+anserArrValue;optionFound=true;return false}else{optionFound=false}})}});displayLbl.append(' <u>'+displayContent+'</u>');for(let i=0;i<$scope.structItems.length;i++){let structItems=$scope.structItems[i];if(structItems.id===''+qid&&(structItems.type==="2"||structItems.type==="4"||structItems.type==="5")){if(!$scope.parseDateFormat(answer,structItems.type)){$("#sunohstructerror"+qid).show()}break}if(structItems.id===''+qid&&structItems.type==="1"){if(!isNumeric(answer)){$("#sunohstructerror"+qid).show()}break}}if(!optionFound){displayLbl.html('<span  style="height: 15px;margin-bottom: -3px;margin-right: 10px;"><u>'+answer+'</u></span><img src="/mobiledoc/jsp/webemr/sunoh/img/StructureData/alert-input-form.svg" title="Please select a valid response." class="sunoh-error" style="height: 15px;margin-bottom: 1px;">')}}});setTimeout(function(){for(let i=0;i<$scope.structItems.length;i++){let structItems=$scope.structItems[i];if(structItems.id&&$(".sunohDataList"+structItems.id).text()===''){$.each($scope.existingData,function(index,existData){if(String(existData.detailId)===String($(".sunohDataList"+structItems.id).attr("mapped-qid"))){if(existData.value.length>0){let answerArr=existData.value.split(",");let qid=structItems.id;let displayExistLbl=$(".sunohDataList"+qid);let displayContent="";displayExistLbl.text("");$.each(answerArr,function(index,anserArrValue){let type=String($("[customid='"+qid+"']").attr("fieldtype"));if(type===String("1")||type===String("2")||type===String("4")||type===String("5")){$("#structInput"+qid).val(anserArrValue);displayContent=anserArrValue}else{$("#structSelect"+qid+" option").each(function(){if($(this).text()===anserArrValue){$(this).attr('selected','selected');if(displayContent!==''){displayContent=displayContent+", "}displayContent=displayContent+anserArrValue;return false}})}});displayExistLbl.append(' <u>'+displayContent+'</u>');$(".sunohDataList"+qid).addClass('existData');$(".history"+qid).show();$(".struct-social-p").removeClass('hide')}else{$(".sunohDataList"+structItems.id).removeClass('existData');$(".history"+structItems.id).hide();$(".sunohDataList"+structItems.id).html('<span style="height: 15px;margin-bottom: -3px;"><u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</u></span>')}}});if(structItems.id&&$(".sunohDataList"+structItems.id).text()===''){$(".sunohDataList"+structItems.id).removeClass('existData');$(".history"+structItems.id).hide();$(".sunohDataList"+structItems.id).html('<span style="height: 15px;margin-bottom: -3px;"><u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</u></span>')}}let quesElementType=$("[customid='"+structItems.id+"']").attr("fieldtype");let quesElement;if(quesElementType===String("1")||quesElementType===String("2")||quesElementType===String("4")||quesElementType===String("5")){quesElement=$("#structInput"+structItems.id)}else{quesElement=$("#structSelect"+structItems.id)}let parentQId=quesElement.attr("parent-qid");let parentOpId=quesElement.attr("parent-optionid");if(parseInt(parentQId)>0){if(String($("#structSelect"+parentQId+" option:selected").attr('mapped-optionid'))===String(parentOpId)){$(quesElement).closest('.tobacco-container').show()}else{$(quesElement).closest('.tobacco-container').hide()}}}},1e3)};function isNumeric(num){return!isNaN(num)}const structuredDateFormats=new Map;structuredDateFormats.set('2','MM/DD/YYYY');structuredDateFormats.set('4','MM/YYYY');structuredDateFormats.set('5','YYYY');$scope.parseDateFormat=function(input,type){let date=moment(input,structuredDateFormats.get(type),true);if(date.isValid()){return true}else{return false}};$scope.showOptions=function(item,event){structureDataChange.add(item.propId);$scope.selectedMultiSelecteId=0;if($(".greenTickIcon"+item.propId).is(":visible")){$("#"+event.currentTarget.id).css('cursor','context-menu');return false}item.isChangeable=true;if(item.type==0&&item.multiselect==1){$scope.selectedMultiSelecteId=item.id;let target=$("#"+event.currentTarget.id).parent().find(".multi-select-elem").multiSelect({maxHeight:200})}};$scope.validateDate=function(event,type){let isValid=$scope.parseDateFormat($("#"+event.target.id).val(),type);let structId=$("#"+event.target.id).attr("customid");if(isValid){$("#sunohstructerror"+structId).hide()}else{$("#sunohstructerror"+structId).show()}};$scope.validateNumeric=function(event,type){let isValid=isNumeric($("#"+event.target.id).val(),type);let structId=$("#"+event.target.id).attr("customid");if(isValid){$("#sunohstructerror"+structId).hide()}else{$("#sunohstructerror"+structId).show()}};$scope.hideOptions=function(item){let isValid=false;if(item.type==="2"||item.type==="4"||item.type==="5"){if($("#structInput"+item.id).val()!=""){$("#sunoh_label_"+item.id+" u").text($("#structInput"+item.id).val());isValid=$scope.parseDateFormat($("#structInput"+item.id).val(),item.type)}else{$("#sunoh_label_"+item.id+" u").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;');isValid=true}}else if(item.type==="1"){if($("#structInput"+item.id).val()!=""){$("#sunoh_label_"+item.id+" u").text($("#structInput"+item.id).val())}else{$("#sunoh_label_"+item.id+" u").html('&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;')}isValid=true}else if(item.type==='3'){let val=$("#structSelect"+item.id).find(":selected").val();if(val.length>0){$("#sunoh_label_"+item.id+" u").text($("#structSelect"+item.id).find(":selected").text())}else{$("#sunoh_label_"+item.id+" u").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")}isValid=true}else if(item.type==='0'){if(item.multiselect==='0'){let val=$("#structSelect"+item.id).find(":selected").val();if(val.length>0){$("#sunoh_label_"+item.id+" u").text($("#structSelect"+item.id).find(":selected").text())}else{$("#sunoh_label_"+item.id+" u").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")}}else{var selectedTexts=[];$("#structSelect"+item.id).find(":selected").each(function(){selectedTexts.push($(this).text())});let commaseperatedText=selectedTexts.join(", ");if(commaseperatedText.length>0){$("#sunoh_label_"+item.id+" u").text(commaseperatedText)}else{$("#sunoh_label_"+item.id+" u").html("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")}}isValid=true}else{$("#sunoh_label_"+item.id+" u").text($("#structSelect"+item.id).find(":selected").text());isValid=true}if(isValid){$("#sunohstructerror"+item.id).hide();$("#sunohstructerror"+item.id).parent().find('.sunoh-error').hide();item.isChangeable=!item.isChangeable;$("#sunoh_label_"+item.id).removeClass("existData");if($("#sunohScribeACIModule .existData").length==0){$(".struct-social-p").addClass('hide')}$(".history"+item.id).remove()}};$scope.renderStructureData=function(resData){let formArr=[];$.each(resData,function(index,resSummary){if(resSummary.formId){formArr.push(resSummary.formId)}});if(formArr.length>0){$scope.getStDataDetail(formArr);setTimeout(function(){$.each(resData,function(index,resSummary){$scope.renderStDataHTML(resSummary.response)});$scope.renderStDataImportLog($scope.stDataimportLog);$scope.renderComplete()},2e3)}else{$scope.renderComplete()}};$scope.showReconnecting=function(isVisible){$scope.isReconnecting=isVisible;if(isVisible){$scope.reconnectingAudio.play()}else{$scope.reconnectingAudio.pause()}safeApplyScope()};$scope.loadQSDxList=function(){$scope.$broadcast('loadQSDxList')};$scope.jumpToEle=function(id,e){let addSpace=0;let back=$(templateId+' .sunoh-back:visible');if(back.length>0){back.trigger('click')}const topPos=$(templateId+" #"+id)[0].offsetTop;$(templateId+' .page-scroll').animate({scrollTop:topPos},300);$(templateId+" #floating-panel a").removeClass("active");if(e){$(e.currentTarget).addClass("active")}};$scope.hpiShort=false;$scope.showShortHPI=false;$scope.longHPI=function(){$scope.showShortHPI=false;setTimeout(function(){$scope.strechingTextArea()})};$scope.shortHPI=function(){$scope.showShortHPI=true;setTimeout(function(){$scope.strechingTextArea()})};$scope.setPNQSDetails=function(){return 1};$scope.saveStructureData=function(itemList){var url="/mobiledoc/jsp/catalog/xml/setStructData.jsp?encId="+$scope.encounterId+"&catId="+itemList[0].catId+"&itemId="+itemList[0].itemId+"&table="+itemList[0].section+"&woundId=1";url=makeURL(url);structureDataChange["delete"](itemList[0].propId);var xmlData='';var xmlDataHeader='<S:Envelope\n'+'\txmlns:S="http://schemas.xmlsoap.org/soap/envelope/"\n'+'\txmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" S:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"\n'+'\txmlns:xsd="http://www.w3.org/1999/XMLSchema"\n'+'\txmlns:xsi="http://www.w3.org/1999/XMLSchema-instance">\n'+'\t<Body>\n'+'\t\t<m:NOOP\n'+'\t\t\txmlns:m="NOOP">\n'+'\t\t\t<userDefaultId xsi:type="xsd:string">-1</userDefaultId>';var xmlDataFooter='</m:NOOP>\n'+'\t</Body>\n'+'</S:Envelope>';var xmlContentData='';$.each(itemList,function(index,value){let qid=value.mappedQId;let selectedValueId=[];var selectedValueText=[];if(value.type===String("0")||value.type===String("3")){if($(".sunohDataList"+value.id).is(":visible")){$.each($("#structSelect"+value.id+" option:selected"),function(){selectedValueId.push($(this).val())});$.each($("#structSelect"+value.id+" option:selected"),function(){if($(this).text()!=='Select'&&$(this).text().length>0){selectedValueText.push($(this).text())}})}}else if(value.type===String("2")||value.type===String("4")||value.type===String("5")){selectedValueId.push('');if($(".sunohDataList"+value.id).is(":visible")){if($("#structInput"+value.id).val().length>0){selectedValueText.push($("#structInput"+value.id+"").val())}}}else if(value.type===String("1")){selectedValueId.push('');if($(".sunohDataList"+value.id).is(":visible")){if($("#structInput"+value.id).val().length>0){selectedValueText.push($("#structInput"+value.id+"").val())}}}if(selectedValueText.length>0){xmlContentData+='<item xsi:type="xsd:string"><detailId xsi:type="xsd:string">'+qid+'</detailId><value xsi:type="xsd:string"><![CDATA['+selectedValueText.join(", ")+']]></value><notes xsi:type="xsd:string"></notes><valueId xsi:type="xsd:string">'+selectedValueId.join(",")+'</valueId><defaultId xsi:type="xsd:string">-1</defaultId></item>'}});xmlData=xmlDataHeader+xmlContentData+xmlDataFooter;var xsrf=$.param({FormData:xmlData,StructData:''});$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,data:xsrf}).then(function(response){$scope.refreshProgressNote();notification.show('success','Sunoh','The '+itemList[0].title+' have been merged successfully.',4e3)},function(response){throw"Internal Error occured, Please try after some time"})};$scope.saveImportLog=function(savedFormIds){let url="/mobiledoc/modules/webemr/sunoh/saveImportLog";let payload={savedSectionsList:savedFormIds,encounterId:$scope.encounterId};$http({method:"POST",url:makeURL(url),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){if(response.status==='success'&&response.importLogList.length>0){let respData=response.importLogList;if(respData&&respData.length>0){$scope.stDataimportLog=JSON.parse(respData);$scope.renderStDataImportLog($scope.stDataimportLog);setTimeout(function(){$scope.disableSection()})}}})};$scope.renderStDataImportLog=function(respData){$scope.clearStDataImportLog();let importedData=respData;if(importedData&&importedData.length>0){for(let importData of importedData){let sections=importData.sections.split(",");sections.forEach(function(propId){$.each($scope.structList,function(index,value){if(String(propId)==String(value.propId)){value.isDisplay=true}});$('.checkmark-circle[propId="'+propId+'"]').hide();$('.greenTickIcon'+propId).show();let formName=$('.greenTickIcon'+propId).siblings('span').text();$('.greenTickIcon'+propId).attr('title',formName+' merged by '+importData.userName+' on '+importData.lastModified);$('.struct-data-div'+propId).addClass('struct-apply-border');$(".respText"+propId).attr('style','cursor: context-menu !important;color:grey');if($('.structuredata-title[propId="'+propId+'"]').attr("formId")>0){$('.structuredata-title[propId="'+propId+'"]').addClass('smart-form-link')}$('.respText'+propId).find('.sunoh-error').hide()})}}else{$scope.renderComplete()}};$scope.disableSection=function(){$.each($(".stDataSection"),function(){let noOfForm=$(this).find(".structured-data-body").length;let importedForm=0;$.each($(this).find(".structured-data-body").find(".sectionImportIcon"),function(){if($(this).css('display')!=='none'){importedForm=importedForm+1}});let sectionName=$(this).find(".checkmark-section-circle").attr("parent-section");if($scope.isSectionHiddenForStructData(sectionName)){$('div[child-section='+sectionName+']').addClass('disableCheckbox').attr('title','This section cannot be imported because its hidden from Progress Notes.');$('div[parent-section='+sectionName+']').addClass('disableCheckbox').attr('title','This section cannot be imported because its hidden from Progress Notes.');$('.quickSectionli input[section-name='+sectionName+']').attr("disabled",true)}if(noOfForm===importedForm){$('.checkmark-section-circle[parent-section="'+sectionName+'"]').addClass('disableCheckbox d-none');$('.checkmark-section-circle[parent-section="'+sectionName+'"]').siblings('i').show();$('.sectionlist-checkbox[section-name="'+sectionName+'"]').prop('disabled',true)}})};$scope.clearStDataImportLog=function(){$.each($scope.structList,function(index,value){value.isDisplay=false});$('.checkmark-circle').show();$("[class*='greenTickIcon']").hide();$('.structuredata-title').removeClass('smart-form-link');$("[class*='respText']").attr('style','cursor: pointer !important;color:black');$("[class*='respText']").find('.sunoh-error').show();$("[class*='checkmark-section-circle']").removeClass('disableCheckbox d-none');$("[class*='checkmark-section-circle']").siblings('i').hide();$("[class*='sectionlist-checkbox']").prop('disabled',false);$("[class*='struct-data-div']").removeClass('struct-apply-border');$('div[child-section]').removeClass('disableCheckbox');$('div[child-section]').removeClass("nobrdr");$('div[child-section]').children().addClass("d-none");$('div[child-section]').children().removeClass("active-check");$('div[parent-section]').removeClass('disableCheckbox').attr("title","");$('div[parent-section]').removeClass("nobrdr");$('div[parent-section]').children().addClass("d-none");$('div[parent-section]').children().removeClass("active-check");$('.sectionlist-checkbox[section-name]').prop('checked',false);$('.stDataCheckBox[section-name]').prop('checked',false);$('.quickSectionli input[section-name]').attr("disabled",false);$(".struct-social-p").addClass('hide')};$scope.fetchStructureDataDetails=function(requestURL,formIdArr){var url=makeURL(requestURL);var aPromise=$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,data:$.param({formId:formIdArr.toString(),patientId:$scope.patientId,encId:$scope.encounterId})}).then(function(response){let data=response.data;return data},function(response){throw"Internal Error occured, Please try after some time"});return aPromise};$scope.updateFocusableDiv=function(){setTimeout(function(){$(document).on('click',function(event){var $target=$(event.target);if($target.parent().hasClass("sunohShowOptions")||$target.parent().parent().hasClass("sunohShowOptions")){return}var $focusableDiv=$(".focusable-div");$focusableDiv.each(function(index,element){if(!$target.closest($(element)).length){if("structSelectdiv"+$scope.selectedMultiSelecteId===element.getAttribute("id")){$(element).trigger('blur');$scope.selectedMultiSelecteId=0}}})})},2e3)};$scope.getStDataDetail=function(formIds){var quesPromise=$scope.fetchStructureDataDetails('/mobiledoc/modules/webemr/sunoh/getSunohStDataByFormId',formIds);quesPromise.then(function(response){if(response.questions){$scope.structItems=response.questions;$scope.updateFocusableDiv()}if(response.existData){$scope.existingData=response.existData}if(response.importedSFList){$scope.importedSFList=response.importedSFList}if(response.sections){$scope.structList=response.sections;let secDetail=new Set;$scope.structList.forEach(function(e){secDetail.add(e.displaySection)});$scope.sectionList=Array.from(secDetail);$scope.stDataTitle="";$.each($scope.structList,function(index,section){if(section){$scope.stDataTitle+=section.title+"\n"+""}})}if(response.options){$scope.structItemOptions=response.options}},function errorCallback(error){console.log("Error in fetching structured data questions")})};$scope.setSunohPtIdentifier=function(){let ptDetails=$scope.encObj.patientIdentifierDetails;let date=$scope.getFormattedDate(ptDetails.dateOfBirth);let mdob=moment(ptDetails.dateOfBirth,"MM/DD/YYYY");let age=moment().diff(mdob,"years");let middleInitial=ptDetails.middleInitial!==''?' '+ptDetails.middleInitial+' ':"";let suffix=ptDetails.suffix!==''?' '+ptDetails.suffix+' ':"";let gender=ptDetails.sex.charAt(0).toUpperCase();if(gender!=='M'&&gender!=='F'){gender="Other"}let sunohPtIdentifier=ptDetails.lastName+', '+ptDetails.firstName+middleInitial+suffix+" ðŸŽ‚ "+date+' ('+age+' yo '+gender+") ðŸ“ "+'Acc. No. '+ptDetails.accountNumber;$(templateId+' .sunoh-pt-name').attr('title',sunohPtIdentifier)};$scope.submitFeedback=function(value,isTvSummary){if($scope.feedback>=0&&value===$scope.feedback){value=-1}let payload={id:$scope.selectedTrxId,value:value,isTv:isTvSummary};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/saveFeedback'),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){$scope.feedback=value;if(isTvSummary){$scope.isFeedbackSumitted=true}notification.show('success','Sunoh','Response Submitted.',4e3)}).error(function(error){notification.show('error','','Response not saved.',4e3)})};$scope.hideDropDown=function(isExam){if(isExam&&$(templateId+' #exam-default-label').length===0){$scope.isExamCategoryClicked=false}else if($(templateId+' #hpi-default-label').length===0){$scope.isHPICategoryClicked=false}};$scope.toggleCategoryDropDown=function(isExam){if(isExam){$scope.isExamCategoryClicked=!$scope.isExamCategoryClicked}else{$scope.isHPICategoryClicked=!$scope.isHPICategoryClicked}};$scope.getFormattedDate=function(ptDob){let dob=moment(ptDob,['MM/DD/YYYY']);return dob.format('MMM D, YYYY')};$scope.triggerHpiConfigForDefaultCat=function(){if(!$scope.isHpiHidden){$(templateId+" .hpi-config").trigger("click")}};$scope.triggerExamConfigForDefaultCat=function(){if(!$scope.isExamHidden){$(templateId+" .exam-config").trigger("click")}};$scope.getHpiDisableTitle=function(){let title="";if($scope.isHpiHidden){title+="HPI section is hidden\n"}if($scope.hpiDefaultValue===0){title+="HPI default category is not set\n"}return title};$scope.getExamDisableTitle=function(){let title="";if($scope.isExamHidden){title+="Examination section is hidden\n"}if($scope.examDefaultValue===0){title+="Examination default category is not set\n"}return title};$scope.sunohSpeechModelFn=function(){$scope.cleanup();sharedServiceSunoh.openSunohSpeechModel()};$scope.toStandardCase=function(inputString){let words=inputString.split('_').map(word=>word.charAt(0).toUpperCase()+word.slice(1).toLowerCase());return words.join(' ')};$scope.getStringFromJSONArray=function(obj){let result="";for(let i=0;i<obj.length;i++){result+=obj[i]+"\n"}return result};$scope.recursiveObjects=function(obj){let result="";if(Array.isArray(obj)){result+=$scope.iterateJSONArray(obj)}if(typeof obj==='object'&&obj!==null&&!Array.isArray(obj)){result+=$scope.iterateJSONObject(obj)}if(typeof obj==='string'){result+=$scope.iterateJSONArray(obj)}return result.trim()};$scope.iterateJSONArray=function(obj){let result="";for(let i=0;i<obj.length;i++){let arrayProps=obj[i];if(Array.isArray(arrayProps)){$scope.iterateJSONArray(arrayProps)}else if(typeof arrayProps==='object'&&arrayProps!==null&&!Array.isArray(arrayProps)){result+=$scope.iterateJSONObject(arrayProps)}else if(typeof arrayProps==='string'){result+=$scope.toStandardCase(arrayProps)+"\n"}}return result+"\n"};$scope.iterateJSONObject=function(obj){let result="";if(typeof obj==='object'){for(let key in obj){if(Array.isArray(obj[key])){result+=key+":\n"+$scope.iterateJSONArray(obj[key])}if(typeof obj[key]==='object'&&obj[key]!==null&&!Array.isArray(obj[key])){result+=key+":\n"+$scope.iterateJSONObject(obj[key])}else if(typeof obj[key]==='string'){result+=$scope.toStandardCase(key)+": "+obj[key]+"\n"}}}return result};$scope.getSummaryJsonFromTxn=function(summary){let result={};try{result=JSON.parse(summary);return result.summary}catch(e){}if(typeof result.summary==='undefined'){return""}return result.summary};$scope.openSummaryFor=function(id,isTV,sunohStatusId){$scope.currentTransaction=id;$scope.selectedTrxId=id;$scope.isTVSummary=isTV===1;if(!$scope.isTVSummary){$scope.getAdditionContent(sunohStatusId)}$http({url:makeURL("/mobiledoc/modules/webemr/sunoh/get/conversationbyid?id="+id+"&isTV="+isTV+"&encId="+$scope.encounterId),method:'GET',dataType:'text'}).success(function(data){$("#inlineAsmtURL").html('');$scope.resetOrderScope();$scope.transactionsummarydata=data;$scope.sunohRecordId=data.sunohstatusid;$scope.loadAssessements();$(templateId+' #summaryGenerated').hide();$(templateId+' .sumoh-summarize').addClass('dnone');$scope.audioFile="";$scope.sunohSummaryId=data.sunohSummaryId;$scope.isRecover_summary=data.isRecover;$scope.sunohSecondaryLanguage=data.secondaryLanguage;$scope.hasStData=data.hasStData;if(data.isRecover==="no"&&data.conversationData&&data.conversationData!=="Not Available"&&!$scope.isTVSummary){$scope.getExistingConversationsAudio(data.sunohstatusid)}if($scope.isSunohStructDataEnabled==='yes'){if($scope.hasStData){$scope.getStDataResponse($scope.userId,sunohStatusId)}else{$scope.structuredSummary=[];$scope.renderComplete()}}$scope.showSummaryClicked(true);$scope.updateModels(data,false,isTV);$scope.loadSuggestedMedications()})};$scope.sunohMsg="";$scope.sunohTranslationRunning=false;$scope.getAdditionContent=function(sunohStatusId){let url=makeURL("/mobiledoc/modules/webemr/sunoh/additional-info");let workerUrl=makeURL("/mobiledoc/jsp/webemr/sunoh/js/telemed.worker.js");let payload=$.param({userId:$scope.userId,sunohStatusId:sunohStatusId});translationWorker.checkTranslationStatus(url,payload,workerUrl).then(function(res){$scope.sunohMsg="";$scope.sunohTranslationRunning=false;$scope.sunohLangError=false;if(res.status==='running'){$scope.isSecondaryLangExists=true;sunohGlobal.checkTransalationStatusInterval&&clearTimeout(sunohGlobal.checkTransalationStatusInterval);sunohGlobal.checkTransalationStatusInterval=setTimeout(function(){$scope.getAdditionContent(sunohStatusId)},15e3);$scope.sunohTranslationRunning=true;$scope.sunohMsg="Translation in progress. Please wait."}else if(res.status==='failed'){$scope.isSecondaryLangExists=true;$scope.sunohLangError=true;$scope.sunohMsg="Sunoh error: unable to translate conversation.";clearTimeout(sunohGlobal.checkTransalationStatusInterval)}else if(res.isSecondaryLang){$scope.isSecondaryLangExists=true;$scope.isSecondaryLangExists=res.isSecondaryLang;$scope.conversationData=JSON.parse(res.transcript);clearTimeout(sunohGlobal.checkTransalationStatusInterval)}setTimeout(function(){$scope.adjustSectionsScrollHt()});safeApplyScope()},function(error){clearTimeout(sunohGlobal.checkTransalationStatusInterval);console.log(error)})};$scope.getStDataResponse=function(userId,sunohStatusId){if(typeof structureDataWorker!=='undefined'&&structureDataWorker){let url=makeURL("/mobiledoc/modules/webemr/sunoh/getStDataResponse");let workerUrl=makeURL("/mobiledoc/jsp/webemr/sunoh/js/structuredata.worker.js");let payload='sunohStatusId='+sunohStatusId;structureDataWorker.getStDataResponse(url,payload,workerUrl,false).then(function(respData){try{$scope.structuredSummary=JSON.parse(respData);let isJsonArr=$scope.structuredSummary[0].formId!=undefined;if(!isJsonArr){$scope.structuredSummary=JSON.parse("["+$scope.structuredSummary+"]")}}catch(e){$scope.structuredSummary=[]}$scope.displayStFormContent=true;$scope.renderStructureData($scope.structuredSummary)},function(error){$scope.isStDataLoading=1;$scope.stDataTitle="There was an error generating Screenings & Structured Data.";console.log(error)})}};$scope.getUserFullNameById=function(id){if(id){if($scope.userTypeByIds.has(id))return $scope.userTypeByIds.get(id);let name=getUserfullnameFromId(id);$scope.userTypeByIds.set(id,name);return name}else{return $scope.currentTransaction.userName}};$scope.getUserTitle=function(userType){switch(userType){case"provider":return"Provider";break;case"patient":return"Patient";break;case"staff":return"Staff";break;case"contact":return"Contact";break;default:return"";break}return result.summary};$scope.mergeDefaultTooltip="Check the box to merge defaults for the selected category";$scope.enableMergeDefault=function(isChangeRequired){let examMergeEle=$(templateId+' #exam-merge-default');if(!isChangeRequired){if(!examMergeEle.prop('checked')){$scope.mergeDefaultTooltip="Check the box to merge defaults for the selected category"}else{$scope.mergeDefaultTooltip='Uncheck the box to not merge defaults for the selected category'}}else if(!examMergeEle.prop('checked')){examMergeEle.prop('checked',true);$scope.mergeDefaultTooltip='Uncheck the box to not merge defaults for the selected category'}else{examMergeEle.prop('checked',false);$scope.mergeDefaultTooltip="Check the box to merge defaults for the selected category"}};$scope.selectedTrxId="-1";let checkChangeForTreatmentPlan=true;$scope.loadDropDown=function(){if($(templateId+" #endSummary").css('display')==='block'){return}if($scope.isInputChanges||checkChangeForTreatmentPlan&&checkForDataChangeInTreatmentPlan()||structureDataChange.size>0){$(templateId+" #switchSummary").css('display','block');$(templateId+" #sunohDropDown").removeClass('selection-options')}};$scope.dismissSwitchSummary=function(){$(templateId+" #switchSummary").hide()};$scope.allowSummarySelectChange=function(){$scope.isInputChanges=false;structureDataChange=new Set;$scope.dismissSwitchSummary();checkChangeForTreatmentPlan=false;$(templateId+" #sunohDropDown").addClass('selection-options');$(templateId+" .selection-click").click()};$scope.resetOrderScope=function(){$scope.gptAnalysis.diagnosis=[];$scope.masterDiagnosisArr=[];$scope.treatmentNotesDataArr=[];$scope.sunohAssessmentList=[];$scope.savedAssessments=[]};$scope.loadSelectedTransactions=function(txn,isTV,sunohStatusId){clearTimeout(sunohGlobal.checkTransalationStatusInterval);if(typeof structureDataWorker!=='undefined'&&structureDataWorker){structureDataWorker.getStDataResponse(null,null,null,true)}structureDataChange=new Set;showStructDisclaimer();$(templateId+" .assessmentLoader").removeClass("dnone");$(templateId+" .treatmentNotesLoader").removeClass("dnone");$scope.isTreatmentDataDisplay=false;$(templateId+" #sunohInlineDx").addClass("dnone");$(".summaryTab").trigger("click");if(txn===0){$http({url:makeURL("/mobiledoc/scribe/aci/get/conversationbyid?id="+0+"&isTV="+isTV+"&encId="+$scope.encounterId),method:'GET',dataType:'text'}).success(function(data){$scope.resetOrderScope();$scope.sunohSummaryId=data.sunohSummaryId;$scope.updateModels(data,false,isTV);$scope.loadSuggestedMedications();setTimeout(function(){$scope.adjustSectionsScrollHt()})})}if($scope.currentTransaction.id!=txn.id){$(templateId+" #tvConv .bubble").remove();$scope.conversationData=[];$scope.isRecover_summary=txn.isRecover;$scope.selectedTrxId=txn.id;$scope.currentTransaction=txn;$scope.isSecondaryLangExists=false;$scope.getAdditionContent(sunohStatusId);$http({url:makeURL("/mobiledoc/modules/webemr/sunoh/get/conversationbyid?id="+txn.id+"&isTV="+isTV+"&encId="+$scope.encounterId),method:'GET',dataType:'text'}).success(function(data){$scope.sunohRecordId=data.sunohstatusid;$scope.resetOrderScope();$scope.sunohSummaryId=data.sunohSummaryId;if(data.isRecover==="no"&&data.conversationData&&data.conversationData!=="Not Available"&&isTV!=1){$scope.getExistingConversationsAudio(data.sunohstatusid)}$scope.hasStData=data.hasStData;if($scope.isSunohStructDataEnabled==='yes'){if($scope.hasStData){$scope.getStDataResponse($scope.userId,data.sunohstatusid)}else{$scope.structuredSummary=[];$scope.renderComplete()}}$scope.sunohSecondaryLanguage=data.secondaryLanguage;$scope.updateModels(data,false,isTV);$scope.loadSuggestedMedications();setTimeout(function(){heightAdjusted=false;$scope.adjustSectionsScrollHt()})})}};let heightAdjusted=false;let resizeTimer;window.addEventListener("resize",()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(function(){heightAdjusted=false;$scope.adjustSectionsScrollHt()},250)});$scope.adjustSectionsScrollHt=function(){let tabHeight=0;if($scope.isSunohStructDataEnabled==='yes'){tabHeight=40}let excludeHt=11+$(templateId+' .sunoh-summary-date-section').outerHeight()+10+$(templateId+' .conversation-summary').outerHeight()+tabHeight+10+40;if($scope.conversationData==="Not Available"){excludeHt=excludeHt-15}$(templateId+' #sunohScribeACIModule .page-scroll').attr('style','height:'+($(templateId+' .right-transcript-section').outerHeight()-excludeHt)+'px !important');if(!heightAdjusted){if(!$scope.isSecondaryLangExists){$(templateId+' #sunohScribeACIModule .trasncription-section').removeAttr('style');let h1=$(templateId+' #sunohScribeACIModule .trasncription-section').outerHeight()+33;if($scope.isRecover_summary==='yes'){h1+=78}$(templateId+' #sunohScribeACIModule .trasncription-section').attr('style','height:'+h1+'px !important');heightAdjusted=true}else if($scope.isSecondaryLangExists&&$scope.isRecover_summary==='yes'){$(templateId+' #sunohScribeACIModule .trasncription-section').removeAttr('style');let h2=$(templateId+' #sunohScribeACIModule .trasncription-section').outerHeight()+78;$(templateId+' #sunohScribeACIModule .trasncription-section').attr('style','height:'+h2+'px !important');heightAdjusted=true}}};function sortRecordingByDate(a,b){return new Date(a.createddate).getTime()-new Date(b.createddate).getTime()}function processTVData(data){if(data&&data['tvResponse']&&data['tvResponse']['transactions']&&data['tvResponse']['transactions'].length>0){data['transactions']=data['transactions'].concat(data['tvResponse']['transactions']);data['transactions'].sort(sortRecordingByDate)}return data}function setUserOutOfPN(isOutPN){$scope.isOutSideTVPN=isOutPN}$scope.loadOlderConversation=function(allTxn,isTV){if(isTV+''==='true'){isTV=1}else{isTV=0}$http({url:makeURL("/mobiledoc/modules/webemr/sunoh/get/conversation?encId="+$scope.encounterId+"&isTV="+isTV),method:'GET',dataType:'text'}).success(function(data){if(isTV){data=processTVData(data)}if(data.encDxList){$scope.encDxList=data.encDxList}if(data.providerLanguageId===0&&data.patientLanguage&&data.patientLanguage!==""){let langJson=JSON.parse(data.patientLanguage);let patientLangJSON=langJson.selectedLang;$scope.preferLangJSON=patientLangJSON;$scope.isPreferedSelectionExist=true;$scope.preferLang=patientLangJSON.language;$scope.preferLangRegion=patientLangJSON.languageRegion;$scope.preferLangCode=patientLangJSON.languageCode}else if(data.providerLanguageId!==0){for(let language in $scope.sunohLanguages){let defaultProviderLangDialet=sunohGlobal.sunohLanguages[language].filter(x=>x.languageId==data.providerLanguageId);if(defaultProviderLangDialet&&defaultProviderLangDialet.length>0){$scope.providerDefaultLang=language;$scope.providerDefaultLangCode=defaultProviderLangDialet[0].languageCode;$scope.sessionLanguage=$scope.providerDefaultLangCode;$scope.languageRegion=defaultProviderLangDialet[0].languageRegion;break}}}$scope.isScribeActive=data.isScribeActive;$scope.isEncLocked=data.isEncLocked;$scope.generateNotesAllow=$scope.isScribeActive===true&&$scope.isEncLocked===false;$scope.isSpeechEnabled=data.isSpeechEnabled;if(!$scope.isScribeActive){$scope.scribeDisableMsg='Please contact your administrator to activate and setup scribe for the appointment provider in order to generate the Sunoh note.';$scope.sunohAssistantDisableMsg='Please contact your administrator to activate and setup scribe for the appointment provider in order to access the Sunoh Assistant.'}else{if($scope.isEncLocked){$scope.scribeDisableMsg='Sunoh note cannot be generated as the progress note is currently locked. Please unlock your progress note to proceed.';$scope.sunohAssistantDisableMsg='Sunoh Assistant cannot be accessed as the progress note is currently locked. Please unlock your progress note to proceed.'}else{$scope.scribeDisableMsg='';$scope.sunohAssistantDisableMsg=''}}isProviderSignatureRegistered=data.isProviderSignatureRegistered?data.isProviderSignatureRegistered:false;providerSignatureData=data.providerSignatureData?data.providerSignatureData:"";encryptedProviderId=data.encryptedProviderId?data.encryptedProviderId:"";$scope.updateModels(data,allTxn,isTV)}).error(function(data){sunohGlobal.log(data)})};$scope.getRetainNoteForSunoh=function(fullRetainNote){$(templateId+" #retainNoteSunohTextArea").val(fullRetainNote);$scope.strechingTextArea();$scope.jumpToEle('scribeTextArea')};$scope.getPreviousNote=function(){let response=urlPost('/mobiledoc/scribe/operation/unsavedNotes',"ptId="+$scope.patientId+"&pnencid="+$scope.encounterId);$(templateId+' #retainNoteSunohTextArea').val(response.trim())};$scope.pnSectionClicked=function(section){let pnControllerScope=angular.element(document.getElementById('pnController')).scope();pnControllerScope.loadProgressNotePopup(section)};$scope.feedback=-1;$scope.isRecover_summary="no";$scope.isDefaultCategorySet=false;$scope.checkTypeOfConversationDataIsObjectWithData=function(){return typeof $scope.conversationData==='object'&&$scope.conversationData.length>0};var addDynamicContent=function(placeHolder,url,type,catId){var inlineEditResponse=urlGet(makeURL(url));$(placeHolder).html(inlineEditResponse);$compile($(placeHolder))($scope)};$scope.isSpeakerIdProvider=function(speakerId){return speakerId==='Guest-1'||speakerId==='provider'||speakerId==='staff'};let gptSuggestedTreatmentPlan=[];$scope.updateModels=function(data,allTxn,isTV){resetSunohAssistantScope();if($scope.type==="widget"&&allTxn){$(templateId+' #playSection').removeClass('dnone')}$scope.gptAnalysisDone=true;if(allTxn){$scope.isSignatureRegistered=data.isSignatureRegistered;if(data.isSignatureRegistered===false&&$scope.type==="widget"){$scope.sunohSpeechModelFn();return}else{if($scope.type==="widget"){$(templateId+' .sumoh-summarize').addClass('dnone');$(templateId+" .play-section").removeClass("dnone");$(templateId+' #playSection').removeClass('dnone').animate({},100,function(){$(this).position({of:$('.sunoh-widget-btn'),my:'center bottom-30',at:'center bottom',collision:"flipfit"}).animate({"opacity":1},100);let top=$(templateId+' #playSection').css('top');let left=$(templateId+' #playSection').css('left');$scope.updateTopPosForAlert();$(templateId+' #viewSummary').css({'top':top,'left':left});$(templateId+' #summaryGenerated').css({'top':top,'left':left})})}else{setTimeout(function(){$(templateId+' .sumoh-summarize').removeClass('dnone').animate({},100,function(){$(this).position({of:$('#sunoh-summary-click'),my:'right bottom-40',at:'right bottom',collision:"flipfit"}).animate({"opacity":1},100)})})}$scope.signatureData=data.signatureData}}if(data.txnUserId){$scope.txnUserId=data.txnUserId}if(isTV&&isTV===1){$scope.isTVSummary=true}else{$scope.isTVSummary=false}if(data&&data.importData){$scope.stDataimportLog=JSON.parse(data.importData)}if(data.transactions&&data.transactions.length>0){if(isTV===1){for(let index in data.transactions){if(data.transactions.hasOwnProperty(index)){if(data.transactions[index]['isTV']===1){data.transactions[index]['conversationduration']=$scope.getTimeFormatOf(data.transactions[index]['conversationduration'])}}}}$scope.transactions=data.transactions;$scope.currentTransaction=$scope.transactions[0];$scope.txnUserId=$scope.currentTransaction.txnUserId;$scope.updateImportdataScopes(data.importData);if(data.defaultCategorySections){$scope.isHpiDefaultSet=data.defaultCategorySections.hpiDefaultCatId>0;$scope.isExamDefaultSet=data.defaultCategorySections.examDefaultCatId>0}if(data.hiddenSections&&data.hiddenSections.length>0){const hiddenSections=new Set(data.hiddenSections);$scope.isHpiHidden=hiddenSections.has("HPI");$scope.isVitalHidden=hiddenSections.has("Vitals");$scope.isExamHidden=hiddenSections.has("Examination");$scope.isMedHxHidden=hiddenSections.has("Allergies");$scope.isSocialHxHidden=hiddenSections.has("SocialHistory");$scope.iFamilyHxHidden=hiddenSections.has("FamilyHistory");$scope.iHospitalizationHidden=hiddenSections.has("Hospitalization");$scope.iBillingHidden=hiddenSections.has("Billing");$scope.isTreatmentNoteHidden=hiddenSections.has("Treatment");$scope.isVitasHidden=hiddenSections.has("Vitals");$scope.isPreventiveMedHidden=hiddenSections.has("PreventiveMedicine")}}if(data.createddate){$scope.currentTransaction={createddate:data.createddate,conversationduration:isTV===0?data.conversationduration:$scope.getTimeFormatOf(data['conversationduration']),userName:data.userName}}if(data.isDefaultCategorySet){$scope.isDefaultCategorySet=data.isDefaultCategorySet}if(typeof data.feedback!=='undefined'){$scope.feedback=data.feedback;if(isTV&&isTV===1){$scope.isFeedbackSumitted=true}}if(typeof data.isRecover!=='undefined'){$scope.isRecover_summary=data.isRecover}if(!$(templateId+' .search-transcript-modal').hasClass('dnone')){try{$scope.conversationData=JSON.parse(data.conversationData)}catch(e){$scope.conversationData=data.conversationData}if(!$scope.conversationData[0].translatedText){$scope.sunohLangError=true}else{$scope.isSecondaryLangExists=true;$scope.sunohLangError=false}}if(data.summary&&data.summary.length>0){$scope.summaryFromDb=data.summary;let sum_data={};try{sum_data=JSON.parse(data.summary)}catch(e){sum_data=data.summary;$scope.gptAnalysis['HPI']="Unable to generate a summary as the provided transcript is incomplete and does not contain any relevant medical history or treatment plan."}$scope.gptAnalysis['summary']=sum_data.summary;let bloodSugar='';let painScale='';if(sum_data.vitals&&sum_data.vitals.blood_sugar_level!==undefined&&sum_data.vitals.blood_sugar_level!==''&&sum_data.vitals.blood_sugar_level!=='Not discussed'){bloodSugar=" Blood Sugar Level is "+sum_data.vitals.blood_sugar_level+"."}if(sum_data.vitals&&sum_data.vitals["Pain Scale"]!==undefined&&sum_data.vitals["Pain Scale"]!==''&&sum_data.vitals["Pain Scale"]!=='Not discussed'){painScale=" Pain Scale is "+sum_data.vitals["Pain Scale"]+"."}if(Array.isArray(sum_data.history_of_present_illness)){let hpidata=Array.from(sum_data.history_of_present_illness).join(' ')+bloodSugar+painScale;$scope.gptAnalysis['HPI']=hpidata}else if(typeof sum_data.history_of_present_illness==='string'){$scope.gptAnalysis['HPI']=sum_data.history_of_present_illness+bloodSugar+painScale}$scope.gptAnalysis['HPI_Short']=sum_data.history_of_present_illness_short+bloodSugar+painScale;$scope.hpiSummary='';$scope.examSummary='';$scope.familyHxSummary='';$scope.medicalHxSummary='';$scope.socialHxSummary='';$scope.treatmentNoteSummary='';$scope.surgicalHxSummary='';$scope.hospitalizationSummary='';$scope.followupSummary='';$scope.sunohRxPatientVitals={weight:'',height:''};$scope.hpiSummary=$scope.gptAnalysis['HPI'];$scope.getPreviousNote();$scope.getCategories();if(sum_data.vitals){let vitalsObj=[];if(validateVital(sum_data.vitals.blood_pressure)){vitalsObj.push("Blood Pressure: "+sum_data.vitals.blood_pressure)}if(validateVital(sum_data.vitals.oxygen_saturation)){vitalsObj.push("Oxygen Saturation: "+sum_data.vitals.oxygen_saturation)}if(validateVital(sum_data.vitals.height)){if(/^\d+$/.test(sum_data.vitals.height)){sum_data.vitals.height+=" inches"}vitalsObj.push("Height: "+sum_data.vitals.height);$scope.sunohRxPatientVitals.height=sum_data.vitals.height}if(validateVital(sum_data.vitals.weight)){let re=/(\d+(\.\d+)?)\s*(\w*)/i;let match=sum_data.vitals.weight.match(re);var weightVal;if(match){let value=match[1];let unit=match[3];if(unit!=="lbs"){weightVal=value+" lbs"}else{weightVal=value+" "+unit}}else if(/^\d+(\.\d+)?$/.test(sum_data.vitals.weight)){weightVal=sum_data.vitals.weight+" lbs"}vitalsObj.push("Weight: "+weightVal);$scope.sunohRxPatientVitals.weight=weightVal}if(validateVital(sum_data.vitals.heart_rate)){vitalsObj.push("Heart Rate: "+sum_data.vitals.heart_rate)}if(validateVital(sum_data.vitals.temperature)){var tempVal=parseFloat(sum_data.vitals.temperature)+' F';vitalsObj.push("Temperature: "+tempVal)}if(validateVital(sum_data.vitals.respiratory_rate)){vitalsObj.push("Respiratory Rate: "+sum_data.vitals.respiratory_rate)}$scope.gptAnalysis['vitalsData']=Array.from(vitalsObj).join(', ');$scope.vitalsSummary=$scope.gptAnalysis.vitalsData}if(sum_data.conversation_temperature&&Object.entries(sum_data.conversation_temperature).length>0){let toneObj=[];if(sum_data.conversation_temperature.active_listening!==''){toneObj.push(sum_data.conversation_temperature.active_listening.split("-")[0])}if(sum_data.conversation_temperature.clarity!==''){toneObj.push(sum_data.conversation_temperature.clarity.split("-")[0])}if(sum_data.conversation_temperature.responsiveness!==''){toneObj.push(sum_data.conversation_temperature.responsiveness.split("-")[0])}$scope.gptAnalysis['conversationTempData']=toneObj;$scope.conversationTemp=$scope.gptAnalysis.conversationTempData}if(typeof sum_data.social_history==="object"){$scope.gptAnalysis['socialHx']=$scope.recursiveObjects(sum_data.social_history)}else{$scope.gptAnalysis['socialHx']=sum_data.social_history}if(data.gptSuggestedTreatmentPlan){gptSuggestedTreatmentPlan=data.gptSuggestedTreatmentPlan}$scope.gptAnalysis['treatmentNote']=sum_data.treatment_plan;$scope.treatmentNotesMap=new Map;for(let i=0;i<$scope.gptAnalysis['treatmentNote'].length;i++){var parts=$scope.gptAnalysis['treatmentNote'][i].split(' - ');$scope.treatmentNotesMap.set(parts[0].trim(),parts[2].trim())}$scope.savedTreatmentNotes=[];if($scope.sunohSummaryId!==''){$http({method:"GET",url:makeURL('/mobiledoc/modules/webemr/sunoh/get/order/treatmentplan'),params:{id:$scope.sunohSummaryId}}).success(function(response){angular.forEach(response,function(obj){obj.value=JSON.parse(obj.value);obj.notesArr=[];if(obj.value.notes){let notes='['+obj.value.notes+']';obj.notesArr=JSON.parse(notes);for(let i=0;i<obj.notesArr.length;i++){obj.notesArr[i].tooltip='Treatment plan merged by '+obj.notesArr[i].userFullName+' on '+$scope.formatDate(new Date(obj.notesArr[i].createdDate))}}obj.isSaved=true;obj.type='treatmentplan';$scope.savedTreatmentNotes.push(obj)})}).error(function(response){notification.show('error','','Treatment plans not able to load.',4e3)})}$scope.socialHxSummary=$scope.gptAnalysis['socialHx'];$scope.treatmentNoteSummary=$scope.gptAnalysis['treatmentNote'];if(typeof sum_data.medical_history==="object"){$scope.gptAnalysis['medicalHx']=$scope.recursiveObjects(sum_data.medical_history)}else{$scope.gptAnalysis['medicalHx']=sum_data.medical_history}$scope.medicalHxSummary=$scope.gptAnalysis['medicalHx'];if(typeof sum_data.examination==="object"){$scope.gptAnalysis.exam=$scope.recursiveObjects(sum_data.examination)}else{$scope.gptAnalysis.exam=sum_data.examination}$scope.examSummary=$scope.gptAnalysis.exam;if(typeof sum_data.family_history==="object"){$scope.gptAnalysis['familyHx']=$scope.recursiveObjects(sum_data.family_history)}else{$scope.gptAnalysis['familyHx']=sum_data.family_history}$scope.familyHxSummary=$scope.gptAnalysis['familyHx'];if(typeof sum_data.surgical_history==="object"){if(sum_data.surgical_history.length>0){$scope.gptAnalysis['surgicalHx']=$scope.recursiveObjects(sum_data.surgical_history)}else{$scope.gptAnalysis['surgicalHx']=""}}else if(sum_data.surgical_history===undefined){$scope.gptAnalysis['surgicalHx']=""}else{$scope.gptAnalysis['surgicalHx']=sum_data.surgical_history}$scope.surgicalHxSummary=$scope.gptAnalysis['surgicalHx'];if(typeof sum_data.hospitalization_history==="object"){if(sum_data.hospitalization_history.length>0){$scope.gptAnalysis['hospitalization']=$scope.recursiveObjects(sum_data.hospitalization_history)}else{$scope.gptAnalysis['hospitalization']=""}}else if(sum_data.hospitalization_history===undefined){$scope.gptAnalysis['hospitalization']=""}else{$scope.gptAnalysis['hospitalization']=sum_data.hospitalization_history}$scope.hospitalizationSummary=$scope.gptAnalysis['hospitalization'];if(sum_data.diagnosis===undefined||sum_data.diagnosis==="Not discussed"){$scope.gptAnalysis.diagnosis=[]}else{$scope.gptAnalysis.diagnosis=[];for(let i=0;i<sum_data.diagnosis.length;i++){let summary_dx=sum_data.diagnosis[i].split(",");for(let j=0;j<summary_dx.length;j++){if(summary_dx[j].trim().length>0){let dxReg=summary_dx[j].trim().replace(/^['"]|['"]$/g,'').trim();$scope.gptAnalysis.diagnosis.push(dxReg)}}}}$scope.treatmentNotesDataArr=[];if(sum_data.diagnosis===undefined||sum_data.diagnosis==="Not discussed"){$scope.resetOrderScope()}else{$(templateId+" .assessmentLoader").removeClass("dnone");$(templateId+" .treatmentNotesLoader").removeClass("dnone");$(templateId+" #sunohInlineDx").addClass("dnone");$scope.gptAnalysis.diagnosis=[];$scope.masterDiagnosisArr=[];var diagnosisList=[];$scope.gptAnalysis.diagnosis=[];for(let i=0;i<sum_data.diagnosis.length;i++){if(sum_data.diagnosis[i].length>0){let summary_dx=sum_data.diagnosis[i].split(/-\s(.+)/)[0].trim();if(summary_dx.length>0){diagnosisList.push(summary_dx)}}}}if(sum_data.referral===undefined||typeof sum_data.referral==='string'){$scope.gptAnalysis.referral=[]}else{$scope.gptAnalysis.referral=sum_data.referral}$scope.getSavedAssessmentList();if(diagnosisList.length===0&&$scope.sunohSummaryId!==''){angular.forEach($scope.savedTreatmentNotes,function(obj){let data=$scope.treatmentNotesDataArr.find(item=>obj.value.itemId!==0&&item.value.itemId===obj.value.itemId);if(data){data.isSaved=true;data.notesArr=angular.copy(obj.notesArr)}else{$scope.treatmentNotesDataArr.push(angular.copy(obj))}});$scope.setNAOtherValueForTreatmentObject();setNotesToNAOtherIfAssessmentIsDeletedFromPN();$ocLazyLoad.load({name:'assessment',files:['/mobiledoc/jsp/webemr/progressnotes/billing/assessmentNotes-tpl.js','/mobiledoc/jsp/webemr/progressnotes/assessment/assessmentcontroller.js']}).then(function(){placeHolder="#inlineAsmtURL";url="/mobiledoc/jsp/webemr/progressnotes/templates/inlineassessment.jsp?encounterId="+$scope.encounterId+"&patientId="+$scope.patientId+"&sunohContext=yes&dc="+moment().toString();$(templateId+" #sunohInlineDx").removeClass("dnone");addDynamicContent(templateId+" #sunohInlineDx",url,"Assessment:")})}if(diagnosisList.length>0&&$scope.sunohSummaryId!==''){let payload={diagnosisSearchWord:JSON.stringify(diagnosisList),patientId:$scope.patientId,summaryId:$scope.sunohSummaryId};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/getMatchDiagnosis'),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){let isSmartSearchSetToDefault=response.isSmartSearchSetToDefault;let diagnosisResultList=response.diagnosisResultList;for(var i=0;i<diagnosisResultList.length;i++){if(diagnosisResultList[i].value!==''){diagnosisResultList[i].value=JSON.parse(diagnosisResultList[i].value)}$scope.gptAnalysis.diagnosis.push(diagnosisResultList[i])}if(isSmartSearchSetToDefault==="1"){$scope.getFirstAssessmentFromSearch($scope.gptAnalysis.diagnosis)}else{angular.forEach($scope.savedTreatmentNotes,function(obj){let data=$scope.treatmentNotesDataArr.find(item=>obj.value.itemId!==0&&item.value.itemId===obj.value.itemId||item.value.name===obj.value.name&&(!item.value.ICD10&&item.value.code===obj.value.code||item.value.ICD10&&item.value.ICD10===obj.value.code));if(data){data.isSaved=true;data.notesArr=angular.copy(obj.notesArr)}else{$scope.treatmentNotesDataArr.push(angular.copy(obj))}});$scope.updateTreatmentPlansArr();angular.forEach($scope.gptAnalysis.diagnosis,function(value){if(!$scope.encDxList.find(item=>item.dxItemName===value.value.name)){value.isSaved=false}else{value.isSaved=true}if(!$scope.masterDiagnosisArr.find(item=>item.key===value.key)){$scope.masterDiagnosisArr.push(angular.copy(value))}let valueObject=angular.copy(value);let index=$scope.treatmentNotesDataArr.findIndex(obj=>obj.key===valueObject.key||obj.value.name===valueObject.value.name&&valueObject.value.ICD10===obj.value.code);valueObject.isSaved=false;$scope.setNAOtherValueForTreatmentObject(valueObject);if(index>=0){let tObj=$scope.treatmentNotesDataArr[index];valueObject.isICDSaved=tObj.isICDSaved;valueObject.notesArr=tObj.notesArr;valueObject.itemid=tObj.itemid;if(valueObject.trash&&valueObject.type==='treatmentplan'){$scope.treatmentNotesDataArr[index]=angular.copy(valueObject);return}else{$scope.treatmentNotesDataArr[index].key=valueObject.key}}else{let index=$scope.savedAssessments.findIndex(obj=>obj.key===valueObject.key);if(index>=0){let data=$scope.treatmentNotesDataArr[index];data.trash=valueObject.trash;if(valueObject.trash){data.key=valueObject.key;data.value.trashNotes=valueObject.value.trashNotes}$scope.treatmentNotesDataArr[index]=angular.copy(data)}else{valueObject.notesArr=[];valueObject.isICDSaved=false;$scope.treatmentNotesDataArr.push(angular.copy(valueObject))}}});setNotesInTreatmentPlan();$scope.setNAOtherValueForTreatmentObject();setNotesToNAOtherIfAssessmentIsDeletedFromPN();$(templateId+" .treatmentNotesLoader").addClass("dnone");$scope.isTreatmentDataDisplay=true;manageAssessmentForOrders();$scope.strechingTextArea();$ocLazyLoad.load({name:'assessment',files:['/mobiledoc/jsp/webemr/progressnotes/billing/assessmentNotes-tpl.js','/mobiledoc/jsp/webemr/progressnotes/assessment/assessmentcontroller.js']}).then(function(){placeHolder="#inlineAsmtURL";url="/mobiledoc/jsp/webemr/progressnotes/templates/inlineassessment.jsp?encounterId="+$scope.encounterId+"&patientId="+$scope.patientId+"&sunohContext=yes&dc="+moment().toString();$(templateId+" #sunohInlineDx").removeClass("dnone");addDynamicContent(templateId+" #sunohInlineDx",url,"Assessment:");$(templateId+" .assessmentLoader").addClass("dnone")})}}).error(function(error){notification.show('error','','Assessment not able to load.',4e3)})}else{if($scope.sunohSummaryId!==''){$(templateId+" .assessmentLoader").addClass("dnone");$(templateId+" .treatmentNotesLoader").addClass("dnone");$(templateId+" #sunohInlineDx").removeClass("dnone");$scope.isTreatmentDataDisplay=true;$scope.strechingTextArea()}}let payloadForLabsDiProcedureOrders={patientId:$scope.patientId,encounterId:$scope.encounterId,summaryId:$scope.sunohSummaryId};if(sum_data.immunizations===undefined||typeof sum_data.immunizations==='string'){$scope.gptAnalysis.immunizations=[]}else{payloadForLabsDiProcedureOrders.immunizations=sum_data.immunizations;payloadForLabsDiProcedureOrders.legacy=true}if(sum_data.immunizations_list){payloadForLabsDiProcedureOrders.immunizations=sum_data.immunizations_list;payloadForLabsDiProcedureOrders.legacy=false}if(sum_data.referral===undefined||typeof sum_data.referral==='string'){$scope.gptAnalysis.referral=[]}else{payloadForLabsDiProcedureOrders.referral=sum_data.referral}if(sum_data.diagnostic_imaging_or_procedures===undefined||typeof sum_data.diagnostic_imaging_or_procedures==='string'){$scope.gptAnalysis.diagnostic_imaging_or_procedures=[]}else{payloadForLabsDiProcedureOrders.diagnostic_imaging_or_procedures=sum_data.diagnostic_imaging_or_procedures}if(sum_data.lab_tests===undefined||typeof sum_data.lab_tests==='string'){$scope.gptAnalysis.lab_tests=[]}else{payloadForLabsDiProcedureOrders.lab_tests=sum_data.lab_tests}if($scope.sunohSummaryId!==''){$scope.loadOrderSuggestions(payloadForLabsDiProcedureOrders)}if(sum_data.medications===undefined||typeof sum_data.medications==='string'){$scope.gptAnalysis.medications=[]}else{$scope.gptAnalysis.medications=sum_data.medications}if((sum_data.new_medications===undefined||typeof sum_data.new_medications==='string')&&$scope.gptAnalysis.medications.length===0){$scope.gptAnalysis.medications=[]}else if(sum_data.new_medications){$scope.gptAnalysis.medications=sum_data.new_medications}if(sum_data.existing_medications===undefined||typeof sum_data.existing_medications==='string'){$scope.gptAnalysis.existingMeds=[]}else{$scope.gptAnalysis.existingMeds=sum_data.existing_medications}if(typeof sum_data.allergies==='string'){$scope.gptAnalysis.allergies=[]}else{$scope.gptAnalysis.allergies=sum_data.allergies}if($scope.gptAnalysis.immunizations){for(let i=0;i<$scope.gptAnalysis.immunizations.length;i++){let med={};med.section="Immunizations";med.name=$scope.gptAnalysis.immunizations[i]}}if($scope.gptAnalysis.allergies){for(let i=0;i<$scope.gptAnalysis.allergies.length;i++){let allergy={};allergy.section="Allergies";allergy.name=$scope.gptAnalysis.allergies[i]}}if($scope.gptAnalysis.medications){for(let i=0;i<$scope.gptAnalysis.medications.length;i++){let med={};med.section="Medication";med.name=$scope.gptAnalysis.medications[i].name;med.formulation=$scope.gptAnalysis.medications[i].formulation;med.frequency=$scope.gptAnalysis.medications[i].frequency;med.reason=$scope.gptAnalysis.medications[i].reason}}$scope.updateActionsForOrders();$scope.gptAnalysis.follow_up_plan=sum_data.follow_up_plan;if($scope.gptAnalysis.follow_up_plan&&($scope.gptAnalysis.follow_up_plan.next_appointment||$scope.gptAnalysis.follow_up_plan.next_appointment=="")){$scope.gptAnalysis.follow_up_plan.text="";if($scope.gptAnalysis.follow_up_plan.next_appointment){$scope.gptAnalysis.follow_up_plan.text=$scope.gptAnalysis.follow_up_plan.next_appointment+"\n";if($scope.gptAnalysis.follow_up_plan.reason&&$scope.gptAnalysis.follow_up_plan.reason.length>0){$scope.gptAnalysis.follow_up_plan.text+='Reason: '+$scope.gptAnalysis.follow_up_plan.reason}}else{$scope.gptAnalysis.follow_up_plan.text=""}$scope.gptAnalysis.follow_up_plan.text=$scope.gptAnalysis.follow_up_plan.text.trim()}else if($scope.gptAnalysis.follow_up_plan&&$scope.gptAnalysis.follow_up_plan.next_appointment_date!=""){var date1=moment(encounterDate,"YYYY-MM-DD");var date2=moment($scope.gptAnalysis.follow_up_plan.next_appointment_date,"YYYY-MM-DD");var days=date2.diff(date1,"days");let period="";let years=Math.trunc(days/365);if(years>=1){period=years+" years ";days=days%365}let months=Math.trunc(days/30);if(months>=1){period+=months+" months ";days=days%30}let weeks=Math.trunc(days/7);if(weeks>=1){period+=weeks+" weeks ";days=days%7}if(days>=1){period+=days+" days"}$scope.gptAnalysis.follow_up_plan.text="";if(period.length>0){$scope.gptAnalysis.follow_up_plan.text="It was discussed that patient will schedule a follow up in "+period+"\n"}if($scope.gptAnalysis.follow_up_plan.reason&&$scope.gptAnalysis.follow_up_plan.reason.length>0){$scope.gptAnalysis.follow_up_plan.text=$scope.gptAnalysis.follow_up_plan.text+'Reason: '+$scope.gptAnalysis.follow_up_plan.reason}$scope.gptAnalysis.follow_up_plan.text=$scope.gptAnalysis.follow_up_plan.text.trim()}else{$scope.gptAnalysis.follow_up_plan={};$scope.gptAnalysis.follow_up_plan.text=""}$scope.followupSummary=$scope.gptAnalysis.follow_up_plan.text;$scope.gptAnalysis.action={};$scope.gptAnalysis.action.orderSuggested=false;$scope.gptAnalysis.action.orders=[];$scope.gptAnalysis.fields=sum_data.fields;if($scope.gptAnalysis.fields&&$scope.gptAnalysis.fields.medication_suggested){$scope.gptAnalysis.action.orderSuggested=true;$scope.gptAnalysis.action.orders=$scope.gptAnalysis.action.orders.concat($scope.gptAnalysis.fields.medications)}if($scope.gptAnalysis.fields&&$scope.gptAnalysis.fields.lab_suggested){$scope.gptAnalysis.action.orderSuggested=true;$scope.gptAnalysis.action.orders=$scope.gptAnalysis.action.orders.concat($scope.gptAnalysis.fields.labs)}let phraseContent='';if(sum_data.phrases&&sum_data.phrases.length>0){sum_data.phrases.forEach(value=>{if(value.length>0){phraseContent=phraseContent+"<li>"+value+"</li>"}})}if(phraseContent.length>0){$scope.isPhrasesAvailable=true;$scope.gptAnalysis['phrases']='<ul class="ml-20">'+phraseContent+'</ul>'}else{$scope.isPhrasesAvailable=false}setTimeout(function(){$(templateId+" #quickSunohQuickSearchLookup .quick-nav").addClass("col-sm-10").addClass("ml20").removeClass("mr2");$(templateId+" #quickSunohQuickSearchLookup input").trigger("blur");$(templateId+" .sunohSummary").scrollTop(0);if($(templateId+" #quickSunohQuickSearchLookup input").length>0){$(templateId)[0].querySelector("#quickSunohQuickSearchLookup input").addEventListener("click",function(){$scope.loadQSDxList();$scope.sunohOrders=true;setTimeout(function(){$(templateId+" .sunohSummary").scrollTop(0)})})}if($(templateId+" #quickSunohQuickSearchLookup .new-icon-referral").length>0){$(templateId)[0].querySelector("#quickSunohQuickSearchLookup .new-icon-referral").addEventListener("click",function(){$scope.sunohOrders=true;setTimeout(function(){$(templateId+" .sunohSummary").scrollTop(0)})})}},1e3);setTimeout(function(){if($(templateId+" #sunohShowSuggestion #txtICDDescr").length>0){$(templateId)[0].querySelector("#sunohShowSuggestion #txtICDDescr").addEventListener("click",function(){$scope.sunohAssessments=true;setTimeout(function(){$(templateId+" .sunohSummary").scrollTop(0)})})}},2e3)}$(templateId+" .sunohSummary .purple-textarea").attr("placeholder","Not discussed. Type/dictate here to input notes");$scope.strechingTextArea()};let setNotesInTreatmentPlan=function(){angular.forEach($scope.masterDiagnosisArr,function(obj){if($scope.treatmentNotesMap.has(obj.key)){var treatmentVal=$scope.treatmentNotesMap.get(obj.key);obj.value.notes=treatmentVal}});angular.forEach($scope.treatmentNotesDataArr,function(obj){if($scope.treatmentNotesMap.has(obj.key)){var treatmentVal=$scope.treatmentNotesMap.get(obj.key);obj.gptNotes=treatmentVal}});angular.forEach($scope.treatmentNotesDataArr,function(dx){let obj=gptSuggestedTreatmentPlan.find(obj=>dx.key===obj.diagnosis);if(obj){dx.gptNotes=obj.notes;dx.isAccepted=obj.isAccepted}else{dx.isAccepted=true}if(dx.isAccepted){dx.gptNotes=""}})};$scope.updateActionsForOrders=function(){if(!$scope.isSunohStandalone&&$scope.gptAnalysis.lab_tests){for(let i=0;i<$scope.gptAnalysis.lab_tests.length;i++){let lab={};lab.section="Labs";lab.name=$scope.gptAnalysis.lab_tests[i].name;lab.result=$scope.gptAnalysis.lab_tests[i].result}}if(!$scope.isSunohStandalone&&$scope.gptAnalysis.diagnostic_imaging_or_procedures){for(let i=0;i<$scope.gptAnalysis.diagnostic_imaging_or_procedures.length;i++){let med={};med.section="Di Procedures";med.name=$scope.gptAnalysis.diagnostic_imaging_or_procedures[i].name}}if(!$scope.isSunohStandalone&&$scope.gptAnalysis.referral){for(let i=0;i<$scope.gptAnalysis.referral.length;i++){let referral={};referral.section="Referral";referral.name=$scope.gptAnalysis.referral[i].referred_doctor_name;referral.speciality=$scope.gptAnalysis.referral[i].referral_speciality}}if(!$scope.isSunohStandalone&&$scope.gptAnalysis.lab_tests){for(let i=0;i<$scope.gptAnalysis.lab_tests.length;i++){let lab={};lab.section="Labs";lab.name=$scope.gptAnalysis.lab_tests[i].name;lab.result=$scope.gptAnalysis.lab_tests[i].result}}if(!$scope.isSunohStandalone&&$scope.gptAnalysis.diagnostic_imaging_or_procedures){for(let i=0;i<$scope.gptAnalysis.diagnostic_imaging_or_procedures.length;i++){let med={};med.section="Di Procedures";med.name=$scope.gptAnalysis.diagnostic_imaging_or_procedures[i].name}}if(!$scope.isSunohStandalone&&$scope.gptAnalysis.immunizations){for(let i=0;i<$scope.gptAnalysis.immunizations.length;i++){let med={};med.section="Immunizations";med.name=$scope.gptAnalysis.immunizations[i]}}if(!$scope.isSunohStandalone&&$scope.gptAnalysis.referral){for(let i=0;i<$scope.gptAnalysis.referral.length;i++){let referral={};referral.section="Referral";referral.name=$scope.gptAnalysis.referral[i].referred_doctor_name;referral.speciality=$scope.gptAnalysis.referral[i].referral_speciality}}};$scope.objectSize=function(obj){if(typeof obj!=='undefined'){return Object.keys(obj).length}};function validateVital(val){if(val&&val!==""&&val.toLowerCase()!=="not discussed"&&val.toLowerCase()!=="na"){return true}return false}$scope.isOpenLabDiRefImmEditPopup=false;let closeOtherEditOptionPopupForOrders=function(orders){if(!orders||orders.length===0){return}orders.forEach(order=>{if(order.recommendedSuggesion)order.recommendedSuggesion.showEditOptionsPopover=false})};$scope.setIsOpenLabDiRefImmEditPopup=function(value){$scope.isOpenLabDiRefImmEditPopup=value};$scope.getIsOpenLabDiRefImmEditPopup=function(){return $scope.isOpenLabDiRefImmEditPopup};$scope.closeOtherEditOptionsPopup=function(){closeOtherEditOptionPopupForOrders($scope.gptAnalysis.lab_tests);closeOtherEditOptionPopupForOrders($scope.gptAnalysis.diagnostic_imaging_or_procedures);closeOtherEditOptionPopupForOrders($scope.gptAnalysis.immunizations);closeOtherEditOptionPopupForOrders($scope.gptAnalysis.referral);$scope.setDirtyFalg(false)};let addAssToSelectedDxIfFoundForHistoricalData=function(item,assObj,orderArray){if(!assObj){return}let labIndex=orderArray.findIndex(order=>order.recommendedSuggesion.itemId===item.itemId);if(labIndex>-1&&orderArray[labIndex].selectDxItems.length===0){assObj.source="historical";orderArray[labIndex].selectDxItems.push(assObj);if(assObj.isICDSaved){orderArray[labIndex].selectDx.push(item.assessmentId)}else{orderArray[labIndex].isAcceptEnable=false}}};$scope.addAssessmentForOtherOrdersIfRequired=function(assCodes){let otherItemIdList=[];if(!$scope.gptAnalysis.lab_tests&&!$scope.gptAnalysis.diagnostic_imaging_or_procedures){return}let otherLabItemList=[];let otherDIItemIdList=[];if($scope.gptAnalysis.lab_tests&&$scope.gptAnalysis.lab_tests.length>0){otherLabItemList=$scope.gptAnalysis.lab_tests.filter(order=>(!order.recommendedSuggesion.selectDx||order.recommendedSuggesion.selectDx.length===0)&&!order.reason&&!order.isOrdered)}if($scope.gptAnalysis.diagnostic_imaging_or_procedures&&$scope.gptAnalysis.diagnostic_imaging_or_procedures.length>0){otherDIItemIdList=$scope.gptAnalysis.diagnostic_imaging_or_procedures.filter(order=>(!order.recommendedSuggesion.selectDx||order.recommendedSuggesion.selectDx.length===0)&&!order.reason&&!order.isOrdered)}otherLabItemList.forEach(lab=>{if(lab.recommendedSuggesion.itemId)otherItemIdList.push(lab.recommendedSuggesion.itemId)});otherDIItemIdList.forEach(di=>{if(di.recommendedSuggesion.itemId)otherItemIdList.push(di.recommendedSuggesion.itemId)});if(!otherItemIdList||otherItemIdList.length==0){return}let payload={patientId:$scope.patientId,assessmentCodes:assCodes,orderItemIds:otherItemIdList};$http({method:"POST",url:makeURL('/mobiledoc/emr/labs.ecw/quickorder/get-past-match-orders-for-assessment'),data:payload}).then(response=>{if(response.data&&response.data.length>0){response.data.forEach(item=>{let assObj=$scope.treatmentNotesDataArr.find(ass=>_.trim(ass.value&&ass.value.code)===_.trim(item.assessmentCode));addAssToSelectedDxIfFoundForHistoricalData(item,assObj,$scope.gptAnalysis.lab_tests);addAssToSelectedDxIfFoundForHistoricalData(item,assObj,$scope.gptAnalysis.diagnostic_imaging_or_procedures)})}},e=>{notification.show('error','','Error while fetching historical lab orders data',4e3)})};let requestOrderRequestQueueCount=0;let showDxOrderLoaders=function(){$scope.isDxSummaryLoading=true};let hideDxOrderLoaders=function(){if(requestOrderRequestQueueCount===0){$scope.isDxSummaryLoading=false}};$scope.loadLabOrderSuggestions=function(payload){showDxOrderLoaders();let request={patientId:$scope.patientId,encounterId:$scope.encounterId,summaryId:$scope.sunohSummaryId,lab_tests:payload.lab_tests};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/getMatchLabsOrders'),data:request}).then(res=>{requestOrderRequestQueueCount--;hideDxOrderLoaders();let data=res.data;if(data.sunohDeletedItems){data.sunohDeletedItems.forEach(value=>{$scope.gptAnalysis.sunohDeletedItems.push(value)})}$scope.gptAnalysis.lab_tests=[];if(data.lab_tests){$scope.gptAnalysis.lab_tests=data.lab_tests;setOtherParamsForOrders($scope.gptAnalysis.lab_tests,[],[])}addDefaultDxForOrders($scope.gptAnalysis.lab_tests);$scope.updateActionsForOrders()},e=>{requestOrderRequestQueueCount--;hideDxOrderLoaders();notification.show('error','','Not able to load Labs.',4e3)})};$scope.loadDiOrProcedureOrderSuggestions=function(payload){showDxOrderLoaders();let request={patientId:$scope.patientId,encounterId:$scope.encounterId,summaryId:$scope.sunohSummaryId,diagnostic_imaging_or_procedures:payload.diagnostic_imaging_or_procedures};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/getMatchDIProceduresOrders'),data:request}).then(res=>{requestOrderRequestQueueCount--;hideDxOrderLoaders();let data=res.data;if(data.sunohDeletedItems){data.sunohDeletedItems.forEach(value=>{$scope.gptAnalysis.sunohDeletedItems.push(value)})}$scope.gptAnalysis.diagnostic_imaging_or_procedures=[];if(data.diagnostic_imaging_or_procedures){$scope.gptAnalysis.diagnostic_imaging_or_procedures=data.diagnostic_imaging_or_procedures;setOtherParamsForOrders($scope.gptAnalysis.diagnostic_imaging_or_procedures,[],[])}addDefaultDxForOrders($scope.gptAnalysis.diagnostic_imaging_or_procedures);$scope.updateActionsForOrders()},e=>{requestOrderRequestQueueCount--;hideDxOrderLoaders();notification.show('error','','Not able to load DI or Procedures.',4e3)})};$scope.loadImmunizationOrderSuggestions=function(payload){showDxOrderLoaders();$scope.encounterAllergies=[];let request={patientId:$scope.patientId,encounterId:$scope.encounterId,summaryId:$scope.sunohSummaryId,immunizations:payload.immunizations,legacy:payload.legacy};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/getMatchImmunizationOrders'),data:request}).then(res=>{requestOrderRequestQueueCount--;hideDxOrderLoaders();let data=res.data;if(data.sunohDeletedItems){data.sunohDeletedItems.forEach(value=>{$scope.gptAnalysis.sunohDeletedItems.push(value)})}$scope.gptAnalysis.immunizations=[];if(data.immunizations){$scope.gptAnalysis.immunizations=data.immunizations;setOtherParamsForOrders([],$scope.gptAnalysis.immunizations,[])}if(data.immunzitionStatusList){$scope.commonData.immunzitionStatusList=data.immunzitionStatusList}addDefaultDxForOrders($scope.gptAnalysis.immunizations);$scope.updateActionsForOrders()},e=>{requestOrderRequestQueueCount--;hideDxOrderLoaders();notification.show('error','','Not able to load Immunizations.',4e3)})};$scope.loadReferralOrderSuggestions=function(payload){showDxOrderLoaders();let request={patientId:$scope.patientId,encounterId:$scope.encounterId,summaryId:$scope.sunohSummaryId,referral:payload.referral};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/getMatchReferralsOrders'),data:request}).then(res=>{requestOrderRequestQueueCount--;hideDxOrderLoaders();let data=res.data;if(data.sunohDeletedItems){data.sunohDeletedItems.forEach(value=>{$scope.gptAnalysis.sunohDeletedItems.push(value)})}$scope.gptAnalysis.referral=[];if(data.referralPriorities){$scope.commonData.referralPriorities=data.referralPriorities}if(data.defaultAssignTo){$scope.commonData.defaultAssignTo=data.defaultAssignTo}if(data.referral){$scope.gptAnalysis.referral=data.referral;setOtherParamsForOrders([],[],$scope.gptAnalysis.referral)}addDefaultDxForOrders($scope.gptAnalysis.referral);$scope.updateActionsForOrders()},e=>{requestOrderRequestQueueCount--;hideDxOrderLoaders();notification.show('error','','Not able to load Referrals.',4e3)})};$scope.loadOrderSuggestions=function(payload){$scope.gptAnalysis.sunohDeletedItems=[];requestOrderRequestQueueCount=0;if(payload.lab_tests&&payload.lab_tests.length>0){requestOrderRequestQueueCount++;$scope.loadLabOrderSuggestions(payload)}if(payload.diagnostic_imaging_or_procedures&&payload.diagnostic_imaging_or_procedures.length>0){requestOrderRequestQueueCount++;$scope.loadDiOrProcedureOrderSuggestions(payload)}if(payload.immunizations&&payload.immunizations.length>0){requestOrderRequestQueueCount++;$scope.commonData={};$scope.loadImmunizationOrderSuggestions(payload)}if(payload.referral&&payload.referral.length>0){requestOrderRequestQueueCount++;if(!$scope.commonData){$scope.commonData={}}$scope.loadReferralOrderSuggestions(payload)}};$scope.strechingTextArea=function(callbackFn){setTimeout(function(){$(templateId+" .sunohAIData").each(function(){let ht=this.scrollHeight;if(this.id==="summarySunohTextArea"){ht+=3}this.setAttribute("style","height:"+ht+"px;overflow-y:hidden;")}).on("input",function(){this.style.height=0;let ht=this.scrollHeight;if(this.id==="summarySunohTextArea"){ht+=3}this.style.height=ht+"px"});if(callbackFn)callbackFn()},500)};$scope.getAudioFile=function(audioblob){$scope.audioFile=audioblob;if($scope.audioFile==null){notification.show('error','','This speech already register, kindly record and try again.',4e3);return}let file=new File([$scope.audioFile],"conversation.wav",{type:"audio/wav"});const audioPlayer=document.createElement("audio");audioPlayer.src=URL.createObjectURL($scope.audioFile);audioPlayer.onloadedmetadata=function(){let audioDuration=$scope.getTimeFormatOf(audioPlayer.duration);$scope.audioDuration=audioDuration;let formData=new FormData;formData.append("wavFile",file);formData.append("userId",$scope.userId);formData.append("encId",$scope.encounterId);formData.append("sunohRecordId",$scope.sunohRecordId);$scope.uploadAudio(formData)}};$scope.retryCount=0;$scope.uploadedAudio=false;$scope.audioFailed=false;$scope.uploadAudio=function(formData){$scope.uploadedAudio=false;$scope.audioFailed=false;$scope.retryCount++;$.ajax({url:makeURL("/mobiledoc/modules/webemr/sunoh/saveAudio"),type:'POST',mimeType:"multipart/form-data",contentType:false,cache:false,processData:false,data:formData,dataType:'text',success:function(response){$scope.uploadedAudio=true;$scope.audioFailed=false;sunohGlobal.log("Audio uploaded successfully")},error:function(xhr,textStatus,errorThrown){if($scope.retryCount<3){sunohGlobal.log("Upload failed, retrying... Attempt number: ",$scope.retryCount);$scope.uploadAudio(formData)}else{$scope.retryCount=0;sunohGlobal.log("Upload failed after retry attempts");$scope.audioFailed=true}}})};$scope.checkUploadAudioStatus=function(allTxn){if($scope.uploadedAudio){$scope.retryCount=0;sunohGlobal.log("Upload was successful")}else if($scope.audioFailed){$scope.retryCount=0;sunohGlobal.log("Upload failed after 2 attempts")}else{let checkUploadStatus=setInterval(function(){if($scope.uploadedAudio){$scope.retryCount=0;sunohGlobal.log("Upload was successful");$scope.cleanup();clearInterval(checkUploadStatus)}else if($scope.audioFailed){$scope.retryCount=0;sunohGlobal.log("Upload failed after 2 attempts");$scope.cleanup();clearInterval(checkUploadStatus)}},5e3)}};$scope.toggleSunohOrders=function(){$(templateId+" #quickSunohQuickSearchLookup #quickSearchDirective_sunohQuickOrder_Btn5").get(0).dispatchEvent(new Event("click"));$(templateId+" #quickSunohQuickSearchLookup #quickSearchDirective_sunohQuickOrder_Btn1").trigger("click");introJs().exit();stopSunohObserve();$scope.isExitFromPlay=true;$scope.sunohOrders=!$scope.sunohOrders;setTimeout(function(){const topPos=$(templateId+" #action_orders")[0].offsetTop;$(templateId+" .page-scroll").scrollTop(topPos)},100);$scope.refreshProgressNote()};$scope.refreshImmAllergies=function(){$scope.$broadcast('refreshSunohEncAllergies')};$scope.toggleSunohAssessments=function(){myScribePanelSharedService.assessmentsSearchResults=[];myScribePanelSharedService.isMoreAsmtPresentinRSP=false;$scope.sunohAssessments=!$scope.sunohAssessments;$scope.isExitFromPlay=true;introJs().exit();stopSunohObserve();$(templateId+" #sunohScribeACIModule #asmtSearch").val("");setTimeout(function(){const topPos=$(templateId+" #sunohAssessmentSec")[0].offsetTop;$(templateId+" .page-scroll").scrollTop(topPos)},100);$scope.refreshProgressNote()};$scope.importAllergy=function(){$(templateId+" .sunohicons-maximize").trigger("click");if(window.navigator.userAgent.indexOf("Mac")>0){$(document.querySelectorAll('[title="âŒ¥ + QA"]')[0]).trigger("click")}else{$(document.querySelectorAll('[title="ALT + QA"]')[0]).trigger("click")}var existCondition=setInterval(function(){if($('#div-medhx-allergies').length){console.log("Exists!");clearInterval(existCondition);let intro=introJs().setOptions({disableInteraction:false,showStepNumbers:true,showDynamicElement:true,showBullets:false,exitOnOverlayClick:false,stepNumbersOfLabel:'/',keyboardNavigation:true,doneLabel:'Finish',skipLabel:'Skip',nextLabel:"Next Allregen",prevLabel:"Previous Allergen"}).onbeforechange(function(){$("#sunoh_allergen_table tr").removeClass("active")}).onafterchange(function(e,a,b){let currentStep=this._currentStep;setTimeout(function(){var input=$('#AllergyDrugRxNotes1');input.val($scope.gptAnalysis.allergies[currentStep].allergen_name);input.trigger('input');input.trigger('change');input.trigger('keyup');$("#sunoh_allergen_"+currentStep).addClass("active");let top=parseInt($(".introjs-helperLayer").css("top").split("px")[0])+45;$(".introjs-helperLayer").css("top",top+'px');let height=parseInt($(".introjs-helperLayer").css("height").split("px")[0])-50;$(".introjs-helperLayer").css("height",height+'px');let tooltip_top=parseInt($(".introjs-fixedTooltip").css("top").split("px")[0])+45;$(".introjs-fixedTooltip").css("top",tooltip_top+'px')},1e3)}).onchange(function(){}).onexit(function(){stopSunohObserve();$("#pnModalBtn1").trigger("click");$(".sunohicons-minimize").trigger("click");$scope.removeActionPreventionForAllergyPlay()});let table="<table class='table simpleTable' id='sunoh_allergen_table'><tr><th>No</th><th>Allergen</th><th>Reaction</th>";for(let i=0;i<$scope.gptAnalysis.allergies.length;i++){let count=i+1;let id="sunoh_allergen_"+i;table+=`<tr id='${id}'><td>${count}</td><td>${$scope.gptAnalysis.allergies[i].allergen_name}</td><td>${$scope.gptAnalysis.allergies[i].reaction}</td></tr>`}table+="</table>";for(let i=0;i<$scope.gptAnalysis.allergies.length;i++){intro.addStep({title:'Sunoh - Allergy',element:document.getElementById('div-medhx-allergies'),intro:table,position:'right'})}$("#div-medhx-allergies-expand").trigger("click");$("#mainPNDialog").addClass("sunohMainPnDialogWidth");$scope.addActionPreventionForAllergyPlay();setTimeout(function(){intro.start()},1e3);let customIds=["#othersection"];$scope.addMutatioObserverListener(customIds)}},100)};$scope.addActionPreventionForAllergyPlay=function(){$('#smart-panel').addClass("sunohPointerEventNone");$("#medhx-header").addClass("sunohPointerEventNone");$('#headerUl1').addClass("sunohPointerEventNone");$('.iconlist').addClass("sunohPointerEventNone");$('#div-medhx-history').addClass("sunohPointerEventNone");$("#div-medhx-allergies-expand").addClass("hide");$("#medicalhistoryBtn12").addClass("sunohPointerEventNone");$("#medicalhistoryBtn15").addClass("sunohPointerEventNone")};$scope.removeActionPreventionForAllergyPlay=function(){$("#smart-panel").removeClass("sunohPointerEventNone");$("#medhx-header").removeClass("sunohPointerEventNone");$('#headerUl1').removeClass("sunohPointerEventNone");$('.iconlist').removeClass("sunohPointerEventNone");$('#div-medhx-history').removeClass("sunohPointerEventNone");$("#div-medhx-allergies-expand").removeClass("hide");$("#medicalhistoryBtn12").removeClass("sunohPointerEventNone");$("#medicalhistoryBtn15").removeClass("sunohPointerEventNone");$("#mainPNDialog").removeClass("sunohMainPnDialogWidth")};$scope.playOrders=function(options){$scope.loadQSDxList();$scope.sunohOrders=true;let selectedOrderObj=[];let title="Sunoh";switch(options){case"labs":selectedOrderObj=$scope.gptAnalysis.lab_tests;title="Sunoh â€“ Lab Orders";break;case"medications":selectedOrderObj=$scope.gptAnalysis.medications;title="Sunoh â€“ Rx Orders";break;case"existingMeds":selectedOrderObj=$scope.gptAnalysis.existingMeds;title="Sunoh â€“ Rx Orders";break;case"diproc":selectedOrderObj=$scope.gptAnalysis.diagnostic_imaging_or_procedures;title="Sunoh â€“ DI/Procedure Orders";break;case"immunizations":selectedOrderObj=$scope.gptAnalysis.immunizations;title="Sunoh â€“ Immunizations Orders";break;default:}setTimeout(function(){let intro=introJs().setOptions({disableInteraction:false,showStepNumbers:true,showDynamicElement:true,showBullets:false,exitOnOverlayClick:false,stepNumbersOfLabel:'/',keyboardNavigation:true,doneLabel:'Finish',skipLabel:'Skip',nextLabel:"Next Order",prevLabel:"Previous Order"}).onbeforechange(function(){$("#sunoh_orders_table tr").removeClass("active");let introItem=this._introItems[this._currentStep]}).onafterchange(function(e,a,b){let currentStep=this._currentStep;setTimeout(function(){var input=$($(templateId)[0].querySelectorAll('#quickSunohQuickSearchLookup [placeholder="Quick Order"]')[0]);let orderName="";if(selectedOrderObj[currentStep].name){orderName=selectedOrderObj[currentStep].name}else{orderName=selectedOrderObj[currentStep]}input.val(orderName);input.trigger('input');input.trigger('change');input.trigger('keyup');$("#sunoh_orders_"+currentStep).addClass("active")},1e3)}).onexit(function(){$scope.toggleSunohOrders()});let table="<table class='table simpleTable' id='sunoh_orders_table'><tr><th>No</th><th>Orders</th>";for(let i=0;i<selectedOrderObj.length;i++){let count=i+1;let id="sunoh_orders_"+i;let orderName="";if(selectedOrderObj[i].name){orderName=selectedOrderObj[i].name}else{orderName=selectedOrderObj[i]}table+=`<tr id='${id}'><td>${count}</td><td>${orderName}</td></tr>`}table+="</table>";for(let i=0;i<selectedOrderObj.length;i++){intro.addStep({title:title,element:$(templateId)[0].querySelectorAll('.sunohSummary')[0],position:'right',intro:table})}$(templateId+" .sunohSummary").scrollTop(0);$scope.addMutatioObserverListener();intro.start()},1e3)};$scope.addMutatioObserverListener=function(customIds){let initialOpenModalCount=0;let elementp=document.querySelectorAll('.modal');for(let index=0;index<elementp.length;index++){let ele=elementp[index];if($(ele).hasClass("in")){initialOpenModalCount++}}let initialModalLength=$(".modal").length;let initialIframeLength=$("iframe").length;sunohObserve(initialOpenModalCount,initialModalLength,initialIframeLength,function(){$(".introjs-tooltipReferenceLayer").css("z-index","6");$(".introjs-helperLayer").css("z-index","6")},function(){$(".introjs-tooltipReferenceLayer").css("z-index","99999999");$(".introjs-helperLayer").css("z-index","99999999")},customIds)};$scope.playAssessments=function(){$scope.sunohAssessments=true;$(templateId+" .sunohSummary").scrollTop(0);let intro=introJs().setOptions({disableInteraction:false,showStepNumbers:true,showDynamicElement:true,showBullets:false,exitOnOverlayClick:false,stepNumbersOfLabel:'/',keyboardNavigation:true,doneLabel:'Finish',skipLabel:'Skip',nextLabel:"Next Dx",prevLabel:"Previous Dx"}).onbeforechange(function(){$("#sunoh_dx_table tr").removeClass("active")}).onafterchange(function(e,a,b){let currentStep=this._currentStep;setTimeout(function(){var input=$(templateId+' #sunohScribeACIModule #txtICDDescr');let dxdata="";if($scope.gptAnalysis.diagnosis[currentStep].indexOf("- [")>0){dxdata=$scope.gptAnalysis.diagnosis[currentStep].split('- [')[0].trim()}else{dxdata=$scope.gptAnalysis.diagnosis[currentStep].split('[')[0].trim()}input.val(dxdata);input.trigger('input');input.trigger('change');input.trigger('keyup');$(templateId+" #sunohShowSuggestion .btnsearch").trigger("click");$("#sunoh_dx_"+currentStep).addClass("active")},1e3)}).onexit(function(){$scope.toggleSunohAssessments()});let table="<table class='table simpleTable' id='sunoh_dx_table'><tr><th>No</th><th>Dx</th>";for(let i=0;i<$scope.gptAnalysis.diagnosis.length;i++){let count=i+1;let id="sunoh_dx_"+i;table+=`<tr id='${id}'><td>${count}</td><td>${$scope.gptAnalysis.diagnosis[i]}</td></tr>`}table+="</table>";for(let i=0;i<$scope.gptAnalysis.diagnosis.length;i++){intro.addStep({title:'Sunoh - Add Assessments',element:$(templateId)[0].querySelectorAll('.sunohSummary')[0],position:'right',intro:table})}$(templateId+" .sunohSummary").scrollTop(0);$scope.addMutatioObserverListener();intro.start()};$scope.addToOrder=function(actionName){$scope.loadQSDxList();$scope.sunohOrders=true;var input=$($(templateId)[0].querySelectorAll('#quickSunohQuickSearchLookup [placeholder="Quick Order"]')[0]);input.val(actionName);if(input.length>0)input[0].setAttribute("sunoh-item-name",actionName);input.trigger('input');input.trigger('change');input.trigger('keyup');$(templateId+" .sunohSummary").scrollTop(0)};let scrollIntoViewEditOptionsPopup=function(){setTimeout(()=>{$("#editOptionPopover")[0].scrollIntoView({behavior:"smooth",block:"end"});$("#edit-opt-accpet-btn")[0].focus({preventScroll:true})},300)};let isNASelected=function(selectedICDList){return selectedICDList.length===1&&selectedICDList[0]===0};$scope.placeOrder=function(suggestedOrder,order,isFromPopup,orderDetailsObj){$("#orderICDValidation").css("visibility","none");order.isAcceptClicked=true;let selectedICDList=isFromPopup?suggestedOrder.selectDx:order.selectDx;if(_.trim(suggestedOrder.type)!=='immunizations'&&$scope.orderConfigAssmtMandatory&&(!selectedICDList||selectedICDList.length===0||isNASelected(selectedICDList))){if(!suggestedOrder.showEditOptionsPopover){suggestedOrder.showEditOptionsPopover=true;$scope.setIsOpenLabDiRefImmEditPopup(true);scrollIntoViewEditOptionsPopup()}setTimeout(()=>{$("#orderICDValidation").css("display","inline")});order.isAcceptClicked=false;return}let icdCodes=[];let selectedICDItemList=isFromPopup?suggestedOrder.selectDxItems:order.selectDxItems;if(selectedICDList&&selectedICDList.length>0){selectedICDList.forEach(dx=>{let dxDetailsObj=selectedICDItemList.find(dxDetail=>parseInt(dxDetail.value.itemId,10)===parseInt(dx,10));if(dxDetailsObj.value.ICD10){icdCodes.push(dxDetailsObj.value.ICD10)}else{icdCodes.push(dxDetailsObj.value.code)}})}let requestJSON={itemId:suggestedOrder.itemId,keyName:suggestedOrder.type,spokenTestName:order.name,name:suggestedOrder.name,encounterId:$scope.encounterId,patientId:$scope.patientId,orderDate:suggestedOrder.type==="immunizations"?suggestedOrder.givenDate:suggestedOrder.futureOrderDate,orderTime:suggestedOrder.type==="immunizations"?convertTimeFormat12To24Hour(suggestedOrder.givenTime):"",status:suggestedOrder.type==="immunizations"?suggestedOrder.naReasonStatus?suggestedOrder.naReasonStatus:suggestedOrder.status:"",fasting:suggestedOrder.fasting,priority:suggestedOrder.priority,assessments:selectedICDList?selectedICDList:[],icdCodes:icdCodes,summaryId:$scope.sunohSummaryId,suggestionLogId:order.suggestionLogId,currentOrder:suggestedOrder.type!=="immunizations"&&!suggestedOrder.isFutureOrder||suggestedOrder.type==="immunizations"&&!suggestedOrder.isHistorical?1:0,billable:suggestedOrder.isBillable};if(suggestedOrder.type==="immunizations"&&suggestedOrder.non_administration_reason){requestJSON.notAdminotherReason=suggestedOrder.non_administration_reason?suggestedOrder.non_administration_reason:"",requestJSON.notAdminReasonCodeForImmunityAndContra=suggestedOrder.immHistoryContraIndicationReasonCode?suggestedOrder.immHistoryContraIndicationReasonCode:"",requestJSON.notAdminReasonCode=suggestedOrder.non_administration_reason_code?suggestedOrder.non_administration_reason_code:"",requestJSON.suppressStatus=suggestedOrder.suppressStatus;requestJSON.suppressDate=suggestedOrder.suppressDate;requestJSON.effectiveDate=suggestedOrder.effectiveDate;requestJSON.expirationDate=suggestedOrder.expirationDate}$http({method:'POST',url:`/mobiledoc/emr/sunoh.ecw/accept-order`,data:requestJSON}).then(res=>{res=res.data;order.isAcceptClicked=false;if(res?.status===0){if(!suggestedOrder.showEditOptionsPopover){suggestedOrder.showEditOptionsPopover=true;$scope.setIsOpenLabDiRefImmEditPopup(true);scrollIntoViewEditOptionsPopup()}setTimeout(()=>{$("#validationMsg strong").text(res.message)});return}refreshDashboard($scope.encounterId,$scope.patientId,"","");notification.show("success",'Sunoh',escapeHtml(suggestedOrder.name+' is placed.'),5e3);order.isOrdered=true;order.isHistorical=suggestedOrder.isHistorical;$("#orderICDValidation").css("visibility","none");$("#validationMsg").val("");if(isFromPopup){order.selectDx=suggestedOrder.selectDx;order.selectDxItems=suggestedOrder.selectDxItems;setAccpetedChangesAfterOrderPlaced(suggestedOrder,orderDetailsObj)}$scope.setIsOpenLabDiRefImmEditPopup(false);if(suggestedOrder.type&&(suggestedOrder.type.toLowerCase()==="labreports"||suggestedOrder.type.toLowerCase()==="xrays")){$scope.labDIOrderPlaced=true}$scope.setDirtyFalg(false)})};function convertTimeFormat12To24Hour(time){time=_.trim(time);if(time){var value=moment(time,"hh:mm a").format("HH:mm");return value}return""}$scope.deleteUndoOrder=function(order,isDeleteOrder,isReferral){$scope.setIsOpenLabDiRefImmEditPopup(false);let payload={spokenTestName:isReferral?order.referral_speciality:order.name,summaryId:$scope.sunohSummaryId,isDeleteOrder:isDeleteOrder};if(isReferral){payload.specialityId=order.recommendedSuggesion.Id}else{payload.itemId=order.recommendedSuggesion.itemId}$http({method:'POST',url:`/mobiledoc/emr/labs.ecw/quickorder/delete-undo-suggested-order`,data:payload}).then(res=>{order.isDeleted=isDeleteOrder;$scope.closeOtherEditOptionsPopup()})};$scope.setDirtyFalg=function(value){labDIProcImmRefDirtyFlag=value};$scope.placeReferral=function(selectedReferral,order,isFromPopup){order.isAcceptClicked=true;let checkFieldLength=dataTruncUtilityService.getTextFieldWidthsFromTable("web_sunoh_summary","editOptionPopover","bluetheme");if(!checkFieldLength){order.isAcceptClicked=false;return}if(!selectedReferral.specialityId){order.isAcceptClicked=false;ecwAlert("Please select speciality first");return}let icdCodes=[];let selectedICDList=isFromPopup?selectedReferral.selectDx:order.selectDx;let selectedICDItemList=isFromPopup?selectedReferral.selectDxItems:order.selectDxItems;if(selectedICDList&&selectedICDList.length>0){selectedICDList.forEach(dx=>{let dxDetailsObj=selectedICDItemList.find(dxDetail=>parseInt(dxDetail.value.itemId,10)===parseInt(dx,10));if(dxDetailsObj.value.ICD10){icdCodes.push(dxDetailsObj.value.ICD10)}else{icdCodes.push(dxDetailsObj.value.code)}})}$http({method:'POST',url:`/mobiledoc/emr/sunoh.ecw/accept-order`,data:{...selectedReferral,keyName:'referral',patientId:$scope.patientId,encounterId:$scope.encounterId,summaryId:$scope.sunohSummaryId,icdCodes:icdCodes,suggestionLogId:order.suggestionLogId}}).then(res=>{res=res.data;order.isAcceptClicked=false;if(res?.status===0){ecwAlert(res.message);return}refreshDashboard($scope.encounterId,$scope.patientId,"","");notification.show("success",'Sunoh',`Referral for ${escapeHtml(selectedReferral.speciality)} is placed.`,5e3);order.isOrdered=true;if(order.recommendedSuggesion){order.recommendedSuggesion.Speciality=selectedReferral.speciality;order.recommendedSuggesion.showEditOptionsPopover=false;order.recommendedSuggesion.priority=selectedReferral.priority;order.recommendedSuggesion.priorityName=selectedReferral.priorityName;order.recommendedSuggesion.referralToName=selectedReferral.referralToName;order.recommendedSuggesion.performedBy=selectedReferral.performedBy;order.recommendedSuggesion.assignedToName=selectedReferral.assignToName;order.recommendedSuggesion.referredToName=selectedReferral.referralToName;order.recommendedSuggesion.isTempOrder=false;if(selectedReferral.reasons&&selectedReferral.reasons.length>=1){order.reason=selectedReferral.reasons.join('|')}}$scope.setIsOpenLabDiRefImmEditPopup(false);if(selectedReferral.selectDx){order.selectDx=selectedReferral.selectDx;order.selectDxItems=selectedReferral.selectDxItems}$scope.setDirtyFalg(false)})};let setAccpetedChangesAfterOrderPlaced=function(suggestedOrder,orderDetailsObj){let suggestedTempIndex=orderDetailsObj.tempSuggestionIndex;let tempEditPopupIndex=orderDetailsObj.tempEditPopupIndex;let orderIndex=orderDetailsObj.orderIndex;suggestedOrder.showEditOptionsPopover=false;if(isLabOrder(orderDetailsObj.orderType)){$scope.gptAnalysis.lab_tests[orderIndex].suggestedOrders[suggestedTempIndex]=angular.copy(suggestedOrder);$scope.gptAnalysis.lab_tests[orderIndex].suggestedOrders[tempEditPopupIndex].showEditOptionsPopover=false;$scope.gptAnalysis.lab_tests[orderIndex].recommendedSuggesion=angular.copy(suggestedOrder);$scope.gptAnalysis.lab_tests[orderIndex].recommendedSuggesion.isTempOrder=false}else if(orderDetailsObj.orderType==="diProc"){$scope.gptAnalysis.diagnostic_imaging_or_procedures[orderIndex].suggestedOrders[suggestedTempIndex]=angular.copy(suggestedOrder);$scope.gptAnalysis.diagnostic_imaging_or_procedures[orderIndex].suggestedOrders[tempEditPopupIndex].showEditOptionsPopover=false;$scope.gptAnalysis.diagnostic_imaging_or_procedures[orderIndex].recommendedSuggesion=angular.copy(suggestedOrder);$scope.gptAnalysis.diagnostic_imaging_or_procedures[orderIndex].recommendedSuggesion.isTempOrder=false}else if(orderDetailsObj.orderType==="imm"){$scope.gptAnalysis.immunizations[orderIndex].suggestedOrders[suggestedTempIndex]=angular.copy(suggestedOrder);$scope.gptAnalysis.immunizations[orderIndex].suggestedOrders[tempEditPopupIndex].showEditOptionsPopover=false;$scope.gptAnalysis.immunizations[orderIndex].recommendedSuggesion=angular.copy(suggestedOrder);$scope.gptAnalysis.immunizations[orderIndex].recommendedSuggesion.isTempOrder=false}else{$scope.gptAnalysis.referral[orderIndex].suggestedOrders[suggestedTempIndex]=angular.copy(suggestedOrder);$scope.gptAnalysis.referral[orderIndex].suggestedOrders[tempEditPopupIndex].showEditOptionsPopover=false;$scope.gptAnalysis.referral[orderIndex].recommendedSuggesion=angular.copy(suggestedOrder);$scope.gptAnalysis.referral[orderIndex].recommendedSuggesion.isTempOrder=false}if($scope&&$scope.$root.$$phase!=='$apply'&&$scope.$root.$$phase!=='$digest'){$scope.$apply()}};$scope.placeSuggestedOrder=function(orderDetailsObj){let suggestedOrder=orderDetailsObj.suggestedOrder;let suggestedTempOrder=orderDetailsObj.suggestedTempOrder;let order=orderDetailsObj.order;if(!suggestedOrder.itemId&&!order.isAllSuggestionInactive||!suggestedTempOrder.itemId&&order.isAllSuggestionInactive){ecwAlert("Please select order first");return}if(suggestedTempOrder.itemId){suggestedOrder=angular.copy(suggestedTempOrder)}$scope.placeOrder(suggestedOrder,order,true,orderDetailsObj)};$scope.addToDx=function(dx){$scope.sunohAssessments=true;var input=$(templateId+' #sunohScribeACIModule #txtICDDescr');let dxdata="";if(dx.indexOf("- [")>0){dxdata=dx.split('- [')[0].trim()}else{dxdata=dx.split('[')[0].trim()}input.val(dxdata);input.trigger('input');input.trigger('change');input.trigger('keyup');$(templateId+" #sunohShowSuggestion .btnsearch").trigger("click");$(templateId+" .sunohSummary").scrollTop(0)};$scope.addToReferral=function(){$scope.sunohOrders=true;$(templateId+" .sunohSummary").scrollTop(0);$(templateId+" #quickSunohQuickSearchLookup .quicksearch-create-referral").parent().get(0).dispatchEvent(new Event("click"));let intro=introJs().setOptions({disableInteraction:false,showStepNumbers:true,showDynamicElement:true,showBullets:false,exitOnOverlayClick:false,stepNumbersOfLabel:'/',keyboardNavigation:true,doneLabel:'Finish',skipLabel:'Skip',nextLabel:"Next Referral",prevLabel:"Previous Referral"}).onbeforechange(function(){$("#sunoh_referrals_table tr").removeClass("active");let introItem=this._introItems[this._currentStep]}).onafterchange(function(e,a,b){let currentStep=this._currentStep;setTimeout(function(){$("#sunoh_referrals_"+currentStep).addClass("active");var text=$scope.gptAnalysis.referral[currentStep].referral_speciality;var search=$(templateId+" #quickSunohQuickSearchLookup .ref-div select:first option").filter(function(){return $(this).text().toLowerCase()===text.toLowerCase()}).first();let val=$(templateId+" #quickSunohQuickSearchLookup .ref-div select").val();if(val!=="? number:0 ?"){$(templateId+" #quickSunohQuickSearchLookup .ref-div select:first option:selected").removeAttr("selected")}if(search.length>0){if(search.length>1){val=search[0].attr("value")}else{val=search.attr("value")}$(templateId+" #quickSunohQuickSearchLookup .ref-div select").val(val)}else{$(templateId+" #quickSunohQuickSearchLookup .ref-div select").val(0)}if($scope.$$phase!=='$apply'&&$scope.$$phase!=='$digest'){$scope.$apply()}$(templateId+" #quickSunohQuickSearchLookup .ref-div select:first").trigger('input');$(templateId+" #quickSunohQuickSearchLookup .ref-div select:first").trigger('change');$(templateId+" #quickSunohQuickSearchLookup .ref-div select:first").trigger('keyup')},1e3)}).onexit(function(){$scope.toggleSunohOrders()});let table="<table class='table simpleTable' id='sunoh_referrals_table'><tr><th>No</th><th>Doctor Name</th><th>Speciality</th>";for(let i=0;i<$scope.gptAnalysis.referral.length;i++){let count=i+1;let id="sunoh_referrals_"+i;table+=`<tr id='${id}'><td>${count}</td><td>${$scope.gptAnalysis.referral[i].referred_doctor_name}</td><td>${$scope.gptAnalysis.referral[i].referral_speciality}</td></tr>`}table+="</table>";for(let i=0;i<$scope.gptAnalysis.referral.length;i++){intro.addStep({title:'Sunoh - Add Referrals',element:$(templateId)[0].querySelectorAll('.sunohSummary')[0],position:'right',intro:table})}$(templateId+" .sunohSummary").scrollTop(0);$scope.addMutatioObserverListener();intro.start()};$scope.copyContent=function(content){const el=document.createElement('textarea');el.value=content;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el)};$scope.stopConversation=function(){$scope.audioDuration=null;$scope.stopTimer();$(templateId+' #playSection').addClass('dnone');$(templateId+" #sunoh_timer,"+templateId+" .sunoh-widget-stop,"+templateId+" #audiovisualizer").addClass("dnone");$(templateId+' .blank-line').removeClass('dnone');navigator.mediaDevices.ondevicechange=null;$scope.aciAzure.stopStreaming($scope.getAudioFile);sourceConversation.disconnect();analyserConversation.disconnect();sunohGlobal.instanceCounter[$scope.encounterId+'widget']['status']=0;let ptDetails=$scope.encObj.patientIdentifierDetails;notification.show('sunoh-info-msg','Sunoh','Recording stopped successfully. Generating Summary for '+ptDetails.lastName.toUpperCase()+', '+ptDetails.firstName.toUpperCase()+', please view summary from Sunoh Summarization List',4e3);if($scope.stream&&$scope.stream.getTracks()){$scope.stream.getTracks()[0].stop()}};let getVisitNoteObj=function(){let visitNoteObj={};let noteType='';let noteTypeId=$scope.isSunohStandalone?getUserProfile("sunohNoteType"):$scope.integratedNoteType;if(noteTypeMap.has(noteTypeId)){noteType=noteTypeMap.get(noteTypeId)}visitNoteObj.noteType=noteType;visitNoteObj.noteAttributes=$scope.isSunohStandalone?'':getAttributes(noteType);return visitNoteObj};let getAttributes=function(visitNoteType){let attributes='';switch(visitNoteType){case'vision':let url='/mobiledoc/jsp/webemr/progressnotes/usvision/visionexam/getVisionExamData.jsp?operation=getAttributes&categoryId='+getUserProfile('eyeExamDefaultCategory');let response=urlGet(url);attributes=unescapeHtmlForJsonString(response);break;default:break}return attributes};$scope.saveAndGenerateSummary=function(data,allTxn){if(!$scope.audioDuration){$scope.audioDuration=audioDurationTimer}let payload={conversations:JSON.stringify($scope.conversationData),summary:data,userId:$scope.userId,encId:$scope.encounterId,conversationDuration:$scope.audioDuration,sunohRecordId:$scope.sunohRecordId};return $http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/saveSummaryData'),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){$scope.summaryID=response;$scope.checkUploadAudioStatus(allTxn)}).error(function(error){notification.show('error','','Response not saved.',4e3)})};$scope.sessionRefresInterval;$scope.startEndAudio=function(eventType){if(eventType==="play"){if(!$scope.isRecordingStart){sharedServiceSunoh.getJWTToken().then(function(data){$scope.startConversation(data.data)});let sunohSession={sessionEncid:$scope.encounterId,sessionPtId:$scope.patientId,sessionPatientFullName:$scope.patientFullName};localStorage.setItem("sunohSession",JSON.stringify(sunohSession));sunohGlobal.isSessionActive=true;continueSession(false);let sessionrefreshTime=maxInActiveTime/2*1e3;$scope.sessionRefresInterval=setInterval(function(){continueSession(false)},sessionrefreshTime)}else{$scope.pauseplayConversation();$(templateId+' .sunoh-loader').addClass('dnone');$(templateId+" #stopWidgetAudio").removeClass("dnone");$(templateId+" #startWidgetAudio").addClass("dnone");$(templateId+' .blank-line').addClass('dnone');$(templateId+' #audiovisualizer').removeClass('dnone');$scope.startTimer($scope.timerCounter)}$(templateId+' #sunohScribeACIModule #playerId').removeClass('mb40').addClass('mb20');$scope.isRecordingPaused=false;$scope.stopPauseTimer();$scope.updateTopPosForAlert()}else if(eventType==="pause"){enableStartButton();$(templateId+' .blank-line').removeClass('dnone');$(templateId+' #audiovisualizer').addClass('dnone');$scope.stopTimer();$(templateId+' #sunohScribeACIModule #playerId').removeClass('mb20').addClass('mb40');$scope.pauseplayConversation();$scope.startPauseTimer();$(templateId+" #startWidgetAudio").removeClass("dnone");$(templateId+" #startWidgetAudio").addClass(["sunohicons-red-triangle","btn-circle-white"]);$(templateId+" #stopWidgetAudio").addClass("dnone");$scope.isRecordingPaused=true;$scope.updateTopPosForAlert()}else{enableStartButton();$scope.isRecordingStart=false;sunohGlobal.recordingStarted=false;$scope.isRecordingPaused=false;$(templateId+' .sunoh-setting-btn').removeClass("disableEl");$(templateId+' #sunohSettings').removeClass("disableEl");$(templateId+" #startWidgetAudio").addClass(["sunohicons-red-triangle","btn-circle-white"]);$(templateId+" #startWidgetAudio").removeClass("dnone");$(templateId+" #stopWidgetAudio,.sunoh-loader").addClass("dnone");$scope.stopConversation();localStorage.removeItem("sunohSession");sunohGlobal.isSessionActive=false;sunohGlobal.checkSummaryStatus();clearInterval($scope.sessionRefresInterval)}};$scope.updateTopPosForAlert=function(){let top=-50;if($scope.isOutSidePN&&$scope.isRecordingPaused){top=top-60}let left=-1;$(templateId+' .sunoh-ps-alert').css({'top':top,'left':left})};$scope.removeAssessemnts=function(){$scope.linkurl=""};$scope.loadAssessements=function(){PNService.setParametersForScreen("assessment",{encounterId:$scope.encounterId,patientId:$scope.patientId,userId:$scope.userId,context:'sunoh'});$ocLazyLoad.load({serie:true,name:'assessment',files:['/mobiledoc/jsp/webemr/progressnotes/assessment/assessmentcontroller.js','/mobiledoc/jsp/webemr/progressnotes/billing/assessmentNotes-tpl.js']}).then(function(){let url="/mobiledoc/jsp/webemr/progressnotes/assessment/assessment.jsp?nts";$scope.linkurl=makeURL(url)})};$scope.pausetimer=900;$scope.pausetimerString="15:00";$scope.pauseTimerVal;$scope.startPauseTimer=function(){$scope.pauseTimerVal=setInterval(function(){$scope.pausetimer=$scope.pausetimer-1;$scope.$apply();let min=Math.trunc($scope.pausetimer/60);let sec=$scope.pausetimer%60;if(min<10){min="0"+min}if(sec<10){sec="0"+sec}$scope.pausetimerString=min+":"+sec;if($scope.pausetimer<=0){$scope.stopPauseTimer();$scope.startEndAudio('stop')}},1e3)};$scope.stopPauseTimer=function(){$scope.pausetimer=900;$scope.pausetimerString="15:00";clearInterval($scope.pauseTimerVal)};$scope.$on("$destroy",function(){sunohGlobal.log("destroy called");$scope.isInputChanges=false;structureDataChange=new Set;$scope.generateNotesAllow=false;$scope.isEncLocked=false;$(templateId+" #sunohDropDown").addClass('selection-options');clearInterval($scope.sessionRefresInterval);let lockObj={};lockObj.formName="frmAssessments";lockObj.g_cancel=false;lockObj.isOpenform=false;lockObj.uniqueKey="frmAssessments"+$scope.encounterId;CloseForm2(lockObj);if(Object.keys($scope.asmtUserProfileKeyValue).length>0){saveUserProfileSettings($scope.asmtUserProfileKeyValue)}SunohGlobalService.destroyTemplateInstance($scope.encounterId,$scope.type,templateIndex);clearTimeout(sunohGlobal.checkTransalationStatusInterval);sunohGlobal.reconnectAttempts=0;if(typeof structureDataWorker!=='undefined'&&structureDataWorker){structureDataWorker.getStDataResponse(null,null,null,true)}});$scope.timerCounter=0;$scope.timer;$scope.startTimer=function(count){$scope.timerCounter=0;if(count){$scope.timerCounter=count}$scope.timer=setInterval(function(){$scope.timerCounter=$scope.timerCounter+1;let m="00";let s="00";if($scope.timerCounter>59){m=Math.trunc($scope.timerCounter/60);if(m/10<1){m="0"+m}s=$scope.timerCounter%60}else{s=$scope.timerCounter%60}if(s/10<1){s="0"+s}$(templateId+" .fnt14semiboldwhite").text(m+":"+s)},1e3)};let audioDurationTimer="00:00";$scope.stopTimer=function(){audioDurationTimer=$(templateId+" .fnt14semiboldwhite.sunoh-timer-digit").text();clearInterval($scope.timer)};$scope.showSummaryClicked=function(isTxt){if(sharedServiceSunoh.isSummaryPermission){if($scope.isOutSidePN&&!isTxt){$scope.showNavigateAlert()}else{$scope.showSummaryFor(isTxt)}}};$scope.showNavigateAlert=function(){$(templateId+' .navigate-sunoh-section-prompt').removeClass('dnone').position({of:event.currentTarget,my:'left-30 bottom-35',at:'left bottom',collision:"flipfit"}).animate({"opacity":1},100)};$scope.closeSunohNavigateAlert=function(){$(templateId+' .navigate-sunoh-section-prompt').addClass('dnone')};$scope.navigateToPN=function(){$scope.openPNForSunoh();$scope.closeSunohNavigateAlert()};$scope.showSummaryFor=function(isTxt){let summaryModel=$(templateId+' .search-transcript-modal');summaryModel.removeClass('dnone');summaryModel.css('bottom',$(templateId+' #bottomPanelApp').outerHeight()+2+'px');setTimeout(function(){$scope.adjustSectionsScrollHt();$scope.strechingTextArea();if($(templateId)[0].querySelector('.sunohSummary')){$(templateId)[0].querySelector('.sunohSummary').addEventListener("scroll",$scope.toggleFloatingButton)}if($scope.isTVSummary){$scope.loadSelectedTransactions(0,1)}if(!isTxt){$scope.loadAudioWavInSummary($scope.audioFile)}});$scope.closeSummary()};$scope.toggleFloatingButton=function(){let summaryScroll=$(templateId+' .sunohSummary').scrollTop();let assessmentHeight=$(templateId)[0].querySelector("#sunohAssessmentSec").offsetTop-150;let progressNoteSection=$(templateId+' .sunohicons-list-progress-notes').parent();let actionAndOrder=$(templateId+' .sunohicons-ordered').parent();if(summaryScroll>assessmentHeight){progressNoteSection.removeClass('active');actionAndOrder.addClass('active')}else if(actionAndOrder.hasClass('active')){progressNoteSection.addClass('active');actionAndOrder.removeClass('active')}};$scope.handler=function(response){if(response.tagging){$scope.isTaggingDone=true;sunohGlobal.isSessionActive=true;$(templateId+" #stopWidgetAudio,"+templateId+" #sunoh_timer,"+templateId+" .sunoh-widget-stop,"+templateId+" #audiovisualizer").removeClass("dnone");$(templateId+" #startWidgetAudio,"+templateId+" .sunoh-loader").addClass("dnone");$scope.hideSunohSetting();$(templateId+' .sunoh-setting-btn').addClass("disableEl");$(templateId+' #sunohSettings').addClass("disableEl");$scope.startConversationWavAudioAnimation();$scope.startTimer()}if(response.summaryCall){$scope.viewSummary('direct',response)}if(response.transcription&&response.speakerId){$scope.conversationData.push(response)}};$scope.viewSummary=function(mode,response){let promise;if(mode==='recover'&&$(templateId+' #summaryGenerated').css('display')!=='none'){$(templateId+' #summaryGenerated').hide();$(templateId+' #viewSummary').show()}else if(mode==='direct'){promise=$scope.saveAndGenerateSummary(response.summaryData,false)}$scope.isTaggingDone=false;$scope.gptAnalysisDone=true;promise.then(function(){$scope.aciAzure.sendAcknowledge();if($scope.uploadedAudio||$scope.audioFailed){$scope.preCleanup();if($scope.aciAzure&&$scope.aciAzure.getSocket()){let socket=$scope.aciAzure.getSocket();if(socket.readyState===WebSocket.OPEN){socket.close()}}$scope.postCleanup()}})};$scope.isMicErrorAvailable=false;$scope.handleMicChange=function(){if($scope.audioList.length===0||!$scope.audioList.includes($scope.defaultMic)&&!$scope.isMicErrorAvailable){sunohGlobal.instanceCounter[$scope.encounterId+'widget']['status']=0;$scope.cleanup(true);$scope.isMicErrorAvailable=true;showCustomErrorDialog('','<b>Sunoh - Microphone Not Detected</b><br><br>'+'We are unable to hear you. However, the recording that has been captured until now will be processed and made available. To initiate a new session, please ensure that your microphone settings are properly configured and launch the Sunoh widget.',"500px")}};$scope.startConversation=function(jwtToken){navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{$scope.audioList=[];$scope.defaultMic=null;$scope.defaultMicSet=false;$scope.isMicErrorAvailable=false;navigator.mediaDevices.ondevicechange=event=>{$scope.updateDeviceList()};$scope.updateDeviceList();$scope.isTaggingDone=false;$(templateId+" #startWidgetAudio").removeClass(["sunohicons-red-triangle","btn-circle-white"]).addClass('dnone');$(templateId+' .sunoh-loader').removeClass('dnone');$(templateId+" #stopWidgetAudio").addClass("dnone");$(templateId+' .blank-line,'+templateId+' .search-transcript-modal').addClass('dnone');if(jwtToken){$scope.aciAzure=new ACIAzure(stream,$scope.handler,'en','en',$scope.signatureData,$scope.encObj,jwtToken,templateIndex);let providerId=EncDetailsService.getProviderId();if(providerId!==global.TrUserId&&isProviderSignatureRegistered&&"yes"===getItemKeyValue("SunohMultiSpeakerEnable")){if(localStorage.getItem("sunohSignature_"+providerId)){let apptProvSigData=[];apptProvSigData.push({userId:providerId,data:localStorage.getItem("sunohSignature_"+providerId),providerSignatureId:providerSignatureData});$scope.startConversationFromWidget(apptProvSigData)}else{addAppointmentProviderSignatureAudio(providerId,$scope.startConversationFromWidget)}}else{let apptProvSigData=[];$scope.startConversationFromWidget(apptProvSigData)}sunohGlobal.instanceCounter[$scope.encounterId+'widget']['status']=1}})["catch"](function(err){let sunohBtnMicAlert=$(templateId+' #sunohBtnMicAlert');sunohBtnMicAlert.css('display','block');sunohBtnMicAlert.animate({},100,function(){$(templateId+" #sunohBtnMicAlert").position({of:$(templateId+" .sunoh-setting-btn"),my:'right+10 bottom-40',at:'right+10 bottom',collision:"flipfit"}).animate({"opacity":1},100)})});$scope.conversationData=[]};function addAppointmentProviderSignatureAudio(providerId,callBack){$.ajax({url:"/mobiledoc/modules/webemr/sunoh/get/signatureaudio",data:{encProviderId:encryptedProviderId},type:'POST'}).success(function(response){let apptProvSigData=[];if(response&&response.length>0){localStorage.setItem("sunohSignature_"+providerId,response);apptProvSigData.push({userId:providerId,data:localStorage.getItem("sunohSignature_"+providerId),providerSignatureId:providerSignatureData})}else if(providerSignatureData&&providerSignatureData.length>0){apptProvSigData.push({userId:providerId,data:"",providerSignatureId:providerSignatureData})}if(typeof callBack==='function'){callBack(apptProvSigData)}}).error(function(data){sunohGlobal.log(data)})}$scope.startConversationFromWidget=function(apptProvSigData){$scope.aciAzure.startTranscription(apptProvSigData,getVisitNoteObj());sunohGlobal.recordingStarted=true;$scope.isRecordingStart=true};$scope.audioList=[];$scope.defaultMic;$scope.defaultMicSet=false;$scope.updateDeviceList=function(){navigator.mediaDevices.enumerateDevices().then(devices=>{$scope.audioList=[];devices.forEach(device=>{const[kind,type,direction]=device.kind.match(/(\w+)(input|output)/i);if(type==="audio"&&direction==="input"){let inputDevice=kind+"|"+device.label+"|"+direction;if(device.label.startsWith("Default - ")&&!$scope.defaultMicSet){$scope.defaultMic=inputDevice;$scope.defaultMicSet=true}$scope.audioList.push(inputDevice)}});$scope.handleMicChange()})};$scope.pauseplayConversation=function(){$scope.aciAzure.pausedPlayRecording()};$scope.startConversationWavAudioAnimation=function(){$scope.initConversationAudio();navigator.mediaDevices.getUserMedia({audio:true}).then(function(stream){$scope.stream=stream;sourceConversation=audioContext.createMediaStreamSource(stream);sourceConversation.connect(analyserConversation)})["catch"](function(err){console.error(err)})};$scope.initConversationAudio=function(){audioContext=new AudioContext;audiocanvas=$(templateId+" #audiovisualizer")[0];audiocanvasCtx=audiocanvas.getContext("2d");audiocanvas.width=183;audiocanvas.height=50;analyserConversation=audioContext.createAnalyser();analyserConversation.fftSize=2048;var bufferLength=analyserConversation.frequencyBinCount;dataArray=new Uint8Array(bufferLength);$scope.drawConversation()};$scope.drawConversation=function(){animationId=requestAnimationFrame($scope.drawConversation);analyserConversation.getByteTimeDomainData(dataArray);audiocanvasCtx.clearRect(0,0,audiocanvas.width,audiocanvas.height);function drawDashedLineConversation(pattern){audiocanvasCtx.beginPath();audiocanvasCtx.lineWidth=5;audiocanvasCtx.strokeStyle="#FB2B66";audiocanvasCtx.setLineDash(pattern);audiocanvasCtx.moveTo(0,y);audiocanvasCtx.lineTo(300,y);audiocanvasCtx.stroke();y+=20}drawDashedLineConversation([1,1]);var bufferLength=dataArray.length;var sliceWidth=audiocanvas.width*1/bufferLength;var x=0;for(var i=0;i<bufferLength;i++){var v=dataArray[i]/128;var y=v*audiocanvas.height/2;if(i===0){audiocanvasCtx.moveTo(x,y)}else{audiocanvasCtx.lineTo(x,y)}x+=sliceWidth}audiocanvasCtx.lineTo(audiocanvas.width,audiocanvas.height/2);audiocanvasCtx.stroke()};$scope.closeTVAnalysis=function(){if(!($scope.isUnsavedHPIData||$scope.isUnsavedMedHxData||$scope.isUnsavedSocialHxData)){$scope.closeTVConvWindow()}else{$(templateId+" #convosummary-close-popup").attr("style","display: block !important;");if($scope.isUnsavedSocialHxData){$(templateId+" .socialhx-section-data").css('border','1px solid red');$(templateId+" .socialhx-section-data").focus()}if($scope.isUnsavedMedHxData){$(templateId+" .medhx-section-data").css('border','1px solid red');$(templateId+" .medhx-section-data").focus()}if($scope.isUnsavedHPIData){$(templateId+" .hpi-section-data").css('border','1px solid red');$(templateId+" .hpi-section-data").focus()}}};$scope.closeTVConvWindow=function(){$(templateId+" #aciConversationController").css("display","none");$(templateId+" .summary-loader").hide();$(templateId+" .gptSummary").hide();$(templateId+' .gpt-analysis').modal('hide');$(templateId+' .popoverThis').popover('hide');$(templateId+' .hpiCatDiv').hide()};var deferred=$q.defer();$scope.getExistingConversationsAudio=function(id){if(deferred.promise.$$state.status&&deferred.promise.$$state.status===1||deferred.promise.$$state.pending&&deferred.promise.$$state.pending.length>0){deferred.resolve();deferred.promise.$$state={status:0}}$(templateId+' #sunohAudioLoader').removeClass('dnone');$(templateId+" #canvasSummary").addClass('dnone');$http({url:makeURL("/mobiledoc/modules/webemr/sunoh/get/conversationaudio"),method:'GET',timeout:deferred.promise,params:{encId:$scope.encounterId,txtId:id},headers:{'Content-type':'application/octet-stream'},responseType:'arraybuffer'}).success(function(data,status,headers,config){$(templateId+' #sunohAudioLoader').addClass('dnone');$(templateId+" #canvasSummary").removeClass('dnone');if(data.byteLength&&data.byteLength>26){$scope.loadAudioWavInSummary(new Blob([data],{type:'audio/wav'}))}else{$(templateId+' #sunohAudioLoader').addClass('dnone');$(templateId+' #sunohAudiodownloadError').removeClass('dnone');$(templateId+" #canvasSummary").addClass('dnone');$scope.adjustSectionsScrollHt()}deferred.promise.$$state={status:0};deferred.resolve()}).error(function(data){$(templateId+' #sunohAudioLoader').addClass('dnone');$(templateId+' #sunohAudiodownloadError').removeClass('dnone');$(templateId+" #canvasSummary").addClass('dnone');$scope.adjustSectionsScrollHt();console.log(data);deferred.promise.$$state={status:0};deferred.resolve()})};$scope.openOrder=function(order){$scope.closeTVAnalysis();setTimeout(function(){var inputfl=$(templateId+' [id^=quick-search-textBox]').get(0);inputfl.value=order;inputfl.focus();$(templateId+" #contains-search").trigger("click");setTimeout(function(){$(inputfl).trigger(jQuery.Event('keyup',{keycode:32}));$(templateId+" #contains-search").trigger("click")},500);setTimeout(function(){let e=$.Event('keyup');e.which=32;$(inputfl).trigger(e)},500)},500)};$scope.openNextAppointment=function(){$scope.closeTVAnalysis();var aTags=$(templateId)[0].getElementsByTagName("b");var searchText="Next Appointment:";var found;for(var i=0;i<aTags.length;i++){if(aTags[i].textContent==searchText){found=aTags[i];break}}$(found).trigger("click")};$scope.getCategories=function(){var payload={action:"getCategoriesList",trUserId:$scope.userId,encid:$scope.encounterId};$http({method:"POST",url:makeURL('/mobiledoc/jsp/dashboard/saveNotes.jsp?'),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){if(response.UserProfile.hpi>0){$scope.hpiDefaultValue=response.UserProfile.hpi;$scope.hpiSelectedValue=response.UserProfile.hpi}if(response.UserProfile.examination>0){$scope.examDefaultValue=response.UserProfile.examination;$scope.examSelectedValue=response.UserProfile.examination}$.extend($scope.hpiList,response.HPI);$.extend($scope.examList,response.Examination)})};$scope.refreshProgressNote=function(){let tabsPanelScope=angular.element($('#tabspanel')).scope();let tabDetails=tabsPanelScope.tabSelected;if(tabDetails.scribe){tabsPanelScope.changeTab('Scribe')}else if(tabDetails.progressnote){tabsPanelScope.changeTab('PN')}else if(tabDetails.orders){tabsPanelScope.changeTab('Orders')}else if(tabDetails.prisma){tabsPanelScope.changeTab('Prisma')}myScribePanelSharedService.refreshRightPanel()};$scope.saveDefaultCategory=function(section){let defaultVal="";let url="";let payload={};if(section==="HPI"){defaultVal=$scope.hpiSelectedValue=$(templateId+" #hpicatselection").val();if(NumberUtility.isPositiveInteger($scope.hpiSelectedValue)===false){return}url='/mobiledoc/modules/webemr/sunoh/saveHPICategory';payload={hpiCatId:defaultVal,trUserId:$scope.userId}}else{defaultVal=$scope.examSelectedValue=$(templateId+" #examcatselection").val();if(NumberUtility.isPositiveInteger($scope.examSelectedValue)===false){return}url='/mobiledoc/modules/webemr/sunoh/saveExamCategory';payload={examCatId:defaultVal,trUserId:$scope.userId}}$http({method:"POST",url:makeURL(url),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){notification.show('success','',section+' Default category saved successfully.',4e3);$scope.isDefaultCategorySet=response.isDefaultCategorySet;if(section==="HPI"){$scope.hpiDefaultValue=defaultVal;$scope.isHpiDefaultSet=true}else{$scope.examDefaultValue=defaultVal;$scope.isExamDefaultSet=true}$(templateId+' .configHPI').trigger('click');$scope.isExamCategoryClicked=false;$scope.isHPICategoryClicked=false}).error(function(error){notification.show('error','',section+' Default category not saved.',4e3)})};$scope.showErrors=function(error){if(error.code==="3000"){error.title="Sunoh - Concurrency";error.message=error.message.replace("Scribe","Sunoh").replace("Scribed","saved")}let warningMsg='<b>'+error.title+'</b><br><br>'+error.message+'<br>';let warningMessage="<table class='custom-error-dialog' style='width: 568px'> "+"<tbody> "+"<tr> "+"<td style='width: 12%; background-color: #fbce2a;'> "+"<i class='iconblack fa fa-2x fa-exclamation-triangle' style='margin-left: 15px;'></i>"+"</td> "+"<td style='padding-left: 10px;'> "+"<div style='font-weight: bold; font-size: 16px;margin-bottom: 18px;margin-top: 10px;'></div> "+"<div style='font-size: 13px;'> "+warningMsg+"</div> "+"<div style='float:right;margin: 10px;'>"+"<button id='okErrorButtonId' style='margin-right: 10px;' class='btn btn-blue btn-xs close-dialog' data-dismiss='modal'>OK</button>"+"</div>"+"</td> "+"</tr> "+"</tbody> "+"</table> ";showCustomAlertPopup(warningMessage,"okErrorButtonId","500px")};$scope.generateAnnualNotesXML=function(encId,notes,type){let notesHtml='<span>'+notes+'</span>';let xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('encounter');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'encounterId',$scope.encounterId,'xsi:type','xsd:string');addElement(xw,'notes','<![CDATA['+replaceUTFCharWithASCII(notes)+']]>','xsi:type','xsd:string');addElement(xw,'notesHtml','<![CDATA['+replaceUTFCharWithASCII(notesHtml)+']]>','xsi:type','xsd:string');addElement(xw,'type',type,'xsi:type','xsd:string');xw.writeEndElement();endSoapPacket(xw);return xw.flush()};$scope.isHPIShort=false;$scope.updateImportdataScopes=function(data){if(data&&data.length>0){$scope.importData=JSON.parse(data);for(let importedData of $scope.importData){var sections=importedData.sections.split(",");sections.forEach(function(section){switch(section){case'hpi_long':$scope.gptAnalysis['IMPORTED_HPI_TIME']=importedData.lastModified;$scope.isHPIImported=true;$scope.hpiImportedBy=importedData.userName;$scope.isHPIShort=false;break;case'hpi_short':$scope.gptAnalysis['IMPORTED_HPI_TIME']=importedData.lastModified;$scope.isHPIImported=true;$scope.hpiImportedBy=importedData.userName;$scope.isHPIShort=true;break;case'medicalhx':$scope.gptAnalysis['IMPORTED_MEDHX_TIME']=importedData.lastModified;$scope.isMedHxImported=true;$scope.medicalHxImportedBy=importedData.userName;break;case'vitals':$scope.gptAnalysis['IMPORTED_VITALS_TIME']=importedData.lastModified;$scope.isVitalsImported=true;$scope.vitalsImportedBy=importedData.userName;break;case'socialhx':$scope.gptAnalysis['IMPORTED_SOCIALHX_TIME']=importedData.lastModified;$scope.isSocialHxImported=true;$scope.socialHxImportedBy=importedData.userName;break;case'familyhx':$scope.gptAnalysis['IMPORTED_FAMILYHX_TIME']=importedData.lastModified;$scope.isFamilyHxImported=true;$scope.familyHxImportedBy=importedData.userName;break;case'surgicalhx':$scope.gptAnalysis['IMPORTED_SURGICALHX_TIME']=importedData.lastModified;$scope.isSurgicalHxImported=true;$scope.surgicalHxImportedBy=importedData.userName;break;case'hospitalization':$scope.gptAnalysis['IMPORTED_HOSPITALIZATION_TIME']=importedData.lastModified;$scope.isHospitalizationImported=true;$scope.hospitalizationImportedBy=importedData.userName;break;case'followup':$scope.gptAnalysis['IMPORTED_FOLLOWUP_TIME']=importedData.lastModified;$scope.isFollowUpImported=true;$scope.followUpImportedBy=importedData.userName;break;case'exam':$scope.gptAnalysis['IMPORTED_EXAM_TIME']=importedData.lastModified;$scope.isExamImported=true;$scope.examImportedBy=importedData.userName;break;case'treatmentNote':$scope.gptAnalysis['IMPORTED_TREATMENT_NOTE_TIME']=importedData.lastModified;$scope.isTreatmentNoteImported=true;$scope.treatmentImportedBy=importedData.userName;break}})}}else{$scope.isHPIImported=false;$scope.isMedHxImported=false;$scope.isSocialHxImported=false;$scope.isFollowUpImported=false;$scope.isExamImported=false;$scope.isTreatmentNoteImported=false;$scope.isHospitalizationImported=false;$scope.isSurgicalHxImported=false;$scope.isFamilyHxImported=false;$scope.importData={}}};$scope.minimize_summary=false;$scope.minimizeSummaryModel=function(){let panel=$(templateId+' .search-transcript-modal');panel.addClass('expandpanel');$scope.minimize_summary=true;panel.css('transition','none');$(templateId+' #recoverHead').hide();$(templateId+' .doc-middle-sec,'+templateId+' .sunohicons-maximize').hide();$(templateId+' .sunohicons-minimize').removeClass('dnone');panel.removeAttr("style");panel.addClass('stickTobottom');panel.removeClass('expandedRightview');panel.removeClass('width-small-panel');introJs().exit()};$scope.maximizeSummaryModel=function(){$(templateId+' .search-transcript-modal').removeClass('expandpanel');$scope.minimize_summary=false;$(templateId+' .doc-middle-sec,'+templateId+' .sunohicons-maximize').show();$(templateId+' .sunohicons-minimize').addClass('dnone');$(templateId+' .search-transcript-modal').removeAttr("style");$(templateId+' .search-transcript-modal').removeClass('width-small-panel');$(templateId+' .search-transcript-modal').removeClass('expandedRightview');$(templateId+' .search-transcript-modal').removeClass('stickTobottom');$(templateId+' .doc-middle-sec').removeClass('expandheight');$scope.adjustSectionsScrollHt();$scope.loadAssessements()};$scope.readOnlySunohSummaryPopup=function(){$scope.generateNotesAllow=false;$scope.isEncLocked=true;$scope.$apply()};let openOrderDetailsPopup=function(){$scope.bottomPanelPopUrl="";$ocLazyLoad.load({name:'laborderdetails',files:getDependencies('laborderdetails')}).then(function(){$scope.bottomPanelPopUrl=makeURL("/mobiledoc/jsp/webemr/labs/orderdetails/OrderDetails.jsp?encounterId="+$scope.encounterId+"&reportId=0&patientId="+$scope.patientId+"&enableLabInstructions="+getUserProfile("EnableLabInstruction")+"&selectSingleAssessment="+$scope.selectSingleAssessment+"&context=SUNOH_LAB_DI_ORDERS&trUserId="+$scope.userId)},function(e){console.log(e)})};$scope.closeSunohSummaryScreen=function(){$scope.closeSunohSummaryPopup(true)};$scope.closeSunohSummaryPopup=function(isFromCloseAOE){let response=false;if(structureDataChange.size>0||labDIProcImmRefDirtyFlag||$scope.isInputChanges||checkForDataChangeInTreatmentPlan()){$scope.dismissSwitchSummary();$(templateId+' #endSummary').show()}else{if(!isFromCloseAOE&&$scope.labDIOrderPlaced){openOrderDetailsPopup();return}response=$scope.closeSunohSummaryModel()}introJs().exit();return response};let checkForDataChangeInTreatmentPlan=function(){let isChange=false;$scope.treatmentNotesDataArr.filter(dx=>!dx.isSaved||dx.isSaved&&dx.type==='assessment').forEach(function(dx){if(!isChange){let obj=gptSuggestedTreatmentPlan.find(obj=>dx.key&&obj.diagnosis&&dx.key===obj.diagnosis);isChange=obj&&!obj.isAccepted?dx.gptNotes!==obj.notes:dx.gptNotes&&dx.gptNotes.length>0}});return isChange};let isRxOrdered=false;$scope.loadInteraction=function(){try{if(isRxOrdered){isRxOrdered=false;$scope.loadRxInteractionSeverity()}}catch(e){}};$scope.loadRxInteractionSeverity=function(){$scope.nAllergyPopupLevel=getUserProfile("AllergyPopupLevel");$scope.m_bInteractionsProactive=false;let interactionsProactive=getUserProfile("EnableProactiveDrugInteraction");if(interactionsProactive.length>0&&(interactionsProactive==="1"||interactionsProactive===1)){$scope.m_bInteractionsProactive=true}if($scope.nAllergyPopupLevel===0||$scope.nAllergyPopupLevel==="0"||!$scope.m_bInteractionsProactive){return true}if(getItemKeyValue("EnableMedispan").toLowerCase()==="yes"){$http({method:"GET",url:"/mobiledoc/jsp/ecwrx/getDrugInteractionSeverity.jsp?encid="+$scope.encounterId,cache:false,params:{TrUserId:global.TrUserId}}).success(function(data){var x2js=new X2JS;data=$.trim(data);$scope.callDrugInteraction(x2js,data)}).error(function(){ecwAlert("Error while checking drug interactions. Please contact your provider.")})}else{var xsrf=$.param({TrUserId:global.TrUserId,encid:$scope.encounterId});$http({method:"POST",url:"/mobiledoc/jsp/catalog/xml/multum/DrugInteractionCheck.jsp",cache:false,headers:{'Content-Type':'application/x-www-form-urlencoded'},data:xsrf}).success(function(data){$scope.callDrugInteraction(x2js,data)}).error(function(){ecwAlert("Error while checking drug interactions. Please contact your provider.")})}};$scope.callDrugInteraction=function(x2js,data){let jsonData=x2js.xml_str2json(data);$scope.rxInteractionSeverity=jsonData.Envelope.Body['return'].severity.severitycode;try{$scope.rxInteractionSeverity=parseInt($scope.rxInteractionSeverity,10);if($scope.rxInteractionSeverity===3||$scope.rxInteractionSeverity===2&&$scope.nAllergyPopupLevel<3||$scope.rxInteractionSeverity===1&&$scope.nAllergyPopupLevel<2){$scope.drugInteraction()}}catch(e){}};$scope.drugInteraction=function(){$ocLazyLoad.load({name:'drugInteraction',files:['/mobiledoc/jsp/webemr/progressnotes/ecwrx/drugInteraction/drugInteractionController.js']}).then(function(){var modalInstance=$modal.open({templateUrl:makeURL('/mobiledoc/jsp/webemr/progressnotes/ecwrx/drugInteraction/drugInteraction.jsp'),controller:'drugInteractionController',windowClass:'app-modal-window1 bluetheme druginteractionPopup',keyboard:false,backdrop:"static",resolve:{patientID:function(){return $scope.patientId},encounterID:function(){return $scope.encounterId},loginuserid:function(){return global.TrUserId},parentName:function(){return"Treatment"},itemIDNDCObj:function(){return{itemid:"",NDCCode:"",doctorsFlag:""}}}});modalInstance.result.then(function(modalInstanceResponse){},function(modalInstanceResponse){})})};$scope.dismissEndSummary=function(){$(templateId+' #endSummary').hide()};$scope.closeSunohSummaryModel=function(){$scope.loadInteraction();if(!$scope.isTaggingDone){$scope.cleanup()}$(templateId)[0].querySelector('.sunohSummary').removeEventListener("scroll",$scope.toggleFloatingButton);$scope.isInputChanges=false;structureDataChange=new Set;$(templateId+' #endSummary').hide();$scope.isGenerateNoteCall=false;$(templateId+' .search-transcript-modal').addClass('dnone');let conversationaudioPlayer=$(templateId+" #conversationaudioPlayer")[0];conversationaudioPlayer.pause();conversationaudioPlayer.currentTime=0;if($(templateId+" #startBtn").hasClass("dnone")){$(templateId+" #startBtn").toggleClass("dnone");$(templateId+" #stopBtn").toggleClass("dnone")}$scope.isExamCategoryClicked=false;$scope.isHPICategoryClicked=false;$scope.sunohRecordId=undefined;return true};$scope.getTickToTimeOf=function(detailedInfo){try{detailedInfo=JSON.parse(detailedInfo)}catch(e){}let tick=detailedInfo.Offset;let second=tick/1e7;return $scope.getTimeFormatOf(second)};$scope.getTimeFormatOf=function(seconds){let sec_num=parseInt(seconds,10);let hours=Math.floor(sec_num/3600);let minutes=Math.floor(sec_num/60)%60;let sec=sec_num%60;return[hours,minutes,sec].map(v=>v<10?"0"+v:v).filter((v,i)=>v!=="00"||i>0).join(":")};$scope.ctx;$scope.drawAudioData=[];$scope.canvas;$scope.loadAudioWavInSummary=function(blob){let fileReader=new FileReader;let arrayBuffer;fileReader.onloadend=()=>{arrayBuffer=fileReader.result;window.AudioContext=window.AudioContext||window.webkitAudioContext;let audioContext=new AudioContext;$scope.canvas=$(templateId)[0].querySelector("canvas#canvasSummary");if($scope.canvas){$scope.ctx=$scope.canvas.getContext("2d");audioContext.decodeAudioData(arrayBuffer).then(audioBuffer=>{$scope.draw($scope.normalizedData(audioBuffer));$scope.drawData($scope.drawAudioData)})}};fileReader.readAsArrayBuffer(blob);let audioPlayer=$(templateId+" #conversationaudioPlayer")[0];if(audioPlayer){let objectURL=URL.createObjectURL(blob);audioPlayer.src=objectURL;audioPlayer.onloadedmetadata=function(){$(templateId+" #totalDuration").html($scope.getTimeFormatOf(audioPlayer.duration))};audioPlayer.addEventListener('ended',function(){$scope.playPauseWavAudio()});function scrollWithActive(){let audio=$(templateId+" #conversationaudioPlayer")[0];let p=Math.round(audio.currentTime);if($(templateId+" .t_"+p).length>0){$(templateId+" .txnContainer").removeClass("active");$(templateId+" .t_"+p).addClass("active");document.querySelector(templateId+' .t_'+p).scrollIntoView({behavior:'smooth',block:'nearest'})}}function addAudioListener(){let audio=$(templateId+" #conversationaudioPlayer")[0];let audioInterval;audio.addEventListener("play",event=>{audioInterval=setInterval(scrollWithActive,1e3)});audio.addEventListener("pause",event=>{clearInterval(audioInterval)})}addAudioListener();let currentAudioTimeStamp=0;audioPlayer.ontimeupdate=function(e){color='#FB2B66';$(templateId+' #goTime').html($scope.getTimeFormatOf(Math.floor(audioPlayer.currentTime)));let percent=audioPlayer.currentTime/audioPlayer.duration;if(currentAudioTimeStamp<this.currentTime){color='#FB2B66'}else{color="#BABABA";percent=currentAudioTimeStamp/audioPlayer.duration}currentAudioTimeStamp=this.currentTime;$scope.drawTimeline(percent,color)}}};$scope.forward=function(){let audioPlayer=$(templateId+" #conversationaudioPlayer")[0];let currentPos=audioPlayer.currentTime+10;audioPlayer.currentTime=currentPos};$scope.backword=function(){let audioPlayer=$(templateId+" #conversationaudioPlayer")[0];let currentPos=audioPlayer.currentTime-10;audioPlayer.currentTime=currentPos};$scope.getTranscriptId=function(detailedTranscription){try{detailedTranscription=JSON.parse(detailedTranscription)}catch(e){}let offsetInSecond=Math.round(detailedTranscription.Offset/1e7);return"t_"+offsetInSecond};$scope.updateAudioSpectrum=function(detailedTranscription){try{detailedTranscription=JSON.parse(detailedTranscription)}catch(e){}let offsetInSecond=Math.round(detailedTranscription.Offset/1e7);let audioPlayer=$(templateId+" #conversationaudioPlayer")[0];audioPlayer.currentTime=offsetInSecond-1};$scope._samples=1e4;$scope._strokeStyle="#BABABA";$scope.drawTimeline=function(percent,color){let end=Math.ceil($scope._samples*percent);let start=end-5||0;let t=$scope.drawAudioData.slice(0,end);$scope.drawData(t,color)};$scope.draw=function(normalizedData){const canvas=$scope.canvas;const dpr=window.devicePixelRatio||1;const padding=10;canvas.width=canvas.offsetWidth*dpr;canvas.height=50;$scope.ctx.scale(dpr,dpr);$scope.ctx.translate(0,12);const width=canvas.offsetWidth/normalizedData.length;for(let i=0;i<normalizedData.length;i++){const x=width*i;let height=normalizedData[i]*canvas.offsetHeight;if(height<0){height=0}else if(height>canvas.offsetHeight/2){height=height>canvas.offsetHeight/2}$scope.drawAudioData.push({x:x,h:height,w:width,isEven:(i+1)%2})}return $scope.drawAudioData};$scope.drawData=function(data,colors=$scope._strokeStyle){data.map(item=>{$scope.drawLineSegment($scope.ctx,item.x,item.h,item.w,item.isEven,colors)})};$scope.drawLineSegment=function(ctx,x,height,width,isEven,colors=$scope._strokeStyle){ctx.lineWidth=1;ctx.strokeStyle=colors;ctx.beginPath();height=isEven?height:-height;ctx.moveTo(x,0);ctx.lineTo(x+width,height);ctx.stroke()};$scope.normalizedData=function(audioBuffer){const rawData=audioBuffer.getChannelData(0);const samples=$scope._samples;const blockSize=Math.floor(rawData.length/samples);const filteredData=[];for(let i=0;i<samples;i++){filteredData.push(rawData[i*blockSize])}return filteredData};$scope.playPauseWavAudio=function(){if($("#startBtn").hasClass('dnone')){$(templateId+' #conversationaudioPlayer')[0].pause()}else{$(templateId+' #conversationaudioPlayer')[0].play()}$(templateId+" #startBtn").toggleClass("dnone");$(templateId+" #stopBtn").toggleClass("dnone")};$scope.getEncounterTime=function(date){if(date){let time=date.split(" ");const[hourString,minute]=time[1].split(":");const hour=+hourString%24;return(hour%12||12)+":"+minute+(hour<12?" AM":" PM")}};$scope.getEncounterDateOnly=function(date){if(date){return date.split(" ")[0]}};$scope.arrayMark=[];$scope.markIndex=0;$scope.total=0;$scope.highlightText=function(event){if(event.shiftKey&&event.which===13){$scope.moveup();$scope.scrollToMessage();return}else if(event.which===13){$scope.movedown();$scope.scrollToMessage();return}else if(event.which===16){return}if($(templateId+" #highlighter").val()===''){$scope.clearValue();return}$(templateId+' .resultBox').removeClass('dnone');$(templateId+' .patient-message,'+templateId+' .doctor-message').each(function(i){let dialogText=$(this).text();let search=$(templateId+' #highlighter')[0].value;search=search.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');let regExp=new RegExp(search,'gi');if(search.length>0){dialogText=dialogText.replace(regExp,`<mark>$&</mark>`);$(this).html(dialogText)}else{$(this).html(dialogText)}if(dialogText.length>0){$(templateId+" #clearInput").show()}else{$(templateId+" #clearInput").hide()}});$(templateId+' mark:first').addClass('selected');$scope.total=$(templateId+' .patient-message mark,'+templateId+' .doctor-message mark').length;$scope.arrayMark=$(templateId+' .chat-msg mark');$(templateId+' .total').html($scope.total);if($scope.arrayMark.length>0){$(templateId+' .selIndex').html($scope.markIndex+1)}else{$(templateId+' .selIndex').html(0)}$scope.scrollToMessage();$scope.moveTo(0)};$scope.moveup=function(){$($scope.arrayMark[$scope.markIndex]).removeClass('selected');$scope.markIndex--;if($scope.markIndex<0){$(templateId+' .up').addClass('disabled');$scope.markIndex=$scope.total-1;$($scope.arrayMark[$scope.markIndex]).addClass('selected')}else{$($scope.arrayMark[$scope.markIndex]).addClass('selected')}$scope.scrollToMessage();$(templateId+' .selIndex').html($scope.markIndex+1)};$scope.moveTo=function(select){$($scope.arrayMark[$scope.markIndex]).removeClass('selected');$scope.markIndex=select;if($scope.markIndex<0){$(templateId+' .up').addClass('disabled');$scope.markIndex=$scope.total-1;$($scope.arrayMark[$scope.markIndex]).addClass('selected')}else{$($scope.arrayMark[$scope.markIndex]).addClass('selected')}$scope.scrollToMessage();$(templateId+' .selIndex').html($scope.markIndex+1)};$scope.movedown=function(){$($scope.arrayMark[$scope.markIndex]).removeClass('selected');$scope.markIndex++;if($scope.markIndex>=$scope.total){$(templateId+' .down').addClass('disabled');$scope.markIndex=0;$($scope.arrayMark[$scope.markIndex]).addClass('selected')}else{$($scope.arrayMark[$scope.markIndex]).addClass('selected')}$scope.scrollToMessage();$(templateId+' .selIndex').html($scope.markIndex+1)};$scope.clearValue=function(){$(templateId+" #highlighter").val('');$(templateId+" #clearInput").hide();$scope.arrayMark=[];$scope.markIndex=0;$(templateId+' .resultBox').addClass('dnone');$(templateId+' .trasncription-section mark').each(function(){this.outerHTML=this.innerHTML})};$scope.scrollToMessage=function(){let msgTop=$(templateId)[0].querySelector('mark.selected').closest('.sunoh-transcription').offsetTop;$(templateId+' .trasncription-section').animate({scrollTop:msgTop},300)};$scope.resetAllLangField=function(){$(templateId+' .pref-lang-section').removeClass('disabled-list');$(templateId+' .lang-chbx,'+templateId+' .lang-dialect-radio,'+templateId+' .sunoh-pref-lang').prop('checked',false);$scope.localLang=[];$scope.isLangSelected=false;$scope.preferLangSelected=false;$scope.isLanguageVisible=false;$(templateId+' .sunoh-lang-list').removeClass(['disabled-list-active','disabled-list'])};$scope.openSunohLangSetting=function(){if($(templateId+' .select-language-transcription-panel').hasClass('dnone')){$(templateId+' .select-language-transcription-panel').removeClass('dnone').position({of:$(templateId+" .sunoh-setting-btn"),my:'left-320 bottom-35',at:'left bottom',collision:"flipfit"}).animate({"opacity":1},100);$scope.resetAllLangField();if($scope.providerDefaultLangCode&&$scope.providerDefaultLangCode!==""){let ele=$(templateId+' #lang'+$scope.providerDefaultLang);ele.closest(templateId+' .language-master-list').animate({scrollTop:ele[0].offsetTop-150},300);ele.trigger('click');setTimeout(function(){let defaultLangCodeEle=$(templateId+' #'+$scope.providerDefaultLangCode);defaultLangCodeEle.closest(templateId+' .lang-dialects').animate({scrollTop:defaultLangCodeEle[0].offsetTop-160},300);defaultLangCodeEle.click();$scope.isLangSelected=true;$(templateId+' #defaultLangCheck').prop('checked',true)})}else{if($scope.languageRegion.length>0){$scope.preferLangSelected=true;let ele=$(templateId+' #lang'+$scope.preferLangJSON.language);ele.closest(templateId+' .language-master-list').animate({scrollTop:ele[0].offsetTop-150},300);ele.trigger('click');setTimeout(function(){let defaultLangCodeEle=$(templateId+' #'+$scope.preferLangJSON.languageCode);defaultLangCodeEle.closest(templateId+' .lang-dialects').animate({scrollTop:defaultLangCodeEle[0].offsetTop-160},300);defaultLangCodeEle.click();$scope.isDirtyLangSelection=false;$scope.isLangSelected=true})}$scope.isSaveBtnVisible=false;$(templateId+' .sunoh-pref-lang').prop('checked',false)}}else{$(templateId+' .select-language-transcription-panel').addClass('dnone');$scope.isLanguageVisible=true}};$scope.enableChildLang=function(key,val,index){if(!$scope.isLangSelected){$scope.localLang=val;$scope.isLangSelected=true;$scope.selectedLanguage=key;$(templateId+" #lang"+index).addClass('disabled-list-active');$(templateId+' .sunoh-lang-list:not(.disabled-list-active)').addClass('disabled-list');setTimeout(function(){if($scope.localLang.length>0&&$scope.preferLangSelected===false){$(templateId+' .lang-dialect-radio').first().prop('checked',true);$scope.checkLang($scope.localLang[0])}if($(templateId+' .lang-chbx:checked').length>0&&$(templateId+' .child-language-master-list .lang-dialect-radio:checked').length==0){$scope.isSaveBtnVisible=false}else{$scope.isSaveBtnVisible=true}if($scope.$$phase!='$apply'&&$scope.$$phase!='$digest'){$scope.$apply()}})}else{$scope.isLangSelected=false;$scope.localLang=[];$scope.selectedLanguage="";$(templateId+" #lang"+index).removeClass('disabled-list-active');$(templateId+' .sunoh-lang-list').removeClass('disabled-list');$(templateId+' .sunoh-pref-lang').prop('checked',false);$scope.sessionLanguage="";$scope.selectedLocalLang={languageCode:'',languageId:0,languageRegion:""};$scope.preferLangSelected=false;$scope.isSaveBtnVisible=true;$(templateId+' .pref-lang-section').removeClass('disabled-list')}};$scope.checkLang=function(language){$scope.isDirtyLangSelection=true;$scope.isSaveBtnVisible=true;$scope.selectedLocalLang=language;if($scope.preferLangJSON.languageCode!==language.languageCode){$scope.preferLangSelected=false;$(templateId+' .sunoh-pref-lang').prop('checked',false);$(templateId+' .pref-lang-section').addClass('disabled-list')}else{$scope.preferLangSelected=true;$(templateId+' .sunoh-pref-lang').prop('checked',true);$(templateId+' .pref-lang-section').removeClass('disabled-list')}if($scope.providerDefaultLangCode===language.languageCode){$scope.isDirtyLangSelection=false}};$scope.selectPreferLang=function(){if($(templateId+' .sunoh-pref-lang').is(':checked')){$scope.preferLangSelected=true;let ele=$(templateId+' #lang'+$scope.preferLangJSON.language);ele.closest(templateId+' .language-master-list').animate({scrollTop:ele[0].offsetTop-150},300);ele.trigger('click');setTimeout(function(){let defaultLangCode=$(templateId+' #'+$scope.preferLangJSON.languageCode);defaultLangCode.closest(templateId+' .lang-dialects').animate({scrollTop:defaultLangCode[0].offsetTop-160},300);defaultLangCode.trigger('click');$scope.isDirtyLangSelection=true;$scope.isSaveBtnVisible=true})}else{$(templateId+' #lang'+$scope.preferLangJSON.language).trigger('click')}};$scope.saveLangSelected=function(){$scope.isDirtyLangSelection=false;$scope.sessionLanguage=$scope.selectedLocalLang.languageCode;$scope.languageRegion=$scope.selectedLocalLang.languageRegion;$scope.isLanguageVisible=true;let payload={userId:$scope.userId,patientId:$scope.patientId,selectedLocalLang:JSON.stringify($scope.selectedLocalLang),selectedLang:$scope.selectedLanguage,isDefaultSet:$(templateId+" #defaultLangCheck").is(":checked")};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/save-language'),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(saved){if($(templateId+" #defaultLangCheck").is(":checked")){$scope.providerDefaultLang=$scope.selectedLanguage;$scope.providerDefaultLangCode=$scope.selectedLocalLang.languageCode;$scope.preferLangJSON="";$(templateId+' .sunoh-pref-lang').prop('checked',false);$scope.isPreferedSelectionExist=false;$scope.preferLang="";$scope.preferLangRegion="";$scope.preferLangCode=""}else{$scope.selectedLocalLang['language']=$scope.selectedLanguage;$scope.preferLangJSON=$scope.selectedLocalLang;$(templateId+' .sunoh-pref-lang').prop('checked',false);$scope.isPreferedSelectionExist=true;$scope.preferLang=$scope.selectedLanguage;$scope.preferLangRegion=$scope.selectedLocalLang.languageRegion;$scope.preferLangCode=$scope.selectedLocalLang.languageCode;$scope.providerDefaultLang="";$scope.providerDefaultLangCode=""}$scope.isSaveBtnVisible=false});$(templateId+' .select-language-transcription-panel').addClass('dnone')};$scope.cancelLangSelection=function(){if($scope.isDirtyLangSelection){let message="Are you sure you want to discard the changes?";let title="<b>Language - Unsaved Changes Alert</b>";modernAlertFactory.warning({header:title,buttons:[{label:'Yes',cssClass:'pad3-10 btn btn-xs btn-primary',callbackEvent:function(){$scope.isDirtyLangSelection=false;$scope.isLanguageVisible=true;$(templateId+' .select-language-transcription-panel').addClass('dnone')}},{label:'No',cssClass:'pad3-10 btn btn-xs btn-secondary btn-secondary-sunoh'}],screenSpecificClass:'sunoh-lang-alert-modal max-sunoh-z-index sunohLangWarningModalWidth500',message:message})}else{$scope.isLanguageVisible=true;$(templateId+' .select-language-transcription-panel').addClass('dnone')}};$scope.openSunohSetting=function(){$(templateId+' .sunoh-setting-btn').popover({html:true,content:function(){return $compile($(templateId+" .sunoh-setting-section").html())($scope)},trigger:'focus',placement:"top"}).popover('show')};$scope.hideSunohSetting=function(){$(templateId+" .sunoh-setting-btn").popover('destroy')};$scope.openMicrophoneSetting=function(){var _that=this;$(templateId+' .microphone-setting-popup').show().animate({},100,function(){$(this).position({of:_that,my:'center-230 bottom+40',at:'center bottom',collision:"flipfit"}).animate({"opacity":1},100)})};$scope.closeSummaryPopover=function(){$(templateId+' .sumoh-summarize').addClass('dnone')};$scope.dockInRight=function(){$(templateId+' .doc-middle-sec').addClass('expandheight');$(templateId+' .search-transcript-modal').addClass('width-small-panel');$(templateId+' .sunoh-summary-date-section').css('flex-direction','column-reverse');$(templateId+' .sunohicons-rotate-img').removeClass('dnone');$(templateId+' .sunohicons-rgt-direct').addClass('dnone')};$scope.resetDockView=function(){$(templateId+' .doc-middle-sec').removeClass('expandheight');let transcriptModel=$(templateId+' .search-transcript-modal');transcriptModel.removeClass('width-small-panel');$(templateId+' .sunoh-summary-date-section').css('flex-direction','initial');$(templateId+' .sunohicons-rgt-direct').removeClass('dnone');$(templateId+' .sunohicons-rotate-img').addClass('dnone')};$scope.closePlaySection=function(){enableStartButton();sunohGlobal.recordingStarted=false;if($scope.isTaggingDone){$(templateId+' .discard-sunoh-section-prompt').removeClass('dnone')}else{sunohGlobal.isSessionActive=false;$scope.cleanup()}};$scope.preCleanup=function(){enableStartButton();$(templateId+' .blank-line').removeClass('dnone');navigator.mediaDevices.ondevicechange=null;$scope.isTaggingDone=false;$scope.isRecordingStart=false;sunohGlobal.recordingStarted=false;$scope.isRecordingPaused=false;$scope.isOutSidePN=false;$scope.isExitFromPlay=false;$(templateId+" #stopWidgetAudio,"+templateId+" #playSection,"+templateId+" .sunoh-loader,"+templateId+" .select-dropdown-panel").addClass(["dnone"]);$(templateId+" #startWidgetAudio").removeClass(["dnone","loading"]).addClass(["sunohicons-red-triangle","btn-circle-white"]);if($scope.stream&&$scope.stream.getTracks()){$scope.stream.getTracks()[0].stop()}$(templateId+' .sunoh-timer-digit').text('00:00');$scope.stopTimer();$scope.reconnectingAudio.pause()};$scope.cleanup=function(isRecoveryRequired){$scope.preCleanup();if($scope.aciAzure&&$scope.aciAzure.getSocket()){let socket=$scope.aciAzure.getSocket();if(socket.readyState===WebSocket.OPEN){$scope.aciAzure.stopStreaming(undefined,!isRecoveryRequired);socket.close()}}$scope.postCleanup()};$scope.postCleanup=function(){$(templateId+' .search-transcript-modal').addClass('dnone');$scope.$destroy()};$scope.isSectionHiddenForStructData=function(sectionName){if(sectionName==='Examination'&&$scope.isExamHidden||sectionName==='SocialHistory'&&$scope.isSocialHxHidden||sectionName==='HPI'&&$scope.isHpiHidden||sectionName==='PreventiveMedicine'&&$scope.isPreventiveMedHidden){return true}return false};$scope.sectionListChange=function(event){const originalElement=event.target;let sectionName=$(originalElement).attr('section-name');$('[parent-section="'+sectionName+'"]').toggleClass("nobrdr");$('[parent-section="'+sectionName+'"]').children().toggleClass("d-none");$('[parent-section="'+sectionName+'"]').children().toggleClass("active-check");if(!$(originalElement).is(':checked')){$('.checkmark-circle[child-section="'+sectionName+'"]').removeClass("nobrdr");$('.checkmark-circle[child-section="'+sectionName+'"]').children().addClass("d-none");$('.checkmark-circle[child-section="'+sectionName+'"]').children().removeClass("active-check");$('.stDataCheckBox[section-name="'+sectionName+'"]').prop('checked',false);$("#selSectionCheck").prop('checked',false)}else{$('.checkmark-circle[child-section="'+sectionName+'"]').addClass("nobrdr");$('.checkmark-circle[child-section="'+sectionName+'"]').children().removeClass("d-none");$('.checkmark-circle[child-section="'+sectionName+'"]').children().addClass("active-check");$('.stDataCheckBox[section-name="'+sectionName+'"]').each(function(){if($(this).css('display')!=='none'){$(this).prop('checked',true)}})}};$scope.stDataChange=function(event){const originalElement=event.target;let propId=$(originalElement).attr('propId');let sectionName=$(originalElement).attr('section-name');if(!$(originalElement).is(':checked')){$('.checkmark-circle[propId="'+propId+'"]').removeClass("nobrdr");$('.checkmark-circle[propId="'+propId+'"]').children().addClass("d-none");$('.checkmark-circle[propId="'+propId+'"]').children().removeClass("active-check");$('.sectionlist-checkbox[section-name="'+sectionName+'"]').prop('checked',false);$('[parent-section="'+sectionName+'"]').removeClass("nobrdr");$('[parent-section="'+sectionName+'"]').children().addClass("d-none");$('[parent-section="'+sectionName+'"]').children().removeClass("active-check");$("#selSectionCheck").prop('checked',false)}else{$('.checkmark-circle[propId="'+propId+'"]').addClass("nobrdr");$('.checkmark-circle[propId="'+propId+'"]').children().removeClass("d-none");$('.checkmark-circle[propId="'+propId+'"]').children().addClass("active-check")}};$scope.deleteCurrentSession=function(){$(templateId+' .discard-sunoh-section-prompt').addClass('dnone');$(templateId+" #sunoh_timer,"+templateId+" .sunoh-widget-stop,"+templateId+" #audiovisualizer").addClass("dnone");sunohGlobal.instanceCounter[$scope.encounterId+$scope.type]['status']=0;$scope.stopTimer();if(sourceConversation||analyserConversation){sourceConversation.disconnect();analyserConversation.disconnect()}sunohGlobal.isSessionActive=false;localStorage.removeItem("sunohSession");clearInterval($scope.sessionRefresInterval);$scope.cleanup()};$scope.closeSunohSessionAlert=function(){$(templateId+' .discard-sunoh-section-prompt').addClass('dnone')};$scope.closeSummary=function(){if(!sunohGlobal.recordingStarted){$(templateId+" #startWidgetAudio").removeClass(["dnone"]).addClass(["sunohicons-red-triangle","btn-circle-white"]);$(templateId+" #sunoh_timer,"+templateId+" .sunoh-widget-stop, "+templateId+" #audiovisualizer, "+templateId+" #play-section, "+templateId+" .play-section").addClass("dnone");$(templateId+' .blank-line').removeClass('dnone');$(templateId+' #viewSummary').hide();$(templateId+' .sunoh-timer-digit').text('00:00')}};$scope.scribeMiscellaneousData=function(){$scope.isInputChanges=false;$(templateId+" #sunohDropDown").addClass('selection-options');$scope.isGenerateNoteCall=true;let scribeNote=$(templateId+' #retainNoteSunohTextArea').val();$scope.commitNote(scribeNote);if($scope.isDefaultCategorySet){$(templateId+' #retainNoteSunohTextArea').val("")}};$scope.commitNote=function(scribeNote){if(scribeNote.length>0){if($scope.isDefaultCategorySet){let textarea=$('<textarea></textarea>',{id:'txtEdit',css:{display:'none'}});$scope.isGenerateNoteCall=true;$(templateId+' #sunohScribeACIModule').append(textarea);$(templateId+' #txtEdit').val(scribeNote);var params={TrUserId:$scope.userId,pnencid:$scope.encounterId,ptId:$scope.patientId,pnType:scribe_scribePanel_strPnType,callingFrom:'sunoh'};myScribePanelSharedService.strParams=$.param(params);myScribePanelSharedService.getRelevantData('sunoh',templateId);$(templateId+' #txtEdit').remove()}else{$(templateId+' .default-cat-alert').removeClass('dnone').animate({},100,function(){$(templateId+' .default-cat-alert').position({of:event.currentTarget,my:'center bottom-35',at:'center bottom',collision:"flipfit"}).animate({"opacity":1},100)})}}};$scope.hideDefaultCatAlert=function(){$(templateId+' .default-cat-alert').addClass('dnone')};$scope.defaultCatModal;$scope.openDefaultCategoriesModal=function(){$scope.hideDefaultCatAlert();$ocLazyLoad.load({name:'scribeDefaultCategoriesModule',files:['/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/ScribeDefaultCategoriesContoller.js'],cache:false}).then(function(){var url=makeURL("/mobiledoc/jsp/webemr/progressnotes/physiciansdashboard/ScribeDefaultCategories.jsp?pnencid="+$scope.encounterId+""+"&TrUserId="+$scope.userId+"&ptId="+$scope.patientId+"&style=Bulleted&back=scribePanel&isDefaultCategorySet=false&context=sunoh");$scope.defaultCatModal=$modal.open({templateUrl:url,controller:'scribeDefaultCategoriesController',windowClass:'app-modal-window bluetheme sunoh',backdrop:"static"})},function(e){sunohGlobal.log(e)})};$scope.openSunohSpeechModel=function(){$scope.hideSunohSetting();$scope.cleanup();sharedServiceSunoh.openSunohSpeechModel()};$scope.openSunohAssistantSetupModel=function(){$scope.hideSunohSetting();$scope.cleanup();sharedServiceSunoh.openSunohAssistantSetupModel()};$scope.updateWidgetPosition=function(){let visiblePlayEl=$(templateId+' .palying-section:visible');let top=visiblePlayEl.css('top');let left=visiblePlayEl.css('left');$(templateId+' .palying-section').css({'top':top,'left':left})};$scope.closeSunohSpeechModal=function(){sharedServiceSunoh.closeSunohSpeechModal()};$scope.sunohScribeNote=function(){const checkboxes=$(templateId)[0].querySelectorAll('.summaryCheck');let scribeNote='';var miscellaneous='';if($scope.showSummaryTab){checkboxes.forEach(checkbox=>{if(checkbox.checked){switch(checkbox.name){case'hpi':if($scope.gptAnalysis['HPIContentType']&&$scope.gptAnalysis['HPIContentType']==='html'){scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #hpiSunohTextArea').html()+'\n\n'}else{scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #hpiSunohTextArea').val()+'\n\n'}break;case'exam':if(!$scope.visionVisitFlag){scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n";scribeNote=scribeNote+'\n'+$scope.gptAnalysis.exam+'\n\n';if($(templateId+' #exam-merge-default').prop('checked')){let categoryName=$scope.examList[$scope.examDefaultValue].split('--\x3e');scribeNote=scribeNote+categoryName[1]+' under '+categoryName[0]+':'+'\n';scribeNote=scribeNote+'\n'+'merge default'+'\n'}}else{myScribePanelSharedService.isVisionImportRequired=true;scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n";scribeNote=scribeNote+'\n'+''+'\n\n'}break;case'medical Hx':if($scope.gptAnalysis['medicalHxContentType']&&$scope.gptAnalysis['medicalHxContentType']==='html'){scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #medicalHxSunohTextArea').html()+'\n\n'}else{scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #medicalHxSunohTextArea').val()+'\n\n'}break;case'vitals':if($scope.gptAnalysis['vitalsDataContentType']&&$scope.gptAnalysis['vitalsDataContentType']==='html'){scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #vitalsSunohTextArea').html()+'\n\n'}else{scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #vitalsSunohTextArea').val()+'\n\n'}break;case'social Hx':if($scope.gptAnalysis['socialHxContentType']&&$scope.gptAnalysis['socialHxContentType']==='html'){scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #socialHxSunohTextArea').html()+'\n\n'}else{scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #socialHxSunohTextArea').val()+'\n\n'}break;case'family Hx':if($scope.gptAnalysis['familyHxContentType']&&$scope.gptAnalysis['familyHxContentType']==='html'){scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #familyHxSunohTextArea').html()+'\n\n'}else{scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #familyHxSunohTextArea').val()+'\n\n'}break;case'surgical Hx':if($scope.gptAnalysis['surgicalHxContentType']&&$scope.gptAnalysis['surgicalHxContentType']==='html'){scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #surgicalHxSunohTextArea').html()+'\n\n'}else{scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #surgicalHxSunohTextArea').val()+'\n\n'}break;case'hospitalization':if($scope.gptAnalysis['hospitalizationContentType']&&$scope.gptAnalysis['hospitalizationContentType']==='html'){scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #hospitalizationSunohTextArea').html()+'\n\n'}else{scribeNote=scribeNote+'\n'+checkbox.name+":"+"\n"+$(templateId+' #hospitalizationSunohTextArea').val()+'\n\n'}break;case'followup':if($scope.gptAnalysis['follow_up_planContentType']&&$scope.gptAnalysis['follow_up_planContentType']==='html'){scribeNote=scribeNote+'\nNext appointment:\n '+$(templateId+' #followupSunohTextArea').html()}else{scribeNote=scribeNote+'\nNext appointment:\n '+$(templateId+' #followupSunohTextArea').val()}break;case'retainSunoh':miscellaneous=$(templateId+' #retainNoteSunohTextArea').val()+'\n\n';if($scope.isDefaultCategorySet){$scope.retainSunoh=false;$scope.retainQuickCheck=false;$(templateId+' #retainNoteSunohTextArea').val("")}break;case'treatmentNote':scribeNote=scribeNote+'\nTreatment Notes:\n';if($scope.gptAnalysis['treatmentNoteContentType']&&$scope.gptAnalysis['treatmentNoteContentType']==='html'){scribeNote=scribeNote+$(templateId+' #treatmentNoteSunohTextArea').html()+'\n\n'}else{scribeNote=scribeNote+$(templateId+' #treatmentNoteSunohTextArea').val()+'\n\n'}break;default:break}}});if(miscellaneous.trim().length>0){scribeNote=scribeNote+"\n"+miscellaneous+'\n\n'}if($scope.visionVisitFlag&&!$scope.isExamImported&&myScribePanelSharedService.isVisionImportRequired){try{let parser=new DOMParser;let dom=parser.parseFromString($scope.gptAnalysis.exam,'text/html');const table=dom.querySelector("table");let response=setObservationsForFieldsFromHTML($scope.encounterId,table.outerHTML.replaceAll(/<br\/>|<br><\/br>|<br>/gi,'\n'));response=JSON.parse(response);if(response.status==='error'){myScribePanelSharedService.isVisionImportRequired=false;let searchExamStr='\n'+"exam:"+"\n"+'\n'+''+'\n\n';scribeNote=scribeNote.replace(searchExamStr,'');if(response.validations&&response.validations.length>0){$modal.open({template:`
                                    <div class="modal-header">
                                        <h4 class="modal-title">Validation Error</h4>
                                    </div>
                                    <div class="modal-body">
                                        <div class="idt">
                                            <div class="idt-info-container">
                                                <span class="idt-notice">The following needs to be addressed before continuing:</span>
                                                <br>
                                                <div class="idt-table-container">
                                                    <table class="table table-bordered blue-fade-table nomargin idt-table">
                                                        <thead>
                                                        <tr>
                                                            <th width="5%">#</th>
                                                            <th width="30%">Validation</th>
                                                            <th width="30%">Entered</th>
                                                            <th width="50%">Allowed</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <tr ng-repeat="validation in validations">
                                                            <td width="5%"><span ng-bind="::$index + 1"></span></td>
                                                            <td width="30%"><span ng-bind="::validation.type"></span></td>
                                                            <td width="30%"><span ng-bind="::validation.entered"></span></td>
                                                            <td width="50%"><span ng-bind="::validation.allowed"></span></td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <div class="pull-right">
                                            <button id="idtCancelBtn" type="button" class="btn btn-xs btn-sm btn-blue" ng-click="doCancel()">OK</button>
                                        </div>
                                    </div>
                                `,controller:function($scope,scDtList){$scope.validations=scDtList;$scope.doCancel=function(){$scope.$dismiss()}},scope:$scope,windowClass:`bluetheme medium-width idt-alert`,backdrop:"static",keyboard:false,resolve:{scDtList:function(){return response.validations}}});return}}}catch(e){}}$scope.isInputChanges=false;$(templateId+" #sunohDropDown").addClass('selection-options');$scope.commitNote(scribeNote)}if($scope.showStructureTab){let importedFormIds=[];$('.stDataCheckBox').each(function(){if($(this).is(':checked')&&$(this).css('display')!=='none'){if($('.checkmark-circle[propId="'+$(this).attr('propId')+'"]').closest('.structured-data-body').find(".sunoh-error:visible").length===0){const structList=$scope.structItems.filter(item=>String(item.propId)===String($(this).attr('propId')));$(this).prop('checked',false);importedFormIds.push(structList[0].propId);$scope.saveStructureData(structList)}else{let structList=$scope.structItems.filter(item=>String(item.propId)===String($(this).attr('propId')));notification.show('info-msg','Sunoh',structList[0].title+' could not be merged because of invalid responses.',4e3)}}});setTimeout(function(){if(importedFormIds.length>0){$scope.saveImportLog(importedFormIds)}})}};let setObservationsForFieldsFromHTML=function(encounterId,htmlStr,categoryId){const fieldsAndObservationsJSON=(new X2JS).xml_str2json(htmlStr);if(fieldsAndObservationsJSON){if(!categoryId){categoryId=getUserProfile('eyeExamDefaultCategory')}if(categoryId<=0){return'{"status": "error"}'}let param={operation:"addObservationsSunoh",encounterId:encounterId,fieldsAndObservationsJSON:JSON.stringify(fieldsAndObservationsJSON),categoryId:categoryId};let url=makeURL('/mobiledoc/jsp/webemr/progressnotes/usvision/visionexam/setVisionExamData.jsp');return urlPost(url,param)}else{return'{"status": "error"}'}};$scope.setIsChanged=function(){$scope.isInputChanges=true;$(templateId+" #sunohDropDown").removeClass('selection-options')};$scope.addedSectionScribe=function(section,id,allCheck){$scope.isInputChanges=true;$(templateId+" #sunohDropDown").removeClass('selection-options');if(allCheck===true){$scope.hpiSunoh=true;$scope.hpiQuickCheck=true;$scope.examSunoh=true;$scope.examQuickCheck=true;$scope.medicalHxSunoh=true;$scope.medicalQuickCheck=true;$scope.socialHxSunoh=true;$scope.treatmentNoteSunoh=true;$scope.socialHxQuickCheck=true;$scope.familyHxSunoh=true;$scope.familyHxQuickCheck=true;$scope.surgicalHxSunoh=true;$scope.surgicalHxQuickCheck=true;$scope.hospitalizationSunoh=true;$scope.hospitalizationQuickCheck=true;$scope.followupSunoh=true;$scope.followupQuickCheck=true;$scope.retainSunoh=true;$scope.retainQuickCheck=true;$scope.treamentNoteQuickCheck=true;$scope.vitalsSunoh=true;$scope.vitalsQuickCheck=true;$(templateId+" #hpiSunohTextArea").removeClass('purple-textarea');$(templateId+" #familyHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #examSunohTextArea").removeClass('purple-textarea');$(templateId+" #medicalHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #socialHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #surgicalHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #followupSunohTextArea").removeClass('purple-textarea');$(templateId+" #hospitalizationSunohTextArea,"+templateId+" #treatmentNoteSunohTextArea,"+templateId+" #vitalsSunohTextArea").removeClass('purple-textarea');$(templateId+" #hpiSunohTextArea").addClass('white-sunoh-textarea');$(templateId+" #familyHxSunohTextArea").addClass('white-sunoh-textarea');$(templateId+" #examSunohTextArea").addClass('white-sunoh-textarea');$(templateId+" #medicalHxSunohTextArea").addClass('white-sunoh-textarea');$(templateId+" #socialHxSunohTextArea").addClass('white-sunoh-textarea');$(templateId+" #surgicalHxSunohTextArea").addClass('white-sunoh-textarea');$(templateId+" #followupSunohTextArea").addClass('white-sunoh-textarea');$(templateId+" #hospitalizationSunohTextArea,"+templateId+" #treatmentNoteSunohTextArea,"+templateId+" #vitalsSunohTextArea").addClass('white-sunoh-textarea');return}if(allCheck===false){$scope.hpiSunoh=false;$scope.hpiQuickCheck=false;$scope.examSunoh=false;$scope.examQuickCheck=false;$scope.medicalHxSunoh=false;$scope.medicalQuickCheck=false;$scope.socialHxSunoh=false;$scope.socialHxQuickCheck=false;$scope.treatmentNoteSunoh=false;$scope.treamentNoteQuickCheck=false;$scope.familyHxSunoh=false;$scope.familyHxQuickCheck=false;$scope.surgicalHxSunoh=false;$scope.surgicalHxQuickCheck=false;$scope.hospitalizationSunoh=false;$scope.hospitalizationQuickCheck=false;$scope.followupSunoh=false;$scope.followupQuickCheck=false;$scope.retainSunoh=false;$scope.retainQuickCheck=false;$scope.vitalsSunoh=false;$scope.vitalsQuickCheck=false;return}if(allCheck===undefined){if(id==='retainSunoh'){if(!$scope.retainSunoh){$scope.retainSunoh=true;$scope.retainQuickCheck=true}else{$scope.retainSunoh=false;$scope.retainQuickCheck=false}}else if(id==='retainQuickCheck'){if(!$scope.retainQuickCheck){$scope.retainSunoh=true;$scope.retainQuickCheck=true}else{$scope.retainSunoh=false;$scope.retainQuickCheck=false}}else if(id==='hpiSunoh'){if(!$scope.hpiSunoh){$scope.hpiSunoh=true;$scope.hpiQuickCheck=true;$(templateId+" #hpiSunohTextArea").removeClass('purple-textarea');$(templateId+" #hpiSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.hpiSunoh=false;$scope.hpiQuickCheck=false}}else if(id==='hpiQuickCheck'){if(!$scope.hpiQuickCheck){$scope.hpiSunoh=true;$scope.hpiQuickCheck=true;$(templateId+" #hpiSunohTextArea").removeClass('purple-textarea');$(templateId+" #hpiSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.hpiSunoh=false;$scope.hpiQuickCheck=false}}else if(id==='examSunoh'){if(!$scope.examSunoh){$scope.examSunoh=true;$scope.examQuickCheck=true;$(templateId+" #examSunohTextArea").removeClass('purple-textarea');$(templateId+" #examSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.examSunoh=false;$scope.examQuickCheck=false}}else if(id==='examQuickCheck'){if(!$scope.examQuickCheck){$scope.examSunoh=true;$scope.examQuickCheck=true;$(templateId+" #examSunohTextArea").removeClass('purple-textarea');$(templateId+" #examSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.examSunoh=false;$scope.examQuickCheck=false}}else if(id==='medicalHxSunoh'){if(!$scope.medicalHxSunoh){$scope.medicalHxSunoh=true;$scope.medicalQuickCheck=true;$(templateId+" #medicalHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #medicalHxSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.medicalHxSunoh=false;$scope.medicalQuickCheck=false}}else if(id==='medicalQuickCheck'){if(!$scope.medicalQuickCheck){$scope.medicalHxSunoh=true;$scope.medicalQuickCheck=true;$(templateId+" #medicalHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #medicalHxSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.medicalHxSunoh=false;$scope.medicalQuickCheck=false}}else if(id==='socialHxSunoh'){if(!$scope.socialHxSunoh){$scope.socialHxSunoh=true;$scope.socialHxQuickCheck=true;$(templateId+" #socialHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #socialHxSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.socialHxSunoh=false;$scope.socialHxQuickCheck=false}}else if(id==='socialHxQuickCheck'){if(!$scope.socialHxQuickCheck){$scope.socialHxSunoh=true;$scope.socialHxQuickCheck=true;$(templateId+" #socialHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #socialHxSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.socialHxSunoh=false;$scope.socialHxQuickCheck=false}}else if(id==='familyHxSunoh'){if(!$scope.familyHxSunoh){$scope.familyHxSunoh=true;$scope.familyHxQuickCheck=true;$(templateId+" #familyHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #familyHxSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.familyHxSunoh=false;$scope.familyHxQuickCheck=false}}else if(id==='familyHxQuickCheck'){if(!$scope.familyHxQuickCheck){$scope.familyHxSunoh=true;$scope.familyHxQuickCheck=true;$(templateId+" #familyHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #familyHxSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.familyHxSunoh=false;$scope.familyHxQuickCheck=false}}else if(id==='surgicalHxSunoh'){if(!$scope.surgicalHxSunoh){$scope.surgicalHxSunoh=true;$scope.surgicalHxQuickCheck=true;$(templateId+" #surgicalHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #surgicalHxSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.surgicalHxSunoh=false;$scope.surgicalHxQuickCheck=false}}else if(id==='surgicalHxQuickCheck'){if(!$scope.surgicalHxQuickCheck){$scope.surgicalHxSunoh=true;$scope.surgicalHxQuickCheck=true;$(templateId+" #surgicalHxSunohTextArea").removeClass('purple-textarea');$(templateId+" #surgicalHxSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.surgicalHxSunoh=false;$scope.surgicalHxQuickCheck=false}}else if(id==='vitalsSunoh'){if(!$scope.vitalsSunoh){$scope.vitalsSunoh=true;$scope.vitalsQuickCheck=true;$(templateId+" #vitalsSunohTextArea").removeClass('purple-textarea');$(templateId+" #vitalsSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.vitalsSunoh=false;$scope.vitalsQuickCheck=false}}else if(id==='vitalsQuickCheck'){if(!$scope.vitalsQuickCheck){$scope.vitalsSunoh=true;$scope.vitalsQuickCheck=true;$(templateId+" #vitalsSunohTextArea").removeClass('purple-textarea');$(templateId+" #vitalsSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.vitalsSunoh=false;$scope.vitalsQuickCheck=false}}else if(id==='hospitalizationSunoh'){if(!$scope.hospitalizationSunoh){$scope.hospitalizationSunoh=true;$scope.hospitalizationQuickCheck=true;$(templateId+" #hospitalizationSunohTextArea").removeClass('purple-textarea');$(templateId+" #hospitalizationSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.hospitalizationSunoh=false;$scope.hospitalizationQuickCheck=false}}else if(id==='hospitalizationQuickCheck'){if(!$scope.hospitalizationQuickCheck){$scope.hospitalizationSunoh=true;$scope.hospitalizationQuickCheck=true;$(templateId+" #hospitalizationSunohTextArea").removeClass('purple-textarea');$(templateId+" #hospitalizationSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.hospitalizationSunoh=false;$scope.hospitalizationQuickCheck=false}}else if(id==='followupSunoh'){if(!$scope.followupSunoh){$scope.followupSunoh=true;$scope.followupQuickCheck=true;$(templateId+" #followupSunohTextArea").removeClass('purple-textarea');$(templateId+" #followupSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.followupSunoh=false;$scope.followupQuickCheck=false}}else if(id==='followupQuickCheck'){if(!$scope.followupQuickCheck){$scope.followupSunoh=true;$scope.followupQuickCheck=true;$(templateId+" #followupSunohTextArea").removeClass('purple-textarea');$(templateId+" #followupSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.followupSunoh=false;$scope.followupQuickCheck=false}}else if(id==='treatmentNoteSunoh'){if(!$scope.treatmentNoteSunoh){$scope.treatmentNoteSunoh=true;$(templateId+" #treatmentNoteSunohTextArea").removeClass('purple-textarea');$(templateId+" #treatmentNoteSunohTextArea").addClass('white-sunoh-textarea')}else{$scope.treatmentNoteSunoh=false}}}};$scope.allCheckQuickSec=function(){let allCheck=$(templateId+' #allCheck')[0];const quickSectionCheck=$(templateId)[0].querySelectorAll('.sunohPN');$scope.addedSectionScribe('','',$(templateId+" #allCheck").prop('checked'));for(let i=0;i<quickSectionCheck.length;i++){quickSectionCheck[i].addEventListener('change',function(){let allChecked=true;for(let j=0;j<quickSectionCheck.length;j++){if(!quickSectionCheck[j].checked){allChecked=false;break}}allCheck.checked=allChecked})}};$scope.openCloseSectionList=function(){if($(".quickSectionMenu").is(":visible")){$(".quickSectionMenu").hide()}else{$(".quickSectionMenu").show()}};$scope.stDataSelectSections=function(event){let elem=event.target;let setValue=false;if($(elem).is(':checked')){setValue=true}$(".sectionlist-checkbox, .stDataCheckBox").each(function(){if(!$(this).is(":disabled")){$(this).prop("checked",setValue)}});if(setValue){$('div[child-section]').addClass("nobrdr");$('div[child-section]').children().removeClass("d-none");$('div[child-section]').children().addClass("active-check");$('div[parent-section]').addClass("nobrdr");$('div[parent-section]').children().removeClass("d-none");$('div[parent-section]').children().addClass("active-check")}else{$('div[child-section]').removeClass("nobrdr");$('div[child-section]').children().addClass("d-none");$('div[child-section]').children().removeClass("active-check");$('div[parent-section]').removeClass("nobrdr");$('div[parent-section]').children().addClass("d-none");$('div[parent-section]').children().removeClass("active-check")}};$scope.checkUnCheckQuickSec=function(){if($(templateId+' .quickSectionMenu').css('display')=='none'){$(templateId+" .quickSectionMenu").show()}};$scope.openSmartForm=function(formID){let tabsPanelScope=angular.element($('#tabspanel')).scope();let formObj={};formObj.id=formID;if(formID>0){tabsPanelScope.openSmartForm(formObj)}};$scope.sendInitializationMessageToWs=function(){$scope.aciAzure.sendSunohWsMessage(JSON.stringify({sunohTxId:$scope.sunohRecordId.toString()}));$scope.aciAzure.sendSunohWsMessage(JSON.stringify({sunohStatusId:$scope.sunohRecordId,sunohCallMeta:true,sunohClientInfo:sunohGlobal.getBrowserAndOSInfo(),encDate:$scope.encObj.encDate+' '+$scope.encObj.encTime}));if($scope.isSunohStructDataEnabled==='yes'&&$scope.stDataMappedFormIds.length>0){$scope.aciAzure.sendSunohWsMessage(JSON.stringify({sunohStructDataCall:true,sunohStatusId:$scope.sunohRecordId,structDataFormIds:$scope.stDataMappedFormIds,encDate:$scope.encObj.encDate+' '+$scope.encObj.encTime}))}};$scope.setCurrentStatusOfCall=function(status){var sunohStatusId=0;if(status==='discard'){sunohStatusId=$scope.sunohRecordId}let requiredParams={encId:$scope.encounterId,TrUserId:global.TrUserId,status:status,sunohRecordId:sunohStatusId,secondaryLanguage:$scope.languageRegion.length>0?$scope.languageRegion:null};$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},Accept:"text/plain",url:makeURL("/mobiledoc/modules/webemr/sunoh/saveSunohStatus"),method:'POST',data:$.param(requiredParams)}).success(function(data){$scope.sunohRecordId=data.id;$scope.stDataMappedFormIds=data.stDataMappedFormIds;if(status==='running'){$scope.sendInitializationMessageToWs()}})};$scope.outProgressNoteBroadcastForSunoh=function(){if($(templateId+' #playSection').length===0){return}if($scope.isExitFromPlay){$scope.isExitFromPlay=false}else{if($scope.isGenerateNoteCall){return}if(!$scope.isTaggingDone){$scope.cleanup();return}$(templateId+' .sumoh-summarize').addClass('dnone');if($(templateId+' #viewSummary').css('display')!=='none'){$scope.cleanup();$scope.closeSummary()}else if($(templateId+' #playSection').hasClass('dnone')===false||$(templateId+' #summaryGenerated').css('display')!=='none'){$scope.isOutSidePN=true;$scope.updateTopPosForAlert()}}};$scope.getImportLogSunoh=function(data){$scope.updateImportdataScopes(data);$scope.refreshProgressNote()};$scope.prepForBroadcastForSunoh=function(encounterId){if($(templateId+' #playSection').length===0){return}$(templateId+' .sumoh-summarize').addClass('dnone');if($scope.encounterId===encounterId){$scope.isOutSidePN=false;$scope.updateTopPosForAlert()}else{if($(templateId+' #viewSummary').css('display')!=='none'){$scope.cleanup();$scope.closeSummary()}else if($(templateId+' #playSection').hasClass('dnone')===false||$(templateId+' #summaryGenerated').css('display')!=='none'){$scope.isOutSidePN=true;$scope.updateTopPosForAlert()}}};$scope.openPNForSunoh=function(){doChecksForPN($scope.encounterId,$scope.patientId,$http,'ovLoader')};$scope.asmtUserProfileKeyValue={};$scope.assistantCommand=[];$scope.loggedInUserName="";$scope.getLoggedInUserName=function(name){if(name){return name}else{return $scope.loggedInUserName}};$scope.showTranscriptTab=true;function resetSunohAssistantScope(){$scope.previouslyRunCommand=[];$scope.alreadyExecutedAssistantCommandResponse=[];$scope.showTranscriptTab=true;$scope.showSunohTab=false}$scope.switchTabSunohSummaryLeftPanel=function(tabType){if(tabType==="summary"){$scope.showSummaryTab=true;$scope.showStructureTab=false;$(templateId+" #showSummaryTab").addClass('active');$(templateId+" #showStructureTab").removeClass('active');$(templateId+" #quickSectionMenuDiv").parent().css("bottom","340px")}else if(tabType==="structure"){$scope.showStructureTab=true;$scope.showSummaryTab=false;$(templateId+" #showStructureTab").addClass('active');$(templateId+" #showSummaryTab").removeClass('active');setTimeout(function(){bottom=$("#quickSectionMenuDiv").height()+50;$(templateId+" #quickSectionMenuDiv").parent().css("bottom",bottom+"px")})}};$scope.switchTabSunohSummaryRightPanel=function(tabType){if(tabType==="transcriptTab"){$scope.showSunohTab=false;$scope.showTranscriptTab=true;$(templateId+" #transcriptTab").addClass('active');$(templateId+" #sunohTab").removeClass('active')}else if(tabType==="sunohTab"){let trasncriptionHeight=$(templateId+' .trasncription-section').outerHeight()+54;if($scope.isSecondaryLangExists){trasncriptionHeight=trasncriptionHeight+33}$(templateId+' .trasncription-section.sunoh-assistant-section').attr("style","height: "+trasncriptionHeight+"px !important;");$scope.showTranscriptTab=false;$scope.showSunohTab=true;$(templateId+" #transcriptTab").removeClass('active');$(templateId+" #sunohTab").addClass('active')}safeApplyScope()};$scope.sunohAssistantCommand=function(){if($scope.previouslyRunCommand.length>0){return}$scope.assistantCommand=[];$scope.showGetAssistantCommandLoader=true;let dataUrl=makeURL("/mobiledoc/modules/webemr/sunoh/assistant/command/"+$scope.encounterId);$.ajax({url:dataUrl,type:'GET',success:function(response){$scope.showGetAssistantCommandLoader=false;if(response.error_msg){safeApplyScope();notification.show('info-msg','Sunoh Assistant ',response.error_msg,4e3);return}$scope.assistantCommand=response;$scope.loggedInUserName=getUserfullnameFromId(global.TrUserId);safeApplyScope()},error:function(request,textStatus,errorThrown){$scope.showGetAssistantCommandLoader=false;safeApplyScope();notification.show('info-msg','Sunoh Assistant ','Something went wrong, please try again!',4e3)}}).fail(function(jqXHR,textStatus,errorThrown){$scope.showGetAssistantCommandLoader=false;safeApplyScope();notification.show('info-msg','Sunoh Assistant ','Something went wrong, please try again!',4e3)})};function getSunohAssessmentSectionMapping(){return{'summary':{'gptAnalysisKey':'summary','notificationName':'Conversation Summary','isImported':false},'history_of_present_illness':{'gptAnalysisKey':'HPI','notificationName':'HPI','isImported':$scope.isHPIImported},'history_of_present_illness_short':{'gptAnalysisKey':'HPI_Short','notificationName':'HPI','isImported':false},'medical_history':{'gptAnalysisKey':'medicalHx','notificationName':'Medical History','isImported':$scope.isMedHxImported},'surgical_history':{'gptAnalysisKey':'surgicalHx','notificationName':'Surgical History','isImported':$scope.isSurgicalHxImported},'hospitalization_history':{'gptAnalysisKey':'hospitalization','notificationName':'Hospitalization History','isImported':$scope.isHospitalizationImported},'family_history':{'gptAnalysisKey':'familyHx','notificationName':'Family History','isImported':$scope.isFamilyHxImported},'social_history':{'gptAnalysisKey':'socialHx','notificationName':'Social History','isImported':$scope.isSocialHxImported},'vitals':{'gptAnalysisKey':'vitalsData','notificationName':'Vitals','isImported':$scope.isVitalsImported},'examination':{'gptAnalysisKey':'exam','notificationName':'Examination','isImported':$scope.isExamImported},'treatment_plan':{'gptAnalysisKey':'treatmentNote','notificationName':'Treatment Plan','isImported':$scope.isTreatmentNoteImported},'follow_up_plan':{'gptAnalysisKey':'follow_up_plan','notificationName':'Next Appointment','isImported':$scope.isFollowUpImported}}}$scope.previouslyRunCommand=[];$scope.alreadyExecutedAssistantCommandResponse=[];$scope.currentExecutedAssistantCommand={};$scope.showLoaderAssistantCommand=false;$scope.executeAssistantCommand=function(command){const currentCommandObj=$.extend(true,{},command);if($scope.showLoaderAssistantCommand){return}$scope.showLoaderAssistantCommand=true;$scope.currentExecutedAssistantCommand=command;const sunohAssessmentSectionMapping=getSunohAssessmentSectionMapping();let summary=$scope.getSelectedSectionsForSunohAssistant();let params={encounterId:$scope.encounterId,recordingId:$scope.selectedTrxId,sunohStatusId:$scope.sunohRecordId,summary:summary,commandId:command.commandId,commandName:command.commandName,commandKey:command.commandKey,commandType:command.commandType};if(command.commandKey==='examinationMergeDefault'){params.pnType=scribe_scribePanel_strPnType;let scribeNote='\nexam:\n';scribeNote=scribeNote+$(templateId+' #examSunohTextArea').val();let categoryName=$scope.examList[$scope.examDefaultValue].split('--\x3e');scribeNote='\n'+scribeNote+'\n'+categoryName[1]+' under '+categoryName[0]+':'+'\n';scribeNote=scribeNote+'merge default'+'\n';params.examNotes=scribeNote}params=JSON.stringify(params);$.ajax({url:makeURL("/mobiledoc/modules/webemr/sunoh/assistant/execute"),type:'POST',data:params,headers:{'Content-Type':'application/json'},success:function(response){result=response;const defaultMsg='Something went wrong, please try again!';if(!result){notification.show('info-msg','Sunoh Assistant ',defaultMsg,4e3);$scope.showLoaderAssistantCommand=false;$scope.currentExecutedAssistantCommand={};safeApplyScope();return}let resSummary=JSON.parse(result.summary);if(resSummary&&resSummary.error_msg){const msg=resSummary.error_msg?resSummary.error_msg:defaultMsg;$scope.showLoaderAssistantCommand=false;$scope.currentExecutedAssistantCommand={};currentCommandObj.endUtc=resSummary.endUtc;currentCommandObj.startUtc=resSummary.startUtc;currentCommandObj.commandMessage=msg;currentCommandObj.showalertbubble=true;$scope.alreadyExecutedAssistantCommandResponse.push(currentCommandObj);moveCommandToPreviouslyExecutedCommand(currentCommandObj);safeApplyScope();return}let executedCommandResult=result.assistantExecuteCommandLog;executedCommandResult.commandName=command.commandName;if(command.commandType===3){if(command.commandKey==='examinationMergeDefault'&&$scope.isExamImported){let message="Notes have already been generated for Examination section.";$scope.importedSectionResponse(executedCommandResult,message)}else{$scope.handleSystemCommand(resSummary,command,executedCommandResult)}}const jsonResult=$scope.getGPTJsonResponse(resSummary);let importedSectionList='';if(jsonResult){for(let type in jsonResult){let realSectionType=sunohAssessmentSectionMapping[type];if(!realSectionType){continue}if(realSectionType.isImported){importedSectionList+=realSectionType.notificationName+" ,";continue}}if(importedSectionList){if(importedSectionList.endsWith(',')){importedSectionList=importedSectionList.slice(0,-1)}let message="Notes have already been generated for "+importedSectionList+" sections.";$scope.importedSectionResponse(executedCommandResult,message)}else{for(let type in jsonResult){let realSectionType=sunohAssessmentSectionMapping[type];if(!realSectionType){continue}$scope.gptAnalysis[realSectionType.gptAnalysisKey+'ContentType']=jsonResult[type].content_type;if(realSectionType.gptAnalysisKey==='follow_up_plan'){$scope.gptAnalysis[realSectionType.gptAnalysisKey].text=jsonResult[type].content}else{$scope.gptAnalysis[realSectionType.gptAnalysisKey]=jsonResult[type].content}}$scope.alreadyExecutedAssistantCommandResponse.push(executedCommandResult);$scope.setIsChanged()}}$scope.showLoaderAssistantCommand=false;moveCommandToPreviouslyExecutedCommand(command);safeApplyScope()},error:function(request,textStatus,errorThrown){$scope.showLoaderAssistantCommand=false;safeApplyScope();notification.show('info-msg','Sunoh Assistant ','Something went wrong, please try again!',4e3)}}).fail(function(jqXHR,textStatus,errorThrown){$scope.showLoaderAssistantCommand=false;safeApplyScope();notification.show('info-msg','Sunoh Assistant ','Something went wrong, please try again!',4e3)})};$scope.importedSectionResponse=function(executedCommandResult,message){executedCommandResult.showalertbubble=true;executedCommandResult.commandMessage=message;$scope.alreadyExecutedAssistantCommandResponse.push(executedCommandResult)};$scope.handleSystemCommand=function(summary,command,executedCommandResult){if(command.commandKey==='examinationMergeDefault'&&summary.systemResponse&&summary.systemResponse.length>0){$scope.gptAnalysis['exam']=summary.systemResponse;$scope.strechingTextArea();$scope.alreadyExecutedAssistantCommandResponse.push(executedCommandResult);$scope.showLoaderAssistantCommand=false;moveCommandToPreviouslyExecutedCommand(command);safeApplyScope()}return};$scope.getGPTJsonResponse=function(resSummary){try{const gptResp=JSON.parse(resSummary.gpt_response);if(gptResp.response){return gptResp.response}return gptResp}catch(e){}};function moveCommandToPreviouslyExecutedCommand(command){let isCommandPresent=$scope.assistantCommand.findIndex(a=>a.commandId===command.commandId);if(isCommandPresent!==-1){$scope.assistantCommand.splice(isCommandPresent,1)}const isPreviouslyRunCommand=$scope.previouslyRunCommand.findIndex(a=>a.commandId===command.commandId);if(isPreviouslyRunCommand===-1){$scope.previouslyRunCommand.push(command)}safeApplyScope()}$scope.getSelectedSectionsForSunohAssistant=function(){const notesObj={};notesObj['allergies']=$scope.gptAnalysis['allergies'];notesObj['diagnosis']=$scope.gptAnalysis['diagnosis'];notesObj['diagnostic_imaging_or_procedures']=$scope.gptAnalysis['diagnostic_imaging_or_procedures'];notesObj['examination']=$scope.gptAnalysis['exam'];notesObj['existing_medications']=$scope.gptAnalysis['existingMeds'];notesObj['family_details']=$scope.gptAnalysis['family_details'];notesObj['family_history']=$scope.gptAnalysis['familyHx'];notesObj['follow_up_plan']=$scope.gptAnalysis.follow_up_plan.text;notesObj['gyn_history']=$scope.gptAnalysis['gyn_history'];notesObj['history_of_present_illness']=$scope.gptAnalysis['HPI'];notesObj['history_of_present_illness_short']=$scope.gptAnalysis['HPI_Short'];notesObj['hospitalization_history']=$scope.gptAnalysis['hospitalization'];notesObj['immunizations']=$scope.gptAnalysis['immunizations'];notesObj['lab_tests']=$scope.gptAnalysis['lab_tests'];notesObj['medical_history']=$scope.gptAnalysis['medicalHx'];notesObj['new_medications']=$scope.gptAnalysis['new_medications'];notesObj['ob_history']=$scope.gptAnalysis['ob_history'];notesObj['referral']=$scope.gptAnalysis['referral'];notesObj['review_of_systems']=$scope.gptAnalysis['review_of_systems'];notesObj['social_history']=$scope.gptAnalysis['socialHx'];notesObj['summary']=$scope.gptAnalysis['summary'];notesObj['surgical_history']=$scope.gptAnalysis['surgicalHx'];notesObj['treatment_plan']=$scope.gptAnalysis['treatmentNote'];notesObj['vitals']=$scope.gptAnalysis['vitalsData'];notesObj['patient_reported_vitals']=$scope.gptAnalysis['patient_reported_vitals'];return JSON.stringify(notesObj)};$scope.getFirstAssessmentFromSearch=function(diagnosis){let indexArray=[];if(diagnosis.length===0){$scope.stopLoading(indexArray,diagnosis)}for(let index=0;index<diagnosis.length;index++){if(diagnosis[index].trash===true){indexArray.push(index);$scope.stopLoading(indexArray,diagnosis);continue}let diagnosisDetail=diagnosis[index].value.name;if(diagnosis[index].value!==''&&!diagnosisDetail.includes('[')&&!diagnosisDetail.includes(']')){$scope.getItemsIMO('',diagnosisDetail,index,indexArray,diagnosis)}else{$scope.getItemsIMO('',diagnosis[index].key,index,indexArray,diagnosis)}}};$scope.stopLoading=function(indexArray,diagnosis){if(indexArray.length===diagnosis.length){angular.forEach($scope.savedTreatmentNotes,function(obj){let data=$scope.treatmentNotesDataArr.find(item=>obj.value.itemId!==0&&item.value.itemId===obj.value.itemId||item.value.name===obj.value.name&&(!item.value.ICD10&&item.value.code===obj.value.code||item.value.ICD10&&item.value.ICD10===obj.value.code));if(data){data.isSaved=true;data.notesArr=angular.copy(obj.notesArr)}else{$scope.treatmentNotesDataArr.push(angular.copy(obj))}});$scope.updateTreatmentPlansArr();angular.forEach(diagnosis,function(value){if(!$scope.masterDiagnosisArr.find(item=>item.key===value.key)){$scope.masterDiagnosisArr.push(angular.copy(value))}let valueObject=angular.copy(value);let index=$scope.treatmentNotesDataArr.findIndex(obj=>obj.key===valueObject.key||obj.value.name===valueObject.value.name&&valueObject.value.ICD10===obj.value.code);valueObject.isSaved=false;$scope.setNAOtherValueForTreatmentObject(valueObject);if(index>=0){let tObj=$scope.treatmentNotesDataArr[index];valueObject.isICDSaved=tObj.isICDSaved;valueObject.notesArr=tObj.notesArr;valueObject.itemid=tObj.itemid;if(valueObject.trash&&valueObject.type==='treatmentplan'){$scope.treatmentNotesDataArr[index]=angular.copy(valueObject);return}else{$scope.treatmentNotesDataArr[index].key=valueObject.key}}else{let index=$scope.savedAssessments.findIndex(obj=>obj.key===valueObject.key);if(index>=0){let data=$scope.treatmentNotesDataArr[index];data.trash=valueObject.trash;if(valueObject.trash){data.key=valueObject.key;data.value.trashNotes=valueObject.value.trashNotes}$scope.treatmentNotesDataArr[index]=angular.copy(data)}else{valueObject.notesArr=[];valueObject.isICDSaved=false;$scope.treatmentNotesDataArr.push(angular.copy(valueObject))}}});setNotesInTreatmentPlan();$scope.setNAOtherValueForTreatmentObject();setNotesToNAOtherIfAssessmentIsDeletedFromPN();$(templateId+" .treatmentNotesLoader").addClass("dnone");$scope.isTreatmentDataDisplay=true;manageAssessmentForOrders();$scope.strechingTextArea();$ocLazyLoad.load({name:'assessment',files:['/mobiledoc/jsp/webemr/progressnotes/billing/assessmentNotes-tpl.js','/mobiledoc/jsp/webemr/progressnotes/assessment/assessmentcontroller.js']}).then(function(){placeHolder="#inlineAsmtURL";url="/mobiledoc/jsp/webemr/progressnotes/templates/inlineassessment.jsp?encounterId="+$scope.encounterId+"&patientId="+$scope.patientId+"&sunohContext=yes&dc="+moment().toString();$(templateId+" #sunohInlineDx").removeClass("dnone");addDynamicContent(templateId+" #sunohInlineDx",url,"Assessment:");$(templateId+" .assessmentLoader").addClass("dnone")})}};let setNotesToNAOtherIfAssessmentIsDeletedFromPN=function(){if($scope.treatmentNotesDataArr){let length=$scope.treatmentNotesDataArr.length;if(length>1){let naObject=$scope.treatmentNotesDataArr[length-1];let indexArray=[];$scope.treatmentNotesDataArr.forEach((obj,index)=>{if(!obj.key&&obj!==naObject&&$scope.savedAssessments.findIndex(obj1=>obj1.value.name===obj.value.name)<0&&$scope.sunohAssessmentList.findIndex(obj1=>obj1.value.name===obj.value.name||obj.value.name===obj1.key)<0){if(obj.notesArr&&obj.notesArr.length>0){if(naObject.notesArr){obj.notesArr.forEach(notes=>{naObject.notesArr.push(notes)})}else{naObject.notesArr=angular.copy(obj.notesArr)}}indexArray.push(index)}});let count=0;indexArray.forEach(index=>{$scope.treatmentNotesDataArr.splice(index-count,1);count=count+1})}}};$scope.setNAOtherValueForTreatmentObject=function(object){let dataObj=$scope.encDxList[$scope.encDxList.length-1];let obj={"ICD10":dataObj.dxItemCode,"name":dataObj.dxItemName,"itemId":dataObj.dxItemId};if(object){if(object.trash){object.isSaved=false}if(!object.value||object.value===''){let dataObj=$scope.encDxList[$scope.encDxList.length-1];let obj={"ICD10":dataObj.dxItemCode,"name":dataObj.dxItemName,"itemId":dataObj.dxItemId};object.value=obj}return}else{let existingData=$scope.treatmentNotesDataArr.find(item=>item.value.itemId===0&&item.value.name===obj.name&&(obj.key===null||obj.key===undefined));let value={};value.value=obj;value.isSaved=false;if(existingData){const index=$scope.treatmentNotesDataArr.findIndex(item=>item.value.itemId===0&&item.value.name===obj.name&&(item.key===null||item.key===undefined));if(index>-1){$scope.treatmentNotesDataArr.splice(index,1)}value.notesArr=angular.copy(existingData.notesArr)}$scope.treatmentNotesDataArr.push(value)}};$scope.getItemsIMO=function(searchBy,searchText,index,indexArray,diagnosis){$scope.imoCounter=1;$scope.imoMaxCount=1;$scope.imoVendorCode='IMO';var url='/mobiledoc/jsp/catalog/xml/IMO/DoSmartICDSearch.jsp?vendorcode='+$scope.imoVendorCode;url=url+'&searchby='+searchBy;url=url+'&search='+searchText;url=url+"&ncounter="+$scope.imoCounter;url=url+"&maxcount="+$scope.imoMaxCount;url=url+'&parentId=0';url=url+'&useicd10=1';if($scope.encounterId&&$scope.encounterId>0){url=url+"&encounterId="+$scope.encounterId}url=url+"&patientId="+($scope.patientId&&$scope.patientId>0?$scope.patientId:"-1");url=url+"&userId="+global.TrUserId;url=makeURL(url);$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url}).then(function(response){var x2js=new X2JS;var data=response.data;var imoJson=x2js.xml_str2json(data);$scope.items=[];if(imoJson&&imoJson.Envelope&&imoJson.Envelope.Body&&imoJson.Envelope.Body["return"]&&imoJson.Envelope.Body["return"].status==="success"){$scope.items=returnDataArray(imoJson.Envelope.Body["return"].ICDCodes.icd)}liIndex=-1;if($scope.items.length>0){$scope.gptAnalysis.diagnosis[index].value=$scope.items[0]}else{$scope.gptAnalysis.diagnosis[index].value=''}indexArray.push(index);$scope.stopLoading(indexArray,diagnosis)},function(response){ecwAlert("An error occurred while loading assessments.")})};let isLabOrder=function(type){return type==='lab'};let isRxOrder=function(type){return type==='rx'};let displayDxOptions=function(order,index,type){order.showDx=true;setTimeout(function(){let id=isLabOrder(type)?'dxOrderOptionsLab':'dxOrderOptionsDiProc';if(type==='rx'){id="dxOrderOptionsRx"}document.getElementById(id+index).scrollIntoView({behavior:'smooth',block:'nearest'})})};$scope.resetMultipleSuggestedOrderObject=function(){angular.forEach($scope.gptAnalysis.lab_tests,function(order){order.recommendedSuggesion.selectedAsstIds=[]});angular.forEach($scope.gptAnalysis.diagnostic_imaging_or_procedures,function(order){order.recommendedSuggesion.selectedAsstIds=[]})};$scope.viewSunohSetting=function(){$scope.hideSunohSetting();$scope.cleanup();openSunohSettingModal()};let openSunohSettingModal=function(){$ocLazyLoad.load({files:['/mobiledoc/jsp/webemr/sunoh/settings/sunohSettingsController.js','/mobiledoc/jsp/webemr/sunoh/css/sunoh-settings.css']}).then(function(){var modalInstance=$modal.open({templateUrl:'/mobiledoc/jsp/webemr/sunoh/settings/sunoh-settings.html',controller:'sunohSettingsController',controllerAs:'sunohSettings',size:'lg',windowClass:'app-modal-window bluetheme sunoh sunoh-setting-main-modal',backdrop:'static',keyboard:false,resolve:{requestParam:function(){let requestParam=[];return requestParam}}});modalInstance.result.then(function(){},function(response){})},function(e){sunohGlobal.log(e)})};$scope.viewAcceptAllOrders=function(){let dxReqObj={nPatientId:$scope.patientId,nTrUserId:$scope.userId,nEncounterId:$scope.encounterId,nDoctorId:EncDetailsService.getProviderId(),sContext:"SunohQuickOrders",nDxItemId:0,sActionType:""};if(!$scope.dxsDetails||!$scope.dxsDetails.list){var strUrl="/mobiledoc/jsp/webemr/labs/LabsRequestHandler.jsp?QuickSearchFilterObj="+JSON.stringify(dxReqObj)+"&sRequestFrom=qsDirective&sRequestType=loadDxList&rnd2="+Math.random();var responsePromise=$http.post(makeURL(strUrl));responsePromise.success(function(data){$scope.dxsDetails={list:{}};$scope.dxsDetails.list.Dx=data.Dx;openAcceptAllModal()})}else{openAcceptAllModal()}};let openAcceptAllModal=function(){$ocLazyLoad.load({files:['/mobiledoc/jsp/webemr/sunoh/orders/sunohAcceptAllOrdersController.js','/mobiledoc/jsp/webemr/sunoh/css/accept-all-orders.css']}).then(function(){var modalInstance=$modal.open({templateUrl:'/mobiledoc/jsp/webemr/sunoh/orders/sunoh-accept-all-orders.html',controller:'sunohAcceptAllOrdersController',controllerAs:'sao',size:'lg',windowClass:'app-modal-window bluetheme sunoh',backdrop:'static',keyboard:false,resolve:{requestParam:function(){let requestParam=[];requestParam["patientId"]=$scope.patientId;requestParam["encounterId"]=$scope.encounterId;requestParam["dxDetails"]=$scope.dxsDetails.list.Dx;requestParam["labTests"]=$scope.gptAnalysis.lab_tests;requestParam["diProcedureTests"]=$scope.gptAnalysis.diagnostic_imaging_or_procedures;requestParam["orderConfigAssmtMandatory"]=$scope.orderConfigAssmtMandatory;requestParam["selectSingleAssessment"]=$scope.selectSingleAssessment;return requestParam}}});modalInstance.result.then(function(){},function(response){$scope.gptAnalysis.lab_tests=response.labTests;$scope.gptAnalysis.diagnostic_imaging_or_procedures=response.diProcedureTests;$scope.resetMultipleSuggestedOrderObject()})},function(e){sunohGlobal.log(e)})};$scope.showDxOptionForOrder=function(order,index,type){displayDxOptions(order,index,type)};$scope.closeDxOrderOption=function(order){order.showDx=false};$scope.openLabRequestForm=function(){$scope.bottomPanelPopUrl="";$ocLazyLoad.load({name:"labRequestForm",cache:true,files:['/mobiledoc/jsp/webemr/progressnotes/labRequestForm/labRequestFormController.js','/mobiledoc/jsp/webemr/templates/savePrompt-tpl.js']}).then(function(){var url="/mobiledoc/jsp/webemr/progressnotes/labRequestForm/labRequestForm.jsp?encounterId="+$scope.encounterId+"&patientId="+$scope.patientId+"&context=progressNote";$scope.bottomPanelPopUrl=makeURL(url);$('.dropup').removeClass('open')},function(e){console.log(e)})};$scope.tooltipOnOverflow=function(immName,id){if($('#'+id)[0].scrollWidth>$('#'+id)[0].clientWidth){$('#'+id)[0].setAttribute('title',immName)}else{$('#'+id)[0].removeAttribute('title')}};$scope.chkAssessmentForOrder=function(order,item){let dxAraay=order.selectDx;let dxItemsArray=order.selectDxItems;order.selectDx=dxAraay&&dxAraay.length>0?order.selectDx:[];if(order.selectDx.length>0&&order.selectDx.findIndex(dx=>parseInt(dx,10)===parseInt(item.dxItemId,10))>=0){return}let orderitemName=item.dxItemName+" - "+item.dxItemCode;order.selectDxItems=dxItemsArray&&dxItemsArray.length>0?order.selectDxItems:[];let naSelected=order.selectDx.length>0&&order.selectDx.findIndex(dx=>dx===0)>=0;if($scope.selectSingleAssessment==='0'||parseInt(item.dxItemId,10)===0||naSelected){order.selectDx=[];order.selectDxItems=[]}order.selectDx.push(item.dxItemId);order.selectDxItems.push({itemId:item.dxItemId,itemName:orderitemName});$scope.setDirtyFalg(true)};$scope.showDxPopUp=function(index,updateDxId,mainDivId){$('.treatmentPlanDx').hide();$('#'+mainDivId+index).css({position:'absolute',left:148,top:24}).show()};$scope.closeDxPopUp=function(){$('.treatmentPlanDx').hide()};$scope.deleteTreatmentNote=function(dxObj){$scope.saveTreatmentNotesInSunoh(dxObj,'true');this.strechingTextArea()};$scope.undoTreatmentNote=function(dxObj){$http({method:"GET",url:makeURL('/mobiledoc/modules/webemr/sunoh/undo/order'),params:{diagnosis:dxObj.key,summaryId:$scope.sunohSummaryId,type:'treatmentplan'}}).success(function(response){if(response===true){dxObj.trash=false}}).error(function(response){notification.show('error','','Treatment Note not able to undo.',4e3)});this.strechingTextArea()};$scope.isNotAvailableInUpdateDxList=function(tPlanName,name,key){if(name==='Other'&&!tPlanName&&key!==undefined){return true}let n=tPlanName?tPlanName:name;return $scope.encDxList.findIndex(dx=>dx.dxItemName===n)>-1?false:true};$scope.acceptTreatmentNote=function(dxObj,index){var jsonObjForNotes={};jsonObjForNotes.indexId=index;jsonObjForNotes.DxItemId=dxObj.value.itemId;jsonObjForNotes.strNotes=$("#treatementNote_txt_"+index).val();$scope.saveTreatmentNotes(jsonObjForNotes,dxObj,'false')};$scope.saveTreatmentNotesInSunoh=function(obj,isTrash,notes){let assessmentData=obj.value;let icdCode=assessmentData.tPlanICD10?assessmentData.tPlanICD10:assessmentData.tPlanCode?assessmentData.tPlanCode:assessmentData.ICD10?assessmentData.ICD10:assessmentData.code;let icdName=assessmentData.tPlanName?assessmentData.tPlanName:assessmentData.name;let icdData=icdCode+' - '+icdName;let transactionData=isTrash==='true'?JSON.stringify(assessmentData):null;let strNotes;if(notes){strNotes=notes}else{strNotes=obj.gptNotes}let diagnosis=obj.key;let itemId=assessmentData.tPlanItemId!==undefined?assessmentData.tPlanItemId:assessmentData.itemId;if(itemId<0){itemId=obj.itemId}if(itemId===undefined||itemId<0){let existingObj=$scope.treatmentNotesDataArr.find(item=>item.value!==null&&item.value.name===obj.value.name&&item.isICDSaved===true);if(existingObj){itemId=existingObj.value.itemId}}if(isTrash==="false"){let existingSuggested=gptSuggestedTreatmentPlan.find(item=>obj.key===item.diagnosis);if(existingSuggested){obj.isAccepted=true}}let payload={encounterId:$scope.encounterId,sunohSummaryId:$scope.sunohSummaryId,diagnosis:diagnosis,icdData:icdData,itemId:itemId,isTrash:isTrash,transactionData:transactionData,notes:strNotes,isAcceptForGPT:obj.isAccepted};let payloadArray=[];payloadArray.push(payload);$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/save/treatmentplan'),data:payloadArray,headers:{'Content-Type':'application/json'}}).success(function(response){if(response){if(isTrash==='true'){obj.trash=true;obj.value.trashNotes=strNotes;obj.isSaved=false;obj.type="treatmentplan";return}itemId=''+itemId;let existingObj;if(itemId=="0"){existingObj=$scope.treatmentNotesDataArr.find(item=>""+item.value.itemId===itemId&&(item.key==null||item.key===undefined))}else{existingObj=$scope.treatmentNotesDataArr.find(item=>""+item.value.itemId===itemId&&item.isICDSaved===true)}if(existingObj){if(!(!existingObj.key&&existingObj.value.name==='Other')){existingObj.isSaved=true;existingObj.type='treatmentplan'}let newNotes={notes:strNotes,tooltip:'Treatment plan merged by '+getUserFullNameWithSuffix()+' on '+$scope.formatDate(new Date)};if(!existingObj.notesArr){existingObj.notesArr=[]}existingObj.notesArr.push(newNotes)}if(assessmentData.tPlanItemId){if(obj.gptNotes&&obj.gptNotes!==''){obj.gptNotes=''}else if(obj.notes&&obj.notes!==''){obj.notes=''}}notification.show('success','','Treatment Plan saved successfully.',4e3);$scope.strechingTextArea();$scope.refreshProgressNote()}else{notification.show('error','','Treatment Plan not saved.',4e3)}}).error(function(error){notification.show('error','','Treatment Plan not saved.',4e3)})};$scope.saveTreatmentNotes=function(jsonObjForNotes,obj,isTrash){const assessmentData=obj.value;if(obj.gptNotes&&obj.gptNotes!==''&&(!assessmentData.tPlanName||assessmentData.tPlanName===assessmentData.name)){obj.isAccepted=true;obj.isAcceptForGPT='true'}let icdCode=assessmentData.tPlanICD10?assessmentData.tPlanICD10:assessmentData.tPlanCode?assessmentData.tPlanCode:assessmentData.ICD10?assessmentData.ICD10:assessmentData.code;var nEncounterId=$scope.encounterId;var nTrUserId=global.TrUserId;var strNotes=obj.gptNotes;obj.gptNotes='';if(nEncounterId>0&&nTrUserId>0){obj.notes=strNotes;$scope.currentSelectedDx=obj;let payload={encounterId:$scope.encounterId,code:icdCode,name:assessmentData.tPlanName?assessmentData.tPlanName:assessmentData.name,note:strNotes,ptId:$scope.patientId};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/pn/save/treatmentplan'),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){if(response.status==='saved'){$scope.saveTreatmentNotesInSunoh(obj,isTrash,strNotes)}else if(response.status==='concurrency'){let warningMessage="<table class='custom-error-dialog' style='width: 568px'> "+"<tbody> "+"<tr> "+"<td style='width: 12%; background-color: #fbce2a;'> "+"<i class='iconblack fa fa-2x fa-exclamation-triangle' style='margin-left: 15px;'></i>"+"</td> "+"<td style='padding-left: 10px;'> "+"<div style='font-weight: bold; font-size: 16px;margin-bottom: 18px;margin-top: 10px;'></div> "+"<div style='font-size: 13px;'> "+response.concurrencyMsg+"</div> "+"<div style='float:right;margin: 10px;'>"+"<button id='okErrorButtonId' style='margin-right: 10px;' class='btn btn-blue btn-xs close-dialog' data-dismiss='modal'>OK</button>"+"</div>"+"</td> "+"</tr> "+"</tbody> "+"</table> ";showCustomAlertPopup(warningMessage,"okErrorButtonId","500px")}else{notification.show('error','','Treatment Plan not saved.',4e3)}}).error(function(){if(error){notification.show('error','','Treatment Plan not saved.',4e3)}})}};$scope.getAsmtId=function(medication,defaultDxId){let asmtId=defaultDxId;if(medication.selectDx&&medication.selectDx.length>0){asmtId=medication.selectDx[0]}return asmtId};function checkUndefinedOrNullOrBlank(value,shouldTrim){if(angular.isUndefined(value)){return true}if(value===null){return true}if(value===""){return true}if(shouldTrim&&value.trim()===""){return true}return false}$scope.openRxEdit=function(medication,possibleMatch,dx){$scope.rxOrderAcceptData=medication;let medObject=angular.copy(possibleMatch);medObject.assmtId=$scope.getAsmtId(medication,0);medication.showDx=false;if(typeof $scope.PNQSDetailsReqObj.sunohEditRx==="undefined"){let scopeValue=getQuickSearchScope();scopeValue.qsrequestObj.sunohEditRx(medObject)}else{$scope.PNQSDetailsReqObj.sunohEditRx(medObject)}};$scope.rxEditClicked=function(medication,possibleMatch,dx){if(medication.isOrdered!==1&&medication.isDeleted!==1&&possibleMatch.status==='Start'&&!$scope.isEncLocked){let popupClosed=$scope.closeAddRxForAnyRx();if(popupClosed){setTimeout(()=>{$scope.checkAllergyVerified(medication,possibleMatch,'openRxEdit')},300)}else{$scope.checkAllergyVerified(medication,possibleMatch,'openRxEdit')}}};$scope.acceptRx=function(medication,possibleMatch){let popupClosed=$scope.closeAddRxForAnyRx();if(popupClosed){setTimeout(()=>{$scope.checkAllergyVerified(medication,possibleMatch,'orderRx')},300)}else{$scope.checkAllergyVerified(medication,possibleMatch,'orderRx')}};$scope.checkAllergyVerified=function(param1,param2,callBackFn){if(!checkEnableAllergyVerification()){$scope[callBackFn](param1,param2);return}var url='/mobiledoc/emr/medication/checkAllergyStatus?encounterId='+$scope.encounterId;url=makeURL(url);$http({method:'POST',url:url,headers:{'Content-Type':'application/json'},data:{}}).then(function(data){if(checkUndefinedOrNullOrBlank(data.data.AllergiesFlag,true)||data.data.AllergiesFlag.toUpperCase()!=='Y'){showAlertMessage("<div class='text-left mt-24'><b>Ordering Medications - Verify Allergies</b><br/></br>Medication cannot be ordered because allergies have not been verified. Return to add the order once allergies have been verified.</div>",'','ErrorMsg');return}$scope[callBackFn](param1,param2)})};function checkEnableAllergyVerification(){return getItemKeyValue("EnablePriorAllergyVerificationPN").toUpperCase()==="YES"}function getQuickSearchScope(){let scopeValue="";let appElement=document.querySelector('.quick-search-modern-style');if(appElement){let scopeQuickSearch=angular.element(appElement).scope();scopeValue=scopeQuickSearch}return scopeValue}$scope.rxOrderAcceptData={};$scope.orderRx=function(medication,possibleMatch){$scope.rxOrderAcceptData=medication;let medObject=angular.copy(possibleMatch);medObject.assmtId=$scope.getAsmtId(medication,0);medication.showDx=false;if(medObject.addWithoutSign==='yes'){medObject.callFrom="addWithoutSig"}else{medObject.callFrom="sunohAcceptClick"}if(medObject.status==='Refill'||medObject.status==='Continue'){$scope.isMedOrderingForPastVist(medObject)}else if(medObject.status==='Stop'){$scope.saveExistingRxData(medObject)}else{if(typeof $scope.PNQSDetailsReqObj.sunohOrderRx==="undefined"){let scopeValue=getQuickSearchScope();scopeValue.qsrequestObj.sunohOrderRx(medObject)}else{$scope.PNQSDetailsReqObj.sunohOrderRx(medObject)}}};$scope.ShowMessageForPastVisitItemKey=getItemKeyValue("ShowMessageForPastVisit");$scope.isMedOrderingForPastVist=function(medObject){let encounterDateOfPN;var todayDate;try{let encDate=$scope.encObj.encDate;let encTime=$scope.encObj.encTime;encounterDateOfPN=new Date(validateAndConvertDate(encDate));if(!angular.isUndefined(encTime)&&encTime!==""){let timeUnits=[];timeUnits=encTime.split(":");encounterDateOfPN.setHours(timeUnits[0]);encounterDateOfPN.setMinutes(timeUnits[1]);encounterDateOfPN.setSeconds(timeUnits[2])}var todayDate=new Date;todayDate.setHours(0);todayDate.setMinutes(0);todayDate.setSeconds(0)}catch(e){encounterDateOfPN=new Date(encDate);encounterDateOfPN=encounterDateOfPN.toUTCString();todayDate=new Date;todayDate=todayDate.toUTCString()}if($scope.ShowMessageForPastVisitItemKey.toLowerCase()==="yes"){if(todayDate>encounterDateOfPN){let warningMsg="<b>Warning â€“ Adding Medications to Past Encounter</b></br></br>Medications added to past encounters may not reflect in the active medication list or the ICW (Right Chart Panel) and may need to be reconciled in subsequent encounters. Interaction checks will only consider medications from this encounter and Medications as of Today on the ICW. Would you like to proceed with ordering this medication?";showAlertMessage(warningMsg,'','ConfirmMsg','showMsgForPastVisitConfirm','rxPossibleMatch_'+$scope.rxRandomNumber);$scope.showMsgForPastVisitConfirm=function(btnAction){if(!angular.isUndefined(btnAction)&&btnAction!==null&&btnAction.toLowerCase()==='yes'){$scope.saveExistingRxData(medObject);return}}}else{$scope.saveExistingRxData(medObject);return}}else{$scope.saveExistingRxData(medObject);return}};$scope.isFirstTreatmentRx=function(){return rxService.isFirstTreatmentRx($scope.encounterId)};$scope.isCurrMedsVerified=function(){return rxService.isValidOffVisitForCurrentMeds($scope.encounterId,$scope.patientId)};let currMedsVerifiedCallbackBtn1="Bring forward patient's active medication list to Current Medication with the Previous Status";let currMedsVerifiedCallbackBtn2="Bring forward patient's active medication list to Current Medication with the Unknown Status";$scope.checkIfCurrMedsVerified=function(medObject){if($scope.isCurrMedsVerified()){let warningMsg="<b>Reconcile Current Medications</b></br></br>";warningMsg+="Records indicate that this patient may have been on some medication(s) which are not verified as of this encounter. One of the following actions is required to proceed further so that the patient's medication history is accurate.";let bottomNote="*To ensure that the current medication list is accurate and complete, go to Current Medications and perform medication reconciliation.";$timeout(function(){showAlertMessage(warningMsg,'','CustomConfirmMsg','currMedsVerifiedCallback','rxPossibleMatch_'+$scope.rxRandomNumber,'650px',currMedsVerifiedCallbackBtn1,currMedsVerifiedCallbackBtn2,'reconcileMedCurrRxAlert',bottomNote);$scope.currMedsVerifiedCallback=function(btnAction){let saveAsUnknown="";if(btnAction===currMedsVerifiedCallbackBtn2){saveAsUnknown="&saveAsUnknown=yes"}let url='/mobiledoc/jsp/catalog/xml/rx/copyCurrRx.jsp?ptid='+$scope.patientId;url+='&encid='+$scope.encounterId+'&encdate='+$scope.encObj.encDate+'&enctime='+$scope.encObj.encTime+'&PopulateMeds=False'+saveAsUnknown;$.ajax({type:"POST",url:makeURL(url),data:"","async":false,success:function(msg){if(msg.indexOf('success')>-1){$scope.skipCurrMedsVerified=true;$scope.saveExistingRxData(medObject);return}else{ecwAlert("An error occured in Reconciling Current Medications")}},error:function(xhr){ecwAlert("An error occured in Reconciling Current Medications: "+xhr.status+" "+xhr.statusText)}})}})}else{$scope.skipCurrMedsVerified=true;$scope.saveExistingRxData(medObject)}};function getRxTypeForSaveMed(medObject){let hNA="";if(medObject.status==='Refill'||medObject.rxStatus&&medObject.rxStatus.name==='Refill'){hNA="11"}else if(medObject.status==='Continue'||medObject.rxStatus&&medObject.rxStatus.name==='Continue'){hNA="2"}else if(medObject.status==='Stop'||medObject.rxStatus&&medObject.rxStatus.name==='Stop'){hNA="10"}return hNA}function getSaveMedParams(medObject){let rxPropertiesObj=getRxProperties();let hData={"supplierID":medObject.drugId?medObject.drugId:medObject.DrugNameId,"nEncId":$scope.encounterId,"preparedByID":0,"itemid":medObject.itemid?medObject.itemid:medObject.ItemId,"id":medObject.itemid?medObject.itemid:medObject.ItemId,"itemvalue":medObject.name?medObject.name:medObject.drugName?medObject.drugName:medObject.itemName,"assessId":medObject.assmtId?medObject.assmtId:medObject.assessId,"OldRxMainId":"","drugnameid":medObject.drugId?medObject.drugId:medObject.DrugNameId,"DoctorFlagName":"","PatientsFlag":0,"RxSourceId":medObject.RxSourceID?medObject.RxSourceID:global.TrUserId,"NDCCode":medObject.NDC?medObject.NDC:medObject.ndc,"StartDate":medObject.startDate?$filter('date')(medObject.startDate,'MM/dd/yyyy'):"","StopDate":medObject.stopDate?$filter('date')(medObject.stopDate,'MM/dd/yyyy'):"","StartDateWO":"","StopDateWO":"","PreparedBy":global.TrUserName,"RxNotes":medObject.RxNotes?medObject.RxNotes:medObject.RxEditNotesValue,"RxKOP":"No","RxDrugSource":"Pharmacy","RxOrderNo":medObject.RxOrderNo?medObject.RxOrderNo:medObject.rxOrderNumber,"RxSource":medObject.RxSource?medObject.RxSource:global.TrUserName,"disconorstopnotes":"","dataHash":0,"StrengthId":rxPropertiesObj.Size,"StrengthVal":medObject.dosage?medObject.dosage:medObject.strength,"FormulationId":rxPropertiesObj.Formulation,"FormulationVal":medObject.Formulation?medObject.Formulation:medObject.formulation,"TakeId":rxPropertiesObj.Take,"TakeVal":medObject.take,"RouteId":rxPropertiesObj.Route,"RouteVal":medObject.route,"FrequencyId":rxPropertiesObj.Frequency,"FrequencyVal":medObject.frequency?medObject.frequency:medObject.freq,"DurationId":rxPropertiesObj.Duration,"DurationVal":medObject.duration,"DispenseId":rxPropertiesObj.Amount,"DispenseVal":medObject.dispense,"RefillId":rxPropertiesObj.Refills,"RefillVal":medObject.refills,"displayIndex":0,"strName":"","MedsOfThisEnc":"","parentId":0,"sAdditionalRxNotes":null,"hasAdditionalInfo":null,"DAW":medObject.daw?medObject.daw:null,"doseCheckData":null,"AdditionalInstructions":medObject.AddInstructions?medObject.AddInstructions:null,"AdditionalInfoRxNotes":medObject.RxAdditionalNotes?medObject.RxAdditionalNotes:null};if($scope.encObj){if($scope.encObj.encDate){hData.medEncDate=validateAndConvertDate($scope.encObj.encDate)}if($scope.encObj.encTime){hData.medEncTime=$scope.encObj.encTime}}if(medObject.PharmacyNCPDPId){hData.PharmacyNCPDPId=medObject.PharmacyNCPDPId}if(medObject.pharmacyId){hData.pharmacyId=medObject.pharmacyId}if(medObject.callFrom){hData.callFrom=medObject.callFrom}return hData}function getRxDoctorFlag(medObject){let docFlag="0";if(medObject.callFrom==="sunohRxEditClick"){docFlag=medObject.rxStatus.Id}else{if(medObject.status==='Continue'){docFlag="2"}else if(medObject.status==='Refill'){docFlag=getItemKeyValue("RefillId",true)}else if(medObject.status==='Stop'){docFlag="0"}else if(medObject.status==='Start'){docFlag="1"}}return docFlag}$scope.acceptRxBtnToolTip=function(medication,dx,possibleMatch){if(!medication.isOrdered&&!medication.isDeleted&&possibleMatch.itemid!==''&&!medication.isAcceptEnable&&!$scope.isDxOther(dx)){return"Accept is disabled because the associated assessment has not been accepted and part of the progress note"}return""};$scope.showRxLoadingImage=function(){document.getElementById("divSaveRxDataLoading").style.display=""};$scope.hideRxLoadingImage=function(){document.getElementById("divSaveRxDataLoading").style.display="none";$(window).resize()};$scope.skipCurrMedsVerified=false;$scope.saveExistingRxData=function(medObject){let hNA=getRxTypeForSaveMed(medObject);if(hNA!=="10"&&$scope.isFirstTreatmentRx()&&!$scope.skipCurrMedsVerified){$scope.checkIfCurrMedsVerified(medObject);return}else{$scope.skipCurrMedsVerified=false}let hData=getSaveMedParams(medObject);let docFlag=getRxDoctorFlag(medObject);hData.DoctorFlag=docFlag;medObject.docFlag=docFlag;hData=JSON.stringify(hData);var params="&encid="+$scope.encounterId;params+="&EncounterId="+$scope.encounterId;params+="&hAssessId="+(medObject.assmtId?medObject.assmtId:medObject.assessId?medObject.assessId:0);params+="&hRefillVal=0";params+="&hUserIdVal="+global.TrUserId;params+="&hData="+escape(encodeURIComponent(hData));params+="&hasDelimiter=nodelimiter";params+="&patientId="+$scope.patientId;params+="&forceRefill=yes";params+="&requestFrom=saveMedSummary";$scope.showRxLoadingImage();$http({url:makeURL("/mobiledoc/emr/sunoh.ecw/accept-rx"),method:'POST',data:"hNA="+hNA+params}).success(function(msg){$scope.hideRxLoadingImage();if(msg){if(msg.indexOf("exists")>-1){ecwAlert("Cannot "+medObject.status+" the selected medication as it already added under the diagnosis")}else if(/^\s*(failed:NDCMismatch)/.test(msg)){let itemName=medObject.name;let msg="The medication(s) cannot be saved because the NDC for "+escapeHtml(itemName)+" is not correct.<br>You can either (1) click in the column under the triangle icon on the Treatment screen to update the NDC or (2) stop the medication and create a new order.";showAlertMessage(msg,'','ErrorMsg','','','600px')}else if(/^\s*(stoppedInFuture:)/.test(msg)){let msg="<b>Medication Summary - Cannot Refill or Continue</b></br></br>";msg+="This medication cannot be Refilled or Continued because the medication is stopped and is no longer on the patientâ€™s current medication list. The medication must be ordered as a new prescription.";showAlertMessage(msg,'','CustomErrorMsg','','','600px','','','warning-stoppedinfuture')}else{let rxFullName=medObject.name?medObject.name:medObject.drugName?medObject.drugName:medObject.itemName;if(medObject.dosage||medObject.strength){rxFullName=rxFullName+" "+(medObject.dosage?medObject.dosage:medObject.strength)}if(medObject.Formulation||medObject.formulation){rxFullName=rxFullName+" "+(medObject.Formulation?medObject.Formulation:medObject.formulation)}if(hNA==="10"){$scope.loadCancelRx(medObject.RxOrderNo,medObject.name?medObject.name:medObject.drugName?medObject.drugName:medObject.itemName,rxFullName)}$scope.sunohRxOrderAcceptClickedData(medObject,1);refreshDashboard($scope.encounterId,$scope.patientId,"","pn")}}}).error(function(){ecwAlert('Medication is not ordered!');$scope.hideRxLoadingImage()})};$scope.rxRandomNumber=Math.floor(Math.random()*Math.pow(10,3))+"";$scope.isCorrectionalFeaturesOn=getItemKeyValue("EnableCorrectionalFeatures").toLowerCase()==="yes";$scope.loadCancelRx=function(rxOrderNo,drugName,rxFullName){if($scope.isCorrectionalFeaturesOn===true||getItemKeyValue("EnableCancelRxForStoppedRx").toLowerCase()==='yes'){if(getItemKeyValue("EnableCancelRx").toLowerCase()==='yes'||getItemKeyValue("EnablePICancelRx").toLowerCase()==='yes'){if(getUserProfile("cancelRxAlert")==='1'){var cancelRxMsg="To send a cancellation request to the pharmacy, please click CANCEL for this medication and the appropriate pharmacy in the ePrescription Logs.";cancelRxMsg+="\n\n Would you like to open the ePrescription Logs?";BootstrapDialog.show({title:"Cancel Rx Alert",message:cancelRxMsg,closable:true,draggable:false,closeByBackdrop:false,closeByKeyboard:false,buttons:[{label:'Yes',action:function(dialog){dialog.close();$scope.openCancelRx(rxOrderNo,drugName)}},{label:'No',action:function(dialog){dialog.close()}}]})}else{notification.show('success','Medication Summary',''+escapeHtml(rxFullName)+' Stopped. To send a cancellation to the pharmacy go to Patient Hub > ePrescription Logs.',4e3)}}}};$scope.openCancelRx=function(rxOrderNo,drugName){$scope.eRxLogsURLFromSunohRx="";$ocLazyLoad.load({name:'myApp.Ejellybean.controllers',files:['/mobiledoc/jsp/webemr/jellybean/refillrequest/js/ejelly.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/RxFillIndicator.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/eRxMessageViewer.js','/mobiledoc/jsp/webemr/jellybean/refillrequest/js/commonRxRequest.js'],cache:false}).then(function(){let url='/mobiledoc/jsp/webemr/jellybean/ePrescription/ePrescriptionPtHub.jsp?pthub=yes&ptid='+$scope.patientId+'&rxOrderNo='+rxOrderNo+"&calledFrom=CancelRxRightChartPanel&drugName="+drugName;url=makeURL(url);$scope.eRxLogsURLFromSunohRx=url},function(e){})};$scope.deleteDraftedRx=function(medication){$scope.deleteRxOrder($scope.sunohSummaryId,medication.rxUUID,medication);medication.isDeleted=1};$scope.undoDeletedRx=function(medication){$scope.closeAddRxForAnyRx();$scope.undoRxOrder($scope.sunohSummaryId,medication.rxUUID);medication.isDeleted=0};$scope.isValidRxProperty=function(property){return!angular.isUndefined(property)&&_.trim(property)!==''&&property!=='NA'&&property!=='Not specified'&&property!=='Not mentioned'&&property!=='Blank'};$scope.resetAllDxObject=function(){$scope.dxsDetails={isCurrentDxActive:true,isPlActive:true,isPrevDxActive:true}};$scope.resetAllDxObject();$scope.getDxList=function(){$scope.resetAllDxObject();$scope.dxsDetails.list={};$scope.dxsDetails.list.Dx=$scope.getDiagnosesForEncounter();$scope.dxsDetails.list.Dx.push({id:0,name:"Others",medicalcode:'N/A'})};$scope.showDxOption=function(medication,index){$scope.getDxList();$scope.dxsDetails.list.Dx=$scope.getDiagnosesForEncounter();medication.showDx=true;setTimeout(function(){document.getElementById("dxOptions"+index).scrollIntoView()})};$scope.closeDxOption=function(medication){medication.showDx=false};$scope.chkAssessment=function(medication,item){medication.asmtId=item.id;medication.showDx=false};$scope.getSelectedDxName=function(medication){let dxFullName="";for(let i=0;medication.selectDxItems&&i<medication.selectDxItems.length&&dxFullName.length===0;i++){if(!medication.selectDxItems[i].trash){dxFullName=medication.selectDxItems[i].value.code+" - "+medication.selectDxItems[i].value.name}}return dxFullName};$scope.getCheckClassForOrder=function(order){let checkClass="sunohicons-check";if(order.isOrdered){checkClass="sunohicons-accept-check"}else if(order.isDeleted){checkClass="sunohicons-strike-check"}return checkClass};$scope.getSuggestedDxName=function(medication){let fullDxName='';let icd10Code=medication["ICD10 Code"];let reason=medication.reason;if(icd10Code!=='undefined'&&icd10Code!==undefined){fullDxName=icd10Code.replace("[","").replace("]","")+" - "}if(reason!=='undefined'&&reason!==undefined&&reason.length>0){fullDxName+=reason}return fullDxName};$scope.getWeHeardRxName=function(medication){let heardName='"';heardName+=medication.name;heardName+=$scope.isValidRxProperty(medication.strength)?" "+medication.strength:"";heardName+=$scope.isValidRxProperty(medication.form)?" "+medication.form:"";heardName+=$scope.isValidRxProperty(medication.frequency)?" "+medication.frequency:"";heardName+='"';return heardName};let x2js=new X2JS;$scope.getDiagnosesForEncounter=function(){let diagnoses=[];$.ajax({url:self.makeURL("/mobiledoc/jsp/catalog/xml/getAssessment.jsp?Id="+$scope.encounterId),method:'GET',dataType:'text',"async":false,headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}}).success(function(data){if(data!==undefined&&data!==''){let jsonData=x2js.xml_str2json(data);let diagnosesPrimary=self.returnDataArray(jsonData.Envelope.Body["return"].assessment.primary.code);let diagnosesSecondary=self.returnDataArray(jsonData.Envelope.Body["return"].assessment.secondary.code);for(let i=0;i<diagnosesPrimary.length;i++){diagnosesPrimary[i].primary=true;diagnoses.push(diagnosesPrimary[i])}for(let i=0;i<diagnosesSecondary.length;i++){diagnosesSecondary[i].primary=false;diagnoses.push(diagnosesSecondary[i])}}}).error(function(){throw"An error occurred while executing network-call of getDiagnosesForEncounter()"});return diagnoses};$scope.getFullRxName=function(possibleMatch){let fullRxName="";if(possibleMatch){fullRxName=possibleMatch.name+" "+possibleMatch.dosage+" "+possibleMatch.Formulation+" "+possibleMatch.take+" "+possibleMatch.route+" "+possibleMatch.frequency+" "+($scope.isValidRxProperty(possibleMatch.duration)?"for "+possibleMatch.duration:"")+" "+($scope.isValidRxProperty(possibleMatch.dispense)?", Dispense:"+possibleMatch.dispense:"")+" "+($scope.isValidRxProperty(possibleMatch.refills)?", Refills:"+possibleMatch.refills:"")}return fullRxName};$scope.getDrugNameIds=function(){let drugIds=[];for(let i=0;i<$scope.gptAnalysis.medications.length;i++){let possibleMatches=$scope.gptAnalysis.medications[i].possibleMatches;for(let j=0;possibleMatches!==undefined&&j<possibleMatches.length;j++){drugIds.push(possibleMatches[j].drugId)}}return drugIds};$scope.loadSuggestedMedications=function(){if(!$scope.isSunohStandalone){$scope.eRxLogsURLFromSunohRx="";showDxOrderLoaders();requestOrderRequestQueueCount++;$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},Accept:"text/plain",url:makeURL("/mobiledoc/modules/webemr/sunoh/mapRx"),method:'POST',data:$.param({cId:$scope.sunohSummaryId,encId:$scope.encounterId,isTv:$scope.isTVSummary})}).success(function(data){if(data){requestOrderRequestQueueCount--;hideDxOrderLoaders();$scope.gptAnalysis.medications=data.new_medications;let existingRxDetails=[];if(data.existing_medications){for(let i=0;i<data.existing_medications.length;i++){if(data.existing_medications[i].status==="Start"||data.existing_medications[i].status==="Continue"||data.existing_medications[i].status==="Refill"||data.existing_medications[i].status==="Stop"){existingRxDetails.push(data.existing_medications[i])}}if(existingRxDetails.length>0){$scope.gptAnalysis.medications=$scope.gptAnalysis.medications.concat(existingRxDetails)}}addDefaultDxForOrders($scope.gptAnalysis.medications);$scope.gptAnalysis.medications.forEach(order=>{if(order.isOrdered&&order.asmtId){order.selectDx=[parseInt(order.asmtId,10)]}})}})}};$scope.acceptRxOrder=function(medObj){let rxSunohStateDto={summaryId:$scope.sunohSummaryId,rxUUID:$scope.rxOrderAcceptData.rxUUID,drugName:medObj.drugName?medObj.drugName:medObj.name?medObj.name:medObj.itemName,strength:medObj.strength?medObj.strength:medObj.dosage,formulation:medObj.formulation?medObj.formulation:medObj.Formulation,take:medObj.take,route:medObj.route,frequency:medObj.frequency?medObj.frequency:medObj.freq,duration:medObj.duration,dispense:medObj.dispense,status:medObj.docFlag,itemId:medObj.ItemId?medObj.ItemId:medObj.itemID?medObj.itemID:medObj.itemid,assmntId:medObj.assmtId?medObj.assmtId:medObj.assessId,addInstructions:medObj.AddInstructions,refill:medObj.refills===""?null:medObj.refills};$http({url:makeURL("/mobiledoc/modules/webemr/sunoh/acceptSuggestedRx"),method:'POST',data:rxSunohStateDto}).success(function(data){if(data){}})};$scope.deleteRxOrder=function(conversationId,rxId,medObj){$scope.closeAddRxForAnyRx();let rxStatus=1;if(medObj.possibleMatches&&medObj.possibleMatches.length>0&&medObj.possibleMatches[0].status!==undefined&&medObj.possibleMatches[0].status!==''){rxStatus=getRxDoctorFlag(medObj.possibleMatches[0])}let itemId=0;if(medObj.possibleMatches&&medObj.possibleMatches.length>0&&medObj.possibleMatches[0].itemid){itemId=medObj.possibleMatches[0].itemid}let rxSunohStateDto={summaryId:conversationId,rxUUID:rxId,drugName:medObj.drugName?medObj.drugName:medObj.name?medObj.name:medObj.itemName,strength:medObj.strength?medObj.strength:medObj.dosage,formulation:medObj.form,take:medObj.take,route:medObj.route,frequency:medObj.frequency?medObj.frequency:medObj.freq,itemId:itemId,status:rxStatus,addInstructions:medObj.AddInstructions,refill:medObj.refills===""?null:medObj.refills};$http({url:makeURL("/mobiledoc/modules/webemr/sunoh/deleteSuggestedRx"),method:'POST',data:rxSunohStateDto}).success(function(data){if(data){}})};$scope.undoRxOrder=function(conversationId,rxId){$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},url:makeURL("/mobiledoc/modules/webemr/sunoh/undoSuggestedRx"),method:'POST',data:$.param({summaryId:$scope.sunohSummaryId,rxUUID:rxId})}).success(function(data){if(data){}})};$scope.associateDxForRx=function(){$scope.getDxList();try{let payload={drudIds:JSON.stringify($scope.getDrugNameIds()),encounterId:$scope.encounterId};$http({method:"POST",url:makeURL('/mobiledoc/modules/webemr/sunoh/mapDiagnosis'),data:$.param(payload),headers:{'Content-Type':'application/x-www-form-urlencoded'}}).success(function(response){if(response){try{let mappedDx=response;let medicationDxMap=[];for(let i=0;$scope.gptAnalysis.medications&&i<$scope.gptAnalysis.medications.length;i++){let possibleMatches=$scope.gptAnalysis.medications[i].possibleMatches;for(let j=0;possibleMatches!==undefined&&j<possibleMatches.length;j++){let dxFound=false;for(let k=0;k<mappedDx.length&&!dxFound;k++){if(possibleMatches[j].drugId===mappedDx[k].drugId){dxFound=true;if($scope.dxsDetails.list&&$scope.dxsDetails.list.Dx){for(let l=0;l<$scope.dxsDetails.list.Dx.length;l++){if($scope.dxsDetails.list.Dx[l].medicalcode===mappedDx[k].dxCode){possibleMatches[j].asmtId=$scope.dxsDetails.list.Dx[l].id;$scope.gptAnalysis.medications[i].asmtId=possibleMatches[j].asmtId;break}}}}}}}}catch(e){notification.show('error','','Something went wrong while associating Dx with medications!',4e3)}}else{notification.show('error','','Something went wrong while associating Dx with medications!',4e3)}}).error(function(){notification.show('error','','Something went wrong while associating Dx with medications!',4e3)})}catch(e){notification.show('error','','Something went wrong while associating Dx with medications!',4e3)}};$scope.addRxMEd={rxUUID:"0"};let isAddRxEnabled=function(medication,dx){return!medication.readOnlyLink&&!medication.hasSectionShow&&medication.isOrdered!==1&&medication.isDeleted!==1&&!$scope.isEncLocked};$scope.getClassForMedName=function(medication){let classes=[];if(medication.isDeleted===1){classes.push('deleted')}if(medication.isOrdered){classes.push('ordered')}else{classes.push('unordered')}return classes.join(" ")};function setRxVitals(med){med.vitals={weight:"",height:""};if($scope.sunohRxPatientVitals){med.vitals.weight=$scope.sunohRxPatientVitals.weight;med.vitals.height=$scope.sunohRxPatientVitals.height}}function adjustAddRxWindowUI(from){setTimeout(()=>{setTimeout(()=>{if(from==='notFound'){$("#rxAddOptionPopover")[0].scrollIntoView({behavior:"smooth",block:"end"})}else{$("#rxAddOptionPopover2")[0].scrollIntoView({behavior:"smooth",block:"end"})}},300)})}function showSunohAddRxWindow(med){setTimeout(()=>{$scope.PNQSDetailsReqObj.setRxNameFromSunoh(med)},300)}function disabledOtherLinkFromAddRx(med){for(let i=0;i<$scope.gptAnalysis.medications.length;i++){if(med.rxUUID!==$scope.gptAnalysis.medications[i].rxUUID){$scope.gptAnalysis.medications[i].readOnlyLink=true}}}$scope.addRx=function(med,from,dx){if(isAddRxEnabled(med,dx)){$scope.quickSunohSelectedRx={};$scope.quickSunohSelectedRx.selectDx=med.selectDx;if(!$scope.quickSunohSelectedRx.selectDx||$scope.quickSunohSelectedRx.selectDx.length===0){$scope.quickSunohSelectedRx.selectDx=[0]}$scope.addRxMEd={rxUUID:"0"};$scope.addRxMEd=med;disabledOtherLinkFromAddRx(med);$(".sunhoRxGridDiv_"+med.rxUUID).css("background","#FFF3E9");med.hasSectionShow=true;setRxVitals(med);adjustAddRxWindowUI(from);showSunohAddRxWindow(med)}};function enabledLinkCloseRx(){for(let i=0;i<$scope.gptAnalysis.medications.length;i++){$scope.gptAnalysis.medications[i].readOnlyLink=false}}$scope.closeAddRx=function(med){$scope.quickSunohSelectedRx={};$scope.addRxMEd={rxUUID:"0"};med.hasSectionShow=false;enabledLinkCloseRx();$(".sunhoRxGridDiv_"+med.rxUUID).css("background","none");if(!$scope.isOpenLabDiRefImmEditPopup){$scope.setDirtyFalg(false)}};$scope.closeAddRxForAnyRx=function(){let popupClosed=false;for(let i=0;i<$scope.gptAnalysis.medications.length;i++){if($scope.addRxMEd.rxUUID===$scope.gptAnalysis.medications[i].rxUUID){$scope.closeAddRx($scope.gptAnalysis.medications[i]);popupClosed=true}}return popupClosed};function setAssessmentFromAddRxAcceptButton(){if($scope.quickSunohSelectedRx.selectDx&&$scope.quickSunohSelectedRx.selectDx.length>0){$scope.quickSunohSelectedRx.assmtId=$scope.quickSunohSelectedRx.selectDx[0]}}$scope.acceptRxFromQuickOrder=function(){if(!$scope.quickSunohSelectedRx.name){ecwAlert("Please select rx first");return}$scope.rxOrderAcceptData=$scope.addRxMEd;setAssessmentFromAddRxAcceptButton();if(typeof $scope.quickSunohSelectedRx.assmtId==='undefined'||$scope.quickSunohSelectedRx.assmtId===""||$scope.quickSunohSelectedRx.assmtId===null){ecwAlert("Please select the corresponding assessment.");return}let medObject=angular.copy($scope.quickSunohSelectedRx);medObject.context="rxQuickOrderScreen";$scope.quickSunohSelectedRx={};if(typeof $scope.PNQSDetailsReqObj.sunohOrderRx==="undefined"){let scopeValue=getQuickSearchScope();scopeValue.qsrequestObj.sunohOrderRx(medObject,true)}else{$scope.PNQSDetailsReqObj.sunohOrderRx(medObject,true)}};$scope.isDxOther=function(dx){return!dx.key};let isOrderPlacedForPNAssessmentNotForSunohAss=function(order,isLabDIProcImmRefOrder){if(order.icd_codes&&order.icd_codes.length>1&&(!order.selectDxItems||order.selectDxItems.length===0)){return true}if(!isLabDIProcImmRefOrder&&$scope.treatmentNotesDataArr.findIndex(masterDx=>masterDx.value&&String(order.selectDx[0])===String(masterDx.value.itemId))===-1){return true}let isPNAssSelected=false;if(!order.selectDxItems){return isPNAssSelected}order.selectDxItems.forEach(dxItem=>{if(isPNAssSelected){return}let masterIndex=$scope.treatmentNotesDataArr.findIndex(masterDx=>masterDx.value&&dxItem.value&&(dxItem.value.code===masterDx.value.code||dxItem.value.code===masterDx.value.ICD10));isPNAssSelected=masterIndex===-1});return isPNAssSelected};let isOrderPlacedForSunohAssessment=function(order,dxObj){return order.selectDxItems.findIndex(dx=>dx.value&&dx.value.code&&(dx.value.code===dxObj.value.code||dx.value.code===dxObj.value.ICD10))>-1};function isOrderInSelectedDx(order,dxObj){return order.selectDx&&order.selectDx.length>0&&dxObj.value.itemId!==undefined&&order.selectDx[0]!==undefined&&parseInt(dxObj.value.itemId)>0&&parseInt(dxObj.value.itemId)===parseInt(order.selectDx[0])}function isRxSavedWithDx(order){return order.asmtId!==undefined&&order.asmtId!==null&&order.asmtId!==''&&parseInt(order.asmtId,10)>=0&&order.rxUUID}function isOrderInSuggestedDx(order,dxObj){if(isRxSavedWithDx(order)){if(isNAAssObj(dxObj)&&$scope.treatmentNotesDataArr.findIndex(masterDx=>masterDx.value&&String(order.asmtId)===String(masterDx.value.itemId))===-1){return true}if(isNAAssObj(dxObj)&&parseInt(order.asmtId,10)===0){return true}return dxObj.value&&dxObj.value.itemId!==undefined&&parseInt(order.asmtId,10)===parseInt(dxObj.value.itemId,10)}else{return(!order.selectDx||order.selectDx.length===0)&&dxObj.key&&dxObj.key===order.reason}}function isOrderSelectedForOtherDx(dxObj,order){return isNAAssObj(dxObj)&&order.selectDx&&order.selectDx.length>0&&order.selectDx[0]===0}function isOrderReasonNotMatchAnyDiagnosis(reason){return $scope.treatmentNotesDataArr.findIndex(masterDx=>masterDx.key===reason)===-1}function addDefaultNASelectionForOrder(dxObj,order,isLabDIProcImmRefOrder){if(!order.selectDx||order.selectDx.length===0){order.selectDx=[];if(!order.selectDxItems)order.selectDxItems=[];order.selectDx.push(dxObj.value.itemId);if(isLabDIProcImmRefOrder){order.selectDxItems.push(dxObj)}}}let isNAAssObj=function(dxObj){return dxObj&&!dxObj.key&&dxObj.value&&dxObj.value.itemId===0};let isOrderPlacedPNAssessment=function(order,dxObj){return order.selectDx.findIndex(dx=>parseInt(dx,10)===parseInt(dxObj.value.itemId,10))>-1};let isLabDIProcIMMRefOrderPlaced=function(isLabDIProcImmRefOrder,order){return isLabDIProcImmRefOrder&&order.isOrdered};$scope.matchOrderToDx=function(order,dxObj,isLabDIProcImmRefOrder,isImmOrRefOrder){let isMatch=false;if(isOrderInSuggestedDx(order,dxObj)&&(!isLabDIProcImmRefOrder||!isLabDIProcIMMRefOrderPlaced(isLabDIProcImmRefOrder,order))){isMatch=true}else if((!order.selectDx||order.selectDx.length===0)&&(!order.selectDxItems||order.selectDxItems.length===0)&&isNAAssObj(dxObj)&&!order.reason&&!isRxSavedWithDx(order)){isMatch=true}else if(isOrderInSelectedDx(order,dxObj)){isMatch=true}else if(isOrderSelectedForOtherDx(dxObj,order)){isMatch=true}else if(!dxObj.key&&dxObj.value&&parseInt(dxObj.value.itemId,10)>0&&order.selectDx&&order.selectDx.length>0&&order.isOrdered){isMatch=isOrderPlacedPNAssessment(order,dxObj)}else if(isNAAssObj(dxObj)&&order.selectDx&&order.selectDx.length>0&&order.isOrdered){isMatch=isOrderPlacedForPNAssessmentNotForSunohAss(order,isLabDIProcImmRefOrder)}else if(isNAAssObj(dxObj)&&order.reason&&!order.isOrdered){isMatch=isOrderReasonNotMatchAnyDiagnosis(order.reason)}else if(isLabDIProcImmRefOrder&&order.isOrdered&&dxObj.key&&dxObj.value&&_.trim(dxObj.value.name).toLowerCase()!=='other'&&order.selectDxItems&&order.selectDxItems.length>0){isMatch=isOrderPlacedForSunohAssessment(order,dxObj)}else if(isNAAssObj(dxObj)&&isLabDIProcImmRefOrder&&order.isOrdered&&(!order.selectDx||order.selectDxItems.length===0)){isMatch=true}if(isLabDIProcImmRefOrder&&!order.reason&&dxObj.key&&!order.isOrdered&&parseInt(dxObj.value.itemId)!==0){if(order.selectDx&&order.selectDx.length>0&&order.selectDx.findIndex(dx=>parseInt(dx,10)===parseInt(dxObj.value.itemId,10))>-1){isMatch=true}if((!order.selectDx||order.selectDx.length===0)&&order.selectDxItems&&order.selectDxItems.length>0){isMatch=order.selectDxItems.findIndex(dx=>dxObj.key===dx.key)>-1}}if(isNAAssObj(dxObj)&&isLabDIProcImmRefOrder&&!isImmOrRefOrder&&!order.isOrdered&&$scope.orderConfigAssmtMandatory&&(!order.selectDx||order.selectDx.length===0)){order.isAcceptEnable=false}if(isNAAssObj(dxObj)&&isMatch&&!order.isOrdered){addDefaultNASelectionForOrder(dxObj,order,isLabDIProcImmRefOrder)}return isMatch};$scope.quickSunohSelectedRx={};function setToDisplayQuickSearch(medObj,i){$scope.quickSunohSelectedRx.name=medObj.drugName?medObj.drugName:medObj.name?medObj.name:medObj.itemName;$scope.quickSunohSelectedRx.dosage=medObj.strength;$scope.quickSunohSelectedRx.Formulation=medObj.formulation;$scope.quickSunohSelectedRx.take=medObj.take;$scope.quickSunohSelectedRx.route=medObj.route;$scope.quickSunohSelectedRx.frequency=medObj.freq;$scope.quickSunohSelectedRx.duration=medObj.duration;$scope.quickSunohSelectedRx.dispense=medObj.dispense;$scope.quickSunohSelectedRx.refills=medObj.refills;$scope.quickSunohSelectedRx.AddInstructions=medObj.AddInstructions;$scope.quickSunohSelectedRx.NDC=medObj.ndc;$scope.quickSunohSelectedRx.drugId=medObj.DrugNameId?medObj.DrugNameId:medObj.drugId;$scope.quickSunohSelectedRx.itemid=medObj.ItemId?medObj.ItemId:medObj.itemID?medObj.itemID:medObj.itemid;$scope.quickSunohSelectedRx.subohRxUUID=$scope.addRxMEd.rxUUID;$scope.quickSunohSelectedRx.callFrom=medObj.callFrom;$scope.quickSunohSelectedRx.favorite=medObj.favorite;$scope.quickSunohSelectedRx.selectedIndex=medObj.selectedIndex;$scope.gptAnalysis.medications[i].fromQuickOrder=true}$scope.$on('appendRxSunohPossibleMatches',function(e,medObj){for(let i=0;i<$scope.gptAnalysis.medications.length;i++){let rxUUID=$scope.gptAnalysis.medications[i].rxUUID;if(rxUUID===$scope.addRxMEd.rxUUID){setToDisplayQuickSearch(medObj,i)}}});$scope.saveInLocalRxDataDict=function(medObj,rxSunohText){let rxMappingDto={itemId:medObj.ItemId?medObj.ItemId:medObj.itemID?medObj.itemID:medObj.itemid,drugNameid:medObj.DrugNameId?medObj.DrugNameId:medObj.drugId,strength:medObj.strength?medObj.strength:medObj.dosage,formulation:medObj.formulation?medObj.formulation:medObj.Formulation,route:medObj.route,rxSunohText:rxSunohText,trUserId:global.TrUserId};$http({url:makeURL("/mobiledoc/modules/webemr/sunoh/mapSunohRxText"),method:'POST',data:rxMappingDto}).success(function(data){if(data){}})};$scope.getClassForMatchedRxSig=function(medication,type,dx){let className='';if(medication.possibleMatches[0].status==='Start'&&medication.isOrdered!==1&&medication.isDeleted!==1&&!$scope.isEncLocked){className=type==='name'?'add-rx-click-style':'rxIsLink'}return className};$scope.getSavedAssessmentList=function(){$http({method:"GET",url:makeURL('/mobiledoc/modules/webemr/sunoh/get/order/assessment'),params:{id:$scope.encounterId}}).success(function(response){$scope.savedAssessments=[];angular.forEach(response,function(obj){obj.value=JSON.parse(obj.value);obj.isSaved=true;if(obj.value.createdDate){obj.tooltipContent='Assessment merged by '+obj.value.userFullName+' on '+$scope.formatDate(new Date(obj.value.createdDate))}$scope.savedAssessments.push(obj);let index=$scope.sunohAssessmentList.findIndex(data=>data.value.name===obj.value.name);if(index>-1){$scope.sunohAssessmentList.splice(index,1)}});$scope.addPNICDToTreatmentPlan()}).error(function(response){notification.show('error','','Assessment not able to load.',4e3)})};$scope.addPNICDToTreatmentPlan=function(){angular.forEach($scope.savedAssessments,function(obj){let data=$scope.treatmentNotesDataArr.find(item=>item.value!==null&&item.value.name===obj.value.name&&(!item.value.ICD10&&item.value.code===obj.value.code||item.value.ICD10&&item.value.ICD10===obj.value.code));if(!data){obj.isSaved=false;obj.notes='';obj.isICDSaved=true;obj.type='treatmentplan';obj.trash=false;if(obj.value&&obj.value.itemId){obj.itemid=obj.value.itemId}let length=$scope.treatmentNotesDataArr.length;if(length>0){let object=$scope.treatmentNotesDataArr[length-1];if(object.value&&object.value.ICD10&&object.value.name&&object.value.ICD10==='N/A'&&object.value.name==='Other'){$scope.treatmentNotesDataArr[length-1]=angular.copy(obj);$scope.treatmentNotesDataArr.push(object)}else{$scope.treatmentNotesDataArr.push(angular.copy(obj))}}else{$scope.treatmentNotesDataArr.push(angular.copy(obj))}}else{data.isICDSaved=true;data.itemid=obj.value.itemId;data.value.itemId=obj.value.itemId}})};$scope.updateTreatmentPlansArr=function(){angular.forEach($scope.savedAssessments,function(obj){if(!$scope.treatmentNotesDataArr.find(item=>item.value!==null&&item.value.name===obj.value.name)){if(!$scope.savedTreatmentNotes.find(item=>item.value.name===obj.value.name)){obj.isSaved=false;obj.type='treatmentplan';obj.trash=false;if(obj.value&&obj.value.itemId){obj.itemid=obj.value.itemId}$scope.treatmentNotesDataArr.push(angular.copy(obj))}else{let data=$scope.treatmentNotesDataArr.find(item=>obj.key===item.key);if(data){data.value=angular.copy(obj.value)}}}obj.isSaved=true;obj.type='assessment';obj.isSaved=$scope.encDxList.find(item=>item.dxItemName===obj.value.name);if(!$scope.masterDiagnosisArr.find(item=>item.key===obj.key)){$scope.masterDiagnosisArr.push(angular.copy(obj))}})};$scope.formatDate=function(date){const year=date.getFullYear();const month=date.getMonth();const day=date.getDate();const hours=date.getHours();const minutes=date.getMinutes();return`${day}${$scope.getOrdinalSuffix(day)} ${new Intl.DateTimeFormat('en-US',{year:'numeric',month:'long'}).format(new Date(year,month,day,hours,minutes))} ${$scope.formatHours(hours)}:${minutes.toString().padStart(2,'0')} ${hours>=12?'PM':'AM'}`};$scope.formatHours=function(hours){if(hours===0){return'12'}else if(hours>12){return(hours-12).toString()}else{return hours.toString()}};$scope.getOrdinalSuffix=function(day){if(day>=11&&day<=13){return'th'}switch(day%10){case 1:return'st';case 2:return'nd';case 3:return'rd';default:return'th'}};$scope.getCurrentAssessment=function(){$http({method:"GET",url:makeURL('/mobiledoc/modules/webemr/sunoh/get/dx'),params:{encounterId:$scope.encounterId,patientId:$scope.patientId}}).success(function(response){$scope.encDxList=response.encDxList}).error(function(response){notification.show('error','','Assessment not able to load.',4e3)})};$scope.$on('refreshSunohAsmntList',function(e){$scope.getSavedAssessmentList();$scope.getCurrentAssessment()});$scope.$on('sunohRxOrderAcceptClicked',function(e,medObject){if(medObject.fromSunohQuickSearch){isRxOrdered=true}else{medObject.docFlag="1";$scope.sunohRxOrderAcceptClickedData(medObject,0)}});function isFromMedSummaryAndNotQuickOrder(isSaveMedSummaryCall,i){return isSaveMedSummaryCall===1&&$scope.rxOrderAcceptData.rxUUID===$scope.gptAnalysis.medications[i].rxUUID&&!$scope.gptAnalysis.medications[i].fromQuickOrder}function isFromAddRxAndQuickOrder(i){return $scope.addRxMEd.rxUUID===$scope.gptAnalysis.medications[i].rxUUID&&$scope.gptAnalysis.medications[i].fromQuickOrder}function isFromStartStatusAndRxEdit(i){return $scope.rxOrderAcceptData.rxUUID===$scope.gptAnalysis.medications[i].rxUUID&&!$scope.gptAnalysis.medications[i].fromQuickOrder}function setAddRxAndQuickOrderValues(i,medObject){setRxInfoPostSave(i,medObject);$scope.gptAnalysis.medications[i].hasSectionShow=false;$(".sunhoRxGridDiv_"+$scope.addRxMEd.rxUUID).css("background","none")}function setStartStatusAndRxEditValues(i,medObject){setRxInfoPostSave(i,medObject)}function setRxInfoPostSave(i,medObject){$scope.gptAnalysis.medications[i].isOrdered=1;let possibleMatchs=[];let medObj={};medObj.name=medObject.drugName?medObject.drugName:medObject.name?medObject.name:medObject.itemName;medObj.Formulation=medObject.formulation;medObj.dosage=medObject.strength;medObj.NDC=medObject.ndc;medObj.drugId=medObject.DrugNameId;medObj.itemid=medObject.ItemId?medObject.ItemId:medObject.itemID;medObj.take=medObject.take;medObj.route=medObject.route;medObj.frequency=medObject.freq;medObj.duration=medObject.duration;medObj.dispense=medObject.dispense;medObj.refills=medObject.refills;medObj.AddInstructions=medObject.AddInstructions;medObj.status="Start";possibleMatchs.push(medObj);$scope.gptAnalysis.medications[i].possibleMatches=possibleMatchs;$scope.gptAnalysis.medications[i].assessId=medObject.assessId;if($scope.gptAnalysis.medications[i].selectDx){$scope.gptAnalysis.medications[i].selectDx[0]=medObject.assessId}else{$scope.gptAnalysis.medications[i].selectDx=[medObject.assessId]}}$scope.sunohRxOrderAcceptClickedData=function(medObject,isSaveMedSummaryCall){isRxOrdered=true;$scope.acceptRxOrder(medObject);$scope.saveInLocalRxDataDict(medObject,$scope.rxOrderAcceptData.name);if(medObject.status!=='Stop'&&medObject.context!=="SunohQuickOrders"){let message=escapeHtml(medObject.drugName?medObject.drugName:medObject.name?medObject.name:medObject.itemName)+' Ordered.';notification.show('success','Sunoh',message,4e3)}for(let i=0;i<$scope.gptAnalysis.medications.length;i++){if(isFromMedSummaryAndNotQuickOrder(isSaveMedSummaryCall,i)){$scope.gptAnalysis.medications[i].isOrdered=1}else if(isFromAddRxAndQuickOrder(i)){setAddRxAndQuickOrderValues(i,medObject)}else if(isFromStartStatusAndRxEdit(i)){setStartStatusAndRxEditValues(i,medObject)}else if($scope.rxOrderAcceptData.rxUUID===$scope.gptAnalysis.medications[i].rxUUID){$scope.gptAnalysis.medications[i].isOrdered=1}$scope.gptAnalysis.medications[i].readOnlyLink=false}$scope.closeAddRxForAnyRx()};$scope.onSelectSummary=function(){let onSelectSummaryFn=function(){$(templateId+' #sunohScribeACIModule').on('change','.summaryCheck, .quickSectionCheck, #allCheck',function(){let disabled=$(templateId+" .summaryCheck:checked").length===0;if(disabled){$(templateId+" #copyToClipboardSunoh").addClass("disableElement").attr("title","Select section(s) to copy");$(templateId+" #exportToPDF").addClass("disableElement").attr("title","Please select sections from the conversation summary to perform Export as PDF.")}else{$(templateId+" #copyToClipboardSunoh").removeClass("disableElement").attr("title","");$(templateId+" #exportToPDF").removeClass("disableElement").attr("title","Export the Conversation Summary")}})};onSelectSummaryTimeout=$timeout(onSelectSummaryFn)};$scope.isAnySummaryUnsaved=function(){let summaryInstanceSelector=".sunoh-instance-summaryView #sunohScribeACIModule";if($(summaryInstanceSelector).length>0){return $(summaryInstanceSelector).scope().isInputChanges}return false};$scope.chooseEncounterToSendDataToEHR=function(){$("#sendEHRModal").modal("show");$scope.generateSelectSectionPreviewPanel();if($scope.isSunohStandalone){let mypatientsScope=angular.element(document.getElementById('mypatients')).scope();mypatientsScope.getEncounterListDataForExternalPatient()}};$scope.sendDataForSmartOnFhirLogin=function(){if($scope.isSunohStandalone){let mypatientsScope=angular.element(document.getElementById('mypatients')).scope();mypatientsScope.sendDataForSmartOnFhir()}};$scope.$on('writeBackDataToEHR',function(event,data){$scope.paramsForWriteBackData=data;$scope.writeBackDataToEHR()});$scope.$on('isDummyPatient',function(event,data){let isPatientCreated=!data;if(SunohService.loadConsultNotesInit&&isPatientCreated)loadConsultNotePopup()});$scope.$on('updatePublishedStatusForSummary',function(event,responseData){updatePublishedStatusForSummary(responseData)});function updatePublishedStatusForSummary(responseData){let obj=$filter('filter')($scope.transactions,{id:responseData.summaryId})[0];if(obj){obj.isDocumentPublished=responseData.status}if(parseInt($scope.currentTransaction.id,10)===responseData.summaryId||parseInt($scope.selectedTrxId,10)===responseData.summaryId){$scope.currentTransaction.isDocumentPublished=responseData.status}}$scope.writeBackDataToEHR=function(){let mypatientsScope=angular.element(document.getElementById('mypatients')).scope();if(!$scope.paramsForWriteBackData){$scope.paramsForWriteBackData={}}if($scope.paramsForWriteBackData.sunohSummarySpecificDetails){$scope.paramsForWriteBackData.sunohSummarySpecificDetails.summaryId=$scope.currentTransaction.id||$scope.selectedTrxId}$scope.paramsForWriteBackData.visitSummaryData=$scope.getSelectedSections($scope.paramsForWriteBackData.patientName);$http({method:"POST",url:'/mobiledoc/emr/sunohSmartOnFhir/createR4/createDocumentReference',data:$scope.paramsForWriteBackData}).success(function(response){$("#allCheck").prop('checked',false);$scope.allCheckQuickSec();if(response){let status=response.responseData===201?'SUCCESS':'FAIL';$scope.currentTransaction.isDocumentPublished=status;let obj=$filter('filter')($scope.transactions,{id:$scope.paramsForWriteBackData.sunohSummarySpecificDetails.summaryId})[0];if(obj){obj.isDocumentPublished=status}if($scope.currentTabId===2){let obj=$filter('filter')($scope.scheduleList,{appointmentId:$scope.currentSelectedMyScheduleCard.appointmentId})[0];if(obj){obj.isDocumentPublished=status}}mypatientsScope.markDocumentAsPublished(status);if(status==='SUCCESS'){notification.show('success','','The conversation summary is sent successfully',1e4)}else{mypatientsScope.markForFailedSummary();notification.show('error','','Something went wrong! Please try again.',4e3)}}else{mypatientsScope.markForFailedSummary();mypatientsScope.performOperationAfterSendToEHR();notification.show('error','','Something went wrong! Please try again.',4e3)}}).error(function(){mypatientsScope.performOperationAfterSendToEHR();notification.show('error','','Something went wrong! Please try again.',4e3)})};function removeBFontTagFromEHR(selectedSummary){return selectedSummary.replaceAll("<b>","").replaceAll("</b>","")}$scope.getReferralsFormatted=function(referrals){if(referrals===undefined||typeof referrals==='string'){return referrals}let formattedReferrals=[];for(let i in referrals){let referral=referrals[i];let formattedReferral=referral.referred_doctor_name;if(formattedReferral&&formattedReferral.trim()&&referral.referral_speciality.trim()){formattedReferral+=" - "}formattedReferral+=referral.referral_speciality;formattedReferrals.push(formattedReferral)}return formattedReferrals.join("\n")};$scope.getAllergiesFormatted=function(allergies){if(allergies===undefined||typeof allergies==='string'){return allergies}let allergiesFormatted=[];for(let i in allergies){let allergy=allergies[i];let allergyFormatted=allergy.allergen_name;if(allergyFormatted&&allergyFormatted.trim()&&allergy.reaction.trim()){allergyFormatted+=" - "}allergyFormatted+=allergy.reaction;allergiesFormatted.push(allergyFormatted)}return allergiesFormatted.join("\n")};$scope.getLabsFormatted=function(labs){if(labs===undefined||typeof labs==='string'){return labs}return labs.map(function(l){return l.name}).join("\n")};$scope.getDiProcFormatted=function(diProc){if(diProc===undefined||typeof diProc==='string'){return diProc}return diProc.map(function(l){return l.name}).join("\n")};$scope.getImmunizationFormatted=function(immunizations){if(immunizations===undefined||typeof immunizations==='string'){return immunizations}return immunizations.join("\n")};$scope.getMedsFormatted=function(medications){if(medications===undefined||typeof medications==='string'){return medications}let medsFormatted=[];for(let i in medications){let medication=medications[i];let med=medication.name;if(!isBlankMed(medication.dosage)){med+=' '+medication.dosage}if(!isBlankMed(medication.formulation)){med+=' '+medication.formulation}if(!isBlankMed(medication.frequency)){med+=' '+medication.frequency}medsFormatted.push(med)}return medsFormatted.join("\n")};function isBlankMed(value){if(value!==undefined&&value!==''&&value!=='NA'&&value!=='Not specified'&&value!=='Not mentioned'&&value!=='Blank'){return false}return true}$scope.setWidgetRecInProgressSa=function(flag){if(!$scope.isSunohStandalone){return false}let mypatientsScope=angular.element(document.getElementById('mypatients')).scope();mypatientsScope.setWidgetRecInProgress(flag)};$scope.getWidgetRecInProgressSa=function(){if(!$scope.isSunohStandalone){return false}let mypatientsScope=angular.element(document.getElementById('mypatients')).scope();let isGetWidgetRecInProgress=mypatientsScope.getWidgetRecInProgress();if(isGetWidgetRecInProgress){if($("#startBtn").hasClass('dnone')){$('#stopBtn').click()}}return isGetWidgetRecInProgress};let isDisplayIconForSuggestedOrder=function(suggestedOrder){return suggestedOrder.findIndex(suggesion=>suggesion.type!==suggestedOrder[0].type)!==-1};$scope.updateDisplayIconFlagIfRequired=function(suggestedOrders){if(!suggestedOrders||suggestedOrders.length===1){return}suggestedOrders.foreach(order=>{order.isDisplayIcon=isDisplayIconForSuggestedOrder(suggestedOrders)})};let addDefaultDxForOrders=function(orders){if(!orders||orders.length===0||!$scope.treatmentNotesDataArr||$scope.treatmentNotesDataArr.length===0){return}orders.forEach(order=>{order.selectDx=[];order.selectDxItems=[];let isAcceptEnable=true;if(!order["reason"]){isAcceptEnable=true}if(order["reason"]&&!order.isOrdered){order.isAcceptEnable=findReasonOrDxIdInArray(order,isAcceptEnable,masterDx=>masterDx.key===order["reason"])}if(order.isOrdered&&order.recommendedSuggesion&&order.recommendedSuggesion.ass_ids&&order.recommendedSuggesion.ass_ids.length>0){order.selectDxItems=[];order.selectDx=[];let icd_codes=order.recommendedSuggesion.icd_codes;order.recommendedSuggesion.ass_ids.forEach((assId,index)=>{let dxObj=$scope.treatmentNotesDataArr.find(masterDx=>masterDx.value&&parseInt(masterDx.value.itemId,10)===assId);if(dxObj){order.selectDxItems.push(dxObj);order.selectDx.push(dxObj.value.itemId);return}let dxAssObj=$scope.treatmentNotesDataArr.find(masterDx=>masterDx.value&&masterDx.value.code===icd_codes[index]);if(dxAssObj){order.selectDxItems.push(dxObj);if(dxObj.value.itemId){order.selectDx.push(dxObj.value.itemId)}return}order.selectDxItems.push({value:{code:icd_codes[index],itemId:assId}});order.selectDx.push(assId)})}})};let findReasonOrDxIdInArray=function(order,isAcceptEnable,find){let index=$scope.treatmentNotesDataArr.findIndex(find);if($scope.treatmentNotesDataArr[index]){let matchedDx=$scope.treatmentNotesDataArr[index];isAcceptEnable=!$scope.isNotAvailableInUpdateDxList(matchedDx.value.tPlanName,matchedDx.value.name);let assObj=angular.copy($scope.treatmentNotesDataArr[index]);if(assObj){assObj.source="suggesion";assObj.isDelete=assObj.trash;order.selectDxItems.push(assObj);if(assObj.isICDSaved&&!assObj.trash&&isAcceptEnable){order.selectDx.push(assObj.value?.itemId)}}}return isAcceptEnable};$scope.setDefaultOrderType=function(order,singleDatePickerObj){switch(_.trim(order.type).toLowerCase()){case'labreports':setFutureOrderIfApplicable(order,'SunohInHouseLabDefaultSetting','SunohSendOutLabDefaultSetting',singleDatePickerObj);break;case'xrays':setFutureOrderIfApplicable(order,'SunohInHouseDIDefaultSetting','SunohSendOutDIDefaultSetting',singleDatePickerObj);break;case'procedures':setFutureOrderIfApplicable(order,'SunohInHouseProcedureDefaultSetting','SunohSendOutProcedureDefaultSetting',singleDatePickerObj);break}};$scope.isDxDivVisisble=function(dxList){return dxList&&dxList.length>=1};let getDateAddBasedOnKey=function(key){let value;switch(key){case'D':value="days";break;case'M':value="months";break;case'W':value="days";break;case'Y':value="year";break}return value};let getDefaultFuturedate=function(itemKeyName){let futureOrderDateSetting=getItemKeyValue(itemKeyName);if(!futureOrderDateSetting){return moment().format("MM/DD/YYYY")}let addInto=parseInt(futureOrderDateSetting.slice(0,-1),10);let dateOptType=futureOrderDateSetting.slice(-1);addInto=dateOptType==="W"?addInto*7:addInto;let addValue=getDateAddBasedOnKey(dateOptType);let futureDate=moment(new Date,'MM/DD/YYYY').toDate();futureDate=moment(futureDate,"MM/DD/YYYY");futureDate.add(addInto,addValue);return moment(futureDate).format('MM/DD/YYYY')};let setFutureOrderIfApplicable=function(suggestedOrder,inHouseDefaultItemKeyName,sendOutDefaultItemKeyName,singleDatePickerObj){if(_.trim(suggestedOrder.isBillable)==='true'&&getItemKeyValue(inHouseDefaultItemKeyName)==='futureOrder'||_.trim(suggestedOrder.isBillable)==='false'&&getItemKeyValue(sendOutDefaultItemKeyName)==='futureOrder'){suggestedOrder.isFutureOrder=true;let futureOrderItemKeyName;if(_.trim(suggestedOrder.isBillable)==='true'&&getItemKeyValue(inHouseDefaultItemKeyName)==='futureOrder'){futureOrderItemKeyName=futureOrderDateTypeSettingMapping[inHouseDefaultItemKeyName]}else{futureOrderItemKeyName=futureOrderDateTypeSettingMapping[sendOutDefaultItemKeyName]}suggestedOrder.futureOrderDate=getDefaultFuturedate(futureOrderItemKeyName);if(singleDatePickerObj){singleDatePickerObj.singleDate=moment(suggestedOrder.futureOrderDate,'MM/DD/YYYY').toDate();singleDatePickerObj.singleDatepicker=moment(suggestedOrder.futureOrderDate,'MM/DD/YYYY').toDate()}}};let setDeleteStatusForOrder=function(order){if(!$scope.gptAnalysis.sunohDeletedItems||$scope.gptAnalysis.sunohDeletedItems.length===0){return}if(!order.recommendedSuggesion.itemId){order.isDeleted=$scope.gptAnalysis.sunohDeletedItems.findIndex(alias=>order.referral_speciality===alias.test_name)>-1;return}order.isDeleted=$scope.gptAnalysis.sunohDeletedItems.findIndex(alias=>order.name===alias.test_name)>-1};let setNAReasonForImmOrder=function(order){if(!order.isOrdered&&parseInt(order.historical,10)===0&&order.status==="Not Administered"){order.recommendedSuggesion.non_administration_reason=_.trim(order.non_administration_reason);order.recommendedSuggesion.status=3;if(order.recommendedSuggesion.non_administration_reason){order.recommendedSuggesion.naReasonStatus=6}}};let setOtherParamsForOrders=function(labDIProcOrders,imms,referrals){if(labDIProcOrders&&labDIProcOrders.length>0){labDIProcOrders.forEach(order=>{if(order.suggestedOrders&&order.suggestedOrders.length>0){if(!order.isOrdered){let isDisplayIcon=isDisplayIconForSuggestedOrder(order.suggestedOrders);order.suggestedOrders.forEach(suggestedOrder=>{suggestedOrder.fasting=false;suggestedOrder.priority=false;suggestedOrder.isFutureOrder=false;suggestedOrder.futureOrderDate="";suggestedOrder.isDisplayIcon=isDisplayIcon;$scope.setDefaultOrderType(suggestedOrder)})}order.recommendedSuggesion=angular.copy(order.suggestedOrders[0])}else{order.recommendedSuggesion={fasting:false,priority:false,futureOrderDate:"",isTempOrder:true}}setDeleteStatusForOrder(order,order.suggestedOrders)})}else if(imms&&imms.length>0){imms.forEach(order=>{if(order.suggestedOrders&&order.suggestedOrders.length>0){order.suggestedOrders.forEach(suggestedOrder=>{suggestedOrder.isDisplayIcon=false});let selectedSuggestion=order.suggestedOrders[0];if(order.isOrdered){order.historical=selectedSuggestion.isFutureOrder?1:0;order.isHistorical=!!selectedSuggestion.isFutureOrder;selectedSuggestion.givenDate=selectedSuggestion.futureOrderDate;selectedSuggestion.givenTime=selectedSuggestion.orderTime}if(!order.isOrdered&&parseInt(order.historical,10)===0){selectedSuggestion=order.suggestedOrders.find(o=>!o.inactive);if(!selectedSuggestion){selectedSuggestion={isTempOrder:true,type:'immunizations'};order.isAllSuggestionInactive=true}}order.recommendedSuggesion=angular.copy(selectedSuggestion)}else{order.recommendedSuggesion={isTempOrder:true}}setNAReasonForImmOrder(order);setDeleteStatusForOrder(order,order.suggestedOrders)})}else if(referrals&&referrals.length>0){referrals.forEach(ref=>{if(ref.suggestedOrders&&ref.suggestedOrders.length>0){ref.suggestedOrders.forEach(suggestedOrder=>{suggestedOrder.isDisplayIcon=false});ref.recommendedSuggesion=angular.copy(fillDetailsAcceptedReferral(ref.suggestedOrders,ref))}else{ref.recommendedSuggesion={isTempOrder:true}}setDeleteStatusForOrder(ref)})}$scope.orderConfigAssmtMandatory=getItemKeyValue("Lab_Configurations_Assessments_Mand",false)==="1";$scope.selectSingleAssessment=getUserProfile("selectSingleAssessment")};let fillDetailsAcceptedReferral=function(suggestions,ref){if(ref.isOrdered){return suggestions[0]}if($scope.commonData&&$scope.commonData.referralPriorities){suggestions[0].priority=$scope.commonData.referralPriorities[0].Id;suggestions[0].priorityName=$scope.commonData.referralPriorities[0].Name}if($scope.commonData&&$scope.commonData?.defaultAssignTo?.id){suggestions[0].performedBy=$scope.commonData.defaultAssignTo.id;suggestions[0].assignedToName=$scope.commonData.defaultAssignTo.name}if(suggestions[0].providers&&suggestions[0].providers.length>0){suggestions[0].referredToName=suggestions[0].providers[0].providerName}return suggestions[0]};let updateAcceptStatusForLabOrders=function(orders,assKey,isFromDeleteAss,assItemId){if(!orders||orders.length===0){return}orders.forEach(order=>{if(order.selectDxItems&&order.selectDxItems.length>0&&!order.isOrdered){let assIndex=order.selectDxItems.findIndex(dx=>dx&&dx.key===assKey);let masterIndex=$scope.treatmentNotesDataArr.findIndex(dx=>dx&&dx.key===assKey);if(assIndex>-1){order.selectDxItems[assIndex]=$scope.treatmentNotesDataArr[masterIndex];if(isFromDeleteAss){order.selectDxItems[assIndex].isDelete=true;order.selectDx.splice(assIndex,1);if(order.selectDxItems.length===1){order.isAllDxDeleted=true;addAssSuggesionForOtherOrderBasedOnHistoricalData()}else{let deletedOrUnsavedDx=order.selectDxItems.filter(dx=>!dx.isICDSaved||dx.isDelete);let deletedDx=order.selectDxItems.filter(dx=>dx.isDelete);if(order.selectDx.length>0||deletedOrUnsavedDx.length!==order.selectDxItems.length){order.isAcceptEnable=true}}}else{order.isAcceptEnable=true;order.selectDx.push(assItemId)}}}})};$scope.updateAcceptStatusForOrders=function(assKey,isFromDeleteAss,assItemId){updateAcceptStatusForLabOrders($scope.gptAnalysis.lab_tests,assKey,isFromDeleteAss,assItemId);updateAcceptStatusForLabOrders($scope.gptAnalysis.diagnostic_imaging_or_procedures,assKey,isFromDeleteAss,assItemId);updateAcceptStatusForLabOrders($scope.gptAnalysis.medications,assKey,isFromDeleteAss,assItemId);updateAcceptStatusForLabOrders($scope.gptAnalysis.referral,assKey,isFromDeleteAss,assItemId)};$scope.toggleAsstSelection=function(selectedAsstIds,itemId){var idx=selectedAsstIds.indexOf(itemId);if(idx>-1){selectedAsstIds.splice(idx,1)}else{selectedAsstIds.push(itemId)}};$scope.isAssSelected=function(orderDxList,dxItemId){return orderDxList&&orderDxList.length>0&&orderDxList.findIndex(item=>item===dxItemId)>=0};let updateSunohDiagnosisValueForOrder=function(orders,existingItem){if(!orders){return}orders.forEach(order=>{if(order.selectDxItems&&order.selectDxItems.length>0){let dxArray=order.selectDxItems.filter(dx=>dx.key===existingItem.key);dxArray.forEach(dx=>dx.value=existingItem.value)}})};let undoSunohDiagnosisStatusForOrder=function(orders,key){if(!orders){return}orders.forEach(order=>{let dxArray;if(order.selectDxItems&&order.selectDxItems.length>0){dxArray=order.selectDxItems.filter(dx=>dx.key===key);dxArray.forEach(dx=>dx.isDelete=false)}if(!dxArray||dxArray.length===0){return}if(order.selectDxItems.length===1){order.isAcceptEnable=false;order.isAllDxDeleted=false}else{let deletedOrUnsavedDx=order.selectDxItems.filter(dx=>!dx.isICDSaved||dx.isDelete);if(order.selectDx.length>0||deletedOrUnsavedDx.length!==order.selectDxItems.length){order.isAcceptEnable=true}else if(deletedOrUnsavedDx.length===order.selectDxItems.length){order.isAcceptEnable=false}}})};$scope.undoSunohDiagnosisStatusForOrders=function(keyName){undoSunohDiagnosisStatusForOrder($scope.gptAnalysis.lab_tests,keyName);undoSunohDiagnosisStatusForOrder($scope.gptAnalysis.diagnostic_imaging_or_procedures,keyName)};$scope.updateSunohDiagnosisArrForOrder=function(existingItem){updateSunohDiagnosisValueForOrder($scope.gptAnalysis.lab_tests,existingItem);updateSunohDiagnosisValueForOrder($scope.gptAnalysis.diagnostic_imaging_or_procedures,existingItem)};$scope.checkChangeForTreatmentPlanNotes=function(){checkChangeForTreatmentPlan=true};function safeApplyScope(){try{if($scope&&$scope.$root.$$phase!=='$apply'&&$scope.$root.$$phase!=='$digest'){$scope.$apply()}}catch(e){}}let addAssSuggesionForOtherOrderBasedOnHistoricalData=function(){if(!$scope.treatmentNotesDataArr||$scope.treatmentNotesDataArr.length===0){return}let currentAssessmentCodes=[];let sunohAss=$scope.treatmentNotesDataArr.filter(dx=>!dx.trash);if(sunohAss&&sunohAss.length>0){currentAssessmentCodes.push(...sunohAss.map(ass=>ass.value.code))}if(currentAssessmentCodes&&currentAssessmentCodes.length>0){$scope.addAssessmentForOtherOrdersIfRequired(currentAssessmentCodes)}};let manageAssessmentForOrders=function(){addDefaultDxForOrders($scope.gptAnalysis.lab_tests);addDefaultDxForOrders($scope.gptAnalysis.diagnostic_imaging_or_procedures);addDefaultDxForOrders($scope.gptAnalysis.medications);addDefaultDxForOrders($scope.gptAnalysis.immunizations);addDefaultDxForOrders($scope.gptAnalysis.referral);addAssSuggesionForOtherOrderBasedOnHistoricalData()}});sunohConversationModule.factory('sharedServiceSunoh',function($rootScope,$ocLazyLoad,$modal,$http){var sharedServiceSunoh={};sharedServiceSunoh.sunohSpeechModel=null;sharedServiceSunoh.isSummaryPermission=false;sharedServiceSunoh.openSunohSpeechModel=function(){$ocLazyLoad.load({name:'sunohSetupSignatureModule',files:['/mobiledoc/jsp/webemr/sunoh/js/signaturecontroller.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/sunoh/template/signature.html');sharedServiceSunoh.sunohSpeechModel=$modal.open({templateUrl:url,controller:'sunohSetupSignatureController',windowClass:'app-modal-window sunohw750',backdrop:"static",keyboard:false,size:"lg"})},function(e){sunohGlobal.log(e)})};sharedServiceSunoh.openSunohAssistantSetupModel=function(){$ocLazyLoad.load({name:'sunohAssistantSettingsModule',files:['/mobiledoc/jsp/webemr/sunoh/settings/sunohAssistantSettingsController.js']}).then(function(){var url=makeURL('/mobiledoc/jsp/webemr/sunoh/settings/sunoh-assistant-settings.html');sharedServiceSunoh.sunohAssistantSettingsModal=$modal.open({templateUrl:url,controller:'sunohAssistantSettingsController',windowClass:'app-modal-window sunohw750 sunoh-assistant-custom',backdrop:"static",keyboard:false,size:"lg"})},function(e){sunohGlobal.log(e)})};sharedServiceSunoh.outForBroadcastForSunohConv=function(){let counter=sunohGlobal.instanceCounter[bottompanel_encounterId+'widget']&&sunohGlobal.instanceCounter[bottompanel_encounterId+'widget'].counter?sunohGlobal.instanceCounter[bottompanel_encounterId+'widget'].counter:0;let key=bottompanel_encounterId+"widget"+counter;let sunohConversationController=sunohGlobal.templateScope[key];if(sunohConversationController&&typeof sunohConversationController.outProgressNoteBroadcastForSunoh==="function"){sunohConversationController.outProgressNoteBroadcastForSunoh()}};sharedServiceSunoh.prepForBroadcast=function(encounterId){let counter=sunohGlobal.instanceCounter[bottompanel_encounterId+'widget']&&sunohGlobal.instanceCounter[bottompanel_encounterId+'widget'].counter?sunohGlobal.instanceCounter[bottompanel_encounterId+'widget'].counter:0;let key=bottompanel_encounterId+"widget"+counter;let sunohConversationController=sunohGlobal.templateScope[key];if(sunohConversationController&&typeof sunohConversationController.prepForBroadcastForSunoh==="function"){sunohConversationController.prepForBroadcastForSunoh(encounterId)}};sharedServiceSunoh.permissionCheck=function(){return $http({url:makeURL("/mobiledoc/modules/webemr/sunoh/check"),method:'POST',dataType:'JSON'})};sharedServiceSunoh.getJWTToken=function(){return $http({url:makeURL("/mobiledoc/modules/webemr/sunoh/get/jwttoken?TrUserId="+global.TrUserId),method:'GET',dataType:'text'}).success(function(data){return data}).error(function(data){showCustomErrorDialog('Sunoh- Error Message:','We are unable to connect to Sunoh server at this time.',"500px")})};sharedServiceSunoh.closeSunohSpeechModal=function(){sharedServiceSunoh.sunohSpeechModel.close();sharedServiceSunoh.sunohSpeechModel=null};return sharedServiceSunoh});sunohConversationModule.directive('sunohContentEditable',['$sce',function($sce){return{restrict:'A',require:'?ngModel',link:function(scope,element,attrs,ngModel){if(!ngModel)return;ngModel.$render=function(){element.html($sce.getTrustedHtml(ngModel.$viewValue||''))};element.on('keyup change',function(){scope.$evalAsync(read)});read();function read(){var html=element.html();if(isNaN(ngModel.$viewValue)){ngModel.$viewValue=''}if(html===ngModel.$viewValue){return}if(attrs.stripBr&&html==='<br>'){html='';ngModel.$setViewValue(html);ngModel.$render();return}ngModel.$setViewValue(html)}}}}])})();function enableStartButton(){$("#startWidgetAudio").prop("disabled",false)}function hideStructDisclaimer(){$("#sunohScribeACIModule .smartform-fade").hide()}function showStructDisclaimer(){$("#sunohScribeACIModule .smartform-fade").show()}
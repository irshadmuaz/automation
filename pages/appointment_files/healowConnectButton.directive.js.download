(function(){angular.module('HealowConnect').directive('healowConnect',['$modal','SessionService','h2hAjaxService','healowConnectModalService',healowConnect]);function healowConnect($modal,sessionService,h2hAjaxService,healowConnectModalService){return{restrict:'E',scope:{screen:'@',patientObj:'=',encounterId:'=?',customClass:'@',contextDataFn:'&',theme:'@',onStart:'&',message:'@'},replace:true,templateUrl:'/mobiledoc/jsp/webemr/healowconnect/assets/templates/healowConnectButton.html',link:function link(scope){scope.isHealowConnectEnabled=getItemKeyValue("healowConnectEnabled").toUpperCase()==='YES';if(!scope.isDefaultStyle){scope.isDefaultStyle=true}scope.isUserAuthorizedToViewHConnect=isUserAuthorizedForHConnect;scope.isCallRunning=false;scope.isSameProgressNote=true;scope.selectedPatient={};const PN_MSG="The call is already in progress with a patient.";let pnMsg=PN_MSG;function changeBtnState(){scope.isCallRunning=!scope.isCallRunning;if(scope.isCallRunning){pnMsg=PN_MSG;scope.disableHealowConnectBtn=true}else{pnMsg="";scope.disableHealowConnectBtn=false}}scope.uniqueBtnIdForPt=0;function enableGreenHConnectBtn(id){var btnTimer=setTimeout(()=>{$('#hConnectBtn_'+id).addClass('btn-healow-green');$('#hConnectBtn_'+id).attr('disabled',false);$('#hConnectBtn_'+id).attr('title',pnMsg);$('#hConnectBtn_'+id).removeClass('disabled');clearTimeout(btnTimer);btnTimer=null},500)}function enableGreenHConnectTile(id){$('#hConnectDiv_'+id).attr('title',pnMsg);$('#hConnectDiv_'+id).find('button').attr('disabled',false);$('#hConnectDiv_'+id).find('button').removeClass('disabled');$('#hConnectDiv_'+id).addClass('border-green')}function enableHConnect(){$('#healowconnectbtn button').attr('disabled',false);$('#healowconnectbtn button').attr('title','Healow Connect');$('#healowconnectbtn .grey-boxes').attr('title','Healow Connect');$('#healowconnectbtn .grey-boxes').removeClass('border-green');$('#healowconnectbtn button').removeClass('disabled btn-healow-green')}function disableHConnect(){$('.btn-hConnect').addClass('disabled');$('.context-menu-icon-healow-connect-btn').addClass('disabled');$('.btn-hConnect').addClass('auto-pointer');$('.btn-hConnect').attr('disabled',true);$('.btn-hConnect').attr('title',pnMsg);$('#healowconnectbtn').find('.grey-boxes').addClass('disabled');$('#healowconnectbtn').find('.grey-boxes').attr('disabled',true);$('#healowconnectbtn').find('.grey-boxes').attr('title',pnMsg)}function disableHConnectBtn(id){var btnTimer=setTimeout(()=>{$('#hConnectBtn_'+id).addClass('disabled');$('#hConnectBtn_'+id).attr('disabled',true);$('#hConnectBtn_'+id).attr('title',pnMsg);$('#hConnectBtn_'+id).addClass('auto-pointer');clearTimeout(btnTimer);btnTimer=null},500)}function disableHConnectTile(id){$('#hConnectDiv_'+id).addClass('disabled');$('#hConnectDiv_'+id).attr('title',pnMsg);$('#hConnectDiv_'+id).addClass('auto-pointer');$('#hConnectDiv_'+id).attr('disabled',true)}function disableConnectBtn(isDisable,uniqueBtnId,isCallRunning){scope.uniqueBtnIdForPt=uniqueBtnId;scope.disableHealowConnectBtn=isDisable;if(isDisable){disableHConnect();if(isCallRunning){enableGreenHConnectBtn(uniqueBtnId);enableGreenHConnectTile(uniqueBtnId);healowConnectBtnFunctions.setStarted(true);healowConnectBtnFunctions.getH2HCallPatientInfo()}}else{enableHConnect()}}sessionService.disableConnectBtn(disableConnectBtn);scope.hConnectBtnStateChange=function(theme,scopeId){let h2hPatientInfo=healowConnectBtnFunctions.getH2HCallInfo();if(Object.prototype.toString.call(scope.patientObj)!=='[object Array]'&&theme!=='grey-theme'){if(Object.keys(h2hPatientInfo).length>0){let result=h2hPatientInfo;let isProviderOnCall=result&&result.data&&result.data['isProviderOnCall'];let isPtOnCall=result&&result.data&&result.data['patients']&&result.data['patients'][scope.patientObj]&&result.data['patients'][scope.patientObj]['callIsRunning'];if(!isPtOnCall){scope.isSameProgressNote=false}if(sessionService.getCallRunning()||isProviderOnCall||isPtOnCall){scope.isCallRunning=true;let isBtnGreen=false;scope.isSameProgressNote=isPtOnCall;if(isPtOnCall&&!isProviderOnCall||sessionService.getCallInfo()['ptId']==scope.patientObj){enableGreenHConnectBtn(scope.$id);enableGreenHConnectTile(scope.$id);isBtnGreen=true}if(!isBtnGreen){scope.disableHealowConnectBtn=isProviderOnCall||isPtOnCall||sessionService.getCallInfo()['ptId']!==scope.patientObj;if(scope.disableHealowConnectBtn){disableHConnectBtn(scope.$id);disableHConnectTile(scope.$id)}}}}}else if(theme&&theme==='grey-theme'){let patientID=scope.patientObj;let isProviderOnCall=h2hPatientInfo&&h2hPatientInfo.data&&h2hPatientInfo.data['isProviderOnCall'];let isPtOnCall=h2hPatientInfo&&h2hPatientInfo.data&&h2hPatientInfo.data['patients']&&h2hPatientInfo.data['patients'][patientID]&&h2hPatientInfo.data['patients'][patientID]['callIsRunning'];if(sessionService.getCallRunning()||isProviderOnCall||isPtOnCall){scope.isCallRunning=true;scope.isSameProgressNote=isPtOnCall;if(sessionService.isMultiplePtBtn()){disableHConnectBtn(scopeId);disableHConnectTile(scopeId)}}}};let hConnectBtnSubscriber=new HealowConnectBtnSubscriber(scope.screen,'healowConnectBtn',scope.$id,scope);healowConnectBtnFunctions.addBtnSubscriber(hConnectBtnSubscriber);scope.$on('$destroy',function(){healowConnectBtnFunctions.unsubscribeBtn(hConnectBtnSubscriber)});sessionService.setBtnState(changeBtnState);if(angular.element('#healowConnectModal').scope()){let healowCtrlScope=angular.element('#healowConnectModal').scope().healowCtrl;if(scope.screen==='resource_schedule'&&(healowCtrlScope.isDockedView||healowCtrlScope.chatData.chatDockView)){$('.context-menu-icon-healow-connect-btn').addClass('disabled')}else{$('.context-menu-icon-healow-connect-btn').removeClass('disabled')}}scope.connectHealow=function(uniqueBtnId){scope.contextData=scope.contextDataFn();if(!scope.patientObj||Array.isArray(scope.patientObj)&&scope.patientObj.length<=0){ecwAlert("Please select a record(s) and try again.");return}if(scope.theme==='grey-theme'&&!Array.isArray(scope.patientObj)){let ptArr=[];ptArr.push(scope.patientObj);scope.patientObj=ptArr}healowConnectModalService.openModel(scope.patientObj,scope.screen,scope.encounterId,scope.contextData,uniqueBtnId,scope.onStart,scope.message);$('.action-hub-modal').remove()}}}}})();
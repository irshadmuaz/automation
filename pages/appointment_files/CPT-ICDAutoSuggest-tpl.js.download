angular.module('ecw.dir.CPT-ICDAutoSuggest',['ecw.dir.icdConversionServiceApp']).directive('cptIcdAutoSuggest',function($timeout,$http,icd10ConversionService){return{restrict:'A',replace:'true',templateUrl:'/mobiledoc/jsp/webemr/templates/CPT-ICDAutoSuggest-tpl.html',scope:{encId:'@',encDate:'@',isCpt:'@',isIcd:'@',onItemSelect:'&',nameDisplay:'@',showAutomapOpt:'@',inlineEdit:'@',imoUsrdefault:'@',patientId:'@',code:'@',description:'@',imosearchtext:'@'},link:function(scope){var x2js=new X2JS;var liIndex=-1,timer=null,mousedDownFired=false,searchBy="",counter=1,cptUrl="",txtType="",feeSch="1";var showFee=getItemKeyValue("ShowFeeForCPT");var lookupFee=getUserProfile("DefaultFeeFilter");var lookupFeeAmt=getUserProfile("DefaultLookupFee");var smartSearchICD,imoMandateModifiers,imoManifestationCodes,showSnomed,imoVendorCode;if(scope.inlineEdit&&scope.inlineEdit==="yes"){smartSearchICD=getItemKeyValue("SmartSearchICD");showSnomed=getItemKeyValue("EnableSNOMEDICDMapping");imoVendorCode=getItemKeyValue("SmartICDSearchVendor")}scope.items=[];scope.callingSource='';scope.currentLi=-1;scope.code="";scope.description="";scope.icd9Data;scope.icdMappingOpts;scope.pageParam={pageIndex:0,maxCount:12};scope.descClass="col-sm-8";scope.imoSearchText="";if(scope.imosearchtext&&scope.imosearchtext!==""){scope.imoSearchText=scope.imosearchtext}scope.isSmartSearch='no';scope.isSnomed='no';scope.currentIdxIMO=-1;scope.imoVendorCode='IMO';scope.imoCounter=1;scope.imoMaxCount=8;var currentDate=new Date;currentDate=currentDate.getFullYear()+"-"+(currentDate.getMonth()+1)+"-"+currentDate.getDate();var icdSearchLen=getItemKeyValue("MinimumCharAsmtLookup");var cptSearchLen=getItemKeyValue("MinimumCharCPTLookup");scope.icdMappingOpts={"isEnabled":"","donotAllowUsrToChange":"","autoMapICD10":0};if(smartSearchICD&&smartSearchICD.toLowerCase()==='yes'&&(scope.imoUsrdefault&&(scope.imoUsrdefault==="true"||scope.imoUsrdefault==="1"))){scope.isSmartSearch='yes';if(showSnomed&&showSnomed==="yes")scope.isSnomed="yes";if(imoVendorCode)scope.imoVendorCode=imoVendorCode}if(scope.inlineEdit&&scope.inlineEdit==="yes"){if(scope.isSmartSearch&&scope.isSmartSearch==="yes"){$("#imoSearch_AutoSuggest").focus()}else{$("#ICDCode").focus()}}if(scope.isIcd&&scope.isIcd==="yes"&&scope.showAutomapOpt&&scope.showAutomapOpt==="yes"){var str=getItemKeyValue('EnableICD9ToICD10Mapping');scope.icdMappingOpts.isEnabled=str.toLowerCase();if(str&&str.toLowerCase()==="yes"){scope.descClass="col-sm-7";str=getItemKeyValue("DonotAllowUserToChangeAutoMapICD10Option");scope.icdMappingOpts.donotAllowUsrToChange=str.toLowerCase();var isICD10Effective;if(scope.encId){isICD10Effective=icd10ConversionService.isICD10Effective(scope.encId)}else{isICD10Effective=icd10ConversionService.isICD10Effective()}if(isICD10Effective){scope.icdMappingOpts.autoMapICD10=1}}}if(scope.encId){cptUrl="/mobiledoc/jsp/catalog/xml/edi/LookupCPTCodes.jsp?parentId=0&encId="+scope.encId}else{cptUrl="/mobiledoc/jsp/catalog/xml/edi/LookupCPTCodes.jsp?parentId=0"}scope.$watch('code',function(newCode,oldCode){if(newCode.length<=0){scope.items=[]}});scope.$watch('description',function(newDescription,oldDescription){if(newDescription.length<=0){scope.items=[]}});if(scope.isCpt&&scope.encId&&parseInt(scope.encId)>0){$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},method:'GET',url:makeURL("/mobiledoc/jsp/catalog/xml/edi/getFeeScheduleForEnc.jsp?encounterId="+scope.encId)}).success(function(response){var jsonData=xml2json($.trim(response));if(jsonData!=undefined&&jsonData.Envelope.Body["return"].EncFeeSchId!=undefined){feeSch=jsonData.Envelope.Body["return"].EncFeeSchId}})}sunohGlobal.getFirstAssessmentFromSearch=function(diagnosis,index){if(index<=diagnosis.length-1){scope.callingSource='sunoh';txtType='ICDName';searchBy='name';getItems(index,diagnosis[index].key)}};scope.autocompleteData=function(event,searchKey,type){if(type=="ICDCode"||type=="ICDName"){if(icdSearchLen&&$.isNumeric(icdSearchLen)){if(searchKey=="code"){if(scope.code.length==0){scope.items=[]}if(icdSearchLen>scope.code.length){return}}else{if(scope.description.length==0){scope.items=[]}if(icdSearchLen>scope.description.length){return}}}}else{if(cptSearchLen&&$.isNumeric(cptSearchLen)){if(searchKey=="code"){if(scope.code.length==0){scope.items=[]}if(cptSearchLen>scope.code.length){return}}else{if(scope.description.length==0){scope.items=[]}if(cptSearchLen>scope.description.length){return}}}}txtType=type;searchBy=searchKey;if(scope.code===""&&scope.description===""){liIndex=-1;scope.currentLi=-1;scope.items=[];resetParams()}else{if(event.keyCode===13){if(timer&&timer!==''){$timeout.cancel(timer)}if(liIndex==-1&&scope.items!=undefined&&scope.items.length>0){liIndex=0;scope.currentLi=scope.items[liIndex].itemId}scope.onSelectIcdCpt({'item':scope.items[liIndex]});scope.code="";scope.description="";scope.items=[];resetParams()}else if(event.keyCode===40){if(liIndex<scope.items.length-1){liIndex=liIndex+1;scope.currentLi=scope.items[liIndex].itemId}}else if(event.keyCode===38){if(liIndex>0){liIndex=liIndex-1;scope.currentLi=scope.items[liIndex].itemId}}else{scope.currentLi=-1;resetParams();if(timer&&timer!==''){$timeout.cancel(timer)}timer=$timeout(function(){if(checkNonPrintable(event)){scope.items=[];getItems()}},500)}}};var getItems=function(index,description){var url,xsrf;if(scope.isCpt){xsrf=$.param({FormData:creatCPTXml(searchBy,description)});url=cptUrl}if(scope.isIcd){xsrf=$.param({FormData:createICDXml(searchBy,description)});url='/mobiledoc/jsp/catalog/xml/edi/LookupDiagnosisCodes.jsp?parentId=0'}url=makeURL(url);$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url,data:xsrf}).success(function(data){var jsonData2=x2js.xml_str2json(data);if(scope.isCpt)scope.items=returnDataArray(jsonData2.Envelope.Body["return"].procedures.procedure);if(scope.isIcd)scope.items=returnDataArray(jsonData2.Envelope.Body["return"].ICDCodes.icd);liIndex=-1;if(scope.callingSource==='sunoh'){if(scope.items.length>0){let existingItem=sunohGlobal.scope.gptAnalysis.diagnosis.find(item=>item.key===description);if(existingItem){existingItem.value.push(scope.items[0])}}index=index+1;sunohGlobal.getFirstAssessmentFromSearch(sunohGlobal.scope.gptAnalysis.diagnosis,index)}})};scope.autocompleteIMOData=function(event){var searchKey="name";if(icdSearchLen&&$.isNumeric(icdSearchLen)){if(!scope.imoSearchText||scope.imoSearchText.length>=0){scope.items=[]}if(icdSearchLen>scope.code.length){return}}txtType="imoSearch_AutoSuggest";if(scope.imoSearctText===""){liIndex=-1;scope.items=[];resetParams()}else{if(event.keyCode===13){if(timer&&timer!==''){$timeout.cancel(timer)}if(liIndex==-1&&scope.items!=undefined&&scope.items.length>0){liIndex=0;scope.currentLi=scope.items[liIndex].itemId;scope.currentIdxIMO=liIndex}scope.onSelectIcdCpt({'item':scope.items[liIndex]},"yes");scope.imoSearchText="";scope.items=[];resetParams()}else if(event.keyCode===40){if(liIndex<scope.items.length-1){liIndex=liIndex+1;scope.currentLi=scope.items[liIndex].itemId;scope.currentIdxIMO=liIndex}}else if(event.keyCode===38){if(liIndex>0){liIndex=liIndex-1;scope.currentLi=scope.items[liIndex].itemId;scope.currentIdxIMO=liIndex}}else{scope.currentLi=-1;resetParams();if(timer&&timer!==''){$timeout.cancel(timer)}timer=$timeout(function(){if(checkNonPrintable(event)){scope.items=[];scope.getItemsIMO(searchBy,scope.imoSearchText)}},500)}}};scope.getItemsIMO=function(searchBy,searchText){var url='/mobiledoc/jsp/catalog/xml/IMO/DoSmartICDSearch.jsp?vendorcode='+scope.imoVendorCode;url=url+'&searchby='+searchBy;url=url+'&search='+searchText;url=url+"&ncounter="+scope.imoCounter;url=url+"&maxcount="+scope.imoMaxCount;url=url+'&parentId=0';url=url+'&useicd10=1';if(scope.encId&&scope.encId>0){url=url+"&encounterId="+scope.encId}url=url+"&patientId="+(scope.patientId&&scope.patientId>0?scope.patientId:"-1");url=url+"&userId="+global.TrUserId;url=makeURL(url);$http({headers:{'Content-Type':'application/x-www-form-urlencoded'},dataType:'text',method:'POST',url:url}).then(function(response){var data=response.data;var imoJson=x2js.xml_str2json(data);if(imoJson.Envelope.Body["return"].status==='failed'&&imoJson.Envelope.Body["return"].errormsg==='GetTerminologyRequestError'){notification.show('warning','',"Smart Search is down as the connection to IMO is unavailable at this time. Now Using Classic Search.",1e4,'connectivity-error');scope.isSmartSearch="no";return}if(imoJson.Envelope.Body["return"].status==='failed'&&imoJson.Envelope.Body["return"].errormsg==='GetTerminologyRequestAuthorizationError'){notification.show('warning','',"There is a problem with your IMO account. Please contact IMO at CustomerSupport@e-imo.com. Now using Classic Search.",1e4,'connectivity-error');scope.isSmartSearch="no";return}scope.items=returnDataArray(imoJson.Envelope.Body["return"].ICDCodes.icd);liIndex=-1},function(response){ecwAlert("An error occurred while loading assessments.")})};scope.next=function(){if(scope.isSmartSearch&&scope.isSmartSearch==="yes"){scope.imoCounter=scope.imoCounter+scope.imoMaxCount;scope.pageParam.pageIndex=scope.pageParam.pageIndex+1;scope.currentLi=-1;scope.getItemsIMO(searchBy,scope.imoSearchText)}else if(scope.items.length===scope.pageParam.maxCount){scope.currentLi=-1;scope.pageParam.pageIndex=scope.pageParam.pageIndex+1;counter=scope.pageParam.pageIndex*scope.pageParam.maxCount+1;getItems()}focusElement()};scope.prev=function(){if(scope.isSmartSearch&&scope.isSmartSearch==="yes"){scope.imoCounter=scope.imoCounter-scope.imoMaxCount;if(scope.imoCounter>1){scope.imoCounter=1}scope.pageParam.pageIndex=scope.pageParam.pageIndex-1;if(scope.pageParam.pageIndex<0){scope.pageParam.pageIndex=0}scope.currentLi=-1;scope.getItemsIMO(searchBy,scope.imoSearchText)}else if(scope.pageParam.pageIndex!==0){scope.currentLi=-1;scope.pageParam.pageIndex=scope.pageParam.pageIndex-1;counter=scope.pageParam.pageIndex*scope.pageParam.maxCount+1;getItems()}focusElement()};scope.clearText=function(){if(scope.nameDisplay=="yes"){if(scope.isSmartSearch&&scope.isSmartSearch==="yes"){scope.imoSearchText=scope.items[liIndex].code}else{scope.code=scope.items[liIndex].code;scope.description=scope.items[liIndex].name}}else{if(scope.isSmartSearch&&scope.isSmartSearch==="yes"){scope.imoSearchText=""}else{scope.code="";scope.description=""}}scope.items=[];resetParams();focusElement()};scope.mouseDown=function(){mousedDownFired=true};scope.txtBlur=function(){if(mousedDownFired){mousedDownFired=false}else{resetParams();scope.items=[]}if(scope.nameDisplay=="yes"&&(scope.code==""||scope.description=="")){scope.code="";scope.description="";scope.onItemSelect({'item':{itemId:0}})}};scope.onSelectIcdCpt=function(obj){if(scope.inlineEdit&&scope.inlineEdit==="yes"){scope.clearText()}if(scope.isIcd&&scope.isIcd==="yes"&&scope.showAutomapOpt&&scope.showAutomapOpt==="yes"&&scope.icdMappingOpts.autoMapICD10&&scope.icdMappingOpts.autoMapICD10==1){if(obj){var item=obj.item;var isICD10=icd10ConversionService.isICD10(item.code,item.itemId);if(isICD10){scope.onItemSelect(obj)}else{scope.icd9Data=obj;icd10ConversionService.autoMapICD9to10(item.code,item.name,item.itemId,scope.icdConverionCallBack)}}}else{scope.onItemSelect(obj)}};scope.icdConverionCallBack=function(action,data){if(action&&action==="close"){if(scope.icd9Data)scope.onItemSelect(scope.icd9Data)}else{if(data){if(data.status&&data.status=="success"){if(data.nodx&&data.nodx=="yes"){if(scope.icd9Data&&scope.icd9Data.item){var icd9Item=scope.icd9Data.item;ecwAlert(icd9Item.code+" : "+icd9Item.name+" has no ICD-10 Mapping.")}else{ecwAlert("Entered ICD-9 Code has no ICD-10 Mapping.")}return}var icdArray=data.icdArray;if(icdArray&&icdArray.length==0){if(scope.icd9Data)scope.onItemSelect(scope.icd9Data)}else if(icdArray){$.each(icdArray,function(index,obj){scope.onItemSelect({'item':{"code":obj.code,"name":obj.name,"itemId":obj.itemId,"icdversion":obj.icdversion}})})}}else{ecwAlert("An error occurred while performing ICD-9 to ICD-10 Mapping");return}}else{ecwAlert("An error occurred while Performing ICD-9 to ICD-10 Mapping");return}}};var resetParams=function(){scope.pageParam.pageIndex=0;counter=1};var focusElement=function(){var element=document.getElementById(txtType);angular.element(element).focus()};scope.moveLiData=function(itemId,index){liIndex=index;scope.currentLi=itemId;scope.currentIdxIMO=liIndex;if(scope.isSmartSearch==="yes"){scope.currentIdxIMO=index}};var creatCPTXml=function(searchBy,description){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('lookup');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'searchBy',searchBy,'xsi:type','xsd:string');if(searchBy==='code')addElement(xw,'code',escapeXml(scope.code),'xsi:type','xsd:string');else if(searchBy==='name'&&description===undefined)addElement(xw,'name',escapeXml(scope.description),'xsi:type','xsd:string');else if(searchBy==='name'&&description!==undefined)addElement(xw,'name',escapeXml(description),'xsi:type','xsd:string');addElement(xw,'keyName','CPTCodes','xsi:type','xsd:string');addElement(xw,'keyName','HCPCS','xsi:type','xsd:string');addElement(xw,'counter',counter,'xsi:type','xsd:string');addElement(xw,'maxcount',scope.pageParam.maxCount,'xsi:type','xsd:string');addElement(xw,'bActive','Active','xsi:type','xsd:string');addElement(xw,'ShowInvalid','0','xsi:type','xsd:string');addElement(xw,'Fee',showFee=='yes'?lookupFee:'','xsi:type','xsd:string');addElement(xw,'Amount',showFee=='yes'?lookupFeeAmt:'0.00','xsi:type','xsd:string');addElement(xw,'FeeSchId',feeSch,'xsi:type','xsd:string');addElement(xw,'ValidDate',currentDate,'xsi:type','xsd:string');addElement(xw,'inlinelookup','yes','xsi:type','xsd:string');xw.writeEndElement();endSoapPacket(xw);return xw.flush()};var createICDXml=function(searchBy,description){var xw=new XMLWriter('ISO-8859-1','1.0');startSoapPacket(xw);xw.writeStartElement('lookup');xw.writeAttributeString('xsi:type','xsd:string');addElement(xw,'searchBy',searchBy,'xsi:type','xsd:string');if(searchBy==='code')addElement(xw,'code',escapeXml(scope.code),'xsi:type','xsd:string');else if(searchBy==='name'&&description===undefined)addElement(xw,'name',escapeXml(scope.description),'xsi:type','xsd:string');else if(searchBy==='name'&&description!==undefined)addElement(xw,'name',escapeXml(description),'xsi:type','xsd:string');addElement(xw,'keyName','Assessments','xsi:type','xsd:string');addElement(xw,'ShowCodes','1','xsi:type','xsd:string');addElement(xw,'ValidDate',scope.encDate===undefined?"":scope.encDate,'xsi:type','xsd:string');addElement(xw,'counter',counter,'xsi:type','xsd:string');addElement(xw,'maxcount',scope.pageParam.maxCount,'xsi:type','xsd:string');addElement(xw,'StartWith','Starts With','xsi:type','xsd:string');if(scope.inlineEdit&&scope.inlineEdit==="yes")addElement(xw,'ICDType','ICD10','xsi:type','xsi:string');xw.writeEndElement();endSoapPacket(xw);return xw.flush()}}}});